<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover"/>
<title>生技展訂購系統 v29</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&family=Roboto:wght@500;700;900&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

<style>
/* --- CORE VARIABLES --- */
:root {
  --primary: #00897b; --primary-light: #e0f2f1; --accent: #ff6f00; 
  --beauty: #d81b60; 
  --bg-body: #f8f9fa; --bg-card: #ffffff; --text-main: #263238; --text-sub: #546e7a;
  --border: #eceff1; --header-height: 115px;
  --shadow-card: 0 4px 20px rgba(0,0,0,0.04);
  --safe-bottom: env(safe-area-inset-bottom, 20px);
  --price-size: 17px;
  --price-size-lg: calc(var(--price-size) + 2px);
}
* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
body {
  font-family: 'Noto Sans TC', sans-serif; background: var(--bg-body); color: var(--text-main);
  margin: 0; padding: 0; 
  padding-bottom: calc(120px + var(--safe-bottom)); 
  overscroll-behavior-y: none;
}
body.modal-open { overflow: hidden; height: 100vh; position: fixed; width: 100%; }

@media (max-width: 768px) {
  input, select, textarea { font-size: 16px !important; }
}

/* --- OPTIMIZATION: Natural Flying Animation --- */
.flying-img { 
  position: fixed; z-index: 9999; pointer-events: none; border-radius: 50%; 
  box-shadow: 0 5px 25px rgba(0,0,0,0.25); 
  width: 60px; height: 60px; object-fit: cover; background: #fff; border: 2px solid #fff;
  transition: top 1s cubic-bezier(0.19, 1, 0.22, 1), 
              left 1s cubic-bezier(0.19, 1, 0.22, 1), 
              transform 1s ease-in, 
              opacity 1s ease-in;
}

.p-img-box { 
  width: 100%; aspect-ratio: 1/1; 
  background: #fcfcfc; 
  position: relative; display: flex; align-items: center; justify-content: center; overflow: hidden; 
}
.p-img-box img { 
  width: 100%; height: 100%; object-fit: contain; 
  transition: opacity 0.4s ease; opacity: 0; 
  mix-blend-mode: multiply; 
}
.p-img-box img.loaded { opacity: 1; }

/* --- FIX: WELCOME & LOADER --- */
#welcome-overlay, #loader {
  position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
  display: flex; align-items: center; justify-content: center;
}
#welcome-overlay { z-index: 9999; background: rgba(236, 239, 241, 0.85); backdrop-filter: blur(8px); transition: opacity 0.5s ease; }
#loader { z-index: 9990; background: #f4f6f8; align-items: flex-start; padding-top: 120px; transition: opacity 0.3s ease; }
#welcome-overlay.fade-out { opacity: 0; pointer-events: none; }

/* --- LAYOUT --- */
main { padding: 12px; max-width: 900px; margin: 0 auto; margin-top: 10px; }
.grid-layout { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 12px; align-content: start; width: 100%; }

/* --- Global: Two-stage checkout collapse (desktop + mobile) --- */
.checkout-details{
  margin-top: 12px;
  overflow: hidden;
  transform-origin: top;
  transition: max-height .38s cubic-bezier(.2,.9,.2,1), opacity .22s ease, transform .38s cubic-bezier(.2,.9,.2,1);
  max-height: 720px;
}
.checkout-details.collapsed{
  max-height: 0px;
  opacity: 0;
  transform: translateY(-6px);
  pointer-events: none;
  margin-top: 0px;
}
.checkout-details:not(.collapsed){
  opacity: 1;
  transform: translateY(0px);
  pointer-events: auto;
}

/* Keep space tidy when collapsed */
.checkout-details.collapsed + .btn-bar{ margin-top: 12px; }

@media (max-width: 480px) { .grid-layout { grid-template-columns: repeat(2, 1fr) !important; gap: 10px; } }

/* Ranking UI */
#ranking-section { background: #fff; margin: 10px 12px 20px; padding: 12px; border-radius: 16px; border: 1px solid #eceff1; box-shadow: 0 4px 15px rgba(0,0,0,0.03); display: none; }
.rank-head { padding: 0 4px 8px; display: flex; align-items: center; gap: 12px; overflow: hidden; }
.rank-title { font-size: 15px; font-weight: 900; color: #d81b60; white-space: nowrap; flex-shrink: 0; display: flex; align-items: center; gap: 4px; }
.rank-tabs { display: flex; gap: 8px; overflow-x: auto; scrollbar-width: none; flex: 1; mask-image: linear-gradient(to right, black 85%, transparent 100%); -webkit-mask-image: linear-gradient(to right, black 85%, transparent 100%); }
.rank-tabs::-webkit-scrollbar { display: none; }
.r-tab { font-size: 12px; font-weight: 500; color: #90a4ae; cursor: pointer; white-space: nowrap; padding: 4px 10px; border-radius: 20px; background: #f5f5f5; transition: 0.2s; }
.r-tab.active { color: #fff; background: #d81b60; font-weight: 700; box-shadow: 0 2px 5px rgba(216, 27, 96, 0.3); }
.rank-list { display: flex; gap: 10px; padding: 4px 0 8px; overflow-x: auto; scroll-behavior: smooth; scrollbar-width: none; -ms-overflow-style: none; }
.rank-list::-webkit-scrollbar { display: none; }
.r-card { flex: 0 0 76px; display: flex; flex-direction: column; align-items: center; gap: 6px; cursor: pointer; transition: transform 0.1s; }
.r-card:active { transform: scale(0.96); }
.r-img-wrap { width: 76px; height: 76px; border-radius: 14px; background: #fff; border: 1px solid #eee; position: relative; padding: 2px; box-shadow: 0 2px 6px rgba(0,0,0,0.03); overflow: hidden; }
.r-img { width: 100%; height: 100%; object-fit: contain; mix-blend-mode: multiply; }
.r-badge { position: absolute; top: 0; left: 0; width: 22px; height: 22px; border-bottom-right-radius: 8px; background: rgba(0,0,0,0.7); color: #fff; font-size: 11px; font-weight: 900; display: flex; align-items: center; justify-content: center; z-index: 2; }
.r-card[data-rank="1"] .r-badge { background: #ffd700; color: #3e2723; }
.r-card[data-rank="2"] .r-badge { background: #cfd8dc; color: #37474f; }
.r-card[data-rank="3"] .r-badge { background: #d7ccc8; color: #3e2723; }
.r-sold-tag { position: absolute; bottom: 3px; right: 3px; background: linear-gradient(135deg, #ff7043, #f4511e); color: #fff; font-size: 9px; font-weight: 700; padding: 2px 6px; border-radius: 8px; box-shadow: 0 2px 4px rgba(244, 81, 30, 0.2); z-index: 2; }
.r-name { font-size: 10px; font-weight: 500; color: #37474f; text-align: center; line-height: 1.3; height: 2.6em; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; width: 100%; }

/* --- Float Bar & Buttons --- */
#float-bar { 
  position: fixed; 
  bottom: calc(20px + var(--safe-bottom)); 
  left: 16px; right: 16px; 
  background: #263238; color: #fff; border-radius: 60px; 
  padding: 10px 10px 10px 24px; box-shadow: 0 15px 35px rgba(0,0,0,0.25); 
  display: flex; align-items: center; justify-content: space-between; 
  z-index: 2000 !important; cursor: pointer; backdrop-filter: blur(10px); 
  transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}
#float-bar.hidden { transform: translateY(200%); }
.fb-total { font-size: 18px; font-weight: 700; }
.fb-count { font-size: 12px; opacity: 0.7; }
.fb-btn { 
  background: var(--accent); color: #fff; padding: 10px 24px; border-radius: 40px; 
  font-weight: 700; font-size: 15px; box-shadow: 0 4px 15px rgba(255,111,0,0.4); 
  display: flex; align-items: center; gap: 6px; transition: 0.1s;
}
.fb-btn:active { background: #e65100; transform: scale(0.98); }

#gift-fab {
  position: fixed; bottom: calc(90px + var(--safe-bottom)); left: 20px;
  width: 50px; height: 50px; border-radius: 50%;
  background: #fff; border: 2px solid #ffd54f;
  box-shadow: 0 4px 15px rgba(255, 160, 0, 0.3);
  display: flex; align-items: center; justify-content: center;
  font-size: 24px; cursor: pointer; z-index: 1090;
  transition: transform 0.2s;
  display: none; 
}
#gift-fab:active { transform: scale(0.9); }
@keyframes shakeGift { 0% { transform: rotate(0deg); } 25% { transform: rotate(-15deg); } 50% { transform: rotate(15deg); } 75% { transform: rotate(-15deg); } 100% { transform: rotate(0deg); } }
.gift-shake { animation: shakeGift 0.5s ease-in-out 2; box-shadow: 0 0 20px rgba(255, 193, 7, 0.8) !important; }

#back-to-top {
  position: fixed; bottom: calc(90px + var(--safe-bottom)); right: 20px; 
  width: 45px; height: 45px; border-radius: 50%;
  background: rgba(255, 255, 255, 0.9); color: var(--primary);
  box-shadow: 0 4px 12px rgba(0,0,0,0.15); border: 1px solid #eee;
  display: flex; align-items: center; justify-content: center;
  z-index: 1090; cursor: pointer; opacity: 0; pointer-events: none;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); transform: translateY(20px);
}
#back-to-top.show { opacity: 1; pointer-events: auto; transform: translateY(0); }

/* --- Top Notification --- */
#top-notify {
  position: fixed; top: 16px; left: 16px; right: 16px;
  background: rgba(33, 33, 33, 0.95); color: #fff;
  padding: 12px 20px; border-radius: 16px; 
  display: flex; flex-direction: column; gap: 4px;
  box-shadow: 0 8px 30px rgba(0,0,0,0.3); 
  z-index: 3000; transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1), opacity 0.4s;
  backdrop-filter: blur(8px);
  transform: translateY(-150%); opacity: 0; pointer-events: none;
}
#top-notify.show { transform: translateY(0); opacity: 1; pointer-events: auto; }
.tn-head { display: flex; align-items: center; gap: 8px; font-weight: 700; color: #ffd54f; font-size: 14px; margin-bottom: 2px; }
.tn-body { font-size: 13px; line-height: 1.5; color: #fff; white-space: normal; }

/* --- Milestone Card --- */
#milestone-overlay {
  position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 3000;
  display: flex; align-items: center; justify-content: center;
  opacity: 0; pointer-events: none; transition: opacity 0.3s; backdrop-filter: blur(2px);
}
#milestone-overlay.open { opacity: 1; pointer-events: auto; }
.ms-card-v {
  background: #fff; width: 95%; max-width: 400px; 
  border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.25); 
  display: flex; flex-direction: column; overflow: hidden;
  max-height: 85vh; transform: scale(0.9); transition: transform 0.3s;
}
#milestone-overlay.open .ms-card-v { transform: scale(1); }
.ms-card-v.shrinking { animation: shrinkToFab 0.6s ease-in forwards; }
@keyframes shrinkToFab { 0% { transform: scale(1) translate(0, 0); opacity: 1; } 100% { transform: scale(0.1) translate(-120vw, 100vh); opacity: 0; } }

.ms-header { background: #fff; padding: 16px 50px 16px 16px; border-bottom: 1px solid #eee; position: relative; }

.ms-close{
  position:absolute; top: 12px; right: 12px;
  width: 34px; height: 34px;
  border-radius: 12px;
  border: 1px solid #eee;
  background: #fff;
  display:flex; align-items:center; justify-content:center;
  cursor: pointer;
  color: #607d8b;
  box-shadow: 0 6px 18px rgba(0,0,0,0.06);
}
.ms-close:hover{ background:#fafafa; }
.ms-close:active{ transform: translateY(1px); }

.ms-title-v { font-size: 18px; font-weight: 900; color: #37474f; margin-bottom: 10px; text-align: center; }
.ms-summary-row { display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; border-radius: 8px; margin-bottom: 6px; font-size: 13px; font-weight: 700; }
.ms-sum-all { background: #fff8e1; color: var(--accent); }
.ms-sum-beauty { background: #fce4ec; color: var(--beauty); }

/* 全站/美容視覺區隔：徽章＋摘要 */
.ms-summary-row{
  gap: 10px;
  align-items: flex-start;
}
.ms-sum-left{
  display:flex;
  align-items:flex-start;
  gap:10px;
  min-width: 0;
}
.ms-badge{
  font-size: 10px;
  font-weight: 900;
  padding: 4px 8px;
  border-radius: 999px;
  line-height: 1;
  border: 1px solid transparent;
  letter-spacing: .2px;
  flex: 0 0 auto;
}
.ms-badge-all{
  background: rgba(230,81,0,0.12);
  border-color: rgba(230,81,0,0.22);
  color:#b54a00;
}
.ms-badge-beauty{
  background: rgba(216,27,96,0.10);
  border-color: rgba(216,27,96,0.20);
  color:#ad1457;
}
.ms-sum-text{ display:flex; flex-direction:column; gap:2px; min-width:0; }
.ms-sum-title{ font-size: 13px; font-weight: 900; line-height:1.1; }
.ms-sum-sub{ font-size: 11px; font-weight: 700; color:#607d8b; line-height:1.2; }
#ms-val-all, #ms-val-beauty{ font-size: 14px; font-weight: 900; line-height:1; padding-top: 2px; }

/* 兩條軌道底色（不影響上下滑動，只強化辨識） */
.ms-track-col{
  padding: 8px 6px 10px;
  border-radius: 14px;
  border: 1px solid rgba(0,0,0,0.05);
  background: rgba(255,255,255,0.70);
}
.ms-track-col.all{
  background: rgba(255,243,224,0.55);
  border-color: rgba(230,81,0,0.10);
}
.ms-track-col.beauty{
  background: rgba(252,228,236,0.55);
  border-color: rgba(216,27,96,0.10);
}
.ms-track-col.all .ms-track-title{ color: var(--accent); }
.ms-dual-body { flex: 1; overflow-y: auto; overflow-x: hidden; padding: 8px; display: grid; grid-template-columns: minmax(0,1fr) minmax(0,1fr); gap: 6px; background: #fafafa; overscroll-behavior: contain; }
.ms-track-col { display: flex; flex-direction: column; gap: 10px; position: relative; min-width: 0; }
.ms-track-title { text-align: center; font-size: 12px; color: #90a4ae; font-weight: 700; margin-bottom: 4px; }
.ms-dual-item { background: #fff; border: 1px solid #eee; border-radius: 12px; padding: 10px; display: flex; flex-direction: column; align-items: center; gap: 6px; opacity: 0.5; transition: 0.3s; text-align: center; }
.ms-dual-item.active { opacity: 1; border-color: var(--accent); box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
.ms-track-col.beauty .ms-dual-item.active { border-color: var(--beauty); }

/* --- V29: Milestone '下一門檻差額' 標籤 + 動效（3.1秒） --- */
/* 版面：每張卡片改成「上：門檻 + 標籤」「下：圖左文字右」以提升可讀性 */
.ms-dual-item{ position: relative; text-align:left; align-items:stretch; padding: 10px; gap: 8px; }
.ms-dual-item.next{
  opacity: 1;
  border-color: rgba(230,81,0,0.26);
  box-shadow: 0 10px 22px rgba(230,81,0,0.10);
}
.ms-track-col.beauty .ms-dual-item.next{
  border-color: rgba(216,27,96,0.26);
  box-shadow: 0 10px 22px rgba(216,27,96,0.10);
}

.ms-d-head{ display:flex; align-items:flex-start; justify-content:space-between; flex-wrap: wrap; gap: 6px; width: 100%; }
.ms-d-body{
  display:flex;
  align-items:center;
  gap: 10px;
  width: 100%;
}
.ms-d-media{ flex: 0 0 64px; }
.ms-d-media .g-img-row{ display:flex; gap:6px; align-items:center; }
.ms-d-media .g-thumb{ width:64px; height:64px; object-fit:contain; border:1px solid #eee; border-radius: 12px; background:#fff; }
.ms-d-media .g-thumb:not(:first-child){ display:none; } /* 只秀第一張，避免擠爆欄寬 */

.ms-d-th{
  font-size: 12px;
  color: #fff;
  background: #bdbdbd;
  padding: 4px 8px;
  border-radius: 10px;
  font-weight: 900;
  letter-spacing: .2px;
  line-height: 1;
  white-space: nowrap;
}
.ms-dual-item.active .ms-d-th { background: var(--accent); }
.ms-track-col.beauty .ms-dual-item.active .ms-d-th { background: var(--beauty); }

.ms-d-name{
  font-size: 13px;
  color: #37474f;
  line-height: 1.25;
  font-weight: 900;
  word-break: break-word;
  display: -webkit-box;
  -webkit-line-clamp: 3;
  -webkit-box-orient: vertical;
  overflow: hidden;
}

.ms-tag{
  position: static;
  font-size: 11px;
  padding: 4px 8px;
  border-radius: 999px;
  background: rgba(255,111,0,0.16);
  color: #e65100;
  border: 1px solid rgba(230,81,0,0.26);
  font-weight: 900;
  letter-spacing: .2px;
  pointer-events:none;
  transform-origin: center;
  white-space: nowrap;
  box-shadow: 0 0 0 rgba(230,81,0,0);
}
.ms-track-col.beauty .ms-tag{
  background: rgba(216,27,96,0.12);
  color: #ad1457;
  border-color: rgba(216,27,96,0.22);
}
.ms-tag.done{
  background: rgba(0,137,123,0.14);
  color:#00695c;
  border-color: rgba(0,137,123,0.22);
  box-shadow: none;
}
.ms-tag.flash{
  animation: msTagGlow .95s ease-in-out infinite, msTagShake .42s ease-in-out infinite;
}
@keyframes msTagGlow{
  0%{ box-shadow: 0 0 0 rgba(230,81,0,0); filter: saturate(1); }
  50%{ box-shadow: 0 10px 26px rgba(230,81,0,0.25); filter: saturate(1.35); }
  100%{ box-shadow: 0 0 0 rgba(230,81,0,0); filter: saturate(1); }
}
@keyframes msTagShake{
  0%{ transform: translate(0,0) rotate(0deg); }
  20%{ transform: translate(0.5px,-0.5px) rotate(-1deg); }
  50%{ transform: translate(-0.5px,0.5px) rotate(1deg); }
  80%{ transform: translate(0.5px,0.2px) rotate(-0.5deg); }
  100%{ transform: translate(0,0) rotate(0deg); }
}

/* FIX: Multi-Image CSS */
.g-img-row { display: flex; gap: 4px; align-items: center; }
.g-thumb { width: 40px; height: 40px; object-fit: contain; border: 1px solid #eee; border-radius: 6px; background: #fff; }

/* --- General --- */
.highlight { background-color: #fff176 !important; color: #212121 !important; font-weight: 900; border-radius: 2px; padding: 0 2px; }
.cat-section-title{
  font-size: 18px;
  font-weight: 900;
  color: var(--primary);
  padding: 16px 44px 8px 8px;
  margin-top: 0;
  margin-bottom: 8px;
  border-bottom: 2px solid var(--primary-light);
  scroll-margin-top: 135px;
  position: relative;
  cursor: pointer;
  border-radius: 10px;
  transition: background .15s ease, transform .12s ease;
}
.cat-section-title:hover{ background: rgba(0,137,123,0.06); }
.cat-section-title:active{ transform: translateY(1px); }
.cat-section-title::after{
  content: 'i';
  position: absolute;
  right: 10px;
  top: 50%;
  transform: translateY(-40%);
  width: 20px;
  height: 20px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-family: 'Roboto', sans-serif;
  font-weight: 900;
  font-size: 12px;
  color: #004d40;
  background: rgba(224,242,241,0.90);
  border: 1.6px solid rgba(0,137,123,0.55);
  box-shadow: 0 6px 14px rgba(0,0,0,0.06);
}


/* --- V28 FIX: Overlay Flash Animation --- */
.p-card { 
  background: #fff; border-radius: 16px; overflow: hidden; position: relative; 
  box-shadow: var(--shadow-card); border: 1px solid #f0f0f0; 
  display: flex; flex-direction: column; transition: transform 0.15s; scroll-margin-top: 200px; 
}
.p-card::after {
  content: ''; position: absolute; inset: 0;
  background: rgba(255, 241, 118, 0.4);
  border-radius: 16px;
  opacity: 0; pointer-events: none; z-index: 10;
  transition: opacity 0.3s;
}
.flash-highlight::after {
  animation: flashOverlay 0.6s ease-in-out 2;
}
@keyframes flashOverlay {
  0%, 100% { opacity: 0; }
  50% { opacity: 1; border: 3px solid #fdd835; }
}

.p-card:active { transform: scale(0.97); }
.p-no-img { font-size: 12px; color: #b0bec5; display: flex; flex-direction: column; align-items: center; }
.badges { position: absolute; top: 8px; left: 8px; display: flex; flex-direction: column; gap: 4px; z-index: 2; align-items: flex-start; }
.badge { font-size: 10px; padding: 4px 8px; border-radius: 6px; color: #fff; font-weight: 700; box-shadow: 0 2px 6px rgba(0,0,0,0.2); letter-spacing: 0.5px; backdrop-filter: blur(4px); }
.bg-red { background: rgba(239, 83, 80, 0.95); }
.new-badge{
  position:absolute; right:8px; bottom:8px;
  z-index:2;
  padding:5px 10px;
  border-radius:999px;
  font-size:10px;
  font-weight:900;
  letter-spacing:0.8px;
  color: var(--new-badge-text, #ffffff);
  background: var(--new-badge-bg, linear-gradient(135deg, #ff5a8a, #ff8fb3));
  box-shadow: 0 8px 18px rgba(0,0,0,0.14);
  border: 1px solid rgba(255,255,255,0.35);
  pointer-events:none;
}

.bg-blue { background: rgba(66, 165, 245, 0.95); }
.bg-gold { background: linear-gradient(135deg, #ffa726, #fb8c00); }
.bg-purple { background: rgba(171, 71, 188, 0.95); }
.bg-teal { background: #26a69a; }

.p-body { padding: 12px; flex: 1; display: flex; flex-direction: column; justify-content: space-between; position: relative; }
.p-title { font-size: 14px; font-weight: 700; line-height: 1.4; color: #37474f; margin-bottom: 4px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; height: 40px; }
.p-code { font-size: 11px; color: #cfd8dc; margin-bottom: 8px; }
.p-code-chip{
  position: absolute;
  top: -10px;
  left: 11px; /* 微調往左 1px */
  z-index: 3;
  font-size: 10px; /* 字體縮小 1px */
  font-weight: 800;
  letter-spacing: 0.2px;
  color: #b0bec5; /* 比刪除線(#90a4ae)更淡 */
  background: transparent; /* 去背：無底色 */
  border: none; /* 去背：無邊框 */
  padding: 0;
  border-radius: 0;
  box-shadow: none;
  pointer-events: none;
}


.p-pill-row{ margin-top: 6px; }

.p-price-row { display: flex; align-items: baseline; gap: 6px; margin-top: 2px; justify-content: flex-start; }
.p-price { font-size: var(--price-size-lg); font-weight: 800; color: #263238; }
.p-price.strike { font-weight: 600; color: #90a4ae; text-decoration: line-through; }



.p-price-pill{
  font-size:12px;
  font-weight:800;
  color:#c62828;
  background:rgba(198,40,40,.08);
  border:1px solid rgba(198,40,40,.22);
  padding:2px 8px;
  border-radius:999px;
  line-height:1.2;
  white-space:nowrap;
}

.p-price-pill .pill-label{
  font-size:0.7em; /* 折後字型縮小30% */
  font-weight:800;
  margin-right:4px;
}



.p-price-pill{ display: inline-flex; align-items: baseline; }

.p-price-pill .pill-value{
  font-size: var(--price-size);
  font-weight: 900;
  line-height: 1;
}

.p-buy-row{
  display: flex;
  align-items: center;
  justify-content: flex-end; /* stepper 永遠靠右，避免擠壓 */
  gap: 10px;
  margin-top: 10px;
}
.p-buy-row.no-pill{ justify-content: flex-end; }
.p-buy-row .stepper{ margin-top: 0 !important; }

.stepper { display: flex; align-items: center; justify-content: flex-end; gap: 8px; margin-top: 10px; }
.s-btn { 
  width: 32px; height: 32px; border-radius: 50%; border: 1px solid #eceff1; background: #fff; color: var(--primary); 
  font-size: 20px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; position: relative;
}
.s-btn::after { content: ''; position: absolute; top: -10px; bottom: -10px; left: -10px; right: -10px; }
.s-btn:active { background: var(--primary-light); transform: scale(0.9); }
.s-btn.add { background: var(--primary); color: #fff; border-color: var(--primary); box-shadow: 0 2px 5px rgba(0,137,123,0.3); }
.s-val { width: 24px; text-align: center; font-size: 15px; font-weight: 600; color: #37474f; }
.s-btn.hidden, .s-val.hidden { display: none; }
.btn-bundle { width: 100%; margin-top: 8px; padding: 10px; border: 1px dashed var(--primary); border-radius: 10px; color: var(--primary); background: var(--primary-light); font-size: 13px; font-weight: 700; text-align: center; cursor: pointer; transition: 0.2s; }
.btn-bundle:active { transform: scale(0.98); background: #b2dfdb; }

/* Header & Nav */
header { position: sticky; top: 0; z-index: 1000; background: rgba(255,255,255,0.98); box-shadow: 0 2px 15px rgba(0,0,0,0.03); backdrop-filter: blur(12px); }
.search-wrap { padding: 8px 16px 0 16px; }
.search-box { position: relative; width: 100%; }
.search-box input { width: 100%; padding: 10px 12px 10px 42px; border-radius: 12px; border: 1px solid #e0e0e0; background: #f5f7f9; font-size: 15px; transition: 0.3s; }
.search-box input:focus { background: #fff; border-color: var(--primary); outline: none; box-shadow: 0 0 0 3px rgba(0,137,123,0.1); }
.search-box .icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-sub); }

/* --- OPTIMIZATION 2: Clear Search Button --- */
.clear-btn { 
  position: absolute; right: 10px; top: 50%; transform: translateY(-50%); 
  color: #90a4ae; cursor: pointer; font-size: 20px; padding: 4px; border-radius: 50%;
  display: none; /* Default Hidden */
}
.clear-btn:active { background: #eceff1; color: #546e7a; }

.cat-nav { display: flex; gap: 8px; padding: 8px 16px 12px 16px; overflow-x: auto; scrollbar-width: none; }
.cat-nav::-webkit-scrollbar { display: none; }
.cat-pill { white-space: nowrap; padding: 7px 18px; border-radius: 24px; font-size: 14px; font-weight: 500; color: var(--text-sub); background: #fff; border: 1px solid #e0e0e0; cursor: pointer; transition: 0.25s cubic-bezier(0.25, 0.8, 0.25, 1); }
.cat-pill.active { background: var(--primary); color: #fff; border-color: var(--primary); box-shadow: 0 4px 10px rgba(0,137,123,0.25); font-weight: 700; transform: scale(1.02); }

/* Drawer Core */
#drawer { position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 1200; pointer-events: none; }
#drawer-bg { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); opacity: 0; transition: 0.3s; backdrop-filter: blur(4px); }
#drawer-panel { position: absolute; top: 0; right: 0; bottom: 0; width: 100%; max-width: 480px; background: #fff; transform: translateX(100%); transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1); display: flex; flex-direction: column; pointer-events: auto; box-shadow: -5px 0 30px rgba(0,0,0,0.15); }
#drawer.open #drawer-bg { opacity: 1; pointer-events: auto; }
#drawer.open #drawer-panel { transform: translateX(0); }
.dr-head { padding: 16px 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: #fff; flex-shrink: 0; }
.dr-body { flex: 1; overflow-y: auto; padding: 12px; background: #f4f6f8; overscroll-behavior: contain; }
.dr-foot { padding: 20px; padding-bottom: calc(20px + var(--safe-bottom)); background: #fff; border-top: 1px solid var(--border); box-shadow: 0 -4px 20px rgba(0,0,0,0.05); flex-shrink: 0; }

.c-item { display: flex; gap: 10px; margin-bottom: 8px; padding: 8px 12px; background: #fff; border-radius: 10px; border: 1px solid #e0e0e0; box-shadow: 0 1px 2px rgba(0,0,0,0.02); align-items: center; }
.c-info { flex: 1; }
.c-title { font-size: 14px; margin-bottom: 2px; line-height: 1.3; font-weight: 700; color:#37474f; }
.c-spec { font-size: 12px; margin-bottom: 2px; color:#90a4ae; }
.c-price-box { margin-top: 2px; font-weight:700; font-size:15px; color:#263238; }
.c-old { text-decoration: line-through; color: #90a4ae; font-size: 12px; margin-right: 6px; }
.c-tags { margin-top: 2px; }
.c-tag { font-size: 11px; padding: 3px 8px; border-radius: 6px; font-weight: 600; display: inline-flex; align-items: center; gap: 4px; }
.c-tag.save { background: #fff3e0; color: #e65100; border: 1px solid #ffe0b2; }
.c-tag.warn { background: #ffebee; color: #c62828; border: 1px solid #ffcdd2; }
.c-ctrl { display: flex; flex-direction: column; align-items: flex-end; justify-content: center; }

/* Modals Misc */
.balloon-card { background: rgba(255, 255, 255, 0.9); width: 85%; max-width: 360px; padding: 40px 30px; border-radius: 40px 40px 40px 10px; box-shadow: 0 20px 50px rgba(0, 137, 123, 0.2); text-align: center; border: 1px solid rgba(255, 255, 255, 0.5); animation: floatBalloon 3s ease-in-out infinite; position: relative; }
.balloon-card::after { content: ''; position: absolute; bottom: -15px; left: 10px; width: 0; height: 0; border-left: 15px solid transparent; border-right: 0 solid transparent; border-top: 20px solid rgba(255, 255, 255, 0.9); transform: rotate(10deg); }
@keyframes floatBalloon { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
.w-logo { font-size: 48px; margin-bottom: 16px; display: inline-block; }
.w-title { font-size: 22px; font-weight: 900; color: var(--primary); margin-bottom: 8px; line-height: 1.3; }
.w-sub { font-size: 14px; color: var(--text-sub); margin-bottom: 32px; font-weight: 500; line-height: 1.6; }
.w-btn { background: var(--primary); color: #fff; border: none; padding: 14px 40px; border-radius: 50px; font-size: 16px; font-weight: 700; cursor: pointer; box-shadow: 0 8px 20px rgba(0, 137, 123, 0.3); transition: 0.2s; }
.w-btn:active { transform: scale(0.95); background: #00796b; }

.gamification-box { padding: 16px 20px; background: linear-gradient(to bottom, #fff, #fcfcfc); border-bottom: 1px solid #f0f0f0; }
.game-txt { font-size: 13px; font-weight: 700; color: #37474f; display: flex; justify-content: space-between; align-items: center; transition: all 0.3s; }
.game-txt.success { color: #2e7d32; }
.game-icon-wrap { cursor: pointer; padding: 4px 8px; background: #fff8e1; border-radius: 20px; border: 1px solid #ffe0b2; display: flex; align-items: center; gap: 4px; transition: 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
.game-icon-wrap:active { transform: scale(0.95); background: #ffecb3; }
.game-icon { transition: all 0.3s; font-size: 16px; }
.game-hint { font-size: 11px; color: var(--accent); }


/* V2.8.12: cart motivation text +20% */
#gameMsg{ font-size: 1.2em; }
.progress-wrap { height: 10px; width: 100%; background: #eee; border-radius: 5px; overflow: hidden; margin-top: 8px; }
.progress-bar { height: 100%; width: 0%; background: linear-gradient(90deg, #ffca28, #ff6f00); border-radius: 5px; transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1); }
.progress-bar.full { background: linear-gradient(90deg, #66bb6a, #43a047); }

.gift-list { display: flex; flex-direction: column; gap: 8px; padding: 8px 4px; flex: 1; overflow-y: auto; min-height: 0; }
.gift-item { display: flex; align-items: center; gap: 12px; padding: 12px; border-radius: 12px; border: 1px dashed #e0e0e0; color: #bdbdbd; transition: 0.3s; flex-shrink: 0; }
.gift-item.unlocked { background: #f1f8e9; border: 1px solid #c5e1a5; color: #33691e; box-shadow: 0 4px 10px rgba(0,0,0,0.05); transform: scale(1.02); }
.g-status { font-size: 20px; }
.g-info { flex: 1; overflow: hidden; }
.g-amt { font-size: 12px; font-weight: 700; margin-bottom: 2px; }
.g-name { font-size: 14px; }
.g-tag { font-size: 10px; background: #fff; padding: 2px 6px; border-radius: 4px; border: 1px solid #a5d6a7; color: #2e7d32; display: inline-block; margin-top: 4px; }


/* V2.8.12: Gift list section title with current spend */
.g-section-title{
  display:flex; align-items:center; justify-content:space-between; gap:10px;
  padding: 8px 10px; margin: 10px 0 4px;
  border-radius: 12px;
  background: rgba(96,125,139,0.08);
  border: 1px solid rgba(96,125,139,0.16);
  color: #37474f;
  font-size: 13px;
  font-weight: 900;
}
.g-section-title.beauty{
  background: rgba(236,64,122,0.08);
  border-color: rgba(236,64,122,0.16);
}
.g-section-amt{
  font-size: 11px;
  font-weight: 800;
  color: #607d8b;
  white-space: nowrap;
}
@keyframes shimmer { 0% { background-position: -468px 0; } 100% { background-position: 468px 0; } }
.skeleton { background: #f6f7f8; background-image: linear-gradient(to right, #f6f7f8 0%, #edeef1 20%, #f6f7f8 40%, #f6f7f8 100%); background-repeat: no-repeat; background-size: 800px 104px; animation: shimmer 1s linear infinite forwards; border-radius: 8px; }
.sk-card { height: 280px; border-radius: 16px; background: #fff; padding: 12px; margin-bottom: 12px; }

#toast-container { position: fixed; bottom: 90px; left: 50%; transform: translateX(-50%); z-index: 9999; pointer-events: none; width: 90%; max-width: 320px; display: flex; flex-direction: column-reverse; gap: 8px; align-items: center; }
.toast { background: rgba(33, 33, 33, 0.95); color: #fff; padding: 12px 24px; border-radius: 50px; font-size: 14px; text-align: center; box-shadow: 0 8px 20px rgba(0,0,0,0.2); opacity: 0; transform: translateY(20px); animation: toastIn 0.3s forwards, toastOut 0.3s forwards 2.5s; backdrop-filter: blur(4px); display: flex; align-items: center; justify-content: center; gap: 8px; transition: 0.3s; }
.toast.game { background: linear-gradient(135deg, #ffa726, #ff6f00); font-weight: 700; box-shadow: 0 10px 25px rgba(255, 111, 0, 0.4); }
@keyframes toastIn { to { opacity: 1; transform: translateY(0); } }
@keyframes toastOut { to { opacity: 0; transform: translateY(-10px); } }

@keyframes flashWarn { 0%, 100% { background: #ffebee; transform: translateX(0); } 20%, 60% { background: #ff5252; color: #fff; transform: translateX(-5px); } 40%, 80% { background: #ff5252; color: #fff; transform: translateX(5px); } }
.flash-anim { animation: flashWarn 0.6s ease-in-out; }
.input-error { border-color: #ef5350 !important; background: #ffebee !important; }

.sum-card { background: #fff; border-radius: 12px; border: 1px solid #e0e0e0; margin-top: 15px; overflow: hidden; }
.sum-head { padding: 12px 16px; background: #f5f5f5; font-size: 14px; font-weight: 700; display: flex; justify-content: space-between; align-items: center; cursor: pointer; color: #37474f; transition: 0.2s; }
.sum-head:hover { background: #eeeeee; }
.sum-body { display: none; padding: 12px 16px; font-size: 13px; color: #546e7a; line-height: 1.6; background: #fff; }
.sum-body.open { display: block; animation: slideDown 0.2s ease-out; }
@keyframes slideDown { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
.sum-line { display: flex; justify-content: space-between; border-bottom: 1px dashed #eee; padding: 6px 0; }

.form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 15px; }
input, select { width: 100%; padding: 14px; border: 1px solid #cfd8dc; border-radius: 12px; font-size: 14px; background: #fafafa; transition: 0.2s; }
input:focus, select:focus { border-color: var(--primary); background: #fff; outline: none; box-shadow: 0 0 0 3px rgba(0,137,123,0.1); }
.btn-bar { display: flex; gap: 10px; margin-top: 20px; }
.btn-submit { flex: 2; padding: 16px; background: var(--text-main); color: #fff; border: none; border-radius: 14px; font-size: 16px; font-weight: 700; cursor: pointer; transition: 0.2s; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
.btn-submit:active { transform: scale(0.98); opacity: 0.9; }
.btn-clear { flex: 0 0 50px; padding: 0; background: #ffebee; color: #ef5350; border: none; border-radius: 14px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; }
.btn-clear:active { background: #ffcdd2; }
.promo-bar { background: #e8f5e9; color: #1b5e20; padding: 12px 16px; font-size: 13px; display: flex; align-items: center; gap: 8px; border-bottom: 1px solid #c8e6c9; font-weight: 500; }

.modal { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 2000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(6px); }
.modal.open { display: flex; animation: fadeIn 0.2s ease-out; }
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
.m-box { background: #fff; width: 90%; max-width: 420px; border-radius: 24px; padding: 24px; max-height: 85vh; display: flex; flex-direction: column; box-shadow: 0 25px 50px rgba(0,0,0,0.25); transform: scale(0.95); transition: 0.2s; }
.modal.open .m-box { transform: scale(1); }
.m-head { font-size: 20px; font-weight: 700; margin-bottom: 8px; text-align: center; color: #263238; flex-shrink: 0; }
.m-sub { text-align: center; color: #78909c; font-size: 14px; margin-bottom: 20px; flex-shrink: 0; }
.m-grid { display: flex; flex-direction: column; gap: 10px; overflow-y: auto; padding: 4px; flex: 1; min-height: 0; }
.m-row { display: flex; justify-content: space-between; align-items: center; padding: 16px; border: 1px solid #eceff1; border-radius: 16px; transition: 0.2s; background: #fafafa; flex-shrink: 0; }
.m-row:hover { background: #fff; border-color: var(--primary); box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
.m-name { font-weight: 700; font-size: 15px; color: #37474f; }
.m-ctrl { display: flex; align-items: center; gap: 12px; }
.m-btn-s { width: 32px; height: 32px; border-radius: 50%; background: #fff; border: 1px solid #cfd8dc; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 18px; color: var(--primary); transition: 0.1s; position: relative; }
.m-btn-s::after { content: ''; position: absolute; top: -10px; bottom: -10px; left: -10px; right: -10px; }
.m-btn-s:active { background: var(--primary); color: #fff; border-color: var(--primary); }
.m-val { font-weight: 700; width: 24px; text-align: center; font-size: 16px; }
.m-acts { display: flex; gap: 12px; margin-top: 24px; flex-shrink: 0; }
.m-btn { flex: 1; padding: 14px; border-radius: 12px; border: none; font-weight: 700; cursor: pointer; font-size: 16px; transition: 0.2s; }
.m-btn.disabled { opacity: 0.5; pointer-events: none; background: #cfd8dc; }
#empty-state { text-align: center; margin-top: 80px; color: #b0bec5; display: none; }

.receipt-paper { background: #fff; padding: 0; width: 100%; border-radius: 0; box-shadow: none; display: flex; flex-direction: column; height: 100%; }
.rc-head { background: var(--primary); color: #fff; padding: 20px; text-align: center; }
.rc-body { flex: 1; overflow-y: auto; padding: 20px; background: #fff; }
.rc-row { display: flex; justify-content: space-between; margin-bottom: 12px; font-size: 14px; color: #455a64; }
.rc-row.bold { font-weight: 700; color: #263238; font-size: 16px; margin-top: 10px; padding-top: 10px; border-top: 2px dashed #eceff1; }
.rc-item { margin-bottom: 15px; border-bottom: 1px dashed #eee; padding-bottom: 8px; }
.rc-name { font-weight: 700; color: #37474f; margin-bottom: 4px; }
.rc-meta { display: flex; justify-content: space-between; font-size: 13px; color: #78909c; }
.rc-actions { padding: 20px; background: #fafafa; border-top: 1px solid #eee; }
.btn-email { width: 100%; padding: 12px; border: 1px solid #cfd8dc; background: #fff; border-radius: 10px; color: #546e7a; font-weight: 700; display: flex; align-items: center; justify-content: center; gap: 8px; margin-bottom: 10px; }
.btn-close-rc { width: 100%; padding: 14px; background: var(--text-main); color: #fff; border: none; border-radius: 10px; font-weight: 700; font-size: 16px; }
.email-input-box { display: none; gap: 8px; margin-bottom: 10px; }
.email-input-box.show { display: flex; }

.flying-gift { position: fixed; z-index: 1300; pointer-events: none; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.3); width: 60px; height: 60px; object-fit: contain; background: #fff; border: 2px solid #ffca28; }


/* --- Step 2 New CSS: Delivery Form --- */
.delivery-toggle-wrap { position: relative; margin: 10px 0; padding: 10px; background: #fff3e0; border-radius: 8px; border: 1px solid #ffe0b2; }
.d-toggle-label { display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 15px; color: #e65100; font-weight: 700; }
.d-toggle-label input { width: 20px; height: 20px; margin: 0; accent-color: #ef6c00; }
.delivery-form { display: none; flex-direction: column; gap: 10px; margin-top: 10px; padding-top: 10px; border-top: 1px dashed #ffcc80; animation: slideDown 0.3s ease-out; }
.delivery-form.show { display: flex; }
.d-input { border: 1px solid #ffcc80 !important; background: #fff !important; }
.d-input:focus { border-color: #ef6c00 !important; box-shadow: 0 0 0 3px rgba(239, 108, 0, 0.2) !important; }

.d-toggle-label { padding-right: 64px; }
.d-collapse-btn { position: absolute; top: 8px; right: 8px; border: none; background: #ef6c00; color: #fff; font-size: 12px; font-weight: 700; padding: 4px 10px; border-radius: 999px; cursor: pointer; display: none; }
.d-collapse-btn:hover { filter: brightness(0.95); }
.d-collapse-btn:active { transform: translateY(1px); }


/* --- V2.8: Delivery free-shipping badge + better spacing when expanded --- */
.ship-free-badge{
  position:absolute;
  top:8px;
  right:72px;
  display:none;
  align-items:center;
  gap:4px;
  padding:4px 10px;
  border-radius:999px;
  font-size:12px;
  font-weight:800;
  white-space:nowrap;
  border:1px solid;
}
.ship-free-badge.ok{ background:#e8f5e9; border-color:#c8e6c9; color:#2e7d32; }
.ship-free-badge:not(.ok){ background:#fff8e1; border-color:#ffe0b2; color:#e65100; }
.delivery-toggle-wrap.has-badge .d-toggle-label{ padding-right: 168px; }

@media (max-width: 480px){
  .ship-free-badge{ top:6px; right:66px; font-size:11px; padding:3px 8px; }
  .delivery-toggle-wrap.has-badge .d-toggle-label{ padding-right: 156px; }
}

/* --- V2.8: Auto-scroll target highlight --- */
.cat-section.zone-highlight{
  outline: 2px solid #ffca28;
  box-shadow: 0 0 0 6px rgba(255,202,40,0.18);
  border-radius: 18px;
}


/* --- V2.3 Cart Compact Header/Footer (mobile) --- */
@media (max-width: 480px){
  /* Header */
  .dr-head{ padding:10px 14px; }
  .dr-head h2{ font-size:18px !important; }
  .dr-head .material-icons-round{ font-size:22px !important; }
  .dr-head > span.material-icons-round{ padding:6px !important; }

  /* Progress strip */
  .gamification-box{ padding:10px 14px; }
  .game-txt{ font-size:12px; }
  .game-icon{ font-size:15px; }
  .game-icon-wrap{ padding:3px 7px; }
  .progress-wrap{ height:8px; margin-top:6px; }

  /* Body */
  .dr-body{ padding:10px; }

  /* Footer */
  /* Footer */
  .dr-foot{ padding:8px 14px; padding-bottom: calc(8px + var(--safe-bottom)); }
.delivery-toggle-wrap{ margin:8px 0; padding:8px; }
  .d-toggle-label{ font-size:14px; }
  .delivery-form{ gap:8px; margin-top:8px; padding-top:8px; }

  
  /* Footer summary spacing (mobile) */
  .dr-foot > div:nth-child(1){ margin-top:2px !important; margin-bottom:2px !important; }
  .dr-foot > div:nth-child(2){ margin-bottom:2px !important; }
  .dr-foot > div:nth-child(3){ margin-bottom:2px !important; }
  .dr-foot > div:nth-child(4){ margin-top:5px !important; padding-top:5px !important; }

/* Form controls only inside cart drawer */
  #drawer-panel input, #drawer-panel select{ padding:12px; font-size:13px; }
  .form-grid{ gap:10px; margin-top:12px; }
.checkout-details{
  margin-top: 12px;
  overflow: hidden;
  transform-origin: top;
  transition: max-height .38s cubic-bezier(.2,.9,.2,1), opacity .22s ease, transform .38s cubic-bezier(.2,.9,.2,1);
  max-height: 720px;
}
.checkout-details.collapsed{
  max-height: 0px;
  opacity: 0;
  transform: translateY(-6px);
  pointer-events: none;
}
.checkout-details:not(.collapsed){
  opacity: 1;
  transform: translateY(0px);
  pointer-events: auto;
}

  /* Buttons */
  .btn-bar{ margin-top:14px; }
  .btn-submit{ padding:14px; font-size:15px; border-radius:14px; }
  .btn-clear{ flex:0 0 46px; }

  /* Summary */
  .sum-card{ margin-top:10px; }
  .sum-head{ padding:10px 14px; font-size:13px; }
}

/* --- V2.8.8: System announcement slot (between rankings and categories) --- */
#systemAnnouncementSlot{ padding:0 14px; margin: 10px 0 6px; }
.sys-ann{
  background: rgba(0,137,123,0.08);
  border: 1px solid rgba(0,137,123,0.18);
  color: #004d40;
  border-radius: 14px;
  padding: 10px 12px;
  font-size: 13px;
  line-height: 1.35;
  box-shadow: 0 6px 18px rgba(0,0,0,0.04);
}
.sys-ann .title{ font-weight: 800; margin-bottom: 4px; }

@media (max-width:380px){
  .sys-ann--row{ flex-wrap:nowrap; }
  .sys-ann-main{ flex:1 1 auto; }
  .sys-ann-cta .cta-text{ display:none; }
  .sys-ann-cta{ padding: 8px 10px; }
}


/* --- V2.8.9: Promo Map (優惠地圖) entry + drawer --- */
.sys-ann--row{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  flex-wrap:nowrap;
}
.sys-ann-main{ flex: 1 1 200px; min-width: 0;
  overflow:hidden;
}
.sys-ann-main .title{white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
.sys-ann-main .desc{white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
.sys-ann-cta{
  flex: 0 0 auto;
  border: 1px solid rgba(0,137,123,0.35);
  background: rgba(255,255,255,0.85);
  color: #004d40;
  border-radius: 999px;
  padding: 8px 12px;
  font-weight: 800;
  font-size: 13px;
  white-space: nowrap;
  cursor: pointer;
  transition: transform .12s ease, box-shadow .18s ease, background .18s ease, border-color .18s ease;
}
.sys-ann-cta:active{ transform: translateY(1px); }

.sys-ann-cta .cta-icon{
  display:inline-block;
  margin-right: 6px;
  font-weight: 900;
  color: var(--ann-icon-fg, #ff6f00);
}
.sys-ann-cta .cta-text{ display:inline-block; }

.sys-ann-cta.pm-attn{
  border-color: rgba(255,111,0,0.55);
  background: linear-gradient(135deg, rgba(255,111,0,0.16), rgba(255,111,0,0.03));
  box-shadow: 0 10px 24px rgba(255,111,0,0.18);
  animation: pmShake 1.15s ease-in-out infinite, pmGlow 1.55s ease-in-out infinite;
}
@keyframes pmShake{
  0%, 100%{ transform: translateX(0); }
  12%{ transform: translateX(-2px); }
  24%{ transform: translateX(2px); }
  36%{ transform: translateX(-2px); }
  48%{ transform: translateX(1px); }
  60%{ transform: translateX(0); }
}
@keyframes pmGlow{
  0%, 100%{ filter: drop-shadow(0 0 0 rgba(255,111,0,0)); }
  50%{ filter: drop-shadow(0 0 8px rgba(255,111,0,0.35)); }
}

/* Drawer */
body.drawer-open { overflow:hidden; }
.pm-overlay{
  position:fixed; inset:0;
  background: rgba(0,0,0,0.30);
  backdrop-filter: blur(2px);
  z-index: 9998;
  display:none;
}
.pm-drawer{
  position:fixed;
  top:0; right:0;
  height:100%;
  width:min(336px, 74vw);
  background:#fff;
  z-index: 9999;
  transform: translateX(102%);
  transition: transform .22s ease;
  box-shadow: -18px 0 40px rgba(0,0,0,0.18);
  border-left: 1px solid rgba(0,0,0,0.06);
  display:flex;
  flex-direction:column;
}
.pm-drawer.open{ transform: translateX(0); }
.pm-header{
  padding: 14px 14px 10px;
  border-bottom: 1px solid rgba(0,0,0,0.06);
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
}
.pm-title{
  font-size: 16px;
  font-weight: 900;
  color: #0b4f49;
  letter-spacing: .2px;
}
.pm-close{
  border: none;
  background: rgba(0,0,0,0.05);
  border-radius: 12px;
  padding: 8px 10px;
  cursor:pointer;
}
.pm-body{
  padding: 12px 14px 14px;
  overflow:auto;
}
.pm-sub{
  font-size: 12px;
  color: #607d8b;
  margin-bottom: 10px;
  line-height: 1.35;
}
.pm-list{ display:flex; flex-direction:column; gap:10px; }
.pm-item{
  border: 1px solid rgba(0,0,0,0.06);
  border-radius: 16px;
  padding: 10px 12px;
  box-shadow: 0 8px 18px rgba(0,0,0,0.04);
  cursor:pointer;
  transition: transform .12s ease, box-shadow .18s ease;
}
.pm-item:active{ transform: translateY(1px); }
.pm-item:hover{ box-shadow: 0 10px 24px rgba(0,0,0,0.06); }
.pm-item .row{ display:flex; align-items:flex-start; justify-content:space-between; gap:10px; }
.pm-item .name{ font-weight: 900; color: #263238; }
.pm-item .hint{ margin-top: 4px; font-size: 12px; color: #455a64; line-height: 1.35; }
.pm-tags{ display:flex; gap:6px; flex-wrap:wrap; margin-top: 6px; }
.pm-tag{
  font-size: 11px;
  padding: 2px 8px;
  border-radius: 999px;
  background: rgba(0,137,123,0.10);
  color:#004d40;
  border:1px solid rgba(0,137,123,0.18);
}
.pm-arrow{ color:#90a4ae; font-size: 18px; line-height:1; }


/* --- V29: Promo Map Tabs (優惠分類 / 贈品門檻) --- */
.pm-head-left{ display:flex; align-items:center; gap:10px; min-width:0; }
.pm-tabs{
  display:flex; align-items:center;
  padding: 3px;
  border-radius: 999px;
  background: rgba(255,255,255,0.58);
  border: 1px solid rgba(0,0,0,0.08);
  box-shadow: 0 10px 22px rgba(0,0,0,0.08);
}
.pm-tab{
  border:0; background:transparent;
  padding: 7px 10px;
  border-radius: 999px;
  font-size: 12px;
  font-weight: 900;
  color:#335c5a;
  cursor:pointer;
  white-space:nowrap;
  line-height:1;
}
.pm-tab.active{
  background: rgba(0,137,123,0.22);
  color:#003b35;
}
.pm-tab:active{ transform: translateY(1px); }

.pm-pane{ min-height: 1px; }

.pm-scope{ display:flex; gap:8px; margin: 10px 2px 12px; }
.pm-scope-btn{
  border:1px solid rgba(0,0,0,0.08);
  background: rgba(255,255,255,0.80);
  border-radius: 999px;
  padding: 7px 10px;
  font-size: 12px;
  font-weight: 900;
  color:#335c5a;
  cursor:pointer;
  line-height:1;
}
.pm-scope-btn[data-scope="all"].active{
  background: rgba(230,81,0,0.14);
  border-color: rgba(230,81,0,0.24);
  color:#b54a00;
}
.pm-scope-btn[data-scope="zone_prefix"].active{
  background: rgba(216,27,96,0.12);
  border-color: rgba(216,27,96,0.22);
  color:#ad1457;
}
.pm-scope-btn[data-scope="series"].active{
  background: rgba(67,160,71,0.12);
  border-color: rgba(67,160,71,0.22);
  color:#2e7d32;
}
.pm-scope-btn:active{ transform: translateY(1px); }

/* 贈品門檻（全區/美容）視覺區隔：徽章 + 摘要 */
.pm-gift-header{
  border: 1px solid rgba(0,0,0,0.06);
  border-radius: 16px;
  padding: 10px 12px;
  background: rgba(255,255,255,0.86);
  box-shadow: 0 10px 20px rgba(0,0,0,0.04);
  margin-top: 10px;
}
.pm-gh-top{ display:flex; align-items:flex-start; gap:10px; }
.pm-badge{
  font-size: 10px;
  font-weight: 900;
  padding: 4px 8px;
  border-radius: 999px;
  line-height: 1;
  border: 1px solid transparent;
  letter-spacing: .2px;
  flex: 0 0 auto;
}
.pm-badge-all{
  background: rgba(230,81,0,0.12);
  border-color: rgba(230,81,0,0.22);
  color:#b54a00;
}
.pm-badge-beauty{
  background: rgba(216,27,96,0.10);
  border-color: rgba(216,27,96,0.20);
  color:#ad1457;
}
.pm-badge-series{
  background: rgba(67,160,71,0.12);
  border-color: rgba(67,160,71,0.22);
  color:#2e7d32;
}
.pm-gh-text{ display:flex; flex-direction:column; gap:2px; min-width:0; }
.pm-gh-title{ font-weight: 900; font-size: 13px; color:#263238; line-height:1.15; }
.pm-gh-sub{ font-weight: 700; font-size: 11px; color:#607d8b; line-height:1.2; }

#promoMapPaneGifts.scope-all .pm-gift-header{ background: rgba(255,243,224,0.70); }
#promoMapPaneGifts.scope-beauty .pm-gift-header{ background: rgba(252,228,236,0.70); }
#promoMapPaneGifts.scope-series .pm-gift-header{ background: rgba(232,245,233,0.78); }

/* 贈品門檻清單卡：色帶＋標籤配色 */
.pm-gift-item{ position: relative; overflow: hidden; }
.pm-gift-item.pm-gift-all{ border-left: 4px solid rgba(230,81,0,0.55); }
.pm-gift-item.pm-gift-beauty{ border-left: 4px solid rgba(216,27,96,0.45); }
.pm-gift-item.pm-gift-series{ border-left: 4px solid rgba(46,125,50,0.38); }
.pm-gift-item.pm-gift-all .pm-gift-amt{
  background: rgba(230,81,0,0.10);
  border-color: rgba(230,81,0,0.18);
  color:#b54a00;
}
.pm-gift-item.pm-gift-beauty .pm-gift-amt{
  background: rgba(216,27,96,0.10);
  border-color: rgba(216,27,96,0.18);
  color:#ad1457;
}
.pm-gift-item.pm-gift-series .pm-gift-amt{
  background: rgba(67,160,71,0.10);
  border-color: rgba(67,160,71,0.18);
  color:#2e7d32;
}


.pm-gift-list{ display:flex; flex-direction:column; gap:10px; }
.pm-gift-item{
  border: 1px solid rgba(0,0,0,0.06);
  border-radius: 18px;
  padding: 12px 12px;
  background: rgba(255,255,255,0.92);
  box-shadow: 0 10px 22px rgba(0,0,0,0.05);
}
.pm-gift-row{ display:flex; gap:12px; align-items:center; }
.pm-gift-media{ flex: 0 0 90px; }
.pm-gift-media .g-img-row{ display:flex; gap:6px; flex-wrap:wrap; align-items:center; }
.pm-gift-media .g-thumb{ width: 78px; height: 78px; object-fit: contain; border: 1px solid #eee; border-radius: 14px; background:#fff; }
.pm-gift-media .g-thumb:not(:first-child){ display:none; } /* 只秀第一張，保持版面乾淨 */
.pm-gift-info{ flex:1; min-width:0; display:flex; flex-direction:column; gap:6px; }
.pm-gift-amt{
  display:inline-flex;
  align-items:center;
  gap:6px;
  align-self:flex-start;
  font-weight: 900;
  font-size: 13px;
  color:#263238;
  padding: 6px 10px;
  border-radius: 999px;
  background: rgba(0,137,123,0.10);
  border: 1px solid rgba(0,137,123,0.16);
  line-height: 1;
}
.pm-gift-name{
  font-weight: 900;
  font-size: 14px;
  color:#263238;
  line-height: 1.25;
  word-break: break-word;
}

.pm-gift-note{ font-weight: 800; font-size: 11px; color:#607d8b; line-height:1.2; }

.pm-empty{
  padding: 12px 12px;
  border-radius: 14px;
  border: 1px dashed rgba(0,0,0,0.12);
  background: rgba(255,255,255,0.75);
  color:#607d8b;
  font-size: 12px;
  line-height: 1.35;
}


/* --- V2.8.11: Promo Map styling (配色＋卡片層次) --- */
.pm-overlay{
  background: rgba(9,30,29,0.34);
  backdrop-filter: blur(3px);
}
.pm-drawer{
  background: linear-gradient(180deg, rgba(224,242,241,0.70) 0%, rgba(255,255,255,1) 160px);
}
.pm-header{
  background: linear-gradient(135deg, rgba(0,137,123,0.20) 0%, rgba(255,111,0,0.10) 100%);
  border-bottom: 1px solid rgba(0,0,0,0.05);
}
.pm-title{ color: #003b35; }
.pm-close{
  background: rgba(255,255,255,0.65);
  border: 1px solid rgba(0,0,0,0.08);
  box-shadow: 0 8px 18px rgba(0,0,0,0.08);
}
.pm-body{
  background: linear-gradient(180deg, rgba(248,249,250,0.65), rgba(255,255,255,0));
}
.pm-sub{
  padding: 10px 10px;
  border-radius: 14px;
  background: rgba(255,255,255,0.85);
  border: 1px dashed rgba(0,137,123,0.22);
  color: #335c5a;
}
.pm-item{
  background: rgba(255,255,255,0.92);
  position: relative;
  padding-left: 18px;
}
.pm-item::before{
  content: '';
  position: absolute;
  left: 10px;
  top: 12px;
  bottom: 12px;
  width: 4px;
  border-radius: 8px;
  background: var(--pm-accent, rgba(0,137,123,0.22));
}
.pm-item[data-kind="order"]{ --pm-accent: rgba(0,137,123,0.85); }
.pm-item[data-kind="tier"]{ --pm-accent: rgba(106,27,154,0.75); }
.pm-item[data-kind="bogo"]{ --pm-accent: rgba(25,118,210,0.78); }
.pm-item[data-kind="addon"]{ --pm-accent: rgba(216,67,21,0.78); }

/* V2.8.12: Promo Map 左側色條改為品牌色（依分類大類） */
.pm-item[data-brand="beauty"]{ --pm-accent: var(--pm-accent-beauty, rgba(236, 64, 122, 0.78)); }   /* 粉 */
.pm-item[data-brand="clean"]{  --pm-accent: var(--pm-accent-clean, rgba(102, 187, 106, 0.70)); }  /* 粉綠 */
.pm-item[data-brand="drink"]{  --pm-accent: var(--pm-accent-drink, rgba(255, 112, 67, 0.68)); }   /* 粉橘 */
.pm-item[data-brand="health"]{ --pm-accent: var(--pm-accent-health, rgba(25, 118, 210, 0.78)); }   /* 藍 */
.pm-tag{
  background: rgba(0,137,123,0.09);
  border-color: rgba(0,137,123,0.20);
}

/* --- V2.8.8: Promo badges/pills are clickable (subtle) --- */
.promo-badge, .p-price-pill{ cursor: pointer; }
.promo-badge:active, .p-price-pill:active{ transform: translateY(1px); }

/* --- V2.8.8: Disable add/remove during config init (not scary, but blocks wrong ops) --- */
body.cfg-loading .s-btn,
body.cfg-loading .btn-bundle{
  pointer-events:none;
  opacity: .45;
  filter: grayscale(.15);
}
body.cfg-error .s-btn,
body.cfg-error .btn-bundle{
  pointer-events:none;
  opacity: .45;
}


/* --- V2.9.2: Star Hero (主打星) overlay + announcement dock --- */
/* Star pulse highlight */
.p-card.star-pulse{ outline: 2px solid rgba(255,143,0,0.55); box-shadow: 0 18px 40px rgba(255,143,0,0.18); }
/* Navigation breathe highlight (source-colored) */
.p-card.nav-breathe{ position: relative; }
.p-card.nav-breathe::after{
  content:"";
  position:absolute;
  inset:0;
  border-radius: inherit;
  pointer-events:none;
  background: rgba(var(--nav-breathe-rgb,255,143,0),0.055);
  box-shadow: inset 0 0 0 1px rgba(var(--nav-breathe-rgb,255,143,0),0.16),
              0 18px 34px rgba(var(--nav-breathe-rgb,255,143,0),0.10);
  opacity:0;
  transform: scale(0.998);
  animation: navBreathe 3.2s ease-in-out 0s 2;
}
@keyframes navBreathe{
  0%{ opacity:0; transform: scale(0.998); }
  45%{ opacity:1; transform: scale(1); }
  100%{ opacity:0; transform: scale(0.999); }
}
@media (prefers-reduced-motion: reduce){
  .p-card.nav-breathe::after{ animation:none; opacity:1; }
}

.star-dock-btn{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  width: 36px;
  height: 36px;
  border-radius: 12px;
  border: 1px solid rgba(255,167,38,0.55);
  background: rgba(255,255,255,0.92);
  color: #ff8f00;
  box-shadow: 0 10px 22px rgba(0,0,0,0.08);
  cursor: pointer;
  margin-right: 8px;
  flex: 0 0 auto;
  transform: translateZ(0);
}

.star-dock-btn{ position: relative; }
.star-dock-badge{
  position:absolute;
  top:-6px;
  right:-6px;
  min-width: 18px;
  height: 18px;
  padding: 0 5px;
  border-radius: 999px;
  background: rgba(255,111,0,0.95);
  color: #fff;
  font-size: 11px;
  font-weight: 900;
  display:flex;
  align-items:center;
  justify-content:center;
  box-shadow: 0 10px 18px rgba(0,0,0,0.14);
  border: 2px solid rgba(255,255,255,0.95);
}
.star-dock-btn.hidden .star-dock-badge{ display:none; }

.star-dock-btn.hidden{ display:none; }
.star-dock-btn .material-icons-round{ font-size: 20px; }
@keyframes starWiggle{
  0%,100%{ transform: translateZ(0) rotate(-6deg) translateY(0px); }
  50%{ transform: translateZ(0) rotate(6deg) translateY(-1px); }
}
@keyframes starTwinkle{
  0%,100%{ box-shadow: 0 10px 22px rgba(0,0,0,0.08), 0 0 0 rgba(255,193,7,0.0); }
  50%{ box-shadow: 0 12px 26px rgba(0,0,0,0.10), 0 0 18px rgba(255,193,7,0.38); }
}
.star-dock-btn.attn{
  animation: starWiggle 1.05s ease-in-out infinite, starTwinkle 1.45s ease-in-out infinite;
}

/* Star hero overlay (appears after welcome) */
#starHeroOverlay{
  position: fixed; top:0; left:0; width:100vw; height:100vh;
  display:none;
  align-items:center; justify-content:center;
  z-index: 9995;
  background: radial-gradient(1200px 800px at 15% 10%, rgba(255,214,170,0.70), rgba(236,239,241,0.62) 55%, rgba(210, 236, 255, 0.55));
  backdrop-filter: blur(9px) saturate(1.08);
  transition: opacity .38s ease;
  opacity: 0;
  padding: 16px;
}
#starHeroOverlay.show{ display:flex; opacity: 1; }
#starHeroOverlay.fade-out{ opacity: 0; }

.star-hero-card{
  width: min(980px, 92vw);
  max-height: min(78vh, 660px);
  overflow: hidden;
  background: rgba(255,255,255,0.94);
  border: 1px solid rgba(255,143,0,0.14);
  border-radius: 22px;
  box-shadow: 0 22px 60px rgba(0,0,0,0.14);
  padding: 16px 16px 14px;
  transform: translateY(0) scale(1);
  transition: transform .42s cubic-bezier(.2,.9,.2,1), opacity .42s ease;
}
.star-hero-card::before{
  content:'';
  position:absolute;
  inset: 0;
  pointer-events:none;
  border-radius: 22px;
  background: radial-gradient(220px 140px at 18% 18%, rgba(255,193,7,0.14), rgba(255,255,255,0.0) 70%),
              radial-gradient(260px 160px at 86% 22%, rgba(255,111,0,0.10), rgba(255,255,255,0.0) 72%);
}
.star-hero-card{ position:relative; }

#starHeroOverlay.fade-out .star-hero-card{
  transform: translateY(6px) scale(0.92);
  opacity: 0;
}

/* Staged entrance (A) */
#starHeroOverlay.show.entering .sh-head,
#starHeroOverlay.show.entering .sh-sub,
#starHeroOverlay.show.entering .sh-carousel,
#starHeroOverlay.show.entering .sh-dots,
#starHeroOverlay.show.entering #starHeroBrowseBtn{
  opacity: 0;
  transform: translateY(10px);
}
@keyframes shFadeUp{
  from{ opacity:0; transform: translateY(10px); }
  to{ opacity:1; transform: translateY(0px); }
}
#starHeroOverlay.show.entering .sh-head{ animation: shFadeUp .46s cubic-bezier(.2,.9,.2,1) both; animation-delay: .06s; }
#starHeroOverlay.show.entering .sh-sub{ animation: shFadeUp .46s cubic-bezier(.2,.9,.2,1) both; animation-delay: .12s; }
#starHeroOverlay.show.entering .sh-carousel{ animation: shFadeUp .52s cubic-bezier(.2,.9,.2,1) both; animation-delay: .18s; }
#starHeroOverlay.show.entering .sh-dots{ animation: shFadeUp .50s cubic-bezier(.2,.9,.2,1) both; animation-delay: .26s; }
#starHeroOverlay.show.entering #starHeroBrowseBtn{ animation: shFadeUp .46s cubic-bezier(.2,.9,.2,1) both; animation-delay: .34s; }


.sh-head{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
}
.sh-title{
  display:flex;
  align-items:center;
  gap:8px;
  font-weight: 900;
  font-size: 19px;
  color: #111827;
}
.sh-title .material-icons-round{ color:#ff8f00; }

.sh-title .material-icons-round{ color:#ff8f00; }
.sh-sub{
  margin-top: 6px;
  color: rgba(17,24,39,0.70);
  font-size: 13px;
  font-weight: 700;
}

.sh-carousel{
  --sh-card-w: 184px;
  --sh-side-pad: max(14px, calc((100% - var(--sh-card-w)) / 2));
  margin-top: 12px;
  display:flex;
  gap: 10px;
  overflow-x:auto;
  padding: 2px var(--sh-side-pad) 12px var(--sh-side-pad);
  scroll-padding-left: var(--sh-side-pad);
  scroll-padding-right: var(--sh-side-pad);
  scroll-snap-type: x mandatory;
  scroll-snap-stop: always;
  -webkit-overflow-scrolling: touch;
}
.sh-carousel::-webkit-scrollbar{ height: 8px; }
.sh-carousel::-webkit-scrollbar-thumb{ background: rgba(255,143,0,0.18); border-radius: 999px; }
.sh-dots{
  margin-top: 6px;
  display:flex;
  align-items:center;
  justify-content:center;
  gap: 7px;
  padding-bottom: 6px;
  user-select:none;
}
.sh-dot{
  width: 7px;
  height: 7px;
  border-radius: 999px;
  background: rgba(17,24,39,0.18);
  transform: scale(0.92);
  transition: transform .18s ease, background .18s ease, width .18s ease;
}
.sh-dot.active{
  background: rgba(255,111,0,0.95);
  transform: scale(1.05);
  width: 16px;
}

.sh-carousel::-webkit-scrollbar-thumb{ background: rgba(0,0,0,0.12); border-radius: 999px; }


.sh-item{
  flex: 0 0 184px;
  scroll-snap-align: center;
  border-radius: 18px;
  border: 1px solid rgba(0,0,0,0.08);
  background: rgba(255,255,255,0.98);
  box-shadow: 0 10px 24px rgba(0,0,0,0.06);
  overflow: hidden;
  cursor: pointer;
  transition: transform .14s ease, box-shadow .18s ease, filter .18s ease;
  display:flex;
  flex-direction:column;
  gap: 8px;
  padding: 10px;
}
.sh-item:active{ transform: scale(0.985); }
.sh-item:hover{ box-shadow: 0 14px 30px rgba(0,0,0,0.08); filter: brightness(1.01); }

.sh-item .sh-img{
  width: 100%;
  height: 108px;
  object-fit: contain;
  display:block;
  background: rgba(255,255,255,0.95);
  border-radius: 16px;
  border: 1px solid rgba(0,0,0,0.06);
}
.sh-item .sh-meta{
  flex: 1;
  min-width: 0;
  display:flex;
  flex-direction:column;
  gap: 6px;
  padding: 0 2px 2px;
}
.sh-item .sh-amt{
  font-size: 12px;
  font-weight: 900;
  color: rgba(255,111,0,0.98);
  background: rgba(255,143,0,0.10);
  border: 1px solid rgba(255,143,0,0.14);
  padding: 4px 8px;
  border-radius: 999px;
  width: fit-content;
  max-width: 100%;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.sh-item .sh-name{
  font-size: 15px;
  font-weight: 900;
  color: #111827;
  line-height: 1.22;
  word-break: break-word;
  display:-webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}
.sh-actions{
  margin-top: 12px;
  display:flex;
  justify-content:flex-end;
}
#starHeroBrowseBtn{
  width: 100%;
  border: none;
  margin-top: 12px;
  background: linear-gradient(90deg, rgba(255,143,0,0.95), rgba(255,111,0,0.95));
  color: #fff;
  font-weight: 900;
  padding: 14px 16px;
  border-radius: 16px;
  font-size: 16px;
  cursor: pointer;
  box-shadow: 0 14px 26px rgba(255,111,0,0.20);
  transition: transform .12s ease, box-shadow .18s ease, filter .18s ease;
}
#starHeroBrowseBtn:active{ transform: translateY(1px) scale(0.995); }
#starHeroBrowseBtn:hover{ filter: brightness(1.02); box-shadow: 0 16px 30px rgba(255,111,0,0.24); }

.star-fly{
  position: fixed;
  z-index: 10010;
  width: 46px;
  height: 46px;
  border-radius: 16px;
  display:flex;
  align-items:center;
  justify-content:center;
  background: rgba(255,255,255,0.94);
  border: 1px solid rgba(255,167,38,0.65);
  color: #ff8f00;
  box-shadow: 0 18px 44px rgba(0,0,0,0.18);
  transform: translateZ(0);
  opacity: 0.0;
  pointer-events:none;
  will-change: transform, opacity;
}
.star-fly .material-icons-round{ font-size: 24px; }

</style>
</head>
<body>

<div id="welcome-overlay">
  <div class="balloon-card">
    <span class="material-icons-round w-logo" style="color:#00897b">spa</span>
    <div class="w-title">Welcome<br>TTL Bio-Tech Order Web</div>
    <div class="w-sub">健康美麗的路上<br>台酒生技與您同行</div>
    <button class="w-btn" onclick="closeWelcome()">開始訂購</button>
  </div>
</div>


<div id="starHeroOverlay" aria-hidden="true">
  <div class="star-hero-card" role="dialog" aria-modal="true" aria-label="主打星推薦">
    <div class="sh-head">
      <div class="sh-title"><span class="material-icons-round">auto_awesome</span> <span id="starHeroTitleText"></span></div>
    </div>
    <div class="sh-sub" id="starHeroSubtitleText"></div>
    <div class="sh-carousel" id="starHeroCarousel"></div>
    <div class="sh-dots" id="starHeroDots" aria-hidden="true"></div>
    <button type="button" id="starHeroBrowseBtn">先去逛逛</button>
  </div>
</div>


<div id="gift-fab" onclick="showMilestoneCard()">
  <span class="material-icons-round" style="color:#ffca28">card_giftcard</span>
</div>

<div id="top-notify">
  <div class="tn-head"><span class="material-icons-round">emoji_events</span> 獲得贈品</div>
  <div class="tn-body" id="tn-text"></div>
</div>

<div id="milestone-overlay">
  <div class="ms-card-v" id="msCard">
    <div class="ms-header">
       <button class="ms-close" onclick="closeMilestoneCard()" aria-label="關閉"><span class="material-icons-round">close</span></button>
       <div class="ms-title-v">🎁 滿額贈進度</div>
       <div class="ms-summary-row ms-sum-all">
         <div class="ms-sum-left">
           <span class="ms-badge ms-badge-all">ALL</span>
           <div class="ms-sum-text">
             <div class="ms-sum-title">全站滿額</div>
             <div class="ms-sum-sub">全站商品合併計算</div>
           </div>
         </div>
         <div id="ms-val-all">$0</div>
       </div>
       <div class="ms-summary-row ms-sum-beauty">
         <div class="ms-sum-left">
           <span class="ms-badge ms-badge-beauty">BEAUTY</span>
           <div class="ms-sum-text">
             <div class="ms-sum-title">美容滿額</div>
             <div class="ms-sum-sub">僅美容區商品累計</div>
           </div>
         </div>
         <div id="ms-val-beauty">$0</div>
       </div>
    </div>
    <div class="ms-dual-body" id="msNodes"></div>
  </div>
</div>

<div id="toast-container"></div>

<div id="back-to-top" onclick="window.scrollTo({top:0, behavior:'smooth'})">
  <span class="material-icons-round">arrow_upward</span>
</div>

<div id="loader">
  <div style="width:100%; max-width:800px; margin:0 auto; display:grid; grid-template-columns:1fr 1fr; gap:12px;">
    <div class="skeleton sk-card"></div><div class="skeleton sk-card"></div>
    <div class="skeleton sk-card"></div><div class="skeleton sk-card"></div>
  </div>
</div>

<header>
  <div class="search-wrap">
    <div class="search-box">
      <span class="material-icons-round icon">search</span>
      <input id="searchInp" type="text" placeholder="搜尋商品...">
      <span id="clearSearch" class="material-icons-round clear-btn">cancel</span>
    </div>
  </div>
  <div class="cat-wrap">
    <nav class="cat-nav" id="catNav"></nav>
  </div>
</header>

<div id="ranking-section">
  <div class="rank-head">
    <div class="rank-title"><span class="material-icons-round" style="color:#d81b60;font-size:18px;">local_fire_department</span> 熱銷</div>
    <div class="rank-tabs">
      <div class="r-tab active" onclick="switchRank('all')">全站</div>
      <div class="r-tab" onclick="switchRank('health')">保健</div>
      <div class="r-tab" onclick="switchRank('beauty')">美容</div>
      <div class="r-tab" onclick="switchRank('cleaning')">清潔</div>
    </div>
  </div>
  <div class="rank-list" id="rankList"></div>
</div>

<div id="systemAnnouncementSlot" style="display:none"></div>

<main id="list"></main>
<div id="empty-state">
  <span class="material-icons-round" style="font-size:48px">search_off</span>
  <p>找不到相關商品</p>
</div>

<div id="float-bar" onclick="safeOpenCart()">
  <div class="fb-info">
    <span class="fb-total">$0</span>
    <span class="fb-count">0 件商品</span>
  </div>
  <div class="fb-btn">查看購物車 <span class="material-icons-round" style="font-size:18px">arrow_forward</span></div>
</div>

<div id="drawer">
  <div id="drawer-bg" onclick="closeCart()"></div>
  <div id="drawer-panel">
    <div class="dr-head">
      <div style="display:flex; align-items:center; gap:8px;">
        <span class="material-icons-round" onclick="closeCart()" style="cursor:pointer;color:#00897b;font-weight:700">arrow_back_ios</span>
        <h2 style="margin:0;font-size:20px;font-weight:700;color:#263238">購物車</h2>
      </div>
      <span class="material-icons-round" onclick="closeCart()" style="cursor:pointer;padding:8px;color:#546e7a;background:#f5f5f5;border-radius:50%">close</span>
    </div>
    
    <div class="gamification-box">
      <div class="game-txt" id="gameMsgContainer">
        <span id="gameMsg">加油！再 $500 送贈品</span>
        <div class="game-icon-wrap" onclick="openGiftList()">
          <span class="game-icon">🎁</span>
          <span class="game-hint">查看好禮</span>
        </div>
      </div>
      <div class="progress-wrap">
        <div class="progress-bar" id="gameBar"></div>
      </div>
    </div>

    <div class="dr-body">
        <div id="cartList"></div>
        
        <div class="sum-card">
            <div class="sum-head" onclick="toggleSum()">
              <span style="display:flex;align-items:center;gap:6px">
                <span class="material-icons-round">receipt_long</span> 商品總覽 (含贈品)
              </span>
              <span class="material-icons-round" id="sumIcon">expand_more</span>
            </div>
            <div class="sum-body" id="finalList"></div>
        </div>
    </div>

    <div class="dr-foot">
      <div style="display:flex;justify-content:space-between;margin:5px 0 5px 0;color:#c2185b;font-weight:700"><span>美容保養小計</span><span id="sumBeauty">$0</span></div>
      <div style="display:flex;justify-content:space-between;margin-bottom:5px;color:#546e7a"><span>原價總計</span><span id="sumBase">$0</span></div>
      <div style="display:flex;justify-content:space-between;margin-bottom:5px;color:var(--accent)"><span>折扣與優惠</span><span id="sumDisc">-$0</span></div>
      <div style="display:flex;justify-content:space-between;margin-top:10px;padding-top:10px;border-top:1px dashed #cfd8dc;font-size:22px;font-weight:800;color:#263238"><span>應付金額</span><span id="sumPay">$0</span></div>

      <div id="checkoutDetails" class="checkout-details collapsed">
      <div class="delivery-toggle-wrap">
        <label class="d-toggle-label">
          <input type="checkbox" id="chkDelivery" onchange="toggleDelivery()">
          <span>需宅配寄送</span> <span id="deliveryStatusText" style="font-size:12px;font-weight:400;color:#ef6c00">(請填寫收件資訊)</span>
        </label>
        <span id="shipFreeBadge" class="ship-free-badge" style="display:none"></span>
        <button type="button" class="d-collapse-btn" id="btnDeliveryCollapse" onclick="collapseDelivery()">收合</button>

        <div id="deliveryForm" class="delivery-form">
           <input id="dName" class="d-input" placeholder="收貨人姓名 (必填)">
           <input id="dPhone" class="d-input" type="tel" placeholder="聯絡電話/手機 (必填)">
           <input id="dAddr" class="d-input" placeholder="收貨地址 (必填)">
           <input id="dNote" class="d-input" placeholder="宅配備註 (選填)">
        </div>
      </div>
      <div class="form-grid">
        <input id="fName" placeholder="訂購人姓名 (必填)">
        <select id="fDept"><option value="" selected disabled>載入中…</option></select>
        <select id="fPay">
          <option value="現金">現金</option>
          <option value="信用卡">信用卡</option>
          <option value="薪資扣款">薪資扣款</option>
          <option value="匯款">匯款</option>
        </select>
        <input id="fNote" placeholder="訂單備註">
      </div>
    </div>
      <div class="btn-bar">
        <button class="btn-clear" onclick="clearCart()"><span class="material-icons-round">delete_outline</span></button>
        <button class="btn-submit" id="btnCheckoutSubmit" onclick="handleCheckoutSubmit()">結帳去</button>
      </div>
      <div id="warnMsg" style="color:#ef5350;font-size:13px;text-align:center;margin-top:10px;display:none;font-weight:700;background:#ffebee;padding:8px;border-radius:8px;"></div>
    </div>
  </div>
</div>

<div id="bundleModal" class="modal">
  <div class="m-box">
    <div class="m-head">任選 2 件內容物</div>
    <div class="m-sub">已選擇 <span id="mCount" style="color:var(--accent);font-weight:700">0</span> / 2 件</div>
    <div class="m-grid" id="mGrid"></div>
    <div class="m-acts">
      <button class="m-btn" style="background:#f5f5f5;color:#546e7a" onclick="closeBundle()">取消</button>
      <button id="mConfirmBtn" class="m-btn disabled" style="background:var(--primary);color:#fff" onclick="confirmBundle()">確認選取</button>
    </div>
  </div>
</div>

<div id="giftModal" class="modal">
  <div class="m-box">
    <div class="m-head" style="margin-bottom:20px">全站獲得贈品</div>
    <div class="gift-list" id="giftListGrid"></div>
    <button class="m-btn" style="background:#f5f5f5;color:#546e7a;margin-top:20px;flex-shrink:0" onclick="closeGiftList()">關閉</button>
  </div>
</div>

<div id="receiptModal" class="modal" style="z-index:2200;">
  <div class="m-box receipt-paper" style="max-height:90vh; max-width:400px; padding:0;">
    <div class="rc-head">
      <h2 style="margin:0;font-size:18px;">訂購完成</h2>
      <div style="font-size:12px;opacity:0.8;margin-top:4px;" id="rcOrderId"></div>
    </div>
    <div class="rc-body" id="rcBody"></div>
    <div class="rc-actions">
      <button class="btn-email" onclick="toggleEmailInput()">
        <span class="material-icons-round">email</span> 寄送訂購紀錄到 Email
      </button>
      <div class="email-input-box" id="emailBox">
        <input type="email" id="rcEmail" placeholder="請輸入 Email..." style="flex:1;">
        <button class="btn-submit" style="flex:0 0 80px;padding:10px;" onclick="sendReceipt()">發送</button>
      </div>
      <div style="font-size:11px;color:#90a4ae;text-align:center;margin-bottom:15px;">
        請自行截圖留存，或使用上方按鈕寄送。
      </div>
      <button class="btn-close-rc" onclick="closeReceipt()">關閉並完成</button>
    </div>
  </div>
</div>

<script>
const GIFT_IMAGES = {}; 

const SHEET_P = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQBtV8q3Ank7Bnhs83IbOb97U46juV-RKeL3NpdFiNcSu-ifI21fQYo1-io62S3JIrXEO5MiDArc1Lr/pub?gid=1623055155&single=true&output=csv";
const SHEET_R = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQU95r9_TOPlQXY-lcBS_RH3tRc0mtRyuazxHHWljpRusbzBiWsEfm3Pa_HZmKW5Ob5TOq4W5O-vumI/pub?gid=2071879068&single=true&output=csv";
const SHEET_RANK = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQj5QLrtaWikGcLNwMawbjiN8ZQDgFzW1RV7UECFgLzECWj16I2ugE_B6tzzLICCynsk1L6lAuJfccS/pub?gid=93142219&single=true&output=csv";
const SHEET_GIFTS_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQBtV8q3Ank7Bnhs83IbOb97U46juV-RKeL3NpdFiNcSu-ifI21fQYo1-io62S3JIrXEO5MiDArc1Lr/pub?gid=1623055155&single=true&output=csv";
const GAS_URL = "https://script.google.com/macros/s/AKfycbxQ9Etloak3ZNv6yfyMCK9KbjoLyDqjRQHHVlASY5iMwwy_c4NCPxWpMK1YkzSXstHN/exec";
// Free-shipping threshold for宅配提示（可依活動調整）
const FREE_SHIP_THRESHOLD = 1000;

const PROXY = (url) => "https://corsproxy.io/?" + encodeURIComponent(url);
// --- V28.1 FIX: Resilient CSV fetch (direct-first, proxy fallback) ---
const CORS_FALLBACKS = [
  (u) => u,                      // direct
  (u) => PROXY(u),               // corsproxy.io (legacy)
  (u) => "https://api.allorigins.win/raw?url=" + encodeURIComponent(u),
  (u) => "https://cors.isomorphic-git.org/" + u
];

async function fetchTextWithTimeout(url, timeoutMs = 12000) {
  const ctrl = new AbortController();
  const t = setTimeout(() => ctrl.abort(), timeoutMs);
  try {
    const res = await fetch(url, { signal: ctrl.signal, cache: "no-store" });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    return await res.text();
  } finally {
    clearTimeout(t);
  }
}

function looksLikeHtml(text) {
  const t = String(text || "").trim().slice(0, 200).toLowerCase();
  return t.startsWith("<!doctype") || t.startsWith("<html") || t.includes("<head") || t.includes("<body");
}

async function fetchCsvTextSmart(sourceUrl, label = "data", options = {}) {
  const { timeoutMs = 12000, optional = false, minLength = 50 } = options || {};
  let lastErr = null;

  for (let i = 0; i < CORS_FALLBACKS.length; i++) {
    const u = CORS_FALLBACKS[i](sourceUrl);
    try {
      const txt = await fetchTextWithTimeout(u, timeoutMs);
      if (!txt || txt.trim().length < minLength) throw new Error("Empty response");
      if (looksLikeHtml(txt)) throw new Error("Unexpected HTML response");
      return txt;
    } catch (e) {
      lastErr = e;
      console.warn(`[CSV] ${label} fetch failed via #${i + 1}`, u, e);
    }
  }

  if (optional) return null;
  throw new Error(`${label} 讀取失敗（可能是 CORS/Proxy 被擋）：${lastErr ? lastErr.message : "unknown"}`);
}

// Bump cache key to avoid stale config from older builds
// V2 Sprint1: strict config loading (no time-based cache, no fallback degrade)
let CONFIG_READY = false;

function setConfigLoadingUI(state) {
  const deptEl = document.getElementById("fDept");
  const payEl = document.getElementById("fPay");

  if(state === 'loading') {
    if(deptEl) {
      deptEl.disabled = true;
      deptEl.innerHTML = '<option value="" selected disabled>載入中…</option>';
    }
    if(payEl) payEl.disabled = true; // keep existing options, just disable
    return;
  }

  if(state === 'error') {
    if(deptEl) {
      deptEl.disabled = true;
      deptEl.innerHTML = '<option value="" selected disabled>設定載入失敗，請重整</option>';
    }
    if(payEl) payEl.disabled = true;
    return;
  }

  // ready
  if(deptEl) deptEl.disabled = false;
  if(payEl) payEl.disabled = false;
}

async function loadConfigOptions() {
  return await fetchAndApplyConfigOptions();
}

async function fetchAndApplyConfigOptions() {
  CONFIG_READY = false;
  setConfigLoadingUI('loading');
  setBootConfigState('loading');

  const payload = { action: "get_config" };
  try {
    const res = await fetch(GAS_URL, {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded" },
      body: "payload=" + encodeURIComponent(JSON.stringify(payload)),
      cache: "no-store"
    }).then(r => r.json());

    if(res && res.ok) {
      const data = {
        departments: Array.isArray(res.departments) ? res.departments : [],
        payments: Array.isArray(res.payments) ? res.payments : []
      };
      applyConfigToForm(data, false);
      setConfigLoadingUI('ready');
      CONFIG_READY = true;
      setBootConfigState('ready');
      return true;
    }

    throw new Error((res && (res.message || res.error)) || 'get_config failed');
  } catch(e) {
    console.warn('[Config] load failed:', e);
    CONFIG_READY = false;
    setConfigLoadingUI('error');
    setBootConfigState('error');
    try { showToast('系統設定載入失敗，請重新整理再試', 'warn'); } catch(_) {}
    return false;
  }
}

function normalizeConfigList(list, fallbackLabel) {
  const out = [];
  (list || []).forEach(x => {
    const label = String((x && (x.label || x.value)) || "").trim();
    if(!label) return;
    out.push({
      label,
      value: label,
      active: String(x.active).toLowerCase() !== "false"
    });
  });
  if(out.length === 0 && fallbackLabel) out.push({ label: fallbackLabel, value: fallbackLabel, active: true });
  return out;
}

function applyConfigToForm(cfg, fromCache) {
  const deptEl = document.getElementById("fDept");
  const payEl = document.getElementById("fPay");

  // Departments
  if(deptEl) {
    const depts = normalizeConfigList(cfg && cfg.departments, "其他").filter(x => x.active);
    deptEl.innerHTML = "";
    const opt0 = document.createElement("option");
    opt0.value = "";
    opt0.disabled = true;
    opt0.selected = true;
    opt0.textContent = "選擇部門";
    deptEl.appendChild(opt0);

    depts.forEach(d => {
      const o = document.createElement("option");
      o.value = d.value;
      o.textContent = d.label;
      deptEl.appendChild(o);
    });
  }

  // Payments (if provided)
  if(payEl && cfg && Array.isArray(cfg.payments)) {
    const pays = normalizeConfigList(cfg.payments, "現金").filter(x => x.active);
    if(pays.length > 0) {
      payEl.innerHTML = "";
      pays.forEach((p, idx) => {
        const o = document.createElement("option");
        o.value = p.value;
        o.textContent = p.label;
        if(idx === 0) o.selected = true;
        payEl.appendChild(o);
      });
    }
  }

  // If cache, do not surface messages; if fetch, also silent to keep UI clean
}


let PRODUCTS = [], RULES = {}, CART = [], SELECTED_BUNDLE = new Map();
let PRODUCT_MAP = new Map(); 
let RANKINGS = { all:[], health:[], beauty:[], cleaning:[] };
let currentCat = "", categories = [];
let modalPid = null, isCartOpen = false;
let tempBundleSelection = [];
let lastOrderData = null; 
let sectionObserver = null;
let GIFT_MAP = new Map();
let achievedGifts = [];
let isFirstAdd = true; 

// --- ADDON (加價購) HELPERS ---
// Multi-value splitter for fields like requires_any_zone_in / zone_prefix
function splitMultiVals(s) {
  return String(s || "")
    .split(/[&＆|、,;；]/)
    .map(x => x.trim())
    .filter(Boolean);
}

function getFlatPriceRule(code, zoneText) {
  if(!RULES || !RULES.flat_price) return null;
  const z = String(zoneText||"");
  return RULES.flat_price.find(r => r.code === code && z.includes(r.zone)) || null;
}

// Eligibility: requires cart contains >= minQty items from ANY of required zones (excluding add-on items)
function isAddonEligible(addonZoneText) {
  const z = String(addonZoneText||"");
  const rule = (RULES && RULES.eligibility) ? (RULES.eligibility.find(e => z.includes(e.zone)) || null) : null;
  if(!rule) return true; // if no eligibility rule, allow
  const reqZones = splitMultiVals(rule.requires);
  const minQty = Number(rule.minQty || 1);
  if(reqZones.length === 0) return true;

  let eligibleQty = 0;
  CART.forEach(it => {
    if(!it || !it.category) return;
    if(String(it.category).includes("加價購")) return; // exclude add-ons
    if(reqZones.some(rz => String(it.category).includes(rz))) eligibleQty += (Number(it.qty)||0);
  });
  return eligibleQty >= (Number.isNaN(minQty) ? 1 : minQty);
}

// Remove ineligible add-on items after cart changes. Returns number of removed lines.
function enforceAddonEligibility() {
  const addonItems = CART.filter(it => it && it.category && String(it.category).includes("加價購"));
  if(addonItems.length === 0) return 0;

  const zones = Array.from(new Set(addonItems.map(it => String(it.category))));
  let removed = 0;

  zones.forEach(z => {
    if(!isAddonEligible(z)) {
      const before = CART.length;
      CART = CART.filter(it => !(it && String(it.category) === z));
      removed += (before - CART.length);
    }
  });
  return removed;
}


// Auto-navigate helper: scroll to a category section by raw zone text (from pricing_strategy)
function findCategoryForZone(zoneText){
  const z = String(zoneText||'').trim();
  if(!z) return null;
  // Prefer exact match on full category
  let cat = categories.find(c => String(c).trim() === z);
  if(!cat) cat = categories.find(c => String(c).includes(z));
  if(!cat) cat = categories.find(c => z.includes(String(c)));
  return cat || null;
}

function scrollToZoneSection(zoneText){
  try{
    const cat = findCategoryForZone(zoneText);
    if(!cat) return false;
    const id = `cat-${String(cat).replace(/\s+/g,'-')}`;
    scrollToSection(id);
    setTimeout(() => {
      const el = document.getElementById(id);
      if(el){
        el.classList.add('zone-highlight');
        setTimeout(() => el.classList.remove('zone-highlight'), 900);
      }
    }, 650);
    return true;
  }catch(e){ return false; }
}

function getFreeShipThreshold(){
  const t = (RULES && RULES.freeShipThreshold != null) ? Number(RULES.freeShipThreshold) : Number(FREE_SHIP_THRESHOLD);
  return (isFinite(t) && t > 0) ? t : 0;
}

function updateShipFreeBadge(total){
  const badge = document.getElementById('shipFreeBadge');
  if(!badge) return;
  const thr = getFreeShipThreshold();
  if(!thr){ badge.style.display='none'; return; }
  const diff = Math.max(0, Math.round(thr - (Number(total)||0)));
  if((Number(total)||0) >= thr){
    badge.classList.add('ok');
    badge.textContent = '✔ 滿額免運';
  } else {
    badge.classList.remove('ok');
    badge.textContent = `差 ${diff.toLocaleString()} 免運`;
  }
}

function syncDeliveryHeaderUI(){
  const wrap = document.querySelector('.delivery-toggle-wrap');
  const form = document.getElementById('deliveryForm');
  const status = document.getElementById('deliveryStatusText');
  const badge = document.getElementById('shipFreeBadge');
  const chk = document.getElementById('chkDelivery');
  if(!wrap || !form || !status || !badge || !chk) return;

  const expanded = !!(chk.checked && form.classList.contains('show'));
  if(expanded){
    status.style.display = 'none';
    badge.style.display = 'inline-flex';
    wrap.classList.add('has-badge');
    const total = parseFloat(String(document.getElementById('sumPay')?.innerText||'').replace(/[^\d.]/g,'')) || 0;
    updateShipFreeBadge(total);
  } else {
    status.style.display = 'inline';
    badge.style.display = 'none';
    wrap.classList.remove('has-badge');
  }
}

// --- GLOBAL FUNCTIONS ---

function cleanupUI() {
    document.body.classList.remove('modal-open');
    document.body.style.overflow = '';
    document.body.style.height = '';
}

window.closeWelcome = function() {
  const el = document.getElementById('welcome-overlay');
  if(!el) return;
  el.classList.add('fade-out');
  setTimeout(() => {
    try{ el.style.display = 'none'; }catch(e){}
    try{ requestStarHeroAutoShow(); }catch(e){}
  }, 520);
};

window.safeOpenCart = function() {
  if(!CART || CART.length === 0) {
    showToast("購物車還是空的喔！趕快去選購吧", "warn");
    return;
  }
  openCart();
};


/* --- V2.9.3: Two-stage checkout (二階結帳 + 收合) --- */
let __CHECKOUT_STAGE__ = 1;
function setCheckoutStage(stage){
  try{
    const details = document.getElementById('checkoutDetails');
    const btn = document.getElementById('btnCheckoutSubmit');
    __CHECKOUT_STAGE__ = (stage===2 ? 2 : 1);

    if(details){
      if(__CHECKOUT_STAGE__ === 2){
        details.classList.remove('collapsed');
      }else{
        details.classList.add('collapsed');
      }
    }
    if(btn){
      btn.textContent = (__CHECKOUT_STAGE__ === 2) ? '確認訂購' : '結帳去';
    }
  }catch(e){}
}
function handleCheckoutSubmit(){
  try{
    if(__CHECKOUT_STAGE__ !== 2){
      setCheckoutStage(2);
      const details = document.getElementById('checkoutDetails');
      if(details){
        details.scrollIntoView({ behavior:'smooth', block:'nearest' });
      }
      const f = document.getElementById('fName');
      if(f) setTimeout(()=>{ try{ f.focus(); }catch(e){} }, 260);
      return;
    }
    submitOrder();
  }catch(e){}
}

window.openCart = function() {
  setCheckoutStage(1);
  document.getElementById("drawer").classList.add("open"); 
  document.getElementById("float-bar").classList.add("hidden"); 
  document.body.classList.add('modal-open');
  isCartOpen = true; 
  history.pushState({modal: 'cart'}, null, ""); 
};

window.closeCart = function() {
  setCheckoutStage(1);
  document.getElementById("drawer").classList.remove("open");
  document.getElementById("float-bar").classList.remove("hidden");
  cleanupUI(); 
  isCartOpen = false;
  if(history.state && history.state.modal === 'cart') history.back();
};

window.switchRank = function(type) {
  document.querySelectorAll(".r-tab").forEach(el => el.classList.remove("active"));
  event.target.classList.add("active");
  renderRanking(type);
};

// V24.3: Dual Track Gift List
window.openGiftList = function() {
    const currentTotal = parseFloat(document.getElementById("sumPay").innerText.replace('$','').replace(/,/g,'')) || 0;
    const currentBeauty = parseFloat(document.getElementById("sumBeauty").innerText.replace('$','').replace(/,/g,'')) || 0;
    
    const giftsAll = RULES.spend.filter(r => r.scope === 'all').sort((a,b) => a.amt - b.amt);
    const giftsBeauty = RULES.spend.filter(r => r.scope === 'zone_prefix').sort((a,b) => a.amt - b.amt);

    const grid = document.getElementById("giftListGrid");
    grid.innerHTML = "";

    // 1. Total Spend Section
    if (giftsAll.length > 0) {
        grid.innerHTML += `<div class="g-section-title"><span>全館滿額贈</span><span class="g-section-amt">目前：$${Math.round(currentTotal).toLocaleString()}</span></div>`;
        giftsAll.forEach(g => {
            const reached = currentTotal >= g.amt;
            grid.appendChild(createGiftItem(g, reached));
        });
    }

    // 2. Beauty Spend Section
    if (giftsBeauty.length > 0) {
        grid.innerHTML += `<div class="g-section-title beauty"><span>美容滿額贈</span><span class="g-section-amt">目前：$${Math.round(currentBeauty).toLocaleString()}</span></div>`;
        giftsBeauty.forEach(g => {
            const reached = currentBeauty >= g.amt;
            grid.appendChild(createGiftItem(g, reached));
        });
    }

    // 3. Series Gift Section (by qty)
    const seriesRules = (RULES.series_gift || []).filter(r => r.scope === 'zone_prefix' && String(r.gift||'').trim());
    if (seriesRules.length > 0) {
        grid.innerHTML += `<div class="g-section-title">系列贈品</div>`;
        seriesRules.forEach(g => {
            const prefixes = splitPrefixes(g.prefix);
            const qty = prefixes.length ? sumQtyByPrefixes(CART, prefixes) : 0;
            let reached = false;
        try{
          const thr = Number(g.amt);
          if(Number.isFinite(thr) && thr > 0){
            const times = g.mult ? Math.floor(qty / thr) : (qty >= thr ? 1 : 0);
            reached = (times > 0);
          } else {
            reached = qty > 0;
          }
        }catch(e){ reached = (qty > 0); }
            grid.appendChild(createSeriesGiftItem(g, reached, qty));
        });
    }

    document.getElementById("giftModal").classList.add("open");
    history.pushState({modal: 'gift'}, null, "");
};

// OPTIMIZATION: Multi-Image Helper (Grid Layout)
function renderGiftImages(giftCode) {
    const images = GIFT_MAP.get(giftCode) || [];
    if(images.length === 0) return '';
    
    let html = `<div class="g-img-row">`;
    // Max 3 images, auto extend
    images.slice(0, 3).forEach(url => {
        if(url) html += `<img src="${url}" class="g-thumb">`;
    });
    html += `</div>`;
    return html;
}

function createSeriesGiftItem(g, reached, baseQty) {
    let gName = (PRODUCT_MAP.get(g.gift) || {}).name || g.gift;
    gName = gName.replace(/^(贈品|贈|Gift)[:\s|｜_]*/i, "");
    let imgHtml = renderGiftImages(g.gift);
    if(!imgHtml) imgHtml = '<div class="g-thumb" style="display:flex;align-items:center;justify-content:center;font-size:16px">🎁</div>';

    const unit = seriesGiftUnit(g.prefix);
    const thr = Number(g.amt);
    const ruleText = (Number.isFinite(thr) && thr > 0) ? `每 ${thr} ${unit}送` : `每${unit}送`;
    const perText = `${ruleText} ${Number(g.qty)||0} 個`;

    const div = document.createElement("div");
    div.className = `gift-item ${reached ? 'unlocked' : ''}`;
    div.innerHTML = `
        <div class="g-status material-icons-round">${reached ? 'check_circle' : 'lock'}</div>
        <div style="flex-shrink:0;">${imgHtml}</div>
        <div class="g-info">
          <div class="g-amt">${perText}</div>
          <div class="g-name">${gName}</div>
          <div style="font-size:12px;opacity:.8;margin-top:4px;">目前${unit}數：${baseQty}</div>
          ${reached ? '<div class="g-tag">已獲得</div>' : ''}
        </div>
    `;
    return div;
}

function createGiftItem(g, reached) {
    let gName = (PRODUCT_MAP.get(g.gift) || {}).name || g.gift;
    gName = gName.replace(/^(贈品|贈|Gift)[:\s|｜_]*/i, "");
    
    let imgHtml = renderGiftImages(g.gift);
    // If no images found, show placeholder
    if(!imgHtml) imgHtml = '<div class="g-thumb" style="display:flex;align-items:center;justify-content:center;font-size:16px">🎁</div>';

    const div = document.createElement("div");
    div.className = `gift-item ${reached ? 'unlocked' : ''}`;
    div.innerHTML = `
        <div class="g-status material-icons-round">${reached ? 'check_circle' : 'lock'}</div>
        <div style="flex-shrink:0;">${imgHtml}</div>
        <div class="g-info"><div class="g-amt">滿 $${g.amt.toLocaleString()}</div><div class="g-name">${gName} x${g.qty}</div>${reached ? '<div class="g-tag">已獲得</div>' : ''}</div>
    `;
    return div;
}

window.closeGiftList = function() {
    if(history.state && history.state.modal === 'gift') {
        history.back();
    } else {
        document.getElementById("giftModal").classList.remove("open");
    }
};

window.toggleSum = function() {
  const b = document.getElementById("finalList");
  const i = document.getElementById("sumIcon");
  if(b.classList.contains("open")) {
    b.classList.remove("open");
    i.innerText = "expand_more";
  } else {
    b.classList.add("open");
    i.innerText = "expand_less";
  }
};

window.updateQty = function(btnEl, pid, delta) {
  const p = PRODUCTS.find(x => x._id === pid);
  if(!p) return;

  // Strict mode: if config isn't ready, do not allow cart operations
  if(typeof CONFIG_READY !== 'undefined' && !CONFIG_READY) {
    try { showInitBlockedToast(); } catch(e) { try { showToast('系統初始化中…請稍候', 'info', 2800); } catch(e2) {} }return;
  }

  if(delta > 0 && p.category.includes("加價購")) {
    if(!isAddonEligible(p.category)) {
      // Clearer hint + auto-navigate to required主商品區
      let hint = "請先選購指定主商品，才能加購喔！";
      let targetZoneRaw = null;
      const rule = (RULES && RULES.eligibility) ? (RULES.eligibility.find(e => String(p.category).includes(e.zone)) || null) : null;
      if(rule && rule.requires) {
        const reqZones = splitMultiVals(rule.requires);
        if(reqZones.length > 0) {
          targetZoneRaw = reqZones[0];
          const zoneDisplay = String(targetZoneRaw).split(/[\s_]/)[0];
          hint = `選購「${zoneDisplay}」系列商品，立即享加購優惠`;
        }
      }
      showToast(hint, "warn");
      if(targetZoneRaw) {
        setTimeout(() => { scrollToZoneSection(targetZoneRaw); }, 300);
      }
      return;
    }
  }

  if(delta > 0 && p.bundle.length >= 2 && p.name.includes("任選")) {
    openBundle(pid); return;
  }

  let item = CART.find(x => x._id === pid && !x.bundleSelection);
  
  if(item) {
    item.qty += delta;
    if(item.qty <= 0) CART = CART.filter(x => x !== item);
  } else if (delta > 0) {
    CART.push({ ...p, qty: 1 });
  }
  
  if(delta > 0 && btnEl) animateFly(btnEl);
  
  if(delta > 0 && isFirstAdd) {
      isFirstAdd = false;
      setTimeout(() => {
          showMilestoneCard();
          setTimeout(() => { minimizeMilestoneCard(); }, 2000);
      }, 500);
  } else if (delta > 0) {
      const addedToast = showToast("已加入購物車");
      setTimeout(() => {
          const data = calcCart();
          checkNewGifts(data.gifts); 
      }, 800);
  }

  // Enforce add-on eligibility after any cart change
  const removedAddon = enforceAddonEligibility();
  if(removedAddon > 0) {
    showToast("加價購商品已移除（未符合加購條件）", "warn");
  }

  saveState();
  refreshCart();
  renderList();
  
  const fab = document.getElementById("float-bar");
  fab.classList.remove("show");
  void fab.offsetWidth; 
  if(CART.length > 0) fab.classList.add("show");
};

// --- MILESTONE LOGIC (DUAL TRACK) ---

window.showMilestoneCard = function() {
    renderMilestoneContent();
    document.getElementById('milestone-overlay').classList.add('open');
    document.getElementById('msCard').classList.remove('shrinking');
    document.body.classList.add('modal-open');
    history.pushState({modal: 'milestone'}, null, "");
};

window.closeMilestoneCard = function() {
    document.getElementById('milestone-overlay').classList.remove('open');
    if(history.state && history.state.modal === 'milestone') history.back();
};

window.minimizeMilestoneCard = function() {
    const card = document.getElementById('msCard');
    card.classList.add('shrinking');
    setTimeout(() => {
        document.getElementById('milestone-overlay').classList.remove('open'); 
        cleanupUI();
        document.getElementById('gift-fab').style.display = 'flex'; 
        if(history.state && history.state.modal === 'milestone') history.back();
    }, 600);
};

function renderMilestoneContent() {
    const data = calcCart();
    const currentTotal = data.finalTotal;
    const currentBeauty = data.beautyTotal;

    document.getElementById('ms-val-all').innerText = `$${Math.round(Number(currentTotal)||0).toLocaleString()}`;
    document.getElementById('ms-val-beauty').innerText = `$${Math.round(Number(currentBeauty)||0).toLocaleString()}`;

    const giftsAll = RULES.spend.filter(r => r.scope === 'all').sort((a,b) => a.amt - b.amt);
    const giftsBeauty = RULES.spend.filter(r => r.scope === 'zone_prefix').sort((a,b) => a.amt - b.amt);

    const nextAll = giftsAll.find(x => Number(currentTotal||0) < Number(x.amt||0));
    const nextBeauty = giftsBeauty.find(x => Number(currentBeauty||0) < Number(x.amt||0));
    const nextAllAmt = nextAll ? Number(nextAll.amt||0) : null;
    const nextBeautyAmt = nextBeauty ? Number(nextBeauty.amt||0) : null;

    const allDone = (nextAllAmt === null && giftsAll.length > 0);
    const beautyDone = (nextBeautyAmt === null && giftsBeauty.length > 0);

    const container = document.getElementById('msNodes');
    container.innerHTML = '';

    const leftCol = document.createElement('div');
    leftCol.className = 'ms-track-col all';
    leftCol.innerHTML = '<div class="ms-track-title">全站滿額</div>';

    const rightCol = document.createElement('div');
    rightCol.className = 'ms-track-col beauty';
    rightCol.innerHTML = '<div class="ms-track-title" style="color:var(--beauty)">美容滿額</div>';

    giftsAll.forEach((g, idx) => {
        const isReached = Number(currentTotal||0) >= Number(g.amt||0);
        const isNext = (!isReached && nextAllAmt !== null && Number(g.amt||0) === nextAllAmt);
        const isDoneTag = (allDone && idx === giftsAll.length - 1);
        const diff = isNext ? Math.max(0, Math.ceil(nextAllAmt - Number(currentTotal||0))) : 0;

        leftCol.appendChild(createDualItem(g, isReached, {
          isNext: isNext || isDoneTag,
          diff,
          tagText: isDoneTag ? '已達最高門檻 🎉' : '',
          flash: isDoneTag ? false : true,
          kind: isDoneTag ? 'done' : 'next'
        }));
    });

    giftsBeauty.forEach((g, idx) => {
        const isReached = Number(currentBeauty||0) >= Number(g.amt||0);
        const isNext = (!isReached && nextBeautyAmt !== null && Number(g.amt||0) === nextBeautyAmt);
        const isDoneTag = (beautyDone && idx === giftsBeauty.length - 1);
        const diff = isNext ? Math.max(0, Math.ceil(nextBeautyAmt - Number(currentBeauty||0))) : 0;

        rightCol.appendChild(createDualItem(g, isReached, {
          isNext: isNext || isDoneTag,
          diff,
          tagText: isDoneTag ? '已達最高門檻 🎉' : '',
          flash: isDoneTag ? false : true,
          kind: isDoneTag ? 'done' : 'next'
        }));
    });

    container.appendChild(leftCol);
    container.appendChild(rightCol);

    // 動效：每次更新閃 3.1 秒（只針對「下一門檻」標籤）
    try{
      if(window.__msTagTimer) clearTimeout(window.__msTagTimer);
      const tags = Array.from(container.querySelectorAll('.ms-tag.flash'));
      window.__msTagTimer = setTimeout(() => {
        try{ tags.forEach(t => t.classList.remove('flash')); }catch(e){}
      }, 3100);
    }catch(e){}
}

function createDualItem(g, isReached, opts) {
    const o = opts || {};
    let gName = (PRODUCT_MAP.get(g.gift) || {}).name || g.gift;
    gName = String(gName||'').replace(/^(贈品|贈|Gift)[:\s|｜_]*/i, "");

    let imgHtml = '';
    try{ imgHtml = renderGiftImages(g.gift); }catch(e){}
    if(!imgHtml) imgHtml = '<div class="g-thumb" style="display:flex;align-items:center;justify-content:center;font-size:16px">🎁</div>';

    const isNext = !!o.isNext;
    const diff = Math.max(0, Number(o.diff||0));
    const tagText = (o.tagText && String(o.tagText).trim()) ? String(o.tagText).trim() : (isNext ? `還差 NT$${Math.round(diff).toLocaleString()}` : '');
    const wantFlash = (o.flash === false) ? false : true;
    const kind = (o.kind === 'done') ? 'done' : 'next';
    const tagClass = `ms-tag ${kind === 'done' ? 'done' : ''} ${(!wantFlash || kind==='done') ? '' : 'flash'}`.trim();

    const tagHtml = (tagText && isNext) ? `<div class="${tagClass}">${String(tagText).replace(/[<>]/g,'')}</div>` : ``;

    const item = document.createElement('div');
    item.className = `ms-dual-item ${isReached ? 'active' : ''} ${isNext ? 'next' : ''}`;
    item.innerHTML = `
      <div class="ms-d-head">
        <div class="ms-d-th">滿 $${(Number(g.amt)||0).toLocaleString()}</div>
        ${tagHtml}
      </div>
      <div class="ms-d-body">
        <div class="ms-d-media">${imgHtml}</div>
        <div class="ms-d-info">
          <div class="ms-d-name">${String(gName||'').replace(/[<>]/g,'')}</div>
        </div>
      </div>
    `;
    return item;
}

function checkNewGifts(currentGifts) {
    const currentNames = currentGifts.map(g => g.name);
    const newUnlocks = currentNames.filter(n => !achievedGifts.includes(n));
    
    if(newUnlocks.length > 0) {
        const fab = document.getElementById('gift-fab');
        const notify = document.getElementById('top-notify');
        const txt = document.getElementById('tn-text');
        
        if(document.getElementById('milestone-overlay').classList.contains('open') === false) {
             fab.style.display = 'flex'; 
        }

        fab.classList.add('gift-shake');
        
        let html = "";
        newUnlocks.forEach(name => {
           html += `<div>• ${name}</div>`;
        });
        txt.innerHTML = html;
        
        notify.classList.add('show');
        
        setTimeout(() => {
            fab.classList.remove('gift-shake');
            notify.classList.remove('show');
        }, 4000); 
    }
    achievedGifts = currentNames;
}

// --- LOGIC FUNCTIONS ---

function saveState() {
  const state = { cart: CART }; 
  localStorage.setItem('v17_cart_data', JSON.stringify(state));
}

function loadState() {
  const raw = localStorage.getItem('v17_cart_data');
  if(!raw) return;
  try {
    const data = JSON.parse(raw);
    CART = data.cart.map(oldItem => {
      const freshItem = PRODUCT_MAP.get(oldItem.code);
      if(freshItem && !freshItem.is_hidden) {
          return { ...freshItem, qty: oldItem.qty, bundleSelection: oldItem.bundleSelection };
      }
      return null;
    }).filter(x => x);
    
    const cData = calcCart();
    achievedGifts = cData.gifts.map(g => g.name);
    
    refreshCart();
    renderList();
    if(CART.length > 0) {
      const fab = document.getElementById("float-bar");
      fab.classList.remove("show");
      void fab.offsetWidth;
      fab.classList.add("show");
      
      isFirstAdd = false;
      document.getElementById('gift-fab').style.display = 'flex';
    }
  } catch(e) { console.error("Load state failed", e); }
}

function showToast(msg, type='normal', durationMs=null) {
  const c = document.getElementById('toast-container');
  const t = document.createElement('div');
  t.className = 'toast';
  if(type === 'game') t.classList.add('game');
  let icon = 'check_circle';
  if (type === 'warn') icon = 'error_outline';
  if (type === 'info') icon = 'info';
  if (type === 'game') icon = 'stars'; 
  const color = (type==='warn') ? '#ff5252' : (type==='game' ? '#fff' : (type==='info' ? '#29b6f6' : '#69f0ae'));
  t.innerHTML = `<span class="material-icons-round" style="color:${color}">${icon}</span> ${msg}`;
  c.appendChild(t); 
  const ms = (durationMs!=null && isFinite(durationMs)) ? Number(durationMs) : (type === 'game' ? 3000 : 2500);
  setTimeout(() => t.remove(), ms);
  return t; 
}


// --- V2.8.8 helpers: unified discount wording (85折 style) + promo hint toast ---
const BOOT_TS = Date.now();

function fmtZheFromPctOff(pctOff){
  const off = Number(pctOff);
  if(!isFinite(off)) return "";
  let payPct = Math.round(100 - off);
  if(!isFinite(payPct)) return "";
  if(payPct < 0) payPct = 0;
  if(payPct > 100) payPct = 100;
  if(payPct % 10 === 0) return `${payPct/10}折`;
  return `${payPct}折`;
}

function uiGet(key, fallback=''){
  try{
    const k = String(key||'').trim();
    if(!k || !RULES) return String(fallback||'');
    const notes = RULES.uiNotes || {};
    if(notes[k] != null && String(notes[k]).trim() !== '') return String(notes[k]).trim();
    const alt = k.startsWith('ui|') ? k.replace(/^ui\|/,'') : ('ui|' + k);
    if(notes[alt] != null && String(notes[alt]).trim() !== '') return String(notes[alt]).trim();
    const cfg = RULES.uiCfg || {};
    if(cfg[k] != null && String(cfg[k]).trim() !== '') return String(cfg[k]).trim();
    if(cfg[alt] != null && String(cfg[alt]).trim() !== '') return String(cfg[alt]).trim();
    return String(fallback||'');
  }catch(e){ return String(fallback||''); }
}
function uiGetNumber(key, fallback){
  const raw = uiGet(key, '');
  const n = Number(String(raw).replace(/,/g,'').trim());
  if(isFinite(n)) return n;
  return fallback;
}
function getPromoHintDurationMs(){
  let ms = uiGetNumber('ui|promo_hint_ms', NaN);
  if(!isFinite(ms)) ms = uiGetNumber('promo_hint_ms', NaN);
  if(!isFinite(ms)) {
    const sec = uiGetNumber('ui|promo_hint_sec', NaN);
    if(isFinite(sec)) ms = sec * 1000;
  }
  if(!isFinite(ms)) {
    const sec = uiGetNumber('promo_hint_sec', NaN);
    if(isFinite(sec)) ms = sec * 1000;
  }
  if(!isFinite(ms)) ms = 2800;
  if(ms > 0 && ms <= 60) ms = ms * 1000;
  ms = Math.max(1200, Math.min(8000, ms));
  return Math.round(ms);
}
function getBadgeName(kind, fallback){
  return uiGet(`badge_name|${kind}`, uiGet(`ui|badge_name|${kind}`, fallback));
}
function applyUiThemeVars(){
  try{
    const root = document.documentElement;
    const acc = (RULES && RULES.uiAccent) ? RULES.uiAccent : {};
    const brandMap = { beauty:'brand|beauty', clean:'brand|clean', drink:'brand|drink', health:'brand|health' };
    const alphaMap = { beauty:0.78, clean:0.70, drink:0.68, health:0.78 };

    function hexToRgba(hex, a){
      const h = String(hex||'').trim();
      const mm = h.match(/^#?([0-9a-fA-F]{6})$/);
      if(!mm) return '';
      const v = mm[1];
      const r = parseInt(v.slice(0,2),16), g = parseInt(v.slice(2,4),16), b = parseInt(v.slice(4,6),16);
      return `rgba(${r}, ${g}, ${b}, ${a})`;
    }
    Object.keys(brandMap).forEach(k=>{
      const z = brandMap[k];
      const c1 = acc[z]?.c1 || '';
      const rgba = c1 ? (hexToRgba(c1, alphaMap[k] || 0.75) || c1) : '';
      if(rgba) root.style.setProperty(`--pm-accent-${k}`, rgba);
    });

    const catInfo = acc['ui|cat_info_icon']?.c1 || acc['cat_info_icon']?.c1 || '';
    if(catInfo){
      root.style.setProperty('--cat-info-fg', catInfo);
      root.style.setProperty('--cat-info-bg', hexToRgba(catInfo, 0.12) || 'rgba(224,242,241,0.90)');
      root.style.setProperty('--cat-info-border', hexToRgba(catInfo, 0.35) || 'rgba(0,137,123,0.55)');
    }
    const annIcon = acc['ui|announce_icon']?.c1 || acc['announce_icon']?.c1 || acc['ui|promo_map_cta_icon']?.c1 || acc['promo_map_cta_icon']?.c1 || '';
    if(annIcon) root.style.setProperty('--ann-icon-fg', annIcon);

// NEW badge theming (sheet-configurable)
const nb = acc['ui|new_badge'] || acc['new_badge'] || null;
if(nb && (nb.c1 || nb.c2)){
  const c1 = String(nb.c1 || '').trim();
  const c2 = String(nb.c2 || '').trim();
  let bg = '';
  if(c1 && c2) bg = `linear-gradient(135deg, ${c1}, ${c2})`;
  else if(c1) bg = c1;
  if(bg) root.style.setProperty('--new-badge-bg', bg);
}
const nbt = (acc['ui|new_badge_text']?.c1) || (acc['new_badge_text']?.c1) || '';
if(nbt) root.style.setProperty('--new-badge-text', String(nbt).trim());


  }catch(e){}
}
function escapeHtml(str){
  return String(str||'').replace(/[&<>"']/g, (c) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
}
function showPromoHint(msg){
  try{
    let s = String(msg||'');
    // allow sheet-friendly literal \n
    s = s.replace(/\\n/g, '\n');
    s = escapeHtml(s).replace(/\r?\n/g, '<br>');
    showToast(s, 'info', getPromoHintDurationMs());
  }catch(e){}
}
// --- V2.8.9: Promo Map (優惠地圖) Drawer ---
function getCatHintOverride(catTitle){
  try{
    const t = String(catTitle||'').trim();
    const notes = (RULES && RULES.uiNotes) ? RULES.uiNotes : {};
    const keys = Object.keys(notes).filter(k => k.startsWith('cat_hint|'));

    // 1) Exact match first (最高優先)
    for(const k of keys){
      const suffix = String(k.split('|')[1]||'').trim();
      if(!suffix) continue;
      if(t === suffix) return String(notes[k]||'').trim();
    }

    // 2) Fallback: allow parent hint to apply to sub-category (title includes suffix)
    let bestSuffix = '';
    let bestText = '';
    for(const k of keys){
      const suffix = String(k.split('|')[1]||'').trim();
      if(!suffix) continue;
      if(t.includes(suffix)){
        if(suffix.length > bestSuffix.length){
          bestSuffix = suffix;
          bestText = String(notes[k]||'').trim();
        }
      }
    }
    return bestText;
  }catch(e){ return ''; }
}

function detectPromoMapBrandByTitle(title){
  const t = String(title||'').trim();
  if(!t) return 'health';
  // Drink has priority (so '保健飲品' 走飲品色)
  if(t.includes('飲品') || t.includes('麥汁') || t.includes('黑麥') || t.includes('啤酒') && t.includes('飲')) return 'drink';
  if(t.includes('美容')) return 'beauty';
  if(t.includes('清潔')) return 'clean';
  if(t.includes('保健')) return 'health';
  return 'health';
}


function categoryUnlocksAddonByTitle(title){
  try{
    const t = String(title||'').trim();
    if(!t || !RULES || !Array.isArray(RULES.eligibility)) return false;
    for(const e of RULES.eligibility){
      const reqs = splitMultiVals(e && e.requires ? e.requires : '');
      for(const rz of reqs){
        const dz = formatZoneDisplay(rz);
        if(dz && (t.includes(dz) || dz.includes(t))) return true;
        if(rz && (t.includes(rz) || String(rz).includes(t))) return true;
      }
    }
    return false;
  }catch(e){ return false; }
}

function buildPromoMapRowHint(title){
  const override = getCatHintOverride(title);
  if(override) return override;
  const info = getTierBadgeInfoByCategory(title);
  const base = buildTierHintText(info);
  if(base) return base;
  if(categoryUnlocksAddonByTitle(title)) return '可解鎖加購優惠';
  return '';
}

function ensurePromoMapDom(){
  const overlay = document.getElementById('promoMapOverlay');
  const drawer = document.getElementById('promoMapDrawer');
  return !!(overlay && drawer);
}

// Promo Map: pending category jump (avoid triggering root-back logic)
let __PM_PENDING_SCROLL_ID__ = null;
function pmScrollToTargetId(id){
  try{
    const tid = String(id||'').trim();
    if(!tid) return;
    const target = document.getElementById(tid);
    if(!target) return;

    const header = document.getElementById('header');
    const headerH = header ? header.getBoundingClientRect().height : 110;
    const offset = Math.min(140, Math.max(78, (headerH || 110) - 18));

    const y = target.getBoundingClientRect().top + window.pageYOffset - offset;
    window.scrollTo({ top: Math.max(0, y), behavior:'smooth' });
  }catch(e){}
}

// Defer scroll until after drawer close/layout settle (prevents partial scroll / wrong stop)
function pmDeferredScroll(id){
  try{
    const tid = String(id||'').trim();
    if(!tid) return;
    requestAnimationFrame(()=>{ requestAnimationFrame(()=>{ try{ pmScrollToTargetId(tid); }catch(e){} }); });
  }catch(e){}
}


function buildPromoMapList(){
  try{
    const listEl = document.getElementById('promoMapList');
    if(!listEl) return;
    listEl.innerHTML = '';
    const sections = Array.from(document.querySelectorAll('.cat-section'));
    sections.forEach(sec => {
      const titleEl = sec.querySelector('.cat-section-title');
      const title = titleEl ? String(titleEl.innerText||'').trim() : '';
      if(!title) return;
      const hint = buildPromoMapRowHint(title);
      const hasAddon = categoryUnlocksAddonByTitle(title);
      const brand = detectPromoMapBrandByTitle(title);
let catAccent = null;
try{
  const m2 = (RULES && RULES.uiCatStyle) ? RULES.uiCatStyle : {};
  if(m2 && m2[title] && (m2[title].c1 || m2[title].c2)) catAccent = m2[title];
}catch(e){}


      // styling hint kind for drawer (order/tier/bogo/addon)
      const tierInfo = getTierBadgeInfoByCategory(title);
      let kind = (tierInfo && tierInfo.kind) ? String(tierInfo.kind) : '';
      if(!kind && String(title).includes('買一送一')) kind = 'bogo';
      if(!kind && hasAddon) kind = 'addon';

      const item = document.createElement('div');
      item.className = 'pm-item';
      item.setAttribute('data-kind', kind || 'plain');
      item.setAttribute('data-brand', brand || 'health');
try{
  const acc = (RULES && RULES.uiAccent) ? RULES.uiAccent : {};
  function hexToRgba(hex, a){
    const h = String(hex||'').trim();
    const mm = h.match(/^#?([0-9a-fA-F]{6})$/);
    if(!mm) return '';
    const v = mm[1];
    const r = parseInt(v.slice(0,2),16), g = parseInt(v.slice(2,4),16), b = parseInt(v.slice(4,6),16);
    return `rgba(${r}, ${g}, ${b}, ${a})`;
  }
  let c1 = (catAccent && catAccent.c1) ? catAccent.c1 : '';
  if(!c1){
    const pal = acc[`brand|${brand}`];
    c1 = pal ? (pal.c1 || '') : '';
  }
  if(c1){
    const a = (brand === 'clean') ? 0.70 : (brand === 'drink') ? 0.68 : 0.78;
    item.style.setProperty('--pm-accent', hexToRgba(c1, a) || c1);
  }
}catch(e){}

      item.setAttribute('data-target', sec.id || '');
      item.innerHTML = `
        <div class="row">
          <div>
            <div class="name">${title.replace(/[<>]/g,'')}</div>
            ${hint ? `<div class="hint">${String(hint).replace(/[<>]/g,'')}</div>` : ``}
            ${(hasAddon && (!hint || hint.indexOf('加購')===-1)) ? `<div class="pm-tags"><span class="pm-tag">可解鎖加購</span></div>` : ``}
          </div>
          <div class="pm-arrow">›</div>
        </div>
      `;
      item.onclick = () => {
        const id = item.getAttribute('data-target');
        // Set pending target and close via history (so onpopstate can close drawer without triggering root-back logic)
        __PM_PENDING_SCROLL_ID__ = id || null;
        try{ closePromoMap(); }catch(e){}
      };
      listEl.appendChild(item);
    });
  }catch(e){}
}

/* --- V29: Promo Map '贈品門檻' 分頁 --- */
function pmLsGet(key, defVal){
  try{
    const v = localStorage.getItem(key);
    return (v === null || v === undefined || v === '') ? defVal : v;
  }catch(e){ return defVal; }
}
function pmLsSet(key, val){
  try{ localStorage.setItem(key, String(val)); }catch(e){}
}
function pmFormatGiftName(gift){
  try{
    let gName = (PRODUCT_MAP.get(gift) || {}).name || gift;
    gName = String(gName||'').replace(/^(贈品|贈|Gift)[:\s|｜_]*/i, "");
    return gName;
  }catch(e){ return String(gift||''); }
}

function buildPromoGiftList(scope){
  try{
    const listEl = document.getElementById('promoGiftList');
    if(!listEl) return;
    listEl.innerHTML = '';

    const sc = String(scope||'all');

    // Series gift rules (explain-only)
    if(sc === 'series'){
      const rules = (RULES && Array.isArray(RULES.series_gift)) ? RULES.series_gift.filter(r => r && r.gift) : [];
      rules.sort((a,b)=>{
        const pa = String(a.prefix||'');
        const pb = String(b.prefix||'');
        if(pa !== pb) return pa.localeCompare(pb, 'zh-Hant');
        return (Number(a.amt)||0) - (Number(b.amt)||0);
      });

      if(!rules.length){
        listEl.innerHTML = '<div class="pm-empty">目前沒有可顯示的系列搭贈規則</div>';
        return;
      }

      rules.forEach(g => {
        const item = document.createElement('div');
        item.className = 'pm-gift-item pm-gift-series';

        const prefixes = (typeof splitPrefixes === 'function') ? splitPrefixes(g.prefix) : [String(g.prefix||'')];
        const prefixLabel = prefixes.filter(Boolean).join('、');

        const thr = Number(g.amt);
        const unit = (typeof seriesGiftUnit === 'function') ? seriesGiftUnit(prefixLabel) : '件';
        const giftQty = Number(g.qty)||0;

        let ruleText = '';
        if(Number.isFinite(thr) && thr > 0){
          ruleText = `每 ${Math.round(thr)} ${unit}送 ${giftQty} 個`;
        }else{
          // threshold empty => treat as "每 1 單位送"
          ruleText = `每 1 ${unit}送 ${giftQty} 個`;
        }

        const gName = pmFormatGiftName(g.gift);
        let imgHtml = '';
        try{ imgHtml = renderGiftImages(g.gift) || ''; }catch(e){}
        if(!imgHtml) imgHtml = '<div class="g-thumb" style="display:flex;align-items:center;justify-content:center;font-size:16px">🎁</div>';

        item.innerHTML = `
          <div class="pm-gift-row">
            <div class="pm-gift-media">${imgHtml}</div>
            <div class="pm-gift-info">
              <div class="pm-gift-amt">${ruleText}</div>
              <div class="pm-gift-name">${String(gName||'').replace(/[<>]/g,'')}</div>
              ${prefixLabel ? `<div class="pm-gift-note">適用系列：${String(prefixLabel).replace(/[<>]/g,'')}</div>` : ''}
            </div>
          </div>
        `;
        listEl.appendChild(item);
      });
      return;
    }

    // Spend thresholds (all / beauty)
    const gifts = (RULES && Array.isArray(RULES.spend)) ? RULES.spend.filter(r => r && r.scope === sc).sort((a,b)=> (a.amt||0)-(b.amt||0)) : [];
    if(!gifts.length){
      listEl.innerHTML = '<div class="pm-empty">目前沒有可顯示的贈品門檻</div>';
      return;
    }

    gifts.forEach(g => {
      const item = document.createElement('div');
      item.className = `pm-gift-item ${sc === 'zone_prefix' ? 'pm-gift-beauty' : 'pm-gift-all'}`;
      const amt = Number(g.amt||0);
      const gName = pmFormatGiftName(g.gift);
      let imgHtml = '';
      try{ imgHtml = renderGiftImages(g.gift) || ''; }catch(e){}
      if(!imgHtml) imgHtml = '<div class="g-thumb" style="display:flex;align-items:center;justify-content:center;font-size:16px">🎁</div>';

      item.innerHTML = `
        <div class="pm-gift-row">
          <div class="pm-gift-media">${imgHtml}</div>
          <div class="pm-gift-info">
            <div class="pm-gift-amt">滿 $${Math.round(amt).toLocaleString()}</div>
            <div class="pm-gift-name">${String(gName||'').replace(/[<>]/g,'')}</div>
          </div>
        </div>
      `;
      listEl.appendChild(item);
    });
  }catch(e){}
}

function updatePromoGiftHeader(sc){
  try{
    const header = document.getElementById('pmGiftHeader');
    if(!header) return;

    const mode = String(sc||'all');
    const isBeauty = (mode === 'zone_prefix');
    const isSeries = (mode === 'series');

    header.classList.toggle('pm-gh-all', mode === 'all');
    header.classList.toggle('pm-gh-beauty', isBeauty);
    header.classList.toggle('pm-gh-series', isSeries);

    const badge = header.querySelector('.pm-badge');
    const title = header.querySelector('.pm-gh-title');
    const sub = header.querySelector('.pm-gh-sub');

    if(isSeries){
      if(badge){
        badge.classList.remove('pm-badge-all','pm-badge-beauty');
        badge.classList.add('pm-badge-series');
        badge.textContent = 'SERIES';
      }
      if(title) title.textContent = '系列贈品';
      if(sub) sub.textContent = '依系列搭贈條件';
      return;
    }

    if(isBeauty){
      if(badge){
        badge.classList.remove('pm-badge-all','pm-badge-series');
        badge.classList.add('pm-badge-beauty');
        badge.textContent = 'BEAUTY';
      }
      if(title) title.textContent = '美容區滿額贈';
      if(sub) sub.textContent = '僅美容區商品累計';
    }else{
      if(badge){
        badge.classList.remove('pm-badge-beauty','pm-badge-series');
        badge.classList.add('pm-badge-all');
        badge.textContent = 'ALL';
      }
      if(title) title.textContent = '全區滿額贈';
      if(sub) sub.textContent = '全站商品合併計算';
    }
  }catch(e){}
}

function setPromoGiftScope(scope, opts){
  const o = opts || {};
  const raw = String(scope||'');
  const sc = (raw === 'zone_prefix' || raw === 'series' || raw === 'all') ? raw : 'all';

  const btns = Array.from(document.querySelectorAll('#promoMapPaneGifts .pm-scope-btn'));
  btns.forEach(b=>{
    const isOn = (String(b.getAttribute('data-scope')) === sc);
    b.classList.toggle('active', isOn);
    b.setAttribute('aria-selected', isOn ? 'true' : 'false');
  });
  if(!o.skipSave) pmLsSet('ttl_pm_gift_scope', sc);

  // Visual split (all / beauty / series)
  try{
    const pane = document.getElementById('promoMapPaneGifts');
    const list = document.getElementById('promoGiftList');
    if(pane){
      pane.classList.toggle('scope-all', sc === 'all');
      pane.classList.toggle('scope-beauty', sc === 'zone_prefix');
      pane.classList.toggle('scope-series', sc === 'series');
    }
    if(list){
      list.classList.toggle('scope-all', sc === 'all');
      list.classList.toggle('scope-beauty', sc === 'zone_prefix');
      list.classList.toggle('scope-series', sc === 'series');
    }
  }catch(e){}

  updatePromoGiftHeader(sc);
  buildPromoGiftList(sc);
}

function setPromoMapTab(tab, opts){
  const o = opts || {};
  const t = (tab === 'gifts') ? 'gifts' : 'nav';
  const navBtn = document.getElementById('pmTabNav');
  const giftsBtn = document.getElementById('pmTabGifts');
  const paneNav = document.getElementById('promoMapPaneNav');
  const paneGifts = document.getElementById('promoMapPaneGifts');
  if(navBtn){ navBtn.classList.toggle('active', t==='nav'); navBtn.setAttribute('aria-selected', t==='nav' ? 'true' : 'false'); }
  if(giftsBtn){ giftsBtn.classList.toggle('active', t==='gifts'); giftsBtn.setAttribute('aria-selected', t==='gifts' ? 'true' : 'false'); }
  if(paneNav) paneNav.style.display = (t==='nav') ? 'block' : 'none';
  if(paneGifts) paneGifts.style.display = (t==='gifts') ? 'block' : 'none';
  if(!o.skipSave) pmLsSet('ttl_pm_tab', t);

  if(t==='nav'){
    buildPromoMapList();
  }else{
    const scope = pmLsGet('ttl_pm_gift_scope', 'zone_prefix');
    setPromoGiftScope(scope, {skipSave:true});
  }
}

function initPromoMapTabsOnce(){
  try{
    const drawer = document.getElementById('promoMapDrawer');
    if(!drawer) return;
    if(drawer.dataset.pmTabsInited === '1') return;

    const navBtn = document.getElementById('pmTabNav');
    const giftsBtn = document.getElementById('pmTabGifts');
    if(navBtn) navBtn.onclick = () => setPromoMapTab('nav');
    if(giftsBtn) giftsBtn.onclick = () => setPromoMapTab('gifts');

    const scopeBtns = Array.from(document.querySelectorAll('#promoMapPaneGifts .pm-scope-btn'));
    scopeBtns.forEach(b=>{
      b.onclick = () => setPromoGiftScope(b.getAttribute('data-scope'));
    });

    drawer.dataset.pmTabsInited = '1';
  }catch(e){}
}

function openPromoMap(){
  try{
    if(!ensurePromoMapDom()) return;
    initPromoMapTabsOnce();
    const prefTab = pmLsGet('ttl_pm_tab','nav');
    setPromoMapTab(prefTab, {skipSave:true});
    document.body.classList.add('drawer-open');
    const overlay = document.getElementById('promoMapOverlay');
    const drawer = document.getElementById('promoMapDrawer');
    overlay.style.display = 'block';
    drawer.classList.add('open');

    
    try{ history.pushState({modal:'promoMap'}, null, ""); }catch(e){}
overlay.onclick = () => closePromoMap();
    const closeBtn = document.getElementById('promoMapCloseBtn');
    if(closeBtn) closeBtn.onclick = () => closePromoMap();
  }catch(e){}
}

function closePromoMap(opts){
  const o = opts || {};
  const skipHistory = !!o.skipHistory;

  // Preferred close path: if we are on the promoMap history entry,
  // just go back and let onpopstate close the drawer (prevents root-back logic interference).
  try{
    if(!skipHistory && history.state && history.state.modal === 'promoMap' && isPromoMapOpen()){
      history.back();
      return;
    }
  }catch(e){}

  // Hard close (no history interaction)
  try{
    const overlay = document.getElementById('promoMapOverlay');
    const drawer = document.getElementById('promoMapDrawer');
    if(overlay) overlay.style.display = 'none';
    if(drawer) drawer.classList.remove('open');
    document.body.classList.remove('drawer-open');
  }catch(e){}

  // If we have a pending jump target (e.g., close without popstate), do it after close
  try{
    const pending = __PM_PENDING_SCROLL_ID__;
    __PM_PENDING_SCROLL_ID__ = null;
    if(pending){
      pmDeferredScroll(pending);
    }
  }catch(e){}
}


// --- Promo Map + Back Guard helpers ---
let BACK_EXIT_ARMED_UNTIL = 0;

function isPromoMapOpen(){
  const d = document.getElementById('promoMapDrawer');
  return !!(d && d.classList.contains('open'));
}

function initBackGuard(){
  try{
    const st = history.state || null;
    if(st && (st.page === 'guard' || st.page === 'root')) return;
    history.replaceState({page:'root'}, null, "");
    history.pushState({page:'guard'}, null, "");
  }catch(e){}
}

function armBackGuard(){
  try{
    const st = history.state || null;
    if(st && st.page === 'guard') return;
    history.pushState({page:'guard'}, null, "");
  }catch(e){}
}

function handleRootBack(){
  try{
    // Step 1: if not at top, go top first
    if(window.scrollY > 60){
      window.scrollTo({top:0, behavior:'smooth'});
      BACK_EXIT_ARMED_UNTIL = 0;
      armBackGuard();
      return;
    }

    // Step 2: at top, show exit hint then allow exit on next back
    const now = Date.now();
    if(now < BACK_EXIT_ARMED_UNTIL){
      BACK_EXIT_ARMED_UNTIL = 0;
      try{ window.onbeforeunload = null; }catch(e){}
      history.back();
      return;
    }

    showToast('再按一次返回即可離開', 'info', 2000);
    BACK_EXIT_ARMED_UNTIL = now + 2200;
    armBackGuard();
  }catch(e){
    try{ armBackGuard(); }catch(e2){}
  }
}

function showInitBlockedToast(){
  const waited = Math.max(1, Math.round((Date.now() - BOOT_TS)/1000));
  showToast(`系統初始化中…已等待 ${waited} 秒`, 'info', 2800);
}

function setBootConfigState(state){
  try{
    document.body.classList.remove('cfg-loading','cfg-ready','cfg-error');
    if(state === 'loading') document.body.classList.add('cfg-loading');
    if(state === 'ready') document.body.classList.add('cfg-ready');
    if(state === 'error') document.body.classList.add('cfg-error');
  }catch(e){}
}

function renderSystemAnnouncement(){
  try{
    const slot = document.getElementById('systemAnnouncementSlot');
    if(!slot) return;
    const notes = (RULES && RULES.uiNotes) ? RULES.uiNotes : {};
    const raw = (notes && notes['announce_between_rank_and_categories']) ? String(notes['announce_between_rank_and_categories']) : '';
    const msg = String(raw||'').trim();
    const safe = msg ? msg.split('\n').map(s => s.replace(/[<>]/g,'')).join('<br>') : '';
    const seen = (function(){ try{ return localStorage.getItem('ttl_promo_map_seen')==='1'; }catch(e){ return false; } })();
    const attnCls = seen ? '' : ' pm-attn';

    // show slot if has message OR we still want CTA entry
    slot.style.display='block';
    slot.innerHTML = `
      <div class="sys-ann sys-ann--row">
        <button type="button" id="starDockBtn" class="star-dock-btn hidden" title="主打星"><span class="material-icons-round">star</span><span class="star-dock-badge" id="starDockBadge" style="display:none">0</span></button>
        ${safe ? `<div class="sys-ann-main">${safe}</div>` : `<div class="sys-ann-main"></div>`}
        <button type="button" id="promoMapCtaBtn" class="sys-ann-cta${attnCls}"><span class="cta-icon">👉</span><span class="cta-text">查看優惠地圖 ›</span></button>
      </div>
    `;

    const btn = document.getElementById('promoMapCtaBtn');
    if(btn){
try{
  const iconEl = btn.querySelector('.cta-icon');
  const textEl = btn.querySelector('.cta-text');
  const iconTxt = uiGet('ui|promo_map_cta_icon', uiGet('promo_map_cta_icon','👉')) || '👉';
  const labelTxt = uiGet('ui|promo_map_cta_text', uiGet('promo_map_cta_text','查看優惠地圖 ›')) || '查看優惠地圖 ›';
  if(iconEl) iconEl.textContent = iconTxt;
  if(textEl) textEl.textContent = labelTxt;
}catch(e){}

      btn.onclick = (ev) => {
        ev.preventDefault();
        ev.stopPropagation();
        try{ localStorage.setItem('ttl_promo_map_seen','1'); }catch(e){}
        try{ btn.classList.remove('pm-attn'); }catch(e){}
        try{ openPromoMap(); }catch(e){}
      };
    }
  }catch(e){}
}



/* --- V2.9.2: Star Hero (主打星) behavior --- */
let __STAR_AUTO_PENDING__ = false;
let __STAR_OPEN__ = false;
let __STAR_CLOSING__ = false;
let __STAR_PENDING_NAV__ = null;
let __STAR_ATT_TIMER__ = null;
let __STAR_SCROLL_TIMER__ = null;
let __STAR_ITEMS__ = [];
let __STAR_ACTIVE_IDX__ = 0;
let __STAR_SUBTITLE_TPL__ = '';


// --- Star Hero DOM template reset (hard fix for "blur only" reopen) ---
let __STAR_TEMPLATE_HTML__ = null;
function __starCaptureTemplate(){
  try{
    const ov = document.getElementById('starHeroOverlay');
    if(!ov) return;
    if(__STAR_TEMPLATE_HTML__ == null){
      __STAR_TEMPLATE_HTML__ = ov.innerHTML;
    }
  }catch(e){}
}
function __starRebuildDOM(){
  try{
    const ov = document.getElementById('starHeroOverlay');
    if(!ov) return;
    __starCaptureTemplate();
    if(__STAR_TEMPLATE_HTML__ != null){
      // Rebuild inner DOM to purge any lingering WAAPI fill-forwards / computed opacity issues
      ov.innerHTML = __STAR_TEMPLATE_HTML__;
    }
  }catch(e){}
}



let __STAR_CLOSE_WATCHDOG__ = null;
let __STAR_REOPEN_PENDING__ = false;
function starIsDismissed(){
  try{ return localStorage.getItem('ttl_star_hero_dismissed') === '1'; }catch(e){ return false; }
}
function setStarDismissed(){
  try{ localStorage.setItem('ttl_star_hero_dismissed','1'); }catch(e){}
}
function getStarProducts(){
  try{
    const list = Array.isArray(PRODUCTS) ? PRODUCTS.slice() : [];
    const vis = list.filter(p => p && !p.isGift && !p.isHidden && String(p.photo||'').trim() !== '');

    const pickNew = ()=>{
      const news = vis.filter(p => p.isNew);
      const base = (news.length ? news : vis).slice();
      base.sort((a,b)=>{
        const aa = String(a.category||'').includes('加價購') ? 1 : 0;
        const bb = String(b.category||'').includes('加價購') ? 1 : 0;
        if(aa !== bb) return aa - bb;
        return (String(a.name||'') > String(b.name||'')) ? 1 : -1;
      });
      return base.slice(0,8);
    };

    const codesRaw = uiGet('star|codes', uiGet('ui|star_codes','')).trim();
    let picks = [];
    if(codesRaw){
      const codes = codesRaw.split(/[\s,;\n]+/).map(s=>s.trim()).filter(Boolean);
      const set = new Set(codes);
      picks = vis.filter(p => p && set.has(String(p.code||'').trim()));
      const map = new Map(picks.map(p => [String(p.code||'').trim(), p]));
      picks = codes.map(c => map.get(c)).filter(Boolean);
      if(picks.length === 0) picks = pickNew();
    }else{
      picks = pickNew();
    }
    return picks.slice(0,8);
  }catch(e){
    return [];
  }
}


function getStarHeroCopy(){
  try{
    const defTitle = '商城首選推薦｜超值特殺';
    const defSub = '滑一下挑喜歡的，點一下就帶你去商品 ✨';
    const title = (uiGet('star|title', uiGet('ui|star_title', defTitle)) || defTitle).trim();
    const sub = (uiGet('star|subtitle', uiGet('star|sub', uiGet('ui|star_subtitle', defSub))) || defSub).trim();
    return { title: title || defTitle, sub: sub || defSub };
  }catch(e){
    return { title:'商城首選推薦｜超值特殺', sub:'滑一下挑喜歡的，點一下就帶你去商品 ✨' };
  }
}
function _formatStarSubtitle(tpl, name){
  try{
    const n = String(name||'').trim();
    const s = String(tpl||'');
    if(!n) return s;
    // supports: {name} / {{name}} / {product} / {{product}} / %NAME%
    if(/[\{\%](?:\s*(?:name|product)\s*)[\}\%]/i.test(s) || /\%NAME\%/i.test(s)){
      return s
        .replace(/\{\{\s*(name|product)\s*\}\}/gi, n)
        .replace(/\{\s*(name|product)\s*\}/gi, n)
        .replace(/\%NAME\%/gi, n);
    }
    return s;
  }catch(e){
    return String(tpl||'');
  }
}
function updateStarHeroSubtitleByIdx(idx){
  try{
    __STAR_ACTIVE_IDX__ = Math.max(0, Number(idx)||0);
    const el = document.getElementById('starHeroSubtitleText');
    if(!el) return;
    const item = (__STAR_ITEMS__ && __STAR_ITEMS__[__STAR_ACTIVE_IDX__]) ? __STAR_ITEMS__[__STAR_ACTIVE_IDX__] : null;
    const name = item ? (item.name || '') : '';
    const tpl = (__STAR_SUBTITLE_TPL__ && String(__STAR_SUBTITLE_TPL__).length) ? __STAR_SUBTITLE_TPL__ : getStarHeroCopy().sub;
    el.textContent = _formatStarSubtitle(tpl, name);
  }catch(e){}
}
function applyStarHeroCopy(){
  try{
    const c = getStarHeroCopy();
    __STAR_SUBTITLE_TPL__ = c.sub;
    const tEl = document.getElementById('starHeroTitleText');
    const sEl = document.getElementById('starHeroSubtitleText');
    if(tEl) tEl.textContent = c.title;
    // show template first (will be replaced after carousel build)
    if(sEl) sEl.textContent = c.sub;
  }catch(e){}
}


function _starZoneOf(p){
  const c = String((p && p.category) || '').toLowerCase();
  if(c.includes('美容') || c.includes('beauty')) return 'beauty';
  if(c.includes('清潔') || c.includes('clean')) return 'cleaning';
  if(c.includes('保健') || c.includes('health')) return 'health';
  if(c.includes('飲品') || c.includes('drink')) return 'drink';
  return '';
}
function _starTierApplies(tZone, pZone){
  const z = String(tZone||'').trim().toLowerCase();
  const pz = String(pZone||'').trim().toLowerCase();
  if(!z || z === 'all') return true;
  if(!pz) return (z.includes('全') || z.includes('all'));
  return (z === pz) || z.includes(pz) || pz.includes(z) || (pz==='beauty' && z.includes('美容')) || (z==='beauty' && pz.includes('美容'));
}
function calcStarDeal(p){
  const base = Number(p && p.price || 0);
  let bestRatio = (base > 0 && isFinite(base)) ? 1 : 1;
  let bestUnit  = (base > 0 && isFinite(base)) ? base : 0;
  let source = '';

  // Bundle promo price (best absolute promo)
  try{
    const bundleRule = (RULES && Array.isArray(RULES.bundle)) ? RULES.bundle.find(r => r && r.code === (p && p.code) && isFinite(r.price) && r.price > 0) : null;
    if(bundleRule){
      const unit = Number(bundleRule.price);
      if(unit > 0 && isFinite(unit)){
        const ratio = (base > 0) ? (unit / base) : 1;
        if(!isFinite(bestUnit) || bestUnit <= 0 || ratio < bestRatio){
          bestRatio = (base > 0) ? ratio : 1;
          bestUnit  = unit;
          source = 'bundle';
        }
      }
    }
  }catch(e){}

  // BOGO effective unit price
  try{
    const bg = (RULES && Array.isArray(RULES.bogo)) ? RULES.bogo.find(r => r && r.code === (p && p.code)) : null;
    if(bg && bg.buy > 0 && bg.get > 0 && base > 0){
      const ratio = bg.buy / (bg.buy + bg.get);
      const unit = base * ratio;
      if(ratio < bestRatio){
        bestRatio = ratio;
        bestUnit  = unit;
        source = 'bogo';
      }
    }
  }catch(e){}

  // Tier discount range (use the BEST pct => lowest unit price)
  try{
    const tr = getTierDiscountRangeForProduct(p);
    if(tr && isFinite(tr.low) && tr.low > 0 && base > 0){
      const ratio = tr.low / base;
      if(ratio < bestRatio){
        bestRatio = ratio;
        bestUnit  = tr.low;
        source = 'tier';
      }
    }
  }catch(e){}

  const minPrice = (bestUnit > 0 && isFinite(bestUnit)) ? Math.round(bestUnit) : (base > 0 ? Math.round(base) : 0);

  let foldStr = '10';
  if(base > 0 && isFinite(bestRatio) && bestRatio > 0){
    const fold = Math.round(bestRatio * 10 * 10) / 10; // 1 decimal
    foldStr = (Math.abs(fold - Math.round(fold)) < 0.05) ? String(Math.round(fold)) : fold.toFixed(1);
  }
  return { minPrice, foldText: `${foldStr}折起`, ratio: bestRatio, source };
}

function buildStarHeroCarousel(){
  const wrap = document.getElementById('starHeroCarousel');
  const dots = document.getElementById('starHeroDots');
  if(!wrap) return;

  const items = (getStarProducts() || []).slice(0,8);
  __STAR_ITEMS__ = items;
  __STAR_ACTIVE_IDX__ = 0;

  wrap.innerHTML = '';
  if(dots) dots.innerHTML = '';

  if(items.length === 0){
    wrap.innerHTML = `<div style="padding:16px 6px;color:rgba(31,41,55,0.65);font-weight:800;">尚無可顯示商品</div>`;
    updateStarDockBadge(0);
    try{ updateStarHeroSubtitleByIdx(0); }catch(e){}
    return;
  }

  updateStarDockBadge(items.length);

  items.forEach((p, idx)=>{
    const div = document.createElement('div');
    div.className = 'sh-item';
    div.dataset.idx = String(idx);

    const deal = calcStarDeal(p);
    const base = Number(p && p.price || 0);
    let line = '';
    if(deal && deal.minPrice){
      if(base > 0 && deal.ratio && deal.ratio < 0.999){
        line = `最低${Number(deal.minPrice).toLocaleString('zh-TW')}元／${String(deal.foldText||'').replace(/[<>]/g,'')}`;
      }else{
        line = `售價${Number(deal.minPrice).toLocaleString('zh-TW')}元`;
      }
    }else if(base > 0){
      line = `售價${Number(base).toLocaleString('zh-TW')}元`;
    }

    const img = (p.photo && String(p.photo).trim().length>5) ? String(p.photo) : '';
    div.innerHTML = `
      ${img ? `<img class="sh-img" src="${img}" loading="lazy" onerror="this.style.display='none'">`
            : `<div class="sh-img" style="display:flex;align-items:center;justify-content:center;color:rgba(0,0,0,0.35);font-weight:900;">無圖片</div>`}
      <div class="sh-meta">
        <div class="sh-amt">${String(line||'').replace(/[<>]/g,'')}</div>
        <div class="sh-name">${String(p.name||'').replace(/[<>]/g,'')}</div>
      </div>
    `;

    div.onclick = (ev)=>{
      ev.preventDefault(); ev.stopPropagation();
      try{
        div.animate([{transform:'scale(1)'},{transform:'scale(0.975)'},{transform:'scale(1)'}], {duration: 190, easing:'cubic-bezier(.2,.85,.2,1)'});
      }catch(e){}
      __STAR_PENDING_NAV__ = String(p.code||'').trim();
      dismissStarHero('nav');
    };

    wrap.appendChild(div);

    if(dots){
      const d = document.createElement('span');
      d.className = 'sh-dot' + (idx===0 ? ' active' : '');
      d.dataset.idx = String(idx);
      d.onclick = (ev)=>{
        ev.preventDefault(); ev.stopPropagation();
        try{
          const target = wrap.querySelector(`.sh-item[data-idx="${idx}"]`);
          if(target){
            const left = target.offsetLeft - (wrap.clientWidth - target.clientWidth)/2;
            wrap.scrollTo({ left: Math.max(0, left), behavior:'smooth' });
          }
        }catch(e){}
      };
      dots.appendChild(d);
    }
  });

  const updateDot = ()=>{
    if(!dots) return;
    const center = wrap.scrollLeft + wrap.clientWidth*0.5;
    let best = 0, bestDist = Infinity;
    wrap.querySelectorAll('.sh-item').forEach((el, i)=>{
      const x = el.offsetLeft + el.clientWidth/2;
      const d = Math.abs(x - center);
      if(d < bestDist){ bestDist = d; best = i; }
    });
    dots.querySelectorAll('.sh-dot').forEach((el,i)=>{
      el.classList.toggle('active', i===best);
    });
    try{ updateStarHeroSubtitleByIdx(best); }catch(e){}
  };

  const snapToNearest = ()=>{
    const els = Array.from(wrap.querySelectorAll('.sh-item'));
    if(els.length === 0) return;
    const center = wrap.scrollLeft + wrap.clientWidth*0.5;
    let bestEl = els[0], bestDist = Infinity;
    els.forEach(el=>{
      const x = el.offsetLeft + el.clientWidth/2;
      const d = Math.abs(x - center);
      if(d < bestDist){ bestDist = d; bestEl = el; }
    });
    try{ const left = bestEl.offsetLeft - (wrap.clientWidth - bestEl.clientWidth)/2;
    wrap.scrollTo({ left: Math.max(0, left), behavior:'smooth' }); }catch(e){}
  };

  try{
    if(wrap.__shScrollHandler){ wrap.removeEventListener('scroll', wrap.__shScrollHandler); }
  }catch(e){}
  wrap.__shScrollHandler = ()=>{
    try{ updateDot(); }catch(e){}
    try{ if(__STAR_SCROLL_TIMER__){ clearTimeout(__STAR_SCROLL_TIMER__); } }catch(e){}
    __STAR_SCROLL_TIMER__ = setTimeout(()=>{ try{ snapToNearest(); }catch(e){} }, 110);
  };
  wrap.addEventListener('scroll', wrap.__shScrollHandler, { passive:true });

  try{ updateDot(); }catch(e){}
}


function openStarHeroOverlay(isAuto=false){
  try{
    if(__STAR_CLOSING__) return;
    if(isAuto && starIsDismissed()) return;
    if(!Array.isArray(PRODUCTS) || PRODUCTS.length===0){
      showToast('商品資料讀取中…', 'info', 2000);
      return;
    }
    const overlay = document.getElementById('starHeroOverlay');
    if(!overlay) return;

    hardResetStarHeroOverlay();

    __starRebuildDOM();

    // Ensure inline hard-hide from previous close doesn't block re-open
    overlay.style.display = '';
    overlay.style.opacity = '';

    applyStarHeroCopy();
    buildStarHeroCarousel();

    overlay.classList.remove('fade-out');
    overlay.classList.add('show');
    overlay.setAttribute('aria-hidden','false');
    __STAR_OPEN__ = true;

    overlay.classList.remove('entering');
    void overlay.offsetWidth;
    overlay.classList.add('entering');
    setTimeout(()=>{ try{ overlay.classList.remove('entering'); }catch(e){} }, 720);

    overlay.onclick = (ev)=>{
      if(ev && ev.target === overlay){
        dismissStarHero('backdrop');
      }
    };

    const btn = document.getElementById('starHeroBrowseBtn');
    if(btn){
      btn.onclick = (ev)=>{
        ev.preventDefault(); ev.stopPropagation();
        dismissStarHero('browse');
      };
    }
  }catch(e){}
}

function hardResetStarHeroOverlay(){
  try{
    const overlay = document.getElementById('starHeroOverlay');
    if(!overlay) return;

    // stop any in-flight close watchdog
    try{ if(__STAR_CLOSE_WATCHDOG__){ clearTimeout(__STAR_CLOSE_WATCHDOG__); __STAR_CLOSE_WATCHDOG__ = null; } }catch(e){}

    // force a clean visual baseline
    overlay.style.pointerEvents = '';
    overlay.onclick = null;
    overlay.classList.remove('show','fade-out','entering');
    overlay.setAttribute('aria-hidden','true');
    // Hard-hide to guarantee backdrop is gone even if classes get stuck
    overlay.style.display = 'none';
    overlay.style.opacity = '';

    const card = overlay.querySelector('.star-hero-card');
    if(card){
      try{ card.getAnimations().forEach(a=>a.cancel()); }catch(e){}
      card.style.opacity = '';
      card.style.transform = '';
      card.style.filter = '';
    }

    const wrap = document.getElementById('starHeroCarousel');
    if(wrap){
      try{ wrap.getAnimations().forEach(a=>a.cancel()); }catch(e){}
      wrap.querySelectorAll('.sh-item').forEach(el=>{
        try{ el.getAnimations().forEach(a=>a.cancel()); }catch(e){}
        el.style.opacity = '';
        el.style.transform = '';
        el.style.filter = '';
      });
      // remove old scroll handler to avoid duplicates
      try{ if(wrap.__shScrollHandler) wrap.removeEventListener('scroll', wrap.__shScrollHandler); }catch(e){}
      wrap.__shScrollHandler = null;
    }

    // remove any leftover flying stars
    try{ document.querySelectorAll('.star-fly').forEach(el=>el.remove()); }catch(e){}

    const dockBtn = document.getElementById('starDockBtn');
    if(dockBtn) dockBtn.style.opacity = '';

    // if we were stuck in closing state, unlock it
    __STAR_CLOSING__ = false;
    __STAR_OPEN__ = false;
  }catch(e){}
}

function forceCloseStarHeroNow(){
  try{
    // Cancel close watchdog/timers
    try{ if(__STAR_CLOSE_WATCHDOG__){ clearTimeout(__STAR_CLOSE_WATCHDOG__); __STAR_CLOSE_WATCHDOG__ = null; } }catch(e){}
    try{ if(__STAR_SCROLL_TIMER__){ clearTimeout(__STAR_SCROLL_TIMER__); __STAR_SCROLL_TIMER__ = null; } }catch(e){}

    const overlay = document.getElementById('starHeroOverlay');
    if(!overlay) return;

    // Cancel animations + reset card
    const card = overlay.querySelector('.star-hero-card');
    if(card){
      try{ card.getAnimations().forEach(a=>a.cancel()); }catch(e){}
      card.style.opacity = '';
      card.style.transform = '';
      card.style.filter = '';
    }

    const wrap = document.getElementById('starHeroCarousel');
    if(wrap){
      try{ wrap.getAnimations().forEach(a=>a.cancel()); }catch(e){}
      try{ if(wrap.__shScrollHandler) wrap.removeEventListener('scroll', wrap.__shScrollHandler); }catch(e){}
      wrap.__shScrollHandler = null;
    }

    // Remove flying stars
    try{ document.querySelectorAll('.star-fly').forEach(el=>el.remove()); }catch(e){}

    // Hard hide overlay to kill backdrop-filter residue
    overlay.classList.remove('show','fade-out','entering');
    overlay.setAttribute('aria-hidden','true');
    overlay.style.pointerEvents = '';
    overlay.onclick = null;
    overlay.style.display = 'none';
    overlay.style.opacity = '';

    // Ensure dock is visible
    const dockBtn = document.getElementById('starDockBtn');
    if(dockBtn){
      dockBtn.style.opacity = '1';
      dockBtn.style.visibility = 'visible';
    }

    __STAR_OPEN__ = false;
    __STAR_CLOSING__ = false;
    __STAR_REOPEN_PENDING__ = false;
  }catch(e){}
}



function _finalizeStarHeroClose(){
  try{ if(__STAR_CLOSE_WATCHDOG__){ clearTimeout(__STAR_CLOSE_WATCHDOG__); __STAR_CLOSE_WATCHDOG__ = null; } }catch(e){}

  try{
    const overlay = document.getElementById('starHeroOverlay');
    if(overlay){
      overlay.classList.remove('show','fade-out','entering');
      overlay.setAttribute('aria-hidden','true');
      overlay.style.pointerEvents='';
      overlay.onclick = null;
      // Hard-hide to prevent any backdrop-filter residue
      overlay.style.display = 'none';
      overlay.style.opacity = '';
    }
  }catch(e){}

  try{ document.querySelectorAll('.star-fly').forEach(el=>el.remove()); }catch(e){}

  __STAR_OPEN__ = false;
  __STAR_CLOSING__ = false;

  // Ensure dock icon is visible (fix: opacity stuck at 0)
  try{
    const dockBtn = document.getElementById('starDockBtn');
    if(dockBtn){
      dockBtn.style.opacity = '1';
      dockBtn.style.visibility = 'visible';
    }
  }catch(e){}

  try{ showStarDock(true); }catch(e){}
  try{ setStarDismissed(); }catch(e){}

  // If user clicked the star while we were closing, reopen smoothly
  if(__STAR_REOPEN_PENDING__){
    __STAR_REOPEN_PENDING__ = false;
    setTimeout(()=>{ try{ openStarHeroOverlay(false); }catch(e){} }, 80);
    return;
  }

  // Post-close navigation
  if(__STAR_PENDING_NAV__){
    const code = __STAR_PENDING_NAV__;
    __STAR_PENDING_NAV__ = null;
    try{ jumpToProductByCode(String(code||'')); }catch(e){}
  }
}


function dismissStarHero(reason){
  try{
    const overlay = document.getElementById('starHeroOverlay');
    if(!overlay) return;
    if(__STAR_CLOSING__) return;
    if(!overlay.classList.contains('show')) return;

    __STAR_CLOSING__ = true;

    const card = overlay.querySelector('.star-hero-card');
    if(card){
      try{
        card.getAnimations().forEach(a=>a.cancel());
        card.animate([
          { transform:'translateY(0) scale(1)', opacity:1, filter:'blur(0px)' },
          { transform:'translateY(-8px) scale(0.985)', opacity:0.0, filter:'blur(0.4px)' }
        ], { duration: 260, easing:'cubic-bezier(.2,.85,.25,1)', fill:'forwards' });
      }catch(e){}
    }

    overlay.classList.add('fade-out');
    overlay.style.pointerEvents = 'none';

    const r = card ? card.getBoundingClientRect() : null;

    const dockBtn = document.getElementById('starDockBtn');
    let dr = null;
    if(dockBtn){
      dockBtn.classList.remove('hidden');
      dockBtn.style.opacity = '0';
      dr = dockBtn.getBoundingClientRect();
    }
    const slot = document.getElementById('systemAnnouncementSlot');
    const sr = slot ? slot.getBoundingClientRect() : null;

    const size = 46;
    const sx = r ? (r.left + r.width/2 - size/2) : 18;
    const sy = r ? (r.top + r.height/2 - size/2) : 80;

    const ex = dr ? (dr.left + dr.width/2 - size/2) : (sr ? (sr.left + 18) : 18);
    const ey = dr ? (dr.top  + dr.height/2 - size/2) : (sr ? (sr.top + 14) : 90);

    const dx = ex - sx;
    const dy = ey - sy;

    const fly = document.createElement('div');
    fly.className = 'star-fly';
    fly.innerHTML = `<span class="material-icons-round">star</span>`;
    fly.style.left = sx + 'px';
    fly.style.top  = sy + 'px';
    document.body.appendChild(fly);

    const midX = dx * 0.55;
    const midY = dy * 0.55 - 64;

    let anim;
    try{
      anim = fly.animate([
        { transform:`translate(0px, 0px) scale(1.06) rotate(0deg)`, opacity:0.15 },
        { transform:`translate(${midX}px, ${midY}px) scale(0.90) rotate(14deg)`, opacity:1.0 },
        { transform:`translate(${dx}px, ${dy}px) scale(0.62) rotate(26deg)`, opacity:1.0 }
      ], { duration: 740, easing:'cubic-bezier(.22,.86,.24,1)', fill:'forwards' });
    }catch(e){
      fly.style.transform = `translate(${dx}px, ${dy}px) scale(0.62)`;
    }

    let _starFinishDone = false;

    const finish = ()=>{
      if(_starFinishDone) return;
      _starFinishDone = true;
      try{ _finalizeStarHeroClose(); }catch(e){
        try{ __STAR_OPEN__ = false; __STAR_CLOSING__ = false; }catch(ex){}
      }
    };

    // Watchdog: if animation promise never resolves (rare), force-cleanup to avoid blur residue.
    try{ if(__STAR_CLOSE_WATCHDOG__){ clearTimeout(__STAR_CLOSE_WATCHDOG__); } }catch(e){}
    __STAR_CLOSE_WATCHDOG__ = setTimeout(()=>{
      try{
        const ov = document.getElementById('starHeroOverlay');
        if(__STAR_CLOSING__) finish();
      }catch(e){}
    }, 1200);

    // Safety net: always finalize close after fixed time (prevents stuck blur-only overlay)
    try{ setTimeout(()=>{ finish(); }, 820); }catch(e){}




    if(anim && anim.finished){
      anim.finished.then(()=>{ finish(); }).catch(()=>{ finish(); });
    }else{
      setTimeout(()=>{ finish(); }, 780);
    }
  }catch(e){
    try{ __STAR_OPEN__ = false; __STAR_CLOSING__ = false; }catch(ex){}
  }
}


function showStarDock(show){
  try{
    const btn = document.getElementById('starDockBtn');
    if(!btn) return;

    try{ if(__STAR_ATT_TIMER__){ clearTimeout(__STAR_ATT_TIMER__); __STAR_ATT_TIMER__ = null; } }catch(e){}

    if(show){
      btn.classList.remove('hidden');
      // Fix: button could be left at opacity:0 (clickable but invisible)
      btn.style.opacity = '1';
      btn.style.visibility = 'visible';
      btn.classList.remove('attn');
      __STAR_ATT_TIMER__ = setTimeout(()=>{ 
        try{ if(!__STAR_OPEN__ && !__STAR_CLOSING__) btn.classList.add('attn'); }catch(e){} 
      }, 1200);
      btn.onclick = (ev)=>{ 
        ev.preventDefault(); ev.stopPropagation(); 
        // Always hard-reset before opening (prevents "blur only" stuck state after nav)
        try{ forceCloseStarHeroNow(); }catch(e){}
        openStarHeroOverlay(false); 
      };
    }else{
      btn.classList.add('hidden');
      btn.classList.remove('attn');
    }
  }catch(e){}
}

function updateStarDockBadge(n){
  try{
    const b = document.getElementById('starDockBadge');
    if(!b) return;
    const v = Math.max(0, Number(n||0));
    if(v > 0){
      b.textContent = String(v);
      b.style.display = 'flex';
    }else{
      b.style.display = 'none';
    }
  }catch(e){}
}

function initStarHero(){
  try{
    // If previously dismissed, show dock immediately
    if(starIsDismissed()){
      showStarDock(true);
    }
    // If pending auto show requested earlier (e.g., user clicked Start before boot ready)
    if(__STAR_AUTO_PENDING__){
      __STAR_AUTO_PENDING__ = false;
      openStarHeroOverlay(true);
    }
  }catch(e){}
}
function requestStarHeroAutoShow(){
  try{
    // if already open or dismissed, just ensure dock exists
    if(starIsDismissed()){
      try{ showStarDock(true); }catch(e){}
      return;
    }
    // If app not ready yet, queue
    if(!(window.__APP_READY__===true)){
      __STAR_AUTO_PENDING__ = true;
      return;
    }
    openStarHeroOverlay(true);
  }catch(e){}
}
function applyNavBreathe(el, source){
  try{
    if(!el) return;
    let rgb = '255,143,0';
    if(source === 'star') rgb = '255,193,7';
    if(source === 'rank') rgb = '216,27,96';
    el.style.setProperty('--nav-breathe-rgb', rgb);

    // restart animation reliably
    try{ el.classList.remove('nav-breathe'); }catch(e){}
    // force reflow
    void el.offsetHeight;
    el.classList.add('nav-breathe');

    try{ if(el.__navBreatheTimer) clearTimeout(el.__navBreatheTimer); }catch(e){}
    el.__navBreatheTimer = setTimeout(()=>{
      try{ el.classList.remove('nav-breathe'); }catch(e){}
    }, 6800);
  }catch(e){}
}

function jumpToProductByCode(code){
  try{
    const c = String(code||'').trim();
    if(!c) return;
    const p = (Array.isArray(PRODUCTS) ? PRODUCTS.find(x => x && String(x.code||'').trim()===c) : null);
    if(!p) return;
    const el = document.getElementById(`p-${p._id}`);
    if(el){
      el.scrollIntoView({behavior:'smooth', block:'start'});
      applyNavBreathe(el, 'star');
      const _tpl = uiGet('star|nav_toast', '已帶你到主打商品：{name} ✨');
      const _msg = _formatStarSubtitle(_tpl, p.name || p.product_name || p.name_zh || '');
      showToast(_msg, 'info', 1600);
    }
  }catch(e){}
}

// Determine tier badge kind for a category (order discount vs multi-tier)
function getTierBadgeInfoByCategory(cat){
  try{
    const c = String(cat||'');
    if(!c || !RULES || !Array.isArray(RULES.tiers)) return null;
    const matches = RULES.tiers.filter(t => t && isFinite(t.pct) && t.pct > 0 && t.zone && c.includes(t.zone));
    if(matches.length === 0) return null;
    // choose the most specific zone (longest match)
    const zones = [...new Set(matches.map(m => String(m.zone)))].sort((a,b)=>b.length-a.length);
    const zone = zones[0];
    const rules = RULES.tiers.filter(t => String(t.zone)===zone && isFinite(t.pct) && t.pct>0).sort((a,b)=>Number(a.min)-Number(b.min));
    if(rules.length === 1 && Number(rules[0].min) <= 1) return { kind:'order', zone, rules };
    return { kind:'tier', zone, rules };
  }catch(e){ return null; }
}


function buildTierHintText(info){
  if(!info || !Array.isArray(info.rules) || info.rules.length===0) return '';
  const orderLabel = getBadgeName('order_discount','訂單折扣');
  const tierLabel  = getBadgeName('tier','多件優惠');
  if(info.kind === 'order'){
    const zhe = fmtZheFromPctOff(info.rules[0].pct);
    return zhe ? `${orderLabel}：${zhe}` : `${orderLabel}`;
  }
  const parts = info.rules.map(r => {
    const min = Number(r.min)||1;
    const zhe = fmtZheFromPctOff(r.pct);
    return `滿${min}件 ${zhe || ''}`.trim();
  });
  return `${tierLabel}：${parts.join('、')}`;
}


function animateFly(startEl) {
  const card = startEl.closest('.p-card') || startEl.closest('.r-card');
  if (!card) return;
  const rect = startEl.getBoundingClientRect();
  const target = document.querySelector('.fb-btn').getBoundingClientRect();
  const fly = document.createElement('img');
  
  let imgEl = card.querySelector('img.p-img') || card.querySelector('img.r-img');
  if(!imgEl) imgEl = card.querySelector('img');
  
  fly.src = imgEl ? imgEl.src : ''; 
  if(!fly.src) return;
  
  fly.className = 'flying-img';
  fly.style.transform = 'scale(1.2) rotate(0deg)';
  fly.style.top = rect.top + 'px';
  fly.style.left = rect.left + 'px';
  fly.style.opacity = '1';
  document.body.appendChild(fly);
  
  void fly.offsetWidth;

  setTimeout(() => {
    fly.style.top = (target.top + 10) + 'px'; 
    fly.style.left = (target.left + 20) + 'px';
    fly.style.transform = 'scale(0.1) rotate(360deg)'; 
    fly.style.opacity = '0.5';
  }, 10); 

  setTimeout(() => fly.remove(), 1000); 
}

function animateGiftFly(giftName) {
  const target = document.querySelector('.fb-btn').getBoundingClientRect();
  const fly = document.createElement('img');
  
  let images = GIFT_MAP.get(giftName) || [];
  let imgSrc = images.length > 0 ? images[0] : '';

  if(imgSrc) {
      fly.src = imgSrc;
  } else {
      const canvas = document.createElement('canvas');
      canvas.width = 60; canvas.height = 60;
      const ctx = canvas.getContext('2d');
      ctx.font = '40px serif';
      ctx.fillText('🎁', 10, 45);
      fly.src = canvas.toDataURL();
  }

  fly.className = 'flying-gift';
  const startTop = (window.innerHeight / 2) - 30;
  const startLeft = (window.innerWidth / 2) - 30;
  
  fly.style.top = startTop + 'px';
  fly.style.left = startLeft + 'px';
  fly.style.transform = 'scale(0)'; 
  document.body.appendChild(fly);

  setTimeout(() => {
      fly.style.transition = 'transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275)';
      fly.style.transform = 'scale(1.5)';
  }, 10);

  setTimeout(() => {
      fly.style.transition = 'all 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55)';
      fly.style.top = target.top + 'px';
      fly.style.left = target.left + 'px';
      fly.style.transform = 'scale(0.2)';
      fly.style.opacity = '0.5';
  }, 800);

  setTimeout(() => fly.remove(), 1600);
}

function jumpToProduct(pid, source){
  const searchInp = document.getElementById("searchInp");
  if(searchInp.value) {
    searchInp.value = "";
    document.getElementById("clearSearch").style.display = 'none'; 
    renderList(); 
  }
  setTimeout(() => {
    const el = document.getElementById(`p-${pid}`);
    if(el) {
      el.scrollIntoView({ behavior: "smooth", block: "center" });
      if(source === 'rank'){
        applyNavBreathe(el, 'rank');
      }else{
        el.classList.add("flash-highlight");
        setTimeout(()=>el.classList.remove("flash-highlight"), 1300);
      }
    }
  }, 100);
}

function jumpToGroupByCode(groupCode, source){
  const gc = String(groupCode||'').trim();
  if(!gc) return false;
  const g = PRODUCT_MAP.get(gc);
  if(g && !g.is_hidden){
    jumpToProduct(g._id, source);
    return true;
  }
  try{ showPromoHint(`找不到商品組：${gc}`); }catch(e){}
  return false;
}
function handleRankingClick(p){
  try{
    if(p && p.is_hidden && p.group_code){
      if(jumpToGroupByCode(p.group_code, 'rank')) return;
    }
  }catch(e){}
  jumpToProduct(p._id, 'rank');
}


// FIX: Improved Highlight Logic
function highlightText(text, query) {
  if (!query) return text;
  // Escape regex chars to be safe
  const safeQuery = query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
  const regex = new RegExp(`(${safeQuery})`, 'gi');
  return text.replace(regex, '<span class="highlight">$1</span>');
}

async function initApp() {
  try{ setBootConfigState('loading'); }catch(e){}

  try {
    // V2 Sprint1: core datasets fetched in parallel (faster + consistent)
const [pText, rText, rankText, gText] = await Promise.all([
  fetchCsvTextSmart(SHEET_P, "商品資料"),
  fetchCsvTextSmart(SHEET_R, "優惠規則"),
  fetchCsvTextSmart(SHEET_RANK, "熱銷榜", { optional: true }),
  fetchCsvTextSmart(SHEET_GIFTS_URL, "贈品圖片", { optional: true })
]);

const pData = Papa.parse(pText, { header: true, skipEmptyLines: true }).data;
    PRODUCTS = pData.map((row, i) => {
      const pick = (k) => {
        const kk = String(k||'').replace(/^\uFEFF/,'').trim().toLowerCase();
        const key = Object.keys(row).find(key => String(key||'').replace(/^\uFEFF/,'').trim().toLowerCase() === kk);
        return (key ? row[key] : "") || "";
      };
      const code = String(pick("product_code")||"").trim();
      const name = String(pick("product_name")||"").trim();
      if(!code || !name) return null;
      const isGift = String(pick("is_gift")||"").toLowerCase();

const _bool = (v) => {
  const s = String(v||'').trim().toLowerCase();
  return (s === 'true' || s === '1' || s === 'y' || s === 'yes' || s === 't');
};
const isNew = _bool(pick("is_new"));
const isHidden = _bool(pick("is_hidden"));
const groupCode = String(pick("group_code")||"").trim();


      let bundle = [];
      for(let k=1; k<=4; k++) {
        let sn = String(pick(`spec_${k}`)||"").trim();
        let sq = Number(pick(`spec_${k}_qty`)||1);
        if(sn) {
          // specs sometimes come as: "375358-12 VINATA緊緻活膚膠囊"
          sn = sn.replace(/^([A-Za-z0-9\-\.]+)\s+/, '').trim();
          bundle.push({ name: sn, qty: sq });
        }
      }

      // V24.0+: gifts are NOT sellable items, but still keep full metadata for gifts-content/statistics
      if(isGift === 'true' || isGift.includes('是')) {
        PRODUCT_MAP.set(code, { name, price: 0, bundle });
        return null;
      }
      const p = {
        _id: i, code: code, name: name, category: pick("category").trim(),
        price: Number((pick("list_price")||"0").replace(/,/g,'')), spec: pick("spec"), photo: pick("photos url"), bundle: bundle,
        is_new: isNew, is_hidden: isHidden, group_code: groupCode
      };
      if(p.code) PRODUCT_MAP.set(p.code, p);
      
      // Gift Map Image (single source): use only "Photos url" to align with site-wide image logic
      if(p.photo && p.photo.length > 5) {
          GIFT_MAP.set(p.code, [p.photo]);
      }
      return p;
    }).filter(x => x);

    if(!PRODUCTS || PRODUCTS.length === 0) {
      throw new Error("商品資料為空（可能是連線被擋 / 代理回傳異常）");
    }

    const rData = Papa.parse(rText, { header: true, skipEmptyLines: true }).data;
    RULES = { tiers: [], bogo: [], spend: [], bundle: [], series_gift: [], flat_price: [], eligibility: [], uiNotes: {}, uiAccent: {}, uiCatStyle: {}, uiCfg: {}, freeShipThreshold: null };
    rData.forEach(row => {
      const pick = (k) => {
        const kk = String(k||'').replace(/^\uFEFF/,'').trim().toLowerCase();
        const key = Object.keys(row).find(key => String(key||'').replace(/^\uFEFF/,'').trim().toLowerCase() === kk);
        return (key ? row[key] : "") || "";
      };
      const type = pick("rule_type").toLowerCase();
      if(type.includes("tier")) RULES.tiers.push({ zone: pick("zone").trim(), min: Number(pick("min_qty")), pct: Number(pick("percent_off")) });
      else if(type.includes("bogo")) RULES.bogo.push({ code: pick("product_code"), buy: Number(pick("buy")), get: Number(pick("get")) });
      else if(type.includes("flat_price")) {
        const zone = pick("zone").trim();
        const code = String(pick("product_code")||"").trim();
        const unit = Number(pick("unit_price")||pick("charge")||0);
        if(zone && code && !Number.isNaN(unit)) RULES.flat_price.push({ zone, code, unit });
      }
      else if(type.includes("eligibility")) {
        const zone = pick("zone").trim();
        const requires = String(pick("requires_any_zone_in")||"").trim();
        const minQty = Number(pick("requires_min_qty")||pick("requires_min_qty ")||pick("requires_min_qty\t")||1);
        if(zone) RULES.eligibility.push({ zone, requires, minQty: (Number.isNaN(minQty) ? 1 : minQty) });
      }
      else if(type.includes("series_gift")) {
        const mRaw = String(pick("multiples") || "").trim().toUpperCase();
        const mult = (mRaw === "TRUE" || mRaw === "1" || mRaw === "YES");
        RULES.series_gift.push({ scope: pick("threshold_scope"), prefix: pick("zone_prefix"), amt: Number(pick("threshold_amount")), gift: pick("gift_code"), qty: Number(pick("gift_qty")), mult });
      }
      else if(type.includes("spend")) {
        const mRaw = String(pick("multiples") || "").trim().toUpperCase();
        const mult = (mRaw === "TRUE" || mRaw === "1" || mRaw === "YES");
        RULES.spend.push({ scope: pick("threshold_scope"), prefix: pick("zone_prefix"), amt: Number(pick("threshold_amount")), gift: pick("gift_code"), qty: Number(pick("gift_qty")), mult });
      }

      else if(type.includes("shipping_threshold")) {
        const rawAmt = String(pick("threshold_amount")||"").trim().replace(/,/g,'');
        const amt = Number(rawAmt);
        if(isFinite(amt) && amt > 0) RULES.freeShipThreshold = amt;
      }
      
else if(type.includes("ui_accent")) {
  const zone = String(pick("zone")||"").trim();
  const c1 = String(pick("ui_accent")||"").trim();
  const c2 = String(pick("ui_accent2")||"").trim();
  if(zone && (c1 || c2)) RULES.uiAccent[zone] = { c1, c2 };
}
else if(type.includes("ui_cat_style")) {
  // zone format: cat|<分類標題>
  const zone = String(pick("zone")||"").trim();
  const mm = zone.match(/^cat\|(.+)$/);
  const catKey = mm ? String(mm[1]||'').trim() : zone.replace(/^cat\|/,'').trim();
  const c1 = String(pick("ui_accent")||"").trim();
  const c2 = String(pick("ui_accent2")||"").trim();
  if(catKey && (c1 || c2)) RULES.uiCatStyle[catKey] = { c1, c2 };
}
else if(type.includes("ui_config")) {
  const key = String(pick("zone")||"").trim();
  const txt = String(pick("ui_text")||"").trim();
  const rawAmt = String(pick("threshold_amount")||"").trim().replace(/,/g,'');
  const amt = Number(rawAmt);
  if(key){
    RULES.uiCfg[key] = (txt ? txt : (isFinite(amt) ? amt : ""));
  }
}
else if(type.includes("ui_note")) {
        const zone = String(pick("zone")||"").trim();
        const txt = String(pick("ui_text")||"").trim();
        if(zone && txt) RULES.uiNotes[zone] = txt;
      }

            else if(type.includes("bundle")) RULES.bundle.push({ code: pick("product_code"), price: Number(pick("unit_price")) });
    });
if (gText) {
  const gData = Papa.parse(gText, { header: true, skipEmptyLines: true }).data;
  gData.forEach(row => {
      const pick = (k) => {
        const kk = String(k||'').replace(/^\uFEFF/,'').trim().toLowerCase();
        const key = Object.keys(row).find(key => String(key||'').replace(/^\uFEFF/,'').trim().toLowerCase() === kk);
        return (key ? row[key] : "") || "";
      };
      const code = pick("product_code");
      const url = pick("photos url");
      if(code && url) {
          let imgs = [url];
          GIFT_MAP.set(code, imgs);
      }
  });
}

if (rankText) {
  processRankings(rankText);
}


    try{ applyUiThemeVars(); }catch(e){}

    renderUI();
    window.__APP_READY__=true;
    renderSystemAnnouncement();
    try{ initStarHero(); }catch(e){}

// V2 Sprint1: staged rendering (reduce perceived waiting)
// Do NOT block the whole page on config fetch.
const loaderEl = document.getElementById("loader");
if(loaderEl) {
  loaderEl.style.opacity = 0;
  setTimeout(()=>{ try{ loaderEl.remove(); } catch(e){} }, 300);
}

// Let the browser paint the UI ASAP
await new Promise(r => requestAnimationFrame(r));

// Restore cart as soon as UI exists
loadState();

// Load dropdown config (departments / payments) in background.
// Ordering stays strict: config not ready => cannot submit.
loadConfigOptions().catch(()=>{});
} catch(e) { alert("連線異常，請稍後重試。\n" + e.message); }
}

function processRankings(csvText) {
  RANKINGS = { all:[], health:[], beauty:[], cleaning:[] };
  const rows = Papa.parse(csvText, { header: false }).data;
  let rawList = [];
  let processedCodes = new Set();

  rows.forEach(r => {
    if(r.length < 6) return;
    const code = r[0];
    let qtyStr = r[5] || "0";
    let qty = parseFloat(qtyStr.toString().replace(/,/g, ''));
    if(!qty || qty <= 0) {
        qtyStr = r[4] || "0";
        qty = parseFloat(qtyStr.toString().replace(/,/g, ''));
    }

    if(PRODUCT_MAP.has(code) && qty > 0 && !processedCodes.has(code)) {
      const p = PRODUCT_MAP.get(code);
      rawList.push({ ...p, sold: qty });
      processedCodes.add(code);
    }
  });

  rawList.sort((a,b) => b.sold - a.sold);
  RANKINGS.all = rawList.slice(0, 10);
  RANKINGS.health = rawList.filter(i => getRankingCategory(i.name, i.category) === 'health').slice(0, 10);
  RANKINGS.beauty = rawList.filter(i => getRankingCategory(i.name, i.category) === 'beauty').slice(0, 10);
  RANKINGS.cleaning = rawList.filter(i => getRankingCategory(i.name, i.category) === 'cleaning').slice(0, 10);

  if(RANKINGS.all.length > 0) {
    document.getElementById("ranking-section").style.display = "block";
    renderRanking("all");
  }
}

function getRankingCategory(name, originalCat) {
  const n = String(name||'').toLowerCase();
  const c = String(originalCat||'').toLowerCase();

  // 清潔：避免用單字「洗」造成誤判，改採顯性關鍵字
  const cleaningKeywords = ["易洗樂","洗潔","洗衣","洗碗","菜瓜布","皂","洗髮","沐浴","洗面","洗手"];
  if (c.includes("清潔") || cleaningKeywords.some(kw => n.includes(String(kw).toLowerCase()))) return "cleaning";

  // 美容：移除洗髮/沐浴，新增護髮/護手
  const beautyKeywords = ["vinata","面膜","精華","霜","露","乳液","潔顏","卸妝","美白","保濕","抗皺","潤","透","亮","膚","痘","護髮","護手"];
  if (c.includes("美容") || c.includes("保養") || beautyKeywords.some(kw => n.includes(String(kw).toLowerCase()))) return "beauty";

  const healthKeywords = ["安可健","s11","益生菌","納豆","紅麴","魚油","鈣","葡萄糖胺","葉黃素","膠囊","錠","酵素"];
  if (c.includes("保健") || c.includes("健康") || healthKeywords.some(kw => n.includes(String(kw).toLowerCase()))) return "health";

  return "other";
}

function renderRanking(type) {
  const list = document.getElementById("rankList");
  list.innerHTML = "";
  const data = RANKINGS[type] || [];
  data.forEach((p, idx) => {
    const card = document.createElement("div");
    card.className = "r-card";
    card.dataset.rank = idx + 1; 
    card.onclick = () => handleRankingClick(p);
    let imgHtml = `<div class="p-no-img" style="height:100%;justify-content:center;font-size:10px">無圖</div>`;
    if(p.photo && p.photo.length > 5) imgHtml = `<img src="${p.photo}" class="r-img" loading="lazy">`;
    card.innerHTML = `<div class="r-img-wrap"><div class="r-badge">${idx + 1}</div><div class="r-sold-tag">售${p.sold.toLocaleString()}件</div>${imgHtml}</div><div class="r-name">${p.name}</div>`;
    list.appendChild(card);
  });
}

function switchRank(type) {
  document.querySelectorAll(".r-tab").forEach(el => el.classList.remove("active"));
  event.target.classList.add("active");
  renderRanking(type);
}

function renderUI() {
  const nav = document.getElementById("catNav");
  let rawCats = [...new Set(PRODUCTS.map(p => p.category))].filter(Boolean);
  const cleaningBase = "清潔用品";
  const hasCleaning = rawCats.some(c => c.includes(cleaningBase));
  if(hasCleaning) {
      rawCats = rawCats.filter(c => !c.includes(cleaningBase));
      rawCats.push("清潔-洗潔", "清潔-洗衣", "清潔-皂"); 
  }
  
  const allPill = document.createElement("div");
  allPill.className = "cat-pill active";
  allPill.innerText = "熱銷排行"; 
  allPill.onclick = () => scrollToSection('cat-all');
  nav.appendChild(allPill);

  rawCats.forEach(c => {
    let displayName = c.includes("清潔-") ? c : c.split(/[\s_]/)[0];
    const pill = document.createElement("div");
    pill.className = "cat-pill";
    pill.innerText = displayName;
    pill.dataset.target = `cat-${c.replace(/\s+/g, '-')}`;
    pill.onclick = () => scrollToSection(pill.dataset.target);
    nav.appendChild(pill);
  });
  
  categories = rawCats; 
  renderList();
  setupScrollSpy();
}

function __mainScrollOffset(){
  try{
    const header = document.getElementById('header');
    const headerH = header ? header.getBoundingClientRect().height : 110;
    // Align with Promo Map jump offset (less "low" than scroll-margin-top)
    const offset = Math.min(140, Math.max(78, (headerH || 110) - 18));
    return offset;
  }catch(e){ return 110; }
}

function __mainScrollToId(id, behavior){
  try{
    const el = document.getElementById(id);
    if(!el) return false;
    const offset = __mainScrollOffset();
    const y = el.getBoundingClientRect().top + window.pageYOffset - offset;
    window.scrollTo({ top: Math.max(0, y), behavior: behavior || 'smooth' });
    return true;
  }catch(e){ return false; }
}

function scrollToSection(id) {
  const tid = String(id||'').trim();
  if(!tid){ return; }

  // Special: top
  if (tid === 'cat-all') {
    window.scrollTo({ top:0, behavior:'smooth' });
    return;
  }

  const go = () => {
    if(__mainScrollToId(tid, 'smooth')){
      // keep top pills state in sync
      try{
        document.querySelectorAll('.cat-pill').forEach(p => {
          p.classList.toggle('active', p.dataset.target === tid);
        });
        const activePill = document.querySelector('.cat-pill.active');
        if(activePill) activePill.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
      }catch(e){}

      // subtle flash on section title
      try{
        const sec = document.getElementById(tid);
        const title = sec ? sec.querySelector('.cat-section-title') : null;
        if(title){
          title.classList.add('cat-flash');
          setTimeout(()=>title.classList.remove('cat-flash'), 900);
        }
      }catch(e){}
    }
  };

  // If searching, clear and re-render, then jump
  try{
    const searchInp = document.getElementById('searchInp');
    if(searchInp && searchInp.value){
      searchInp.value = '';
      const clr = document.getElementById('clearSearch');
      if(clr) clr.style.display = 'none';
      renderList();
      setTimeout(go, 120);
      return;
    }
  }catch(e){}

  // Normal jump
  go();
}

function setupScrollSpy() {
  if (sectionObserver) sectionObserver.disconnect();
  const options = { root: null, rootMargin: '-135px 0px -70% 0px', threshold: 0 };
  sectionObserver = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        const id = entry.target.id;
        document.querySelectorAll(".cat-pill").forEach(pill => {
          pill.classList.toggle("active", pill.dataset.target === id || (id==='cat-all-wrapper' && pill.innerText==='熱銷排行'));
        });
        const activePill = document.querySelector(".cat-pill.active");
        if(activePill) activePill.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
      }
    });
  }, options);
  document.querySelectorAll('.cat-section').forEach(section => { sectionObserver.observe(section); });
}

function renderList() {
  const grid = document.getElementById("list");
  grid.innerHTML = "";
  const inp = document.getElementById("searchInp");
  const q = inp.value.toLowerCase().trim();
  
  document.getElementById("clearSearch").style.display = q.length > 0 ? 'block' : 'none';
  
  if (q) {
    if(sectionObserver) sectionObserver.disconnect();
    const filtered = PRODUCTS.filter(p => !p.is_hidden && (p.name.toLowerCase().includes(q) || p.code.toLowerCase().includes(q)));
    document.getElementById("empty-state").style.display = filtered.length === 0 ? "block" : "none";
    const container = document.createElement("div");
    container.className = "grid-layout";
    filtered.forEach(p => { container.appendChild(createProductCard(p, q)); });
    grid.appendChild(container);
  } else {
    document.getElementById("empty-state").style.display = "none";
    
    const topAnchor = document.createElement("div");
    topAnchor.id = "cat-all-wrapper";
    grid.appendChild(topAnchor);

    categories.forEach(cat => {
        const catProducts = PRODUCTS.filter(p => {
            if(p.is_hidden) return false;
            if (cat.includes("清潔-")) {
                if (!p.category.includes("清潔")) return false;
                if (cat === "清潔-洗潔" && !p.name.includes("洗潔")) return false;
                if (cat === "清潔-洗衣" && !p.name.includes("洗衣")) return false;
                if (cat === "清潔-皂" && !p.name.includes("皂")) return false;
                return true;
            } else { return p.category.includes(cat); }
        });
        if (catProducts.length > 0) {
            const secId = `cat-${cat.replace(/\s+/g, '-')}`;
            const section = document.createElement("div"); section.className = "cat-section"; section.id = secId;
            const title = document.createElement("div"); title.className = "cat-section-title";
            let displayName = cat.includes("清潔-") ? cat : cat.split(/[\s_]/)[0];
            title.innerText = displayName;
            section.appendChild(title);
            const gridContainer = document.createElement("div"); gridContainer.className = "grid-layout";
            catProducts.forEach(p => { gridContainer.appendChild(createProductCard(p, null)); });
            section.appendChild(gridContainer);
            grid.appendChild(section);
        }
    });
    setupScrollSpy();
  }
}


/* v2.5: Price Range Pill (theoretical tier range from pricing_strategy) */
function getTierDiscountRangeForProduct(p){
  try{
    if(!p || !p.price || !RULES || !Array.isArray(RULES.tiers)) return null;
    const matches = RULES.tiers.filter(t => t && !isNaN(t.pct) && t.pct > 0 && p.category && p.category.includes(t.zone));
    if(matches.length === 0) return null;
    const pcts = matches.map(x => Number(x.pct)).filter(x => isFinite(x));
    if(pcts.length === 0) return null;
    const minPct = Math.min(...pcts);
    const maxPct = Math.max(...pcts);
    if(!isFinite(minPct) || !isFinite(maxPct) || maxPct <= 0) return null;

    let low = Math.round(p.price * (1 - maxPct/100));
    let high = Math.round(p.price * (1 - minPct/100));
    if(!isFinite(low) || !isFinite(high)) return null;
    if(low > high){ const tmp = low; low = high; high = tmp; }
    if(low < 0) low = 0;
    if(high < 0) high = 0;
    return { low, high, minPct, maxPct };
  } catch(e){
    return null;
  }
}
function getTierRangeText(p){
  const r = getTierDiscountRangeForProduct(p);
  if(!r) return "";
  if(r.low === r.high) return `${r.low.toLocaleString()}`;
  return `${r.low.toLocaleString()}–${r.high.toLocaleString()}`;
}

function createProductCard(p, highlightQuery) {
    const inCart = CART.find(x => x._id === p._id && !x.bundleSelection);
    const qty = inCart ? inCart.qty : 0;

// UI configurable badge names
const L_addon = getBadgeName('addon','加價購');
const L_bogo  = getBadgeName('bogo','買一送一');
const L_bundleSel = getBadgeName('bundle_select','優惠組合');
const L_order = getBadgeName('order_discount','訂單折扣');
const L_tier  = getBadgeName('tier','多件優惠');

    let badges = "";
    if(p.category.includes("加價購")) badges += `<span class="badge bg-red promo-badge" data-promo="addon">${L_addon}</span>`;
    if(RULES.bogo.some(b => b.code === p.code)) badges += `<span class="badge bg-blue promo-badge" data-promo="bogo" data-code="${p.code}">${L_bogo}</span>`;
    if(p.name.includes("任選")) badges += `<span class="badge bg-gold promo-badge" data-promo="bundle_select">${L_bundleSel}</span>`;
    (function(){
    const info = getTierBadgeInfoByCategory(p.category);
    if(!info) return;
    if(info.kind === 'order') badges += `<span class="badge bg-purple promo-badge" data-promo="order_discount" data-zone="${String(info.zone).replace(/"/g,'&quot;')}">${L_order}</span>`;
    else badges += `<span class="badge bg-purple promo-badge" data-promo="tier" data-zone="${String(info.zone).replace(/"/g,'&quot;')}">${L_tier}</span>`;
  })();
    let actionBtn = "";
    if(p.bundle.length >= 2 && p.name.includes("任選")) {
      const hasSel = SELECTED_BUNDLE.has(p._id);
      actionBtn = `<div class="btn-bundle" onclick="openBundle(${p._id})">${hasSel ? "內容已選 ✓" : "選擇內容物"}</div>`;
    }
    let imgHtml = `<div class="p-no-img"><span class="material-icons-round" style="font-size:32px">image_not_supported</span>無圖片</div>`;
    if(p.photo && p.photo.length > 5) {
      imgHtml = `<img src="${p.photo}" class="p-img" onload="this.classList.add('loaded')" onerror="this.style.display='none';this.parentElement.innerHTML='<div class=\'p-no-img\'>暫無圖片</div>'">`;
    }
    
    // RESTORED HIGHLIGHT LOGIC
    let displayName = p.name;
    if (highlightQuery) { displayName = highlightText(p.name, highlightQuery); }
    
    const card = document.createElement("div"); card.className = "p-card"; card.id = `p-${p._id}`;
    const pricePack = (function(){
      let priceHtml = '';
      let pillHtml = '';
      if(String(p.category||"").includes("加價購")){
        const fr = getFlatPriceRule(p.code, p.category);
        const ap = (fr && fr.unit > 0) ? Number(fr.unit).toLocaleString() : "";
        priceHtml = '<span class="p-price strike">$' + p.price.toLocaleString() + '</span>';
        if(ap) pillHtml = '<span class="p-price-pill" data-promo="addon_price"><span class="pill-label">加購</span> <span class="pill-value">' + ap + '</span></span>';
        return { priceHtml, pillHtml };
      } else {
        // bundle (e.g., 美容超值組) show strike list + promo price
        const bundleRule = (RULES && Array.isArray(RULES.bundle)) ? RULES.bundle.find(r => r && r.code === p.code && isFinite(r.price) && r.price > 0) : null;
        if(bundleRule && isFinite(bundleRule.price) && bundleRule.price > 0) {
          const bp = Number(bundleRule.price).toLocaleString();
          priceHtml = '<span class="p-price strike">$' + p.price.toLocaleString() + '</span>';
          pillHtml = '<span class="p-price-pill" data-promo="bundle_price" data-code="' + p.code + '"><span class="pill-label">優惠</span> <span class="pill-value">' + bp + '</span></span>';
          return { priceHtml, pillHtml };
        }
        const t = getTierRangeText(p);
        priceHtml = '<span class="p-price">$' + p.price.toLocaleString() + '</span>';
        if(t) pillHtml = '<span class="p-price-pill" data-promo="tier_range" data-zone="' + (function(){ const _i = getTierBadgeInfoByCategory(p.category); return _i ? String(_i.zone||"").replace(/"/g,'&quot;') : ''; })() + '"><span class="pill-label">折後</span> <span class="pill-value">' + t + '</span></span>';
        return { priceHtml, pillHtml };
      }
    })();
        const codeChipHtml = (p.code && String(p.code).trim()) ? `<div class="p-code-chip">${escapeHtml(p.code)}</div>` : '';
    const pillRowHtml = pricePack.pillHtml ? `<div class="p-pill-row">${pricePack.pillHtml}</div>` : '';

const newBadgeLabel = (function(){
  try{ return escapeHtml(getBadgeName('new', 'NEW')); }catch(e){ return 'NEW'; }
})();
const newBadgeHtml = (p.is_new) ? `<div class="new-badge">${newBadgeLabel}</div>` : '';
    card.innerHTML = `<div class="p-img-box"><div class="badges">${badges}</div>${imgHtml}${newBadgeHtml}</div><div class="p-body">${codeChipHtml}<div><div class="p-title">${displayName}</div><div class="p-price-row">${pricePack.priceHtml}</div>${pillRowHtml}${actionBtn}<div class="p-buy-row no-pill"><div class="stepper"><div class="s-btn ${qty===0?'hidden':''}" onclick="window.updateQty(this, ${p._id}, -1)">－</div><div class="s-val ${qty===0?'hidden':''}">${qty}</div><div class="s-btn add" onclick="window.updateQty(this, ${p._id}, 1)">＋</div></div></div></div></div>`;
    return card;
}

window.openBundle = function(pid) {
  modalPid = pid;
  const p = PRODUCTS.find(x => x._id === pid);
  const grid = document.getElementById("mGrid");
  grid.innerHTML = "";
  tempBundleSelection = []; // RESET: Always start fresh
  updateModalUI();
  p.bundle.forEach((b, idx) => {
    const row = document.createElement("div");
    row.className = "m-row";
    row.dataset.idx = idx;
    row.innerHTML = `<div style="flex:1"><div class="m-name">${b.name}</div><div style="font-size:12px;color:#90a4ae">規格: ${b.qty}</div></div><div class="m-ctrl"><div class="m-btn-s minus">－</div><div class="m-val">0</div><div class="m-btn-s plus">＋</div></div>`;
    row.querySelector(".minus").onclick = () => modifyTemp(idx, -1);
    row.querySelector(".plus").onclick = () => modifyTemp(idx, 1);
    grid.appendChild(row);
  });
  updateModalCounts();
  document.getElementById("bundleModal").classList.add("open");
};

function modifyTemp(idx, delta) {
  if (delta > 0) {
    if (tempBundleSelection.length < 2) tempBundleSelection.push(idx);
  } else {
    const i = tempBundleSelection.indexOf(idx);
    if (i > -1) tempBundleSelection.splice(i, 1);
  }
  updateModalUI();
  updateModalCounts();
}

function updateModalUI() {
  document.getElementById("mCount").innerText = tempBundleSelection.length;
  const btn = document.getElementById("mConfirmBtn");
  if (tempBundleSelection.length === 2) {
    btn.classList.remove("disabled");
    btn.innerText = "確認選取";
  } else {
    btn.classList.add("disabled");
    btn.innerText = `還差 ${2 - tempBundleSelection.length} 件`;
  }
}

function updateModalCounts() {
  const rows = document.getElementById("mGrid").children;
  Array.from(rows).forEach(row => {
    const idx = parseInt(row.dataset.idx);
    const count = tempBundleSelection.filter(x => x === idx).length;
    row.querySelector(".m-val").innerText = count;
    if(count > 0) row.style.borderColor = "var(--primary)";
    else row.style.borderColor = "#eceff1";
  });
}

// V22.2: Confirm Bundle creates a NEW cart item
window.confirmBundle = function() {
  if (tempBundleSelection.length !== 2) return;
  
  const p = PRODUCTS.find(x => x._id === modalPid);
  if(!p) return;
  
  // Clone product to create new cart item
  const cartItem = { 
    ...p, 
    qty: 1, 
    bundleSelection: [...tempBundleSelection], // Store selection
    cartId: Date.now() + Math.random() // Unique ID
  };
  
  // Check if EXACT same bundle exists? No, user wants separate usually. 
  // Or if same, increment? Let's check.
  const existing = CART.find(x => x._id === modalPid && JSON.stringify(x.bundleSelection) === JSON.stringify(tempBundleSelection));
  
  if(existing) {
      existing.qty += 1;
  } else {
      CART.push(cartItem);
  }

  saveState(); 
  refreshCart(); 
  renderList(); // Update buttons state
  
  // Show toast
  const addedToast = showToast("已加入購物車");
  setTimeout(() => {
      const data = calcCart();
      checkNewGifts(data.gifts); 
  }, 800);
  
  // Show fab
  const fab = document.getElementById("float-bar");
  fab.classList.remove("show");
  void fab.offsetWidth; 
  if(CART.length > 0) fab.classList.add("show");

  closeBundle();
};

window.closeBundle = function() { document.getElementById("bundleModal").classList.remove("open"); };

window.clearCart = function() {
  if(confirm("確定要清空購物車嗎？")) { 
    CART = []; 
    SELECTED_BUNDLE.clear(); 
    achievedGifts = []; // Reset gifts memory
    saveState(); 
    refreshCart(); 
    renderList(); 
    closeCart(); 
    showToast("購物車已清空"); 
  }
};

// V24.0: In-Cart Feedback Update (Pulse & Celebrate)
window.updateCartItem = function(index, delta) {
    const item = CART[index];
    if(!item) return;
    
    // Feedback 1: Pulse Gift Icon
    const giftIcon = document.querySelector('.game-icon');
    if(giftIcon) {
        giftIcon.classList.remove('gift-pulse');
        void giftIcon.offsetWidth; 
        giftIcon.classList.add('gift-pulse');
    }

    item.qty += delta;
    if(item.qty <= 0) {
        CART.splice(index, 1);
    }
    
    // Enforce add-on eligibility after any cart change
    const removedAddon = enforceAddonEligibility();
    if(removedAddon > 0) {
        showToast("加價購商品已移除（未符合加購條件）", "warn");
    }

    saveState();
    const data = refreshCart(); // Refresh and get data
    
    // Feedback 2: Check for new gift unlock inside cart
    const currentGiftNames = data.gifts.map(g => g.name);
    const newUnlocks = currentGiftNames.filter(n => !achievedGifts.includes(n));
    if(newUnlocks.length > 0) {
        // Trigger Celebration in Cart
        if(giftIcon) {
            giftIcon.classList.add('gift-unlock-anim');
            setTimeout(()=>giftIcon.classList.remove('gift-unlock-anim'), 1000);
        }
        const msg = document.getElementById("gameMsg");
        const originalMsg = msg.innerText;
        msg.innerText = `🎉 恭喜！已獲得新贈品`;
        msg.classList.add('success'); 
        
        // Also show Top Pill
        const notify = document.getElementById('top-notify');
        const txt = document.getElementById('tn-text');
        txt.innerText = `已獲得 ${newUnlocks[newUnlocks.length-1]}!`;
        notify.classList.add('show');
        setTimeout(() => notify.classList.remove('show'), 3000);

        setTimeout(() => {
            msg.innerText = originalMsg; 
            msg.classList.remove('success');
            refreshCart(); 
        }, 2500);
        achievedGifts = currentGiftNames;
    }
    
    renderList(); 
}

function splitPrefixes(str){
  return String(str||"").split(/[&＆|,、]/).map(s=>s.trim()).filter(Boolean);
}
function seriesGiftUnit(prefixStr){
  return /麥汁/.test(String(prefixStr||"")) ? '箱' : '件';
}

function sumFinalByPrefixes(processedItems, prefixes){
  if(!prefixes || prefixes.length===0) return 0;
  let sum=0;
  processedItems.forEach(it=>{
    const cat = String(it.category||"");
    if(prefixes.some(p=>cat.includes(p))) sum += (Number(it.finalLine)||0);
  });
  return sum;
}
function sumQtyByPrefixes(cartItems, prefixes){
  if(!prefixes || prefixes.length===0) return 0;
  let q=0;
  cartItems.forEach(it=>{
    const cat = String(it.category||"");
    if(prefixes.some(p=>cat.includes(p))) q += (Number(it.qty)||0);
  });
  return q;
}

function calcCart() {
  let subTotal = 0, finalTotal = 0, beautyTotal = 0, discountAmt = 0;
  let warnings = [];
  let catCounts = {};
  CART.forEach(it => {
    const matchedRule = RULES.tiers.find(r => it.category.includes(r.zone));
    if(matchedRule) { const zone = matchedRule.zone; catCounts[zone] = (catCounts[zone] || 0) + it.qty; }
  });
  const processedItems = CART.map(it => {
    const originalLine = it.price * it.qty;
    subTotal += originalLine;
    let finalLine = originalLine;
    let tags = [];

    // Add-on (加價購) uses flat_price override (do NOT apply tier/bogo/bundle)
    if(String(it.category||"").includes("加價購")) {
      const fr = getFlatPriceRule(it.code, it.category);
      if(fr && fr.unit > 0) {
        finalLine = fr.unit * it.qty;
        tags.push({ text: `加購價 ${Number(fr.unit).toLocaleString()}`, cls: "save" });
      }
      finalTotal += finalLine;
      if(it.category.includes("美容")) beautyTotal += finalLine;
      return { ...it, finalLine, tags };
    }

    const bundleRule = RULES.bundle.find(b => b.code === it.code);
    if(bundleRule && bundleRule.price < it.price) {
      finalLine = bundleRule.price * it.qty;
      tags.push({ text: `現省 $${((it.price - bundleRule.price) * it.qty).toLocaleString()}`, cls: "save" });
    } else {
      const matchedRule = RULES.tiers.find(r => it.category.includes(r.zone));
      if(matchedRule) {
         const zone = matchedRule.zone;
         const tierRules = RULES.tiers.filter(r => r.zone === zone).sort((a,b) => b.min - a.min);
         const tier = tierRules.find(t => catCounts[zone] >= t.min);
         if(tier) {
           finalLine = originalLine * ((100 - tier.pct) / 100);
           tags.push({ text: `已享 ${fmtZheFromPctOff(tier.pct)}`, cls: "save" });
         }
      }
    }
    const bogo = RULES.bogo.find(b => b.code === it.code);
    if(bogo) {
      const set = bogo.buy + bogo.get;
      const free = Math.floor(it.qty/set) * bogo.get;
      finalLine -= free * it.price;
      if(free > 0) tags.push({ text: `買${bogo.buy}送${bogo.get}`, cls: "save" });
      if(it.qty % set !== 0) {
        tags.push({ text: `未湊滿優惠 (再選 ${set - (it.qty%set)} 件)`, cls: "warn" });
        warnings.push(`${it.name}`);
      }
    }
    finalTotal += finalLine;
    if(it.category.includes("美容")) beautyTotal += finalLine;
    return { ...it, finalLine, tags };
  });
  discountAmt = subTotal - finalTotal;
  const gifts = [];
  // Spend-threshold gifts (supports zone_prefix with multi-prefix syntax: & ＆ | 、 ,)
  RULES.spend.forEach(r => {
    let basis = finalTotal;
    if(r.scope === "zone_prefix") {
      const prefixes = splitPrefixes(r.prefix);
      basis = prefixes.length ? sumFinalByPrefixes(processedItems, prefixes) : 0;
    }
    if(Number.isFinite(r.amt) && basis >= r.amt) {
      let qty = r.mult ? Math.floor(basis / r.amt) * r.qty : r.qty;
      if(qty > 0) {
        let gName = r.gift;
        if(PRODUCT_MAP.has(r.gift)) gName = PRODUCT_MAP.get(r.gift).name;
        gName = gName.replace(/^(贈品|贈|Gift)[:\s|｜_]*/i, "");
        gifts.push({ name: gName, qty: qty, code: r.gift });
      }
    }
  });

  // Series gift: per-box / per-qty gift by zone_prefix (e.g., 保健飲品每箱送2提袋)
  (RULES.series_gift || []).forEach(r => {
    if(r.scope !== "zone_prefix") return;
    const prefixes = splitPrefixes(r.prefix);
    if(!prefixes.length) return;

    const totalQty = sumQtyByPrefixes(CART, prefixes); // qty = 箱數（購物車數量）
    if(totalQty <= 0) return;

    let giftQty = 0;
    const thr = Number(r.amt);
    if(Number.isFinite(thr) && thr > 0) {
      const times = r.mult ? Math.floor(totalQty / thr) : (totalQty >= thr ? 1 : 0);
      giftQty = times * (Number(r.qty) || 0);
    } else {
      // 若 threshold_amount 空白：視為「每箱送 gift_qty」
      giftQty = totalQty * (Number(r.qty) || 0);
    }

    if(giftQty > 0 && r.gift) {
      let gName = r.gift;
      if(PRODUCT_MAP.has(r.gift)) gName = PRODUCT_MAP.get(r.gift).name;
      gName = gName.replace(/^(贈品|贈|Gift)[:\s|｜_]*/i, "");
      gifts.push({ name: gName, qty: giftQty, code: r.gift });
    }
  });

  return { items: processedItems, subTotal, finalTotal, discountAmt, beautyTotal, gifts, warnings };
}

function refreshCart() {
  const data = calcCart();
  const list = document.getElementById("cartList");
  list.innerHTML = "";
  document.querySelector(".fb-total").innerText = "$" + Math.round(data.finalTotal).toLocaleString();
  document.querySelector(".fb-count").innerText = CART.reduce((a,b)=>a+b.qty,0) + " 件";
  
  data.items.forEach((it, index) => {
    let specStr = it.spec;
    if(it.bundleSelection) {
       if(it.bundle && it.bundle.length > 0) {
          const s = it.bundleSelection;
          const n1 = it.bundle[s[0]] ? it.bundle[s[0]].name : '?';
          const n2 = it.bundle[s[1]] ? it.bundle[s[1]].name : '?';
          specStr = `組合：${n1}、${n2}`;
       }
    } else if(it.bundle.length > 0) {
       specStr = it.bundle.map(b => `${b.name}x${b.qty}`).join("、");
    }

    const div = document.createElement("div"); div.className = "c-item";
    let tags = it.tags.map(t => `<span class="c-tag ${t.cls}">${t.text}</span>`).join("");
    
    // Price Display Fix: Old + New (Apply to BOGO too)
    let priceHtml = `$${Math.round(it.finalLine).toLocaleString()}`;
    if(it.finalLine < it.price * it.qty) {
        priceHtml = `<span class="c-old">$${(it.price*it.qty).toLocaleString()}</span> $${Math.round(it.finalLine).toLocaleString()}`;
    }
    
    div.innerHTML = `<div class="c-info"><div class="c-title">${it.name}</div><div class="c-spec">${specStr || ''}</div><div class="c-tags">${tags}</div><div class="c-price-box">${priceHtml}</div></div>
      <div class="c-ctrl"><div class="stepper"><div class="s-btn" onclick="window.updateCartItem(${index}, -1)">－</div><div class="s-val">${it.qty}</div><div class="s-btn add" onclick="window.updateCartItem(${index}, 1)">＋</div></div></div>`;
    list.appendChild(div);
  });

  document.getElementById("sumBase").innerText = "$" + data.subTotal.toLocaleString();
  document.getElementById("sumDisc").innerText = "-$" + Math.round(data.discountAmt).toLocaleString();
  document.getElementById("sumPay").innerText = "$" + Math.round(data.finalTotal).toLocaleString();
  document.getElementById("sumBeauty").innerText = "$" + Math.round(data.beautyTotal).toLocaleString();
  const warnEl = document.getElementById("warnMsg");
  if(data.warnings.length > 0) { warnEl.style.display = "block"; warnEl.innerText = "⚠️ " + [...new Set(data.warnings)].join("、"); } else { warnEl.style.display = "none"; }
  
  const next = RULES.spend.find(r => r.scope === "all" && r.amt > data.finalTotal);
  if(next) {
    const diff = Math.max(0, (next.amt - data.finalTotal));
  const diffInt = Math.ceil(diff);
  document.getElementById("gameMsg").innerText = `加油！再 $${diffInt.toLocaleString()} 解鎖贈品`;
    document.getElementById("gameBar").style.width = ((data.finalTotal/next.amt)*100) + "%";
    document.getElementById("gameBar").classList.remove("full");
  } else {
    document.getElementById("gameMsg").innerText = "🎉 太棒了！已解鎖所有滿額贈品";
    document.getElementById("gameBar").style.width = "100%";
    document.getElementById("gameBar").classList.add("full");
  }
  
  const finalList = document.getElementById("finalList");
  let sumHtml = "";
  data.items.forEach(i => sumHtml += `<div class="sum-line"><span>${i.name}</span><span>x${i.qty}</span></div>`);
  data.gifts.forEach(g => sumHtml += `<div class="sum-line" style="color:#e65100"><span>🎁 ${g.name}</span><span>x${g.qty}</span></div>`);
  finalList.innerHTML = sumHtml; // V22.2 Fix: Ensure HTML is set

  // Update宅配列右側免運提示（僅在展開時顯示）
  try { syncDeliveryHeaderUI(); } catch(e) {}

  return data;
}

/* removed accidental override of openCart (kept core openCart with 2-stage checkout) */
/* removed accidental override of closeCart (kept core closeCart with 2-stage checkout) */

window.onpopstate = (e) => { 
    // CRITICAL FIX: Always ensure body is clean when returning to root state
    if (!document.querySelector('.modal.open') && 
        !document.getElementById('drawer').classList.contains('open') && 
        !document.getElementById('milestone-overlay').classList.contains('open') &&
        !isPromoMapOpen()) {
        cleanupUI();
    }

    // Handle Promo Map Drawer (優惠地圖)
    if(isPromoMapOpen()){
        closePromoMap({skipHistory:true});
        const pending = __PM_PENDING_SCROLL_ID__;
        __PM_PENDING_SCROLL_ID__ = null;
        // keep guard so user doesn't leave app accidentally
        armBackGuard();
        if(pending){
          pmDeferredScroll(pending);
        }
        return;
    }

    // V25 FIX 1: Handle Milestone using DOM state
    const msOverlay = document.getElementById('milestone-overlay');
    if(msOverlay.classList.contains('open')) {
        msOverlay.classList.remove('open');
        document.getElementById('gift-fab').style.display = 'flex'; // Ensure FAB returns
        if(!isCartOpen) cleanupUI();
        return;
    }

    // V25 FIX 3: Handle Gift Modal correctly
    const giftModal = document.getElementById("giftModal"); 
    if(giftModal.classList.contains("open")) { 
        giftModal.classList.remove("open"); 
        if(isCartOpen) {
             document.getElementById("drawer").classList.add("open");
             document.body.classList.add("modal-open");
        } else {
             cleanupUI();
        }
        return; 
    } 

    // Handle Receipt
    const rcModal = document.getElementById("receiptModal"); 
    if(rcModal.classList.contains("open")) { return; } 

    // Handle Cart Drawer
    if(isCartOpen) { 
        document.getElementById("drawer").classList.remove("open"); 
        document.getElementById("float-bar").classList.remove("hidden"); 
        cleanupUI(); // V26: Force Cleanup
        isCartOpen = false; 
        return;
    } 

    // Root-level back behavior (主商品頁：先置頂→再提示→再離開)
    const st = history.state || null;
    if(st && st.page === 'guard') return;
    handleRootBack();
};
window.onbeforeunload = (e) => { if(CART.length > 0) return "訂單尚未送出"; };
document.getElementById("searchInp").addEventListener("input", renderList);

// OPTIMIZATION 2: Clear Search Logic
document.getElementById("clearSearch").addEventListener("click", () => {
    document.getElementById("searchInp").value = "";
    document.getElementById("clearSearch").style.display = 'none';
    renderList();
    document.getElementById("searchInp").focus();
});

window.toggleSum = () => { const b = document.getElementById("finalList"); const i = document.getElementById("sumIcon"); if(b.classList.contains("open")) { b.classList.remove("open"); i.innerText = "expand_more"; } else { b.classList.add("open"); i.innerText = "expand_less"; } };

// [NEW] 切換宅配表單顯示
window.toggleDelivery = function() {
  const chk = document.getElementById("chkDelivery");
  const form = document.getElementById("deliveryForm");
  const btn = document.getElementById("btnDeliveryCollapse");
  const status = document.getElementById("deliveryStatusText");

  const isComplete = () => {
    const n = (document.getElementById("dName")?.value || "").trim();
    const p = (document.getElementById("dPhone")?.value || "").trim();
    const a = (document.getElementById("dAddr")?.value || "").trim();
    return !!(n && p && a);
  };

  const setStatus = (complete) => {
    if(!status) return;
    if(complete) {
      status.textContent = "(已填妥收件資訊)";
      status.style.color = "#2e7d32";
      status.style.fontWeight = "700";
    } else {
      status.textContent = "(請填寫收件資訊)";
      status.style.color = "#ef6c00";
      status.style.fontWeight = "400";
    }
  };

  if(chk.checked) {
    form.classList.add("show");
    if(btn) btn.style.display = "inline-flex";
    // 自動帶入訂購人姓名到收貨人 (方便使用者)
    const fName = document.getElementById("fName").value;
    if(fName && !document.getElementById("dName").value) {
        document.getElementById("dName").value = fName;
    }
    setStatus(isComplete());
  } else {
    // [Guard] 若宅配必填欄位已填妥，避免誤觸取消勾選（改為展開檢視/編輯，但保持勾選）
    if(isComplete()) {
      chk.checked = true;
      form.classList.add("show");
      if(btn) btn.style.display = "inline-flex";
      setStatus(true);
      return;
    }

    form.classList.remove("show");
    if(btn) btn.style.display = "none";
    setStatus(false);
  }
  try { syncDeliveryHeaderUI(); } catch(e) {}
};

// [NEW] 宅配表單收合（需先完成必填欄位）
window.collapseDelivery = function() {
  const chk = document.getElementById("chkDelivery");
  const form = document.getElementById("deliveryForm");
  const btn = document.getElementById("btnDeliveryCollapse");
  const status = document.getElementById("deliveryStatusText");

  const v = (id) => (document.getElementById(id)?.value || "").trim();
  const required = ["dName", "dPhone", "dAddr"];

  // 只在「宅配已勾選」且表單展開時有意義
  if(!chk || !chk.checked) return;

  // Reset error styles
  required.forEach(id => document.getElementById(id)?.classList.remove("input-error", "flash-anim"));

  let hasError = false;
  required.forEach(id => {
    if(!v(id)) {
      const el = document.getElementById(id);
      if(el) el.classList.add("input-error", "flash-anim");
      hasError = true;
    }
  });

  if(hasError) {
    showToast("請先填妥收件資訊再收合", "warn");
    return;
  }

  // Collapse
  if(form) form.classList.remove("show");
  if(btn) btn.style.display = "none";

  // Update status text
  if(status) {
    status.textContent = "(已填妥收件資訊)";
    status.style.color = "#2e7d32";
    status.style.fontWeight = "700";
  }
  try { syncDeliveryHeaderUI(); } catch(e) {}
};


// [NEW] 防呆：若宅配必填欄位已填妥（或瀏覽器自動帶入），則維持勾選與完成狀態
window.syncDeliveryUI = function(opts = { collapse: true }) {
  const chk = document.getElementById("chkDelivery");
  const form = document.getElementById("deliveryForm");
  const btn = document.getElementById("btnDeliveryCollapse");
  const status = document.getElementById("deliveryStatusText");
  if(!chk || !form || !status) return;

  const n = (document.getElementById("dName")?.value || "").trim();
  const p = (document.getElementById("dPhone")?.value || "").trim();
  const a = (document.getElementById("dAddr")?.value || "").trim();
  const complete = !!(n && p && a);

  if(complete) {
    chk.checked = true;
    status.textContent = "(已填妥收件資訊)";
    status.style.color = "#2e7d32";
    status.style.fontWeight = "700";

    if(opts && opts.collapse) {
      form.classList.remove("show");
      if(btn) btn.style.display = "none";
    }
  }
  try { syncDeliveryHeaderUI(); } catch(e) {}
};

// 兼容瀏覽器 Autofill：延遲同步一次，並於 pageshow 再同步
setTimeout(() => window.syncDeliveryUI && window.syncDeliveryUI({ collapse: true }), 200);
window.addEventListener("pageshow", () => {
  setTimeout(() => window.syncDeliveryUI && window.syncDeliveryUI({ collapse: true }), 200);
});

window.submitOrder = () => {
    // V2 Sprint1: strict mode — if config isn't ready, don't allow submission
    if(!CONFIG_READY) {
        try { showInitBlockedToast(); } catch(e) { try { showToast('系統初始化中…請稍候', 'info', 2800); } catch(e2) {} }return;
    }
const f = (id) => document.getElementById(id).value.trim(); 
    const nameEl = document.getElementById("fName");
    const deptEl = document.getElementById("fDept");

    // 錯誤提示重置
    nameEl.classList.remove("input-error", "flash-anim");
    deptEl.classList.remove("input-error", "flash-anim");
    const dInputs = ['dName', 'dPhone', 'dAddr'];
    dInputs.forEach(id => document.getElementById(id).classList.remove("input-error", "flash-anim"));

    void nameEl.offsetWidth; // Trigger reflow

    let hasError = false;
    // 1. 基本驗證
    if(!f("fName")) { nameEl.classList.add("input-error", "flash-anim"); hasError = true; }
    if(!f("fDept")) { deptEl.classList.add("input-error", "flash-anim"); hasError = true; }

    // [NEW] 2. 宅配驗證
    const isDelivery = document.getElementById("chkDelivery").checked;
    let pickupInfo = null;

    if (isDelivery) {
        if(!f("dName")) { document.getElementById("dName").classList.add("input-error", "flash-anim"); hasError = true; }
        if(!f("dPhone")) { document.getElementById("dPhone").classList.add("input-error", "flash-anim"); hasError = true; }
        if(!f("dAddr")) { document.getElementById("dAddr").classList.add("input-error", "flash-anim"); hasError = true; }

        if (!hasError) {
            pickupInfo = {
                name: f("dName"),
                phone: f("dPhone"),
                address: f("dAddr"),
                note: f("dNote")
            };
        }
    }

    if(hasError) {
        showToast(isDelivery ? "請填寫完整訂購與宅配資訊" : "請填寫姓名與部門", "warn"); 
        return; 
    } 

    const data = calcCart(); 
    if(data.warnings.length > 0) { 
        const warnEl = document.getElementById("warnMsg"); 
        warnEl.scrollIntoView({ behavior: "smooth", block: "center" }); 
        warnEl.classList.remove("flash-anim"); void warnEl.offsetWidth; warnEl.classList.add("flash-anim"); 
        showToast("尚有優惠未湊滿，無法送出！", "warn"); 
        return; 
    } 

    const btn = document.querySelector(".btn-submit"); 
    const originalText = btn.innerText; 
    btn.innerText = "資料傳送中..."; 
    btn.disabled = true; 
    btn.style.opacity = "0.7"; 

    const allDiscountNotes = []; 

    // 準備商品資料
    const itemsPayload = data.items.map(it => { 
        let spec = it.spec || ""; 
        let bundleSummary = ""; 

        if(it.bundleSelection) { 
            const s = it.bundleSelection; 
            spec = `[自選] ${it.bundle[s[0]]?.name} + ${it.bundle[s[1]]?.name}`; 
            bundleSummary = `${it.bundle[s[0]]?.name}|${it.bundle[s[1]]?.name}`; 
        } else { 
            if(it.bundle.length > 0) { 
                spec = "[" + it.bundle.map(b=>b.name).join("+") + "]"; 
                bundleSummary = it.bundle.map(b=>b.name).join("|"); 
            } 
        } 

        let chargeQty = it.qty, freeQty = 0; 
        const bogo = RULES.bogo.find(b => b.code === it.code); 
        if(bogo) { 
            const set = bogo.buy + bogo.get; 
            const sets = Math.floor(it.qty / set); 
            freeQty = sets * bogo.get; 
            chargeQty = it.qty - freeQty; 
        } 

        it.tags.forEach(t => { 
            if(t.cls === 'save') allDiscountNotes.push(`${it.name}: ${t.text}`); 
        }); 

        return { 
            product_code: it.code, 
            product_name: it.name, 
            spec: spec, 
            category: it.category, 
            unit_price: it.price, 
            qty: it.qty, 
            charge_qty: chargeQty, 
            free_qty: freeQty, 
            line_total: Math.round(it.finalLine), 
            bundle_summary: bundleSummary 
        }; 
    }); 

    // [Mod] 準備贈品資料 (包含拆解邏輯)
    const giftsPayload = data.gifts.map(g => {
        let bundleSummary = "";
        // 查找贈品是否有 bundle 設定 (邏輯同產品列表)
        const p = PRODUCT_MAP.get(g.code);
        if (p && p.bundle && p.bundle.length > 0) {
            // 如果贈品本身是組合包，自動拆解其內容物
            bundleSummary = p.bundle.map(b => b.name).join("|");
        }

        return { 
            product_code: g.code || "GIFT", 
            product_name: `[贈品] ${g.name}`, 
            qty: g.qty,
            bundle_summary: bundleSummary // 傳給後端寫入 Content 欄位
        };
    }); 

    if(giftsPayload.length > 0) allDiscountNotes.push("已符合滿額贈資格"); 

    // 組合最終 Payload
    lastOrderData = { 
        employee_name: f("fName"), 
        department: f("fDept"), 
        payment_method: f("fPay"), 
        remarks: f("fNote"), 
        totals: { 
            base: data.subTotal, 
            discount: Math.round(data.discountAmt), 
            pay: Math.round(data.finalTotal) 
        }, 
        discount_notes: allDiscountNotes, 
        items: itemsPayload, 
        gifts: giftsPayload,
        // [New] 宅配與取貨資訊
        pickup_method: isDelivery ? '宅配' : '自取',
        pickup_info: pickupInfo
    }; 

    fetch(GAS_URL, { 
        method: "POST", 
        headers: { "Content-Type": "application/x-www-form-urlencoded" }, 
        body: "payload=" + encodeURIComponent(JSON.stringify(lastOrderData)) 
    })
    .then(response => response.json())
    .then(res => { 
        if(res.ok) { 
            showToast("訂單送出成功！"); 
            openReceipt(res.order_id); 
        } else { 
            alert("訂單送出失敗：" + (res.error || "未知錯誤")); 
        } 
    })
    .catch(err => { 
        console.error(err); 
        alert("連線發生錯誤"); 
    })
    .finally(() => { 
        btn.innerText = originalText; 
        btn.disabled = false; 
        btn.style.opacity = "1"; 
    }); 
};

function openReceipt(orderId) { const modal = document.getElementById("receiptModal"); const body = document.getElementById("rcBody"); document.getElementById("rcOrderId").innerText = `No. ${orderId}`; let html = ""; 

    // [New] 收據顯示宅配資訊
    if (lastOrderData.pickup_method === '宅配' && lastOrderData.pickup_info) {
        html += `
        <div style="background:#fff3e0;padding:10px;margin-bottom:10px;border-radius:6px;font-size:13px;color:#e65100;">
            <b>🚚 宅配資訊</b><br>
            ${lastOrderData.pickup_info.name} / ${lastOrderData.pickup_info.phone}<br>
            ${lastOrderData.pickup_info.address}
        </div>`;
    }
 lastOrderData.items.forEach(it => { html += `<div class="rc-item"><div class="rc-name">${it.product_name}</div><div class="rc-meta"><span>${it.spec}</span><span>x${it.qty}</span><span>$${it.line_total}</span></div></div>`; }); if(lastOrderData.gifts.length > 0) { html += `<div class="rc-row bold" style="color:#e65100">滿額贈品</div>`; lastOrderData.gifts.forEach(g => { html += `<div class="rc-item"><div class="rc-name" style="color:#e65100">🎁 ${g.product_name}</div><div class="rc-meta"><span></span><span>x${g.qty}</span><span>免費</span></div></div>`; }); } html += `<div class="rc-row bold"><span>總計金額</span><span>$${lastOrderData.totals.pay}</span></div>`; body.innerHTML = html; modal.classList.add("open"); }
function closeReceipt() { document.getElementById("receiptModal").classList.remove("open"); CART = []; SELECTED_BUNDLE.clear(); achievedGifts = []; saveState(); refreshCart(); closeCart(); renderList(); document.getElementById("fNote").value = ""; lastOrderData = null; }
function toggleEmailInput() { const box = document.getElementById("emailBox"); box.classList.toggle("show"); if(box.classList.contains("show")) document.getElementById("rcEmail").focus(); }
function sendReceipt() { const email = document.getElementById("rcEmail").value.trim(); if(!email || !email.includes('@')) { showToast("請輸入有效的 Email", "warn"); return; } const btn = document.querySelector("#emailBox .btn-submit"); const orgTxt = btn.innerText; btn.innerText = "..."; btn.disabled = true; const payload = { action: 'send_email', email: email, order_id: document.getElementById("rcOrderId").innerText, order_data: lastOrderData }; fetch(GAS_URL, { method: "POST", headers: { "Content-Type": "application/x-www-form-urlencoded" }, body: "payload=" + encodeURIComponent(JSON.stringify(payload)) }).then(res => res.json()).then(res => { if(res.ok) { showToast("✅ 已寄送至信箱"); toggleEmailInput(); } else { alert("寄送失敗"); } }).catch(err => alert("連線錯誤")) .finally(() => { btn.innerText = orgTxt; btn.disabled = false; }); }

// Start
window.addEventListener('scroll', () => {
  const btn = document.getElementById('back-to-top');
  const scrollY = window.scrollY;
  if(scrollY > 300) btn.classList.add('show');
  else btn.classList.remove('show');

  if (scrollY < 50) {
    document.querySelectorAll(".cat-pill").forEach(pill => {
      pill.classList.toggle("active", pill.innerText === "熱銷排行");
    });
  }
});

// Remove Error State on Focus
document.querySelectorAll('input, select').forEach(input => {
    input.addEventListener('focus', function() {
        this.classList.remove('input-error', 'flash-anim');
    });
});

document.getElementById("searchInp").addEventListener("input", renderList);
window.onbeforeunload = (e) => { if(CART.length > 0) return "訂單尚未送出"; };

initApp();
try{ __starCaptureTemplate(); }catch(e){}
try{ initBackGuard(); }catch(e){}

// --- V2.8.8: Click-to-explain for promo badges/pills (non-intrusive) ---
document.addEventListener('click', function promoHintClick(e){
  const el = e.target.closest('.promo-badge, .p-price-pill, #shipFreeBadge');
  if(!el) return;
  // prevent interfering with +/- buttons etc.
  if(e.target.closest('.s-btn')) return;

  // Shipping badge
  if(el.id === 'shipFreeBadge'){
    const total = Number(document.getElementById("sumPay")?.innerText?.replace('$','').replace(/,/g,'')) || 0;
    const thr = getFreeShipThreshold();
    if(!thr) return;
    if(total >= thr) return showPromoHint(`免運門檻：滿 ${Math.round(thr).toLocaleString()} 免運（已達標）`);
    const diff = Math.max(0, Math.round(thr - total));
    return showPromoHint(`免運門檻：滿 ${Math.round(thr).toLocaleString()} 免運；還差 ${diff.toLocaleString()}`);
  }

  const promo = el.dataset.promo || '';
  if(promo === 'bogo'){
    const code = el.dataset.code || '';
    const r = (RULES && Array.isArray(RULES.bogo)) ? RULES.bogo.find(x => x && x.code === code) : null;
    if(r) return showPromoHint(`${getBadgeName('bogo','買一送一')}：買${Number(r.buy)||1}送${Number(r.get)||1}`);
    return showPromoHint(`${getBadgeName('bogo','買一送一')}：依活動規則`);
  }
  if(promo === 'tier' || promo === 'order_discount' || promo === 'tier_range'){
    // If el has zone, use it; else infer by current product category not available -> fallback by zone
    const zone = (el.dataset.zone || '').trim();
    let info = null;
    if(zone){
      const rules = (RULES && Array.isArray(RULES.tiers)) ? RULES.tiers.filter(t => t && String(t.zone)===zone && isFinite(t.pct) && t.pct>0).sort((a,b)=>Number(a.min)-Number(b.min)) : [];
      if(rules.length){
        info = (rules.length===1 && Number(rules[0].min)<=1) ? {kind:'order', zone, rules} : {kind:'tier', zone, rules};
      }
    }
    if(!info){
      // last resort: try to infer from currently opened modal product
      return;
    }
    return showPromoHint(buildTierHintText(info));
  }
  if(promo === 'bundle_select'){
    return showPromoHint(`${getBadgeName('bundle_select','優惠組合')}：依商品內容任選搭配`);
  }
  if(promo === 'bundle_price'){
    return showPromoHint('優惠價：以活動設定為準');
  }
  if(promo === 'addon' || promo === 'addon_price'){
    return showPromoHint('加價購：需先選購指定主商品區商品才可加購');
  }
});


// --- V2.8.11: Category title click-to-explain (same as Promo Map hint) ---
document.addEventListener('click', function catTitleHintClick(e){
  const el = e.target.closest('.cat-section-title');
  if(!el) return;
  // ignore clicks when user is selecting text in inputs etc.
  if(e.target.closest('input, textarea, select')) return;
  const title = String(el.innerText||'').trim();
  if(!title) return;

const hint = buildPromoMapRowHint(title);
const tpl = uiGet('ui|cat_title_hint_tpl', uiGet('cat_title_hint_tpl',''));
if(hint){
  if(tpl){
    const msg = String(tpl)
      .replace(/\{cat\}/g, title)
      .replace(/\{hint\}/g, hint);
    return showPromoHint(msg || hint);
  }
  return showPromoHint(hint);
}
if(tpl){
  const msg = String(tpl).replace(/\{cat\}/g, title).replace(/\{hint\}/g, '本分類目前無優惠訊息');
  return showPromoHint(msg || '本分類目前無優惠訊息');
}
return showPromoHint('本分類目前無優惠訊息');
});

</script>

<!-- V2.8.9: Promo Map Drawer -->
<div id="promoMapOverlay" class="pm-overlay"></div>
<aside id="promoMapDrawer" class="pm-drawer" aria-hidden="true">
  <div class="pm-header">
    <div class="pm-head-left">
      <div class="pm-title">優惠地圖</div>
      <div class="pm-tabs" role="tablist" aria-label="優惠地圖切換">
        <button type="button" class="pm-tab active" id="pmTabNav" data-tab="nav" role="tab" aria-selected="true">優惠分類</button>
        <button type="button" class="pm-tab" id="pmTabGifts" data-tab="gifts" role="tab" aria-selected="false">贈品門檻</button>
      </div>
    </div>
    <button type="button" class="pm-close" id="promoMapCloseBtn" aria-label="關閉">✕</button>
  </div>
  <div class="pm-body">
    <div id="promoMapPaneNav" class="pm-pane">
      <div class="pm-sub">點擊可快速跳轉</div>
      <div id="promoMapList" class="pm-list"></div>
    </div>

    <div id="promoMapPaneGifts" class="pm-pane" style="display:none">
      <div class="pm-sub">查看各階滿額贈品</div>
      <div id="pmGiftHeader" class="pm-gift-header pm-gh-all" aria-label="贈品門檻摘要">
        <div class="pm-gh-top">
          <span class="pm-badge pm-badge-all">ALL</span>
          <div class="pm-gh-text">
            <div class="pm-gh-title">全區滿額贈</div>
            <div class="pm-gh-sub">全站商品合併計算</div>
          </div>
        </div>
      </div>
      <div class="pm-scope" role="tablist" aria-label="贈品範圍">
        <button type="button" class="pm-scope-btn active" data-scope="all" role="tab" aria-selected="true">全區</button>
        <button type="button" class="pm-scope-btn" data-scope="zone_prefix" role="tab" aria-selected="false">美容</button>
        <button type="button" class="pm-scope-btn" data-scope="series" role="tab" aria-selected="false">系列</button>
      </div>
      <div id="promoGiftList" class="pm-gift-list"></div>
    </div>
  </div>
</aside>

</body>
</html>
