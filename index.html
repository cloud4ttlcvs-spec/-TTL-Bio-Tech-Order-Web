<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
<title>ÁîüÊäÄÂ±ïË®ÇË≥ºÁ≥ªÁµ± V14.0 (ÊóóËâ¶È´îÈ©óÁâà)</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&family=Roboto:wght@500;700;900&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

<style>
:root {
  --primary: #00897b; --primary-light: #e0f2f1; --accent: #ff6f00; 
  --bg-body: #f8f9fa; --bg-card: #ffffff; --text-main: #263238; --text-sub: #546e7a;
  --border: #eceff1; --header-height: 115px;
  --shadow-card: 0 4px 20px rgba(0,0,0,0.04);
}
* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
body {
  font-family: 'Noto Sans TC', sans-serif; background: var(--bg-body); color: var(--text-main);
  margin: 0; padding: 0; padding-top: var(--header-height); padding-bottom: 120px;
  overscroll-behavior-y: none;
}

/* 1. Skeleton Loading Animation */
@keyframes shimmer {
  0% { background-position: -468px 0; }
  100% { background-position: 468px 0; }
}
.skeleton {
  background: #f6f7f8;
  background-image: linear-gradient(to right, #f6f7f8 0%, #edeef1 20%, #f6f7f8 40%, #f6f7f8 100%);
  background-repeat: no-repeat;
  background-size: 800px 104px; 
  animation: shimmer 1s linear infinite forwards;
  border-radius: 8px;
}
.sk-card { height: 280px; border-radius: 16px; background: #fff; padding: 12px; margin-bottom: 12px; }
.sk-img { height: 160px; width: 100%; margin-bottom: 10px; }
.sk-txt { height: 16px; width: 70%; margin-bottom: 8px; }
.sk-price { height: 20px; width: 40%; margin-top: auto; }

/* 2. Toast Notifications */
#toast-container {
  position: fixed; bottom: 90px; left: 50%; transform: translateX(-50%);
  z-index: 9999; pointer-events: none; width: 90%; max-width: 300px;
  display: flex; flex-direction: column; gap: 8px;
}
.toast {
  background: rgba(33, 33, 33, 0.9); color: #fff; padding: 12px 20px;
  border-radius: 50px; font-size: 14px; text-align: center;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15); opacity: 0; transform: translateY(20px);
  animation: toastIn 0.3s forwards, toastOut 0.3s forwards 2s;
  backdrop-filter: blur(4px); display: flex; align-items: center; justify-content: center; gap: 8px;
}
@keyframes toastIn { to { opacity: 1; transform: translateY(0); } }
@keyframes toastOut { to { opacity: 0; transform: translateY(-10px); } }

/* 3. Flying Item Animation */
.flying-img {
  position: fixed; z-index: 9999; pointer-events: none; border-radius: 50%;
  box-shadow: 0 5px 15px rgba(0,0,0,0.2); transition: transform 0.5s ease-in, opacity 0.5s ease-in;
  width: 50px; height: 50px; object-fit: cover; background: #fff;
}

/* Header */
header {
  position: fixed; top: 0; left: 0; right: 0; background: rgba(255,255,255,0.95);
  z-index: 1000; box-shadow: 0 2px 15px rgba(0,0,0,0.03);
  padding: 8px 0; height: var(--header-height); display: flex; flex-direction: column; justify-content: space-between; backdrop-filter: blur(12px);
}
.search-wrap { padding: 0 16px; }
.search-box { position: relative; width: 100%; }
.search-box input {
  width: 100%; padding: 10px 12px 10px 42px; border-radius: 12px; border: 1px solid #e0e0e0;
  background: #f5f7f9; font-size: 15px; transition: 0.3s;
}
.search-box input:focus { background: #fff; border-color: var(--primary); outline: none; box-shadow: 0 0 0 3px rgba(0,137,123,0.1); }
.search-box .icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-sub); }

/* Tabs */
.cat-nav { display: flex; gap: 8px; padding: 0 16px 8px 16px; overflow-x: auto; scrollbar-width: none; }
.cat-nav::-webkit-scrollbar { display: none; }
.cat-pill {
  white-space: nowrap; padding: 7px 18px; border-radius: 24px; font-size: 14px; font-weight: 500;
  color: var(--text-sub); background: #fff; border: 1px solid #e0e0e0; cursor: pointer; transition: 0.25s cubic-bezier(0.25, 0.8, 0.25, 1);
}
.cat-pill.active {
  background: var(--primary); color: #fff; border-color: var(--primary); 
  box-shadow: 0 4px 10px rgba(0,137,123,0.25); font-weight: 700; transform: scale(1.02);
}

/* Grid */
main { padding: 16px; max-width: 900px; margin: 0 auto; min-height: 80vh; touch-action: pan-y; }
#list { display: grid; grid-template-columns: repeat(auto-fill, minmax(165px, 1fr)); gap: 12px; }
@media (max-width: 480px) { #list { grid-template-columns: 1fr 1fr; gap: 10px; } }

/* Product Card */
.p-card { 
  background: #fff; border-radius: 16px; overflow: hidden; position: relative;
  box-shadow: var(--shadow-card); border: 1px solid #f0f0f0;
  display: flex; flex-direction: column; transition: transform 0.15s;
}
.p-card:active { transform: scale(0.97); }
.p-img-box {
  width: 100%; aspect-ratio: 1/1; background: #fff; position: relative;
  display: flex; align-items: center; justify-content: center; overflow: hidden;
}
.p-img-box img { width: 100%; height: 100%; object-fit: contain; transition: opacity 0.4s ease; opacity: 0; }
.p-img-box img.loaded { opacity: 1; }
.p-no-img { font-size: 12px; color: #b0bec5; display: flex; flex-direction: column; align-items: center; }

/* Badges */
.badges { position: absolute; top: 8px; left: 8px; display: flex; flex-direction: column; gap: 4px; z-index: 2; align-items: flex-start; }
.badge { font-size: 10px; padding: 4px 8px; border-radius: 6px; color: #fff; font-weight: 700; box-shadow: 0 2px 6px rgba(0,0,0,0.2); letter-spacing: 0.5px; backdrop-filter: blur(4px); }
.bg-red { background: rgba(239, 83, 80, 0.95); }
.bg-blue { background: rgba(66, 165, 245, 0.95); }
.bg-gold { background: linear-gradient(135deg, #ffa726, #fb8c00); }
.bg-purple { background: rgba(171, 71, 188, 0.95); }

.p-body { padding: 12px; flex: 1; display: flex; flex-direction: column; justify-content: space-between; }
.p-title { font-size: 14px; font-weight: 700; line-height: 1.4; color: #37474f; margin-bottom: 4px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; height: 40px; }
.p-code { font-size: 11px; color: #cfd8dc; margin-bottom: 8px; }
.p-price-row { display: flex; align-items: baseline; gap: 6px; margin-top: auto; }
.p-price { font-size: 17px; font-weight: 800; color: #263238; }

/* Stepper */
.stepper { display: flex; align-items: center; justify-content: flex-end; gap: 8px; margin-top: 10px; }
.s-btn { 
  width: 32px; height: 32px; border-radius: 50%; border: 1px solid #eceff1; 
  background: #fff; color: var(--primary); font-size: 20px; 
  display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s;
}
.s-btn:active { background: var(--primary-light); transform: scale(0.9); }
.s-btn.add { background: var(--primary); color: #fff; border-color: var(--primary); box-shadow: 0 2px 5px rgba(0,137,123,0.3); }
.s-val { width: 24px; text-align: center; font-size: 15px; font-weight: 600; color: #37474f; }
.s-btn.hidden, .s-val.hidden { display: none; }

.btn-bundle {
  width: 100%; margin-top: 8px; padding: 10px; 
  border: 1px dashed var(--primary); border-radius: 10px; 
  color: var(--primary); background: var(--primary-light); 
  font-size: 13px; font-weight: 700; text-align: center; cursor: pointer;
  transition: 0.2s;
}
.btn-bundle:active { transform: scale(0.98); background: #b2dfdb; }

/* Floating Bar */
#float-bar {
  position: fixed; bottom: 20px; left: 16px; right: 16px; 
  background: #263238; color: #fff; border-radius: 60px; 
  padding: 10px 10px 10px 24px; box-shadow: 0 15px 35px rgba(0,0,0,0.25); 
  display: flex; align-items: center; justify-content: space-between; 
  transform: translateY(200%); transition: 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); 
  z-index: 1100; cursor: pointer; backdrop-filter: blur(10px);
}
#float-bar.show { transform: translateY(0); }
.fb-total { font-size: 18px; font-weight: 700; }
.fb-count { font-size: 12px; opacity: 0.7; }
.fb-btn { background: var(--accent); color: #fff; padding: 10px 24px; border-radius: 40px; font-weight: 700; font-size: 15px; box-shadow: 0 4px 15px rgba(255,111,0,0.4); display: flex; align-items: center; gap: 6px; }

/* Drawer */
#drawer { position: fixed; inset: 0; z-index: 1200; pointer-events: none; }
#drawer-bg { position: absolute; inset: 0; background: rgba(0,0,0,0.6); opacity: 0; transition: 0.3s; backdrop-filter: blur(4px); }
#drawer-panel { 
  position: absolute; top: 0; right: 0; bottom: 0; width: 100%; max-width: 480px; 
  background: #fff; transform: translateX(100%); transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
  display: flex; flex-direction: column; pointer-events: auto; box-shadow: -5px 0 30px rgba(0,0,0,0.15);
}
#drawer.open #drawer-bg { opacity: 1; pointer-events: auto; }
#drawer.open #drawer-panel { transform: translateX(0); }

.dr-head { padding: 16px 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: #fff; }
.dr-body { flex: 1; overflow-y: auto; padding: 16px; background: #f9fafb; }
.dr-foot { padding: 20px; background: #fff; border-top: 1px solid var(--border); box-shadow: 0 -4px 20px rgba(0,0,0,0.05); }

/* Cart Item */
.c-item { display: flex; gap: 12px; margin-bottom: 12px; padding: 16px; background: #fff; border-radius: 16px; border: 1px solid #eceff1; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
.c-info { flex: 1; }
.c-title { font-size: 15px; font-weight: 700; margin-bottom: 4px; color: #37474f; }
.c-spec { font-size: 13px; color: #78909c; margin-bottom: 6px; }
.c-tags { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 6px; }
.c-tag { font-size: 11px; padding: 3px 8px; border-radius: 6px; font-weight: 600; display: inline-flex; align-items: center; gap: 4px; }
.c-tag.save { background: #fff3e0; color: #e65100; border: 1px solid #ffe0b2; }
.c-tag.warn { background: #ffebee; color: #c62828; border: 1px solid #ffcdd2; }
.c-price-box { margin-top: 8px; display: flex; align-items: baseline; gap: 6px; }
.c-price { font-weight: 800; font-size: 16px; color: #263238; }
.c-old { text-decoration: line-through; color: #90a4ae; font-size: 12px; }
.c-ctrl { display: flex; flex-direction: column; align-items: flex-end; justify-content: center; }

/* Summary Card */
.sum-card { background: #fff; border-radius: 12px; border: 1px solid #e0e0e0; margin-top: 15px; overflow: hidden; }
.sum-head { padding: 12px 16px; background: #f5f5f5; font-size: 14px; font-weight: 700; display: flex; justify-content: space-between; align-items: center; cursor: pointer; color: #37474f; transition: 0.2s; }
.sum-head:hover { background: #eeeeee; }
.sum-body { display: none; padding: 12px 16px; font-size: 13px; color: #546e7a; line-height: 1.6; background: #fff; }
.sum-body.open { display: block; animation: slideDown 0.2s ease-out; }
@keyframes slideDown { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
.sum-line { display: flex; justify-content: space-between; border-bottom: 1px dashed #eee; padding: 6px 0; }

/* Form */
.form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 15px; }
input, select { width: 100%; padding: 14px; border: 1px solid #cfd8dc; border-radius: 12px; font-size: 14px; background: #fafafa; transition: 0.2s; }
input:focus, select:focus { border-color: var(--primary); background: #fff; outline: none; box-shadow: 0 0 0 3px rgba(0,137,123,0.1); }
.btn-bar { display: flex; gap: 10px; margin-top: 20px; }
.btn-submit { flex: 2; padding: 16px; background: var(--text-main); color: #fff; border: none; border-radius: 14px; font-size: 16px; font-weight: 700; cursor: pointer; transition: 0.2s; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
.btn-submit:active { transform: scale(0.98); opacity: 0.9; }
.btn-clear { flex: 0 0 50px; padding: 0; background: #ffebee; color: #ef5350; border: none; border-radius: 14px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; }
.btn-clear:active { background: #ffcdd2; }

/* Promo Bar */
.promo-bar { background: #e8f5e9; color: #1b5e20; padding: 12px 16px; font-size: 13px; display: flex; align-items: center; gap: 8px; border-bottom: 1px solid #c8e6c9; font-weight: 500; }

/* Modal */
.modal { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 2000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(6px); }
.modal.open { display: flex; animation: fadeIn 0.2s ease-out; }
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
.m-box { background: #fff; width: 90%; max-width: 420px; border-radius: 24px; padding: 24px; max-height: 85vh; display: flex; flex-direction: column; box-shadow: 0 25px 50px rgba(0,0,0,0.25); transform: scale(0.95); transition: 0.2s; }
.modal.open .m-box { transform: scale(1); }
.m-head { font-size: 20px; font-weight: 700; margin-bottom: 8px; text-align: center; color: #263238; }
.m-sub { text-align: center; color: #78909c; font-size: 14px; margin-bottom: 20px; }
.m-grid { display: flex; flex-direction: column; gap: 10px; overflow-y: auto; padding: 4px; }
.m-row { display: flex; justify-content: space-between; align-items: center; padding: 16px; border: 1px solid #eceff1; border-radius: 16px; transition: 0.2s; background: #fafafa; }
.m-row:hover { background: #fff; border-color: var(--primary); box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
.m-name { font-weight: 700; font-size: 15px; color: #37474f; }
.m-ctrl { display: flex; align-items: center; gap: 12px; }
.m-btn-s { width: 32px; height: 32px; border-radius: 50%; background: #fff; border: 1px solid #cfd8dc; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 18px; color: var(--primary); transition: 0.1s; }
.m-btn-s:active { background: var(--primary); color: #fff; border-color: var(--primary); }
.m-val { font-weight: 700; width: 24px; text-align: center; font-size: 16px; }
.m-acts { display: flex; gap: 12px; margin-top: 24px; }
.m-btn { flex: 1; padding: 14px; border-radius: 12px; border: none; font-weight: 700; cursor: pointer; font-size: 16px; transition: 0.2s; }
.m-btn.disabled { opacity: 0.5; pointer-events: none; background: #cfd8dc; }

#empty-state { text-align: center; margin-top: 80px; color: #b0bec5; display: none; }
</style>
</head>
<body>

<div id="toast-container"></div>

<div id="loader" style="background:#f4f6f8; align-items:flex-start; padding: 120px 16px 0;">
  <div style="width:100%; max-width:800px; margin:0 auto; display:grid; grid-template-columns:1fr 1fr; gap:12px;">
    <div class="skeleton sk-card"></div><div class="skeleton sk-card"></div>
    <div class="skeleton sk-card"></div><div class="skeleton sk-card"></div>
  </div>
</div>

<header>
  <div class="search-wrap">
    <div class="search-box">
      <span class="material-icons-round icon">search</span>
      <input id="searchInp" type="text" placeholder="ÊêúÂ∞ãÂïÜÂìÅ...">
    </div>
  </div>
  <div class="cat-wrap">
    <nav class="cat-nav" id="catNav">
      </nav>
  </div>
</header>

<main id="list"></main>
<div id="empty-state">
  <span class="material-icons-round" style="font-size:48px">search_off</span>
  <p>Êâæ‰∏çÂà∞Áõ∏ÈóúÂïÜÂìÅ</p>
</div>

<div id="float-bar" onclick="openCart()">
  <div class="fb-info">
    <span class="fb-total">$0</span>
    <span class="fb-count">0 ‰ª∂ÂïÜÂìÅ</span>
  </div>
  <div class="fb-btn">Êü•ÁúãË≥ºÁâ©Ëªä <span class="material-icons-round" style="font-size:18px">arrow_forward</span></div>
</div>

<div id="drawer">
  <div id="drawer-bg" onclick="closeCart()"></div>
  <div id="drawer-panel">
    <div class="dr-head">
      <h2 style="margin:0;font-size:20px;font-weight:700;color:#263238">Ë≥ºÁâ©Ëªä</h2>
      <span class="material-icons-round" onclick="closeCart()" style="cursor:pointer;padding:8px;color:#546e7a;background:#f5f5f5;border-radius:50%">close</span>
    </div>
    
    <div class="promo-bar" id="promoBar" style="display:none">
      <span class="material-icons-round" style="color:#2e7d32">redeem</span>
      <span id="promoTxt"></span>
    </div>

    <div class="dr-body" id="cartList"></div>

    <div class="dr-foot">
      <div class="sum-card">
        <div class="sum-head" onclick="toggleSum()">
          <span>üéÅ ÂïÜÂìÅÁ∏ΩË¶Ω (Âê´Ë¥àÂìÅ)</span>
          <span class="material-icons-round" id="sumIcon">expand_more</span>
        </div>
        <div class="sum-body" id="finalList"></div>
      </div>

      <div style="display:flex;justify-content:space-between;margin:15px 0 5px 0;color:#c2185b;font-weight:700"><span>ÁæéÂÆπ‰øùÈ§äÂ∞èË®à</span><span id="sumBeauty">$0</span></div>
      <div style="display:flex;justify-content:space-between;margin-bottom:5px;color:#546e7a"><span>ÂéüÂÉπÁ∏ΩË®à</span><span id="sumBase">$0</span></div>
      <div style="display:flex;justify-content:space-between;margin-bottom:5px;color:var(--accent)"><span>ÊäòÊâ£ËàáÂÑ™ÊÉ†</span><span id="sumDisc">-$0</span></div>
      <div style="display:flex;justify-content:space-between;margin-top:10px;padding-top:10px;border-top:1px dashed #cfd8dc;font-size:22px;font-weight:800;color:#263238"><span>Êáâ‰ªòÈáëÈ°ç</span><span id="sumPay">$0</span></div>
      
      <div class="form-grid">
        <input id="fName" placeholder="ÂßìÂêç (ÂøÖÂ°´)">
        <input id="fDept" placeholder="ÈÉ®ÈñÄ (ÂøÖÂ°´)">
        <select id="fPay">
          <option value="ÁèæÈáë">ÁèæÈáë</option>
          <option value="‰ø°Áî®Âç°">‰ø°Áî®Âç°</option>
          <option value="Ëñ™Ë≥áÊâ£Ê¨æ">Ëñ™Ë≥áÊâ£Ê¨æ</option>
          <option value="ÂåØÊ¨æ">ÂåØÊ¨æ</option>
        </select>
        <input id="fNote" placeholder="ÂÇôË®ª">
      </div>
      <div class="btn-bar">
        <button class="btn-clear" onclick="clearCart()"><span class="material-icons-round">delete_outline</span></button>
        <button class="btn-submit" onclick="submitOrder()">Á¢∫Ë™çË®ÇË≥º</button>
      </div>
      <div id="warnMsg" style="color:#ef5350;font-size:13px;text-align:center;margin-top:10px;display:none;font-weight:700;background:#ffebee;padding:8px;border-radius:8px;"></div>
    </div>
  </div>
</div>

<div id="bundleModal" class="modal">
  <div class="m-box">
    <div class="m-head">‰ªªÈÅ∏ 2 ‰ª∂ÂÖßÂÆπÁâ©</div>
    <div class="m-sub">Â∑≤ÈÅ∏Êìá <span id="mCount" style="color:var(--accent);font-weight:700">0</span> / 2 ‰ª∂</div>
    <div class="m-grid" id="mGrid"></div>
    <div class="m-acts">
      <button class="m-btn" style="background:#f5f5f5;color:#546e7a" onclick="closeBundle()">ÂèñÊ∂à</button>
      <button id="mConfirmBtn" class="m-btn disabled" style="background:var(--primary);color:#fff" onclick="confirmBundle()">Á¢∫Ë™çÈÅ∏Âèñ</button>
    </div>
  </div>
</div>

<script>
// --- Config ---
const SHEET_P = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQBtV8q3Ank7Bnhs83IbOb97U46juV-RKeL3NpdFiNcSu-ifI21fQYo1-io62S3JIrXEO5MiDArc1Lr/pub?gid=1623055155&single=true&output=csv";
const SHEET_R = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQU95r9_TOPlQXY-lcBS_RH3tRc0mtRyuazxHHWljpRusbzBiWsEfm3Pa_HZmKW5Ob5TOq4W5O-vumI/pub?gid=2071879068&single=true&output=csv";
const PROXY = (url) => "https://corsproxy.io/?" + encodeURIComponent(url);

let PRODUCTS = [], RULES = {}, CART = [], SELECTED_BUNDLE = new Map();
let PRODUCT_MAP = new Map(); 
let currentCat = "", categories = [];
let modalPid = null, isCartOpen = false;
let tempBundleSelection = [];

// --- UX: Toasts ---
function showToast(msg, type='normal') {
  const c = document.getElementById('toast-container');
  const t = document.createElement('div');
  t.className = 'toast';
  let icon = type === 'warn' ? 'error_outline' : 'check_circle';
  t.innerHTML = `<span class="material-icons-round" style="color:${type==='warn'?'#ff5252':'#69f0ae'}">${icon}</span> ${msg}`;
  c.appendChild(t);
  setTimeout(() => t.remove(), 2500);
}

// --- UX: Flying Animation ---
function animateFly(startEl) {
  const rect = startEl.getBoundingClientRect();
  const target = document.querySelector('.fb-btn').getBoundingClientRect();
  
  const fly = document.createElement('img');
  // Try to find image in card
  const imgEl = startEl.closest('.p-card').querySelector('img');
  fly.src = imgEl ? imgEl.src : ''; 
  if(!fly.src) return; // Skip if no image
  
  fly.className = 'flying-img';
  fly.style.top = rect.top + 'px';
  fly.style.left = rect.left + 'px';
  document.body.appendChild(fly);
  
  setTimeout(() => {
    fly.style.top = target.top + 'px';
    fly.style.left = target.left + 'px';
    fly.style.width = '20px';
    fly.style.height = '20px';
    fly.style.opacity = '0';
  }, 10);
  
  setTimeout(() => fly.remove(), 500);
}

async function initApp() {
  try {
    const [pText, rText] = await Promise.all([
      fetch(PROXY(SHEET_P)).then(r => r.text()),
      fetch(PROXY(SHEET_R)).then(r => r.text())
    ]);

    const pData = Papa.parse(pText, { header: true, skipEmptyLines: true }).data;
    PRODUCTS = pData.map((row, i) => {
      const pick = (k) => row[Object.keys(row).find(key => key.toLowerCase() === k.toLowerCase())] || "";
      const name = pick("product_name");
      if(!name) return null;

      const isGift = pick("is_gift").toLowerCase();
      if(isGift === 'true' || isGift.includes('ÊòØ')) {
        PRODUCT_MAP.set(pick("product_code"), { name, price: 0 }); 
        return null;
      }

      let bundle = [];
      for(let k=1; k<=4; k++) {
        let sn = pick(`spec_${k}`);
        let sq = Number(pick(`spec_${k}_qty`)||1);
        if(sn) bundle.push({ name: sn, qty: sq });
      }

      const p = {
        _id: i,
        code: pick("product_code"),
        name: name,
        category: pick("category").trim(),
        price: Number((pick("list_price")||"0").replace(/,/g,'')),
        spec: pick("spec"),
        photo: pick("photos url"),
        bundle: bundle
      };
      
      if(p.code) PRODUCT_MAP.set(p.code, p);
      return p;
    }).filter(x => x);

    const rData = Papa.parse(rText, { header: true, skipEmptyLines: true }).data;
    RULES = { tiers: [], bogo: [], spend: [], bundle: [] };
    
    rData.forEach(row => {
      const pick = (k) => row[Object.keys(row).find(key => key.toLowerCase() === k.toLowerCase())] || "";
      const type = pick("rule_type").toLowerCase();
      
      if(type.includes("tier")) {
        RULES.tiers.push({ zone: pick("zone").trim(), min: Number(pick("min_qty")), pct: Number(pick("percent_off")) });
      } else if(type.includes("bogo")) {
        RULES.bogo.push({ code: pick("product_code"), buy: Number(pick("buy")), get: Number(pick("get")) });
      } else if(type.includes("spend")) {
        RULES.spend.push({ 
          scope: pick("threshold_scope"), prefix: pick("zone_prefix"), 
          amt: Number(pick("threshold_amount")), gift: pick("gift_code"), 
          qty: Number(pick("gift_qty")), mult: pick("multiples").toUpperCase()==="TRUE" 
        });
      } else if(type.includes("bundle")) {
        RULES.bundle.push({ code: pick("product_code"), price: Number(pick("unit_price")) });
      }
    });

    renderUI();
    document.getElementById("loader").style.opacity = 0;
    setTimeout(()=>document.getElementById("loader").remove(), 300);

  } catch(e) {
    alert("ÈÄ£Á∑öÁï∞Â∏∏ÔºåË´ãÁ®çÂæåÈáçË©¶„ÄÇ\n" + e.message);
  }
}

function renderUI() {
  const nav = document.getElementById("catNav");
  categories = [...new Set(PRODUCTS.map(p => p.category))].filter(Boolean);
  
  const allPill = document.createElement("div");
  allPill.className = "cat-pill active";
  allPill.innerText = "ÂÖ®ÈÉ®ÂïÜÂìÅ";
  allPill.onclick = () => setCategory("");
  nav.appendChild(allPill);

  categories.forEach(c => {
    const pill = document.createElement("div");
    pill.className = "cat-pill";
    pill.innerText = c.split(/[\s_]/)[0];
    pill.onclick = () => setCategory(c);
    nav.appendChild(pill);
  });

  renderList();
  
  const listEl = document.querySelector("main");
  let ts = 0;
  listEl.addEventListener('touchstart', (e) => { ts = e.changedTouches[0].screenX; }, {passive: true});
  listEl.addEventListener('touchend', (e) => {
    let te = e.changedTouches[0].screenX;
    if (Math.abs(ts - te) > 60) { 
      let idx = categories.indexOf(currentCat);
      if (te < ts) { 
        if (currentCat === "") setCategory(categories[0]);
        else if (idx < categories.length - 1) setCategory(categories[idx+1]);
      } else { 
        if (idx > 0) setCategory(categories[idx-1]);
        else setCategory("");
      }
    }
  }, {passive: true});
}

function renderList() {
  const grid = document.getElementById("list");
  grid.innerHTML = "";
  const q = document.getElementById("searchInp").value.toLowerCase().trim();
  
  const filtered = PRODUCTS.filter(p => {
    if(currentCat && p.category !== currentCat) return false;
    if(q && !p.name.toLowerCase().includes(q) && !p.code.toLowerCase().includes(q)) return false;
    return true;
  });

  document.getElementById("empty-state").style.display = filtered.length === 0 ? "block" : "none";

  filtered.forEach(p => {
    const inCart = CART.find(x => x._id === p._id);
    const qty = inCart ? inCart.qty : 0;
    
    let badges = "";
    if(p.category.includes("Âä†ÂÉπË≥º")) badges += `<span class="badge bg-red">Âä†ÂÉπË≥º</span>`;
    if(RULES.bogo.some(b => b.code === p.code)) badges += `<span class="badge bg-blue">Ë≤∑‰∏ÄÈÄÅ‰∏Ä</span>`;
    if(p.name.includes("‰ªªÈÅ∏")) badges += `<span class="badge bg-gold">ÂÑ™ÊÉ†ÁµÑÂêà</span>`;
    if(RULES.tiers.some(t => p.category.includes(t.zone))) badges += `<span class="badge bg-purple">Â§ö‰ª∂ÂÑ™ÊÉ†</span>`;

    let actionBtn = "";
    if(p.bundle.length >= 2 && p.name.includes("‰ªªÈÅ∏")) {
      const hasSel = SELECTED_BUNDLE.has(p._id);
      actionBtn = `<div class="btn-bundle" onclick="openBundle(${p._id})">
        ${hasSel ? "ÂÖßÂÆπÂ∑≤ÈÅ∏ ‚úì" : "ÈÅ∏ÊìáÂÖßÂÆπÁâ©"}
      </div>`;
    }

    let imgHtml = `<div class="p-no-img"><span class="material-icons-round" style="font-size:32px">image_not_supported</span>ÁÑ°ÂúñÁâá</div>`;
    if(p.photo && p.photo.length > 5) {
      imgHtml = `<img src="${p.photo}" onload="this.classList.add('loaded')" onerror="this.style.display='none';this.parentElement.innerHTML='<div class=\'p-no-img\'>Êö´ÁÑ°ÂúñÁâá</div>'">`;
    }

    const card = document.createElement("div");
    card.className = "p-card";
    card.innerHTML = `
      <div class="p-img-box">
        <div class="badges">${badges}</div>
        ${imgHtml}
      </div>
      <div class="p-body">
        <div>
          <div class="p-title">${p.name}</div>
          <div class="p-code">${p.code}</div>
        </div>
        <div>
          <div class="p-price-row"><span class="p-price">$${p.price.toLocaleString()}</span></div>
          ${actionBtn}
          <div class="stepper">
            <div class="s-btn ${qty===0?'hidden':''}" onclick="window.updateQty(this, ${p._id}, -1)">Ôºç</div>
            <div class="s-val ${qty===0?'hidden':''}">${qty}</div>
            <div class="s-btn add" onclick="window.updateQty(this, ${p._id}, 1)">Ôºã</div>
          </div>
        </div>
      </div>
    `;
    grid.appendChild(card);
  });
}

function setCategory(cat) {
  currentCat = cat;
  document.querySelectorAll(".cat-pill").forEach(el => {
    el.classList.toggle("active", el.innerText === (cat.split(/[\s_]/)[0] || "ÂÖ®ÈÉ®ÂïÜÂìÅ"));
  });
  const activePill = document.querySelector(".cat-pill.active");
  if(activePill) activePill.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
  renderList();
  window.scrollTo({top: 0, behavior: 'smooth'});
}

/* ================= MODAL ================= */
function openBundle(pid) {
  modalPid = pid;
  const p = PRODUCTS.find(x => x._id === pid);
  const grid = document.getElementById("mGrid");
  grid.innerHTML = "";
  
  tempBundleSelection = SELECTED_BUNDLE.has(pid) ? [...SELECTED_BUNDLE.get(pid)] : [];
  updateModalUI();
  
  p.bundle.forEach((b, idx) => {
    const row = document.createElement("div");
    row.className = "m-row";
    row.dataset.idx = idx;
    
    row.innerHTML = `
      <div style="flex:1">
        <div class="m-name">${b.name}</div>
        <div style="font-size:12px;color:#90a4ae">Ë¶èÊ†º: ${b.qty}</div>
      </div>
      <div class="m-ctrl">
        <div class="m-btn-s minus">Ôºç</div>
        <div class="m-val">0</div>
        <div class="m-btn-s plus">Ôºã</div>
      </div>
    `;
    
    row.querySelector(".minus").onclick = () => modifyTemp(idx, -1);
    row.querySelector(".plus").onclick = () => modifyTemp(idx, 1);
    grid.appendChild(row);
  });
  
  updateModalCounts();
  document.getElementById("bundleModal").classList.add("open");
}

function modifyTemp(idx, delta) {
  if (delta > 0) {
    if (tempBundleSelection.length < 2) tempBundleSelection.push(idx);
  } else {
    const i = tempBundleSelection.indexOf(idx);
    if (i > -1) tempBundleSelection.splice(i, 1);
  }
  updateModalUI();
  updateModalCounts();
}

function updateModalUI() {
  document.getElementById("mCount").innerText = tempBundleSelection.length;
  const btn = document.getElementById("mConfirmBtn");
  if (tempBundleSelection.length === 2) {
    btn.classList.remove("disabled");
    btn.innerText = "Á¢∫Ë™çÈÅ∏Âèñ";
  } else {
    btn.classList.add("disabled");
    btn.innerText = `ÈÇÑÂ∑Æ ${2 - tempBundleSelection.length} ‰ª∂`;
  }
}

function updateModalCounts() {
  const rows = document.getElementById("mGrid").children;
  Array.from(rows).forEach(row => {
    const idx = parseInt(row.dataset.idx);
    const count = tempBundleSelection.filter(x => x === idx).length;
    row.querySelector(".m-val").innerText = count;
    if(count > 0) row.style.borderColor = "var(--primary)";
    else row.style.borderColor = "#eceff1";
  });
}

function confirmBundle() {
  if (tempBundleSelection.length !== 2) return;
  SELECTED_BUNDLE.set(modalPid, [...tempBundleSelection]);
  
  let item = CART.find(x => x._id === modalPid);
  if (!item) window.updateQty(null, modalPid, 1);
  else { refreshCart(); renderList(); }
  
  closeBundle();
}

function closeBundle() { document.getElementById("bundleModal").classList.remove("open"); }

/* ================= CART ENGINE ================= */
window.updateQty = (btnEl, pid, delta) => {
  const p = PRODUCTS.find(x => x._id === pid);
  if(!p) return;

  // Add-on Logic
  if(delta > 0 && p.category.includes("Âä†ÂÉπË≥º")) {
    const mainCount = CART.reduce((acc, it) => acc + (!it.category.includes("Âä†ÂÉπË≥º") ? it.qty : 0), 0);
    if(mainCount === 0) {
      showToast("Ë´ãÂÖàÈÅ∏Ë≥º‰∏ªÂïÜÂìÅÔºåÊâçËÉΩÂä†Ë≥ºÂñîÔºÅ", "warn");
      return;
    }
  }

  if(delta > 0 && p.bundle.length >= 2 && p.name.includes("‰ªªÈÅ∏")) {
    if(!SELECTED_BUNDLE.has(pid) || SELECTED_BUNDLE.get(pid).length !== 2) {
      openBundle(pid); return;
    }
  }

  let item = CART.find(x => x._id === pid);
  if(!item && delta > 0) { item = { ...p, qty: 0 }; CART.push(item); }
  
  if(item) {
    item.qty += delta;
    if(item.qty <= 0) CART = CART.filter(x => x._id !== pid);
  }
  
  if(delta > 0 && btnEl) animateFly(btnEl);
  if(delta > 0) showToast("Â∑≤Âä†ÂÖ•Ë≥ºÁâ©Ëªä");

  refreshCart();
  renderList();
  
  const fab = document.getElementById("float-bar");
  fab.classList.remove("show");
  void fab.offsetWidth; 
  if(CART.length > 0) fab.classList.add("show");
}

function clearCart() {
  if(confirm("Á¢∫ÂÆöË¶ÅÊ∏ÖÁ©∫Ë≥ºÁâ©ËªäÂóéÔºü")) {
    CART = [];
    SELECTED_BUNDLE.clear();
    refreshCart();
    renderList();
    closeCart();
    showToast("Ë≥ºÁâ©ËªäÂ∑≤Ê∏ÖÁ©∫");
  }
}

function calcCart() {
  let subTotal = 0, finalTotal = 0, beautyTotal = 0, discountAmt = 0;
  let warnings = [];
  
  let catCounts = {};
  CART.forEach(it => {
    const matchedRule = RULES.tiers.find(r => it.category.includes(r.zone));
    if(matchedRule) {
       const zone = matchedRule.zone;
       catCounts[zone] = (catCounts[zone] || 0) + it.qty;
    }
  });

  const processedItems = CART.map(it => {
    const originalLine = it.price * it.qty;
    subTotal += originalLine;
    let finalLine = originalLine;
    let tags = [];

    // Bundle
    const bundleRule = RULES.bundle.find(b => b.code === it.code);
    if(bundleRule && bundleRule.price < it.price) {
      finalLine = bundleRule.price * it.qty;
      const saved = (it.price - bundleRule.price) * it.qty;
      tags.push({ text: `ÁèæÁúÅ $${saved.toLocaleString()}`, cls: "save" });
    }
    // Tier
    else {
      const matchedRule = RULES.tiers.find(r => it.category.includes(r.zone));
      if(matchedRule) {
         const zone = matchedRule.zone;
         const tierRules = RULES.tiers.filter(r => r.zone === zone).sort((a,b) => b.min - a.min);
         const tier = tierRules.find(t => catCounts[zone] >= t.min);
         
         if(tier) {
           finalLine = originalLine * ((100 - tier.pct) / 100);
           tags.push({ text: `Â∑≤‰∫´ ${100-tier.pct} Êäò`, cls: "save" });
         }
      }
    }

    // BOGO
    const bogo = RULES.bogo.find(b => b.code === it.code);
    if(bogo) {
      const set = bogo.buy + bogo.get;
      const free = Math.floor(it.qty/set) * bogo.get;
      finalLine -= free * it.price;
      if(free > 0) tags.push({ text: `Ë≤∑${bogo.buy}ÈÄÅ${bogo.get}`, cls: "save" });
      if(it.qty % set !== 0) {
        tags.push({ text: `Êú™ÊπäÊªøÂÑ™ÊÉ† (ÂÜçÈÅ∏ ${set - (it.qty%set)} ‰ª∂)`, cls: "warn" });
        warnings.push(`${it.name}`);
      }
    }

    finalTotal += finalLine;
    if(it.category.includes("ÁæéÂÆπ")) beautyTotal += finalLine;

    return { ...it, finalLine, tags };
  });

  discountAmt = subTotal - finalTotal;

  // Gifts
  const gifts = [];
  RULES.spend.forEach(r => {
    let basis = r.scope === "zone_prefix" ? beautyTotal : finalTotal;
    if(r.scope === "zone_prefix" && r.prefix && !r.prefix.includes("ÁæéÂÆπ")) basis = 0; 

    if(basis >= r.amt) {
      let qty = r.mult ? Math.floor(basis / r.amt) * r.qty : r.qty;
      if(qty > 0) {
        let gName = r.gift;
        if(PRODUCT_MAP.has(r.gift)) gName = PRODUCT_MAP.get(r.gift).name;
        gName = gName.replace(/^(Ë¥àÂìÅ|Ë¥à|Gift)[:\s|ÔΩú_]*/i, "");
        gifts.push({ name: gName, qty: qty });
      }
    }
  });

  return { items: processedItems, subTotal, finalTotal, discountAmt, beautyTotal, gifts, warnings };
}

function refreshCart() {
  const data = calcCart();
  const list = document.getElementById("cartList");
  list.innerHTML = "";

  document.querySelector(".fb-total").innerText = "$" + Math.round(data.finalTotal).toLocaleString();
  document.querySelector(".fb-count").innerText = CART.reduce((a,b)=>a+b.qty,0) + " ‰ª∂";

  data.items.forEach(it => {
    let specStr = it.spec;
    if(it.bundle.length > 0) {
       if(it.name.includes("‰ªªÈÅ∏") && SELECTED_BUNDLE.has(it._id)) {
          const idxs = SELECTED_BUNDLE.get(it._id);
          specStr = `ÁµÑÂêàÔºö${it.bundle[idxs[0]]?.name}„ÄÅ${it.bundle[idxs[1]]?.name}`;
       } else if (!it.name.includes("‰ªªÈÅ∏")) {
          specStr = it.bundle.map(b => `${b.name}x${b.qty}`).join("„ÄÅ");
       }
    }

    const div = document.createElement("div");
    div.className = "c-item";
    let tags = it.tags.map(t => `<span class="c-tag ${t.cls}">${t.text}</span>`).join("");
    
    let priceHtml = `$${Math.round(it.finalLine).toLocaleString()}`;
    if(it.finalLine < it.price * it.qty) {
        priceHtml = `<span class="c-old">$${(it.price*it.qty).toLocaleString()}</span> $${Math.round(it.finalLine).toLocaleString()}`;
    }

    div.innerHTML = `
      <div class="c-info">
        <div class="c-title">${it.name}</div>
        <div class="c-spec">${specStr || ''}</div>
        <div class="c-tags">${tags}</div>
        <div class="c-price-box">${priceHtml}</div>
      </div>
      <div class="c-ctrl">
        <div class="stepper">
          <div class="s-btn" onclick="window.updateQty(this, ${it._id}, -1)">Ôºç</div>
          <div class="s-val">${it.qty}</div>
          <div class="s-btn add" onclick="window.updateQty(this, ${it._id}, 1)">Ôºã</div>
        </div>
      </div>
    `;
    list.appendChild(div);
  });

  document.getElementById("sumBase").innerText = "$" + data.subTotal.toLocaleString();
  document.getElementById("sumDisc").innerText = "-$" + Math.round(data.discountAmt).toLocaleString();
  document.getElementById("sumPay").innerText = "$" + Math.round(data.finalTotal).toLocaleString();
  document.getElementById("sumBeauty").innerText = "$" + Math.round(data.beautyTotal).toLocaleString();

  const warnEl = document.getElementById("warnMsg");
  if(data.warnings.length > 0) {
    warnEl.style.display = "block";
    warnEl.innerText = "‚ö†Ô∏è " + [...new Set(data.warnings)].join("„ÄÅ");
  } else {
    warnEl.style.display = "none";
  }

  const next = RULES.spend.find(r => r.scope === "all" && r.amt > data.finalTotal);
  if(next) {
    document.getElementById("promoBar").style.display = "flex";
    let gName = PRODUCT_MAP.has(next.gift) ? PRODUCT_MAP.get(next.gift).name : next.gift;
    gName = gName.replace(/^(Ë¥àÂìÅ|Ë¥à|Gift)[:\s|ÔΩú_]*/i, "");
    document.getElementById("promoTxt").innerText = `ÂÜçË≤∑ $${(next.amt - data.finalTotal).toLocaleString()} Ë¥à ${gName}`;
  } else {
    document.getElementById("promoBar").style.display = "none";
  }

  const finalList = document.getElementById("finalList");
  let sumHtml = "";
  data.items.forEach(i => sumHtml += `<div class="sum-line"><span>${i.name}</span><span>x${i.qty}</span></div>`);
  data.gifts.forEach(g => sumHtml += `<div class="sum-line" style="color:#e65100"><span>üéÅ ${g.name}</span><span>x${g.qty}</span></div>`);
  finalList.innerHTML = sumHtml;
}

window.openCart = () => {
  if(CART.length === 0) return;
  document.getElementById("drawer").classList.add("open");
  isCartOpen = true;
  history.pushState({modal: true}, null, "");
};

window.closeCart = () => {
  document.getElementById("drawer").classList.remove("open");
  isCartOpen = false;
  if(history.state && history.state.modal) history.back();
};

window.onpopstate = (e) => {
  if(isCartOpen) {
    document.getElementById("drawer").classList.remove("open");
    isCartOpen = false;
  }
};

window.onbeforeunload = (e) => {
  if(CART.length > 0) return "Ë®ÇÂñÆÂ∞öÊú™ÈÄÅÂá∫";
};

document.getElementById("searchInp").addEventListener("input", renderList);

window.toggleSum = () => {
  const b = document.getElementById("finalList");
  const i = document.getElementById("sumIcon");
  if(b.classList.contains("open")) {
    b.classList.remove("open");
    i.innerText = "expand_more";
  } else {
    b.classList.add("open");
    i.innerText = "expand_less";
  }
};

window.submitOrder = () => {
  const f = (id) => document.getElementById(id).value;
  if(!f("fName") || !f("fDept")) { showToast("Ë´ãÂ°´ÂØ´ÂßìÂêçËàáÈÉ®ÈñÄ", "warn"); return; }
  
  const data = calcCart();
  if(data.warnings.length > 0 && !confirm("Â∞öÊúâÂÑ™ÊÉ†Êú™ÊπäÊªøÔºåÁ¢∫ÂÆöË¶ÅÈÄÅÂá∫ÂóéÔºü")) return;

  let csv = "\uFEFFË®ÇË≥º‰∫∫,ÈÉ®ÈñÄ,‰ªòÊ¨æÊñπÂºè,ÂÇôË®ª,ÂïÜÂìÅ‰ª£Ëôü,ÂïÜÂìÅÂêçÁ®±,Ë¶èÊ†º,Êï∏Èáè,ÂéüÂÉπ,ÊäòÊâ£ÂæåÂ∞èË®à\n";
  const meta = `${f("fName")},${f("fDept")},${f("fPay")},${f("fNote")}`;
  
  data.items.forEach(it => {
    let spec = it.spec || "";
    if(it.bundle.length > 0) {
       if(it.name.includes("‰ªªÈÅ∏")) {
          const s = SELECTED_BUNDLE.get(it._id) || [0,1];
          spec = `[${it.bundle[s[0]]?.name}+${it.bundle[s[1]]?.name}]`;
       } else {
          spec = "[" + it.bundle.map(b=>b.name).join("+") + "]";
       }
    }
    csv += `${meta},${it.code},"${it.name}","${spec}",${it.qty},${it.price},${Math.round(it.finalLine)}\n`;
  });
  
  data.gifts.forEach(g => csv += `${meta},GIFT,"[Ë¥àÂìÅ] ${g.name}","",${g.qty},0,0\n`);

  const a = document.createElement("a");
  a.href = URL.createObjectURL(new Blob([csv], {type: "text/csv"}));
  a.download = `Ë®ÇÂñÆ_${f("fName")}.csv`;
  a.click();
  
  CART = []; SELECTED_BUNDLE.clear(); 
  refreshCart(); closeCart(); renderList();
  showToast("Ë®ÇÂñÆÂ∑≤ÂåØÂá∫ÔºÅ");
};

initApp();
</script>
</body>
</html>