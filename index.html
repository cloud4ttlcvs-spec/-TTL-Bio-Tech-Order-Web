<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover"/>
<title>ÁîüÊäÄÂ±ïË®ÇË≥ºÁ≥ªÁµ± V29 - Optimized</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&family=Roboto:wght@500;700;900&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

<style>
/* --- CORE VARIABLES --- */
:root {
  --primary: #00897b; --primary-light: #e0f2f1; --accent: #ff6f00; 
  --beauty: #d81b60; 
  --bg-body: #f8f9fa; --bg-card: #ffffff; --text-main: #263238; --text-sub: #546e7a;
  --border: #eceff1; --header-height: 105px; /* Á∑äÁ∏Æ Header È´òÂ∫¶ */
  --shadow-card: 0 4px 20px rgba(0,0,0,0.04);
  --safe-bottom: env(safe-area-inset-bottom, 20px);
}
* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
body {
  font-family: 'Noto Sans TC', sans-serif; background: var(--bg-body); color: var(--text-main);
  margin: 0; padding: 0; 
  padding-bottom: calc(120px + var(--safe-bottom)); 
  overscroll-behavior-y: none;
}
body.modal-open { overflow: hidden; height: 100vh; position: fixed; width: 100%; }

@media (max-width: 768px) {
  input, select, textarea { font-size: 16px !important; }
}

/* --- OPTIMIZATION: Natural Flying Animation --- */
.flying-img { 
  position: fixed; z-index: 9999; pointer-events: none; border-radius: 50%; 
  box-shadow: 0 5px 25px rgba(0,0,0,0.25); 
  width: 60px; height: 60px; object-fit: cover; background: #fff; border: 2px solid #fff;
  transition: top 1s cubic-bezier(0.19, 1, 0.22, 1), 
              left 1s cubic-bezier(0.19, 1, 0.22, 1), 
              transform 1s ease-in, 
              opacity 1s ease-in;
}

.p-img-box { 
  width: 100%; aspect-ratio: 1/1; 
  background: #fcfcfc; 
  position: relative; display: flex; align-items: center; justify-content: center; overflow: hidden; 
}
.p-img-box img { 
  width: 100%; height: 100%; object-fit: contain; 
  transition: opacity 0.4s ease; opacity: 0; 
  mix-blend-mode: multiply; 
}
.p-img-box img.loaded { opacity: 1; }

/* --- FIX: WELCOME & LOADER --- */
#welcome-overlay, #loader {
  position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
  display: flex; align-items: center; justify-content: center;
}
#welcome-overlay { z-index: 9999; background: rgba(236, 239, 241, 0.85); backdrop-filter: blur(8px); transition: opacity 0.5s ease; }
#loader { z-index: 9990; background: #f4f6f8; align-items: flex-start; padding-top: 120px; transition: opacity 0.3s ease; }
#welcome-overlay.fade-out { opacity: 0; pointer-events: none; }

/* --- LAYOUT --- */
main { padding: 12px; max-width: 900px; margin: 0 auto; margin-top: 10px; }
.grid-layout { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 12px; align-content: start; width: 100%; }
@media (max-width: 480px) { .grid-layout { grid-template-columns: repeat(2, 1fr) !important; gap: 10px; } }

/* Ranking UI */
#ranking-section { background: #fff; margin: 10px 12px 20px; padding: 12px; border-radius: 16px; border: 1px solid #eceff1; box-shadow: 0 4px 15px rgba(0,0,0,0.03); display: none; }
.rank-head { padding: 0 4px 8px; display: flex; align-items: center; gap: 12px; overflow: hidden; }
.rank-title { font-size: 15px; font-weight: 900; color: #d81b60; white-space: nowrap; flex-shrink: 0; display: flex; align-items: center; gap: 4px; }
.rank-tabs { display: flex; gap: 8px; overflow-x: auto; scrollbar-width: none; flex: 1; mask-image: linear-gradient(to right, black 85%, transparent 100%); -webkit-mask-image: linear-gradient(to right, black 85%, transparent 100%); }
.rank-tabs::-webkit-scrollbar { display: none; }
.r-tab { font-size: 12px; font-weight: 500; color: #90a4ae; cursor: pointer; white-space: nowrap; padding: 4px 10px; border-radius: 20px; background: #f5f5f5; transition: 0.2s; }
.r-tab.active { color: #fff; background: #d81b60; font-weight: 700; box-shadow: 0 2px 5px rgba(216, 27, 96, 0.3); }
.rank-list { display: flex; gap: 10px; padding: 4px 0 8px; overflow-x: auto; scroll-behavior: smooth; scrollbar-width: none; -ms-overflow-style: none; }
.rank-list::-webkit-scrollbar { display: none; }
.r-card { flex: 0 0 76px; display: flex; flex-direction: column; align-items: center; gap: 6px; cursor: pointer; transition: transform 0.1s; }
.r-card:active { transform: scale(0.96); }
.r-img-wrap { width: 76px; height: 76px; border-radius: 14px; background: #fff; border: 1px solid #eee; position: relative; padding: 2px; box-shadow: 0 2px 6px rgba(0,0,0,0.03); overflow: hidden; }
.r-img { width: 100%; height: 100%; object-fit: contain; mix-blend-mode: multiply; }
.r-badge { position: absolute; top: 0; left: 0; width: 22px; height: 22px; border-bottom-right-radius: 8px; background: rgba(0,0,0,0.7); color: #fff; font-size: 11px; font-weight: 900; display: flex; align-items: center; justify-content: center; z-index: 2; }
.r-card[data-rank="1"] .r-badge { background: #ffd700; color: #3e2723; }
.r-card[data-rank="2"] .r-badge { background: #cfd8dc; color: #37474f; }
.r-card[data-rank="3"] .r-badge { background: #d7ccc8; color: #3e2723; }
.r-sold-tag { position: absolute; bottom: 3px; right: 3px; background: linear-gradient(135deg, #ff7043, #f4511e); color: #fff; font-size: 9px; font-weight: 700; padding: 2px 6px; border-radius: 8px; box-shadow: 0 2px 4px rgba(244, 81, 30, 0.2); z-index: 2; }
.r-name { font-size: 10px; font-weight: 500; color: #37474f; text-align: center; line-height: 1.3; height: 2.6em; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; width: 100%; }

/* --- Float Bar & Buttons --- */
#float-bar { 
  position: fixed; 
  bottom: calc(20px + var(--safe-bottom)); 
  left: 16px; right: 16px; 
  background: #263238; color: #fff; border-radius: 60px; 
  padding: 10px 10px 10px 24px; box-shadow: 0 15px 35px rgba(0,0,0,0.25); 
  display: flex; align-items: center; justify-content: space-between; 
  z-index: 2000 !important; cursor: pointer; backdrop-filter: blur(10px); 
  transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}
#float-bar.hidden { transform: translateY(200%); }
.fb-total { font-size: 18px; font-weight: 700; }
.fb-count { font-size: 12px; opacity: 0.7; }
.fb-btn { 
  background: var(--accent); color: #fff; padding: 10px 24px; border-radius: 40px; 
  font-weight: 700; font-size: 15px; box-shadow: 0 4px 15px rgba(255,111,0,0.4); 
  display: flex; align-items: center; gap: 6px; transition: 0.1s;
}
.fb-btn:active { background: #e65100; transform: scale(0.98); }

#gift-fab {
  position: fixed; bottom: calc(90px + var(--safe-bottom)); left: 20px;
  width: 50px; height: 50px; border-radius: 50%;
  background: #fff; border: 2px solid #ffd54f;
  box-shadow: 0 4px 15px rgba(255, 160, 0, 0.3);
  display: flex; align-items: center; justify-content: center;
  font-size: 24px; cursor: pointer; z-index: 1090;
  transition: transform 0.2s;
  display: none; 
}
#gift-fab:active { transform: scale(0.9); }
@keyframes shakeGift { 0% { transform: rotate(0deg); } 25% { transform: rotate(-15deg); } 50% { transform: rotate(15deg); } 75% { transform: rotate(-15deg); } 100% { transform: rotate(0deg); } }
.gift-shake { animation: shakeGift 0.5s ease-in-out 2; box-shadow: 0 0 20px rgba(255, 193, 7, 0.8) !important; }

#back-to-top {
  position: fixed; bottom: calc(90px + var(--safe-bottom)); right: 20px; 
  width: 45px; height: 45px; border-radius: 50%;
  background: rgba(255, 255, 255, 0.9); color: var(--primary);
  box-shadow: 0 4px 12px rgba(0,0,0,0.15); border: 1px solid #eee;
  display: flex; align-items: center; justify-content: center;
  z-index: 1090; cursor: pointer; opacity: 0; pointer-events: none;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); transform: translateY(20px);
}
#back-to-top.show { opacity: 1; pointer-events: auto; transform: translateY(0); }

/* --- Top Notification --- */
#top-notify {
  position: fixed; top: 16px; left: 16px; right: 16px;
  background: rgba(33, 33, 33, 0.95); color: #fff;
  padding: 12px 20px; border-radius: 16px; 
  display: flex; flex-direction: column; gap: 4px;
  box-shadow: 0 8px 30px rgba(0,0,0,0.3); 
  z-index: 3000; transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1), opacity 0.4s;
  backdrop-filter: blur(8px);
  transform: translateY(-150%); opacity: 0; pointer-events: none;
}
#top-notify.show { transform: translateY(0); opacity: 1; pointer-events: auto; }
.tn-head { display: flex; align-items: center; gap: 8px; font-weight: 700; color: #ffd54f; font-size: 14px; margin-bottom: 2px; }
.tn-body { font-size: 13px; line-height: 1.5; color: #fff; white-space: normal; }

/* --- Milestone Card --- */
#milestone-overlay {
  position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 3000;
  display: flex; align-items: center; justify-content: center;
  opacity: 0; pointer-events: none; transition: opacity 0.3s; backdrop-filter: blur(2px);
}
#milestone-overlay.open { opacity: 1; pointer-events: auto; }
.ms-card-v {
  background: #fff; width: 95%; max-width: 400px; 
  border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.25); 
  display: flex; flex-direction: column; overflow: hidden;
  max-height: 85vh; transform: scale(0.9); transition: transform 0.3s;
}
#milestone-overlay.open .ms-card-v { transform: scale(1); }
.ms-card-v.shrinking { animation: shrinkToFab 0.6s ease-in forwards; }
@keyframes shrinkToFab { 0% { transform: scale(1) translate(0, 0); opacity: 1; } 100% { transform: scale(0.1) translate(-120vw, 100vh); opacity: 0; } }

.ms-header { background: #fff; padding: 16px; border-bottom: 1px solid #eee; }
.ms-title-v { font-size: 18px; font-weight: 900; color: #37474f; margin-bottom: 10px; text-align: center; }
.ms-summary-row { display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; border-radius: 8px; margin-bottom: 6px; font-size: 13px; font-weight: 700; }
.ms-sum-all { background: #fff8e1; color: var(--accent); }
.ms-sum-beauty { background: #fce4ec; color: var(--beauty); }
.ms-dual-body { flex: 1; overflow-y: auto; padding: 10px; display: grid; grid-template-columns: 1fr 1fr; gap: 8px; background: #fafafa; overscroll-behavior: contain; }
.ms-track-col { display: flex; flex-direction: column; gap: 12px; position: relative; }
.ms-track-title { text-align: center; font-size: 12px; color: #90a4ae; font-weight: 700; margin-bottom: 4px; }
.ms-dual-item { background: #fff; border: 1px solid #eee; border-radius: 12px; padding: 10px; display: flex; flex-direction: column; align-items: center; gap: 6px; opacity: 0.5; transition: 0.3s; text-align: center; }
.ms-dual-item.active { opacity: 1; border-color: var(--accent); box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
.ms-track-col.beauty .ms-dual-item.active { border-color: var(--beauty); }
.ms-d-name { font-size: 11px; color: #37474f; line-height: 1.3; height: auto; min-height: 2.6em; overflow: visible; }
.ms-d-th { font-size: 10px; color: #fff; background: #bdbdbd; padding: 2px 6px; border-radius: 10px; font-weight: 700; }
.ms-dual-item.active .ms-d-th { background: var(--accent); }
.ms-track-col.beauty .ms-dual-item.active .ms-d-th { background: var(--beauty); }
.ms-footer { padding: 16px; border-top: 1px solid #eee; background: #fff; }
.ms-back-btn { width: 100%; padding: 12px; background: #f5f5f5; color: #546e7a; border: none; border-radius: 12px; font-weight: 700; font-size: 14px; cursor: pointer; }

/* FIX: Multi-Image CSS */
.g-img-row { display: flex; gap: 4px; align-items: center; }
.g-thumb { width: 40px; height: 40px; object-fit: contain; border: 1px solid #eee; border-radius: 6px; background: #fff; }

/* --- General --- */
.highlight { background-color: #fff176 !important; color: #212121 !important; font-weight: 900; border-radius: 2px; padding: 0 2px; }
.cat-section-title { font-size: 18px; font-weight: 900; color: var(--primary); padding: 16px 8px 8px; margin-top: 0; margin-bottom: 8px; border-bottom: 2px solid var(--primary-light); scroll-margin-top: 135px; }

/* --- V28 FIX: Overlay Flash Animation --- */
.p-card { 
  background: #fff; border-radius: 16px; overflow: hidden; position: relative; 
  box-shadow: var(--shadow-card); border: 1px solid #f0f0f0; 
  display: flex; flex-direction: column; transition: transform 0.15s; scroll-margin-top: 200px; 
}
.p-card::after {
  content: ''; position: absolute; inset: 0;
  background: rgba(255, 241, 118, 0.4);
  border-radius: 16px;
  opacity: 0; pointer-events: none; z-index: 10;
  transition: opacity 0.3s;
}
.flash-highlight::after {
  animation: flashOverlay 0.6s ease-in-out 2;
}
@keyframes flashOverlay {
  0%, 100% { opacity: 0; }
  50% { opacity: 1; border: 3px solid #fdd835; }
}

.p-card:active { transform: scale(0.97); }
.p-no-img { font-size: 12px; color: #b0bec5; display: flex; flex-direction: column; align-items: center; }
.badges { position: absolute; top: 8px; left: 8px; display: flex; flex-direction: column; gap: 4px; z-index: 2; align-items: flex-start; }
.badge { font-size: 10px; padding: 4px 8px; border-radius: 6px; color: #fff; font-weight: 700; box-shadow: 0 2px 6px rgba(0,0,0,0.2); letter-spacing: 0.5px; backdrop-filter: blur(4px); }
.bg-red { background: rgba(239, 83, 80, 0.95); }
.bg-blue { background: rgba(66, 165, 245, 0.95); }
.bg-gold { background: linear-gradient(135deg, #ffa726, #fb8c00); }
.bg-purple { background: rgba(171, 71, 188, 0.95); }
.bg-teal { background: #26a69a; }

.p-body { padding: 12px; flex: 1; display: flex; flex-direction: column; justify-content: space-between; }
.p-title { font-size: 14px; font-weight: 700; line-height: 1.4; color: #37474f; margin-bottom: 4px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; height: 40px; }
.p-code { font-size: 11px; color: #cfd8dc; margin-bottom: 8px; }
.p-price-row { display: flex; align-items: baseline; gap: 6px; margin-top: auto; }
.p-price { font-size: 17px; font-weight: 800; color: #263238; }

.stepper { display: flex; align-items: center; justify-content: flex-end; gap: 8px; margin-top: 10px; }
.s-btn { 
  width: 32px; height: 32px; border-radius: 50%; border: 1px solid #eceff1; background: #fff; color: var(--primary); 
  font-size: 20px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; position: relative;
}
.s-btn::after { content: ''; position: absolute; top: -10px; bottom: -10px; left: -10px; right: -10px; }
.s-btn:active { background: var(--primary-light); transform: scale(0.9); }
.s-btn.add { background: var(--primary); color: #fff; border-color: var(--primary); box-shadow: 0 2px 5px rgba(0,137,123,0.3); }
.s-val { width: 24px; text-align: center; font-size: 15px; font-weight: 600; color: #37474f; }
.s-btn.hidden, .s-val.hidden { display: none; }
.btn-bundle { width: 100%; margin-top: 8px; padding: 10px; border: 1px dashed var(--primary); border-radius: 10px; color: var(--primary); background: var(--primary-light); font-size: 13px; font-weight: 700; text-align: center; cursor: pointer; transition: 0.2s; }
.btn-bundle:active { transform: scale(0.98); background: #b2dfdb; }

/* Header & Nav */
header { position: sticky; top: 0; z-index: 1000; background: rgba(255,255,255,0.98); box-shadow: 0 2px 15px rgba(0,0,0,0.03); backdrop-filter: blur(12px); }
.search-wrap { padding: 8px 16px 0 16px; }
.search-box { position: relative; width: 100%; }
.search-box input { width: 100%; padding: 10px 12px 10px 42px; border-radius: 12px; border: 1px solid #e0e0e0; background: #f5f7f9; font-size: 15px; transition: 0.3s; }
.search-box input:focus { background: #fff; border-color: var(--primary); outline: none; box-shadow: 0 0 0 3px rgba(0,137,123,0.1); }
.search-box .icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-sub); }

/* --- OPTIMIZATION 2: Clear Search Button --- */
.clear-btn { 
  position: absolute; right: 10px; top: 50%; transform: translateY(-50%); 
  color: #90a4ae; cursor: pointer; font-size: 20px; padding: 4px; border-radius: 50%;
  display: none; /* Default Hidden */
}
.clear-btn:active { background: #eceff1; color: #546e7a; }

/* --- CAT WRAP V29: ÁΩÆ‰∏≠‰∏îÂº∑ÂåñË≥™ÊÑü (Êº∏Â±§ÈÅÆÁΩ©) --- */
.cat-wrap {
  position: relative;
  width: 100%;
  mask-image: linear-gradient(to right, transparent, black 10%, black 90%, transparent);
  -webkit-mask-image: linear-gradient(to right, transparent, black 10%, black 90%, transparent);
}
.cat-nav { 
  display: flex; gap: 8px; padding: 10px 20px; 
  overflow-x: auto; scrollbar-width: none; 
  justify-content: flex-start; /* ÊâãÊ©üÁ´ØÈÄöÂ∏∏Èù†Â∑¶ÊªëÂãïËºÉÈ†ÜÊâãÔºåPCÁ´ØÊúÉËá™ÁÑ∂Ê∫¢Âá∫ */
}
.cat-nav::-webkit-scrollbar { display: none; }
.cat-pill { 
  white-space: nowrap; padding: 8px 20px; border-radius: 24px; font-size: 14px; 
  font-weight: 500; color: var(--text-sub); background: #fff; border: 1px solid #e0e0e0; 
  cursor: pointer; transition: 0.25s cubic-bezier(0.25, 0.8, 0.25, 1);
  box-shadow: 0 2px 5px rgba(0,0,0,0.02);
}
.cat-pill.active { 
  background: var(--primary); color: #fff; border-color: var(--primary); 
  box-shadow: 0 4px 10px rgba(0,137,123,0.25); font-weight: 700; transform: scale(1.02); 
}

/* Drawer Core */
#drawer { position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 1200; pointer-events: none; }
#drawer-bg { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); opacity: 0; transition: 0.3s; backdrop-filter: blur(4px); }
#drawer-panel { position: absolute; top: 0; right: 0; bottom: 0; width: 100%; max-width: 480px; background: #fff; transform: translateX(100%); transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1); display: flex; flex-direction: column; pointer-events: auto; box-shadow: -5px 0 30px rgba(0,0,0,0.15); }
#drawer.open #drawer-bg { opacity: 1; pointer-events: auto; }
#drawer.open #drawer-panel { transform: translateX(0); }
.dr-head { padding: 16px 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: #fff; flex-shrink: 0; }
.dr-body { flex: 1; overflow-y: auto; padding: 12px; background: #f4f6f8; overscroll-behavior: contain; }

/* --- V29 Á∑äÁ∏Æ Footer Á©∫Èñì --- */
.dr-foot { 
  padding: 12px 16px; /* Âéü 20px */
  padding-bottom: calc(12px + var(--safe-bottom)); 
  background: #fff; border-top: 1px solid var(--border); 
  box-shadow: 0 -4px 20px rgba(0,0,0,0.05); flex-shrink: 0; 
}

.c-item { display: flex; gap: 10px; margin-bottom: 8px; padding: 8px 12px; background: #fff; border-radius: 10px; border: 1px solid #e0e0e0; box-shadow: 0 1px 2px rgba(0,0,0,0.02); align-items: center; }
.c-info { flex: 1; }
.c-title { font-size: 14px; margin-bottom: 2px; line-height: 1.3; font-weight: 700; color:#37474f; }
.c-spec { font-size: 12px; margin-bottom: 2px; color:#90a4ae; }
.c-price-box { margin-top: 2px; font-weight:700; font-size:15px; color:#263238; }
.c-old { text-decoration: line-through; color: #90a4ae; font-size: 12px; margin-right: 6px; }
.c-tags { margin-top: 2px; }
.c-tag { font-size: 11px; padding: 3px 8px; border-radius: 6px; font-weight: 600; display: inline-flex; align-items: center; gap: 4px; }
.c-tag.save { background: #fff3e0; color: #e65100; border: 1px solid #ffe0b2; }
.c-tag.warn { background: #ffebee; color: #c62828; border: 1px solid #ffcdd2; }
.c-ctrl { display: flex; flex-direction: column; align-items: flex-end; justify-content: center; }

/* Modals Misc */
.balloon-card { background: rgba(255, 255, 255, 0.9); width: 85%; max-width: 360px; padding: 40px 30px; border-radius: 40px 40px 40px 10px; box-shadow: 0 20px 50px rgba(0, 137, 123, 0.2); text-align: center; border: 1px solid rgba(255, 255, 255, 0.5); animation: floatBalloon 3s ease-in-out infinite; position: relative; }
.balloon-card::after { content: ''; position: absolute; bottom: -15px; left: 10px; width: 0; height: 0; border-left: 15px solid transparent; border-right: 0 solid transparent; border-top: 20px solid rgba(255, 255, 255, 0.9); transform: rotate(10deg); }
@keyframes floatBalloon { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
.w-logo { font-size: 48px; margin-bottom: 16px; display: inline-block; }
.w-title { font-size: 22px; font-weight: 900; color: var(--primary); margin-bottom: 8px; line-height: 1.3; }
.w-sub { font-size: 14px; color: var(--text-sub); margin-bottom: 32px; font-weight: 500; line-height: 1.6; }
.w-btn { background: var(--primary); color: #fff; border: none; padding: 14px 40px; border-radius: 50px; font-size: 16px; font-weight: 700; cursor: pointer; box-shadow: 0 8px 20px rgba(0, 137, 123, 0.3); transition: 0.2s; }
.w-btn:active { transform: scale(0.95); background: #00796b; }

.gamification-box { padding: 16px 20px; background: linear-gradient(to bottom, #fff, #fcfcfc); border-bottom: 1px solid #f0f0f0; }
.game-txt { font-size: 13px; font-weight: 700; color: #37474f; display: flex; justify-content: space-between; align-items: center; transition: all 0.3s; }
.game-txt.success { color: #2e7d32; }
.game-icon-wrap { cursor: pointer; padding: 4px 8px; background: #fff8e1; border-radius: 20px; border: 1px solid #ffe0b2; display: flex; align-items: center; gap: 4px; transition: 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
.game-icon-wrap:active { transform: scale(0.95); background: #ffecb3; }
.game-icon { transition: all 0.3s; font-size: 16px; }
.game-hint { font-size: 11px; color: var(--accent); }

.progress-wrap { height: 10px; width: 100%; background: #eee; border-radius: 5px; overflow: hidden; margin-top: 8px; }
.progress-bar { height: 100%; width: 0%; background: linear-gradient(90deg, #ffca28, #ff6f00); border-radius: 5px; transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1); }
.progress-bar.full { background: linear-gradient(90deg, #66bb6a, #43a047); }

.gift-list { display: flex; flex-direction: column; gap: 8px; padding: 8px 4px; flex: 1; overflow-y: auto; min-height: 0; }
.gift-item { display: flex; align-items: center; gap: 12px; padding: 12px; border-radius: 12px; border: 1px dashed #e0e0e0; color: #bdbdbd; transition: 0.3s; flex-shrink: 0; }
.gift-item.unlocked { background: #f1f8e9; border: 1px solid #c5e1a5; color: #33691e; box-shadow: 0 4px 10px rgba(0,0,0,0.05); transform: scale(1.02); }
.g-status { font-size: 20px; }
.g-info { flex: 1; overflow: hidden; }
.g-amt { font-size: 12px; font-weight: 700; margin-bottom: 2px; }
.g-name { font-size: 14px; }
.g-tag { font-size: 10px; background: #fff; padding: 2px 6px; border-radius: 4px; border: 1px solid #a5d6a7; color: #2e7d32; display: inline-block; margin-top: 4px; }

@keyframes shimmer { 0% { background-position: -468px 0; } 100% { background-position: 468px 0; } }
.skeleton { background: #f6f7f8; background-image: linear-gradient(to right, #f6f7f8 0%, #edeef1 20%, #f6f7f8 40%, #f6f7f8 100%); background-repeat: no-repeat; background-size: 800px 104px; animation: shimmer 1s linear infinite forwards; border-radius: 8px; }
.sk-card { height: 280px; border-radius: 16px; background: #fff; padding: 12px; margin-bottom: 12px; }

#toast-container { position: fixed; bottom: 90px; left: 50%; transform: translateX(-50%); z-index: 9999; pointer-events: none; width: 90%; max-width: 320px; display: flex; flex-direction: column-reverse; gap: 8px; align-items: center; }
.toast { background: rgba(33, 33, 33, 0.95); color: #fff; padding: 12px 24px; border-radius: 50px; font-size: 14px; text-align: center; box-shadow: 0 8px 20px rgba(0,0,0,0.2); opacity: 0; transform: translateY(20px); animation: toastIn 0.3s forwards, toastOut 0.3s forwards 2.5s; backdrop-filter: blur(4px); display: flex; align-items: center; justify-content: center; gap: 8px; transition: 0.3s; }
.toast.game { background: linear-gradient(135deg, #ffa726, #ff6f00); font-weight: 700; box-shadow: 0 10px 25px rgba(255, 111, 0, 0.4); }
@keyframes toastIn { to { opacity: 1; transform: translateY(0); } }
@keyframes toastOut { to { opacity: 0; transform: translateY(-10px); } }

@keyframes flashWarn { 0%, 100% { background: #ffebee; transform: translateX(0); } 20%, 60% { background: #ff5252; color: #fff; transform: translateX(-5px); } 40%, 80% { background: #ff5252; color: #fff; transform: translateX(5px); } }
.flash-anim { animation: flashWarn 0.6s ease-in-out; }
.input-error { border-color: #ef5350 !important; background: #ffebee !important; }

.sum-card { background: #fff; border-radius: 12px; border: 1px solid #e0e0e0; margin-top: 10px; overflow: hidden; }
.sum-head { padding: 12px 16px; background: #f5f5f5; font-size: 14px; font-weight: 700; display: flex; justify-content: space-between; align-items: center; cursor: pointer; color: #37474f; transition: 0.2s; }
.sum-head:hover { background: #eeeeee; }
.sum-body { display: none; padding: 12px 16px; font-size: 13px; color: #546e7a; line-height: 1.6; background: #fff; }
.sum-body.open { display: block; animation: slideDown 0.2s ease-out; }
@keyframes slideDown { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
.sum-line { display: flex; justify-content: space-between; border-bottom: 1px dashed #eee; padding: 6px 0; }

.form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 10px; }
input, select { width: 100%; padding: 10px 12px; border: 1px solid #cfd8dc; border-radius: 10px; font-size: 14px; background: #fafafa; transition: 0.2s; }
input:focus, select:focus { border-color: var(--primary); background: #fff; outline: none; box-shadow: 0 0 0 3px rgba(0,137,123,0.1); }
.btn-bar { display: flex; gap: 10px; margin-top: 12px; }
.btn-submit { flex: 2; padding: 14px; background: var(--text-main); color: #fff; border: none; border-radius: 12px; font-size: 16px; font-weight: 700; cursor: pointer; transition: 0.2s; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
.btn-submit:active { transform: scale(0.98); opacity: 0.9; }
.btn-clear { flex: 0 0 50px; padding: 0; background: #ffebee; color: #ef5350; border: none; border-radius: 12px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; }
.btn-clear:active { background: #ffcdd2; }

.modal { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 2000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(6px); }
.modal.open { display: flex; animation: fadeIn 0.2s ease-out; }
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
.m-box { background: #fff; width: 90%; max-width: 420px; border-radius: 24px; padding: 24px; max-height: 85vh; display: flex; flex-direction: column; box-shadow: 0 25px 50px rgba(0,0,0,0.25); transform: scale(0.95); transition: 0.2s; }
.modal.open .m-box { transform: scale(1); }
.m-head { font-size: 20px; font-weight: 700; margin-bottom: 8px; text-align: center; color: #263238; flex-shrink: 0; }
.m-sub { text-align: center; color: #78909c; font-size: 14px; margin-bottom: 20px; flex-shrink: 0; }
.m-grid { display: flex; flex-direction: column; gap: 10px; overflow-y: auto; padding: 4px; flex: 1; min-height: 0; }
.m-row { display: flex; justify-content: space-between; align-items: center; padding: 16px; border: 1px solid #eceff1; border-radius: 16px; transition: 0.2s; background: #fafafa; flex-shrink: 0; }
.m-row:hover { background: #fff; border-color: var(--primary); box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
.m-name { font-weight: 700; font-size: 15px; color: #37474f; }
.m-ctrl { display: flex; align-items: center; gap: 12px; }
.m-btn-s { width: 32px; height: 32px; border-radius: 50%; background: #fff; border: 1px solid #cfd8dc; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 18px; color: var(--primary); transition: 0.1s; position: relative; }
.m-btn-s::after { content: ''; position: absolute; top: -10px; bottom: -10px; left: -10px; right: -10px; }
.m-btn-s:active { background: var(--primary); color: #fff; border-color: var(--primary); }
.m-val { font-weight: 700; width: 24px; text-align: center; font-size: 16px; }
.m-acts { display: flex; gap: 12px; margin-top: 24px; flex-shrink: 0; }
.m-btn { flex: 1; padding: 14px; border-radius: 12px; border: none; font-weight: 700; cursor: pointer; font-size: 16px; transition: 0.2s; }
.m-btn.disabled { opacity: 0.5; pointer-events: none; background: #cfd8dc; }
#empty-state { text-align: center; margin-top: 80px; color: #b0bec5; display: none; }

.receipt-paper { background: #fff; padding: 0; width: 100%; border-radius: 0; box-shadow: none; display: flex; flex-direction: column; height: 100%; }
.rc-head { background: var(--primary); color: #fff; padding: 20px; text-align: center; }
.rc-body { flex: 1; overflow-y: auto; padding: 20px; background: #fff; }
.rc-row { display: flex; justify-content: space-between; margin-bottom: 12px; font-size: 14px; color: #455a64; }
.rc-row.bold { font-weight: 700; color: #263238; font-size: 16px; margin-top: 10px; padding-top: 10px; border-top: 2px dashed #eceff1; }
.rc-item { margin-bottom: 15px; border-bottom: 1px dashed #eee; padding-bottom: 8px; }
.rc-name { font-weight: 700; color: #37474f; margin-bottom: 4px; }
.rc-meta { display: flex; justify-content: space-between; font-size: 13px; color: #78909c; }
.rc-actions { padding: 20px; background: #fafafa; border-top: 1px solid #eee; }
.btn-email { width: 100%; padding: 12px; border: 1px solid #cfd8dc; background: #fff; border-radius: 10px; color: #546e7a; font-weight: 700; display: flex; align-items: center; justify-content: center; gap: 8px; margin-bottom: 10px; }
.btn-close-rc { width: 100%; padding: 14px; background: var(--text-main); color: #fff; border: none; border-radius: 10px; font-weight: 700; font-size: 16px; }
.email-input-box { display: none; gap: 8px; margin-bottom: 10px; }
.email-input-box.show { display: flex; }

.flying-gift { position: fixed; z-index: 1300; pointer-events: none; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.3); width: 60px; height: 60px; object-fit: contain; background: #fff; border: 2px solid #ffca28; }


/* --- Delivery Form --- */
.delivery-toggle-wrap { position: relative; margin: 10px 0; padding: 10px; background: #fff3e0; border-radius: 8px; border: 1px solid #ffe0b2; }
.d-toggle-label { display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 15px; color: #e65100; font-weight: 700; }
.d-toggle-label input { width: 20px; height: 20px; margin: 0; accent-color: #ef6c00; }
.delivery-form { display: none; flex-direction: column; gap: 10px; margin-top: 10px; padding-top: 10px; border-top: 1px dashed #ffcc80; animation: slideDown 0.3s ease-out; }
.delivery-form.show { display: flex; }
.d-input { border: 1px solid #ffcc80 !important; background: #fff !important; }
.d-input:focus { border-color: #ef6c00 !important; box-shadow: 0 0 0 3px rgba(239, 108, 0, 0.2) !important; }

.d-toggle-label { padding-right: 64px; }
.d-collapse-btn { position: absolute; top: 8px; right: 8px; border: none; background: #ef6c00; color: #fff; font-size: 12px; font-weight: 700; padding: 4px 10px; border-radius: 999px; cursor: pointer; display: none; }
</style>
</head>
<body>

<div id="welcome-overlay">
  <div class="balloon-card">
    <span class="material-icons-round w-logo" style="color:#00897b">spa</span>
    <div class="w-title">Welcome<br>TTL Bio-Tech Order Web</div>
    <div class="w-sub">ÂÅ•Â∫∑ÁæéÈ∫óÁöÑË∑Ø‰∏ä<br>Âè∞ÈÖíÁîüÊäÄËàáÊÇ®ÂêåË°å</div>
    <button class="w-btn" onclick="closeWelcome()">ÈñãÂßãË®ÇË≥º</button>
  </div>
</div>

<div id="gift-fab" onclick="showMilestoneCard()">
  <span class="material-icons-round" style="color:#ffca28">card_giftcard</span>
</div>

<div id="top-notify">
  <div class="tn-head"><span class="material-icons-round">emoji_events</span> Áç≤ÂæóË¥àÂìÅ</div>
  <div class="tn-body" id="tn-text"></div>
</div>

<div id="milestone-overlay">
  <div class="ms-card-v" id="msCard">
    <div class="ms-header">
       <div class="ms-title-v">üéÅ ÊªøÈ°çË¥àÈÄ≤Â∫¶</div>
       <div class="ms-summary-row ms-sum-all"><div>ÂÖ®Á´ôÊªøÈ°ç</div><div id="ms-val-all">$0</div></div>
       <div class="ms-summary-row ms-sum-beauty"><div>ÁæéÂÆπÊªøÈ°ç</div><div id="ms-val-beauty">$0</div></div>
    </div>
    <div class="ms-dual-body" id="msNodes"></div>
    <div class="ms-footer">
       <button class="ms-back-btn" onclick="closeMilestoneCard()">ËøîÂõûË≥ºÁâ©</button>
    </div>
  </div>
</div>

<div id="toast-container"></div>

<div id="back-to-top" onclick="window.scrollTo({top:0, behavior:'smooth'})">
  <span class="material-icons-round">arrow_upward</span>
</div>

<div id="loader">
  <div style="width:100%; max-width:800px; margin:0 auto; display:grid; grid-template-columns:1fr 1fr; gap:12px;">
    <div class="skeleton sk-card"></div><div class="skeleton sk-card"></div>
    <div class="skeleton sk-card"></div><div class="skeleton sk-card"></div>
  </div>
</div>

<header>
  <div class="search-wrap">
    <div class="search-box">
      <span class="material-icons-round icon">search</span>
      <input id="searchInp" type="text" placeholder="ÊêúÂ∞ãÂïÜÂìÅ...">
      <span id="clearSearch" class="material-icons-round clear-btn">cancel</span>
    </div>
  </div>
  <div class="cat-wrap">
    <nav class="cat-nav" id="catNav"></nav>
  </div>
</header>

<div id="ranking-section">
  <div class="rank-head">
    <div class="rank-title"><span class="material-icons-round" style="color:#d81b60;font-size:18px;">local_fire_department</span> ÁÜ±Èä∑</div>
    <div class="rank-tabs">
      <div class="r-tab active" onclick="switchRank('all')">ÂÖ®Á´ô</div>
      <div class="r-tab" onclick="switchRank('health')">‰øùÂÅ•</div>
      <div class="r-tab" onclick="switchRank('beauty')">ÁæéÂÆπ</div>
      <div class="r-tab" onclick="switchRank('cleaning')">Ê∏ÖÊΩî</div>
    </div>
  </div>
  <div class="rank-list" id="rankList"></div>
</div>

<main id="list"></main>
<div id="empty-state">
  <span class="material-icons-round" style="font-size:48px">search_off</span>
  <p>Êâæ‰∏çÂà∞Áõ∏ÈóúÂïÜÂìÅ</p>
</div>

<div id="float-bar" onclick="safeOpenCart()">
  <div class="fb-info">
    <span class="fb-total">$0</span>
    <span class="fb-count">0 ‰ª∂ÂïÜÂìÅ</span>
  </div>
  <div class="fb-btn">Êü•ÁúãË≥ºÁâ©Ëªä <span class="material-icons-round" style="font-size:18px">arrow_forward</span></div>
</div>

<div id="drawer">
  <div id="drawer-bg" onclick="closeCart()"></div>
  <div id="drawer-panel">
    <div class="dr-head">
      <div style="display:flex; align-items:center; gap:8px;">
        <span class="material-icons-round" onclick="closeCart()" style="cursor:pointer;color:#00897b;font-weight:700">arrow_back_ios</span>
        <h2 style="margin:0;font-size:20px;font-weight:700;color:#263238">Ë≥ºÁâ©Ëªä</h2>
      </div>
      <span class="material-icons-round" onclick="closeCart()" style="cursor:pointer;padding:8px;color:#546e7a;background:#f5f5f5;border-radius:50%">close</span>
    </div>
    
    <div class="gamification-box">
      <div class="game-txt" id="gameMsgContainer">
        <span id="gameMsg">Âä†Ê≤πÔºÅÂÜç $500 ÈÄÅË¥àÂìÅ</span>
        <div class="game-icon-wrap" onclick="openGiftList()">
          <span class="game-icon">üéÅ</span>
          <span class="game-hint">Êü•ÁúãÂ•ΩÁ¶Æ</span>
        </div>
      </div>
      <div class="progress-wrap">
        <div class="progress-bar" id="gameBar"></div>
      </div>
    </div>

    <div class="dr-body">
        <div id="cartList"></div>
        
        <div class="sum-card">
            <div class="sum-head" onclick="toggleSum()">
              <span style="display:flex;align-items:center;gap:6px">
                <span class="material-icons-round">receipt_long</span> ÂïÜÂìÅÁ∏ΩË¶Ω (Âê´Ë¥àÂìÅ)
              </span>
              <span class="material-icons-round" id="sumIcon">expand_more</span>
            </div>
            <div class="sum-body" id="finalList"></div>
        </div>
    </div>

    <div class="dr-foot">
      <div style="display:flex;justify-content:space-between;margin:2px 0;color:#c2185b;font-weight:700;font-size:13px;"><span>ÁæéÂÆπ‰øùÈ§äÂ∞èË®à</span><span id="sumBeauty">$0</span></div>
      <div style="display:flex;justify-content:space-between;margin-bottom:2px;color:#546e7a;font-size:13px;"><span>ÂéüÂÉπÁ∏ΩË®à</span><span id="sumBase">$0</span></div>
      <div style="display:flex;justify-content:space-between;margin-bottom:2px;color:var(--accent);font-size:13px;"><span>ÊäòÊâ£ËàáÂÑ™ÊÉ†</span><span id="sumDisc">-$0</span></div>
      <div style="display:flex;justify-content:space-between;margin-top:5px;padding-top:5px;border-top:1px dashed #cfd8dc;font-size:20px;font-weight:800;color:#263238"><span>Êáâ‰ªòÈáëÈ°ç</span><span id="sumPay">$0</span></div>

      <div class="delivery-toggle-wrap">
        <label class="d-toggle-label">
          <input type="checkbox" id="chkDelivery" onchange="toggleDelivery()">
          <span>ÈúÄÂÆÖÈÖçÂØÑÈÄÅ</span> <span id="deliveryStatusText" style="font-size:12px;font-weight:400;color:#ef6c00">(Ë´ãÂ°´ÂØ´Êî∂‰ª∂Ë≥áË®ä)</span>
        </label>
        <button type="button" class="d-collapse-btn" id="btnDeliveryCollapse" onclick="collapseDelivery()">Êî∂Âêà</button>

        <div id="deliveryForm" class="delivery-form">
           <input id="dName" class="d-input" placeholder="Êî∂Ë≤®‰∫∫ÂßìÂêç (ÂøÖÂ°´)">
           <input id="dPhone" class="d-input" type="tel" placeholder="ËÅØÁµ°ÈõªË©±/ÊâãÊ©ü (ÂøÖÂ°´)">
           <input id="dAddr" class="d-input" placeholder="Êî∂Ë≤®Âú∞ÂùÄ (ÂøÖÂ°´)">
           <input id="dNote" class="d-input" placeholder="ÂÆÖÈÖçÂÇôË®ª (ÈÅ∏Â°´)">
        </div>
      </div>
      <div class="form-grid">
        <input id="fName" placeholder="Ë®ÇË≥º‰∫∫ÂßìÂêç (ÂøÖÂ°´)">
        <input id="fDept" placeholder="Ë®ÇË≥º‰∫∫ÈÉ®ÈñÄ (ÂøÖÂ°´)">
        <select id="fPay">
          <option value="ÁèæÈáë">ÁèæÈáë</option>
          <option value="‰ø°Áî®Âç°">‰ø°Áî®Âç°</option>
          <option value="Ëñ™Ë≥áÊâ£Ê¨æ">Ëñ™Ë≥áÊâ£Ê¨æ</option>
          <option value="ÂåØÊ¨æ">ÂåØÊ¨æ</option>
        </select>
        <input id="fNote" placeholder="Ë®ÇÂñÆÂÇôË®ª">
      </div>
      <div class="btn-bar">
        <button class="btn-clear" onclick="clearCart()"><span class="material-icons-round">delete_outline</span></button>
        <button class="btn-submit" onclick="submitOrder()">Á¢∫Ë™çË®ÇË≥º</button>
      </div>
      <div id="warnMsg" style="color:#ef5350;font-size:12px;text-align:center;margin-top:5px;display:none;font-weight:700;background:#ffebee;padding:5px;border-radius:6px;"></div>
    </div>
  </div>
</div>

<div id="bundleModal" class="modal">
  <div class="m-box">
    <div class="m-head">‰ªªÈÅ∏ 2 ‰ª∂ÂÖßÂÆπÁâ©</div>
    <div class="m-sub">Â∑≤ÈÅ∏Êìá <span id="mCount" style="color:var(--accent);font-weight:700">0</span> / 2 ‰ª∂</div>
    <div class="m-grid" id="mGrid"></div>
    <div class="m-acts">
      <button class="m-btn" style="background:#f5f5f5;color:#546e7a" onclick="closeBundle()">ÂèñÊ∂à</button>
      <button id="mConfirmBtn" class="m-btn disabled" style="background:var(--primary);color:#fff" onclick="confirmBundle()">Á¢∫Ë™çÈÅ∏Âèñ</button>
    </div>
  </div>
</div>

<div id="giftModal" class="modal">
  <div class="m-box">
    <div class="m-head" style="margin-bottom:20px">üéÅ ÊªøÈ°çË¥àÈÅîÊ®ôÊ∏ÖÂñÆ</div>
    <div class="gift-list" id="giftListGrid"></div>
    <button class="m-btn" style="background:#f5f5f5;color:#546e7a;margin-top:20px;flex-shrink:0" onclick="closeGiftList()">ÈóúÈñâ</button>
  </div>
</div>

<div id="receiptModal" class="modal" style="z-index:2200;">
  <div class="m-box receipt-paper" style="max-height:90vh; max-width:400px; padding:0;">
    <div class="rc-head">
      <h2 style="margin:0;font-size:18px;">Ë®ÇË≥ºÂÆåÊàê</h2>
      <div style="font-size:12px;opacity:0.8;margin-top:4px;" id="rcOrderId"></div>
    </div>
    <div class="rc-body" id="rcBody"></div>
    <div class="rc-actions">
      <button class="btn-email" onclick="toggleEmailInput()">
        <span class="material-icons-round">email</span> ÂØÑÈÄÅË®ÇË≥ºÁ¥ÄÈåÑÂà∞ Email
      </button>
      <div class="email-input-box" id="emailBox">
        <input type="email" id="rcEmail" placeholder="Ë´ãËº∏ÂÖ• Email..." style="flex:1;">
        <button class="btn-submit" style="flex:0 0 80px;padding:10px;" onclick="sendReceipt()">ÁôºÈÄÅ</button>
      </div>
      <div style="font-size:11px;color:#90a4ae;text-align:center;margin-bottom:15px;">
        Ë´ãËá™Ë°åÊà™ÂúñÁïôÂ≠òÔºåÊàñ‰ΩøÁî®‰∏äÊñπÊåâÈàïÂØÑÈÄÅ„ÄÇ
      </div>
      <button class="btn-close-rc" onclick="closeReceipt()">ÈóúÈñâ‰∏¶ÂÆåÊàê</button>
    </div>
  </div>
</div>

<script>
/* --- V29 Optimization: Áõ¥Êé•ËÆÄÂèñ Google Sheets (ÁßªÈô§‰∏çÁ©©ÂÆöÁöÑ Proxy) --- */
const SHEET_P = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQBtV8q3Ank7Bnhs83IbOb97U46juV-RKeL3NpdFiNcSu-ifI21fQYo1-io62S3JIrXEO5MiDArc1Lr/pub?gid=1623055155&single=true&output=csv";
const SHEET_R = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQU95r9_TOPlQXY-lcBS_RH3tRc0mtRyuazxHHWljpRusbzBiWsEfm3Pa_HZmKW5Ob5TOq4W5O-vumI/pub?gid=2071879068&single=true&output=csv";
const SHEET_RANK = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQj5QLrtaWikGcLNwMawbjiN8ZQDgFzW1RV7UECFgLzECWj16I2ugE_B6tzzLICCynsk1L6lAuJfccS/pub?gid=93142219&single=true&output=csv";
const GAS_URL = "https://script.google.com/macros/s/AKfycbxQ9Etloak3ZNv6yfyMCK9KbjoLyDqjRQHHVlASY5iMwwy_c4NCPxWpMK1YkzSXstHN/exec";

/* Ëã•ÈÅáÂà∞ CORS Êìã‰ΩèÊâçÂïüÂãïÂÇôÁî® Proxy */
const DIRECT_FETCH = (url) => url + "&t=" + Date.now(); 

let PRODUCTS = [], RULES = {}, CART = [], SELECTED_BUNDLE = new Map();
let PRODUCT_MAP = new Map(); 
let RANKINGS = { all:[], health:[], beauty:[], cleaning:[] };
let currentCat = "", categories = [];
let modalPid = null, isCartOpen = false;
let tempBundleSelection = [];
let lastOrderData = null; 
let sectionObserver = null;
let GIFT_MAP = new Map();
let achievedGifts = [];
let isFirstAdd = true; 

function cleanupUI() {
    document.body.classList.remove('modal-open');
    document.body.style.overflow = '';
    document.body.style.height = '';
}

window.closeWelcome = function() {
  const el = document.getElementById('welcome-overlay');
  el.classList.add('fade-out');
  setTimeout(() => el.style.display = 'none', 500);
};

window.safeOpenCart = function() {
  if(!CART || CART.length === 0) {
    showToast("Ë≥ºÁâ©ËªäÈÇÑÊòØÁ©∫ÁöÑÂñîÔºÅ", "warn");
    return;
  }
  openCart();
};

window.openCart = function() {
  document.getElementById("drawer").classList.add("open"); 
  document.getElementById("float-bar").classList.add("hidden"); 
  document.body.classList.add('modal-open');
  isCartOpen = true; 
  history.pushState({modal: 'cart'}, null, ""); 
};

window.closeCart = function() {
  document.getElementById("drawer").classList.remove("open");
  document.getElementById("float-bar").classList.remove("hidden");
  cleanupUI(); 
  isCartOpen = false;
  if(history.state && history.state.modal === 'cart') history.back();
};

window.switchRank = function(type) {
  document.querySelectorAll(".r-tab").forEach(el => el.classList.remove("active"));
  event.target.classList.add("active");
  renderRanking(type);
};

window.openGiftList = function() {
    const data = calcCart();
    const currentTotal = data.finalTotal;
    const currentBeauty = data.beautyTotal;
    
    const giftsAll = RULES.spend.filter(r => r.scope === 'all').sort((a,b) => a.amt - b.amt);
    const giftsBeauty = RULES.spend.filter(r => r.scope === 'zone_prefix').sort((a,b) => a.amt - b.amt);

    const grid = document.getElementById("giftListGrid");
    grid.innerHTML = "";

    if (giftsAll.length > 0) {
        grid.innerHTML += `<div style="font-size:13px;font-weight:900;color:var(--accent);padding:10px 0 5px 5px;border-bottom:1px solid #eee">ÂÖ®È§®ÊªøÈ°çË¥à</div>`;
        giftsAll.forEach(g => {
            const reached = currentTotal >= g.amt;
            grid.appendChild(createGiftItem(g, reached));
        });
    }

    if (giftsBeauty.length > 0) {
        grid.innerHTML += `<div style="font-size:13px;font-weight:900;color:var(--beauty);padding:15px 0 5px 5px;border-bottom:1px solid #eee">ÁæéÂÆπÊªøÈ°çË¥à</div>`;
        giftsBeauty.forEach(g => {
            const reached = currentBeauty >= g.amt;
            grid.appendChild(createGiftItem(g, reached));
        });
    }

    document.getElementById("giftModal").classList.add("open");
    history.pushState({modal: 'gift'}, null, "");
};

/* V29: ‰øÆÊ≠£ GIFT_MAP ÂúñÁâáÊ∏≤ÊüìÈÇèËºØ */
function renderGiftImages(giftCode) {
    const images = GIFT_MAP.get(giftCode) || [];
    if(images.length === 0) return '';
    
    let html = `<div class="g-img-row">`;
    images.slice(0, 3).forEach(url => {
        if(url && url.length > 5) html += `<img src="${url}" class="g-thumb" onerror="this.style.display='none'">`;
    });
    html += `</div>`;
    return html;
}

function createGiftItem(g, reached) {
    let pInfo = PRODUCT_MAP.get(g.gift) || { name: g.gift };
    let gName = pInfo.name.replace(/^(Ë¥àÂìÅ|Ë¥à|Gift)[:\s|ÔΩú_]*/i, "");
    
    let imgHtml = renderGiftImages(g.gift);
    if(!imgHtml) imgHtml = '<div class="g-thumb" style="display:flex;align-items:center;justify-content:center;font-size:16px;background:#f5f5f5">üéÅ</div>';

    const div = document.createElement("div");
    div.className = `gift-item ${reached ? 'unlocked' : ''}`;
    div.innerHTML = `
        <div class="g-status material-icons-round">${reached ? 'check_circle' : 'lock'}</div>
        <div style="flex-shrink:0;">${imgHtml}</div>
        <div class="g-info"><div class="g-amt">Êªø $${g.amt.toLocaleString()}</div><div class="g-name">${gName} x${g.qty}</div>${reached ? '<div class="g-tag">Â∑≤Áç≤Âæó</div>' : ''}</div>
    `;
    return div;
}

window.closeGiftList = function() {
    document.getElementById("giftModal").classList.remove("open");
    if(history.state && history.state.modal === 'gift') history.back();
};

window.toggleSum = function() {
  const b = document.getElementById("finalList");
  const i = document.getElementById("sumIcon");
  if(b.classList.contains("open")) {
    b.classList.remove("open");
    i.innerText = "expand_more";
  } else {
    b.classList.add("open");
    i.innerText = "expand_less";
  }
};

window.updateQty = function(btnEl, pid, delta) {
  const p = PRODUCTS.find(x => x._id === pid);
  if(!p) return;

  if(delta > 0 && p.category.includes("Âä†ÂÉπË≥º")) {
    const mainCount = CART.reduce((acc, it) => acc + (!it.category.includes("Âä†ÂÉπË≥º") ? it.qty : 0), 0);
    if(mainCount === 0) {
      showToast("Ë´ãÂÖàÈÅ∏Ë≥º‰∏ªÂïÜÂìÅÔºÅ", "warn");
      return;
    }
  }

  if(delta > 0 && p.bundle.length >= 2 && p.name.includes("‰ªªÈÅ∏")) {
    openBundle(pid); return;
  }

  let item = CART.find(x => x._id === pid && !x.bundleSelection);
  
  if(item) {
    item.qty += delta;
    if(item.qty <= 0) CART = CART.filter(x => x !== item);
  } else if (delta > 0) {
    CART.push({ ...p, qty: 1 });
  }
  
  if(delta > 0 && btnEl) animateFly(btnEl);
  
  if(delta > 0 && isFirstAdd) {
      isFirstAdd = false;
      setTimeout(() => {
          showMilestoneCard();
          setTimeout(() => { minimizeMilestoneCard(); }, 2000);
      }, 500);
  } else if (delta > 0) {
      showToast("Â∑≤Âä†ÂÖ•Ë≥ºÁâ©Ëªä");
      setTimeout(() => {
          const data = calcCart();
          checkNewGifts(data.gifts); 
      }, 800);
  }

  saveState();
  refreshCart();
  renderList();
  
  const fab = document.getElementById("float-bar");
  if(CART.length > 0) fab.classList.add("show");
};

window.showMilestoneCard = function() {
    renderMilestoneContent();
    document.getElementById('milestone-overlay').classList.add('open');
    document.getElementById('msCard').classList.remove('shrinking');
    document.body.classList.add('modal-open');
    history.pushState({modal: 'milestone'}, null, "");
};

window.closeMilestoneCard = function() {
    document.getElementById('milestone-overlay').classList.remove('open');
    if(history.state && history.state.modal === 'milestone') history.back();
};

window.minimizeMilestoneCard = function() {
    const card = document.getElementById('msCard');
    card.classList.add('shrinking');
    setTimeout(() => {
        document.getElementById('milestone-overlay').classList.remove('open'); 
        cleanupUI();
        document.getElementById('gift-fab').style.display = 'flex'; 
        if(history.state && history.state.modal === 'milestone') history.back();
    }, 600);
};

function renderMilestoneContent() {
    const data = calcCart();
    const currentTotal = data.finalTotal;
    const currentBeauty = data.beautyTotal;
    
    document.getElementById('ms-val-all').innerText = `$${currentTotal.toLocaleString()}`;
    document.getElementById('ms-val-beauty').innerText = `$${currentBeauty.toLocaleString()}`;

    const giftsAll = RULES.spend.filter(r => r.scope === 'all').sort((a,b) => a.amt - b.amt);
    const giftsBeauty = RULES.spend.filter(r => r.scope === 'zone_prefix').sort((a,b) => a.amt - b.amt);

    const container = document.getElementById('msNodes');
    container.innerHTML = '';
    
    const leftCol = document.createElement('div');
    leftCol.className = 'ms-track-col';
    leftCol.innerHTML = '<div class="ms-track-title">ÂÖ®Á´ôÊªøÈ°ç</div>';
    
    const rightCol = document.createElement('div');
    rightCol.className = 'ms-track-col beauty';
    rightCol.innerHTML = '<div class="ms-track-title" style="color:var(--beauty)">ÁæéÂÆπÊªøÈ°ç</div>';
    
    giftsAll.forEach(g => leftCol.appendChild(createDualItem(g, currentTotal >= g.amt)));
    giftsBeauty.forEach(g => rightCol.appendChild(createDualItem(g, currentBeauty >= g.amt)));
    
    container.appendChild(leftCol);
    container.appendChild(rightCol);
}

function createDualItem(g, isReached) {
    let pInfo = PRODUCT_MAP.get(g.gift) || { name: g.gift };
    let gName = pInfo.name.replace(/^(Ë¥àÂìÅ|Ë¥à|Gift)[:\s|ÔΩú_]*/i, "");
    let imgHtml = renderGiftImages(g.gift); 
    if(!imgHtml) imgHtml = '<div class="g-thumb" style="display:flex;align-items:center;justify-content:center;font-size:16px;background:#f5f5f5">üéÅ</div>';
    
    const item = document.createElement('div');
    item.className = `ms-dual-item ${isReached ? 'active' : ''}`;
    item.innerHTML = `
      <div class="ms-d-th">$${(g.amt).toLocaleString()}</div>
      ${imgHtml}
      <div class="ms-d-name">${gName}</div>
    `;
    return item;
}

function checkNewGifts(currentGifts) {
    const currentNames = currentGifts.map(g => g.name);
    const newUnlocks = currentNames.filter(n => !achievedGifts.includes(n));
    
    if(newUnlocks.length > 0) {
        const fab = document.getElementById('gift-fab');
        const notify = document.getElementById('top-notify');
        const txt = document.getElementById('tn-text');
        
        fab.style.display = 'flex'; 
        fab.classList.add('gift-shake');
        
        let html = "";
        newUnlocks.forEach(name => html += `<div>‚Ä¢ ${name}</div>`);
        txt.innerHTML = html;
        notify.classList.add('show');
        
        setTimeout(() => {
            fab.classList.remove('gift-shake');
            notify.classList.remove('show');
        }, 4000); 
    }
    achievedGifts = currentNames;
}

function saveState() {
  localStorage.setItem('v29_cart_data', JSON.stringify({ cart: CART }));
}

function loadState() {
  const raw = localStorage.getItem('v29_cart_data');
  if(!raw) return;
  try {
    const data = JSON.parse(raw);
    CART = data.cart.map(oldItem => {
      const freshItem = PRODUCT_MAP.get(oldItem.code);
      if(freshItem) return { ...freshItem, qty: oldItem.qty, bundleSelection: oldItem.bundleSelection };
      return null;
    }).filter(x => x);
    
    const cData = calcCart();
    achievedGifts = cData.gifts.map(g => g.name);
    
    refreshCart();
    renderList();
    if(CART.length > 0) {
      document.getElementById("float-bar").classList.add("show");
      isFirstAdd = false;
      document.getElementById('gift-fab').style.display = 'flex';
    }
  } catch(e) { console.error("Load state failed", e); }
}

function showToast(msg, type='normal') {
  const c = document.getElementById('toast-container');
  const t = document.createElement('div');
  t.className = 'toast';
  if(type === 'game') t.classList.add('game');
  let icon = (type === 'warn') ? 'error_outline' : (type === 'game' ? 'stars' : 'check_circle');
  t.innerHTML = `<span class="material-icons-round" style="color:${type==='warn'?'#ff5252':(type==='game'?'#fff':'#69f0ae')}">${icon}</span> ${msg}`;
  c.appendChild(t); 
  setTimeout(() => t.remove(), 2500);
  return t; 
}

function animateFly(startEl) {
  const card = startEl.closest('.p-card') || startEl.closest('.r-card');
  if (!card) return;
  const rect = startEl.getBoundingClientRect();
  const target = document.querySelector('.fb-btn').getBoundingClientRect();
  const fly = document.createElement('img');
  let imgEl = card.querySelector('img.p-img') || card.querySelector('img.r-img') || card.querySelector('img');
  if(!imgEl || !imgEl.src) return;
  
  fly.src = imgEl.src;
  fly.className = 'flying-img';
  fly.style.top = rect.top + 'px';
  fly.style.left = rect.left + 'px';
  document.body.appendChild(fly);
  
  setTimeout(() => {
    fly.style.top = (target.top + 10) + 'px'; 
    fly.style.left = (target.left + 20) + 'px';
    fly.style.transform = 'scale(0.1) rotate(360deg)'; 
    fly.style.opacity = '0.5';
  }, 10); 
  setTimeout(() => fly.remove(), 1000); 
}

function jumpToProduct(pid) {
  const searchInp = document.getElementById("searchInp");
  if(searchInp.value) {
    searchInp.value = "";
    document.getElementById("clearSearch").style.display = 'none'; 
    renderList(); 
  }
  setTimeout(() => {
    const el = document.getElementById(`p-${pid}`);
    if(el) {
      el.scrollIntoView({ behavior: "smooth", block: "center" });
      el.classList.add("flash-highlight");
      setTimeout(()=>el.classList.remove("flash-highlight"), 1300);
    }
  }, 100);
}

function highlightText(text, query) {
  if (!query) return text;
  const safeQuery = query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
  const regex = new RegExp(`(${safeQuery})`, 'gi');
  return text.replace(regex, '<span class="highlight">$1</span>');
}

/* --- V29 ‰øÆÊ≠£ÂúñÁâáÊé°ÈõÜ logic --- */
async function initApp() {
  try {
    const [pText, rText, rankText] = await Promise.all([
      fetch(DIRECT_FETCH(SHEET_P)).then(r => r.text()),
      fetch(DIRECT_FETCH(SHEET_R)).then(r => r.text()),
      fetch(DIRECT_FETCH(SHEET_RANK)).then(r => r.text())
    ]);

    const pData = Papa.parse(pText, { header: true, skipEmptyLines: true }).data;
    PRODUCTS = pData.map((row, i) => {
      const pick = (k) => row[Object.keys(row).find(key => key.toLowerCase().replace(/\s/g,'') === k.toLowerCase().replace(/\s/g,''))] || "";
      const name = pick("productname");
      const code = pick("productcode");
      if(!name || !code) return null;
      
      const isGift = pick("isgift").toLowerCase();
      
      // ÂúñÁâáÊé°ÈõÜ (ÂåÖÂê´‰∏ªÂúñËàáÂâØÂúñ)
      let imgs = [];
      const p1 = pick("photosurl"); if(p1.length > 5) imgs.push(p1);
      const p2 = pick("photosurl2"); if(p2.length > 5) imgs.push(p2);
      const p3 = pick("photosurl3"); if(p3.length > 5) imgs.push(p3);
      if(imgs.length > 0) GIFT_MAP.set(code, imgs);

      if(isGift === 'true' || isGift.includes('ÊòØ')) {
        PRODUCT_MAP.set(code, { name, price: 0 }); 
        return null;
      }
      
      let bundle = [];
      for(let k=1; k<=4; k++) {
        let sn = pick(`spec${k}`);
        let sq = Number(pick(`spec${k}qty`)||1);
        if(sn) bundle.push({ name: sn, qty: sq });
      }

      const p = {
        _id: i, code: code, name: name, category: pick("category").trim(),
        price: Number((pick("listprice")||"0").replace(/,/g,'')), 
        spec: pick("spec"), photo: p1, bundle: bundle
      };
      PRODUCT_MAP.set(code, p);
      return p;
    }).filter(x => x);

    const rData = Papa.parse(rText, { header: true, skipEmptyLines: true }).data;
    RULES = { tiers: [], bogo: [], spend: [], bundle: [] };
    rData.forEach(row => {
      const pick = (k) => row[Object.keys(row).find(key => key.toLowerCase().replace(/\s/g,'') === k.toLowerCase().replace(/\s/g,''))] || "";
      const type = pick("ruletype").toLowerCase();
      if(type.includes("tier")) RULES.tiers.push({ zone: pick("zone").trim(), min: Number(pick("minqty")), pct: Number(pick("percentoff")) });
      else if(type.includes("bogo")) RULES.bogo.push({ code: pick("productcode"), buy: Number(pick("buy")), get: Number(pick("get")) });
      else if(type.includes("spend")) RULES.spend.push({ scope: pick("thresholdscope"), prefix: pick("zoneprefix"), amt: Number(pick("thresholdamount")), gift: pick("giftcode"), qty: Number(pick("giftqty")), mult: pick("multiples").toUpperCase()==="TRUE" });
      else if(type.includes("bundle")) RULES.bundle.push({ code: pick("productcode"), price: Number(pick("unitprice")) });
    });

    processRankings(rankText);
    renderUI();
    document.getElementById("loader").style.opacity = 0;
    setTimeout(()=>document.getElementById("loader").remove(), 300);
    loadState();
  } catch(e) { 
    console.error(e);
    alert("Ë≥áÊñôËºâÂÖ•Â§±ÊïóÔºåË´ãÊ™¢Êü•Á∂≤Ë∑ØÈÄ£Á∑öÊàñÁ®çÂæåÂÜçË©¶„ÄÇ"); 
  }
}

function processRankings(csvText) {
  RANKINGS = { all:[], health:[], beauty:[], cleaning:[] };
  const rows = Papa.parse(csvText, { header: false }).data;
  let rawList = [];
  let processedCodes = new Set();

  rows.forEach(r => {
    if(r.length < 6) return;
    const code = r[0];
    let qty = parseFloat((r[5]||r[4]||"0").toString().replace(/,/g, ''));
    if(PRODUCT_MAP.has(code) && qty > 0 && !processedCodes.has(code)) {
      rawList.push({ ...PRODUCT_MAP.get(code), sold: qty });
      processedCodes.add(code);
    }
  });

  rawList.sort((a,b) => b.sold - a.sold);
  RANKINGS.all = rawList.slice(0, 10);
  RANKINGS.health = rawList.filter(i => getRankingCategory(i.name, i.category) === 'health').slice(0, 10);
  RANKINGS.beauty = rawList.filter(i => getRankingCategory(i.name, i.category) === 'beauty').slice(0, 10);
  RANKINGS.cleaning = rawList.filter(i => getRankingCategory(i.name, i.category) === 'cleaning').slice(0, 10);

  if(RANKINGS.all.length > 0) {
    document.getElementById("ranking-section").style.display = "block";
    renderRanking("all");
  }
}

function getRankingCategory(name, originalCat) {
  const n = name.toLowerCase(); const c = originalCat.toLowerCase();
  if (n.includes("ÊòìÊ¥óÊ®Ç") || n.includes("Ê¥óÊΩî") || n.includes("Ê¥óË°£") || c.includes("Ê∏ÖÊΩî")) return "cleaning";
  if (c.includes("ÁæéÂÆπ") || c.includes("‰øùÈ§ä") || ["vinata", "Èù¢ËÜú", "Èúú", "Èú≤", "‰π≥Ê∂≤"].some(kw => n.includes(kw))) return "beauty";
  if (c.includes("‰øùÂÅ•") || ["ÂÆâÂèØÂÅ•", "ÁõäÁîüËèå", "Á¥ÖÈ∫¥", "È≠öÊ≤π"].some(kw => n.includes(kw))) return "health";
  return "other"; 
}

function renderRanking(type) {
  const list = document.getElementById("rankList");
  list.innerHTML = "";
  (RANKINGS[type] || []).forEach((p, idx) => {
    const card = document.createElement("div");
    card.className = "r-card"; card.dataset.rank = idx + 1; 
    card.onclick = () => jumpToProduct(p._id);
    let imgHtml = (p.photo && p.photo.length > 5) ? `<img src="${p.photo}" class="r-img" loading="lazy">` : `<div class="p-no-img" style="height:100%;justify-content:center;font-size:10px">ÁÑ°Âúñ</div>`;
    card.innerHTML = `<div class="r-img-wrap"><div class="r-badge">${idx + 1}</div><div class="r-sold-tag">ÂîÆ${p.sold.toLocaleString()}</div>${imgHtml}</div><div class="r-name">${p.name}</div>`;
    list.appendChild(card);
  });
}

function renderUI() {
  const nav = document.getElementById("catNav");
  nav.innerHTML = "";
  let rawCats = [...new Set(PRODUCTS.map(p => p.category))].filter(Boolean);
  
  const createPill = (txt, target) => {
    const p = document.createElement("div");
    p.className = "cat-pill" + (txt === "ÁÜ±Èä∑ÊéíË°å" ? " active" : "");
    p.innerText = txt;
    p.onclick = () => scrollToSection(target);
    nav.appendChild(p);
  };

  createPill("ÁÜ±Èä∑ÊéíË°å", 'cat-all-wrapper');
  rawCats.forEach(c => createPill(c.split(/[\s_]/)[0], `cat-${c.replace(/\s+/g, '-')}`));
  
  categories = rawCats; 
  renderList();
}

function scrollToSection(id) {
  const el = document.getElementById(id);
  if(el) {
    const offset = 120;
    const bodyRect = document.body.getBoundingClientRect().top;
    const elementRect = el.getBoundingClientRect().top;
    const elementPosition = elementRect - bodyRect;
    const offsetPosition = elementPosition - offset;

    window.scrollTo({ top: offsetPosition, behavior: 'smooth' });
  }
}

function setupScrollSpy() {
  if (sectionObserver) sectionObserver.disconnect();
  sectionObserver = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        const id = entry.target.id;
        document.querySelectorAll(".cat-pill").forEach(pill => {
          const isMatch = (id === 'cat-all-wrapper' && pill.innerText === 'ÁÜ±Èä∑ÊéíË°å') || (id.includes(pill.innerText));
          pill.classList.toggle("active", isMatch);
        });
      }
    });
  }, { rootMargin: '-135px 0px -70% 0px' });
  document.querySelectorAll('.cat-section, #cat-all-wrapper').forEach(s => sectionObserver.observe(s));
}

function renderList() {
  const grid = document.getElementById("list");
  grid.innerHTML = "";
  const q = document.getElementById("searchInp").value.toLowerCase().trim();
  document.getElementById("clearSearch").style.display = q ? 'block' : 'none';
  
  if (q) {
    const filtered = PRODUCTS.filter(p => p.name.toLowerCase().includes(q) || p.code.toLowerCase().includes(q));
    document.getElementById("empty-state").style.display = filtered.length === 0 ? "block" : "none";
    const container = document.createElement("div"); container.className = "grid-layout";
    filtered.forEach(p => container.appendChild(createProductCard(p, q)));
    grid.appendChild(container);
  } else {
    document.getElementById("empty-state").style.display = "none";
    const topAnchor = document.createElement("div"); topAnchor.id = "cat-all-wrapper"; grid.appendChild(topAnchor);

    categories.forEach(cat => {
        const catProducts = PRODUCTS.filter(p => p.category === cat);
        if (catProducts.length > 0) {
            const section = document.createElement("div"); section.className = "cat-section"; section.id = `cat-${cat.replace(/\s+/g, '-')}`;
            section.innerHTML = `<div class="cat-section-title">${cat.split(/[\s_]/)[0]}</div>`;
            const gridContainer = document.createElement("div"); gridContainer.className = "grid-layout";
            catProducts.forEach(p => gridContainer.appendChild(createProductCard(p, null)));
            section.appendChild(gridContainer);
            grid.appendChild(section);
        }
    });
    setupScrollSpy();
  }
}

function createProductCard(p, highlightQuery) {
    const inCart = CART.find(x => x._id === p._id && !x.bundleSelection);
    const qty = inCart ? inCart.qty : 0;
    let badges = "";
    if(p.category.includes("Âä†ÂÉπË≥º")) badges += `<span class="badge bg-red">Âä†ÂÉπË≥º</span>`;
    if(RULES.bogo.some(b => b.code === p.code)) badges += `<span class="badge bg-blue">Ë≤∑‰∏ÄÈÄÅ‰∏Ä</span>`;
    if(p.name.includes("‰ªªÈÅ∏")) badges += `<span class="badge bg-gold">ÂÑ™ÊÉ†ÁµÑÂêà</span>`;
    
    let actionBtn = (p.bundle.length >= 2 && p.name.includes("‰ªªÈÅ∏")) ? `<div class="btn-bundle" onclick="openBundle(${p._id})">ÈÅ∏ÊìáÂÖßÂÆπÁâ©</div>` : "";
    let imgHtml = (p.photo && p.photo.length > 5) ? `<img src="${p.photo}" class="p-img" onload="this.classList.add('loaded')" onerror="this.parentElement.innerHTML='<div class=\'p-no-img\'>Êö´ÁÑ°ÂúñÁâá</div>'">` : `<div class="p-no-img"><span class="material-icons-round" style="font-size:32px">image_not_supported</span>ÁÑ°ÂúñÁâá</div>`;
    
    const card = document.createElement("div"); card.className = "p-card"; card.id = `p-${p._id}`;
    card.innerHTML = `<div class="p-img-box"><div class="badges">${badges}</div>${imgHtml}</div><div class="p-body"><div><div class="p-title">${highlightText(p.name, highlightQuery)}</div><div class="p-code">${p.code}</div></div><div><div class="p-price-row"><span class="p-price">$${p.price.toLocaleString()}</span></div>${actionBtn}<div class="stepper"><div class="s-btn ${qty===0?'hidden':''}" onclick="window.updateQty(this, ${p._id}, -1)">Ôºç</div><div class="s-val ${qty===0?'hidden':''}">${qty}</div><div class="s-btn add" onclick="window.updateQty(this, ${p._id}, 1)">Ôºã</div></div></div></div>`;
    return card;
}

window.openBundle = function(pid) {
  modalPid = pid;
  const p = PRODUCTS.find(x => x._id === pid);
  const grid = document.getElementById("mGrid");
  grid.innerHTML = ""; tempBundleSelection = [];
  updateModalUI();
  p.bundle.forEach((b, idx) => {
    const row = document.createElement("div"); row.className = "m-row"; row.dataset.idx = idx;
    row.innerHTML = `<div style="flex:1"><div class="m-name">${b.name}</div><div style="font-size:12px;color:#90a4ae">Ë¶èÊ†º: ${b.qty}</div></div><div class="m-ctrl"><div class="m-btn-s minus">Ôºç</div><div class="m-val">0</div><div class="m-btn-s plus">Ôºã</div></div>`;
    row.querySelector(".minus").onclick = () => modifyTemp(idx, -1);
    row.querySelector(".plus").onclick = () => modifyTemp(idx, 1);
    grid.appendChild(row);
  });
  document.getElementById("bundleModal").classList.add("open");
};

function modifyTemp(idx, delta) {
  if (delta > 0) { if (tempBundleSelection.length < 2) tempBundleSelection.push(idx); }
  else { const i = tempBundleSelection.indexOf(idx); if (i > -1) tempBundleSelection.splice(i, 1); }
  updateModalUI(); updateModalCounts();
}

function updateModalUI() {
  const len = tempBundleSelection.length;
  document.getElementById("mCount").innerText = len;
  const btn = document.getElementById("mConfirmBtn");
  btn.className = "m-btn" + (len === 2 ? "" : " disabled");
  btn.innerText = (len === 2) ? "Á¢∫Ë™çÈÅ∏Âèñ" : `ÈÇÑÂ∑Æ ${2 - len} ‰ª∂`;
}

function updateModalCounts() {
  Array.from(document.getElementById("mGrid").children).forEach(row => {
    const idx = parseInt(row.dataset.idx);
    const count = tempBundleSelection.filter(x => x === idx).length;
    row.querySelector(".m-val").innerText = count;
    row.style.borderColor = (count > 0) ? "var(--primary)" : "#eceff1";
  });
}

window.confirmBundle = function() {
  if (tempBundleSelection.length !== 2) return;
  const p = PRODUCTS.find(x => x._id === modalPid);
  if(!p) return;
  
  const existing = CART.find(x => x._id === modalPid && JSON.stringify(x.bundleSelection) === JSON.stringify(tempBundleSelection));
  if(existing) existing.qty += 1;
  else CART.push({ ...p, qty: 1, bundleSelection: [...tempBundleSelection], cartId: Date.now() });

  saveState(); refreshCart(); renderList();
  showToast("ÁµÑÂêàÂ∑≤Âä†ÂÖ•"); closeBundle();
};

window.closeBundle = function() { document.getElementById("bundleModal").classList.remove("open"); };

window.clearCart = function() {
  if(confirm("Á¢∫ÂÆöË¶ÅÊ∏ÖÁ©∫Ë≥ºÁâ©ËªäÂóéÔºü")) { 
    CART = []; achievedGifts = []; saveState(); refreshCart(); renderList(); closeCart(); 
  }
};

window.updateCartItem = function(index, delta) {
    const item = CART[index];
    if(!item) return;
    item.qty += delta;
    if(item.qty <= 0) CART.splice(index, 1);
    saveState();
    const data = refreshCart();
    checkNewGifts(data.gifts);
    renderList(); 
};

function calcCart() {
  let subTotal = 0, finalTotal = 0, beautyTotal = 0, discountAmt = 0;
  let warnings = [];
  let catCounts = {};
  
  CART.forEach(it => {
    const matchedRule = RULES.tiers.find(r => it.category.includes(r.zone));
    if(matchedRule) catCounts[matchedRule.zone] = (catCounts[matchedRule.zone] || 0) + it.qty;
  });

  const processedItems = CART.map(it => {
    const originalLine = it.price * it.qty;
    subTotal += originalLine;
    let finalLine = originalLine;
    let tags = [];
    
    const bundleRule = RULES.bundle.find(b => b.code === it.code);
    if(bundleRule && bundleRule.price < it.price) {
      finalLine = bundleRule.price * it.qty;
      tags.push({ text: `ÁèæÁúÅ $${((it.price - bundleRule.price) * it.qty).toLocaleString()}`, cls: "save" });
    } else {
      const matchedRule = RULES.tiers.find(r => it.category.includes(r.zone));
      if(matchedRule) {
         const tier = RULES.tiers.filter(r => r.zone === matchedRule.zone).sort((a,b) => b.min - a.min).find(t => catCounts[matchedRule.zone] >= t.min);
         if(tier) {
           finalLine = originalLine * ((100 - tier.pct) / 100);
           tags.push({ text: `Â∑≤‰∫´ ${100-tier.pct} Êäò`, cls: "save" });
         }
      }
    }

    const bogo = RULES.bogo.find(b => b.code === it.code);
    if(bogo) {
      const set = bogo.buy + bogo.get;
      const free = Math.floor(it.qty/set) * bogo.get;
      finalLine -= free * it.price;
      if(free > 0) tags.push({ text: `Ë≤∑${bogo.buy}ÈÄÅ${bogo.get}`, cls: "save" });
      if(it.qty % set !== 0) warnings.push(it.name);
    }

    finalTotal += finalLine;
    if(it.category.includes("ÁæéÂÆπ")) beautyTotal += finalLine;
    return { ...it, finalLine, tags };
  });

  const gifts = [];
  RULES.spend.forEach(r => {
    let basis = (r.scope === "zone_prefix") ? beautyTotal : finalTotal;
    if(basis >= r.amt) {
      let qty = r.mult ? Math.floor(basis / r.amt) * r.qty : r.qty;
      if(qty > 0) gifts.push({ name: (PRODUCT_MAP.get(r.gift) || {name: r.gift}).name, qty, code: r.gift });
    }
  });

  return { items: processedItems, subTotal, finalTotal, discountAmt: subTotal - finalTotal, beautyTotal, gifts, warnings };
}

function refreshCart() {
  const data = calcCart();
  const list = document.getElementById("cartList");
  list.innerHTML = "";
  
  document.querySelector(".fb-total").innerText = "$" + Math.round(data.finalTotal).toLocaleString();
  document.querySelector(".fb-count").innerText = CART.reduce((a,b)=>a+b.qty,0) + " ‰ª∂";
  
  data.items.forEach((it, index) => {
    let specStr = it.bundleSelection ? `ÁµÑÂêàÔºö${it.bundle[it.bundleSelection[0]].name} + ${it.bundle[it.bundleSelection[1]].name}` : (it.spec || "");
    let priceHtml = (it.finalLine < it.price * it.qty) ? `<span class="c-old">$${(it.price*it.qty).toLocaleString()}</span> $${Math.round(it.finalLine).toLocaleString()}` : `$${Math.round(it.finalLine).toLocaleString()}`;
    
    const div = document.createElement("div"); div.className = "c-item";
    div.innerHTML = `<div class="c-info"><div class="c-title">${it.name}</div><div class="c-spec">${specStr}</div><div class="c-tags">${it.tags.map(t=>`<span class="c-tag ${t.cls}">${t.text}</span>`).join("")}</div><div class="c-price-box">${priceHtml}</div></div>
      <div class="c-ctrl"><div class="stepper"><div class="s-btn" onclick="window.updateCartItem(${index}, -1)">Ôºç</div><div class="s-val">${it.qty}</div><div class="s-btn add" onclick="window.updateCartItem(${index}, 1)">Ôºã</div></div></div>`;
    list.appendChild(div);
  });

  document.getElementById("sumBase").innerText = "$" + data.subTotal.toLocaleString();
  document.getElementById("sumDisc").innerText = "-$" + Math.round(data.discountAmt).toLocaleString();
  document.getElementById("sumPay").innerText = "$" + Math.round(data.finalTotal).toLocaleString();
  document.getElementById("sumBeauty").innerText = "$" + Math.round(data.beautyTotal).toLocaleString();
  
  const warnEl = document.getElementById("warnMsg");
  if(data.warnings.length > 0) { warnEl.style.display = "block"; warnEl.innerText = "‚ö†Ô∏è Ë≤∑‰∏ÄÈÄÅ‰∏ÄÊú™ÊπäÈΩäÔºö" + [...new Set(data.warnings)].join("„ÄÅ"); }
  else warnEl.style.display = "none";
  
  const next = RULES.spend.find(r => r.scope === "all" && r.amt > data.finalTotal);
  const msg = document.getElementById("gameMsg");
  const bar = document.getElementById("gameBar");
  if(next) {
    msg.innerText = `ÂÜç $${(next.amt - data.finalTotal).toLocaleString()} Ëß£ÈéñË¥àÂìÅ`;
    bar.style.width = ((data.finalTotal/next.amt)*100) + "%"; bar.classList.remove("full");
  } else {
    msg.innerText = "üéâ Â∑≤Ëß£ÈéñÊâÄÊúâË¥àÂìÅ"; bar.style.width = "100%"; bar.classList.add("full");
  }
  
  let sumHtml = "";
  data.items.forEach(i => sumHtml += `<div class="sum-line"><span>${i.name}</span><span>x${i.qty}</span></div>`);
  data.gifts.forEach(g => sumHtml += `<div class="sum-line" style="color:#e65100"><span>üéÅ ${g.name}</span><span>x${g.qty}</span></div>`);
  document.getElementById("finalList").innerHTML = sumHtml;
  
  return data;
}

window.onpopstate = (e) => { 
    if(document.getElementById("giftModal").classList.contains("open")) { closeGiftList(); return; }
    if(document.getElementById("milestone-overlay").classList.contains("open")) { closeMilestoneCard(); return; }
    if(isCartOpen) { closeCart(); return; } 
    cleanupUI();
};

window.toggleDelivery = function() {
  const chk = document.getElementById("chkDelivery");
  const form = document.getElementById("deliveryForm");
  const btn = document.getElementById("btnDeliveryCollapse");
  if(chk.checked) {
    form.classList.add("show"); btn.style.display = "inline-flex";
    if(!document.getElementById("dName").value) document.getElementById("dName").value = document.getElementById("fName").value;
  } else {
    form.classList.remove("show"); btn.style.display = "none";
  }
};

window.collapseDelivery = function() {
  if(!document.getElementById("dName").value || !document.getElementById("dPhone").value || !document.getElementById("dAddr").value) {
    showToast("Ë´ãÂ°´Â¶•Êî∂‰ª∂Ë≥áË®ä", "warn"); return;
  }
  document.getElementById("deliveryForm").classList.remove("show");
  document.getElementById("btnDeliveryCollapse").style.display = "none";
  document.getElementById("deliveryStatusText").innerText = "(Â∑≤Â°´Â¶•Êî∂‰ª∂Ë≥áË®ä)";
};

window.submitOrder = () => { 
    const f = (id) => document.getElementById(id).value.trim(); 
    if(!f("fName") || !f("fDept")) { showToast("Ë´ãÂ°´ÂØ´ÂßìÂêçËàáÈÉ®ÈñÄ", "warn"); return; }
    
    const isDelivery = document.getElementById("chkDelivery").checked;
    if (isDelivery && (!f("dName") || !f("dPhone") || !f("dAddr"))) {
        document.getElementById("deliveryForm").classList.add("show");
        showToast("Ë´ãÂ°´ÂØ´ÂÆåÊï¥ÂÆÖÈÖçË≥áË®ä", "warn"); return;
    }

    const data = calcCart(); 
    if(data.warnings.length > 0) { showToast("Ë≤∑‰∏ÄÈÄÅ‰∏ÄÊú™ÊπäÈΩä", "warn"); return; } 

    const btn = document.querySelector(".btn-submit"); 
    btn.innerText = "ÂÇ≥ÈÄÅ‰∏≠..."; btn.disabled = true; 

    const payload = { 
        employee_name: f("fName"), department: f("fDept"), payment_method: f("fPay"), remarks: f("fNote"), 
        totals: { base: data.subTotal, discount: Math.round(data.discountAmt), pay: Math.round(data.finalTotal) }, 
        items: data.items.map(it => ({
            product_code: it.code, product_name: it.name, 
            spec: it.bundleSelection ? `[ÁµÑÂêà] ${it.bundle[it.bundleSelection[0]].name} + ${it.bundle[it.bundleSelection[1]].name}` : (it.spec||""),
            qty: it.qty, line_total: Math.round(it.finalLine)
        })), 
        gifts: data.gifts.map(g => ({ product_code: g.code, product_name: `[Ë¥àÂìÅ] ${g.name}`, qty: g.qty })),
        pickup_method: isDelivery ? 'ÂÆÖÈÖç' : 'Ëá™Âèñ',
        pickup_info: isDelivery ? { name: f("dName"), phone: f("dPhone"), address: f("dAddr"), note: f("dNote") } : null
    }; 

    fetch(GAS_URL, { 
        method: "POST", headers: { "Content-Type": "application/x-www-form-urlencoded" }, 
        body: "payload=" + encodeURIComponent(JSON.stringify(payload)) 
    })
    .then(r => r.json()).then(res => { 
        if(res.ok) { showToast("Ë®ÇË≥ºÊàêÂäüÔºÅ"); openReceipt(res.order_id); } 
        else alert("Â§±ÊïóÔºö" + res.error); 
    })
    .catch(() => alert("ÈÄ£Á∑öÈåØË™§"))
    .finally(() => { btn.innerText = "Á¢∫Ë™çË®ÇË≥º"; btn.disabled = false; }); 
};

function openReceipt(orderId) { 
    const modal = document.getElementById("receiptModal"); 
    document.getElementById("rcOrderId").innerText = `No. ${orderId}`; 
    let html = ""; 
    lastOrderData.items.forEach(it => { html += `<div class="rc-item"><div class="rc-name">${it.product_name}</div><div class="rc-meta"><span>${it.spec}</span><span>x${it.qty}</span><span>$${it.line_total}</span></div></div>`; }); 
    if(lastOrderData.gifts.length > 0) { 
        html += `<div class="rc-row bold" style="color:#e65100">ÊªøÈ°çË¥àÂìÅ</div>`; 
        lastOrderData.gifts.forEach(g => { html += `<div class="rc-item"><div class="rc-name" style="color:#e65100">üéÅ ${g.product_name}</div><div class="rc-meta"><span></span><span>x${g.qty}</span><span>ÂÖçË≤ª</span></div></div>`; }); 
    } 
    html += `<div class="rc-row bold"><span>Á∏ΩË®àÈáëÈ°ç</span><span>$${lastOrderData.totals.pay}</span></div>`; 
    document.getElementById("rcBody").innerHTML = html; modal.classList.add("open"); 
}

function closeReceipt() { 
    CART = []; achievedGifts = []; saveState(); refreshCart(); closeCart(); renderList(); 
    document.getElementById("receiptModal").classList.remove("open"); 
}

function toggleEmailInput() { document.getElementById("emailBox").classList.toggle("show"); }

function sendReceipt() {
    const email = document.getElementById("rcEmail").value.trim();
    if(!email.includes('@')) { showToast("Email Ê†ºÂºèÈåØË™§", "warn"); return; }
    const payload = { action: 'send_email', email: email, order_id: document.getElementById("rcOrderId").innerText, order_data: lastOrderData };
    fetch(GAS_URL, { method: "POST", body: "payload=" + encodeURIComponent(JSON.stringify(payload)) })
    .then(() => { showToast("Â∑≤ÂØÑÈÄÅ"); toggleEmailInput(); });
}

window.addEventListener('scroll', () => {
  const btn = document.getElementById('back-to-top');
  btn.classList.toggle('show', window.scrollY > 300);
});

initApp();
</script>
</body>
</html>