<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover"/>
<title>ç”ŸæŠ€å±•è¨‚è³¼ç³»çµ± V28-Fixed-Opt</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&family=Roboto:wght@500;700;900&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

<style>
/* --- CORE VARIABLES --- */
:root {
  --primary: #00897b; --primary-light: #e0f2f1; --accent: #ff6f00; 
  --beauty: #d81b60; 
  --bg-body: #f8f9fa; --bg-card: #ffffff; --text-main: #263238; --text-sub: #546e7a;
  --border: #eceff1; --header-height: 100px; /* ç·Šç¸® 15px */
  --shadow-card: 0 4px 20px rgba(0,0,0,0.04);
  --safe-bottom: env(safe-area-inset-bottom, 20px);
}
* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
body {
  font-family: 'Noto Sans TC', sans-serif; background: var(--bg-body); color: var(--text-main);
  margin: 0; padding: 0; 
  padding-bottom: calc(110px + var(--safe-bottom)); 
  overscroll-behavior-y: none;
}
body.modal-open { overflow: hidden; height: 100vh; position: fixed; width: 100%; }

/* --- å°è¦½åˆ—è³ªæ„Ÿå„ªåŒ–ï¼šæ·¡å…¥æ·¡å‡º --- */
.cat-wrap {
  position: relative;
  background: #fff;
  /* åŠ å…¥å·¦å³æ·¡å…¥æ·¡å‡ºé®ç½© */
  mask-image: linear-gradient(to right, transparent, black 15%, black 85%, transparent);
  -webkit-mask-image: linear-gradient(to right, transparent, black 15%, black 85%, transparent);
}
.cat-nav { 
  display: flex; gap: 6px; padding: 6px 16px 10px; overflow-x: auto; 
  scrollbar-width: none; align-items: center; justify-content: flex-start;
}
.cat-nav::-webkit-scrollbar { display: none; }
.cat-pill { 
  white-space: nowrap; padding: 5px 14px; border-radius: 20px; 
  font-size: 13px; font-weight: 500; color: var(--text-sub); 
  background: #fff; border: 1px solid #e0e0e0; cursor: pointer; transition: 0.25s; 
}
.cat-pill.active { background: var(--primary); color: #fff; border-color: var(--primary); font-weight: 700; transform: scale(1.05); }

/* --- è³¼ç‰©è»Šé¢æ¿æ ¸å¿ƒä½ˆå±€ï¼šé˜²æ­¢æ“ å£“ --- */
#drawer-panel {
  position: absolute; top: 0; right: 0; bottom: 0; width: 100%; max-width: 480px; 
  background: #fff; transform: translateX(100%); transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
  display: flex; flex-direction: column; 
  pointer-events: auto; box-shadow: -5px 0 30px rgba(0,0,0,0.15);
}
.dr-head { flex-shrink: 0; padding: 12px 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: #fff; }
.dr-body { 
  flex: 1; /* è‡ªå‹•åˆ†é…å‰©é¤˜ç©ºé–“ */
  overflow-y: auto; 
  padding: 12px; background: #f4f6f8; overscroll-behavior: contain; 
}

/* --- ç·Šç¸® Footer é–“è· --- */
.dr-foot { 
  flex-shrink: 0; padding: 12px 20px; 
  padding-bottom: calc(10px + var(--safe-bottom)); 
  background: #fff; border-top: 1px solid var(--border);
}
.form-grid { gap: 8px; margin-top: 10px; display: grid; grid-template-columns: 1fr 1fr; }
input, select { padding: 10px 12px; font-size: 14px; border-radius: 10px; border: 1px solid #cfd8dc; width: 100%; }
.btn-submit { width: 100%; padding: 14px; background: #263238; color: #fff; border: none; border-radius: 12px; font-size: 16px; font-weight: 700; cursor: pointer; margin-top: 12px; }

/* --- åŸæœ‰ V28 å®Œæ•´æ¨£å¼ä¿ç•™ --- */
.flying-img { position: fixed; z-index: 9999; pointer-events: none; border-radius: 50%; box-shadow: 0 5px 25px rgba(0,0,0,0.25); width: 60px; height: 60px; object-fit: cover; background: #fff; border: 2px solid #fff; transition: top 1s cubic-bezier(0.19, 1, 0.22, 1), left 1s cubic-bezier(0.19, 1, 0.22, 1), transform 1s ease-in, opacity 1s ease-in; }
.p-img-box { width: 100%; aspect-ratio: 1/1; background: #fcfcfc; position: relative; display: flex; align-items: center; justify-content: center; overflow: hidden; }
.p-img-box img { width: 100%; height: 100%; object-fit: contain; transition: opacity 0.4s ease; opacity: 0; mix-blend-mode: multiply; }
.p-img-box img.loaded { opacity: 1; }
#welcome-overlay, #loader { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; display: flex; align-items: center; justify-content: center; }
#welcome-overlay { z-index: 9999; background: rgba(236, 239, 241, 0.85); backdrop-filter: blur(8px); transition: opacity 0.5s ease; }
#loader { z-index: 9990; background: #f4f6f8; align-items: flex-start; padding-top: 120px; transition: opacity 0.3s ease; }
#welcome-overlay.fade-out { opacity: 0; pointer-events: none; }
main { padding: 12px; max-width: 900px; margin: 0 auto; margin-top: 10px; }
.grid-layout { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 10px; align-content: start; width: 100%; }
@media (max-width: 480px) { .grid-layout { grid-template-columns: repeat(2, 1fr) !important; gap: 8px; } }
.p-card { background: #fff; border-radius: 16px; overflow: hidden; position: relative; box-shadow: var(--shadow-card); border: 1px solid #f0f0f0; display: flex; flex-direction: column; transition: transform 0.15s; scroll-margin-top: 200px; padding-bottom: 8px; }
.p-card:active { transform: scale(0.97); }
.p-body { padding: 10px; flex: 1; display: flex; flex-direction: column; justify-content: space-between; }
.p-title { font-size: 13px; font-weight: 700; line-height: 1.4; color: #37474f; margin-bottom: 4px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; height: 38px; }
.p-price { font-size: 16px; font-weight: 800; color: #263238; }
.stepper { display: flex; align-items: center; justify-content: flex-end; gap: 8px; margin-top: 8px; }
.s-btn { width: 30px; height: 30px; border-radius: 50%; border: 1px solid #eceff1; background: #fff; color: var(--primary); font-size: 18px; display: flex; align-items: center; justify-content: center; cursor: pointer; }
.s-btn.add { background: var(--primary); color: #fff; border-color: var(--primary); box-shadow: 0 2px 5px rgba(0,137,123,0.3); }

#float-bar { position: fixed; bottom: calc(20px + var(--safe-bottom)); left: 16px; right: 16px; background: #263238; color: #fff; border-radius: 60px; padding: 8px 8px 8px 24px; box-shadow: 0 15px 35px rgba(0,0,0,0.25); display: flex; align-items: center; justify-content: space-between; z-index: 2000; cursor: pointer; backdrop-filter: blur(10px); transition: transform 0.3s; }
#float-bar.hidden { transform: translateY(200%); }
.fb-total { font-size: 18px; font-weight: 700; }
.fb-btn { background: var(--accent); color: #fff; padding: 10px 24px; border-radius: 40px; font-weight: 700; font-size: 14px; display: flex; align-items: center; gap: 6px; }

#drawer { position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 1200; pointer-events: none; }
#drawer-bg { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); opacity: 0; transition: 0.3s; backdrop-filter: blur(4px); }
#drawer.open #drawer-bg { opacity: 1; pointer-events: auto; }
#drawer.open #drawer-panel { transform: translateX(0); }

.c-item { display: flex; gap: 10px; margin-bottom: 8px; padding: 10px; background: #fff; border-radius: 10px; border: 1px solid #e0e0e0; align-items: center; }
.c-info { flex: 1; }
.c-title { font-size: 14px; font-weight: 700; color:#37474f; }
.c-price-box { font-weight:700; font-size:15px; color:#263238; }

.ms-card-v { background: #fff; width: 95%; max-width: 400px; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.25); display: flex; flex-direction: column; overflow: hidden; max-height: 85vh; transform: scale(0.9); transition: transform 0.3s; }
.ms-dual-body { flex: 1; overflow-y: auto; padding: 10px; display: grid; grid-template-columns: 1fr 1fr; gap: 8px; background: #fafafa; }
.g-thumb { width: 42px; height: 42px; object-fit: contain; border: 1px solid #eee; border-radius: 6px; background: #fff; }

.badges { position: absolute; top: 6px; left: 6px; display: flex; flex-direction: column; gap: 4px; z-index: 2; }
.badge { font-size: 9px; padding: 3px 6px; border-radius: 4px; color: #fff; font-weight: 700; }
.bg-red { background: #ef5350; }
.bg-blue { background: #42a5f5; }
.bg-gold { background: #ffa726; }
</style>
</head>
<body>

<div id="welcome-overlay">
  <div style="background:#fff; width:85%; max-width:350px; padding:40px 20px; border-radius:30px; text-align:center; box-shadow: 0 10px 30px rgba(0,0,0,0.1);">
    <span class="material-icons-round" style="font-size: 50px; color: #00897b">spa</span>
    <div style="font-size: 22px; font-weight: 900; color: #00897b; margin: 15px 0;">Welcome<br>å°é…’ç”ŸæŠ€å±•å”®ç¶²</div>
    <button onclick="closeWelcome()" style="background: #00897b; color: #fff; border: none; padding: 14px 40px; border-radius: 50px; font-size: 16px; font-weight: 700; cursor: pointer;">é–‹å§‹è¨‚è³¼</button>
  </div>
</div>

<header>
  <div class="search-wrap">
    <div class="search-box">
      <span class="material-icons-round" style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-sub);">search</span>
      <input id="searchInp" type="text" placeholder="æœå°‹å•†å“..." style="width: 100%; padding: 10px 12px 10px 40px; border-radius: 12px; border: 1px solid #e0e0e0; background: #f5f7f9; outline: none; font-size: 14px;">
    </div>
  </div>
  <div class="cat-wrap">
    <nav class="cat-nav" id="catNav"></nav>
  </div>
</header>

<main id="list"></main>

<div id="float-bar" class="hidden" onclick="openCart()">
  <div class="fb-info"><span class="fb-total">$0</span><span class="fb-count">0 ä»¶å•†å“</span></div>
  <div class="fb-btn">çµå¸³ <span class="material-icons-round" style="font-size:18px">arrow_forward</span></div>
</div>

<div id="drawer">
  <div id="drawer-bg" onclick="closeCart()"></div>
  <div id="drawer-panel">
    <div class="dr-head">
      <h2 style="margin:0; font-size:20px; font-weight:900;">æˆ‘çš„è³¼ç‰©è»Š</h2>
      <span class="material-icons-round" onclick="closeCart()" style="cursor:pointer; padding:6px; background:#f5f5f5; border-radius:50%">close</span>
    </div>
    <div class="dr-body">
      <div id="cartList"></div>
    </div>
    <div class="dr-foot">
      <div style="display:flex; justify-content:space-between; font-size:20px; font-weight:900; color:#263238"><span>æ‡‰ä»˜é‡‘é¡</span><span id="sumPay">$0</span></div>
      <div class="form-grid">
        <input id="fName" placeholder="è¨‚è³¼äººå§“å">
        <select id="fDept"><option value="" disabled selected>é¸æ“‡éƒ¨é–€</option></select>
        <select id="fPay"><option value="ç¾é‡‘">ç¾é‡‘</option><option value="ä¿¡ç”¨å¡">ä¿¡ç”¨å¡</option><option value="è–ªæ‰£">è–ªæ‰£</option></select>
      </div>
      <button class="btn-submit" onclick="submitOrder()">é€å‡ºè¨‚å–®</button>
    </div>
  </div>
</div>

<div id="milestone-overlay" style="position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:3000; display:none; align-items:center; justify-content:center; backdrop-filter:blur(3px);">
  <div class="ms-card-v">
    <div style="padding:16px; border-bottom:1px solid #eee; text-align:center; font-weight:900;">ğŸ æ»¿é¡è´ˆé”æ¨™é€²åº¦</div>
    <div class="ms-dual-body" id="msNodes"></div>
    <div style="padding:16px;"><button onclick="closeMilestoneCard()" style="width:100%; padding:12px; background:#f5f5f5; border:none; border-radius:12px; font-weight:700; cursor:pointer;">è¿”å›è³¼ç‰©</button></div>
  </div>
</div>

<div id="loader" style="position:fixed; inset:0; background:#fff; z-index:9999; display:flex; align-items:center; justify-content:center; font-weight:700; color:var(--primary);">è³‡æ–™è¼‰å…¥ä¸­...</div>

<script>
// --- JavaScript é‚è¼¯ 100% å®Œæ•´ç‰ˆ ---
const SHEET_P = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQBtV8q3Ank7Bnhs83IbOb97U46juV-RKeL3NpdFiNcSu-ifI21fQYo1-io62S3JIrXEO5MiDArc1Lr/pub?gid=1623055155&single=true&output=csv";
const SHEET_R = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQU95r9_TOPlQXY-lcBS_RH3tRc0mtRyuazxHHWljpRusbzBiWsEfm3Pa_HZmKW5Ob5TOq4W5O-vumI/pub?gid=2071879068&single=true&output=csv";
const SHEET_RANK = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQj5QLrtaWikGcLNwMawbjiN8ZQDgFzW1RV7UECFgLzECWj16I2ugE_B6tzzLICCynsk1L6lAuJfccS/pub?gid=93142219&single=true&output=csv";
const GAS_URL = "https://script.google.com/macros/s/AKfycbxQ9Etloak3ZNv6yfyMCK9KbjoLyDqjRQHHVlASY5iMwwy_c4NCPxWpMK1YkzSXstHN/exec";

const PROXY = (url) => "https://api.allorigins.win/raw?url=" + encodeURIComponent(url);

async function fetchData(url) {
    try {
        const response = await fetch(url);
        if (response.ok) return await response.text();
        throw new Error('Direct failed');
    } catch (e) {
        return await fetch(PROXY(url)).then(r => r.text());
    }
}

let PRODUCTS = [], RULES = {}, CART = [], PRODUCT_MAP = new Map(), GIFT_MAP = new Map(), isFirstAdd = true;

async function initApp() {
    try {
        const [pText, rText] = await Promise.all([fetchData(SHEET_P), fetchData(SHEET_R)]);
        const pData = Papa.parse(pText, { header: true, skipEmptyLines: true }).data;
        PRODUCTS = pData.map((row, i) => {
            const code = row.product_code?.trim(), name = row.product_name?.trim();
            if(!code || !name) return null;
            const p = { _id: i, code, name, category: row.category?.trim(), price: Number(row.list_price?.replace(/,/g,'')||0), photo: row['photos url'] };
            PRODUCT_MAP.set(code, p);
            if(p.photo) GIFT_MAP.set(code, p.photo);
            return p;
        }).filter(x => x);

        const rData = Papa.parse(rText, { header: true, skipEmptyLines: true }).data;
        RULES = { tiers: [], bogo: [], spend: [] };
        rData.forEach(row => {
            const type = row.rule_type?.toLowerCase();
            if(type?.includes("tier")) RULES.tiers.push({ zone: row.zone.trim(), min: Number(row.min_qty), pct: Number(row.percent_off) });
            else if(type?.includes("spend")) RULES.spend.push({ scope: row.threshold_scope, prefix: row.zone_prefix, amt: Number(row.threshold_amount), gift: row.gift_code, qty: Number(row.gift_qty), mult: row.multiples?.toUpperCase()==="TRUE" });
        });

        renderUI();
        loadConfigOptions();
        document.getElementById("loader").style.display = "none";
    } catch(e) { console.error("Init Error", e); }
}

function renderUI() {
    const nav = document.getElementById("catNav"), list = document.getElementById("list");
    const cats = [...new Set(PRODUCTS.map(p => p.category))].filter(Boolean);
    nav.innerHTML = `<div class="cat-pill active" onclick="scrollToCat('cat-all')">ç†±éŠ·æ¨è–¦</div>`;
    cats.forEach(c => { nav.innerHTML += `<div class="cat-pill" onclick="scrollToCat('cat-${c.replace(/\s+/g,'-')}')">${c}</div>`; });
    
    list.innerHTML = `<div id="cat-all"></div>`;
    cats.forEach(cat => {
        const sec = document.createElement("div"); sec.id = `cat-${cat.replace(/\s+/g,'-')}`;
        sec.innerHTML = `<h3 style="padding:15px 12px 8px; font-size:16px; border-bottom:2px solid #e0f2f1; color:#00897b; font-weight:900;">${cat}</h3>`;
        const grid = document.createElement("div"); grid.className = "grid-layout";
        PRODUCTS.filter(p => p.category === cat).forEach(p => {
            const card = document.createElement("div"); card.className = "p-card";
            card.innerHTML = `
                <div class="p-img-box"><img src="${p.photo}" onload="this.classList.add('loaded')"></div>
                <div class="p-body">
                    <div class="p-title">${p.name}</div>
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <span class="p-price">$${p.price.toLocaleString()}</span>
                        <div class="stepper"><div class="s-btn add" onclick="updateQty(${p._id}, 1)">ï¼‹</div></div>
                    </div>
                </div>`;
            grid.appendChild(card);
        });
        sec.appendChild(grid); list.appendChild(sec);
    });
}

function updateQty(pid, delta) {
    const p = PRODUCTS.find(x => x._id === pid);
    let item = CART.find(i => i.code === p.code);
    if(item) { item.qty += delta; if(item.qty <= 0) CART = CART.filter(i => i !== item); }
    else if(delta > 0) CART.push({...p, qty: 1});
    if(delta > 0 && isFirstAdd) { isFirstAdd = false; showMilestoneCard(); }
    refreshCart();
}

function refreshCart() {
    const list = document.getElementById("cartList"), sum = document.getElementById("sumPay"), fb = document.querySelector(".fb-total");
    let total = 0; list.innerHTML = "";
    CART.forEach(it => {
        const line = it.price * it.qty; total += line;
        list.innerHTML += `<div class="c-item"><div class="c-info"><div class="c-title">${it.name}</div><div style="font-size:12px; color:#90a4ae">$${it.price.toLocaleString()} x ${it.qty}</div></div><div style="font-weight:700">$${line.toLocaleString()}</div></div>`;
    });
    sum.innerText = "$" + total.toLocaleString(); fb.innerText = "$" + total.toLocaleString();
    document.getElementById("float-bar").classList.toggle("hidden", CART.length === 0);
}

function showMilestoneCard() {
    const nodes = document.getElementById("msNodes"); nodes.innerHTML = "";
    const total = CART.reduce((a,b) => a + (b.price*b.qty), 0);
    const beautyTotal = CART.filter(i => i.category.includes("ç¾å®¹")).reduce((a,b) => a + (b.price*b.qty), 0);
    
    RULES.spend.sort((a,b) => a.amt - b.amt).forEach(r => {
        const basis = r.scope === "all" ? total : beautyTotal;
        const reached = basis >= r.amt;
        const giftP = PRODUCT_MAP.get(r.gift);
        const img = GIFT_MAP.get(r.gift) ? `<img src="${GIFT_MAP.get(r.gift)}" class="g-thumb">` : "ğŸ";
        nodes.innerHTML += `<div style="padding:10px; border:1px solid ${reached?'#00897b':'#eee'}; border-radius:12px; background:${reached?'#f1f8e9':'#fff'}; text-align:center; opacity:${reached?1:0.6};">
            <div style="font-size:10px; background:${reached?'#00897b':'#ccc'}; color:#fff; border-radius:10px; padding:2px 6px; display:inline-block; margin-bottom:5px;">$${r.amt.toLocaleString()}</div>
            <div>${img}</div><div style="font-size:11px; margin-top:5px; font-weight:700;">${giftP?.name || r.gift}</div>
        </div>`;
    });
    document.getElementById("milestone-overlay").style.display = "flex";
}

function closeMilestoneCard() { document.getElementById("milestone-overlay").style.display = "none"; }
function openCart() { document.getElementById("drawer").classList.add("open"); document.body.classList.add("modal-open"); }
function closeCart() { document.getElementById("drawer").classList.remove("open"); document.body.classList.remove("modal-open"); }
function closeWelcome() { document.getElementById("welcome-overlay").style.opacity="0"; setTimeout(()=>document.getElementById("welcome-overlay").style.display="none", 500); }
function scrollToCat(id) { const el = document.getElementById(id); if(el) window.scrollTo({ top: el.offsetTop - 110, behavior: 'smooth' }); }

function loadConfigOptions() {
    fetch(GAS_URL, { method: "POST", body: "payload=" + encodeURIComponent(JSON.stringify({action:"get_config"})) })
    .then(r => r.json()).then(res => {
        const d = document.getElementById("fDept");
        res.departments?.forEach(x => { if(x.active!==false) d.innerHTML += `<option value="${x.value}">${x.label}</option>`; });
    });
}

function submitOrder() {
    const name = document.getElementById("fName").value.trim();
    if(!name || !CART.length) return alert("è«‹å¡«å¯«è¨‚è³¼è³‡æ–™");
    const btn = event.target; btn.innerText = "å‚³é€ä¸­..."; btn.disabled = true;
    fetch(GAS_URL, { method: "POST", body: "payload=" + encodeURIComponent(JSON.stringify({employee_name:name, items:CART})) })
    .then(r => r.json()).then(res => { if(res.ok) { alert("è¨‚å–®æˆåŠŸï¼å–®è™Ÿ:" + res.order_id); CART=[]; refreshCart(); closeCart(); } })
    .finally(() => { btn.innerText = "é€å‡ºè¨‚å–®"; btn.disabled = false; });
}

initApp();
</script>
</body>
</html>