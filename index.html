<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover"/>
<title>ç”ŸæŠ€å±•è¨‚è³¼ç³»çµ± v29</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&family=Roboto:wght@500;700;900&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

<style>
/* --- CORE VARIABLES --- */
:root {
  --primary: #00897b; --primary-light: #e0f2f1; --accent: #ff6f00; 
  --beauty: #d81b60; 
  --bg-body: #f8f9fa; --bg-card: #ffffff; --text-main: #263238; --text-sub: #546e7a;
  --border: #eceff1; --header-height: 115px;
  --shadow-card: 0 4px 20px rgba(0,0,0,0.04);
  --safe-bottom: env(safe-area-inset-bottom, 20px);
  --price-size: 17px;
  --price-size-lg: calc(var(--price-size) + 2px);
}
* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
body {
  font-family: 'Noto Sans TC', sans-serif; background: var(--bg-body); color: var(--text-main);
  margin: 0; padding: 0; 
  padding-bottom: calc(120px + var(--safe-bottom)); 
  overscroll-behavior-y: none;
}
body.modal-open { overflow: hidden; height: 100vh; position: fixed; width: 100%; }

@media (max-width: 768px) {
  input, select, textarea { font-size: 16px !important; }
}

/* --- OPTIMIZATION: Natural Flying Animation --- */
.flying-img { 
  position: fixed; z-index: 9999; pointer-events: none; border-radius: 50%; 
  box-shadow: 0 5px 25px rgba(0,0,0,0.25); 
  width: 60px; height: 60px; object-fit: cover; background: #fff; border: 2px solid #fff;
  transition: top 1s cubic-bezier(0.19, 1, 0.22, 1), 
              left 1s cubic-bezier(0.19, 1, 0.22, 1), 
              transform 1s ease-in, 
              opacity 1s ease-in;
}

.p-img-box { 
  width: 100%; aspect-ratio: 1/1; 
  background: #fcfcfc; 
  position: relative; display: flex; align-items: center; justify-content: center; overflow: hidden; 
}
.p-img-box img { 
  width: 100%; height: 100%; object-fit: contain; 
  transition: opacity 0.4s ease; opacity: 0; 
  mix-blend-mode: multiply; 
}
.p-img-box img.loaded { opacity: 1; }

/* --- FIX: WELCOME & LOADER --- */
#welcome-overlay, #loader {
  position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
  display: flex; align-items: center; justify-content: center;
}
#welcome-overlay { z-index: 9999; background: rgba(236, 239, 241, 0.85); backdrop-filter: blur(8px); transition: opacity 0.5s ease; }
#loader { z-index: 9990; background: #f4f6f8; align-items: flex-start; padding-top: 120px; transition: opacity 0.3s ease; }
#welcome-overlay.fade-out { opacity: 0; pointer-events: none; }

/* --- LAYOUT --- */
main { padding: 12px; max-width: 900px; margin: 0 auto; margin-top: 10px; }
.grid-layout { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 12px; align-content: start; width: 100%; }
@media (max-width: 480px) { .grid-layout { grid-template-columns: repeat(2, 1fr) !important; gap: 10px; } }

/* Ranking UI */
#ranking-section { background: #fff; margin: 10px 12px 20px; padding: 12px; border-radius: 16px; border: 1px solid #eceff1; box-shadow: 0 4px 15px rgba(0,0,0,0.03); display: none; }
.rank-head { padding: 0 4px 8px; display: flex; align-items: center; gap: 12px; overflow: hidden; }
.rank-title { font-size: 15px; font-weight: 900; color: #d81b60; white-space: nowrap; flex-shrink: 0; display: flex; align-items: center; gap: 4px; }
.rank-tabs { display: flex; gap: 8px; overflow-x: auto; scrollbar-width: none; flex: 1; mask-image: linear-gradient(to right, black 85%, transparent 100%); -webkit-mask-image: linear-gradient(to right, black 85%, transparent 100%); }
.rank-tabs::-webkit-scrollbar { display: none; }
.r-tab { font-size: 12px; font-weight: 500; color: #90a4ae; cursor: pointer; white-space: nowrap; padding: 4px 10px; border-radius: 20px; background: #f5f5f5; transition: 0.2s; }
.r-tab.active { color: #fff; background: #d81b60; font-weight: 700; box-shadow: 0 2px 5px rgba(216, 27, 96, 0.3); }
.rank-list { display: flex; gap: 10px; padding: 4px 0 8px; overflow-x: auto; scroll-behavior: smooth; scrollbar-width: none; -ms-overflow-style: none; }
.rank-list::-webkit-scrollbar { display: none; }
.r-card { flex: 0 0 76px; display: flex; flex-direction: column; align-items: center; gap: 6px; cursor: pointer; transition: transform 0.1s; }
.r-card:active { transform: scale(0.96); }
.r-img-wrap { width: 76px; height: 76px; border-radius: 14px; background: #fff; border: 1px solid #eee; position: relative; padding: 2px; box-shadow: 0 2px 6px rgba(0,0,0,0.03); overflow: hidden; }
.r-img { width: 100%; height: 100%; object-fit: contain; mix-blend-mode: multiply; }
.r-badge { position: absolute; top: 0; left: 0; width: 22px; height: 22px; border-bottom-right-radius: 8px; background: rgba(0,0,0,0.7); color: #fff; font-size: 11px; font-weight: 900; display: flex; align-items: center; justify-content: center; z-index: 2; }
.r-card[data-rank="1"] .r-badge { background: #ffd700; color: #3e2723; }
.r-card[data-rank="2"] .r-badge { background: #cfd8dc; color: #37474f; }
.r-card[data-rank="3"] .r-badge { background: #d7ccc8; color: #3e2723; }
.r-sold-tag { position: absolute; bottom: 3px; right: 3px; background: linear-gradient(135deg, #ff7043, #f4511e); color: #fff; font-size: 9px; font-weight: 700; padding: 2px 6px; border-radius: 8px; box-shadow: 0 2px 4px rgba(244, 81, 30, 0.2); z-index: 2; }
.r-name { font-size: 10px; font-weight: 500; color: #37474f; text-align: center; line-height: 1.3; height: 2.6em; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; width: 100%; }

/* --- Float Bar & Buttons --- */
#float-bar { 
  position: fixed; 
  bottom: calc(20px + var(--safe-bottom)); 
  left: 16px; right: 16px; 
  background: #263238; color: #fff; border-radius: 60px; 
  padding: 10px 10px 10px 24px; box-shadow: 0 15px 35px rgba(0,0,0,0.25); 
  display: flex; align-items: center; justify-content: space-between; 
  z-index: 2000 !important; cursor: pointer; backdrop-filter: blur(10px); 
  transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}
#float-bar.hidden { transform: translateY(200%); }
.fb-total { font-size: 18px; font-weight: 700; }
.fb-count { font-size: 12px; opacity: 0.7; }
.fb-btn { 
  background: var(--accent); color: #fff; padding: 10px 24px; border-radius: 40px; 
  font-weight: 700; font-size: 15px; box-shadow: 0 4px 15px rgba(255,111,0,0.4); 
  display: flex; align-items: center; gap: 6px; transition: 0.1s;
}
.fb-btn:active { background: #e65100; transform: scale(0.98); }

#gift-fab {
  position: fixed; bottom: calc(90px + var(--safe-bottom)); left: 20px;
  width: 50px; height: 50px; border-radius: 50%;
  background: #fff; border: 2px solid #ffd54f;
  box-shadow: 0 4px 15px rgba(255, 160, 0, 0.3);
  display: flex; align-items: center; justify-content: center;
  font-size: 24px; cursor: pointer; z-index: 1090;
  transition: transform 0.2s;
  display: none; 
}
#gift-fab:active { transform: scale(0.9); }
@keyframes shakeGift { 0% { transform: rotate(0deg); } 25% { transform: rotate(-15deg); } 50% { transform: rotate(15deg); } 75% { transform: rotate(-15deg); } 100% { transform: rotate(0deg); } }
.gift-shake { animation: shakeGift 0.5s ease-in-out 2; box-shadow: 0 0 20px rgba(255, 193, 7, 0.8) !important; }

#back-to-top {
  position: fixed; bottom: calc(90px + var(--safe-bottom)); right: 20px; 
  width: 45px; height: 45px; border-radius: 50%;
  background: rgba(255, 255, 255, 0.9); color: var(--primary);
  box-shadow: 0 4px 12px rgba(0,0,0,0.15); border: 1px solid #eee;
  display: flex; align-items: center; justify-content: center;
  z-index: 1090; cursor: pointer; opacity: 0; pointer-events: none;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); transform: translateY(20px);
}
#back-to-top.show { opacity: 1; pointer-events: auto; transform: translateY(0); }

/* --- Top Notification --- */
#top-notify {
  position: fixed; top: 16px; left: 16px; right: 16px;
  background: rgba(33, 33, 33, 0.95); color: #fff;
  padding: 12px 20px; border-radius: 16px; 
  display: flex; flex-direction: column; gap: 4px;
  box-shadow: 0 8px 30px rgba(0,0,0,0.3); 
  z-index: 3000; transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1), opacity 0.4s;
  backdrop-filter: blur(8px);
  transform: translateY(-150%); opacity: 0; pointer-events: none;
}
#top-notify.show { transform: translateY(0); opacity: 1; pointer-events: auto; }
.tn-head { display: flex; align-items: center; gap: 8px; font-weight: 700; color: #ffd54f; font-size: 14px; margin-bottom: 2px; }
.tn-body { font-size: 13px; line-height: 1.5; color: #fff; white-space: normal; }

/* --- Milestone Card --- */
#milestone-overlay {
  position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 3000;
  display: flex; align-items: center; justify-content: center;
  opacity: 0; pointer-events: none; transition: opacity 0.3s; backdrop-filter: blur(2px);
}
#milestone-overlay.open { opacity: 1; pointer-events: auto; }
.ms-card-v {
  background: #fff; width: 95%; max-width: 400px; 
  border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.25); 
  display: flex; flex-direction: column; overflow: hidden;
  max-height: 85vh; transform: scale(0.9); transition: transform 0.3s;
}
#milestone-overlay.open .ms-card-v { transform: scale(1); }
.ms-card-v.shrinking { animation: shrinkToFab 0.6s ease-in forwards; }
@keyframes shrinkToFab { 0% { transform: scale(1) translate(0, 0); opacity: 1; } 100% { transform: scale(0.1) translate(-120vw, 100vh); opacity: 0; } }

.ms-header { background: #fff; padding: 16px 50px 16px 16px; border-bottom: 1px solid #eee; position: relative; }

.ms-close{
  position:absolute; top: 12px; right: 12px;
  width: 34px; height: 34px;
  border-radius: 12px;
  border: 1px solid #eee;
  background: #fff;
  display:flex; align-items:center; justify-content:center;
  cursor: pointer;
  color: #607d8b;
  box-shadow: 0 6px 18px rgba(0,0,0,0.06);
}
.ms-close:hover{ background:#fafafa; }
.ms-close:active{ transform: translateY(1px); }

.ms-title-v { font-size: 18px; font-weight: 900; color: #37474f; margin-bottom: 10px; text-align: center; }
.ms-summary-row { display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; border-radius: 8px; margin-bottom: 6px; font-size: 13px; font-weight: 700; }
.ms-sum-all { background: #fff8e1; color: var(--accent); }
.ms-sum-beauty { background: #fce4ec; color: var(--beauty); }
.ms-dual-body { flex: 1; overflow-y: auto; overflow-x: hidden; padding: 8px; display: grid; grid-template-columns: minmax(0,1fr) minmax(0,1fr); gap: 6px; background: #fafafa; overscroll-behavior: contain; }
.ms-track-col { display: flex; flex-direction: column; gap: 10px; position: relative; min-width: 0; }
.ms-track-title { text-align: center; font-size: 12px; color: #90a4ae; font-weight: 700; margin-bottom: 4px; }
.ms-dual-item { background: #fff; border: 1px solid #eee; border-radius: 12px; padding: 10px; display: flex; flex-direction: column; align-items: center; gap: 6px; opacity: 0.5; transition: 0.3s; text-align: center; }
.ms-dual-item.active { opacity: 1; border-color: var(--accent); box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
.ms-track-col.beauty .ms-dual-item.active { border-color: var(--beauty); }

/* --- V29: Milestone 'ä¸‹ä¸€é–€æª»å·®é¡' æ¨™ç±¤ + å‹•æ•ˆï¼ˆ3.1ç§’ï¼‰ --- */
/* ç‰ˆé¢ï¼šæ¯å¼µå¡ç‰‡æ”¹æˆã€Œä¸Šï¼šé–€æª» + æ¨™ç±¤ã€ã€Œä¸‹ï¼šåœ–å·¦æ–‡å­—å³ã€ä»¥æå‡å¯è®€æ€§ */
.ms-dual-item{ position: relative; text-align:left; align-items:stretch; padding: 10px; gap: 8px; }
.ms-dual-item.next{
  opacity: 1;
  border-color: rgba(230,81,0,0.26);
  box-shadow: 0 10px 22px rgba(230,81,0,0.10);
}
.ms-track-col.beauty .ms-dual-item.next{
  border-color: rgba(216,27,96,0.26);
  box-shadow: 0 10px 22px rgba(216,27,96,0.10);
}

.ms-d-head{ display:flex; align-items:flex-start; justify-content:space-between; flex-wrap: wrap; gap: 6px; width: 100%; }
.ms-d-body{
  display:flex;
  align-items:center;
  gap: 10px;
  width: 100%;
}
.ms-d-media{ flex: 0 0 64px; }
.ms-d-media .g-img-row{ display:flex; gap:6px; align-items:center; }
.ms-d-media .g-thumb{ width:64px; height:64px; object-fit:contain; border:1px solid #eee; border-radius: 12px; background:#fff; }
.ms-d-media .g-thumb:not(:first-child){ display:none; } /* åªç§€ç¬¬ä¸€å¼µï¼Œé¿å…æ“ çˆ†æ¬„å¯¬ */

.ms-d-th{
  font-size: 12px;
  color: #fff;
  background: #bdbdbd;
  padding: 4px 8px;
  border-radius: 10px;
  font-weight: 900;
  letter-spacing: .2px;
  line-height: 1;
  white-space: nowrap;
}
.ms-dual-item.active .ms-d-th { background: var(--accent); }
.ms-track-col.beauty .ms-dual-item.active .ms-d-th { background: var(--beauty); }

.ms-d-name{
  font-size: 13px;
  color: #37474f;
  line-height: 1.25;
  font-weight: 900;
  word-break: break-word;
  display: -webkit-box;
  -webkit-line-clamp: 3;
  -webkit-box-orient: vertical;
  overflow: hidden;
}

.ms-tag{
  position: static;
  font-size: 11px;
  padding: 4px 8px;
  border-radius: 999px;
  background: rgba(255,111,0,0.16);
  color: #e65100;
  border: 1px solid rgba(230,81,0,0.26);
  font-weight: 900;
  letter-spacing: .2px;
  pointer-events:none;
  transform-origin: center;
  white-space: nowrap;
  box-shadow: 0 0 0 rgba(230,81,0,0);
}
.ms-track-col.beauty .ms-tag{
  background: rgba(216,27,96,0.12);
  color: #ad1457;
  border-color: rgba(216,27,96,0.22);
}
.ms-tag.done{
  background: rgba(0,137,123,0.14);
  color:#00695c;
  border-color: rgba(0,137,123,0.22);
  box-shadow: none;
}
.ms-tag.flash{
  animation: msTagGlow .95s ease-in-out infinite, msTagShake .42s ease-in-out infinite;
}
@keyframes msTagGlow{
  0%{ box-shadow: 0 0 0 rgba(230,81,0,0); filter: saturate(1); }
  50%{ box-shadow: 0 10px 26px rgba(230,81,0,0.25); filter: saturate(1.35); }
  100%{ box-shadow: 0 0 0 rgba(230,81,0,0); filter: saturate(1); }
}
@keyframes msTagShake{
  0%{ transform: translate(0,0) rotate(0deg); }
  20%{ transform: translate(0.5px,-0.5px) rotate(-1deg); }
  50%{ transform: translate(-0.5px,0.5px) rotate(1deg); }
  80%{ transform: translate(0.5px,0.2px) rotate(-0.5deg); }
  100%{ transform: translate(0,0) rotate(0deg); }
}

/* FIX: Multi-Image CSS */
.g-img-row { display: flex; gap: 4px; align-items: center; }
.g-thumb { width: 40px; height: 40px; object-fit: contain; border: 1px solid #eee; border-radius: 6px; background: #fff; }

/* --- General --- */
.highlight { background-color: #fff176 !important; color: #212121 !important; font-weight: 900; border-radius: 2px; padding: 0 2px; }
.cat-section-title{
  font-size: 18px;
  font-weight: 900;
  color: var(--primary);
  padding: 16px 44px 8px 8px;
  margin-top: 0;
  margin-bottom: 8px;
  border-bottom: 2px solid var(--primary-light);
  scroll-margin-top: 135px;
  position: relative;
  cursor: pointer;
  border-radius: 10px;
  transition: background .15s ease, transform .12s ease;
}
.cat-section-title:hover{ background: rgba(0,137,123,0.06); }
.cat-section-title:active{ transform: translateY(1px); }
.cat-section-title::after{
  content: 'i';
  position: absolute;
  right: 10px;
  top: 50%;
  transform: translateY(-40%);
  width: 20px;
  height: 20px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-family: 'Roboto', sans-serif;
  font-weight: 900;
  font-size: 12px;
  color: #004d40;
  background: rgba(224,242,241,0.90);
  border: 1.6px solid rgba(0,137,123,0.55);
  box-shadow: 0 6px 14px rgba(0,0,0,0.06);
}


/* --- V28 FIX: Overlay Flash Animation --- */
.p-card { 
  background: #fff; border-radius: 16px; overflow: hidden; position: relative; 
  box-shadow: var(--shadow-card); border: 1px solid #f0f0f0; 
  display: flex; flex-direction: column; transition: transform 0.15s; scroll-margin-top: 200px; 
}
.p-card::after {
  content: ''; position: absolute; inset: 0;
  background: rgba(255, 241, 118, 0.4);
  border-radius: 16px;
  opacity: 0; pointer-events: none; z-index: 10;
  transition: opacity 0.3s;
}
.flash-highlight::after {
  animation: flashOverlay 0.6s ease-in-out 2;
}
@keyframes flashOverlay {
  0%, 100% { opacity: 0; }
  50% { opacity: 1; border: 3px solid #fdd835; }
}

.p-card:active { transform: scale(0.97); }
.p-no-img { font-size: 12px; color: #b0bec5; display: flex; flex-direction: column; align-items: center; }
.badges { position: absolute; top: 8px; left: 8px; display: flex; flex-direction: column; gap: 4px; z-index: 2; align-items: flex-start; }
.badge { font-size: 10px; padding: 4px 8px; border-radius: 6px; color: #fff; font-weight: 700; box-shadow: 0 2px 6px rgba(0,0,0,0.2); letter-spacing: 0.5px; backdrop-filter: blur(4px); }
.bg-red { background: rgba(239, 83, 80, 0.95); }
.new-badge{
  position:absolute; right:8px; bottom:8px;
  z-index:2;
  padding:5px 10px;
  border-radius:999px;
  font-size:10px;
  font-weight:900;
  letter-spacing:0.8px;
  color: var(--new-badge-text, #ffffff);
  background: var(--new-badge-bg, linear-gradient(135deg, #ff5a8a, #ff8fb3));
  box-shadow: 0 8px 18px rgba(0,0,0,0.14);
  border: 1px solid rgba(255,255,255,0.35);
  pointer-events:none;
}

.bg-blue { background: rgba(66, 165, 245, 0.95); }
.bg-gold { background: linear-gradient(135deg, #ffa726, #fb8c00); }
.bg-purple { background: rgba(171, 71, 188, 0.95); }
.bg-teal { background: #26a69a; }

.p-body { padding: 12px; flex: 1; display: flex; flex-direction: column; justify-content: space-between; position: relative; }
.p-title { font-size: 14px; font-weight: 700; line-height: 1.4; color: #37474f; margin-bottom: 4px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; height: 40px; }
.p-code { font-size: 11px; color: #cfd8dc; margin-bottom: 8px; }
.p-code-chip{
  position: absolute;
  top: -10px;
  left: 11px; /* å¾®èª¿å¾€å·¦ 1px */
  z-index: 3;
  font-size: 10px; /* å­—é«”ç¸®å° 1px */
  font-weight: 800;
  letter-spacing: 0.2px;
  color: #b0bec5; /* æ¯”åˆªé™¤ç·š(#90a4ae)æ›´æ·¡ */
  background: transparent; /* å»èƒŒï¼šç„¡åº•è‰² */
  border: none; /* å»èƒŒï¼šç„¡é‚Šæ¡† */
  padding: 0;
  border-radius: 0;
  box-shadow: none;
  pointer-events: none;
}


.p-pill-row{ margin-top: 6px; }

.p-price-row { display: flex; align-items: baseline; gap: 6px; margin-top: 2px; justify-content: flex-start; }
.p-price { font-size: var(--price-size-lg); font-weight: 800; color: #263238; }
.p-price.strike { font-weight: 600; color: #90a4ae; text-decoration: line-through; }



.p-price-pill{
  font-size:12px;
  font-weight:800;
  color:#c62828;
  background:rgba(198,40,40,.08);
  border:1px solid rgba(198,40,40,.22);
  padding:2px 8px;
  border-radius:999px;
  line-height:1.2;
  white-space:nowrap;
}

.p-price-pill .pill-label{
  font-size:0.7em; /* æŠ˜å¾Œå­—å‹ç¸®å°30% */
  font-weight:800;
  margin-right:4px;
}



.p-price-pill{ display: inline-flex; align-items: baseline; }

.p-price-pill .pill-value{
  font-size: var(--price-size);
  font-weight: 900;
  line-height: 1;
}

.p-buy-row{
  display: flex;
  align-items: center;
  justify-content: flex-end; /* stepper æ°¸é é å³ï¼Œé¿å…æ“ å£“ */
  gap: 10px;
  margin-top: 10px;
}
.p-buy-row.no-pill{ justify-content: flex-end; }
.p-buy-row .stepper{ margin-top: 0 !important; }

.stepper { display: flex; align-items: center; justify-content: flex-end; gap: 8px; margin-top: 10px; }
.s-btn { 
  width: 32px; height: 32px; border-radius: 50%; border: 1px solid #eceff1; background: #fff; color: var(--primary); 
  font-size: 20px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; position: relative;
}
.s-btn::after { content: ''; position: absolute; top: -10px; bottom: -10px; left: -10px; right: -10px; }
.s-btn:active { background: var(--primary-light); transform: scale(0.9); }
.s-btn.add { background: var(--primary); color: #fff; border-color: var(--primary); box-shadow: 0 2px 5px rgba(0,137,123,0.3); }
.s-val { width: 24px; text-align: center; font-size: 15px; font-weight: 600; color: #37474f; }
.s-btn.hidden, .s-val.hidden { display: none; }
.btn-bundle { width: 100%; margin-top: 8px; padding: 10px; border: 1px dashed var(--primary); border-radius: 10px; color: var(--primary); background: var(--primary-light); font-size: 13px; font-weight: 700; text-align: center; cursor: pointer; transition: 0.2s; }
.btn-bundle:active { transform: scale(0.98); background: #b2dfdb; }

/* Header & Nav */
header { position: sticky; top: 0; z-index: 1000; background: rgba(255,255,255,0.98); box-shadow: 0 2px 15px rgba(0,0,0,0.03); backdrop-filter: blur(12px); }
.search-wrap { padding: 8px 16px 0 16px; }
.search-box { position: relative; width: 100%; }
.search-box input { width: 100%; padding: 10px 12px 10px 42px; border-radius: 12px; border: 1px solid #e0e0e0; background: #f5f7f9; font-size: 15px; transition: 0.3s; }
.search-box input:focus { background: #fff; border-color: var(--primary); outline: none; box-shadow: 0 0 0 3px rgba(0,137,123,0.1); }
.search-box .icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-sub); }

/* --- OPTIMIZATION 2: Clear Search Button --- */
.clear-btn { 
  position: absolute; right: 10px; top: 50%; transform: translateY(-50%); 
  color: #90a4ae; cursor: pointer; font-size: 20px; padding: 4px; border-radius: 50%;
  display: none; /* Default Hidden */
}
.clear-btn:active { background: #eceff1; color: #546e7a; }

.cat-nav { display: flex; gap: 8px; padding: 8px 16px 12px 16px; overflow-x: auto; scrollbar-width: none; }
.cat-nav::-webkit-scrollbar { display: none; }
.cat-pill { white-space: nowrap; padding: 7px 18px; border-radius: 24px; font-size: 14px; font-weight: 500; color: var(--text-sub); background: #fff; border: 1px solid #e0e0e0; cursor: pointer; transition: 0.25s cubic-bezier(0.25, 0.8, 0.25, 1); }
.cat-pill.active { background: var(--primary); color: #fff; border-color: var(--primary); box-shadow: 0 4px 10px rgba(0,137,123,0.25); font-weight: 700; transform: scale(1.02); }

/* Drawer Core */
#drawer { position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 1200; pointer-events: none; }
#drawer-bg { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); opacity: 0; transition: 0.3s; backdrop-filter: blur(4px); }
#drawer-panel { position: absolute; top: 0; right: 0; bottom: 0; width: 100%; max-width: 480px; background: #fff; transform: translateX(100%); transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1); display: flex; flex-direction: column; pointer-events: auto; box-shadow: -5px 0 30px rgba(0,0,0,0.15); }
#drawer.open #drawer-bg { opacity: 1; pointer-events: auto; }
#drawer.open #drawer-panel { transform: translateX(0); }
.dr-head { padding: 16px 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: #fff; flex-shrink: 0; }
.dr-body { flex: 1; overflow-y: auto; padding: 12px; background: #f4f6f8; overscroll-behavior: contain; }
.dr-foot { padding: 20px; padding-bottom: calc(20px + var(--safe-bottom)); background: #fff; border-top: 1px solid var(--border); box-shadow: 0 -4px 20px rgba(0,0,0,0.05); flex-shrink: 0; }

.c-item { display: flex; gap: 10px; margin-bottom: 8px; padding: 8px 12px; background: #fff; border-radius: 10px; border: 1px solid #e0e0e0; box-shadow: 0 1px 2px rgba(0,0,0,0.02); align-items: center; }
.c-info { flex: 1; }
.c-title { font-size: 14px; margin-bottom: 2px; line-height: 1.3; font-weight: 700; color:#37474f; }
.c-spec { font-size: 12px; margin-bottom: 2px; color:#90a4ae; }
.c-price-box { margin-top: 2px; font-weight:700; font-size:15px; color:#263238; }
.c-old { text-decoration: line-through; color: #90a4ae; font-size: 12px; margin-right: 6px; }
.c-tags { margin-top: 2px; }
.c-tag { font-size: 11px; padding: 3px 8px; border-radius: 6px; font-weight: 600; display: inline-flex; align-items: center; gap: 4px; }
.c-tag.save { background: #fff3e0; color: #e65100; border: 1px solid #ffe0b2; }
.c-tag.warn { background: #ffebee; color: #c62828; border: 1px solid #ffcdd2; }
.c-ctrl { display: flex; flex-direction: column; align-items: flex-end; justify-content: center; }

/* Modals Misc */
.balloon-card { background: rgba(255, 255, 255, 0.9); width: 85%; max-width: 360px; padding: 40px 30px; border-radius: 40px 40px 40px 10px; box-shadow: 0 20px 50px rgba(0, 137, 123, 0.2); text-align: center; border: 1px solid rgba(255, 255, 255, 0.5); animation: floatBalloon 3s ease-in-out infinite; position: relative; }
.balloon-card::after { content: ''; position: absolute; bottom: -15px; left: 10px; width: 0; height: 0; border-left: 15px solid transparent; border-right: 0 solid transparent; border-top: 20px solid rgba(255, 255, 255, 0.9); transform: rotate(10deg); }
@keyframes floatBalloon { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
.w-logo { font-size: 48px; margin-bottom: 16px; display: inline-block; }
.w-title { font-size: 22px; font-weight: 900; color: var(--primary); margin-bottom: 8px; line-height: 1.3; }
.w-sub { font-size: 14px; color: var(--text-sub); margin-bottom: 32px; font-weight: 500; line-height: 1.6; }
.w-btn { background: var(--primary); color: #fff; border: none; padding: 14px 40px; border-radius: 50px; font-size: 16px; font-weight: 700; cursor: pointer; box-shadow: 0 8px 20px rgba(0, 137, 123, 0.3); transition: 0.2s; }
.w-btn:active { transform: scale(0.95); background: #00796b; }

.gamification-box { padding: 16px 20px; background: linear-gradient(to bottom, #fff, #fcfcfc); border-bottom: 1px solid #f0f0f0; }
.game-txt { font-size: 13px; font-weight: 700; color: #37474f; display: flex; justify-content: space-between; align-items: center; transition: all 0.3s; }
.game-txt.success { color: #2e7d32; }
.game-icon-wrap { cursor: pointer; padding: 4px 8px; background: #fff8e1; border-radius: 20px; border: 1px solid #ffe0b2; display: flex; align-items: center; gap: 4px; transition: 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
.game-icon-wrap:active { transform: scale(0.95); background: #ffecb3; }
.game-icon { transition: all 0.3s; font-size: 16px; }
.game-hint { font-size: 11px; color: var(--accent); }


/* V2.8.12: cart motivation text +20% */
#gameMsg{ font-size: 1.2em; }
.progress-wrap { height: 10px; width: 100%; background: #eee; border-radius: 5px; overflow: hidden; margin-top: 8px; }
.progress-bar { height: 100%; width: 0%; background: linear-gradient(90deg, #ffca28, #ff6f00); border-radius: 5px; transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1); }
.progress-bar.full { background: linear-gradient(90deg, #66bb6a, #43a047); }

.gift-list { display: flex; flex-direction: column; gap: 8px; padding: 8px 4px; flex: 1; overflow-y: auto; min-height: 0; }
.gift-item { display: flex; align-items: center; gap: 12px; padding: 12px; border-radius: 12px; border: 1px dashed #e0e0e0; color: #bdbdbd; transition: 0.3s; flex-shrink: 0; }
.gift-item.unlocked { background: #f1f8e9; border: 1px solid #c5e1a5; color: #33691e; box-shadow: 0 4px 10px rgba(0,0,0,0.05); transform: scale(1.02); }
.g-status { font-size: 20px; }
.g-info { flex: 1; overflow: hidden; }
.g-amt { font-size: 12px; font-weight: 700; margin-bottom: 2px; }
.g-name { font-size: 14px; }
.g-tag { font-size: 10px; background: #fff; padding: 2px 6px; border-radius: 4px; border: 1px solid #a5d6a7; color: #2e7d32; display: inline-block; margin-top: 4px; }


/* V2.8.12: Gift list section title with current spend */
.g-section-title{
  display:flex; align-items:center; justify-content:space-between; gap:10px;
  padding: 8px 10px; margin: 10px 0 4px;
  border-radius: 12px;
  background: rgba(96,125,139,0.08);
  border: 1px solid rgba(96,125,139,0.16);
  color: #37474f;
  font-size: 13px;
  font-weight: 900;
}
.g-section-title.beauty{
  background: rgba(236,64,122,0.08);
  border-color: rgba(236,64,122,0.16);
}
.g-section-amt{
  font-size: 11px;
  font-weight: 800;
  color: #607d8b;
  white-space: nowrap;
}
@keyframes shimmer { 0% { background-position: -468px 0; } 100% { background-position: 468px 0; } }
.skeleton { background: #f6f7f8; background-image: linear-gradient(to right, #f6f7f8 0%, #edeef1 20%, #f6f7f8 40%, #f6f7f8 100%); background-repeat: no-repeat; background-size: 800px 104px; animation: shimmer 1s linear infinite forwards; border-radius: 8px; }
.sk-card { height: 280px; border-radius: 16px; background: #fff; padding: 12px; margin-bottom: 12px; }

#toast-container { position: fixed; bottom: 90px; left: 50%; transform: translateX(-50%); z-index: 9999; pointer-events: none; width: 90%; max-width: 320px; display: flex; flex-direction: column-reverse; gap: 8px; align-items: center; }
.toast { background: rgba(33, 33, 33, 0.95); color: #fff; padding: 12px 24px; border-radius: 50px; font-size: 14px; text-align: center; box-shadow: 0 8px 20px rgba(0,0,0,0.2); opacity: 0; transform: translateY(20px); animation: toastIn 0.3s forwards, toastOut 0.3s forwards 2.5s; backdrop-filter: blur(4px); display: flex; align-items: center; justify-content: center; gap: 8px; transition: 0.3s; }
.toast.game { background: linear-gradient(135deg, #ffa726, #ff6f00); font-weight: 700; box-shadow: 0 10px 25px rgba(255, 111, 0, 0.4); }
@keyframes toastIn { to { opacity: 1; transform: translateY(0); } }
@keyframes toastOut { to { opacity: 0; transform: translateY(-10px); } }

@keyframes flashWarn { 0%, 100% { background: #ffebee; transform: translateX(0); } 20%, 60% { background: #ff5252; color: #fff; transform: translateX(-5px); } 40%, 80% { background: #ff5252; color: #fff; transform: translateX(5px); } }
.flash-anim { animation: flashWarn 0.6s ease-in-out; }
.input-error { border-color: #ef5350 !important; background: #ffebee !important; }

.sum-card { background: #fff; border-radius: 12px; border: 1px solid #e0e0e0; margin-top: 15px; overflow: hidden; }
.sum-head { padding: 12px 16px; background: #f5f5f5; font-size: 14px; font-weight: 700; display: flex; justify-content: space-between; align-items: center; cursor: pointer; color: #37474f; transition: 0.2s; }
.sum-head:hover { background: #eeeeee; }
.sum-body { display: none; padding: 12px 16px; font-size: 13px; color: #546e7a; line-height: 1.6; background: #fff; }
.sum-body.open { display: block; animation: slideDown 0.2s ease-out; }
@keyframes slideDown { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
.sum-line { display: flex; justify-content: space-between; border-bottom: 1px dashed #eee; padding: 6px 0; }

.form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 15px; }
input, select { width: 100%; padding: 14px; border: 1px solid #cfd8dc; border-radius: 12px; font-size: 14px; background: #fafafa; transition: 0.2s; }
input:focus, select:focus { border-color: var(--primary); background: #fff; outline: none; box-shadow: 0 0 0 3px rgba(0,137,123,0.1); }
.btn-bar { display: flex; gap: 10px; margin-top: 20px; }
.btn-submit { flex: 2; padding: 16px; background: var(--text-main); color: #fff; border: none; border-radius: 14px; font-size: 16px; font-weight: 700; cursor: pointer; transition: 0.2s; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
.btn-submit:active { transform: scale(0.98); opacity: 0.9; }
.btn-clear { flex: 0 0 50px; padding: 0; background: #ffebee; color: #ef5350; border: none; border-radius: 14px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; }
.btn-clear:active { background: #ffcdd2; }
.promo-bar { background: #e8f5e9; color: #1b5e20; padding: 12px 16px; font-size: 13px; display: flex; align-items: center; gap: 8px; border-bottom: 1px solid #c8e6c9; font-weight: 500; }

.modal { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 2000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(6px); }
.modal.open { display: flex; animation: fadeIn 0.2s ease-out; }
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
.m-box { background: #fff; width: 90%; max-width: 420px; border-radius: 24px; padding: 24px; max-height: 85vh; display: flex; flex-direction: column; box-shadow: 0 25px 50px rgba(0,0,0,0.25); transform: scale(0.95); transition: 0.2s; }
.modal.open .m-box { transform: scale(1); }
.m-head { font-size: 20px; font-weight: 700; margin-bottom: 8px; text-align: center; color: #263238; flex-shrink: 0; }
.m-sub { text-align: center; color: #78909c; font-size: 14px; margin-bottom: 20px; flex-shrink: 0; }
.m-grid { display: flex; flex-direction: column; gap: 10px; overflow-y: auto; padding: 4px; flex: 1; min-height: 0; }
.m-row { display: flex; justify-content: space-between; align-items: center; padding: 16px; border: 1px solid #eceff1; border-radius: 16px; transition: 0.2s; background: #fafafa; flex-shrink: 0; }
.m-row:hover { background: #fff; border-color: var(--primary); box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
.m-name { font-weight: 700; font-size: 15px; color: #37474f; }
.m-ctrl { display: flex; align-items: center; gap: 12px; }
.m-btn-s { width: 32px; height: 32px; border-radius: 50%; background: #fff; border: 1px solid #cfd8dc; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 18px; color: var(--primary); transition: 0.1s; position: relative; }
.m-btn-s::after { content: ''; position: absolute; top: -10px; bottom: -10px; left: -10px; right: -10px; }
.m-btn-s:active { background: var(--primary); color: #fff; border-color: var(--primary); }
.m-val { font-weight: 700; width: 24px; text-align: center; font-size: 16px; }
.m-acts { display: flex; gap: 12px; margin-top: 24px; flex-shrink: 0; }
.m-btn { flex: 1; padding: 14px; border-radius: 12px; border: none; font-weight: 700; cursor: pointer; font-size: 16px; transition: 0.2s; }
.m-btn.disabled { opacity: 0.5; pointer-events: none; background: #cfd8dc; }
#empty-state { text-align: center; margin-top: 80px; color: #b0bec5; display: none; }

.receipt-paper { background: #fff; padding: 0; width: 100%; border-radius: 0; box-shadow: none; display: flex; flex-direction: column; height: 100%; }
.rc-head { background: var(--primary); color: #fff; padding: 20px; text-align: center; }
.rc-body { flex: 1; overflow-y: auto; padding: 20px; background: #fff; }
.rc-row { display: flex; justify-content: space-between; margin-bottom: 12px; font-size: 14px; color: #455a64; }
.rc-row.bold { font-weight: 700; color: #263238; font-size: 16px; margin-top: 10px; padding-top: 10px; border-top: 2px dashed #eceff1; }
.rc-item { margin-bottom: 15px; border-bottom: 1px dashed #eee; padding-bottom: 8px; }
.rc-name { font-weight: 700; color: #37474f; margin-bottom: 4px; }
.rc-meta { display: flex; justify-content: space-between; font-size: 13px; color: #78909c; }
.rc-actions { padding: 20px; background: #fafafa; border-top: 1px solid #eee; }
.btn-email { width: 100%; padding: 12px; border: 1px solid #cfd8dc; background: #fff; border-radius: 10px; color: #546e7a; font-weight: 700; display: flex; align-items: center; justify-content: center; gap: 8px; margin-bottom: 10px; }
.btn-close-rc { width: 100%; padding: 14px; background: var(--text-main); color: #fff; border: none; border-radius: 10px; font-weight: 700; font-size: 16px; }
.email-input-box { display: none; gap: 8px; margin-bottom: 10px; }
.email-input-box.show { display: flex; }

.flying-gift { position: fixed; z-index: 1300; pointer-events: none; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.3); width: 60px; height: 60px; object-fit: contain; background: #fff; border: 2px solid #ffca28; }


/* --- Step 2 New CSS: Delivery Form --- */
.delivery-toggle-wrap { position: relative; margin: 10px 0; padding: 10px; background: #fff3e0; border-radius: 8px; border: 1px solid #ffe0b2; }
.d-toggle-label { display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 15px; color: #e65100; font-weight: 700; }
.d-toggle-label input { width: 20px; height: 20px; margin: 0; accent-color: #ef6c00; }
.delivery-form { display: none; flex-direction: column; gap: 10px; margin-top: 10px; padding-top: 10px; border-top: 1px dashed #ffcc80; animation: slideDown 0.3s ease-out; }
.delivery-form.show { display: flex; }
.d-input { border: 1px solid #ffcc80 !important; background: #fff !important; }
.d-input:focus { border-color: #ef6c00 !important; box-shadow: 0 0 0 3px rgba(239, 108, 0, 0.2) !important; }

.d-toggle-label { padding-right: 64px; }
.d-collapse-btn { position: absolute; top: 8px; right: 8px; border: none; background: #ef6c00; color: #fff; font-size: 12px; font-weight: 700; padding: 4px 10px; border-radius: 999px; cursor: pointer; display: none; }
.d-collapse-btn:hover { filter: brightness(0.95); }
.d-collapse-btn:active { transform: translateY(1px); }


/* --- V2.8: Delivery free-shipping badge + better spacing when expanded --- */
.ship-free-badge{
  position:absolute;
  top:8px;
  right:72px;
  display:none;
  align-items:center;
  gap:4px;
  padding:4px 10px;
  border-radius:999px;
  font-size:12px;
  font-weight:800;
  white-space:nowrap;
  border:1px solid;
}
.ship-free-badge.ok{ background:#e8f5e9; border-color:#c8e6c9; color:#2e7d32; }
.ship-free-badge:not(.ok){ background:#fff8e1; border-color:#ffe0b2; color:#e65100; }
.delivery-toggle-wrap.has-badge .d-toggle-label{ padding-right: 168px; }

@media (max-width: 480px){
  .ship-free-badge{ top:6px; right:66px; font-size:11px; padding:3px 8px; }
  .delivery-toggle-wrap.has-badge .d-toggle-label{ padding-right: 156px; }
}

/* --- V2.8: Auto-scroll target highlight --- */
.cat-section.zone-highlight{
  outline: 2px solid #ffca28;
  box-shadow: 0 0 0 6px rgba(255,202,40,0.18);
  border-radius: 18px;
}


/* --- V2.3 Cart Compact Header/Footer (mobile) --- */
@media (max-width: 480px){
  /* Header */
  .dr-head{ padding:10px 14px; }
  .dr-head h2{ font-size:18px !important; }
  .dr-head .material-icons-round{ font-size:22px !important; }
  .dr-head > span.material-icons-round{ padding:6px !important; }

  /* Progress strip */
  .gamification-box{ padding:10px 14px; }
  .game-txt{ font-size:12px; }
  .game-icon{ font-size:15px; }
  .game-icon-wrap{ padding:3px 7px; }
  .progress-wrap{ height:8px; margin-top:6px; }

  /* Body */
  .dr-body{ padding:10px; }

  /* Footer */
  /* Footer */
  .dr-foot{ padding:8px 14px; padding-bottom: calc(8px + var(--safe-bottom)); }
.delivery-toggle-wrap{ margin:8px 0; padding:8px; }
  .d-toggle-label{ font-size:14px; }
  .delivery-form{ gap:8px; margin-top:8px; padding-top:8px; }

  
  /* Footer summary spacing (mobile) */
  .dr-foot > div:nth-child(1){ margin-top:2px !important; margin-bottom:2px !important; }
  .dr-foot > div:nth-child(2){ margin-bottom:2px !important; }
  .dr-foot > div:nth-child(3){ margin-bottom:2px !important; }
  .dr-foot > div:nth-child(4){ margin-top:5px !important; padding-top:5px !important; }

/* Form controls only inside cart drawer */
  #drawer-panel input, #drawer-panel select{ padding:12px; font-size:13px; }
  .form-grid{ gap:10px; margin-top:12px; }

  /* Buttons */
  .btn-bar{ margin-top:14px; }
  .btn-submit{ padding:14px; font-size:15px; border-radius:14px; }
  .btn-clear{ flex:0 0 46px; }

  /* Summary */
  .sum-card{ margin-top:10px; }
  .sum-head{ padding:10px 14px; font-size:13px; }
}

/* --- V2.8.8: System announcement slot (between rankings and categories) --- */
#systemAnnouncementSlot{ padding:0 14px; margin: 10px 0 6px; }
.sys-ann{
  background: rgba(0,137,123,0.08);
  border: 1px solid rgba(0,137,123,0.18);
  color: #004d40;
  border-radius: 14px;
  padding: 10px 12px;
  font-size: 13px;
  line-height: 1.35;
  box-shadow: 0 6px 18px rgba(0,0,0,0.04);
}
.sys-ann .title{ font-weight: 800; margin-bottom: 4px; }

/* --- V2.8.9: Promo Map (å„ªæƒ åœ°åœ–) entry + drawer --- */
.sys-ann--row{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  flex-wrap:wrap;
}
.sys-ann-main{ flex: 1 1 200px; min-width: 180px; }
.sys-ann-cta{
  flex: 0 0 auto;
  border: 1px solid rgba(0,137,123,0.35);
  background: rgba(255,255,255,0.85);
  color: #004d40;
  border-radius: 999px;
  padding: 8px 12px;
  font-weight: 800;
  font-size: 13px;
  white-space: nowrap;
  cursor: pointer;
  transition: transform .12s ease, box-shadow .18s ease, background .18s ease, border-color .18s ease;
}
.sys-ann-cta:active{ transform: translateY(1px); }

.sys-ann-cta .cta-icon{
  display:inline-block;
  margin-right: 6px;
  font-weight: 900;
  color: var(--ann-icon-fg, #ff6f00);
}
.sys-ann-cta .cta-text{ display:inline-block; }

.sys-ann-cta.pm-attn{
  border-color: rgba(255,111,0,0.55);
  background: linear-gradient(135deg, rgba(255,111,0,0.16), rgba(255,111,0,0.03));
  box-shadow: 0 10px 24px rgba(255,111,0,0.18);
  animation: pmShake 1.15s ease-in-out infinite, pmGlow 1.55s ease-in-out infinite;
}
@keyframes pmShake{
  0%, 100%{ transform: translateX(0); }
  12%{ transform: translateX(-2px); }
  24%{ transform: translateX(2px); }
  36%{ transform: translateX(-2px); }
  48%{ transform: translateX(1px); }
  60%{ transform: translateX(0); }
}
@keyframes pmGlow{
  0%, 100%{ filter: drop-shadow(0 0 0 rgba(255,111,0,0)); }
  50%{ filter: drop-shadow(0 0 8px rgba(255,111,0,0.35)); }
}

/* Drawer */
body.drawer-open { overflow:hidden; }
.pm-overlay{
  position:fixed; inset:0;
  background: rgba(0,0,0,0.30);
  backdrop-filter: blur(2px);
  z-index: 9998;
  display:none;
}
.pm-drawer{
  position:fixed;
  top:0; right:0;
  height:100%;
  width:min(336px, 74vw);
  background:#fff;
  z-index: 9999;
  transform: translateX(102%);
  transition: transform .22s ease;
  box-shadow: -18px 0 40px rgba(0,0,0,0.18);
  border-left: 1px solid rgba(0,0,0,0.06);
  display:flex;
  flex-direction:column;
}
.pm-drawer.open{ transform: translateX(0); }
.pm-header{
  padding: 14px 14px 10px;
  border-bottom: 1px solid rgba(0,0,0,0.06);
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
}
.pm-title{
  font-size: 16px;
  font-weight: 900;
  color: #0b4f49;
  letter-spacing: .2px;
}
.pm-close{
  border: none;
  background: rgba(0,0,0,0.05);
  border-radius: 12px;
  padding: 8px 10px;
  cursor:pointer;
}
.pm-body{
  padding: 12px 14px 14px;
  overflow:auto;
}
.pm-sub{
  font-size: 12px;
  color: #607d8b;
  margin-bottom: 10px;
  line-height: 1.35;
}
.pm-list{ display:flex; flex-direction:column; gap:10px; }
.pm-item{
  border: 1px solid rgba(0,0,0,0.06);
  border-radius: 16px;
  padding: 10px 12px;
  box-shadow: 0 8px 18px rgba(0,0,0,0.04);
  cursor:pointer;
  transition: transform .12s ease, box-shadow .18s ease;
}
.pm-item:active{ transform: translateY(1px); }
.pm-item:hover{ box-shadow: 0 10px 24px rgba(0,0,0,0.06); }
.pm-item .row{ display:flex; align-items:flex-start; justify-content:space-between; gap:10px; }
.pm-item .name{ font-weight: 900; color: #263238; }
.pm-item .hint{ margin-top: 4px; font-size: 12px; color: #455a64; line-height: 1.35; }
.pm-tags{ display:flex; gap:6px; flex-wrap:wrap; margin-top: 6px; }
.pm-tag{
  font-size: 11px;
  padding: 2px 8px;
  border-radius: 999px;
  background: rgba(0,137,123,0.10);
  color:#004d40;
  border:1px solid rgba(0,137,123,0.18);
}
.pm-arrow{ color:#90a4ae; font-size: 18px; line-height:1; }


/* --- V29: Promo Map Tabs (å„ªæƒ åˆ†é¡ / è´ˆå“é–€æª») --- */
.pm-head-left{ display:flex; align-items:center; gap:10px; min-width:0; }
.pm-tabs{
  display:flex; align-items:center;
  padding: 3px;
  border-radius: 999px;
  background: rgba(255,255,255,0.58);
  border: 1px solid rgba(0,0,0,0.08);
  box-shadow: 0 10px 22px rgba(0,0,0,0.08);
}
.pm-tab{
  border:0; background:transparent;
  padding: 7px 10px;
  border-radius: 999px;
  font-size: 12px;
  font-weight: 900;
  color:#335c5a;
  cursor:pointer;
  white-space:nowrap;
  line-height:1;
}
.pm-tab.active{
  background: rgba(0,137,123,0.22);
  color:#003b35;
}
.pm-tab:active{ transform: translateY(1px); }

.pm-pane{ min-height: 1px; }

.pm-scope{ display:flex; gap:8px; margin: 10px 2px 12px; }
.pm-scope-btn{
  border:1px solid rgba(0,0,0,0.08);
  background: rgba(255,255,255,0.80);
  border-radius: 999px;
  padding: 7px 10px;
  font-size: 12px;
  font-weight: 900;
  color:#335c5a;
  cursor:pointer;
  line-height:1;
}
.pm-scope-btn.active{
  background: rgba(230,81,0,0.14);
  border-color: rgba(230,81,0,0.24);
  color:#b54a00;
}
.pm-scope-btn:active{ transform: translateY(1px); }

.pm-gift-list{ display:flex; flex-direction:column; gap:10px; }
.pm-gift-item{
  border: 1px solid rgba(0,0,0,0.06);
  border-radius: 18px;
  padding: 12px 12px;
  background: rgba(255,255,255,0.92);
  box-shadow: 0 10px 22px rgba(0,0,0,0.05);
}
.pm-gift-row{ display:flex; gap:12px; align-items:center; }
.pm-gift-media{ flex: 0 0 90px; }
.pm-gift-media .g-img-row{ display:flex; gap:6px; flex-wrap:wrap; align-items:center; }
.pm-gift-media .g-thumb{ width: 78px; height: 78px; object-fit: contain; border: 1px solid #eee; border-radius: 14px; background:#fff; }
.pm-gift-media .g-thumb:not(:first-child){ display:none; } /* åªç§€ç¬¬ä¸€å¼µï¼Œä¿æŒç‰ˆé¢ä¹¾æ·¨ */
.pm-gift-info{ flex:1; min-width:0; display:flex; flex-direction:column; gap:6px; }
.pm-gift-amt{
  display:inline-flex;
  align-items:center;
  gap:6px;
  align-self:flex-start;
  font-weight: 900;
  font-size: 13px;
  color:#263238;
  padding: 6px 10px;
  border-radius: 999px;
  background: rgba(0,137,123,0.10);
  border: 1px solid rgba(0,137,123,0.16);
  line-height: 1;
}
.pm-gift-name{
  font-weight: 900;
  font-size: 14px;
  color:#263238;
  line-height: 1.25;
  word-break: break-word;
}

.pm-empty{
  padding: 12px 12px;
  border-radius: 14px;
  border: 1px dashed rgba(0,0,0,0.12);
  background: rgba(255,255,255,0.75);
  color:#607d8b;
  font-size: 12px;
  line-height: 1.35;
}


/* --- V2.8.11: Promo Map styling (é…è‰²ï¼‹å¡ç‰‡å±¤æ¬¡) --- */
.pm-overlay{
  background: rgba(9,30,29,0.34);
  backdrop-filter: blur(3px);
}
.pm-drawer{
  background: linear-gradient(180deg, rgba(224,242,241,0.70) 0%, rgba(255,255,255,1) 160px);
}
.pm-header{
  background: linear-gradient(135deg, rgba(0,137,123,0.20) 0%, rgba(255,111,0,0.10) 100%);
  border-bottom: 1px solid rgba(0,0,0,0.05);
}
.pm-title{ color: #003b35; }
.pm-close{
  background: rgba(255,255,255,0.65);
  border: 1px solid rgba(0,0,0,0.08);
  box-shadow: 0 8px 18px rgba(0,0,0,0.08);
}
.pm-body{
  background: linear-gradient(180deg, rgba(248,249,250,0.65), rgba(255,255,255,0));
}
.pm-sub{
  padding: 10px 10px;
  border-radius: 14px;
  background: rgba(255,255,255,0.85);
  border: 1px dashed rgba(0,137,123,0.22);
  color: #335c5a;
}
.pm-item{
  background: rgba(255,255,255,0.92);
  position: relative;
  padding-left: 18px;
}
.pm-item::before{
  content: '';
  position: absolute;
  left: 10px;
  top: 12px;
  bottom: 12px;
  width: 4px;
  border-radius: 8px;
  background: var(--pm-accent, rgba(0,137,123,0.22));
}
.pm-item[data-kind="order"]{ --pm-accent: rgba(0,137,123,0.85); }
.pm-item[data-kind="tier"]{ --pm-accent: rgba(106,27,154,0.75); }
.pm-item[data-kind="bogo"]{ --pm-accent: rgba(25,118,210,0.78); }
.pm-item[data-kind="addon"]{ --pm-accent: rgba(216,67,21,0.78); }

/* V2.8.12: Promo Map å·¦å´è‰²æ¢æ”¹ç‚ºå“ç‰Œè‰²ï¼ˆä¾åˆ†é¡å¤§é¡ï¼‰ */
.pm-item[data-brand="beauty"]{ --pm-accent: var(--pm-accent-beauty, rgba(236, 64, 122, 0.78)); }   /* ç²‰ */
.pm-item[data-brand="clean"]{  --pm-accent: var(--pm-accent-clean, rgba(102, 187, 106, 0.70)); }  /* ç²‰ç¶  */
.pm-item[data-brand="drink"]{  --pm-accent: var(--pm-accent-drink, rgba(255, 112, 67, 0.68)); }   /* ç²‰æ©˜ */
.pm-item[data-brand="health"]{ --pm-accent: var(--pm-accent-health, rgba(25, 118, 210, 0.78)); }   /* è— */
.pm-tag{
  background: rgba(0,137,123,0.09);
  border-color: rgba(0,137,123,0.20);
}

/* --- V2.8.8: Promo badges/pills are clickable (subtle) --- */
.promo-badge, .p-price-pill{ cursor: pointer; }
.promo-badge:active, .p-price-pill:active{ transform: translateY(1px); }

/* --- V2.8.8: Disable add/remove during config init (not scary, but blocks wrong ops) --- */
body.cfg-loading .s-btn,
body.cfg-loading .btn-bundle{
  pointer-events:none;
  opacity: .45;
  filter: grayscale(.15);
}
body.cfg-error .s-btn,
body.cfg-error .btn-bundle{
  pointer-events:none;
  opacity: .45;
}

</style>
</head>
<body>

<div id="welcome-overlay">
  <div class="balloon-card">
    <span class="material-icons-round w-logo" style="color:#00897b">spa</span>
    <div class="w-title">Welcome<br>TTL Bio-Tech Order Web</div>
    <div class="w-sub">å¥åº·ç¾éº—çš„è·¯ä¸Š<br>å°é…’ç”ŸæŠ€èˆ‡æ‚¨åŒè¡Œ</div>
    <button class="w-btn" onclick="closeWelcome()">é–‹å§‹è¨‚è³¼</button>
  </div>
</div>

<div id="gift-fab" onclick="showMilestoneCard()">
  <span class="material-icons-round" style="color:#ffca28">card_giftcard</span>
</div>

<div id="top-notify">
  <div class="tn-head"><span class="material-icons-round">emoji_events</span> ç²å¾—è´ˆå“</div>
  <div class="tn-body" id="tn-text"></div>
</div>

<div id="milestone-overlay">
  <div class="ms-card-v" id="msCard">
    <div class="ms-header">
       <button class="ms-close" onclick="closeMilestoneCard()" aria-label="é—œé–‰"><span class="material-icons-round">close</span></button>
       <div class="ms-title-v">ğŸ æ»¿é¡è´ˆé€²åº¦</div>
       <div class="ms-summary-row ms-sum-all"><div>å…¨ç«™æ»¿é¡</div><div id="ms-val-all">$0</div></div>
       <div class="ms-summary-row ms-sum-beauty"><div>ç¾å®¹æ»¿é¡</div><div id="ms-val-beauty">$0</div></div>
    </div>
    <div class="ms-dual-body" id="msNodes"></div>
  </div>
</div>

<div id="toast-container"></div>

<div id="back-to-top" onclick="window.scrollTo({top:0, behavior:'smooth'})">
  <span class="material-icons-round">arrow_upward</span>
</div>

<div id="loader">
  <div style="width:100%; max-width:800px; margin:0 auto; display:grid; grid-template-columns:1fr 1fr; gap:12px;">
    <div class="skeleton sk-card"></div><div class="skeleton sk-card"></div>
    <div class="skeleton sk-card"></div><div class="skeleton sk-card"></div>
  </div>
</div>

<header>
  <div class="search-wrap">
    <div class="search-box">
      <span class="material-icons-round icon">search</span>
      <input id="searchInp" type="text" placeholder="æœå°‹å•†å“...">
      <span id="clearSearch" class="material-icons-round clear-btn">cancel</span>
    </div>
  </div>
  <div class="cat-wrap">
    <nav class="cat-nav" id="catNav"></nav>
  </div>
</header>

<div id="ranking-section">
  <div class="rank-head">
    <div class="rank-title"><span class="material-icons-round" style="color:#d81b60;font-size:18px;">local_fire_department</span> ç†±éŠ·</div>
    <div class="rank-tabs">
      <div class="r-tab active" onclick="switchRank('all')">å…¨ç«™</div>
      <div class="r-tab" onclick="switchRank('health')">ä¿å¥</div>
      <div class="r-tab" onclick="switchRank('beauty')">ç¾å®¹</div>
      <div class="r-tab" onclick="switchRank('cleaning')">æ¸…æ½”</div>
    </div>
  </div>
  <div class="rank-list" id="rankList"></div>
</div>

<div id="systemAnnouncementSlot" style="display:none"></div>

<main id="list"></main>
<div id="empty-state">
  <span class="material-icons-round" style="font-size:48px">search_off</span>
  <p>æ‰¾ä¸åˆ°ç›¸é—œå•†å“</p>
</div>

<div id="float-bar" onclick="safeOpenCart()">
  <div class="fb-info">
    <span class="fb-total">$0</span>
    <span class="fb-count">0 ä»¶å•†å“</span>
  </div>
  <div class="fb-btn">æŸ¥çœ‹è³¼ç‰©è»Š <span class="material-icons-round" style="font-size:18px">arrow_forward</span></div>
</div>

<div id="drawer">
  <div id="drawer-bg" onclick="closeCart()"></div>
  <div id="drawer-panel">
    <div class="dr-head">
      <div style="display:flex; align-items:center; gap:8px;">
        <span class="material-icons-round" onclick="closeCart()" style="cursor:pointer;color:#00897b;font-weight:700">arrow_back_ios</span>
        <h2 style="margin:0;font-size:20px;font-weight:700;color:#263238">è³¼ç‰©è»Š</h2>
      </div>
      <span class="material-icons-round" onclick="closeCart()" style="cursor:pointer;padding:8px;color:#546e7a;background:#f5f5f5;border-radius:50%">close</span>
    </div>
    
    <div class="gamification-box">
      <div class="game-txt" id="gameMsgContainer">
        <span id="gameMsg">åŠ æ²¹ï¼å† $500 é€è´ˆå“</span>
        <div class="game-icon-wrap" onclick="openGiftList()">
          <span class="game-icon">ğŸ</span>
          <span class="game-hint">æŸ¥çœ‹å¥½ç¦®</span>
        </div>
      </div>
      <div class="progress-wrap">
        <div class="progress-bar" id="gameBar"></div>
      </div>
    </div>

    <div class="dr-body">
        <div id="cartList"></div>
        
        <div class="sum-card">
            <div class="sum-head" onclick="toggleSum()">
              <span style="display:flex;align-items:center;gap:6px">
                <span class="material-icons-round">receipt_long</span> å•†å“ç¸½è¦½ (å«è´ˆå“)
              </span>
              <span class="material-icons-round" id="sumIcon">expand_more</span>
            </div>
            <div class="sum-body" id="finalList"></div>
        </div>
    </div>

    <div class="dr-foot">
      <div style="display:flex;justify-content:space-between;margin:5px 0 5px 0;color:#c2185b;font-weight:700"><span>ç¾å®¹ä¿é¤Šå°è¨ˆ</span><span id="sumBeauty">$0</span></div>
      <div style="display:flex;justify-content:space-between;margin-bottom:5px;color:#546e7a"><span>åŸåƒ¹ç¸½è¨ˆ</span><span id="sumBase">$0</span></div>
      <div style="display:flex;justify-content:space-between;margin-bottom:5px;color:var(--accent)"><span>æŠ˜æ‰£èˆ‡å„ªæƒ </span><span id="sumDisc">-$0</span></div>
      <div style="display:flex;justify-content:space-between;margin-top:10px;padding-top:10px;border-top:1px dashed #cfd8dc;font-size:22px;font-weight:800;color:#263238"><span>æ‡‰ä»˜é‡‘é¡</span><span id="sumPay">$0</span></div>

      <div class="delivery-toggle-wrap">
        <label class="d-toggle-label">
          <input type="checkbox" id="chkDelivery" onchange="toggleDelivery()">
          <span>éœ€å®…é…å¯„é€</span> <span id="deliveryStatusText" style="font-size:12px;font-weight:400;color:#ef6c00">(è«‹å¡«å¯«æ”¶ä»¶è³‡è¨Š)</span>
        </label>
        <span id="shipFreeBadge" class="ship-free-badge" style="display:none"></span>
        <button type="button" class="d-collapse-btn" id="btnDeliveryCollapse" onclick="collapseDelivery()">æ”¶åˆ</button>

        <div id="deliveryForm" class="delivery-form">
           <input id="dName" class="d-input" placeholder="æ”¶è²¨äººå§“å (å¿…å¡«)">
           <input id="dPhone" class="d-input" type="tel" placeholder="è¯çµ¡é›»è©±/æ‰‹æ©Ÿ (å¿…å¡«)">
           <input id="dAddr" class="d-input" placeholder="æ”¶è²¨åœ°å€ (å¿…å¡«)">
           <input id="dNote" class="d-input" placeholder="å®…é…å‚™è¨» (é¸å¡«)">
        </div>
      </div>
      <div class="form-grid">
        <input id="fName" placeholder="è¨‚è³¼äººå§“å (å¿…å¡«)">
        <select id="fDept"><option value="" selected disabled>è¼‰å…¥ä¸­â€¦</option></select>
        <select id="fPay">
          <option value="ç¾é‡‘">ç¾é‡‘</option>
          <option value="ä¿¡ç”¨å¡">ä¿¡ç”¨å¡</option>
          <option value="è–ªè³‡æ‰£æ¬¾">è–ªè³‡æ‰£æ¬¾</option>
          <option value="åŒ¯æ¬¾">åŒ¯æ¬¾</option>
        </select>
        <input id="fNote" placeholder="è¨‚å–®å‚™è¨»">
      </div>
      <div class="btn-bar">
        <button class="btn-clear" onclick="clearCart()"><span class="material-icons-round">delete_outline</span></button>
        <button class="btn-submit" onclick="submitOrder()">ç¢ºèªè¨‚è³¼</button>
      </div>
      <div id="warnMsg" style="color:#ef5350;font-size:13px;text-align:center;margin-top:10px;display:none;font-weight:700;background:#ffebee;padding:8px;border-radius:8px;"></div>
    </div>
  </div>
</div>

<div id="bundleModal" class="modal">
  <div class="m-box">
    <div class="m-head">ä»»é¸ 2 ä»¶å…§å®¹ç‰©</div>
    <div class="m-sub">å·²é¸æ“‡ <span id="mCount" style="color:var(--accent);font-weight:700">0</span> / 2 ä»¶</div>
    <div class="m-grid" id="mGrid"></div>
    <div class="m-acts">
      <button class="m-btn" style="background:#f5f5f5;color:#546e7a" onclick="closeBundle()">å–æ¶ˆ</button>
      <button id="mConfirmBtn" class="m-btn disabled" style="background:var(--primary);color:#fff" onclick="confirmBundle()">ç¢ºèªé¸å–</button>
    </div>
  </div>
</div>

<div id="giftModal" class="modal">
  <div class="m-box">
    <div class="m-head" style="margin-bottom:20px">ğŸ æ»¿é¡è´ˆé”æ¨™æ¸…å–®</div>
    <div class="gift-list" id="giftListGrid"></div>
    <button class="m-btn" style="background:#f5f5f5;color:#546e7a;margin-top:20px;flex-shrink:0" onclick="closeGiftList()">é—œé–‰</button>
  </div>
</div>

<div id="receiptModal" class="modal" style="z-index:2200;">
  <div class="m-box receipt-paper" style="max-height:90vh; max-width:400px; padding:0;">
    <div class="rc-head">
      <h2 style="margin:0;font-size:18px;">è¨‚è³¼å®Œæˆ</h2>
      <div style="font-size:12px;opacity:0.8;margin-top:4px;" id="rcOrderId"></div>
    </div>
    <div class="rc-body" id="rcBody"></div>
    <div class="rc-actions">
      <button class="btn-email" onclick="toggleEmailInput()">
        <span class="material-icons-round">email</span> å¯„é€è¨‚è³¼ç´€éŒ„åˆ° Email
      </button>
      <div class="email-input-box" id="emailBox">
        <input type="email" id="rcEmail" placeholder="è«‹è¼¸å…¥ Email..." style="flex:1;">
        <button class="btn-submit" style="flex:0 0 80px;padding:10px;" onclick="sendReceipt()">ç™¼é€</button>
      </div>
      <div style="font-size:11px;color:#90a4ae;text-align:center;margin-bottom:15px;">
        è«‹è‡ªè¡Œæˆªåœ–ç•™å­˜ï¼Œæˆ–ä½¿ç”¨ä¸Šæ–¹æŒ‰éˆ•å¯„é€ã€‚
      </div>
      <button class="btn-close-rc" onclick="closeReceipt()">é—œé–‰ä¸¦å®Œæˆ</button>
    </div>
  </div>
</div>

<script>
const GIFT_IMAGES = {}; 

const SHEET_P = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQBtV8q3Ank7Bnhs83IbOb97U46juV-RKeL3NpdFiNcSu-ifI21fQYo1-io62S3JIrXEO5MiDArc1Lr/pub?gid=1623055155&single=true&output=csv";
const SHEET_R = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQU95r9_TOPlQXY-lcBS_RH3tRc0mtRyuazxHHWljpRusbzBiWsEfm3Pa_HZmKW5Ob5TOq4W5O-vumI/pub?gid=2071879068&single=true&output=csv";
const SHEET_RANK = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQj5QLrtaWikGcLNwMawbjiN8ZQDgFzW1RV7UECFgLzECWj16I2ugE_B6tzzLICCynsk1L6lAuJfccS/pub?gid=93142219&single=true&output=csv";
const SHEET_GIFTS_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQBtV8q3Ank7Bnhs83IbOb97U46juV-RKeL3NpdFiNcSu-ifI21fQYo1-io62S3JIrXEO5MiDArc1Lr/pub?gid=1623055155&single=true&output=csv";
const GAS_URL = "https://script.google.com/macros/s/AKfycbxQ9Etloak3ZNv6yfyMCK9KbjoLyDqjRQHHVlASY5iMwwy_c4NCPxWpMK1YkzSXstHN/exec";
// Free-shipping threshold forå®…é…æç¤ºï¼ˆå¯ä¾æ´»å‹•èª¿æ•´ï¼‰
const FREE_SHIP_THRESHOLD = 1000;

const PROXY = (url) => "https://corsproxy.io/?" + encodeURIComponent(url);
// --- V28.1 FIX: Resilient CSV fetch (direct-first, proxy fallback) ---
const CORS_FALLBACKS = [
  (u) => u,                      // direct
  (u) => PROXY(u),               // corsproxy.io (legacy)
  (u) => "https://api.allorigins.win/raw?url=" + encodeURIComponent(u),
  (u) => "https://cors.isomorphic-git.org/" + u
];

async function fetchTextWithTimeout(url, timeoutMs = 12000) {
  const ctrl = new AbortController();
  const t = setTimeout(() => ctrl.abort(), timeoutMs);
  try {
    const res = await fetch(url, { signal: ctrl.signal, cache: "no-store" });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    return await res.text();
  } finally {
    clearTimeout(t);
  }
}

function looksLikeHtml(text) {
  const t = String(text || "").trim().slice(0, 200).toLowerCase();
  return t.startsWith("<!doctype") || t.startsWith("<html") || t.includes("<head") || t.includes("<body");
}

async function fetchCsvTextSmart(sourceUrl, label = "data", options = {}) {
  const { timeoutMs = 12000, optional = false, minLength = 50 } = options || {};
  let lastErr = null;

  for (let i = 0; i < CORS_FALLBACKS.length; i++) {
    const u = CORS_FALLBACKS[i](sourceUrl);
    try {
      const txt = await fetchTextWithTimeout(u, timeoutMs);
      if (!txt || txt.trim().length < minLength) throw new Error("Empty response");
      if (looksLikeHtml(txt)) throw new Error("Unexpected HTML response");
      return txt;
    } catch (e) {
      lastErr = e;
      console.warn(`[CSV] ${label} fetch failed via #${i + 1}`, u, e);
    }
  }

  if (optional) return null;
  throw new Error(`${label} è®€å–å¤±æ•—ï¼ˆå¯èƒ½æ˜¯ CORS/Proxy è¢«æ“‹ï¼‰ï¼š${lastErr ? lastErr.message : "unknown"}`);
}

// Bump cache key to avoid stale config from older builds
// V2 Sprint1: strict config loading (no time-based cache, no fallback degrade)
let CONFIG_READY = false;

function setConfigLoadingUI(state) {
  const deptEl = document.getElementById("fDept");
  const payEl = document.getElementById("fPay");

  if(state === 'loading') {
    if(deptEl) {
      deptEl.disabled = true;
      deptEl.innerHTML = '<option value="" selected disabled>è¼‰å…¥ä¸­â€¦</option>';
    }
    if(payEl) payEl.disabled = true; // keep existing options, just disable
    return;
  }

  if(state === 'error') {
    if(deptEl) {
      deptEl.disabled = true;
      deptEl.innerHTML = '<option value="" selected disabled>è¨­å®šè¼‰å…¥å¤±æ•—ï¼Œè«‹é‡æ•´</option>';
    }
    if(payEl) payEl.disabled = true;
    return;
  }

  // ready
  if(deptEl) deptEl.disabled = false;
  if(payEl) payEl.disabled = false;
}

async function loadConfigOptions() {
  return await fetchAndApplyConfigOptions();
}

async function fetchAndApplyConfigOptions() {
  CONFIG_READY = false;
  setConfigLoadingUI('loading');
  setBootConfigState('loading');

  const payload = { action: "get_config" };
  try {
    const res = await fetch(GAS_URL, {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded" },
      body: "payload=" + encodeURIComponent(JSON.stringify(payload)),
      cache: "no-store"
    }).then(r => r.json());

    if(res && res.ok) {
      const data = {
        departments: Array.isArray(res.departments) ? res.departments : [],
        payments: Array.isArray(res.payments) ? res.payments : []
      };
      applyConfigToForm(data, false);
      setConfigLoadingUI('ready');
      CONFIG_READY = true;
      setBootConfigState('ready');
      return true;
    }

    throw new Error((res && (res.message || res.error)) || 'get_config failed');
  } catch(e) {
    console.warn('[Config] load failed:', e);
    CONFIG_READY = false;
    setConfigLoadingUI('error');
    setBootConfigState('error');
    try { showToast('ç³»çµ±è¨­å®šè¼‰å…¥å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†å†è©¦', 'warn'); } catch(_) {}
    return false;
  }
}

function normalizeConfigList(list, fallbackLabel) {
  const out = [];
  (list || []).forEach(x => {
    const label = String((x && (x.label || x.value)) || "").trim();
    if(!label) return;
    out.push({
      label,
      value: label,
      active: String(x.active).toLowerCase() !== "false"
    });
  });
  if(out.length === 0 && fallbackLabel) out.push({ label: fallbackLabel, value: fallbackLabel, active: true });
  return out;
}

function applyConfigToForm(cfg, fromCache) {
  const deptEl = document.getElementById("fDept");
  const payEl = document.getElementById("fPay");

  // Departments
  if(deptEl) {
    const depts = normalizeConfigList(cfg && cfg.departments, "å…¶ä»–").filter(x => x.active);
    deptEl.innerHTML = "";
    const opt0 = document.createElement("option");
    opt0.value = "";
    opt0.disabled = true;
    opt0.selected = true;
    opt0.textContent = "é¸æ“‡éƒ¨é–€";
    deptEl.appendChild(opt0);

    depts.forEach(d => {
      const o = document.createElement("option");
      o.value = d.value;
      o.textContent = d.label;
      deptEl.appendChild(o);
    });
  }

  // Payments (if provided)
  if(payEl && cfg && Array.isArray(cfg.payments)) {
    const pays = normalizeConfigList(cfg.payments, "ç¾é‡‘").filter(x => x.active);
    if(pays.length > 0) {
      payEl.innerHTML = "";
      pays.forEach((p, idx) => {
        const o = document.createElement("option");
        o.value = p.value;
        o.textContent = p.label;
        if(idx === 0) o.selected = true;
        payEl.appendChild(o);
      });
    }
  }

  // If cache, do not surface messages; if fetch, also silent to keep UI clean
}


let PRODUCTS = [], RULES = {}, CART = [], SELECTED_BUNDLE = new Map();
let PRODUCT_MAP = new Map(); 
let RANKINGS = { all:[], health:[], beauty:[], cleaning:[] };
let currentCat = "", categories = [];
let modalPid = null, isCartOpen = false;
let tempBundleSelection = [];
let lastOrderData = null; 
let sectionObserver = null;
let GIFT_MAP = new Map();
let achievedGifts = [];
let isFirstAdd = true; 

// --- ADDON (åŠ åƒ¹è³¼) HELPERS ---
// Multi-value splitter for fields like requires_any_zone_in / zone_prefix
function splitMultiVals(s) {
  return String(s || "")
    .split(/[&ï¼†|ã€,;ï¼›]/)
    .map(x => x.trim())
    .filter(Boolean);
}

function getFlatPriceRule(code, zoneText) {
  if(!RULES || !RULES.flat_price) return null;
  const z = String(zoneText||"");
  return RULES.flat_price.find(r => r.code === code && z.includes(r.zone)) || null;
}

// Eligibility: requires cart contains >= minQty items from ANY of required zones (excluding add-on items)
function isAddonEligible(addonZoneText) {
  const z = String(addonZoneText||"");
  const rule = (RULES && RULES.eligibility) ? (RULES.eligibility.find(e => z.includes(e.zone)) || null) : null;
  if(!rule) return true; // if no eligibility rule, allow
  const reqZones = splitMultiVals(rule.requires);
  const minQty = Number(rule.minQty || 1);
  if(reqZones.length === 0) return true;

  let eligibleQty = 0;
  CART.forEach(it => {
    if(!it || !it.category) return;
    if(String(it.category).includes("åŠ åƒ¹è³¼")) return; // exclude add-ons
    if(reqZones.some(rz => String(it.category).includes(rz))) eligibleQty += (Number(it.qty)||0);
  });
  return eligibleQty >= (Number.isNaN(minQty) ? 1 : minQty);
}

// Remove ineligible add-on items after cart changes. Returns number of removed lines.
function enforceAddonEligibility() {
  const addonItems = CART.filter(it => it && it.category && String(it.category).includes("åŠ åƒ¹è³¼"));
  if(addonItems.length === 0) return 0;

  const zones = Array.from(new Set(addonItems.map(it => String(it.category))));
  let removed = 0;

  zones.forEach(z => {
    if(!isAddonEligible(z)) {
      const before = CART.length;
      CART = CART.filter(it => !(it && String(it.category) === z));
      removed += (before - CART.length);
    }
  });
  return removed;
}


// Auto-navigate helper: scroll to a category section by raw zone text (from pricing_strategy)
function findCategoryForZone(zoneText){
  const z = String(zoneText||'').trim();
  if(!z) return null;
  // Prefer exact match on full category
  let cat = categories.find(c => String(c).trim() === z);
  if(!cat) cat = categories.find(c => String(c).includes(z));
  if(!cat) cat = categories.find(c => z.includes(String(c)));
  return cat || null;
}

function scrollToZoneSection(zoneText){
  try{
    const cat = findCategoryForZone(zoneText);
    if(!cat) return false;
    const id = `cat-${String(cat).replace(/\s+/g,'-')}`;
    scrollToSection(id);
    setTimeout(() => {
      const el = document.getElementById(id);
      if(el){
        el.classList.add('zone-highlight');
        setTimeout(() => el.classList.remove('zone-highlight'), 900);
      }
    }, 650);
    return true;
  }catch(e){ return false; }
}

function getFreeShipThreshold(){
  const t = (RULES && RULES.freeShipThreshold != null) ? Number(RULES.freeShipThreshold) : Number(FREE_SHIP_THRESHOLD);
  return (isFinite(t) && t > 0) ? t : 0;
}

function updateShipFreeBadge(total){
  const badge = document.getElementById('shipFreeBadge');
  if(!badge) return;
  const thr = getFreeShipThreshold();
  if(!thr){ badge.style.display='none'; return; }
  const diff = Math.max(0, Math.round(thr - (Number(total)||0)));
  if((Number(total)||0) >= thr){
    badge.classList.add('ok');
    badge.textContent = 'âœ” æ»¿é¡å…é‹';
  } else {
    badge.classList.remove('ok');
    badge.textContent = `å·® ${diff.toLocaleString()} å…é‹`;
  }
}

function syncDeliveryHeaderUI(){
  const wrap = document.querySelector('.delivery-toggle-wrap');
  const form = document.getElementById('deliveryForm');
  const status = document.getElementById('deliveryStatusText');
  const badge = document.getElementById('shipFreeBadge');
  const chk = document.getElementById('chkDelivery');
  if(!wrap || !form || !status || !badge || !chk) return;

  const expanded = !!(chk.checked && form.classList.contains('show'));
  if(expanded){
    status.style.display = 'none';
    badge.style.display = 'inline-flex';
    wrap.classList.add('has-badge');
    const total = parseFloat(String(document.getElementById('sumPay')?.innerText||'').replace(/[^\d.]/g,'')) || 0;
    updateShipFreeBadge(total);
  } else {
    status.style.display = 'inline';
    badge.style.display = 'none';
    wrap.classList.remove('has-badge');
  }
}

// --- GLOBAL FUNCTIONS ---

function cleanupUI() {
    document.body.classList.remove('modal-open');
    document.body.style.overflow = '';
    document.body.style.height = '';
}

window.closeWelcome = function() {
  const el = document.getElementById('welcome-overlay');
  el.classList.add('fade-out');
  setTimeout(() => el.style.display = 'none', 500);
};

window.safeOpenCart = function() {
  if(!CART || CART.length === 0) {
    showToast("è³¼ç‰©è»Šé‚„æ˜¯ç©ºçš„å–”ï¼è¶•å¿«å»é¸è³¼å§", "warn");
    return;
  }
  openCart();
};

window.openCart = function() {
  document.getElementById("drawer").classList.add("open"); 
  document.getElementById("float-bar").classList.add("hidden"); 
  document.body.classList.add('modal-open');
  isCartOpen = true; 
  history.pushState({modal: 'cart'}, null, ""); 
};

window.closeCart = function() {
  document.getElementById("drawer").classList.remove("open");
  document.getElementById("float-bar").classList.remove("hidden");
  cleanupUI(); 
  isCartOpen = false;
  if(history.state && history.state.modal === 'cart') history.back();
};

window.switchRank = function(type) {
  document.querySelectorAll(".r-tab").forEach(el => el.classList.remove("active"));
  event.target.classList.add("active");
  renderRanking(type);
};

// V24.3: Dual Track Gift List
window.openGiftList = function() {
    const currentTotal = parseFloat(document.getElementById("sumPay").innerText.replace('$','').replace(/,/g,'')) || 0;
    const currentBeauty = parseFloat(document.getElementById("sumBeauty").innerText.replace('$','').replace(/,/g,'')) || 0;
    
    const giftsAll = RULES.spend.filter(r => r.scope === 'all').sort((a,b) => a.amt - b.amt);
    const giftsBeauty = RULES.spend.filter(r => r.scope === 'zone_prefix').sort((a,b) => a.amt - b.amt);

    const grid = document.getElementById("giftListGrid");
    grid.innerHTML = "";

    // 1. Total Spend Section
    if (giftsAll.length > 0) {
        grid.innerHTML += `<div class="g-section-title"><span>å…¨é¤¨æ»¿é¡è´ˆ</span><span class="g-section-amt">ç›®å‰ï¼š$${Math.round(currentTotal).toLocaleString()}</span></div>`;
        giftsAll.forEach(g => {
            const reached = currentTotal >= g.amt;
            grid.appendChild(createGiftItem(g, reached));
        });
    }

    // 2. Beauty Spend Section
    if (giftsBeauty.length > 0) {
        grid.innerHTML += `<div class="g-section-title beauty"><span>ç¾å®¹æ»¿é¡è´ˆ</span><span class="g-section-amt">ç›®å‰ï¼š$${Math.round(currentBeauty).toLocaleString()}</span></div>`;
        giftsBeauty.forEach(g => {
            const reached = currentBeauty >= g.amt;
            grid.appendChild(createGiftItem(g, reached));
        });
    }

    // 3. Series Gift Section (by qty)
    const seriesRules = (RULES.series_gift || []).filter(r => r.scope === 'zone_prefix' && String(r.gift||'').trim());
    if (seriesRules.length > 0) {
        grid.innerHTML += `<div class="g-section-title">ç³»åˆ—è´ˆå“</div>`;
        seriesRules.forEach(g => {
            const prefixes = splitPrefixes(g.prefix);
            const qty = prefixes.length ? sumQtyByPrefixes(CART, prefixes) : 0;
            const reached = qty > 0;
            grid.appendChild(createSeriesGiftItem(g, reached, qty));
        });
    }

    document.getElementById("giftModal").classList.add("open");
    history.pushState({modal: 'gift'}, null, "");
};

// OPTIMIZATION: Multi-Image Helper (Grid Layout)
function renderGiftImages(giftCode) {
    const images = GIFT_MAP.get(giftCode) || [];
    if(images.length === 0) return '';
    
    let html = `<div class="g-img-row">`;
    // Max 3 images, auto extend
    images.slice(0, 3).forEach(url => {
        if(url) html += `<img src="${url}" class="g-thumb">`;
    });
    html += `</div>`;
    return html;
}

function createSeriesGiftItem(g, reached, baseQty) {
    let gName = (PRODUCT_MAP.get(g.gift) || {}).name || g.gift;
    gName = gName.replace(/^(è´ˆå“|è´ˆ|Gift)[:\s|ï½œ_]*/i, "");
    let imgHtml = renderGiftImages(g.gift);
    if(!imgHtml) imgHtml = '<div class="g-thumb" style="display:flex;align-items:center;justify-content:center;font-size:16px">ğŸ</div>';

    const unit = seriesGiftUnit(g.prefix);
    const thr = Number(g.amt);
    const ruleText = (Number.isFinite(thr) && thr > 0) ? `æ¯ ${thr} ${unit}é€` : `æ¯${unit}é€`;
    const perText = `${ruleText} ${Number(g.qty)||0} å€‹`;

    const div = document.createElement("div");
    div.className = `gift-item ${reached ? 'unlocked' : ''}`;
    div.innerHTML = `
        <div class="g-status material-icons-round">${reached ? 'check_circle' : 'lock'}</div>
        <div style="flex-shrink:0;">${imgHtml}</div>
        <div class="g-info">
          <div class="g-amt">${perText}</div>
          <div class="g-name">${gName}</div>
          <div style="font-size:12px;opacity:.8;margin-top:4px;">ç›®å‰${unit}æ•¸ï¼š${baseQty}</div>
          ${reached ? '<div class="g-tag">å·²ç²å¾—</div>' : ''}
        </div>
    `;
    return div;
}

function createGiftItem(g, reached) {
    let gName = (PRODUCT_MAP.get(g.gift) || {}).name || g.gift;
    gName = gName.replace(/^(è´ˆå“|è´ˆ|Gift)[:\s|ï½œ_]*/i, "");
    
    let imgHtml = renderGiftImages(g.gift);
    // If no images found, show placeholder
    if(!imgHtml) imgHtml = '<div class="g-thumb" style="display:flex;align-items:center;justify-content:center;font-size:16px">ğŸ</div>';

    const div = document.createElement("div");
    div.className = `gift-item ${reached ? 'unlocked' : ''}`;
    div.innerHTML = `
        <div class="g-status material-icons-round">${reached ? 'check_circle' : 'lock'}</div>
        <div style="flex-shrink:0;">${imgHtml}</div>
        <div class="g-info"><div class="g-amt">æ»¿ $${g.amt.toLocaleString()}</div><div class="g-name">${gName} x${g.qty}</div>${reached ? '<div class="g-tag">å·²ç²å¾—</div>' : ''}</div>
    `;
    return div;
}

window.closeGiftList = function() {
    if(history.state && history.state.modal === 'gift') {
        history.back();
    } else {
        document.getElementById("giftModal").classList.remove("open");
    }
};

window.toggleSum = function() {
  const b = document.getElementById("finalList");
  const i = document.getElementById("sumIcon");
  if(b.classList.contains("open")) {
    b.classList.remove("open");
    i.innerText = "expand_more";
  } else {
    b.classList.add("open");
    i.innerText = "expand_less";
  }
};

window.updateQty = function(btnEl, pid, delta) {
  const p = PRODUCTS.find(x => x._id === pid);
  if(!p) return;

  // Strict mode: if config isn't ready, do not allow cart operations
  if(typeof CONFIG_READY !== 'undefined' && !CONFIG_READY) {
    try { showInitBlockedToast(); } catch(e) { try { showToast('ç³»çµ±åˆå§‹åŒ–ä¸­â€¦è«‹ç¨å€™', 'info', 2800); } catch(e2) {} }return;
  }

  if(delta > 0 && p.category.includes("åŠ åƒ¹è³¼")) {
    if(!isAddonEligible(p.category)) {
      // Clearer hint + auto-navigate to requiredä¸»å•†å“å€
      let hint = "è«‹å…ˆé¸è³¼æŒ‡å®šä¸»å•†å“ï¼Œæ‰èƒ½åŠ è³¼å–”ï¼";
      let targetZoneRaw = null;
      const rule = (RULES && RULES.eligibility) ? (RULES.eligibility.find(e => String(p.category).includes(e.zone)) || null) : null;
      if(rule && rule.requires) {
        const reqZones = splitMultiVals(rule.requires);
        if(reqZones.length > 0) {
          targetZoneRaw = reqZones[0];
          const zoneDisplay = String(targetZoneRaw).split(/[\s_]/)[0];
          hint = `é¸è³¼ã€Œ${zoneDisplay}ã€ç³»åˆ—å•†å“ï¼Œç«‹å³äº«åŠ è³¼å„ªæƒ `;
        }
      }
      showToast(hint, "warn");
      if(targetZoneRaw) {
        setTimeout(() => { scrollToZoneSection(targetZoneRaw); }, 300);
      }
      return;
    }
  }

  if(delta > 0 && p.bundle.length >= 2 && p.name.includes("ä»»é¸")) {
    openBundle(pid); return;
  }

  let item = CART.find(x => x._id === pid && !x.bundleSelection);
  
  if(item) {
    item.qty += delta;
    if(item.qty <= 0) CART = CART.filter(x => x !== item);
  } else if (delta > 0) {
    CART.push({ ...p, qty: 1 });
  }
  
  if(delta > 0 && btnEl) animateFly(btnEl);
  
  if(delta > 0 && isFirstAdd) {
      isFirstAdd = false;
      setTimeout(() => {
          showMilestoneCard();
          setTimeout(() => { minimizeMilestoneCard(); }, 2000);
      }, 500);
  } else if (delta > 0) {
      const addedToast = showToast("å·²åŠ å…¥è³¼ç‰©è»Š");
      setTimeout(() => {
          const data = calcCart();
          checkNewGifts(data.gifts); 
      }, 800);
  }

  // Enforce add-on eligibility after any cart change
  const removedAddon = enforceAddonEligibility();
  if(removedAddon > 0) {
    showToast("åŠ åƒ¹è³¼å•†å“å·²ç§»é™¤ï¼ˆæœªç¬¦åˆåŠ è³¼æ¢ä»¶ï¼‰", "warn");
  }

  saveState();
  refreshCart();
  renderList();
  
  const fab = document.getElementById("float-bar");
  fab.classList.remove("show");
  void fab.offsetWidth; 
  if(CART.length > 0) fab.classList.add("show");
};

// --- MILESTONE LOGIC (DUAL TRACK) ---

window.showMilestoneCard = function() {
    renderMilestoneContent();
    document.getElementById('milestone-overlay').classList.add('open');
    document.getElementById('msCard').classList.remove('shrinking');
    document.body.classList.add('modal-open');
    history.pushState({modal: 'milestone'}, null, "");
};

window.closeMilestoneCard = function() {
    document.getElementById('milestone-overlay').classList.remove('open');
    if(history.state && history.state.modal === 'milestone') history.back();
};

window.minimizeMilestoneCard = function() {
    const card = document.getElementById('msCard');
    card.classList.add('shrinking');
    setTimeout(() => {
        document.getElementById('milestone-overlay').classList.remove('open'); 
        cleanupUI();
        document.getElementById('gift-fab').style.display = 'flex'; 
        if(history.state && history.state.modal === 'milestone') history.back();
    }, 600);
};

function renderMilestoneContent() {
    const data = calcCart();
    const currentTotal = data.finalTotal;
    const currentBeauty = data.beautyTotal;

    document.getElementById('ms-val-all').innerText = `$${Math.round(Number(currentTotal)||0).toLocaleString()}`;
    document.getElementById('ms-val-beauty').innerText = `$${Math.round(Number(currentBeauty)||0).toLocaleString()}`;

    const giftsAll = RULES.spend.filter(r => r.scope === 'all').sort((a,b) => a.amt - b.amt);
    const giftsBeauty = RULES.spend.filter(r => r.scope === 'zone_prefix').sort((a,b) => a.amt - b.amt);

    const nextAll = giftsAll.find(x => Number(currentTotal||0) < Number(x.amt||0));
    const nextBeauty = giftsBeauty.find(x => Number(currentBeauty||0) < Number(x.amt||0));
    const nextAllAmt = nextAll ? Number(nextAll.amt||0) : null;
    const nextBeautyAmt = nextBeauty ? Number(nextBeauty.amt||0) : null;

    const allDone = (nextAllAmt === null && giftsAll.length > 0);
    const beautyDone = (nextBeautyAmt === null && giftsBeauty.length > 0);

    const container = document.getElementById('msNodes');
    container.innerHTML = '';

    const leftCol = document.createElement('div');
    leftCol.className = 'ms-track-col';
    leftCol.innerHTML = '<div class="ms-track-title">å…¨ç«™æ»¿é¡</div>';

    const rightCol = document.createElement('div');
    rightCol.className = 'ms-track-col beauty';
    rightCol.innerHTML = '<div class="ms-track-title" style="color:var(--beauty)">ç¾å®¹æ»¿é¡</div>';

    giftsAll.forEach((g, idx) => {
        const isReached = Number(currentTotal||0) >= Number(g.amt||0);
        const isNext = (!isReached && nextAllAmt !== null && Number(g.amt||0) === nextAllAmt);
        const isDoneTag = (allDone && idx === giftsAll.length - 1);
        const diff = isNext ? Math.max(0, Math.ceil(nextAllAmt - Number(currentTotal||0))) : 0;

        leftCol.appendChild(createDualItem(g, isReached, {
          isNext: isNext || isDoneTag,
          diff,
          tagText: isDoneTag ? 'å·²é”æœ€é«˜é–€æª» ğŸ‰' : '',
          flash: isDoneTag ? false : true,
          kind: isDoneTag ? 'done' : 'next'
        }));
    });

    giftsBeauty.forEach((g, idx) => {
        const isReached = Number(currentBeauty||0) >= Number(g.amt||0);
        const isNext = (!isReached && nextBeautyAmt !== null && Number(g.amt||0) === nextBeautyAmt);
        const isDoneTag = (beautyDone && idx === giftsBeauty.length - 1);
        const diff = isNext ? Math.max(0, Math.ceil(nextBeautyAmt - Number(currentBeauty||0))) : 0;

        rightCol.appendChild(createDualItem(g, isReached, {
          isNext: isNext || isDoneTag,
          diff,
          tagText: isDoneTag ? 'å·²é”æœ€é«˜é–€æª» ğŸ‰' : '',
          flash: isDoneTag ? false : true,
          kind: isDoneTag ? 'done' : 'next'
        }));
    });

    container.appendChild(leftCol);
    container.appendChild(rightCol);

    // å‹•æ•ˆï¼šæ¯æ¬¡æ›´æ–°é–ƒ 3.1 ç§’ï¼ˆåªé‡å°ã€Œä¸‹ä¸€é–€æª»ã€æ¨™ç±¤ï¼‰
    try{
      if(window.__msTagTimer) clearTimeout(window.__msTagTimer);
      const tags = Array.from(container.querySelectorAll('.ms-tag.flash'));
      window.__msTagTimer = setTimeout(() => {
        try{ tags.forEach(t => t.classList.remove('flash')); }catch(e){}
      }, 3100);
    }catch(e){}
}

function createDualItem(g, isReached, opts) {
    const o = opts || {};
    let gName = (PRODUCT_MAP.get(g.gift) || {}).name || g.gift;
    gName = String(gName||'').replace(/^(è´ˆå“|è´ˆ|Gift)[:\s|ï½œ_]*/i, "");

    let imgHtml = '';
    try{ imgHtml = renderGiftImages(g.gift); }catch(e){}
    if(!imgHtml) imgHtml = '<div class="g-thumb" style="display:flex;align-items:center;justify-content:center;font-size:16px">ğŸ</div>';

    const isNext = !!o.isNext;
    const diff = Math.max(0, Number(o.diff||0));
    const tagText = (o.tagText && String(o.tagText).trim()) ? String(o.tagText).trim() : (isNext ? `é‚„å·® NT$${Math.round(diff).toLocaleString()}` : '');
    const wantFlash = (o.flash === false) ? false : true;
    const kind = (o.kind === 'done') ? 'done' : 'next';
    const tagClass = `ms-tag ${kind === 'done' ? 'done' : ''} ${(!wantFlash || kind==='done') ? '' : 'flash'}`.trim();

    const tagHtml = (tagText && isNext) ? `<div class="${tagClass}">${String(tagText).replace(/[<>]/g,'')}</div>` : ``;

    const item = document.createElement('div');
    item.className = `ms-dual-item ${isReached ? 'active' : ''} ${isNext ? 'next' : ''}`;
    item.innerHTML = `
      <div class="ms-d-head">
        <div class="ms-d-th">æ»¿ $${(Number(g.amt)||0).toLocaleString()}</div>
        ${tagHtml}
      </div>
      <div class="ms-d-body">
        <div class="ms-d-media">${imgHtml}</div>
        <div class="ms-d-info">
          <div class="ms-d-name">${String(gName||'').replace(/[<>]/g,'')}</div>
        </div>
      </div>
    `;
    return item;
}

function checkNewGifts(currentGifts) {
    const currentNames = currentGifts.map(g => g.name);
    const newUnlocks = currentNames.filter(n => !achievedGifts.includes(n));
    
    if(newUnlocks.length > 0) {
        const fab = document.getElementById('gift-fab');
        const notify = document.getElementById('top-notify');
        const txt = document.getElementById('tn-text');
        
        if(document.getElementById('milestone-overlay').classList.contains('open') === false) {
             fab.style.display = 'flex'; 
        }

        fab.classList.add('gift-shake');
        
        let html = "";
        newUnlocks.forEach(name => {
           html += `<div>â€¢ ${name}</div>`;
        });
        txt.innerHTML = html;
        
        notify.classList.add('show');
        
        setTimeout(() => {
            fab.classList.remove('gift-shake');
            notify.classList.remove('show');
        }, 4000); 
    }
    achievedGifts = currentNames;
}

// --- LOGIC FUNCTIONS ---

function saveState() {
  const state = { cart: CART }; 
  localStorage.setItem('v17_cart_data', JSON.stringify(state));
}

function loadState() {
  const raw = localStorage.getItem('v17_cart_data');
  if(!raw) return;
  try {
    const data = JSON.parse(raw);
    CART = data.cart.map(oldItem => {
      const freshItem = PRODUCT_MAP.get(oldItem.code);
      if(freshItem && !freshItem.is_hidden) {
          return { ...freshItem, qty: oldItem.qty, bundleSelection: oldItem.bundleSelection };
      }
      return null;
    }).filter(x => x);
    
    const cData = calcCart();
    achievedGifts = cData.gifts.map(g => g.name);
    
    refreshCart();
    renderList();
    if(CART.length > 0) {
      const fab = document.getElementById("float-bar");
      fab.classList.remove("show");
      void fab.offsetWidth;
      fab.classList.add("show");
      
      isFirstAdd = false;
      document.getElementById('gift-fab').style.display = 'flex';
    }
  } catch(e) { console.error("Load state failed", e); }
}

function showToast(msg, type='normal', durationMs=null) {
  const c = document.getElementById('toast-container');
  const t = document.createElement('div');
  t.className = 'toast';
  if(type === 'game') t.classList.add('game');
  let icon = 'check_circle';
  if (type === 'warn') icon = 'error_outline';
  if (type === 'info') icon = 'info';
  if (type === 'game') icon = 'stars'; 
  const color = (type==='warn') ? '#ff5252' : (type==='game' ? '#fff' : (type==='info' ? '#29b6f6' : '#69f0ae'));
  t.innerHTML = `<span class="material-icons-round" style="color:${color}">${icon}</span> ${msg}`;
  c.appendChild(t); 
  const ms = (durationMs!=null && isFinite(durationMs)) ? Number(durationMs) : (type === 'game' ? 3000 : 2500);
  setTimeout(() => t.remove(), ms);
  return t; 
}


// --- V2.8.8 helpers: unified discount wording (85æŠ˜ style) + promo hint toast ---
const BOOT_TS = Date.now();

function fmtZheFromPctOff(pctOff){
  const off = Number(pctOff);
  if(!isFinite(off)) return "";
  let payPct = Math.round(100 - off);
  if(!isFinite(payPct)) return "";
  if(payPct < 0) payPct = 0;
  if(payPct > 100) payPct = 100;
  if(payPct % 10 === 0) return `${payPct/10}æŠ˜`;
  return `${payPct}æŠ˜`;
}

function uiGet(key, fallback=''){
  try{
    const k = String(key||'').trim();
    if(!k || !RULES) return String(fallback||'');
    const notes = RULES.uiNotes || {};
    if(notes[k] != null && String(notes[k]).trim() !== '') return String(notes[k]).trim();
    const alt = k.startsWith('ui|') ? k.replace(/^ui\|/,'') : ('ui|' + k);
    if(notes[alt] != null && String(notes[alt]).trim() !== '') return String(notes[alt]).trim();
    const cfg = RULES.uiCfg || {};
    if(cfg[k] != null && String(cfg[k]).trim() !== '') return String(cfg[k]).trim();
    if(cfg[alt] != null && String(cfg[alt]).trim() !== '') return String(cfg[alt]).trim();
    return String(fallback||'');
  }catch(e){ return String(fallback||''); }
}
function uiGetNumber(key, fallback){
  const raw = uiGet(key, '');
  const n = Number(String(raw).replace(/,/g,'').trim());
  if(isFinite(n)) return n;
  return fallback;
}
function getPromoHintDurationMs(){
  let ms = uiGetNumber('ui|promo_hint_ms', NaN);
  if(!isFinite(ms)) ms = uiGetNumber('promo_hint_ms', NaN);
  if(!isFinite(ms)) {
    const sec = uiGetNumber('ui|promo_hint_sec', NaN);
    if(isFinite(sec)) ms = sec * 1000;
  }
  if(!isFinite(ms)) {
    const sec = uiGetNumber('promo_hint_sec', NaN);
    if(isFinite(sec)) ms = sec * 1000;
  }
  if(!isFinite(ms)) ms = 2800;
  if(ms > 0 && ms <= 60) ms = ms * 1000;
  ms = Math.max(1200, Math.min(8000, ms));
  return Math.round(ms);
}
function getBadgeName(kind, fallback){
  return uiGet(`badge_name|${kind}`, uiGet(`ui|badge_name|${kind}`, fallback));
}
function applyUiThemeVars(){
  try{
    const root = document.documentElement;
    const acc = (RULES && RULES.uiAccent) ? RULES.uiAccent : {};
    const brandMap = { beauty:'brand|beauty', clean:'brand|clean', drink:'brand|drink', health:'brand|health' };
    const alphaMap = { beauty:0.78, clean:0.70, drink:0.68, health:0.78 };

    function hexToRgba(hex, a){
      const h = String(hex||'').trim();
      const mm = h.match(/^#?([0-9a-fA-F]{6})$/);
      if(!mm) return '';
      const v = mm[1];
      const r = parseInt(v.slice(0,2),16), g = parseInt(v.slice(2,4),16), b = parseInt(v.slice(4,6),16);
      return `rgba(${r}, ${g}, ${b}, ${a})`;
    }
    Object.keys(brandMap).forEach(k=>{
      const z = brandMap[k];
      const c1 = acc[z]?.c1 || '';
      const rgba = c1 ? (hexToRgba(c1, alphaMap[k] || 0.75) || c1) : '';
      if(rgba) root.style.setProperty(`--pm-accent-${k}`, rgba);
    });

    const catInfo = acc['ui|cat_info_icon']?.c1 || acc['cat_info_icon']?.c1 || '';
    if(catInfo){
      root.style.setProperty('--cat-info-fg', catInfo);
      root.style.setProperty('--cat-info-bg', hexToRgba(catInfo, 0.12) || 'rgba(224,242,241,0.90)');
      root.style.setProperty('--cat-info-border', hexToRgba(catInfo, 0.35) || 'rgba(0,137,123,0.55)');
    }
    const annIcon = acc['ui|announce_icon']?.c1 || acc['announce_icon']?.c1 || acc['ui|promo_map_cta_icon']?.c1 || acc['promo_map_cta_icon']?.c1 || '';
    if(annIcon) root.style.setProperty('--ann-icon-fg', annIcon);

// NEW badge theming (sheet-configurable)
const nb = acc['ui|new_badge'] || acc['new_badge'] || null;
if(nb && (nb.c1 || nb.c2)){
  const c1 = String(nb.c1 || '').trim();
  const c2 = String(nb.c2 || '').trim();
  let bg = '';
  if(c1 && c2) bg = `linear-gradient(135deg, ${c1}, ${c2})`;
  else if(c1) bg = c1;
  if(bg) root.style.setProperty('--new-badge-bg', bg);
}
const nbt = (acc['ui|new_badge_text']?.c1) || (acc['new_badge_text']?.c1) || '';
if(nbt) root.style.setProperty('--new-badge-text', String(nbt).trim());


  }catch(e){}
}
function escapeHtml(str){
  return String(str||'').replace(/[&<>"']/g, (c) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
}
function showPromoHint(msg){
  try{
    let s = String(msg||'');
    // allow sheet-friendly literal \n
    s = s.replace(/\\n/g, '\n');
    s = escapeHtml(s).replace(/\r?\n/g, '<br>');
    showToast(s, 'info', getPromoHintDurationMs());
  }catch(e){}
}
// --- V2.8.9: Promo Map (å„ªæƒ åœ°åœ–) Drawer ---
function getCatHintOverride(catTitle){
  try{
    const t = String(catTitle||'').trim();
    const notes = (RULES && RULES.uiNotes) ? RULES.uiNotes : {};
    const keys = Object.keys(notes).filter(k => k.startsWith('cat_hint|'));

    // 1) Exact match first (æœ€é«˜å„ªå…ˆ)
    for(const k of keys){
      const suffix = String(k.split('|')[1]||'').trim();
      if(!suffix) continue;
      if(t === suffix) return String(notes[k]||'').trim();
    }

    // 2) Fallback: allow parent hint to apply to sub-category (title includes suffix)
    let bestSuffix = '';
    let bestText = '';
    for(const k of keys){
      const suffix = String(k.split('|')[1]||'').trim();
      if(!suffix) continue;
      if(t.includes(suffix)){
        if(suffix.length > bestSuffix.length){
          bestSuffix = suffix;
          bestText = String(notes[k]||'').trim();
        }
      }
    }
    return bestText;
  }catch(e){ return ''; }
}

function detectPromoMapBrandByTitle(title){
  const t = String(title||'').trim();
  if(!t) return 'health';
  // Drink has priority (so 'ä¿å¥é£²å“' èµ°é£²å“è‰²)
  if(t.includes('é£²å“') || t.includes('éº¥æ±') || t.includes('é»‘éº¥') || t.includes('å•¤é…’') && t.includes('é£²')) return 'drink';
  if(t.includes('ç¾å®¹')) return 'beauty';
  if(t.includes('æ¸…æ½”')) return 'clean';
  if(t.includes('ä¿å¥')) return 'health';
  return 'health';
}


function categoryUnlocksAddonByTitle(title){
  try{
    const t = String(title||'').trim();
    if(!t || !RULES || !Array.isArray(RULES.eligibility)) return false;
    for(const e of RULES.eligibility){
      const reqs = splitMultiVals(e && e.requires ? e.requires : '');
      for(const rz of reqs){
        const dz = formatZoneDisplay(rz);
        if(dz && (t.includes(dz) || dz.includes(t))) return true;
        if(rz && (t.includes(rz) || String(rz).includes(t))) return true;
      }
    }
    return false;
  }catch(e){ return false; }
}

function buildPromoMapRowHint(title){
  const override = getCatHintOverride(title);
  if(override) return override;
  const info = getTierBadgeInfoByCategory(title);
  const base = buildTierHintText(info);
  if(base) return base;
  if(categoryUnlocksAddonByTitle(title)) return 'å¯è§£é–åŠ è³¼å„ªæƒ ';
  return '';
}

function ensurePromoMapDom(){
  const overlay = document.getElementById('promoMapOverlay');
  const drawer = document.getElementById('promoMapDrawer');
  return !!(overlay && drawer);
}

function buildPromoMapList(){
  try{
    const listEl = document.getElementById('promoMapList');
    if(!listEl) return;
    listEl.innerHTML = '';
    const sections = Array.from(document.querySelectorAll('.cat-section'));
    sections.forEach(sec => {
      const titleEl = sec.querySelector('.cat-section-title');
      const title = titleEl ? String(titleEl.innerText||'').trim() : '';
      if(!title) return;
      const hint = buildPromoMapRowHint(title);
      const hasAddon = categoryUnlocksAddonByTitle(title);
      const brand = detectPromoMapBrandByTitle(title);
let catAccent = null;
try{
  const m2 = (RULES && RULES.uiCatStyle) ? RULES.uiCatStyle : {};
  if(m2 && m2[title] && (m2[title].c1 || m2[title].c2)) catAccent = m2[title];
}catch(e){}


      // styling hint kind for drawer (order/tier/bogo/addon)
      const tierInfo = getTierBadgeInfoByCategory(title);
      let kind = (tierInfo && tierInfo.kind) ? String(tierInfo.kind) : '';
      if(!kind && String(title).includes('è²·ä¸€é€ä¸€')) kind = 'bogo';
      if(!kind && hasAddon) kind = 'addon';

      const item = document.createElement('div');
      item.className = 'pm-item';
      item.setAttribute('data-kind', kind || 'plain');
      item.setAttribute('data-brand', brand || 'health');
try{
  const acc = (RULES && RULES.uiAccent) ? RULES.uiAccent : {};
  function hexToRgba(hex, a){
    const h = String(hex||'').trim();
    const mm = h.match(/^#?([0-9a-fA-F]{6})$/);
    if(!mm) return '';
    const v = mm[1];
    const r = parseInt(v.slice(0,2),16), g = parseInt(v.slice(2,4),16), b = parseInt(v.slice(4,6),16);
    return `rgba(${r}, ${g}, ${b}, ${a})`;
  }
  let c1 = (catAccent && catAccent.c1) ? catAccent.c1 : '';
  if(!c1){
    const pal = acc[`brand|${brand}`];
    c1 = pal ? (pal.c1 || '') : '';
  }
  if(c1){
    const a = (brand === 'clean') ? 0.70 : (brand === 'drink') ? 0.68 : 0.78;
    item.style.setProperty('--pm-accent', hexToRgba(c1, a) || c1);
  }
}catch(e){}

      item.setAttribute('data-target', sec.id || '');
      item.innerHTML = `
        <div class="row">
          <div>
            <div class="name">${title.replace(/[<>]/g,'')}</div>
            ${hint ? `<div class="hint">${String(hint).replace(/[<>]/g,'')}</div>` : ``}
            ${(hasAddon && (!hint || hint.indexOf('åŠ è³¼')===-1)) ? `<div class="pm-tags"><span class="pm-tag">å¯è§£é–åŠ è³¼</span></div>` : ``}
          </div>
          <div class="pm-arrow">â€º</div>
        </div>
      `;
      item.onclick = () => {
        const id = item.getAttribute('data-target');
        if(id){
          const target = document.getElementById(id);
          if(target){
            try{ target.scrollIntoView({ behavior:'smooth', block:'start' }); }catch(e){}
          }
        }
        closePromoMap();
      };
      listEl.appendChild(item);
    });
  }catch(e){}
}

/* --- V29: Promo Map 'è´ˆå“é–€æª»' åˆ†é  --- */
function pmLsGet(key, defVal){
  try{
    const v = localStorage.getItem(key);
    return (v === null || v === undefined || v === '') ? defVal : v;
  }catch(e){ return defVal; }
}
function pmLsSet(key, val){
  try{ localStorage.setItem(key, String(val)); }catch(e){}
}
function pmFormatGiftName(gift){
  try{
    let gName = (PRODUCT_MAP.get(gift) || {}).name || gift;
    gName = String(gName||'').replace(/^(è´ˆå“|è´ˆ|Gift)[:\s|ï½œ_]*/i, "");
    return gName;
  }catch(e){ return String(gift||''); }
}

function buildPromoGiftList(scope){
  try{
    const listEl = document.getElementById('promoGiftList');
    if(!listEl) return;
    listEl.innerHTML = '';
    const gifts = (RULES && Array.isArray(RULES.spend)) ? RULES.spend.filter(r => r && r.scope === scope).sort((a,b)=> (a.amt||0)-(b.amt||0)) : [];
    if(!gifts.length){
      listEl.innerHTML = '<div class="pm-empty">ç›®å‰æ²’æœ‰å¯é¡¯ç¤ºçš„è´ˆå“é–€æª»</div>';
      return;
    }
    gifts.forEach(g => {
      const item = document.createElement('div');
      item.className = 'pm-gift-item';
      const amt = Number(g.amt||0);
      const gName = pmFormatGiftName(g.gift);
      let imgHtml = '';
      try{ imgHtml = renderGiftImages(g.gift) || ''; }catch(e){}
      if(!imgHtml) imgHtml = '<div class="g-thumb" style="display:flex;align-items:center;justify-content:center;font-size:16px">ğŸ</div>';

      item.innerHTML = `
        <div class="pm-gift-row">
          <div class="pm-gift-media">${imgHtml}</div>
          <div class="pm-gift-info">
            <div class="pm-gift-amt">æ»¿ $${Math.round(amt).toLocaleString()}</div>
            <div class="pm-gift-name">${String(gName||'').replace(/[<>]/g,'')}</div>
          </div>
        </div>
      `;
      listEl.appendChild(item);
    });
  }catch(e){}
}

function setPromoGiftScope(scope, opts){
  const o = opts || {};
  const sc = (scope === 'zone_prefix') ? 'zone_prefix' : 'all';
  const btns = Array.from(document.querySelectorAll('#promoMapPaneGifts .pm-scope-btn'));
  btns.forEach(b=>{
    const isOn = (String(b.getAttribute('data-scope')) === sc);
    b.classList.toggle('active', isOn);
    b.setAttribute('aria-selected', isOn ? 'true' : 'false');
  });
  if(!o.skipSave) pmLsSet('ttl_pm_gift_scope', sc);
  buildPromoGiftList(sc);
}

function setPromoMapTab(tab, opts){
  const o = opts || {};
  const t = (tab === 'gifts') ? 'gifts' : 'nav';
  const navBtn = document.getElementById('pmTabNav');
  const giftsBtn = document.getElementById('pmTabGifts');
  const paneNav = document.getElementById('promoMapPaneNav');
  const paneGifts = document.getElementById('promoMapPaneGifts');
  if(navBtn){ navBtn.classList.toggle('active', t==='nav'); navBtn.setAttribute('aria-selected', t==='nav' ? 'true' : 'false'); }
  if(giftsBtn){ giftsBtn.classList.toggle('active', t==='gifts'); giftsBtn.setAttribute('aria-selected', t==='gifts' ? 'true' : 'false'); }
  if(paneNav) paneNav.style.display = (t==='nav') ? 'block' : 'none';
  if(paneGifts) paneGifts.style.display = (t==='gifts') ? 'block' : 'none';
  if(!o.skipSave) pmLsSet('ttl_pm_tab', t);

  if(t==='nav'){
    buildPromoMapList();
  }else{
    const scope = pmLsGet('ttl_pm_gift_scope', 'all');
    setPromoGiftScope(scope, {skipSave:true});
  }
}

function initPromoMapTabsOnce(){
  try{
    const drawer = document.getElementById('promoMapDrawer');
    if(!drawer) return;
    if(drawer.dataset.pmTabsInited === '1') return;

    const navBtn = document.getElementById('pmTabNav');
    const giftsBtn = document.getElementById('pmTabGifts');
    if(navBtn) navBtn.onclick = () => setPromoMapTab('nav');
    if(giftsBtn) giftsBtn.onclick = () => setPromoMapTab('gifts');

    const scopeBtns = Array.from(document.querySelectorAll('#promoMapPaneGifts .pm-scope-btn'));
    scopeBtns.forEach(b=>{
      b.onclick = () => setPromoGiftScope(b.getAttribute('data-scope'));
    });

    drawer.dataset.pmTabsInited = '1';
  }catch(e){}
}

function openPromoMap(){
  try{
    if(!ensurePromoMapDom()) return;
    initPromoMapTabsOnce();
    const prefTab = pmLsGet('ttl_pm_tab','nav');
    setPromoMapTab(prefTab, {skipSave:true});
    document.body.classList.add('drawer-open');
    const overlay = document.getElementById('promoMapOverlay');
    const drawer = document.getElementById('promoMapDrawer');
    overlay.style.display = 'block';
    drawer.classList.add('open');

    
    try{ history.pushState({modal:'promoMap'}, null, ""); }catch(e){}
overlay.onclick = () => closePromoMap();
    const closeBtn = document.getElementById('promoMapCloseBtn');
    if(closeBtn) closeBtn.onclick = () => closePromoMap();
  }catch(e){}
}

function closePromoMap(opts){
  const o = opts || {};
  const skipHistory = !!o.skipHistory;
  try{
    const overlay = document.getElementById('promoMapOverlay');
    const drawer = document.getElementById('promoMapDrawer');
    if(overlay) overlay.style.display = 'none';
    if(drawer) drawer.classList.remove('open');
    document.body.classList.remove('drawer-open');
  }catch(e){}
  try{
    if(!skipHistory && history.state && history.state.modal === 'promoMap'){
      history.back();
    }
  }catch(e){}
}


// --- Promo Map + Back Guard helpers ---
let BACK_EXIT_ARMED_UNTIL = 0;

function isPromoMapOpen(){
  const d = document.getElementById('promoMapDrawer');
  return !!(d && d.classList.contains('open'));
}

function initBackGuard(){
  try{
    const st = history.state || null;
    if(st && (st.page === 'guard' || st.page === 'root')) return;
    history.replaceState({page:'root'}, null, "");
    history.pushState({page:'guard'}, null, "");
  }catch(e){}
}

function armBackGuard(){
  try{
    const st = history.state || null;
    if(st && st.page === 'guard') return;
    history.pushState({page:'guard'}, null, "");
  }catch(e){}
}

function handleRootBack(){
  try{
    // Step 1: if not at top, go top first
    if(window.scrollY > 60){
      window.scrollTo({top:0, behavior:'smooth'});
      BACK_EXIT_ARMED_UNTIL = 0;
      armBackGuard();
      return;
    }

    // Step 2: at top, show exit hint then allow exit on next back
    const now = Date.now();
    if(now < BACK_EXIT_ARMED_UNTIL){
      BACK_EXIT_ARMED_UNTIL = 0;
      try{ window.onbeforeunload = null; }catch(e){}
      history.back();
      return;
    }

    showToast('å†æŒ‰ä¸€æ¬¡è¿”å›å³å¯é›¢é–‹', 'info', 2000);
    BACK_EXIT_ARMED_UNTIL = now + 2200;
    armBackGuard();
  }catch(e){
    try{ armBackGuard(); }catch(e2){}
  }
}

function showInitBlockedToast(){
  const waited = Math.max(1, Math.round((Date.now() - BOOT_TS)/1000));
  showToast(`ç³»çµ±åˆå§‹åŒ–ä¸­â€¦å·²ç­‰å¾… ${waited} ç§’`, 'info', 2800);
}

function setBootConfigState(state){
  try{
    document.body.classList.remove('cfg-loading','cfg-ready','cfg-error');
    if(state === 'loading') document.body.classList.add('cfg-loading');
    if(state === 'ready') document.body.classList.add('cfg-ready');
    if(state === 'error') document.body.classList.add('cfg-error');
  }catch(e){}
}

function renderSystemAnnouncement(){
  try{
    const slot = document.getElementById('systemAnnouncementSlot');
    if(!slot) return;
    const notes = (RULES && RULES.uiNotes) ? RULES.uiNotes : {};
    const raw = (notes && notes['announce_between_rank_and_categories']) ? String(notes['announce_between_rank_and_categories']) : '';
    const msg = String(raw||'').trim();
    const safe = msg ? msg.split('\n').map(s => s.replace(/[<>]/g,'')).join('<br>') : '';
    const seen = (function(){ try{ return localStorage.getItem('ttl_promo_map_seen')==='1'; }catch(e){ return false; } })();
    const attnCls = seen ? '' : ' pm-attn';

    // show slot if has message OR we still want CTA entry
    slot.style.display='block';
    slot.innerHTML = `
      <div class="sys-ann sys-ann--row">
        ${safe ? `<div class="sys-ann-main">${safe}</div>` : `<div class="sys-ann-main"></div>`}
        <button type="button" id="promoMapCtaBtn" class="sys-ann-cta${attnCls}"><span class="cta-icon">ğŸ‘‰</span><span class="cta-text">æŸ¥çœ‹å„ªæƒ åœ°åœ– â€º</span></button>
      </div>
    `;

    const btn = document.getElementById('promoMapCtaBtn');
    if(btn){
try{
  const iconEl = btn.querySelector('.cta-icon');
  const textEl = btn.querySelector('.cta-text');
  const iconTxt = uiGet('ui|promo_map_cta_icon', uiGet('promo_map_cta_icon','ğŸ‘‰')) || 'ğŸ‘‰';
  const labelTxt = uiGet('ui|promo_map_cta_text', uiGet('promo_map_cta_text','æŸ¥çœ‹å„ªæƒ åœ°åœ– â€º')) || 'æŸ¥çœ‹å„ªæƒ åœ°åœ– â€º';
  if(iconEl) iconEl.textContent = iconTxt;
  if(textEl) textEl.textContent = labelTxt;
}catch(e){}

      btn.onclick = (ev) => {
        ev.preventDefault();
        ev.stopPropagation();
        try{ localStorage.setItem('ttl_promo_map_seen','1'); }catch(e){}
        try{ btn.classList.remove('pm-attn'); }catch(e){}
        try{ openPromoMap(); }catch(e){}
      };
    }
  }catch(e){}
}


// Determine tier badge kind for a category (order discount vs multi-tier)
function getTierBadgeInfoByCategory(cat){
  try{
    const c = String(cat||'');
    if(!c || !RULES || !Array.isArray(RULES.tiers)) return null;
    const matches = RULES.tiers.filter(t => t && isFinite(t.pct) && t.pct > 0 && t.zone && c.includes(t.zone));
    if(matches.length === 0) return null;
    // choose the most specific zone (longest match)
    const zones = [...new Set(matches.map(m => String(m.zone)))].sort((a,b)=>b.length-a.length);
    const zone = zones[0];
    const rules = RULES.tiers.filter(t => String(t.zone)===zone && isFinite(t.pct) && t.pct>0).sort((a,b)=>Number(a.min)-Number(b.min));
    if(rules.length === 1 && Number(rules[0].min) <= 1) return { kind:'order', zone, rules };
    return { kind:'tier', zone, rules };
  }catch(e){ return null; }
}


function buildTierHintText(info){
  if(!info || !Array.isArray(info.rules) || info.rules.length===0) return '';
  const orderLabel = getBadgeName('order_discount','è¨‚å–®æŠ˜æ‰£');
  const tierLabel  = getBadgeName('tier','å¤šä»¶å„ªæƒ ');
  if(info.kind === 'order'){
    const zhe = fmtZheFromPctOff(info.rules[0].pct);
    return zhe ? `${orderLabel}ï¼š${zhe}` : `${orderLabel}`;
  }
  const parts = info.rules.map(r => {
    const min = Number(r.min)||1;
    const zhe = fmtZheFromPctOff(r.pct);
    return `æ»¿${min}ä»¶ ${zhe || ''}`.trim();
  });
  return `${tierLabel}ï¼š${parts.join('ã€')}`;
}


function animateFly(startEl) {
  const card = startEl.closest('.p-card') || startEl.closest('.r-card');
  if (!card) return;
  const rect = startEl.getBoundingClientRect();
  const target = document.querySelector('.fb-btn').getBoundingClientRect();
  const fly = document.createElement('img');
  
  let imgEl = card.querySelector('img.p-img') || card.querySelector('img.r-img');
  if(!imgEl) imgEl = card.querySelector('img');
  
  fly.src = imgEl ? imgEl.src : ''; 
  if(!fly.src) return;
  
  fly.className = 'flying-img';
  fly.style.transform = 'scale(1.2) rotate(0deg)';
  fly.style.top = rect.top + 'px';
  fly.style.left = rect.left + 'px';
  fly.style.opacity = '1';
  document.body.appendChild(fly);
  
  void fly.offsetWidth;

  setTimeout(() => {
    fly.style.top = (target.top + 10) + 'px'; 
    fly.style.left = (target.left + 20) + 'px';
    fly.style.transform = 'scale(0.1) rotate(360deg)'; 
    fly.style.opacity = '0.5';
  }, 10); 

  setTimeout(() => fly.remove(), 1000); 
}

function animateGiftFly(giftName) {
  const target = document.querySelector('.fb-btn').getBoundingClientRect();
  const fly = document.createElement('img');
  
  let images = GIFT_MAP.get(giftName) || [];
  let imgSrc = images.length > 0 ? images[0] : '';

  if(imgSrc) {
      fly.src = imgSrc;
  } else {
      const canvas = document.createElement('canvas');
      canvas.width = 60; canvas.height = 60;
      const ctx = canvas.getContext('2d');
      ctx.font = '40px serif';
      ctx.fillText('ğŸ', 10, 45);
      fly.src = canvas.toDataURL();
  }

  fly.className = 'flying-gift';
  const startTop = (window.innerHeight / 2) - 30;
  const startLeft = (window.innerWidth / 2) - 30;
  
  fly.style.top = startTop + 'px';
  fly.style.left = startLeft + 'px';
  fly.style.transform = 'scale(0)'; 
  document.body.appendChild(fly);

  setTimeout(() => {
      fly.style.transition = 'transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275)';
      fly.style.transform = 'scale(1.5)';
  }, 10);

  setTimeout(() => {
      fly.style.transition = 'all 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55)';
      fly.style.top = target.top + 'px';
      fly.style.left = target.left + 'px';
      fly.style.transform = 'scale(0.2)';
      fly.style.opacity = '0.5';
  }, 800);

  setTimeout(() => fly.remove(), 1600);
}

function jumpToProduct(pid) {
  const searchInp = document.getElementById("searchInp");
  if(searchInp.value) {
    searchInp.value = "";
    document.getElementById("clearSearch").style.display = 'none'; 
    renderList(); 
  }
  setTimeout(() => {
    const el = document.getElementById(`p-${pid}`);
    if(el) {
      el.scrollIntoView({ behavior: "smooth", block: "center" });
      el.classList.add("flash-highlight");
      setTimeout(()=>el.classList.remove("flash-highlight"), 1300);
    }
  }, 100);
}

function jumpToGroupByCode(groupCode){
  const gc = String(groupCode||'').trim();
  if(!gc) return false;
  const g = PRODUCT_MAP.get(gc);
  if(g && !g.is_hidden){
    jumpToProduct(g._id);
    return true;
  }
  try{ showPromoHint(`æ‰¾ä¸åˆ°å•†å“çµ„ï¼š${gc}`); }catch(e){}
  return false;
}
function handleRankingClick(p){
  try{
    if(p && p.is_hidden && p.group_code){
      if(jumpToGroupByCode(p.group_code)) return;
    }
  }catch(e){}
  jumpToProduct(p._id);
}


// FIX: Improved Highlight Logic
function highlightText(text, query) {
  if (!query) return text;
  // Escape regex chars to be safe
  const safeQuery = query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
  const regex = new RegExp(`(${safeQuery})`, 'gi');
  return text.replace(regex, '<span class="highlight">$1</span>');
}

async function initApp() {
  try{ setBootConfigState('loading'); }catch(e){}

  try {
    // V2 Sprint1: core datasets fetched in parallel (faster + consistent)
const [pText, rText, rankText, gText] = await Promise.all([
  fetchCsvTextSmart(SHEET_P, "å•†å“è³‡æ–™"),
  fetchCsvTextSmart(SHEET_R, "å„ªæƒ è¦å‰‡"),
  fetchCsvTextSmart(SHEET_RANK, "ç†±éŠ·æ¦œ", { optional: true }),
  fetchCsvTextSmart(SHEET_GIFTS_URL, "è´ˆå“åœ–ç‰‡", { optional: true })
]);

const pData = Papa.parse(pText, { header: true, skipEmptyLines: true }).data;
    PRODUCTS = pData.map((row, i) => {
      const pick = (k) => {
        const kk = String(k||'').replace(/^\uFEFF/,'').trim().toLowerCase();
        const key = Object.keys(row).find(key => String(key||'').replace(/^\uFEFF/,'').trim().toLowerCase() === kk);
        return (key ? row[key] : "") || "";
      };
      const code = String(pick("product_code")||"").trim();
      const name = String(pick("product_name")||"").trim();
      if(!code || !name) return null;
      const isGift = String(pick("is_gift")||"").toLowerCase();

const _bool = (v) => {
  const s = String(v||'').trim().toLowerCase();
  return (s === 'true' || s === '1' || s === 'y' || s === 'yes' || s === 't');
};
const isNew = _bool(pick("is_new"));
const isHidden = _bool(pick("is_hidden"));
const groupCode = String(pick("group_code")||"").trim();


      let bundle = [];
      for(let k=1; k<=4; k++) {
        let sn = String(pick(`spec_${k}`)||"").trim();
        let sq = Number(pick(`spec_${k}_qty`)||1);
        if(sn) {
          // specs sometimes come as: "375358-12 VINATAç·Šç·»æ´»è†šè† å›Š"
          sn = sn.replace(/^([A-Za-z0-9\-\.]+)\s+/, '').trim();
          bundle.push({ name: sn, qty: sq });
        }
      }

      // V24.0+: gifts are NOT sellable items, but still keep full metadata for gifts-content/statistics
      if(isGift === 'true' || isGift.includes('æ˜¯')) {
        PRODUCT_MAP.set(code, { name, price: 0, bundle });
        return null;
      }
      const p = {
        _id: i, code: code, name: name, category: pick("category").trim(),
        price: Number((pick("list_price")||"0").replace(/,/g,'')), spec: pick("spec"), photo: pick("photos url"), bundle: bundle,
        is_new: isNew, is_hidden: isHidden, group_code: groupCode
      };
      if(p.code) PRODUCT_MAP.set(p.code, p);
      
      // Collect Multiple Images for Gift Map
      if(p.photo && p.photo.length > 5) {
          let imgs = [p.photo];
          let p2 = pick("Photos url 2");
          let p3 = pick("Photos url 3");
          if(p2 && p2.length > 5) imgs.push(p2);
          if(p3 && p3.length > 5) imgs.push(p3);
          GIFT_MAP.set(p.code, imgs); 
      }
      return p;
    }).filter(x => x);

    if(!PRODUCTS || PRODUCTS.length === 0) {
      throw new Error("å•†å“è³‡æ–™ç‚ºç©ºï¼ˆå¯èƒ½æ˜¯é€£ç·šè¢«æ“‹ / ä»£ç†å›å‚³ç•°å¸¸ï¼‰");
    }

    const rData = Papa.parse(rText, { header: true, skipEmptyLines: true }).data;
    RULES = { tiers: [], bogo: [], spend: [], bundle: [], series_gift: [], flat_price: [], eligibility: [], uiNotes: {}, uiAccent: {}, uiCatStyle: {}, uiCfg: {}, freeShipThreshold: null };
    rData.forEach(row => {
      const pick = (k) => {
        const kk = String(k||'').replace(/^\uFEFF/,'').trim().toLowerCase();
        const key = Object.keys(row).find(key => String(key||'').replace(/^\uFEFF/,'').trim().toLowerCase() === kk);
        return (key ? row[key] : "") || "";
      };
      const type = pick("rule_type").toLowerCase();
      if(type.includes("tier")) RULES.tiers.push({ zone: pick("zone").trim(), min: Number(pick("min_qty")), pct: Number(pick("percent_off")) });
      else if(type.includes("bogo")) RULES.bogo.push({ code: pick("product_code"), buy: Number(pick("buy")), get: Number(pick("get")) });
      else if(type.includes("flat_price")) {
        const zone = pick("zone").trim();
        const code = String(pick("product_code")||"").trim();
        const unit = Number(pick("unit_price")||pick("charge")||0);
        if(zone && code && !Number.isNaN(unit)) RULES.flat_price.push({ zone, code, unit });
      }
      else if(type.includes("eligibility")) {
        const zone = pick("zone").trim();
        const requires = String(pick("requires_any_zone_in")||"").trim();
        const minQty = Number(pick("requires_min_qty")||pick("requires_min_qty ")||pick("requires_min_qty\t")||1);
        if(zone) RULES.eligibility.push({ zone, requires, minQty: (Number.isNaN(minQty) ? 1 : minQty) });
      }
      else if(type.includes("series_gift")) {
        const mRaw = String(pick("multiples") || "").trim().toUpperCase();
        const mult = (mRaw === "TRUE" || mRaw === "1" || mRaw === "YES");
        RULES.series_gift.push({ scope: pick("threshold_scope"), prefix: pick("zone_prefix"), amt: Number(pick("threshold_amount")), gift: pick("gift_code"), qty: Number(pick("gift_qty")), mult });
      }
      else if(type.includes("spend")) {
        const mRaw = String(pick("multiples") || "").trim().toUpperCase();
        const mult = (mRaw === "TRUE" || mRaw === "1" || mRaw === "YES");
        RULES.spend.push({ scope: pick("threshold_scope"), prefix: pick("zone_prefix"), amt: Number(pick("threshold_amount")), gift: pick("gift_code"), qty: Number(pick("gift_qty")), mult });
      }

      else if(type.includes("shipping_threshold")) {
        const rawAmt = String(pick("threshold_amount")||"").trim().replace(/,/g,'');
        const amt = Number(rawAmt);
        if(isFinite(amt) && amt > 0) RULES.freeShipThreshold = amt;
      }
      
else if(type.includes("ui_accent")) {
  const zone = String(pick("zone")||"").trim();
  const c1 = String(pick("ui_accent")||"").trim();
  const c2 = String(pick("ui_accent2")||"").trim();
  if(zone && (c1 || c2)) RULES.uiAccent[zone] = { c1, c2 };
}
else if(type.includes("ui_cat_style")) {
  // zone format: cat|<åˆ†é¡æ¨™é¡Œ>
  const zone = String(pick("zone")||"").trim();
  const mm = zone.match(/^cat\|(.+)$/);
  const catKey = mm ? String(mm[1]||'').trim() : zone.replace(/^cat\|/,'').trim();
  const c1 = String(pick("ui_accent")||"").trim();
  const c2 = String(pick("ui_accent2")||"").trim();
  if(catKey && (c1 || c2)) RULES.uiCatStyle[catKey] = { c1, c2 };
}
else if(type.includes("ui_config")) {
  const key = String(pick("zone")||"").trim();
  const txt = String(pick("ui_text")||"").trim();
  const rawAmt = String(pick("threshold_amount")||"").trim().replace(/,/g,'');
  const amt = Number(rawAmt);
  if(key){
    RULES.uiCfg[key] = (txt ? txt : (isFinite(amt) ? amt : ""));
  }
}
else if(type.includes("ui_note")) {
        const zone = String(pick("zone")||"").trim();
        const txt = String(pick("ui_text")||"").trim();
        if(zone && txt) RULES.uiNotes[zone] = txt;
      }

            else if(type.includes("bundle")) RULES.bundle.push({ code: pick("product_code"), price: Number(pick("unit_price")) });
    });
if (gText) {
  const gData = Papa.parse(gText, { header: true, skipEmptyLines: true }).data;
  gData.forEach(row => {
      const pick = (k) => {
        const kk = String(k||'').replace(/^\uFEFF/,'').trim().toLowerCase();
        const key = Object.keys(row).find(key => String(key||'').replace(/^\uFEFF/,'').trim().toLowerCase() === kk);
        return (key ? row[key] : "") || "";
      };
      const code = pick("product_code");
      const url = pick("photos url");
      if(code && url) {
          let imgs = [url];
          let u2 = pick("Photos url 2");
          let u3 = pick("Photos url 3");
          if(u2) imgs.push(u2);
          if(u3) imgs.push(u3);
          GIFT_MAP.set(code, imgs);
      }
  });
}

if (rankText) {
  processRankings(rankText);
}


    try{ applyUiThemeVars(); }catch(e){}

    renderUI();
    renderSystemAnnouncement();

// V2 Sprint1: staged rendering (reduce perceived waiting)
// Do NOT block the whole page on config fetch.
const loaderEl = document.getElementById("loader");
if(loaderEl) {
  loaderEl.style.opacity = 0;
  setTimeout(()=>{ try{ loaderEl.remove(); } catch(e){} }, 300);
}

// Let the browser paint the UI ASAP
await new Promise(r => requestAnimationFrame(r));

// Restore cart as soon as UI exists
loadState();

// Load dropdown config (departments / payments) in background.
// Ordering stays strict: config not ready => cannot submit.
loadConfigOptions().catch(()=>{});
} catch(e) { alert("é€£ç·šç•°å¸¸ï¼Œè«‹ç¨å¾Œé‡è©¦ã€‚\n" + e.message); }
}

function processRankings(csvText) {
  RANKINGS = { all:[], health:[], beauty:[], cleaning:[] };
  const rows = Papa.parse(csvText, { header: false }).data;
  let rawList = [];
  let processedCodes = new Set();

  rows.forEach(r => {
    if(r.length < 6) return;
    const code = r[0];
    let qtyStr = r[5] || "0";
    let qty = parseFloat(qtyStr.toString().replace(/,/g, ''));
    if(!qty || qty <= 0) {
        qtyStr = r[4] || "0";
        qty = parseFloat(qtyStr.toString().replace(/,/g, ''));
    }

    if(PRODUCT_MAP.has(code) && qty > 0 && !processedCodes.has(code)) {
      const p = PRODUCT_MAP.get(code);
      rawList.push({ ...p, sold: qty });
      processedCodes.add(code);
    }
  });

  rawList.sort((a,b) => b.sold - a.sold);
  RANKINGS.all = rawList.slice(0, 10);
  RANKINGS.health = rawList.filter(i => getRankingCategory(i.name, i.category) === 'health').slice(0, 10);
  RANKINGS.beauty = rawList.filter(i => getRankingCategory(i.name, i.category) === 'beauty').slice(0, 10);
  RANKINGS.cleaning = rawList.filter(i => getRankingCategory(i.name, i.category) === 'cleaning').slice(0, 10);

  if(RANKINGS.all.length > 0) {
    document.getElementById("ranking-section").style.display = "block";
    renderRanking("all");
  }
}

function getRankingCategory(name, originalCat) {
  const n = String(name||'').toLowerCase();
  const c = String(originalCat||'').toLowerCase();

  // æ¸…æ½”ï¼šé¿å…ç”¨å–®å­—ã€Œæ´—ã€é€ æˆèª¤åˆ¤ï¼Œæ”¹æ¡é¡¯æ€§é—œéµå­—
  const cleaningKeywords = ["æ˜“æ´—æ¨‚","æ´—æ½”","æ´—è¡£","æ´—ç¢—","èœç“œå¸ƒ","çš‚","æ´—é«®","æ²æµ´","æ´—é¢","æ´—æ‰‹"];
  if (c.includes("æ¸…æ½”") || cleaningKeywords.some(kw => n.includes(String(kw).toLowerCase()))) return "cleaning";

  // ç¾å®¹ï¼šç§»é™¤æ´—é«®/æ²æµ´ï¼Œæ–°å¢è­·é«®/è­·æ‰‹
  const beautyKeywords = ["vinata","é¢è†œ","ç²¾è¯","éœœ","éœ²","ä¹³æ¶²","æ½”é¡","å¸å¦","ç¾ç™½","ä¿æ¿•","æŠ—çšº","æ½¤","é€","äº®","è†š","ç—˜","è­·é«®","è­·æ‰‹"];
  if (c.includes("ç¾å®¹") || c.includes("ä¿é¤Š") || beautyKeywords.some(kw => n.includes(String(kw).toLowerCase()))) return "beauty";

  const healthKeywords = ["å®‰å¯å¥","s11","ç›Šç”ŸèŒ","ç´è±†","ç´…éº´","é­šæ²¹","éˆ£","è‘¡è„ç³–èƒº","è‘‰é»ƒç´ ","è† å›Š","éŒ ","é…µç´ "];
  if (c.includes("ä¿å¥") || c.includes("å¥åº·") || healthKeywords.some(kw => n.includes(String(kw).toLowerCase()))) return "health";

  return "other";
}

function renderRanking(type) {
  const list = document.getElementById("rankList");
  list.innerHTML = "";
  const data = RANKINGS[type] || [];
  data.forEach((p, idx) => {
    const card = document.createElement("div");
    card.className = "r-card";
    card.dataset.rank = idx + 1; 
    card.onclick = () => handleRankingClick(p);
    let imgHtml = `<div class="p-no-img" style="height:100%;justify-content:center;font-size:10px">ç„¡åœ–</div>`;
    if(p.photo && p.photo.length > 5) imgHtml = `<img src="${p.photo}" class="r-img" loading="lazy">`;
    card.innerHTML = `<div class="r-img-wrap"><div class="r-badge">${idx + 1}</div><div class="r-sold-tag">å”®${p.sold.toLocaleString()}ä»¶</div>${imgHtml}</div><div class="r-name">${p.name}</div>`;
    list.appendChild(card);
  });
}

function switchRank(type) {
  document.querySelectorAll(".r-tab").forEach(el => el.classList.remove("active"));
  event.target.classList.add("active");
  renderRanking(type);
}

function renderUI() {
  const nav = document.getElementById("catNav");
  let rawCats = [...new Set(PRODUCTS.map(p => p.category))].filter(Boolean);
  const cleaningBase = "æ¸…æ½”ç”¨å“";
  const hasCleaning = rawCats.some(c => c.includes(cleaningBase));
  if(hasCleaning) {
      rawCats = rawCats.filter(c => !c.includes(cleaningBase));
      rawCats.push("æ¸…æ½”-æ´—æ½”", "æ¸…æ½”-æ´—è¡£", "æ¸…æ½”-çš‚"); 
  }
  
  const allPill = document.createElement("div");
  allPill.className = "cat-pill active";
  allPill.innerText = "ç†±éŠ·æ’è¡Œ"; 
  allPill.onclick = () => scrollToSection('cat-all');
  nav.appendChild(allPill);

  rawCats.forEach(c => {
    let displayName = c.includes("æ¸…æ½”-") ? c : c.split(/[\s_]/)[0];
    const pill = document.createElement("div");
    pill.className = "cat-pill";
    pill.innerText = displayName;
    pill.dataset.target = `cat-${c.replace(/\s+/g, '-')}`;
    pill.onclick = () => scrollToSection(pill.dataset.target);
    nav.appendChild(pill);
  });
  
  categories = rawCats; 
  renderList();
  setupScrollSpy();
}

function scrollToSection(id) {
  const el = document.getElementById(id);
  if(el) {
    if(document.getElementById("searchInp").value) {
        document.getElementById("searchInp").value = "";
        document.getElementById("clearSearch").style.display = 'none'; 
        renderList();
        setTimeout(() => {
             const el2 = document.getElementById(id);
             if(el2) el2.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }, 50);
    } else {
        el.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
  } else if (id === 'cat-all') {
      window.scrollTo({ top:0, behavior:'smooth' });
  }
}

function setupScrollSpy() {
  if (sectionObserver) sectionObserver.disconnect();
  const options = { root: null, rootMargin: '-135px 0px -70% 0px', threshold: 0 };
  sectionObserver = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        const id = entry.target.id;
        document.querySelectorAll(".cat-pill").forEach(pill => {
          pill.classList.toggle("active", pill.dataset.target === id || (id==='cat-all-wrapper' && pill.innerText==='ç†±éŠ·æ’è¡Œ'));
        });
        const activePill = document.querySelector(".cat-pill.active");
        if(activePill) activePill.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
      }
    });
  }, options);
  document.querySelectorAll('.cat-section').forEach(section => { sectionObserver.observe(section); });
}

function renderList() {
  const grid = document.getElementById("list");
  grid.innerHTML = "";
  const inp = document.getElementById("searchInp");
  const q = inp.value.toLowerCase().trim();
  
  document.getElementById("clearSearch").style.display = q.length > 0 ? 'block' : 'none';
  
  if (q) {
    if(sectionObserver) sectionObserver.disconnect();
    const filtered = PRODUCTS.filter(p => !p.is_hidden && (p.name.toLowerCase().includes(q) || p.code.toLowerCase().includes(q)));
    document.getElementById("empty-state").style.display = filtered.length === 0 ? "block" : "none";
    const container = document.createElement("div");
    container.className = "grid-layout";
    filtered.forEach(p => { container.appendChild(createProductCard(p, q)); });
    grid.appendChild(container);
  } else {
    document.getElementById("empty-state").style.display = "none";
    
    const topAnchor = document.createElement("div");
    topAnchor.id = "cat-all-wrapper";
    grid.appendChild(topAnchor);

    categories.forEach(cat => {
        const catProducts = PRODUCTS.filter(p => {
            if(p.is_hidden) return false;
            if (cat.includes("æ¸…æ½”-")) {
                if (!p.category.includes("æ¸…æ½”")) return false;
                if (cat === "æ¸…æ½”-æ´—æ½”" && !p.name.includes("æ´—æ½”")) return false;
                if (cat === "æ¸…æ½”-æ´—è¡£" && !p.name.includes("æ´—è¡£")) return false;
                if (cat === "æ¸…æ½”-çš‚" && !p.name.includes("çš‚")) return false;
                return true;
            } else { return p.category.includes(cat); }
        });
        if (catProducts.length > 0) {
            const secId = `cat-${cat.replace(/\s+/g, '-')}`;
            const section = document.createElement("div"); section.className = "cat-section"; section.id = secId;
            const title = document.createElement("div"); title.className = "cat-section-title";
            let displayName = cat.includes("æ¸…æ½”-") ? cat : cat.split(/[\s_]/)[0];
            title.innerText = displayName;
            section.appendChild(title);
            const gridContainer = document.createElement("div"); gridContainer.className = "grid-layout";
            catProducts.forEach(p => { gridContainer.appendChild(createProductCard(p, null)); });
            section.appendChild(gridContainer);
            grid.appendChild(section);
        }
    });
    setupScrollSpy();
  }
}


/* v2.5: Price Range Pill (theoretical tier range from pricing_strategy) */
function getTierDiscountRangeForProduct(p){
  try{
    if(!p || !p.price || !RULES || !Array.isArray(RULES.tiers)) return null;
    const matches = RULES.tiers.filter(t => t && !isNaN(t.pct) && t.pct > 0 && p.category && p.category.includes(t.zone));
    if(matches.length === 0) return null;
    const pcts = matches.map(x => Number(x.pct)).filter(x => isFinite(x));
    if(pcts.length === 0) return null;
    const minPct = Math.min(...pcts);
    const maxPct = Math.max(...pcts);
    if(!isFinite(minPct) || !isFinite(maxPct) || maxPct <= 0) return null;

    let low = Math.round(p.price * (1 - maxPct/100));
    let high = Math.round(p.price * (1 - minPct/100));
    if(!isFinite(low) || !isFinite(high)) return null;
    if(low > high){ const tmp = low; low = high; high = tmp; }
    if(low < 0) low = 0;
    if(high < 0) high = 0;
    return { low, high, minPct, maxPct };
  } catch(e){
    return null;
  }
}
function getTierRangeText(p){
  const r = getTierDiscountRangeForProduct(p);
  if(!r) return "";
  if(r.low === r.high) return `${r.low.toLocaleString()}`;
  return `${r.low.toLocaleString()}â€“${r.high.toLocaleString()}`;
}

function createProductCard(p, highlightQuery) {
    const inCart = CART.find(x => x._id === p._id && !x.bundleSelection);
    const qty = inCart ? inCart.qty : 0;

// UI configurable badge names
const L_addon = getBadgeName('addon','åŠ åƒ¹è³¼');
const L_bogo  = getBadgeName('bogo','è²·ä¸€é€ä¸€');
const L_bundleSel = getBadgeName('bundle_select','å„ªæƒ çµ„åˆ');
const L_order = getBadgeName('order_discount','è¨‚å–®æŠ˜æ‰£');
const L_tier  = getBadgeName('tier','å¤šä»¶å„ªæƒ ');

    let badges = "";
    if(p.category.includes("åŠ åƒ¹è³¼")) badges += `<span class="badge bg-red promo-badge" data-promo="addon">${L_addon}</span>`;
    if(RULES.bogo.some(b => b.code === p.code)) badges += `<span class="badge bg-blue promo-badge" data-promo="bogo" data-code="${p.code}">${L_bogo}</span>`;
    if(p.name.includes("ä»»é¸")) badges += `<span class="badge bg-gold promo-badge" data-promo="bundle_select">${L_bundleSel}</span>`;
    (function(){
    const info = getTierBadgeInfoByCategory(p.category);
    if(!info) return;
    if(info.kind === 'order') badges += `<span class="badge bg-purple promo-badge" data-promo="order_discount" data-zone="${String(info.zone).replace(/"/g,'&quot;')}">${L_order}</span>`;
    else badges += `<span class="badge bg-purple promo-badge" data-promo="tier" data-zone="${String(info.zone).replace(/"/g,'&quot;')}">${L_tier}</span>`;
  })();
    let actionBtn = "";
    if(p.bundle.length >= 2 && p.name.includes("ä»»é¸")) {
      const hasSel = SELECTED_BUNDLE.has(p._id);
      actionBtn = `<div class="btn-bundle" onclick="openBundle(${p._id})">${hasSel ? "å…§å®¹å·²é¸ âœ“" : "é¸æ“‡å…§å®¹ç‰©"}</div>`;
    }
    let imgHtml = `<div class="p-no-img"><span class="material-icons-round" style="font-size:32px">image_not_supported</span>ç„¡åœ–ç‰‡</div>`;
    if(p.photo && p.photo.length > 5) {
      imgHtml = `<img src="${p.photo}" class="p-img" onload="this.classList.add('loaded')" onerror="this.style.display='none';this.parentElement.innerHTML='<div class=\'p-no-img\'>æš«ç„¡åœ–ç‰‡</div>'">`;
    }
    
    // RESTORED HIGHLIGHT LOGIC
    let displayName = p.name;
    if (highlightQuery) { displayName = highlightText(p.name, highlightQuery); }
    
    const card = document.createElement("div"); card.className = "p-card"; card.id = `p-${p._id}`;
    const pricePack = (function(){
      let priceHtml = '';
      let pillHtml = '';
      if(String(p.category||"").includes("åŠ åƒ¹è³¼")){
        const fr = getFlatPriceRule(p.code, p.category);
        const ap = (fr && fr.unit > 0) ? Number(fr.unit).toLocaleString() : "";
        priceHtml = '<span class="p-price strike">$' + p.price.toLocaleString() + '</span>';
        if(ap) pillHtml = '<span class="p-price-pill" data-promo="addon_price"><span class="pill-label">åŠ è³¼</span> <span class="pill-value">' + ap + '</span></span>';
        return { priceHtml, pillHtml };
      } else {
        // bundle (e.g., ç¾å®¹è¶…å€¼çµ„) show strike list + promo price
        const bundleRule = (RULES && Array.isArray(RULES.bundle)) ? RULES.bundle.find(r => r && r.code === p.code && isFinite(r.price) && r.price > 0) : null;
        if(bundleRule && isFinite(bundleRule.price) && bundleRule.price > 0) {
          const bp = Number(bundleRule.price).toLocaleString();
          priceHtml = '<span class="p-price strike">$' + p.price.toLocaleString() + '</span>';
          pillHtml = '<span class="p-price-pill" data-promo="bundle_price" data-code="' + p.code + '"><span class="pill-label">å„ªæƒ </span> <span class="pill-value">' + bp + '</span></span>';
          return { priceHtml, pillHtml };
        }
        const t = getTierRangeText(p);
        priceHtml = '<span class="p-price">$' + p.price.toLocaleString() + '</span>';
        if(t) pillHtml = '<span class="p-price-pill" data-promo="tier_range" data-zone="' + (function(){ const _i = getTierBadgeInfoByCategory(p.category); return _i ? String(_i.zone||"").replace(/"/g,'&quot;') : ''; })() + '"><span class="pill-label">æŠ˜å¾Œ</span> <span class="pill-value">' + t + '</span></span>';
        return { priceHtml, pillHtml };
      }
    })();
        const codeChipHtml = (p.code && String(p.code).trim()) ? `<div class="p-code-chip">${escapeHtml(p.code)}</div>` : '';
    const pillRowHtml = pricePack.pillHtml ? `<div class="p-pill-row">${pricePack.pillHtml}</div>` : '';

const newBadgeLabel = (function(){
  try{ return escapeHtml(getBadgeName('new', 'NEW')); }catch(e){ return 'NEW'; }
})();
const newBadgeHtml = (p.is_new) ? `<div class="new-badge">${newBadgeLabel}</div>` : '';
    card.innerHTML = `<div class="p-img-box"><div class="badges">${badges}</div>${imgHtml}${newBadgeHtml}</div><div class="p-body">${codeChipHtml}<div><div class="p-title">${displayName}</div><div class="p-price-row">${pricePack.priceHtml}</div>${pillRowHtml}${actionBtn}<div class="p-buy-row no-pill"><div class="stepper"><div class="s-btn ${qty===0?'hidden':''}" onclick="window.updateQty(this, ${p._id}, -1)">ï¼</div><div class="s-val ${qty===0?'hidden':''}">${qty}</div><div class="s-btn add" onclick="window.updateQty(this, ${p._id}, 1)">ï¼‹</div></div></div></div></div>`;
    return card;
}

window.openBundle = function(pid) {
  modalPid = pid;
  const p = PRODUCTS.find(x => x._id === pid);
  const grid = document.getElementById("mGrid");
  grid.innerHTML = "";
  tempBundleSelection = []; // RESET: Always start fresh
  updateModalUI();
  p.bundle.forEach((b, idx) => {
    const row = document.createElement("div");
    row.className = "m-row";
    row.dataset.idx = idx;
    row.innerHTML = `<div style="flex:1"><div class="m-name">${b.name}</div><div style="font-size:12px;color:#90a4ae">è¦æ ¼: ${b.qty}</div></div><div class="m-ctrl"><div class="m-btn-s minus">ï¼</div><div class="m-val">0</div><div class="m-btn-s plus">ï¼‹</div></div>`;
    row.querySelector(".minus").onclick = () => modifyTemp(idx, -1);
    row.querySelector(".plus").onclick = () => modifyTemp(idx, 1);
    grid.appendChild(row);
  });
  updateModalCounts();
  document.getElementById("bundleModal").classList.add("open");
};

function modifyTemp(idx, delta) {
  if (delta > 0) {
    if (tempBundleSelection.length < 2) tempBundleSelection.push(idx);
  } else {
    const i = tempBundleSelection.indexOf(idx);
    if (i > -1) tempBundleSelection.splice(i, 1);
  }
  updateModalUI();
  updateModalCounts();
}

function updateModalUI() {
  document.getElementById("mCount").innerText = tempBundleSelection.length;
  const btn = document.getElementById("mConfirmBtn");
  if (tempBundleSelection.length === 2) {
    btn.classList.remove("disabled");
    btn.innerText = "ç¢ºèªé¸å–";
  } else {
    btn.classList.add("disabled");
    btn.innerText = `é‚„å·® ${2 - tempBundleSelection.length} ä»¶`;
  }
}

function updateModalCounts() {
  const rows = document.getElementById("mGrid").children;
  Array.from(rows).forEach(row => {
    const idx = parseInt(row.dataset.idx);
    const count = tempBundleSelection.filter(x => x === idx).length;
    row.querySelector(".m-val").innerText = count;
    if(count > 0) row.style.borderColor = "var(--primary)";
    else row.style.borderColor = "#eceff1";
  });
}

// V22.2: Confirm Bundle creates a NEW cart item
window.confirmBundle = function() {
  if (tempBundleSelection.length !== 2) return;
  
  const p = PRODUCTS.find(x => x._id === modalPid);
  if(!p) return;
  
  // Clone product to create new cart item
  const cartItem = { 
    ...p, 
    qty: 1, 
    bundleSelection: [...tempBundleSelection], // Store selection
    cartId: Date.now() + Math.random() // Unique ID
  };
  
  // Check if EXACT same bundle exists? No, user wants separate usually. 
  // Or if same, increment? Let's check.
  const existing = CART.find(x => x._id === modalPid && JSON.stringify(x.bundleSelection) === JSON.stringify(tempBundleSelection));
  
  if(existing) {
      existing.qty += 1;
  } else {
      CART.push(cartItem);
  }

  saveState(); 
  refreshCart(); 
  renderList(); // Update buttons state
  
  // Show toast
  const addedToast = showToast("å·²åŠ å…¥è³¼ç‰©è»Š");
  setTimeout(() => {
      const data = calcCart();
      checkNewGifts(data.gifts); 
  }, 800);
  
  // Show fab
  const fab = document.getElementById("float-bar");
  fab.classList.remove("show");
  void fab.offsetWidth; 
  if(CART.length > 0) fab.classList.add("show");

  closeBundle();
};

window.closeBundle = function() { document.getElementById("bundleModal").classList.remove("open"); };

window.clearCart = function() {
  if(confirm("ç¢ºå®šè¦æ¸…ç©ºè³¼ç‰©è»Šå—ï¼Ÿ")) { 
    CART = []; 
    SELECTED_BUNDLE.clear(); 
    achievedGifts = []; // Reset gifts memory
    saveState(); 
    refreshCart(); 
    renderList(); 
    closeCart(); 
    showToast("è³¼ç‰©è»Šå·²æ¸…ç©º"); 
  }
};

// V24.0: In-Cart Feedback Update (Pulse & Celebrate)
window.updateCartItem = function(index, delta) {
    const item = CART[index];
    if(!item) return;
    
    // Feedback 1: Pulse Gift Icon
    const giftIcon = document.querySelector('.game-icon');
    if(giftIcon) {
        giftIcon.classList.remove('gift-pulse');
        void giftIcon.offsetWidth; 
        giftIcon.classList.add('gift-pulse');
    }

    item.qty += delta;
    if(item.qty <= 0) {
        CART.splice(index, 1);
    }
    
    // Enforce add-on eligibility after any cart change
    const removedAddon = enforceAddonEligibility();
    if(removedAddon > 0) {
        showToast("åŠ åƒ¹è³¼å•†å“å·²ç§»é™¤ï¼ˆæœªç¬¦åˆåŠ è³¼æ¢ä»¶ï¼‰", "warn");
    }

    saveState();
    const data = refreshCart(); // Refresh and get data
    
    // Feedback 2: Check for new gift unlock inside cart
    const currentGiftNames = data.gifts.map(g => g.name);
    const newUnlocks = currentGiftNames.filter(n => !achievedGifts.includes(n));
    if(newUnlocks.length > 0) {
        // Trigger Celebration in Cart
        if(giftIcon) {
            giftIcon.classList.add('gift-unlock-anim');
            setTimeout(()=>giftIcon.classList.remove('gift-unlock-anim'), 1000);
        }
        const msg = document.getElementById("gameMsg");
        const originalMsg = msg.innerText;
        msg.innerText = `ğŸ‰ æ­å–œï¼å·²ç²å¾—æ–°è´ˆå“`;
        msg.classList.add('success'); 
        
        // Also show Top Pill
        const notify = document.getElementById('top-notify');
        const txt = document.getElementById('tn-text');
        txt.innerText = `å·²ç²å¾— ${newUnlocks[newUnlocks.length-1]}!`;
        notify.classList.add('show');
        setTimeout(() => notify.classList.remove('show'), 3000);

        setTimeout(() => {
            msg.innerText = originalMsg; 
            msg.classList.remove('success');
            refreshCart(); 
        }, 2500);
        achievedGifts = currentGiftNames;
    }
    
    renderList(); 
}

function splitPrefixes(str){
  return String(str||"").split(/[&ï¼†|,ã€]/).map(s=>s.trim()).filter(Boolean);
}
function seriesGiftUnit(prefixStr){
  return /éº¥æ±/.test(String(prefixStr||"")) ? 'ç®±' : 'ä»¶';
}

function sumFinalByPrefixes(processedItems, prefixes){
  if(!prefixes || prefixes.length===0) return 0;
  let sum=0;
  processedItems.forEach(it=>{
    const cat = String(it.category||"");
    if(prefixes.some(p=>cat.includes(p))) sum += (Number(it.finalLine)||0);
  });
  return sum;
}
function sumQtyByPrefixes(cartItems, prefixes){
  if(!prefixes || prefixes.length===0) return 0;
  let q=0;
  cartItems.forEach(it=>{
    const cat = String(it.category||"");
    if(prefixes.some(p=>cat.includes(p))) q += (Number(it.qty)||0);
  });
  return q;
}

function calcCart() {
  let subTotal = 0, finalTotal = 0, beautyTotal = 0, discountAmt = 0;
  let warnings = [];
  let catCounts = {};
  CART.forEach(it => {
    const matchedRule = RULES.tiers.find(r => it.category.includes(r.zone));
    if(matchedRule) { const zone = matchedRule.zone; catCounts[zone] = (catCounts[zone] || 0) + it.qty; }
  });
  const processedItems = CART.map(it => {
    const originalLine = it.price * it.qty;
    subTotal += originalLine;
    let finalLine = originalLine;
    let tags = [];

    // Add-on (åŠ åƒ¹è³¼) uses flat_price override (do NOT apply tier/bogo/bundle)
    if(String(it.category||"").includes("åŠ åƒ¹è³¼")) {
      const fr = getFlatPriceRule(it.code, it.category);
      if(fr && fr.unit > 0) {
        finalLine = fr.unit * it.qty;
        tags.push({ text: `åŠ è³¼åƒ¹ ${Number(fr.unit).toLocaleString()}`, cls: "save" });
      }
      finalTotal += finalLine;
      if(it.category.includes("ç¾å®¹")) beautyTotal += finalLine;
      return { ...it, finalLine, tags };
    }

    const bundleRule = RULES.bundle.find(b => b.code === it.code);
    if(bundleRule && bundleRule.price < it.price) {
      finalLine = bundleRule.price * it.qty;
      tags.push({ text: `ç¾çœ $${((it.price - bundleRule.price) * it.qty).toLocaleString()}`, cls: "save" });
    } else {
      const matchedRule = RULES.tiers.find(r => it.category.includes(r.zone));
      if(matchedRule) {
         const zone = matchedRule.zone;
         const tierRules = RULES.tiers.filter(r => r.zone === zone).sort((a,b) => b.min - a.min);
         const tier = tierRules.find(t => catCounts[zone] >= t.min);
         if(tier) {
           finalLine = originalLine * ((100 - tier.pct) / 100);
           tags.push({ text: `å·²äº« ${fmtZheFromPctOff(tier.pct)}`, cls: "save" });
         }
      }
    }
    const bogo = RULES.bogo.find(b => b.code === it.code);
    if(bogo) {
      const set = bogo.buy + bogo.get;
      const free = Math.floor(it.qty/set) * bogo.get;
      finalLine -= free * it.price;
      if(free > 0) tags.push({ text: `è²·${bogo.buy}é€${bogo.get}`, cls: "save" });
      if(it.qty % set !== 0) {
        tags.push({ text: `æœªæ¹Šæ»¿å„ªæƒ  (å†é¸ ${set - (it.qty%set)} ä»¶)`, cls: "warn" });
        warnings.push(`${it.name}`);
      }
    }
    finalTotal += finalLine;
    if(it.category.includes("ç¾å®¹")) beautyTotal += finalLine;
    return { ...it, finalLine, tags };
  });
  discountAmt = subTotal - finalTotal;
  const gifts = [];
  // Spend-threshold gifts (supports zone_prefix with multi-prefix syntax: & ï¼† | ã€ ,)
  RULES.spend.forEach(r => {
    let basis = finalTotal;
    if(r.scope === "zone_prefix") {
      const prefixes = splitPrefixes(r.prefix);
      basis = prefixes.length ? sumFinalByPrefixes(processedItems, prefixes) : 0;
    }
    if(Number.isFinite(r.amt) && basis >= r.amt) {
      let qty = r.mult ? Math.floor(basis / r.amt) * r.qty : r.qty;
      if(qty > 0) {
        let gName = r.gift;
        if(PRODUCT_MAP.has(r.gift)) gName = PRODUCT_MAP.get(r.gift).name;
        gName = gName.replace(/^(è´ˆå“|è´ˆ|Gift)[:\s|ï½œ_]*/i, "");
        gifts.push({ name: gName, qty: qty, code: r.gift });
      }
    }
  });

  // Series gift: per-box / per-qty gift by zone_prefix (e.g., ä¿å¥é£²å“æ¯ç®±é€2æè¢‹)
  (RULES.series_gift || []).forEach(r => {
    if(r.scope !== "zone_prefix") return;
    const prefixes = splitPrefixes(r.prefix);
    if(!prefixes.length) return;

    const totalQty = sumQtyByPrefixes(CART, prefixes); // qty = ç®±æ•¸ï¼ˆè³¼ç‰©è»Šæ•¸é‡ï¼‰
    if(totalQty <= 0) return;

    let giftQty = 0;
    const thr = Number(r.amt);
    if(Number.isFinite(thr) && thr > 0) {
      const times = r.mult ? Math.floor(totalQty / thr) : (totalQty >= thr ? 1 : 0);
      giftQty = times * (Number(r.qty) || 0);
    } else {
      // è‹¥ threshold_amount ç©ºç™½ï¼šè¦–ç‚ºã€Œæ¯ç®±é€ gift_qtyã€
      giftQty = totalQty * (Number(r.qty) || 0);
    }

    if(giftQty > 0 && r.gift) {
      let gName = r.gift;
      if(PRODUCT_MAP.has(r.gift)) gName = PRODUCT_MAP.get(r.gift).name;
      gName = gName.replace(/^(è´ˆå“|è´ˆ|Gift)[:\s|ï½œ_]*/i, "");
      gifts.push({ name: gName, qty: giftQty, code: r.gift });
    }
  });

  return { items: processedItems, subTotal, finalTotal, discountAmt, beautyTotal, gifts, warnings };
}

function refreshCart() {
  const data = calcCart();
  const list = document.getElementById("cartList");
  list.innerHTML = "";
  document.querySelector(".fb-total").innerText = "$" + Math.round(data.finalTotal).toLocaleString();
  document.querySelector(".fb-count").innerText = CART.reduce((a,b)=>a+b.qty,0) + " ä»¶";
  
  data.items.forEach((it, index) => {
    let specStr = it.spec;
    if(it.bundleSelection) {
       if(it.bundle && it.bundle.length > 0) {
          const s = it.bundleSelection;
          const n1 = it.bundle[s[0]] ? it.bundle[s[0]].name : '?';
          const n2 = it.bundle[s[1]] ? it.bundle[s[1]].name : '?';
          specStr = `çµ„åˆï¼š${n1}ã€${n2}`;
       }
    } else if(it.bundle.length > 0) {
       specStr = it.bundle.map(b => `${b.name}x${b.qty}`).join("ã€");
    }

    const div = document.createElement("div"); div.className = "c-item";
    let tags = it.tags.map(t => `<span class="c-tag ${t.cls}">${t.text}</span>`).join("");
    
    // Price Display Fix: Old + New (Apply to BOGO too)
    let priceHtml = `$${Math.round(it.finalLine).toLocaleString()}`;
    if(it.finalLine < it.price * it.qty) {
        priceHtml = `<span class="c-old">$${(it.price*it.qty).toLocaleString()}</span> $${Math.round(it.finalLine).toLocaleString()}`;
    }
    
    div.innerHTML = `<div class="c-info"><div class="c-title">${it.name}</div><div class="c-spec">${specStr || ''}</div><div class="c-tags">${tags}</div><div class="c-price-box">${priceHtml}</div></div>
      <div class="c-ctrl"><div class="stepper"><div class="s-btn" onclick="window.updateCartItem(${index}, -1)">ï¼</div><div class="s-val">${it.qty}</div><div class="s-btn add" onclick="window.updateCartItem(${index}, 1)">ï¼‹</div></div></div>`;
    list.appendChild(div);
  });

  document.getElementById("sumBase").innerText = "$" + data.subTotal.toLocaleString();
  document.getElementById("sumDisc").innerText = "-$" + Math.round(data.discountAmt).toLocaleString();
  document.getElementById("sumPay").innerText = "$" + Math.round(data.finalTotal).toLocaleString();
  document.getElementById("sumBeauty").innerText = "$" + Math.round(data.beautyTotal).toLocaleString();
  const warnEl = document.getElementById("warnMsg");
  if(data.warnings.length > 0) { warnEl.style.display = "block"; warnEl.innerText = "âš ï¸ " + [...new Set(data.warnings)].join("ã€"); } else { warnEl.style.display = "none"; }
  
  const next = RULES.spend.find(r => r.scope === "all" && r.amt > data.finalTotal);
  if(next) {
    const diff = Math.max(0, (next.amt - data.finalTotal));
  const diffInt = Math.ceil(diff);
  document.getElementById("gameMsg").innerText = `åŠ æ²¹ï¼å† $${diffInt.toLocaleString()} è§£é–è´ˆå“`;
    document.getElementById("gameBar").style.width = ((data.finalTotal/next.amt)*100) + "%";
    document.getElementById("gameBar").classList.remove("full");
  } else {
    document.getElementById("gameMsg").innerText = "ğŸ‰ å¤ªæ£’äº†ï¼å·²è§£é–æ‰€æœ‰æ»¿é¡è´ˆå“";
    document.getElementById("gameBar").style.width = "100%";
    document.getElementById("gameBar").classList.add("full");
  }
  
  const finalList = document.getElementById("finalList");
  let sumHtml = "";
  data.items.forEach(i => sumHtml += `<div class="sum-line"><span>${i.name}</span><span>x${i.qty}</span></div>`);
  data.gifts.forEach(g => sumHtml += `<div class="sum-line" style="color:#e65100"><span>ğŸ ${g.name}</span><span>x${g.qty}</span></div>`);
  finalList.innerHTML = sumHtml; // V22.2 Fix: Ensure HTML is set

  // Updateå®…é…åˆ—å³å´å…é‹æç¤ºï¼ˆåƒ…åœ¨å±•é–‹æ™‚é¡¯ç¤ºï¼‰
  try { syncDeliveryHeaderUI(); } catch(e) {}

  return data;
}

window.openCart = () => { if(CART.length === 0) return; document.getElementById("drawer").classList.add("open"); document.getElementById("float-bar").classList.add("hidden"); isCartOpen = true; history.pushState({modal: 'cart'}, null, ""); };
window.closeCart = () => { document.getElementById("drawer").classList.remove("open"); document.getElementById("float-bar").classList.remove("hidden"); cleanupUI(); isCartOpen = false; if(history.state && history.state.modal === 'cart') history.back(); };

window.onpopstate = (e) => { 
    // CRITICAL FIX: Always ensure body is clean when returning to root state
    if (!document.querySelector('.modal.open') && 
        !document.getElementById('drawer').classList.contains('open') && 
        !document.getElementById('milestone-overlay').classList.contains('open') &&
        !isPromoMapOpen()) {
        cleanupUI();
    }

    // Handle Promo Map Drawer (å„ªæƒ åœ°åœ–)
    if(isPromoMapOpen()){
        closePromoMap({skipHistory:true});
        // keep guard so user doesn't leave app accidentally
        armBackGuard();
        return;
    }

    // V25 FIX 1: Handle Milestone using DOM state
    const msOverlay = document.getElementById('milestone-overlay');
    if(msOverlay.classList.contains('open')) {
        msOverlay.classList.remove('open');
        document.getElementById('gift-fab').style.display = 'flex'; // Ensure FAB returns
        if(!isCartOpen) cleanupUI();
        return;
    }

    // V25 FIX 3: Handle Gift Modal correctly
    const giftModal = document.getElementById("giftModal"); 
    if(giftModal.classList.contains("open")) { 
        giftModal.classList.remove("open"); 
        if(isCartOpen) {
             document.getElementById("drawer").classList.add("open");
             document.body.classList.add("modal-open");
        } else {
             cleanupUI();
        }
        return; 
    } 

    // Handle Receipt
    const rcModal = document.getElementById("receiptModal"); 
    if(rcModal.classList.contains("open")) { return; } 

    // Handle Cart Drawer
    if(isCartOpen) { 
        document.getElementById("drawer").classList.remove("open"); 
        document.getElementById("float-bar").classList.remove("hidden"); 
        cleanupUI(); // V26: Force Cleanup
        isCartOpen = false; 
        return;
    } 

    // Root-level back behavior (ä¸»å•†å“é ï¼šå…ˆç½®é ‚â†’å†æç¤ºâ†’å†é›¢é–‹)
    const st = history.state || null;
    if(st && st.page === 'guard') return;
    handleRootBack();
};
window.onbeforeunload = (e) => { if(CART.length > 0) return "è¨‚å–®å°šæœªé€å‡º"; };
document.getElementById("searchInp").addEventListener("input", renderList);

// OPTIMIZATION 2: Clear Search Logic
document.getElementById("clearSearch").addEventListener("click", () => {
    document.getElementById("searchInp").value = "";
    document.getElementById("clearSearch").style.display = 'none';
    renderList();
    document.getElementById("searchInp").focus();
});

window.toggleSum = () => { const b = document.getElementById("finalList"); const i = document.getElementById("sumIcon"); if(b.classList.contains("open")) { b.classList.remove("open"); i.innerText = "expand_more"; } else { b.classList.add("open"); i.innerText = "expand_less"; } };

// [NEW] åˆ‡æ›å®…é…è¡¨å–®é¡¯ç¤º
window.toggleDelivery = function() {
  const chk = document.getElementById("chkDelivery");
  const form = document.getElementById("deliveryForm");
  const btn = document.getElementById("btnDeliveryCollapse");
  const status = document.getElementById("deliveryStatusText");

  const isComplete = () => {
    const n = (document.getElementById("dName")?.value || "").trim();
    const p = (document.getElementById("dPhone")?.value || "").trim();
    const a = (document.getElementById("dAddr")?.value || "").trim();
    return !!(n && p && a);
  };

  const setStatus = (complete) => {
    if(!status) return;
    if(complete) {
      status.textContent = "(å·²å¡«å¦¥æ”¶ä»¶è³‡è¨Š)";
      status.style.color = "#2e7d32";
      status.style.fontWeight = "700";
    } else {
      status.textContent = "(è«‹å¡«å¯«æ”¶ä»¶è³‡è¨Š)";
      status.style.color = "#ef6c00";
      status.style.fontWeight = "400";
    }
  };

  if(chk.checked) {
    form.classList.add("show");
    if(btn) btn.style.display = "inline-flex";
    // è‡ªå‹•å¸¶å…¥è¨‚è³¼äººå§“ååˆ°æ”¶è²¨äºº (æ–¹ä¾¿ä½¿ç”¨è€…)
    const fName = document.getElementById("fName").value;
    if(fName && !document.getElementById("dName").value) {
        document.getElementById("dName").value = fName;
    }
    setStatus(isComplete());
  } else {
    // [Guard] è‹¥å®…é…å¿…å¡«æ¬„ä½å·²å¡«å¦¥ï¼Œé¿å…èª¤è§¸å–æ¶ˆå‹¾é¸ï¼ˆæ”¹ç‚ºå±•é–‹æª¢è¦–/ç·¨è¼¯ï¼Œä½†ä¿æŒå‹¾é¸ï¼‰
    if(isComplete()) {
      chk.checked = true;
      form.classList.add("show");
      if(btn) btn.style.display = "inline-flex";
      setStatus(true);
      return;
    }

    form.classList.remove("show");
    if(btn) btn.style.display = "none";
    setStatus(false);
  }
  try { syncDeliveryHeaderUI(); } catch(e) {}
};

// [NEW] å®…é…è¡¨å–®æ”¶åˆï¼ˆéœ€å…ˆå®Œæˆå¿…å¡«æ¬„ä½ï¼‰
window.collapseDelivery = function() {
  const chk = document.getElementById("chkDelivery");
  const form = document.getElementById("deliveryForm");
  const btn = document.getElementById("btnDeliveryCollapse");
  const status = document.getElementById("deliveryStatusText");

  const v = (id) => (document.getElementById(id)?.value || "").trim();
  const required = ["dName", "dPhone", "dAddr"];

  // åªåœ¨ã€Œå®…é…å·²å‹¾é¸ã€ä¸”è¡¨å–®å±•é–‹æ™‚æœ‰æ„ç¾©
  if(!chk || !chk.checked) return;

  // Reset error styles
  required.forEach(id => document.getElementById(id)?.classList.remove("input-error", "flash-anim"));

  let hasError = false;
  required.forEach(id => {
    if(!v(id)) {
      const el = document.getElementById(id);
      if(el) el.classList.add("input-error", "flash-anim");
      hasError = true;
    }
  });

  if(hasError) {
    showToast("è«‹å…ˆå¡«å¦¥æ”¶ä»¶è³‡è¨Šå†æ”¶åˆ", "warn");
    return;
  }

  // Collapse
  if(form) form.classList.remove("show");
  if(btn) btn.style.display = "none";

  // Update status text
  if(status) {
    status.textContent = "(å·²å¡«å¦¥æ”¶ä»¶è³‡è¨Š)";
    status.style.color = "#2e7d32";
    status.style.fontWeight = "700";
  }
  try { syncDeliveryHeaderUI(); } catch(e) {}
};


// [NEW] é˜²å‘†ï¼šè‹¥å®…é…å¿…å¡«æ¬„ä½å·²å¡«å¦¥ï¼ˆæˆ–ç€è¦½å™¨è‡ªå‹•å¸¶å…¥ï¼‰ï¼Œå‰‡ç¶­æŒå‹¾é¸èˆ‡å®Œæˆç‹€æ…‹
window.syncDeliveryUI = function(opts = { collapse: true }) {
  const chk = document.getElementById("chkDelivery");
  const form = document.getElementById("deliveryForm");
  const btn = document.getElementById("btnDeliveryCollapse");
  const status = document.getElementById("deliveryStatusText");
  if(!chk || !form || !status) return;

  const n = (document.getElementById("dName")?.value || "").trim();
  const p = (document.getElementById("dPhone")?.value || "").trim();
  const a = (document.getElementById("dAddr")?.value || "").trim();
  const complete = !!(n && p && a);

  if(complete) {
    chk.checked = true;
    status.textContent = "(å·²å¡«å¦¥æ”¶ä»¶è³‡è¨Š)";
    status.style.color = "#2e7d32";
    status.style.fontWeight = "700";

    if(opts && opts.collapse) {
      form.classList.remove("show");
      if(btn) btn.style.display = "none";
    }
  }
  try { syncDeliveryHeaderUI(); } catch(e) {}
};

// å…¼å®¹ç€è¦½å™¨ Autofillï¼šå»¶é²åŒæ­¥ä¸€æ¬¡ï¼Œä¸¦æ–¼ pageshow å†åŒæ­¥
setTimeout(() => window.syncDeliveryUI && window.syncDeliveryUI({ collapse: true }), 200);
window.addEventListener("pageshow", () => {
  setTimeout(() => window.syncDeliveryUI && window.syncDeliveryUI({ collapse: true }), 200);
});

window.submitOrder = () => {
    // V2 Sprint1: strict mode â€” if config isn't ready, don't allow submission
    if(!CONFIG_READY) {
        try { showInitBlockedToast(); } catch(e) { try { showToast('ç³»çµ±åˆå§‹åŒ–ä¸­â€¦è«‹ç¨å€™', 'info', 2800); } catch(e2) {} }return;
    }
const f = (id) => document.getElementById(id).value.trim(); 
    const nameEl = document.getElementById("fName");
    const deptEl = document.getElementById("fDept");

    // éŒ¯èª¤æç¤ºé‡ç½®
    nameEl.classList.remove("input-error", "flash-anim");
    deptEl.classList.remove("input-error", "flash-anim");
    const dInputs = ['dName', 'dPhone', 'dAddr'];
    dInputs.forEach(id => document.getElementById(id).classList.remove("input-error", "flash-anim"));

    void nameEl.offsetWidth; // Trigger reflow

    let hasError = false;
    // 1. åŸºæœ¬é©—è­‰
    if(!f("fName")) { nameEl.classList.add("input-error", "flash-anim"); hasError = true; }
    if(!f("fDept")) { deptEl.classList.add("input-error", "flash-anim"); hasError = true; }

    // [NEW] 2. å®…é…é©—è­‰
    const isDelivery = document.getElementById("chkDelivery").checked;
    let pickupInfo = null;

    if (isDelivery) {
        if(!f("dName")) { document.getElementById("dName").classList.add("input-error", "flash-anim"); hasError = true; }
        if(!f("dPhone")) { document.getElementById("dPhone").classList.add("input-error", "flash-anim"); hasError = true; }
        if(!f("dAddr")) { document.getElementById("dAddr").classList.add("input-error", "flash-anim"); hasError = true; }

        if (!hasError) {
            pickupInfo = {
                name: f("dName"),
                phone: f("dPhone"),
                address: f("dAddr"),
                note: f("dNote")
            };
        }
    }

    if(hasError) {
        showToast(isDelivery ? "è«‹å¡«å¯«å®Œæ•´è¨‚è³¼èˆ‡å®…é…è³‡è¨Š" : "è«‹å¡«å¯«å§“åèˆ‡éƒ¨é–€", "warn"); 
        return; 
    } 

    const data = calcCart(); 
    if(data.warnings.length > 0) { 
        const warnEl = document.getElementById("warnMsg"); 
        warnEl.scrollIntoView({ behavior: "smooth", block: "center" }); 
        warnEl.classList.remove("flash-anim"); void warnEl.offsetWidth; warnEl.classList.add("flash-anim"); 
        showToast("å°šæœ‰å„ªæƒ æœªæ¹Šæ»¿ï¼Œç„¡æ³•é€å‡ºï¼", "warn"); 
        return; 
    } 

    const btn = document.querySelector(".btn-submit"); 
    const originalText = btn.innerText; 
    btn.innerText = "è³‡æ–™å‚³é€ä¸­..."; 
    btn.disabled = true; 
    btn.style.opacity = "0.7"; 

    const allDiscountNotes = []; 

    // æº–å‚™å•†å“è³‡æ–™
    const itemsPayload = data.items.map(it => { 
        let spec = it.spec || ""; 
        let bundleSummary = ""; 

        if(it.bundleSelection) { 
            const s = it.bundleSelection; 
            spec = `[è‡ªé¸] ${it.bundle[s[0]]?.name} + ${it.bundle[s[1]]?.name}`; 
            bundleSummary = `${it.bundle[s[0]]?.name}|${it.bundle[s[1]]?.name}`; 
        } else { 
            if(it.bundle.length > 0) { 
                spec = "[" + it.bundle.map(b=>b.name).join("+") + "]"; 
                bundleSummary = it.bundle.map(b=>b.name).join("|"); 
            } 
        } 

        let chargeQty = it.qty, freeQty = 0; 
        const bogo = RULES.bogo.find(b => b.code === it.code); 
        if(bogo) { 
            const set = bogo.buy + bogo.get; 
            const sets = Math.floor(it.qty / set); 
            freeQty = sets * bogo.get; 
            chargeQty = it.qty - freeQty; 
        } 

        it.tags.forEach(t => { 
            if(t.cls === 'save') allDiscountNotes.push(`${it.name}: ${t.text}`); 
        }); 

        return { 
            product_code: it.code, 
            product_name: it.name, 
            spec: spec, 
            category: it.category, 
            unit_price: it.price, 
            qty: it.qty, 
            charge_qty: chargeQty, 
            free_qty: freeQty, 
            line_total: Math.round(it.finalLine), 
            bundle_summary: bundleSummary 
        }; 
    }); 

    // [Mod] æº–å‚™è´ˆå“è³‡æ–™ (åŒ…å«æ‹†è§£é‚è¼¯)
    const giftsPayload = data.gifts.map(g => {
        let bundleSummary = "";
        // æŸ¥æ‰¾è´ˆå“æ˜¯å¦æœ‰ bundle è¨­å®š (é‚è¼¯åŒç”¢å“åˆ—è¡¨)
        const p = PRODUCT_MAP.get(g.code);
        if (p && p.bundle && p.bundle.length > 0) {
            // å¦‚æœè´ˆå“æœ¬èº«æ˜¯çµ„åˆåŒ…ï¼Œè‡ªå‹•æ‹†è§£å…¶å…§å®¹ç‰©
            bundleSummary = p.bundle.map(b => b.name).join("|");
        }

        return { 
            product_code: g.code || "GIFT", 
            product_name: `[è´ˆå“] ${g.name}`, 
            qty: g.qty,
            bundle_summary: bundleSummary // å‚³çµ¦å¾Œç«¯å¯«å…¥ Content æ¬„ä½
        };
    }); 

    if(giftsPayload.length > 0) allDiscountNotes.push("å·²ç¬¦åˆæ»¿é¡è´ˆè³‡æ ¼"); 

    // çµ„åˆæœ€çµ‚ Payload
    lastOrderData = { 
        employee_name: f("fName"), 
        department: f("fDept"), 
        payment_method: f("fPay"), 
        remarks: f("fNote"), 
        totals: { 
            base: data.subTotal, 
            discount: Math.round(data.discountAmt), 
            pay: Math.round(data.finalTotal) 
        }, 
        discount_notes: allDiscountNotes, 
        items: itemsPayload, 
        gifts: giftsPayload,
        // [New] å®…é…èˆ‡å–è²¨è³‡è¨Š
        pickup_method: isDelivery ? 'å®…é…' : 'è‡ªå–',
        pickup_info: pickupInfo
    }; 

    fetch(GAS_URL, { 
        method: "POST", 
        headers: { "Content-Type": "application/x-www-form-urlencoded" }, 
        body: "payload=" + encodeURIComponent(JSON.stringify(lastOrderData)) 
    })
    .then(response => response.json())
    .then(res => { 
        if(res.ok) { 
            showToast("è¨‚å–®é€å‡ºæˆåŠŸï¼"); 
            openReceipt(res.order_id); 
        } else { 
            alert("è¨‚å–®é€å‡ºå¤±æ•—ï¼š" + (res.error || "æœªçŸ¥éŒ¯èª¤")); 
        } 
    })
    .catch(err => { 
        console.error(err); 
        alert("é€£ç·šç™¼ç”ŸéŒ¯èª¤"); 
    })
    .finally(() => { 
        btn.innerText = originalText; 
        btn.disabled = false; 
        btn.style.opacity = "1"; 
    }); 
};

function openReceipt(orderId) { const modal = document.getElementById("receiptModal"); const body = document.getElementById("rcBody"); document.getElementById("rcOrderId").innerText = `No. ${orderId}`; let html = ""; 

    // [New] æ”¶æ“šé¡¯ç¤ºå®…é…è³‡è¨Š
    if (lastOrderData.pickup_method === 'å®…é…' && lastOrderData.pickup_info) {
        html += `
        <div style="background:#fff3e0;padding:10px;margin-bottom:10px;border-radius:6px;font-size:13px;color:#e65100;">
            <b>ğŸšš å®…é…è³‡è¨Š</b><br>
            ${lastOrderData.pickup_info.name} / ${lastOrderData.pickup_info.phone}<br>
            ${lastOrderData.pickup_info.address}
        </div>`;
    }
 lastOrderData.items.forEach(it => { html += `<div class="rc-item"><div class="rc-name">${it.product_name}</div><div class="rc-meta"><span>${it.spec}</span><span>x${it.qty}</span><span>$${it.line_total}</span></div></div>`; }); if(lastOrderData.gifts.length > 0) { html += `<div class="rc-row bold" style="color:#e65100">æ»¿é¡è´ˆå“</div>`; lastOrderData.gifts.forEach(g => { html += `<div class="rc-item"><div class="rc-name" style="color:#e65100">ğŸ ${g.product_name}</div><div class="rc-meta"><span></span><span>x${g.qty}</span><span>å…è²»</span></div></div>`; }); } html += `<div class="rc-row bold"><span>ç¸½è¨ˆé‡‘é¡</span><span>$${lastOrderData.totals.pay}</span></div>`; body.innerHTML = html; modal.classList.add("open"); }
function closeReceipt() { document.getElementById("receiptModal").classList.remove("open"); CART = []; SELECTED_BUNDLE.clear(); achievedGifts = []; saveState(); refreshCart(); closeCart(); renderList(); document.getElementById("fNote").value = ""; lastOrderData = null; }
function toggleEmailInput() { const box = document.getElementById("emailBox"); box.classList.toggle("show"); if(box.classList.contains("show")) document.getElementById("rcEmail").focus(); }
function sendReceipt() { const email = document.getElementById("rcEmail").value.trim(); if(!email || !email.includes('@')) { showToast("è«‹è¼¸å…¥æœ‰æ•ˆçš„ Email", "warn"); return; } const btn = document.querySelector("#emailBox .btn-submit"); const orgTxt = btn.innerText; btn.innerText = "..."; btn.disabled = true; const payload = { action: 'send_email', email: email, order_id: document.getElementById("rcOrderId").innerText, order_data: lastOrderData }; fetch(GAS_URL, { method: "POST", headers: { "Content-Type": "application/x-www-form-urlencoded" }, body: "payload=" + encodeURIComponent(JSON.stringify(payload)) }).then(res => res.json()).then(res => { if(res.ok) { showToast("âœ… å·²å¯„é€è‡³ä¿¡ç®±"); toggleEmailInput(); } else { alert("å¯„é€å¤±æ•—"); } }).catch(err => alert("é€£ç·šéŒ¯èª¤")) .finally(() => { btn.innerText = orgTxt; btn.disabled = false; }); }

// Start
window.addEventListener('scroll', () => {
  const btn = document.getElementById('back-to-top');
  const scrollY = window.scrollY;
  if(scrollY > 300) btn.classList.add('show');
  else btn.classList.remove('show');

  if (scrollY < 50) {
    document.querySelectorAll(".cat-pill").forEach(pill => {
      pill.classList.toggle("active", pill.innerText === "ç†±éŠ·æ’è¡Œ");
    });
  }
});

// Remove Error State on Focus
document.querySelectorAll('input, select').forEach(input => {
    input.addEventListener('focus', function() {
        this.classList.remove('input-error', 'flash-anim');
    });
});

document.getElementById("searchInp").addEventListener("input", renderList);
window.onbeforeunload = (e) => { if(CART.length > 0) return "è¨‚å–®å°šæœªé€å‡º"; };

initApp();
try{ initBackGuard(); }catch(e){}

// --- V2.8.8: Click-to-explain for promo badges/pills (non-intrusive) ---
document.addEventListener('click', function promoHintClick(e){
  const el = e.target.closest('.promo-badge, .p-price-pill, #shipFreeBadge');
  if(!el) return;
  // prevent interfering with +/- buttons etc.
  if(e.target.closest('.s-btn')) return;

  // Shipping badge
  if(el.id === 'shipFreeBadge'){
    const total = Number(document.getElementById("sumPay")?.innerText?.replace('$','').replace(/,/g,'')) || 0;
    const thr = getFreeShipThreshold();
    if(!thr) return;
    if(total >= thr) return showPromoHint(`å…é‹é–€æª»ï¼šæ»¿ ${Math.round(thr).toLocaleString()} å…é‹ï¼ˆå·²é”æ¨™ï¼‰`);
    const diff = Math.max(0, Math.round(thr - total));
    return showPromoHint(`å…é‹é–€æª»ï¼šæ»¿ ${Math.round(thr).toLocaleString()} å…é‹ï¼›é‚„å·® ${diff.toLocaleString()}`);
  }

  const promo = el.dataset.promo || '';
  if(promo === 'bogo'){
    const code = el.dataset.code || '';
    const r = (RULES && Array.isArray(RULES.bogo)) ? RULES.bogo.find(x => x && x.code === code) : null;
    if(r) return showPromoHint(`${getBadgeName('bogo','è²·ä¸€é€ä¸€')}ï¼šè²·${Number(r.buy)||1}é€${Number(r.get)||1}`);
    return showPromoHint(`${getBadgeName('bogo','è²·ä¸€é€ä¸€')}ï¼šä¾æ´»å‹•è¦å‰‡`);
  }
  if(promo === 'tier' || promo === 'order_discount' || promo === 'tier_range'){
    // If el has zone, use it; else infer by current product category not available -> fallback by zone
    const zone = (el.dataset.zone || '').trim();
    let info = null;
    if(zone){
      const rules = (RULES && Array.isArray(RULES.tiers)) ? RULES.tiers.filter(t => t && String(t.zone)===zone && isFinite(t.pct) && t.pct>0).sort((a,b)=>Number(a.min)-Number(b.min)) : [];
      if(rules.length){
        info = (rules.length===1 && Number(rules[0].min)<=1) ? {kind:'order', zone, rules} : {kind:'tier', zone, rules};
      }
    }
    if(!info){
      // last resort: try to infer from currently opened modal product
      return;
    }
    return showPromoHint(buildTierHintText(info));
  }
  if(promo === 'bundle_select'){
    return showPromoHint(`${getBadgeName('bundle_select','å„ªæƒ çµ„åˆ')}ï¼šä¾å•†å“å…§å®¹ä»»é¸æ­é…`);
  }
  if(promo === 'bundle_price'){
    return showPromoHint('å„ªæƒ åƒ¹ï¼šä»¥æ´»å‹•è¨­å®šç‚ºæº–');
  }
  if(promo === 'addon' || promo === 'addon_price'){
    return showPromoHint('åŠ åƒ¹è³¼ï¼šéœ€å…ˆé¸è³¼æŒ‡å®šä¸»å•†å“å€å•†å“æ‰å¯åŠ è³¼');
  }
});


// --- V2.8.11: Category title click-to-explain (same as Promo Map hint) ---
document.addEventListener('click', function catTitleHintClick(e){
  const el = e.target.closest('.cat-section-title');
  if(!el) return;
  // ignore clicks when user is selecting text in inputs etc.
  if(e.target.closest('input, textarea, select')) return;
  const title = String(el.innerText||'').trim();
  if(!title) return;

const hint = buildPromoMapRowHint(title);
const tpl = uiGet('ui|cat_title_hint_tpl', uiGet('cat_title_hint_tpl',''));
if(hint){
  if(tpl){
    const msg = String(tpl)
      .replace(/\{cat\}/g, title)
      .replace(/\{hint\}/g, hint);
    return showPromoHint(msg || hint);
  }
  return showPromoHint(hint);
}
if(tpl){
  const msg = String(tpl).replace(/\{cat\}/g, title).replace(/\{hint\}/g, 'æœ¬åˆ†é¡ç›®å‰ç„¡å„ªæƒ è¨Šæ¯');
  return showPromoHint(msg || 'æœ¬åˆ†é¡ç›®å‰ç„¡å„ªæƒ è¨Šæ¯');
}
return showPromoHint('æœ¬åˆ†é¡ç›®å‰ç„¡å„ªæƒ è¨Šæ¯');
});

</script>

<!-- V2.8.9: Promo Map Drawer -->
<div id="promoMapOverlay" class="pm-overlay"></div>
<aside id="promoMapDrawer" class="pm-drawer" aria-hidden="true">
  <div class="pm-header">
    <div class="pm-head-left">
      <div class="pm-title">å„ªæƒ åœ°åœ–</div>
      <div class="pm-tabs" role="tablist" aria-label="å„ªæƒ åœ°åœ–åˆ‡æ›">
        <button type="button" class="pm-tab active" id="pmTabNav" data-tab="nav" role="tab" aria-selected="true">å„ªæƒ åˆ†é¡</button>
        <button type="button" class="pm-tab" id="pmTabGifts" data-tab="gifts" role="tab" aria-selected="false">è´ˆå“é–€æª»</button>
      </div>
    </div>
    <button type="button" class="pm-close" id="promoMapCloseBtn" aria-label="é—œé–‰">âœ•</button>
  </div>
  <div class="pm-body">
    <div id="promoMapPaneNav" class="pm-pane">
      <div class="pm-sub">é»æ“Šå¯å¿«é€Ÿè·³è½‰</div>
      <div id="promoMapList" class="pm-list"></div>
    </div>

    <div id="promoMapPaneGifts" class="pm-pane" style="display:none">
      <div class="pm-sub">æŸ¥çœ‹å„éšæ»¿é¡è´ˆå“</div>
      <div class="pm-scope" role="tablist" aria-label="è´ˆå“ç¯„åœ">
        <button type="button" class="pm-scope-btn active" data-scope="all" role="tab" aria-selected="true">å…¨å€</button>
        <button type="button" class="pm-scope-btn" data-scope="zone_prefix" role="tab" aria-selected="false">ç¾å®¹</button>
      </div>
      <div id="promoGiftList" class="pm-gift-list"></div>
    </div>
  </div>
</aside>

</body>
</html>
