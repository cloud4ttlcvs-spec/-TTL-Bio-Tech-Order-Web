<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover"/>
<title>ç”ŸæŠ€å±•è¨‚è³¼ç³»çµ± V29</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&family=Roboto:wght@500;700;900&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

<style>
/* --- æ ¸å¿ƒè®Šæ•¸å„ªåŒ–ï¼šç©ºé–“ç·Šç¸® --- */
:root {
  --primary: #00897b; --primary-light: #e0f2f1; --accent: #ff6f00; 
  --beauty: #d81b60; 
  --bg-body: #f8f9fa; --bg-card: #ffffff; --text-main: #263238; --text-sub: #546e7a;
  --border: #eceff1; 
  --header-height: 105px; /* V29: ç¸®æ¸›é«˜åº¦ */
  --shadow-card: 0 4px 20px rgba(0,0,0,0.04);
  --safe-bottom: env(safe-area-inset-bottom, 20px);
}
* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
body {
  font-family: 'Noto Sans TC', sans-serif; background: var(--bg-body); color: var(--text-main);
  margin: 0; padding: 0; 
  padding-bottom: calc(120px + var(--safe-bottom)); 
  overscroll-behavior-y: none;
}
body.modal-open { overflow: hidden; height: 100vh; position: fixed; width: 100%; }

/* --- å°è¦½åˆ—è³ªæ„Ÿå¼·åŒ–ï¼šæ¼¸å±¤é®ç½© --- */
.cat-wrap {
  position: relative;
  width: 100%;
  overflow: hidden;
  /* V29: å¢åŠ æ·¡å…¥æ·¡å‡ºè³ªæ„Ÿ */
  mask-image: linear-gradient(to right, transparent, black 10%, black 90%, transparent);
  -webkit-mask-image: linear-gradient(to right, transparent, black 10%, black 90%, transparent);
}
.cat-nav { 
  display: flex; gap: 8px; padding: 10px 20px; 
  overflow-x: auto; scrollbar-width: none; 
}
.cat-nav::-webkit-scrollbar { display: none; }
.cat-pill { 
  white-space: nowrap; padding: 7px 18px; border-radius: 24px; font-size: 14px; 
  font-weight: 500; color: var(--text-sub); background: #fff; border: 1px solid #e0e0e0; 
  cursor: pointer; transition: 0.25s;
}
.cat-pill.active { 
  background: var(--primary); color: #fff; border-color: var(--primary); 
  box-shadow: 0 4px 10px rgba(0,137,123,0.25); font-weight: 700; 
}

/* --- è³¼ç‰©è»Šåº•éƒ¨ç©ºé–“ç·Šç¸® --- */
.dr-foot { 
  padding: 12px 16px; /* ç·Šç¸®å…§è· */
  padding-bottom: calc(12px + var(--safe-bottom)); 
  background: #fff; border-top: 1px solid var(--border); 
  box-shadow: 0 -4px 20px rgba(0,0,0,0.05); flex-shrink: 0; 
}
.form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 10px; }
.form-grid input, .form-grid select { padding: 10px; border-radius: 10px; font-size: 14px; }
.btn-bar { display: flex; gap: 10px; margin-top: 12px; }

/* --- å…¶é¤˜æ¨£å¼ä¿ç•™ V28 é‚è¼¯ä¸¦å¾®èª¿ --- */
.p-card { background: #fff; border-radius: 16px; overflow: hidden; position: relative; box-shadow: var(--shadow-card); border: 1px solid #f0f0f0; display: flex; flex-direction: column; transition: transform 0.15s; scroll-margin-top: 130px; }
.p-img-box { width: 100%; aspect-ratio: 1/1; background: #fcfcfc; position: relative; display: flex; align-items: center; justify-content: center; overflow: hidden; }
.p-img-box img { width: 100%; height: 100%; object-fit: contain; transition: opacity 0.4s ease; opacity: 0; mix-blend-mode: multiply; }
.p-img-box img.loaded { opacity: 1; }
.p-body { padding: 12px; flex: 1; display: flex; flex-direction: column; justify-content: space-between; }
.p-title { font-size: 14px; font-weight: 700; line-height: 1.4; color: #37474f; height: 40px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
.stepper { display: flex; align-items: center; justify-content: flex-end; gap: 8px; margin-top: 8px; }
.s-btn { width: 30px; height: 30px; border-radius: 50%; border: 1px solid #eceff1; background: #fff; color: var(--primary); display: flex; align-items: center; justify-content: center; cursor: pointer; }
.s-btn.add { background: var(--primary); color: #fff; border-color: var(--primary); }
.s-btn.hidden, .s-val.hidden { display: none; }
.s-val { font-weight: 600; width: 20px; text-align: center; }

#float-bar { position: fixed; bottom: calc(20px + var(--safe-bottom)); left: 16px; right: 16px; background: #263238; color: #fff; border-radius: 60px; padding: 10px 10px 10px 24px; box-shadow: 0 15px 35px rgba(0,0,0,0.25); display: flex; align-items: center; justify-content: space-between; z-index: 2000; transition: 0.3s; transform: translateY(200%); }
#float-bar.show { transform: translateY(0); }
.fb-btn { background: var(--accent); color: #fff; padding: 10px 20px; border-radius: 40px; font-weight: 700; display: flex; align-items: center; gap: 6px; }

header { position: sticky; top: 0; z-index: 1000; background: rgba(255,255,255,0.98); backdrop-filter: blur(12px); box-shadow: 0 2px 10px rgba(0,0,0,0.03); }
.search-wrap { padding: 8px 16px 0 16px; }
.search-box { position: relative; }
.search-box input { width: 100%; padding: 10px 12px 10px 40px; border-radius: 12px; border: 1px solid #e0e0e0; background: #f5f7f9; }
.search-box .icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #90a4ae; }
.clear-btn { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); color: #cfd8dc; cursor: pointer; display: none; }

/* æ»¿é¡è´ˆå°å¡èˆ‡æ¸…å–® */
#gift-fab { position: fixed; bottom: calc(90px + var(--safe-bottom)); left: 20px; width: 50px; height: 50px; border-radius: 50%; background: #fff; border: 2px solid #ffd54f; display: flex; align-items: center; justify-content: center; z-index: 1090; display: none; }
.gift-item { display: flex; align-items: center; gap: 10px; padding: 10px; border-radius: 12px; border: 1px dashed #eee; margin-bottom: 8px; }
.gift-item.unlocked { background: #f1f8e9; border: 1px solid #c5e1a5; }
.g-thumb { width: 45px; height: 45px; object-fit: contain; background: #fff; border: 1px solid #eee; border-radius: 6px; }

/* æŠ½å±œæ¨£å¼ */
#drawer { position: fixed; inset: 0; z-index: 2100; pointer-events: none; }
#drawer-bg { position: absolute; inset: 0; background: rgba(0,0,0,0.5); opacity: 0; transition: 0.3s; pointer-events: none; }
#drawer-panel { position: absolute; top: 0; right: 0; bottom: 0; width: 100%; max-width: 450px; background: #fff; transform: translateX(100%); transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1); pointer-events: auto; display: flex; flex-direction: column; }
#drawer.open #drawer-bg { opacity: 1; pointer-events: auto; }
#drawer.open #drawer-panel { transform: translateX(0); }
.dr-head { padding: 16px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
.dr-body { flex: 1; overflow-y: auto; padding: 12px; background: #f8f9fa; }

/* å®…é…è¡¨å–® */
.delivery-toggle-wrap { background: #fff3e0; padding: 10px; border-radius: 10px; margin: 10px 0; border: 1px solid #ffe0b2; }
.delivery-form { display: none; flex-direction: column; gap: 8px; margin-top: 10px; padding-top: 10px; border-top: 1px dashed #ffcc80; }
.delivery-form.show { display: flex; }

/* éª¨æ¶å±èˆ‡ Modal */
.skeleton { background: #f0f0f0; border-radius: 16px; height: 250px; }
.modal { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 3000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
.modal.open { display: flex; }
.m-box { background: #fff; width: 90%; max-width: 400px; border-radius: 24px; padding: 20px; max-height: 80vh; overflow-y: auto; }

/* é€šç”¨å…ƒä»¶ */
.btn-submit { width: 100%; padding: 14px; background: #263238; color: #fff; border: none; border-radius: 12px; font-weight: 700; font-size: 16px; cursor: pointer; }
.toast-container { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%); z-index: 9999; }
.toast { background: rgba(0,0,0,0.8); color: #fff; padding: 10px 20px; border-radius: 20px; font-size: 14px; margin-bottom: 8px; }
</style>
</head>
<body>

<div id="loader">
  <div style="padding:20px; display:grid; grid-template-columns:1fr 1fr; gap:12px; width:100%; max-width:900px; margin:0 auto;">
    <div class="skeleton"></div><div class="skeleton"></div><div class="skeleton"></div><div class="skeleton"></div>
  </div>
</div>

<header>
  <div class="search-wrap">
    <div class="search-box">
      <span class="material-icons-round icon">search</span>
      <input id="searchInp" type="text" placeholder="æœå°‹å•†å“åç¨±æˆ–ç·¨è™Ÿ...">
      <span id="clearSearch" class="material-icons-round clear-btn">cancel</span>
    </div>
  </div>
  <div class="cat-wrap">
    <nav class="cat-nav" id="catNav"></nav>
  </div>
</header>

<main id="list"></main>

<div id="float-bar" onclick="openCart()">
  <div class="fb-info">
    <span class="fb-total" id="fb-total">$0</span>
    <span class="fb-count" id="fb-count">0 ä»¶å•†å“</span>
  </div>
  <div class="fb-btn">æŸ¥çœ‹è³¼ç‰©è»Š <span class="material-icons-round">arrow_forward</span></div>
</div>

<div id="drawer">
  <div id="drawer-bg" onclick="closeCart()"></div>
  <div id="drawer-panel">
    <div class="dr-head">
      <h2 style="margin:0; font-size:18px;">è³¼ç‰©è»Š</h2>
      <span class="material-icons-round" onclick="closeCart()" style="cursor:pointer;">close</span>
    </div>
    <div class="dr-body">
      <div id="cartList"></div>
      <div id="giftDisplay" style="margin-top:15px;"></div>
    </div>
    <div class="dr-foot">
      <div style="display:flex; justify-content:space-between; margin-bottom:5px; font-size:14px;">
        <span>å•†å“ç¸½è¨ˆ</span><span id="sumBase">$0</span>
      </div>
      <div style="display:flex; justify-content:space-between; margin-bottom:8px; color:var(--accent); font-weight:700;">
        <span>æŠ˜æ‰£å„ªæƒ </span><span id="sumDisc">-$0</span>
      </div>
      <div style="display:flex; justify-content:space-between; font-size:20px; font-weight:900; border-top:1px dashed #eee; padding-top:10px;">
        <span>æ‡‰ä»˜é‡‘é¡</span><span id="sumPay">$0</span>
      </div>

      <div class="delivery-toggle-wrap">
        <label style="display:flex; align-items:center; gap:8px; cursor:pointer; color:#e65100; font-weight:700;">
          <input type="checkbox" id="chkDelivery" onchange="toggleDelivery()"> éœ€å®…é…å¯„é€
        </label>
        <div id="deliveryForm" class="delivery-form">
          <input id="dName" placeholder="æ”¶ä»¶äººå§“å">
          <input id="dPhone" placeholder="æ”¶ä»¶äººé›»è©±">
          <input id="dAddr" placeholder="æ”¶ä»¶åœ°å€">
        </div>
      </div>

      <div class="form-grid">
        <input id="fName" placeholder="è¨‚è³¼äººå§“å">
        <input id="fDept" placeholder="éƒ¨é–€">
        <select id="fPay">
          <option value="ç¾é‡‘">ç¾é‡‘</option>
          <option value="ä¿¡ç”¨å¡">ä¿¡ç”¨å¡</option>
          <option value="è–ªè³‡æ‰£æ¬¾">è–ªè³‡æ‰£æ¬¾</option>
        </select>
      </div>
      <div class="btn-bar">
        <button class="btn-submit" onclick="submitOrder()">ç¢ºèªè¨‚è³¼</button>
      </div>
    </div>
  </div>
</div>

<script>
/* V29: ç§»é™¤ä»£ç†ï¼Œæ”¹ç”¨ç›´æ¥è®€å– + æ™‚é–“æˆ³è¨˜é˜²æ­¢å¿«å– */
const SHEET_P = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQBtV8q3Ank7Bnhs83IbOb97U46juV-RKeL3NpdFiNcSu-ifI21fQYo1-io62S3JIrXEO5MiDArc1Lr/pub?gid=1623055155&single=true&output=csv";
const SHEET_R = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQU95r9_TOPlQXY-lcBS_RH3tRc0mtRyuazxHHWljpRusbzBiWsEfm3Pa_HZmKW5Ob5TOq4W5O-vumI/pub?gid=2071879068&single=true&output=csv";
const GAS_URL = "https://script.google.com/macros/s/AKfycbxQ9Etloak3ZNv6yfyMCK9KbjoLyDqjRQHHVlASY5iMwwy_c4NCPxWpMK1YkzSXstHN/exec";

let PRODUCTS = [], RULES = { tiers: [], bogo: [], spend: [] }, CART = [];
let PRODUCT_MAP = new Map(), GIFT_MAP = new Map();
let categories = [];

async function initApp() {
  try {
    const timestamp = Date.now();
    // V29: ç›´æ¥è®€å–
    const [pRes, rRes] = await Promise.all([
      fetch(`${SHEET_P}&t=${timestamp}`).then(r => r.text()),
      fetch(`${SHEET_R}&t=${timestamp}`).then(r => r.text())
    ]);

    const pData = Papa.parse(pRes, { header: true, skipEmptyLines: true }).data;
    PRODUCTS = pData.map((row, i) => {
      const code = row.product_code || row.ç·¨è™Ÿ;
      const name = row.product_name || row.å“å;
      const isGift = (row.is_gift || "").toLowerCase();
      
      // æ¡é›†è´ˆå“åœ–ç‰‡é‚è¼¯å„ªåŒ–
      const img1 = row.photos_url || row['Photos url'] || "";
      const imgs = [img1, row['Photos url 2'], row['Photos url 3']].filter(u => u && u.length > 5);
      if(imgs.length > 0) GIFT_MAP.set(code, imgs);

      if(!code || !name) return null;
      if(isGift === 'true' || isGift === 'æ˜¯') return null;

      const p = {
        _id: i, code, name, category: row.category || "å…¶å®ƒ",
        price: Number((row.list_price || "0").replace(/,/g, '')),
        photo: img1, spec: row.spec || ""
      };
      PRODUCT_MAP.set(code, p);
      return p;
    }).filter(x => x);

    const rData = Papa.parse(rRes, { header: true, skipEmptyLines: true }).data;
    rData.forEach(row => {
      const type = (row.rule_type || "").toLowerCase();
      if(type.includes("tier")) RULES.tiers.push({ zone: row.zone, min: Number(row.min_qty), pct: Number(row.percent_off) });
      if(type.includes("spend")) RULES.spend.push({ scope: row.threshold_scope, amt: Number(row.threshold_amount), gift: row.gift_code, qty: Number(row.gift_qty) });
    });

    categories = [...new Set(PRODUCTS.map(p => p.category))];
    renderUI();
    document.getElementById("loader").style.display = "none";
  } catch(e) {
    alert("å•†å“è®€å–å¤±æ•—ï¼Œè«‹ç¢ºèªç¶²è·¯é€£ç·šæˆ–ç¨å¾Œå†è©¦ã€‚");
    console.error(e);
  }
}

function renderUI() {
  const nav = document.getElementById("catNav");
  nav.innerHTML = '<div class="cat-pill active" onclick="filterCat(\'all\')">å…¨éƒ¨å•†å“</div>';
  categories.forEach(cat => {
    nav.innerHTML += `<div class="cat-pill" onclick="filterCat('${cat}')">${cat}</div>`;
  });
  renderList();
}

function renderList(cat = 'all') {
  const grid = document.getElementById("list");
  grid.innerHTML = "";
  const filtered = cat === 'all' ? PRODUCTS : PRODUCTS.filter(p => p.category === cat);
  
  const layout = document.createElement("div");
  layout.className = "grid-layout";
  
  filtered.forEach(p => {
    const item = CART.find(c => c.code === p.code);
    const qty = item ? item.qty : 0;
    const card = document.createElement("div");
    card.className = "p-card";
    card.id = `p-${p._id}`;
    card.innerHTML = `
      <div class="p-img-box">
        <img src="${p.photo}" class="${p.photo ? '' : 'hidden'}" onload="this.classList.add('loaded')">
      </div>
      <div class="p-body">
        <div class="p-title">${p.name}</div>
        <div style="font-size:12px; color:#90a4ae;">${p.code}</div>
        <div style="margin-top:auto;">
          <div style="font-weight:900; font-size:16px;">$${p.price.toLocaleString()}</div>
          <div class="stepper">
            <div class="s-btn ${qty===0?'hidden':''}" onclick="updateQty('${p.code}', -1)">ï¼</div>
            <div class="s-val ${qty===0?'hidden':''}">${qty}</div>
            <div class="s-btn add" onclick="updateQty('${p.code}', 1)">ï¼‹</div>
          </div>
        </div>
      </div>
    `;
    layout.appendChild(card);
  });
  grid.appendChild(layout);
}

function updateQty(code, delta) {
  const p = PRODUCT_MAP.get(code);
  let item = CART.find(c => c.code === code);
  if(item) {
    item.qty += delta;
    if(item.qty <= 0) CART = CART.filter(c => c.code !== code);
  } else if(delta > 0) {
    CART.push({ ...p, qty: 1 });
  }
  refreshCart();
  renderList(document.querySelector(".cat-pill.active").innerText);
}

function refreshCart() {
  const data = calcCart();
  const list = document.getElementById("cartList");
  list.innerHTML = "";
  
  CART.forEach(item => {
    list.innerHTML += `
      <div style="display:flex; justify-content:space-between; align-items:center; background:#fff; padding:10px; border-radius:10px; margin-bottom:8px;">
        <div>
          <div style="font-size:14px; font-weight:700;">${item.name}</div>
          <div style="font-size:12px; color:#90a4ae;">$${item.price} x ${item.qty}</div>
        </div>
        <div class="stepper">
          <div class="s-btn" onclick="updateQty('${item.code}', -1)">ï¼</div>
          <div class="s-val">${item.qty}</div>
          <div class="s-btn add" onclick="updateQty('${item.code}', 1)">ï¼‹</div>
        </div>
      </div>
    `;
  });

  document.getElementById("sumBase").innerText = `$${data.base.toLocaleString()}`;
  document.getElementById("sumDisc").innerText = `-$${data.disc.toLocaleString()}`;
  document.getElementById("sumPay").innerText = `$${data.pay.toLocaleString()}`;
  document.getElementById("fb-total").innerText = `$${data.pay.toLocaleString()}`;
  document.getElementById("fb-count").innerText = `${CART.reduce((a,b)=>a+b.qty,0)} ä»¶å•†å“`;
  
  const bar = document.getElementById("float-bar");
  if(CART.length > 0) bar.classList.add("show");
  else bar.classList.remove("show");

  // æ¸²æŸ“è´ˆå“
  const gd = document.getElementById("giftDisplay");
  gd.innerHTML = "";
  data.gifts.forEach(g => {
    const imgs = GIFT_MAP.get(g.code) || [];
    const imgHtml = imgs.length > 0 ? `<img src="${imgs[0]}" class="g-thumb">` : `<div class="g-thumb" style="display:flex;align-items:center;justify-content:center;">ğŸ</div>`;
    gd.innerHTML += `
      <div class="gift-item unlocked">
        ${imgHtml}
        <div>
          <div style="font-size:12px; color:#e65100; font-weight:700;">æ»¿é¡è´ˆ</div>
          <div style="font-size:14px;">${g.name} x ${g.qty}</div>
        </div>
      </div>
    `;
  });
}

function calcCart() {
  let base = 0, pay = 0, beautyTotal = 0;
  CART.forEach(item => {
    base += item.price * item.qty;
    let lineTotal = item.price * item.qty;
    // ç°¡æ˜“æŠ˜æ‰£é‚è¼¯ç¯„ä¾‹
    RULES.tiers.forEach(r => {
      if(item.category === r.zone && item.qty >= r.min) lineTotal *= (r.pct/100);
    });
    pay += lineTotal;
    if(item.category.includes("ç¾å®¹")) beautyTotal += lineTotal;
  });

  const gifts = [];
  RULES.spend.forEach(r => {
    if(r.scope === 'all' && pay >= r.amt) {
      const g = PRODUCT_MAP.get(r.gift) || { name: r.gift };
      gifts.push({ code: r.gift, name: g.name, qty: r.qty });
    }
  });

  return { base, pay, disc: base - pay, gifts };
}

function openCart() { document.getElementById("drawer").classList.add("open"); document.body.classList.add("modal-open"); }
function closeCart() { document.getElementById("drawer").classList.remove("open"); document.body.classList.remove("modal-open"); }
function filterCat(cat) {
  document.querySelectorAll(".cat-pill").forEach(p => p.classList.remove("active"));
  event.target.classList.add("active");
  renderList(cat);
}
function toggleDelivery() { document.getElementById("deliveryForm").classList.toggle("show"); }

async function submitOrder() {
  const btn = document.querySelector(".btn-submit");
  const fName = document.getElementById("fName").value;
  if(!fName) { alert("è«‹å¡«å¯«è¨‚è³¼äººå§“å"); return; }
  
  btn.disabled = true;
  btn.innerText = "è¨‚å–®å‚³é€ä¸­...";
  
  const data = calcCart();
  const payload = {
    employee_name: fName,
    department: document.getElementById("fDept").value,
    items: CART,
    gifts: data.gifts,
    total_pay: data.pay
  };

  try {
    const res = await fetch(GAS_URL, {
      method: "POST",
      body: JSON.stringify(payload)
    }).then(r => r.json());
    if(res.ok) {
      alert("è¨‚è³¼æˆåŠŸï¼è¨‚å–®ç·¨è™Ÿï¼š" + res.order_id);
      CART = [];
      refreshCart();
      closeCart();
    }
  } catch(e) {
    alert("å‚³é€å¤±æ•—ï¼Œè«‹æˆªåœ–è³¼ç‰©è»Šä¸¦è¯çµ¡ç®¡ç†å“¡ã€‚");
  } finally {
    btn.disabled = false;
    btn.innerText = "ç¢ºèªè¨‚è³¼";
  }
}

initApp();
</script>
</body>
</html>