<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
<title>TTL BIO-TECH æˆ°æƒ…ä¸­å¿ƒ V96 (Auto)</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&family=Roboto:wght@500;700;900&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

<style>
/* --- Theme Variables --- */
:root {
  --primary: #00897b; --accent: #ff6f00;
  --bg-body: #f4f6f8; --text-main: #263238; --text-sub: #546e7a;
  --danger: #d32f2f; --warning: #f57c00; --success: #388e3c;
  --info: #0288d1; --stagnant: #7b1fa2;
  --header-height: 55px; --sidebar-width: 220px;
}
* { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
body { margin: 0; font-family: 'Roboto', 'Noto Sans TC', sans-serif; background: var(--bg-body); color: var(--text-main); font-size: 14px; overflow: hidden; height: 100vh; display: flex; flex-direction: column; }

/* Login Modal */
.modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(38,50,56,0.9); z-index: 9999; display: flex; justify-content: center; align-items: center; backdrop-filter: blur(5px); transition: opacity 0.3s; }
.modal-overlay.hidden { opacity: 0; pointer-events: none; }
.login-box { background: #fff; padding: 30px; border-radius: 12px; width: 300px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.3); transform: translateY(0); transition: transform 0.3s; }
.modal-overlay.hidden .login-box { transform: translateY(-20px); }
.login-box h2 { margin: 0 0 20px; color: var(--primary); font-weight: 900; letter-spacing: 1px; }
.login-input { width: 100%; padding: 12px; border: 2px solid #eceff1; border-radius: 8px; font-size: 16px; margin-bottom: 20px; text-align: center; transition: 0.2s; }
.login-input:focus { border-color: var(--primary); }
.login-btn { width: 100%; padding: 12px; background: var(--primary); color: #fff; border: none; border-radius: 8px; font-size: 16px; font-weight: 700; cursor: pointer; transition: 0.2s; }
.login-btn:hover { background: #00796b; transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0,137,123,0.3); }

/* Layout */
header { height: var(--header-height); background: #fff; display: flex; align-items: center; padding: 0 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); z-index: 100; justify-content: space-between; }
.brand { font-size: 18px; font-weight: 900; color: var(--primary); display: flex; align-items: center; gap: 8px; }
.header-right { display: flex; align-items: center; gap: 15px; }

/* Auto Refresh Toggle */
.auto-refresh-wrapper { display: flex; align-items: center; gap: 8px; font-size: 13px; font-weight: 500; color: var(--text-sub); background: #f0f2f5; padding: 6px 12px; border-radius: 20px; }
.refresh-spin { animation: spin 1s linear infinite; display: none; color: var(--primary); }
.refresh-spin.active { display: block; }
@keyframes spin { 100% { transform: rotate(360deg); } }
.switch { position: relative; display: inline-block; width: 34px; height: 18px; }
.switch input { opacity: 0; width: 0; height: 0; }
.slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 18px; }
.slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%; }
input:checked + .slider { background-color: var(--primary); }
input:checked + .slider:before { transform: translateX(16px); }

.logout-btn { color: var(--text-sub); cursor: pointer; font-size: 20px; transition: 0.2s; }
.logout-btn:hover { color: var(--danger); }

.main-container { display: flex; flex: 1; overflow: hidden; }
.sidebar { width: var(--sidebar-width); background: #263238; color: #fff; display: flex; flex-direction: column; padding-top: 20px; transition: width 0.3s; }
.nav-item { padding: 15px 25px; cursor: pointer; color: #b0bec5; display: flex; align-items: center; gap: 12px; transition: 0.2s; font-weight: 500; }
.nav-item:hover { background: rgba(255,255,255,0.05); color: #fff; }
.nav-item.active { color: var(--accent); background: rgba(255,255,255,0.1); border-right: 3px solid var(--accent); }
.content { flex: 1; overflow-y: auto; padding: 20px; position: relative; }

/* Dashboard Cards */
.dash-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 25px; }
.card { background: #fff; border-radius: 10px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.03); display: flex; flex-direction: column; position: relative; overflow: hidden; }
.card-val { font-size: 28px; font-weight: 900; color: var(--text-main); margin: 5px 0; }
.card-label { font-size: 13px; color: var(--text-sub); font-weight: 500; }
.card-icon { position: absolute; right: -10px; bottom: -10px; font-size: 80px; color: rgba(0,0,0,0.03); transform: rotate(-15deg); }
.trend { font-size: 12px; display: flex; align-items: center; gap: 4px; margin-top: auto; font-weight: 700; }
.trend.up { color: var(--success); } .trend.down { color: var(--danger); }

/* Tables */
.panel { background: #fff; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.03); overflow: hidden; display: flex; flex-direction: column; height: 100%; max-height: calc(100vh - 120px); }
.panel-head { padding: 15px 20px; border-bottom: 1px solid #eceff1; display: flex; justify-content: space-between; align-items: center; }
.panel-title { font-size: 16px; font-weight: 700; color: var(--text-main); display: flex; align-items: center; gap: 8px; }
.table-wrap { flex: 1; overflow: auto; }
table { width: 100%; border-collapse: collapse; white-space: nowrap; }
th { position: sticky; top: 0; background: #fafafa; padding: 12px 15px; text-align: left; font-size: 13px; color: var(--text-sub); font-weight: 700; border-bottom: 2px solid #eceff1; z-index: 10; cursor: pointer; user-select: none; }
th:hover { background: #f0f0f0; color: var(--primary); }
td { padding: 12px 15px; border-bottom: 1px solid #f0f0f0; font-size: 14px; color: var(--text-main); }
tr:hover { background: #f9fafb; }
.status-pill { padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: 700; }
.st-ok { background: #e8f5e9; color: #2e7d32; }
.st-low { background: #fff3e0; color: #ef6c00; }
.st-out { background: #ffebee; color: #c62828; }

/* Filter & Action */
.action-bar { display: flex; gap: 10px; }
.search-box { background: #f4f6f8; border: 1px solid #eceff1; padding: 6px 12px; border-radius: 6px; font-size: 14px; width: 200px; transition: 0.2s; }
.search-box:focus { background: #fff; border-color: var(--primary); width: 240px; }
.filter-btn { width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 6px; cursor: pointer; color: var(--text-sub); background: #f4f6f8; position: relative; }
.filter-btn:hover { background: #eceff1; color: var(--primary); }
.filter-btn.active { background: var(--primary); color: #fff; }

/* Filter Sheet */
.filter-sheet { position: absolute; top: 50px; right: 20px; background: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 5px 20px rgba(0,0,0,0.15); z-index: 200; width: 220px; display: none; transform-origin: top right; animation: scaleIn 0.2s; }
.filter-sheet.open { display: block; }
.filter-opt { display: flex; flex-direction: column; gap: 8px; max-height: 300px; overflow-y: auto; }
.filter-row { display: flex; align-items: center; gap: 10px; font-size: 14px; cursor: pointer; padding: 4px 0; }
@keyframes scaleIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }

/* Modals */
.info-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1100; display: none; justify-content: center; align-items: center; opacity: 0; transition: opacity 0.3s; }
.info-modal.open { display: flex; opacity: 1; }
.info-box { background: #fff; width: 500px; max-width: 90%; max-height: 80vh; border-radius: 12px; overflow: hidden; display: flex; flex-direction: column; box-shadow: 0 10px 40px rgba(0,0,0,0.2); transform: translateY(20px); transition: transform 0.3s; }
.info-modal.open .info-box { transform: translateY(0); }
.info-head { padding: 15px 20px; background: var(--primary); color: #fff; font-weight: 700; display: flex; justify-content: space-between; align-items: center; }
.info-body { padding: 20px; overflow-y: auto; font-size: 14px; line-height: 1.6; }
.info-close { cursor: pointer; }
.info-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px dashed #eee; }
.info-row:last-child { border: none; }
.act-btn { cursor: pointer; margin: 0 4px; color: var(--text-sub); font-size: 18px; }
.act-btn:hover { color: var(--primary); }

/* Loading */
.loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #fff; z-index: 2000; display: flex; flex-direction: column; justify-content: center; align-items: center; transition: opacity 0.5s; pointer-events: none; opacity: 0; }
.loading-overlay.show { opacity: 1; pointer-events: all; }
.spinner { width: 40px; height: 40px; border: 4px solid #eceff1; border-top-color: var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; }
.loading-text { margin-top: 15px; font-weight: 700; color: var(--text-sub); }

/* Edit Inputs */
.edit-input { width: 100%; padding: 6px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; }
.info-section-title { font-weight: 700; color: var(--primary); margin-top: 15px; margin-bottom: 5px; border-left: 3px solid var(--primary); padding-left: 8px; }

/* Responsive */
@media(max-width: 768px) {
  .sidebar { position: absolute; left: -220px; height: 100%; z-index: 500; }
  .sidebar.open { left: 0; box-shadow: 5px 0 20px rgba(0,0,0,0.1); }
  .menu-btn { display: block !important; margin-right: 15px; }
  .card-val { font-size: 24px; }
  .dash-grid { grid-template-columns: 1fr; }
}
.menu-btn { display: none; cursor: pointer; color: var(--text-main); }
</style>
</head>
<body>

<div id="loader" class="loading-overlay show">
  <div class="spinner"></div>
  <div class="loading-text" id="loadText">ç³»çµ±åˆå§‹åŒ–ä¸­...</div>
</div>

<div id="loginModal" class="modal-overlay">
  <div class="login-box">
    <h2>TTL æˆ°æƒ…ä¸­å¿ƒ</h2>
    <input type="password" id="pwdInput" class="login-input" placeholder="è«‹è¼¸å…¥ç®¡ç†å¯†ç¢¼">
    <button class="login-btn" onclick="checkAuth()">ç™»å…¥ç³»çµ±</button>
  </div>
</div>

<header>
  <div class="brand">
    <span class="material-icons-round menu-btn" onclick="toggleSidebar()">menu</span>
    <span class="material-icons-round">analytics</span> TTL BIO-TECH
  </div>
  <div class="header-right">
    <div class="auto-refresh-wrapper">
        <span class="material-icons-round refresh-spin" id="refreshIcon">sync</span>
        <span>è‡ªå‹•æ›´æ–° (30s)</span>
        <label class="switch">
            <input type="checkbox" id="autoRefreshToggle" onchange="toggleAutoRefresh()">
            <span class="slider"></span>
        </label>
    </div>
    <span class="material-icons-round logout-btn" onclick="logout()" title="ç™»å‡º">logout</span>
  </div>
</header>

<div class="main-container">
  <div class="sidebar" id="sidebar">
    <div class="nav-item active" onclick="switchTab('dashboard')"><span class="material-icons-round">dashboard</span> ç‡Ÿé‹ç¸½è¦½</div>
    <div class="nav-item" onclick="switchTab('orders')"><span class="material-icons-round">receipt_long</span> è¨‚å–®ç®¡ç†</div>
    <div class="nav-item" onclick="switchTab('inventory')"><span class="material-icons-round">inventory_2</span> åº«å­˜ç›£æ§</div>
    <div class="nav-item" onclick="switchTab('sales')"><span class="material-icons-round">trending_up</span> éŠ·å”®åˆ†æ</div>
  </div>
  
  <div class="content" id="mainContent">
    </div>
</div>

<div id="infoModal" class="info-modal" onclick="if(event.target===this)closeModal()">
  <div class="info-box">
    <div class="info-head"><span id="info-title">è¨‚å–®è©³æƒ…</span><span class="material-icons-round info-close" onclick="closeModal()">close</span></div>
    <div class="info-body" id="info-body"></div>
    <div style="padding:15px; border-top:1px solid #eee; text-align:right; background:#f9f9f9;" id="modal-footer">
        <button class="login-btn" style="width:auto; padding:8px 20px; background:#546e7a" onclick="closeModal()">é—œé–‰</button>
    </div>
  </div>
</div>

<div id="sortOverlay" style="position:fixed;top:0;left:0;width:100%;height:100%;z-index:190;display:none" onclick="closeFilterSheet()"></div>
<div id="filterSheet" class="filter-sheet">
    <div style="font-weight:700;margin-bottom:10px;color:var(--text-sub)">ç¯©é¸ç‹€æ…‹</div>
    <div class="filter-opt" id="filterOptions"></div>
    <button class="login-btn" style="margin-top:10px;padding:8px" onclick="applyFilter()">å¥—ç”¨</button>
</div>

<script>
/* ================= CONFIG ================= */
const GAS_URL = "https://script.google.com/macros/s/AKfycbzQy4y2t2O0dO6-yqKjKOKJ7TbT69E4N7_uvZtK4XJ9-9XQ35e-X2O7tEizG9Xl6J4/exec";
// CSV Sources
const ORDERS_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRIGbs4rMOfytnlajoBKcTZ5a0HhozeDAb2HMmsHsfUzfzrE0_O_y0QhhXD_SQjiwjoDKV_BJWoJwyp/pub?output=csv";
const INVENTORY_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ581142644042.../pub?output=csv"; // è«‹å¡«å…¥æ­£ç¢ºçš„åº«å­˜ CSV é€£çµï¼Œè‹¥ç„¡å‰‡ç•™ç©ºæˆ–è¨»è§£
const SALES_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ93142219.../pub?output=csv"; // è«‹å¡«å…¥æ­£ç¢ºçš„éŠ·å”® CSV é€£çµ
const SHEET_P_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQBtV8q3Ank7Bnhs83IbOb97U46juV-RKeL3NpdFiNcSu-ifI21fQYo1-io62S3JIrXEO5MiDArc1Lr/pub?gid=1623055155&single=true&output=csv";

// Password & Storage
let ADMIN_TOKEN = "phoebe0130";
const STORAGE_KEY = "ttl_admin_token"; // ç”¨æ–¼ localStorage

/* ================= STATE ================= */
let CURRENT_TAB = 'dashboard';
let DATA = { orders: [], inventory: [], sales: [], soldMap: {} };
let SORT = { key: 'id', asc: false };
let ALL_STATUSES = ["æ­£å¸¸", "ä½åº«å­˜", "ç¼ºè²¨", "è£œè²¨ä¸­"];
let SELECTED_STATUSES = new Set();
let PRODUCT_BUNDLE_MAP = new Map();
let currentEditOrder = null;

// Auto Refresh State
let refreshTimer = null;
let isAutoRefresh = false;

/* ================= INIT & AUTH ================= */
// On Load: Check if token is saved
window.addEventListener('DOMContentLoaded', () => {
    const savedToken = localStorage.getItem(STORAGE_KEY);
    if(savedToken === ADMIN_TOKEN) {
        // Auto Login
        document.getElementById('loginModal').classList.add('hidden');
        document.getElementById('pwdInput').value = savedToken;
        init();
    } else {
        // Show Login
        document.getElementById('loader').classList.remove('show');
    }
});

function checkAuth() {
    const input = document.getElementById('pwdInput').value;
    if(input === ADMIN_TOKEN) {
        // Save to Storage
        localStorage.setItem(STORAGE_KEY, input);
        
        document.getElementById('loginModal').classList.add('hidden');
        init();
    } else {
        alert("å¯†ç¢¼éŒ¯èª¤");
    }
}

function logout() {
    if(confirm("ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ")) {
        localStorage.removeItem(STORAGE_KEY);
        location.reload(); // Reload to clear state
    }
}

// Data Fetching
// isSilent: true means don't show the full screen loader (for auto-refresh)
async function init(isSilent = false) {
  if(!isSilent) showLoading(true, "è¼‰å…¥æ•¸æ“šä¸­...");
  else document.getElementById('refreshIcon').classList.add('active'); // Show small spinner

  try {
    // ä¸¦è¡ŒæŠ“å– CSV
    const [ord, prods] = await Promise.all([
      fetchCSV(ORDERS_CSV), 
      fetchCSV(SHEET_P_CSV)
      // fetchCSV(INVENTORY_CSV), // è‹¥æœ‰åº«å­˜è¡¨å¯è‡ªè¡Œæ‰“é–‹
      // fetchCSV(SALES_CSV)      // è‹¥æœ‰éŠ·å”®è¡¨å¯è‡ªè¡Œæ‰“é–‹
    ]);
    
    // Process Data
    processProducts(prods);
    processOrders(ord);
    // processInventory(inv);
    // processSales(sales);

    updateDashboard(); // Refresh Dashboard Cards
    renderCurrentTable(); // Refresh Table View

  } catch(e) {
    console.error(e);
    if(!isSilent) alert("æ•¸æ“šè¼‰å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–ä¾†æº");
  } finally {
    if(!isSilent) showLoading(false);
    else document.getElementById('refreshIcon').classList.remove('active');
  }
}

function fetchCSV(url) {
    return new Promise((resolve, reject) => {
        if(!url || url.includes("...")) { resolve([]); return; } // Dummy check
        Papa.parse(url, {
            download: true,
            complete: (res) => resolve(res.data),
            error: (err) => reject(err)
        });
    });
}

/* ================= DATA PROCESSING ================= */
function processProducts(rows) {
    if(!rows || rows.length < 2) return;
    const header = rows[0];
    const idxCode = header.indexOf('product_code');
    const idxName = header.indexOf('product_name');
    const idxSpecs = [];
    for(let k=1; k<=4; k++) idxSpecs.push({ name: header.indexOf(`spec_${k}`), qty: header.indexOf(`spec_${k}_qty`) });

    rows.slice(1).forEach(r => {
        const code = r[idxCode];
        const name = r[idxName];
        if(!code) return;
        
        let bundleItems = [];
        idxSpecs.forEach(s => {
            const n = r[s.name];
            if(n) bundleItems.push(n); 
        });
        
        if(bundleItems.length > 0) {
            PRODUCT_BUNDLE_MAP.set(code, bundleItems.join('|'));
        } else if (name) {
            PRODUCT_BUNDLE_MAP.set(code, name);
        }
    });
}

function processOrders(rows) {
  DATA.soldMap = {};
  // GAS V3.7+ çµæ§‹: 
  // Col 0:ID, 1:Time, 2:Name, 3:Dept, 4:PayMethod, 5:Note, 6:Base, 7:Disc, 8:Total, 9:DiscNote, 10:Pickup, 11:JSON
  DATA.orders = rows.slice(1).map(r => {
    const safe = (i) => (r[i] !== undefined && r[i] !== null) ? String(r[i]) : "";
    let rawJson = null;
    
    // å˜—è©¦è®€å– JSON
    try { 
        if(safe(11) && safe(11).startsWith('{')) {
            rawJson = JSON.parse(safe(11)); 
        } else if (safe(10) && safe(10).startsWith('{')) {
            rawJson = JSON.parse(safe(10)); // fallback
        }
    } catch(e) { console.warn("JSON Parse Error", r[0]); }
    
    // å»ºç«‹éŠ·é‡ Map
    if (rawJson) {
        if(rawJson.items) rawJson.items.forEach(it => { const code = it.product_code || it.product_name; if(code) DATA.soldMap[code] = (DATA.soldMap[code] || 0) + (it.qty || 0); });
        if(rawJson.gifts) rawJson.gifts.forEach(g => { 
            let code = g.product_code || g.product_name;
            code = code.replace(/^\[è´ˆå“\]\s*/, '').replace(/^\[Gift\]\s*/i, '');
            if(code) DATA.soldMap[code] = (DATA.soldMap[code] || 0) + (g.qty || 0); 
        });
    }
    
    let pickup = safe(10); 
    if(pickup.includes('{') || !pickup) pickup = "è‡ªå–"; 
    
    return { 
        id: safe(0), 
        time: safe(1), 
        name: safe(2), 
        dept: safe(3), 
        note: safe(5), 
        total: Number(safe(8).toString().replace(/,/g, '')) || 0, 
        pickup: pickup,
        raw: rawJson 
    };
  }).filter(o => o.id);
}

/* ================= AUTO REFRESH LOGIC ================= */
function toggleAutoRefresh() {
    const chk = document.getElementById('autoRefreshToggle');
    isAutoRefresh = chk.checked;
    
    if(isAutoRefresh) {
        // Start Timer
        refreshTimer = setInterval(() => {
            init(true); // Silent update
        }, 30000); // 30 Seconds
    } else {
        // Stop Timer
        if(refreshTimer) clearInterval(refreshTimer);
        refreshTimer = null;
    }
}

/* ================= UI RENDERING ================= */
function switchTab(tab) {
    CURRENT_TAB = tab;
    document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
    document.querySelector(`.nav-item[onclick="switchTab('${tab}')"]`).classList.add('active');
    
    // Reset Sort/Filter on tab change? Optional.
    renderCurrentTable();
}

function updateDashboard() {
    // ç°¡å–®ç¯„ä¾‹ï¼šåªé¡¯ç¤ºè¨‚å–®æ•¸å’ŒéŠ·å”®é¡
    // å¯¦éš›å¯æ ¹æ“š DATA.orders è¨ˆç®—æ›´å¤š KPI
    const totalOrders = DATA.orders.length;
    const totalSales = DATA.orders.reduce((sum, o) => sum + o.total, 0);
    
    // é€™è£¡è‹¥æ˜¯ç¬¬ä¸€æ¬¡æ¸²æŸ“ï¼Œå¯ä»¥ç”Ÿæˆ HTMLï¼Œè‹¥å·²æœ‰å‰‡æ›´æ–°æ•¸å€¼
    // ç‚ºäº†ç°¡åŒ–ï¼Œç›´æ¥é‡ç¹ª Dashboard å€åŸŸ (è‹¥ currentTab æ˜¯ dashboard)
    if(CURRENT_TAB === 'dashboard') renderDashboard(totalOrders, totalSales);
}

function renderDashboard(count, money) {
    const html = `
    <div class="dash-grid">
        <div class="card">
            <div class="card-label">ç¸½è¨‚å–®æ•¸ (ç­†)</div>
            <div class="card-val">${count}</div>
            <div class="trend up"><span class="material-icons-round" style="font-size:16px">trending_up</span> å³æ™‚æ›´æ–°</div>
            <span class="material-icons-round card-icon">receipt_long</span>
        </div>
        <div class="card">
            <div class="card-label">ç¸½éŠ·å”®é¡ (NT$)</div>
            <div class="card-val">$${money.toLocaleString()}</div>
            <div class="trend up"><span class="material-icons-round" style="font-size:16px">payments</span> ç´¯ç©ç‡Ÿæ”¶</div>
            <span class="material-icons-round card-icon">monetization_on</span>
        </div>
    </div>
    <div class="panel">
        <div class="panel-head">
            <div class="panel-title"><span class="material-icons-round">history</span> è¿‘æœŸè¨‚å–®</div>
        </div>
        <div class="table-wrap" id="dashTable"></div>
    </div>
    `;
    document.getElementById('mainContent').innerHTML = html;
    
    // Render mini table for dashboard (Top 10)
    const recent = [...DATA.orders].reverse().slice(0, 10);
    let tbl = `<table><thead><tr><th>å–®è™Ÿ</th><th>æ™‚é–“</th><th>å§“å</th><th>é‡‘é¡</th></tr></thead><tbody>`;
    recent.forEach(o => {
        tbl += `<tr><td>${o.id}</td><td>${o.time.split(' ')[1] || o.time}</td><td>${o.name}</td><td>$${o.total}</td></tr>`;
    });
    tbl += `</tbody></table>`;
    document.getElementById('dashTable').innerHTML = tbl;
}

function renderCurrentTable() {
    const container = document.getElementById('mainContent');
    if(CURRENT_TAB === 'dashboard') { updateDashboard(); return; }

    // Header Template
    let html = `
    <div class="panel">
        <div class="panel-head">
            <div class="panel-title">
                ${getTabTitle(CURRENT_TAB)}
                ${CURRENT_TAB === 'orders' ? `<div id="order-summary-bar" style="margin-left:20px;font-size:14px;color:#2e7d32;background:#e8f5e9;padding:4px 10px;border-radius:4px;"></div>` : ''}
            </div>
            <div class="action-bar">
                ${CURRENT_TAB === 'orders' ? `<button onclick="showItemStats()" style="border:1px solid #2e7d32;background:#fff;color:#2e7d32;border-radius:20px;padding:4px 12px;font-size:12px;font-weight:700;cursor:pointer;display:flex;align-items:center;gap:4px"><span class="material-icons-round" style="font-size:16px">poll</span> è²¨å“çµ±è¨ˆ</button>` : ''}
                <input type="text" class="search-box" placeholder="æœå°‹..." id="tableSearch" onkeyup="renderCurrentTable()">
                <div class="filter-btn" id="filter-btn" onclick="openFilterSheet()"><span class="material-icons-round">filter_list</span></div>
                <div class="filter-btn" onclick="openSortSheet()"><span class="material-icons-round">sort</span></div>
            </div>
        </div>
        <div class="table-wrap">
            <table id="dataTable">
                </table>
        </div>
    </div>`;
    
    container.innerHTML = html;
    
    // Filtering & Sorting Logic
    let list = [];
    if(CURRENT_TAB === 'orders') list = [...DATA.orders];
    
    // 1. Search
    const q = document.getElementById('tableSearch') ? document.getElementById('tableSearch').value.toLowerCase().trim() : "";
    if(q) {
        list = list.filter(item => {
            return Object.values(item).some(val => String(val).toLowerCase().includes(q));
        });
    }

    // 2. Filter (Multi-select)
    if(CURRENT_TAB === 'orders' && SELECTED_STATUSES.size > 0) {
        list = list.filter(o => SELECTED_STATUSES.has(o.dept) || SELECTED_STATUSES.has(o.pickup));
    }

    // 3. Sort
    list.sort((a, b) => {
        let va = a[SORT.key], vb = b[SORT.key];
        if(SORT.key === 'total' || SORT.key === 'qty') { va = Number(va); vb = Number(vb); }
        if(va < vb) return SORT.asc ? -1 : 1;
        if(va > vb) return SORT.asc ? 1 : -1;
        return 0;
    });

    // 4. Update Order Summary
    if(CURRENT_TAB === 'orders') {
        const sumTotal = list.reduce((acc, o) => acc + o.total, 0);
        const bar = document.getElementById('order-summary-bar');
        if(bar) bar.innerText = `ç¯©é¸ç­†æ•¸: ${list.length} / ç¸½é‡‘é¡: $${sumTotal.toLocaleString()}`;
    }

    // 5. Build Table HTML
    let tableHtml = "";
    if(CURRENT_TAB === 'orders') {
        tableHtml = `<thead><tr>
            ${getSortHeader('id','å–®è™Ÿ')}
            ${getSortHeader('time','æ™‚é–“')}
            ${getSortHeader('name','å§“å')}
            ${getSortHeader('dept','éƒ¨é–€')}
            ${getSortHeader('pickup','å–è²¨')}
            ${getSortHeader('total','ç¸½é‡‘é¡')}
            <th>æ“ä½œ <span class="material-icons-round" style="color:#d32f2f;cursor:pointer;font-size:20px;vertical-align:middle;margin-left:8px;" onclick="deleteAllOrders()" title="åˆªé™¤å…¨éƒ¨">delete_sweep</span></th>
        </tr></thead><tbody>`;
        
        list.forEach(o => { 
            const pickupBadge = o.pickup === 'å®…é…' 
                ? `<span style="background:#fff3e0;color:#e65100;padding:2px 6px;border-radius:4px;font-size:12px">å®…é…</span>`
                : `<span style="background:#f5f5f5;color:#607d8b;padding:2px 6px;border-radius:4px;font-size:12px">è‡ªå–</span>`;
            
            tableHtml += `
            <tr style="cursor:pointer" onclick="openOrderModal('${o.id}','view')">
                <td style="font-size:14px">${o.id}</td>
                <td>${o.time.split(' ')[0]}</td>
                <td><b>${o.name}</b></td>
                <td><span style="font-size:13px;color:#546e7a">${o.dept}</span></td>
                <td>${pickupBadge}</td>
                <td style="font-weight:700">$${o.total.toLocaleString()}</td>
                <td>
                    <span class="material-icons-round act-btn" onclick="openOrderModal('${o.id}','edit');event.stopPropagation()">edit</span>
                    <span class="material-icons-round act-btn" style="color:#ef5350" onclick="deleteOrderPrompt('${o.id}');event.stopPropagation()">delete</span>
                </td>
            </tr>`; 
        });
    } 
    // ... å¯ä»¥æ“´å…… Inventory / Sales çš„è¡¨æ ¼é‚è¼¯ ...

    tableHtml += `</tbody>`;
    document.getElementById('dataTable').innerHTML = tableHtml;
}

function getSortHeader(key, label) {
    const icon = SORT.key === key ? (SORT.asc ? 'arrow_upward' : 'arrow_downward') : '';
    return `<th onclick="setSort('${key}')">${label} <span class="material-icons-round" style="font-size:14px;vertical-align:middle">${icon}</span></th>`;
}

function setSort(key) {
    if(SORT.key === key) SORT.asc = !SORT.asc;
    else { SORT.key = key; SORT.asc = true; }
    renderCurrentTable();
}

function getTabTitle(tab) {
    if(tab === 'orders') return '<span class="material-icons-round">receipt_long</span> è¨‚å–®ç®¡ç†';
    if(tab === 'inventory') return '<span class="material-icons-round">inventory_2</span> åº«å­˜åˆ—è¡¨';
    return 'åˆ—è¡¨';
}

/* ================= MODALS & ACTIONS ================= */
// Order Detail Modal (View/Edit)
function openOrderModal(oid, mode) {
    const order = DATA.orders.find(o => o.id === oid);
    if(!order) return;
    currentEditOrder = order;

    const modal = document.getElementById('infoModal');
    const body = document.getElementById('info-body');
    const title = document.getElementById('info-title');
    const footer = document.getElementById('modal-footer');
    
    title.innerText = (mode === 'edit' ? "ç·¨è¼¯è¨‚å–® " : "è¨‚å–®è©³æƒ… ") + oid;
    
    if(mode === 'view') {
        let itemsHtml = order.raw.items.map(it => `
            <div class="info-row">
                <span>${it.product_name} <span style="color:#888;font-size:12px">${it.spec}</span></span>
                <span>x${it.qty}</span>
            </div>`).join('');
            
        let giftsHtml = "";
        if(order.raw.gifts && order.raw.gifts.length > 0) {
            giftsHtml = `<div class="info-section-title">è´ˆå“</div>` + 
            order.raw.gifts.map(g => `<div class="info-row" style="color:#e65100"><span>ğŸ ${g.product_name}</span><span>x${g.qty}</span></div>`).join('');
        }

        let pickupInfo = "";
        if(order.pickup === "å®…é…" && order.raw.pickup_info) {
            pickupInfo = `<div style="background:#fff3e0;padding:10px;margin:10px 0;border-radius:6px">
                <b>å®…é…è³‡è¨Š</b><br>
                ${order.raw.pickup_info.name} / ${order.raw.pickup_info.phone}<br>
                ${order.raw.pickup_info.address}<br>
                å‚™è¨»: ${order.raw.pickup_info.note || 'ç„¡'}
            </div>`;
        }

        body.innerHTML = `
            <div style="font-size:16px;font-weight:700;margin-bottom:10px">${order.name} <span style="font-weight:400;color:#666">(${order.dept})</span></div>
            <div style="color:#546e7a;margin-bottom:15px">æ™‚é–“: ${order.time} | å–è²¨: ${order.pickup}</div>
            ${pickupInfo}
            <div style="border-top:1px solid #eee;padding-top:10px">${itemsHtml}</div>
            ${giftsHtml}
            <div style="margin-top:15px;padding-top:10px;border-top:2px solid #333;text-align:right;font-size:18px;font-weight:900;color:#d32f2f">
                ç¸½é‡‘é¡: $${order.total.toLocaleString()}
            </div>
            <div style="margin-top:10px;color:#888;font-size:13px">å‚™è¨»: ${order.note || 'ç„¡'}</div>
        `;
        footer.innerHTML = `<button class="login-btn" style="width:auto; padding:8px 20px; background:#546e7a" onclick="closeModal()">é—œé–‰</button>`;
    } 
    else if (mode === 'edit') {
        // Edit Mode HTML
        body.innerHTML = `
            <div class="info-row"><span>å§“å</span><input id="e-name" class="edit-input" value="${order.name}"></div>
            <div class="info-row"><span>éƒ¨é–€</span><input id="e-dept" class="edit-input" value="${order.dept}"></div>
            <div class="info-row"><span>å‚™è¨»</span><input id="e-note" class="edit-input" value="${order.note}"></div>
            <div style="margin-top:20px; color:#d32f2f; font-size:12px">* é‡‘é¡èˆ‡å“é …è«‹åˆªé™¤å¾Œé‡æ–°ä¸‹å–®ï¼Œæ­¤è™•åƒ…ä¾›è³‡æ–™ä¿®æ­£ã€‚</div>
        `;
        footer.innerHTML = `
            <button class="login-btn" style="width:auto; padding:8px 20px; background:#ccc; color:#333" onclick="closeModal()">å–æ¶ˆ</button>
            <button class="login-btn" style="width:auto; padding:8px 20px;" onclick="saveOrderAction()">å„²å­˜è®Šæ›´</button>
        `;
    }
    
    modal.classList.add('open');
}

function saveOrderAction() {
    if(!currentEditOrder) return;
    
    // Update local object
    currentEditOrder.raw.employee_name = document.getElementById('e-name').value;
    currentEditOrder.raw.department = document.getElementById('e-dept').value;
    currentEditOrder.raw.remarks = document.getElementById('e-note').value;
    
    // Auto-fix bundle summary if missing (for legacy data)
    if(currentEditOrder.raw.items) {
        currentEditOrder.raw.items.forEach(it => {
            if(!it.bundle_summary && PRODUCT_BUNDLE_MAP.has(it.product_code)) {
                it.bundle_summary = PRODUCT_BUNDLE_MAP.get(it.product_code);
            }
        });
    }
    if(currentEditOrder.raw.gifts) {
        currentEditOrder.raw.gifts.forEach(g => {
            if(!g.bundle_summary && g.product_code && PRODUCT_BUNDLE_MAP.has(g.product_code)) {
                g.bundle_summary = PRODUCT_BUNDLE_MAP.get(g.product_code);
            } else if (!g.bundle_summary) {
                 g.bundle_summary = g.product_name.replace(/^\[è´ˆå“\]\s*/, ''); // fallback
            }
        });
    }

    const payload = JSON.parse(JSON.stringify(currentEditOrder.raw));
    payload.action = "update_order";
    payload.order_id = currentEditOrder.id;
    
    callGAS(payload, "ä¿®æ”¹æˆåŠŸ", false);
}

function deleteOrderPrompt(oid) {
    if(confirm(`ç¢ºå®šè¦åˆªé™¤è¨‚å–® ${oid} å—ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸï¼`)) {
        callGAS({ action: 'delete_order', order_id: oid }, "åˆªé™¤æˆåŠŸ", true);
    }
}

function callGAS(payload, msg, isDelete) {
    showLoading(true, isDelete ? "åˆªé™¤ä¸­..." : "å„²å­˜ä¸­...");
    
    fetch(GAS_URL + "?token=" + encodeURIComponent(ADMIN_TOKEN), { 
        method: "POST", 
        headers: { "Content-Type": "application/x-www-form-urlencoded" }, 
        body: "payload=" + encodeURIComponent(JSON.stringify(payload)) 
    })
    .then(r=>r.json())
    .then(res=>{ 
        if(res.ok) { 
            // é‡æ–°è¼‰å…¥ä»¥ç¢ºä¿æ•¸æ“šä¸€è‡´ (init æœƒé‡ç¹ª)
            init(false); 
            closeModal();
            alert(msg);
        } else {
            alert("æ“ä½œå¤±æ•—: " + (res.error || "æœªçŸ¥éŒ¯èª¤"));
        }
    })
    .catch(err => alert("é€£ç·šéŒ¯èª¤"))
    .finally(() => showLoading(false));
}

function closeModal() {
    document.getElementById('infoModal').classList.remove('open');
    currentEditOrder = null;
}

// Stats Modal
function showItemStats() {
    // Re-calculate based on current filtered list
    const q = document.getElementById('tableSearch').value.toLowerCase().trim();
    let list = DATA.orders.filter(o => o.id.toLowerCase().includes(q) || o.name.includes(q));
    if (SELECTED_STATUSES.size > 0) {
        list = list.filter(o => SELECTED_STATUSES.has(o.dept) || SELECTED_STATUSES.has(o.pickup));
    }

    const itemStats = {};
    const giftStats = {};

    list.forEach(o => {
        if(!o.raw) return;
        if(o.raw.items) o.raw.items.forEach(it => {
            const qty = it.qty || 0;
            if(it.bundle_summary) {
                it.bundle_summary.split('|').forEach(sub => itemStats[sub.trim()] = (itemStats[sub.trim()] || 0) + qty);
            } else {
                itemStats[it.product_name] = (itemStats[it.product_name] || 0) + qty;
            }
        });
        if(o.raw.gifts) o.raw.gifts.forEach(g => {
            const qty = g.qty || 0;
            if(g.bundle_summary) {
                g.bundle_summary.split('|').forEach(sub => giftStats[sub.trim()] = (giftStats[sub.trim()] || 0) + qty);
            } else {
                let name = g.product_name.replace(/^\[è´ˆå“\]\s*/, '').replace(/^\[Gift\]\s*/i, '');
                giftStats[name] = (giftStats[name] || 0) + qty;
            }
        });
    });

    const body = document.getElementById('info-body');
    document.getElementById('info-title').innerText = "è²¨å“çµ±è¨ˆ (ç›®å‰ç¯©é¸ç¯„åœ)";
    
    let html = `<div style="padding:10px;background:#e8f5e9;color:#2e7d32;font-weight:700;margin-bottom:15px;border-radius:8px">çµ±è¨ˆè¨‚å–®æ•¸ï¼š${list.length} ç­†</div>`;
    html += `<div class="info-section-title">ğŸ“¦ å•†å“çµ±è¨ˆ</div>`;
    Object.entries(itemStats).sort((a,b)=>b[1]-a[1]).forEach(([k,v]) => {
        html += `<div class="info-row"><span>${k}</span><span style="font-weight:900">${v}</span></div>`;
    });
    
    if(Object.keys(giftStats).length > 0) {
        html += `<div class="info-section-title" style="margin-top:20px;border-color:var(--accent)">ğŸ è´ˆå“çµ±è¨ˆ</div>`;
        Object.entries(giftStats).sort((a,b)=>b[1]-a[1]).forEach(([k,v]) => {
            html += `<div class="info-row" style="color:#546e7a"><span>${k}</span><span style="font-weight:900;color:var(--accent)">${v}</span></div>`;
        });
    }
    
    body.innerHTML = html;
    document.getElementById('modal-footer').innerHTML = `<button class="login-btn" style="width:auto;padding:8px 20px" onclick="closeModal()">é—œé–‰</button>`;
    document.getElementById('infoModal').classList.add('open');
}

/* ================= FILTER & UTILS ================= */
function openFilterSheet() {
    const optsDiv = document.getElementById('filterOptions');
    optsDiv.innerHTML = "";
    
    let options = [];
    if(CURRENT_TAB === 'orders') {
        const depts = [...new Set(DATA.orders.map(o => o.dept))].filter(Boolean).sort();
        const pickups = ["è‡ªå–", "å®…é…"];
        options = ["(å…¨é¸)", ...pickups, "---", ...depts];
    } else {
        options = ALL_STATUSES;
    }

    options.forEach(opt => {
        if(opt === "---") { optsDiv.appendChild(document.createElement("hr")); return; }
        const isAll = opt === "(å…¨é¸)";
        const isChecked = isAll ? false : SELECTED_STATUSES.has(opt);
        
        const div = document.createElement('div');
        div.className = "filter-row";
        if(isAll) div.style.color = "var(--primary)";
        
        div.onclick = function() { 
            if(isAll) { 
                const all = document.querySelectorAll('.filter-chk');
                const val = !all[0].checked; // Toggle based on first
                all.forEach(c => c.checked = val);
                return;
            }
            const chk = this.querySelector('input'); 
            chk.checked = !chk.checked; 
        };
        
        div.innerHTML = isAll 
            ? `<span class="material-icons-round" style="margin-right:12px">done_all</span><span>å…¨é¸ / å–æ¶ˆ</span>`
            : `<input type="checkbox" class="filter-chk" value="${opt}" ${isChecked ? 'checked' : ''} onclick="event.stopPropagation()"><span>${opt}</span>`;
        optsDiv.appendChild(div);
    });
    
    document.getElementById('filterSheet').classList.add('open');
    document.getElementById('sortOverlay').style.display = 'block';
}

function applyFilter() {
    const chks = document.querySelectorAll('.filter-chk');
    SELECTED_STATUSES.clear();
    chks.forEach(c => { if(c.checked) SELECTED_STATUSES.add(c.value); });
    
    const btn = document.getElementById('filter-btn');
    if(SELECTED_STATUSES.size > 0) btn.classList.add('active'); else btn.classList.remove('active');
    
    closeFilterSheet();
    renderCurrentTable();
}

function closeFilterSheet() {
    document.getElementById('filterSheet').classList.remove('open');
    document.getElementById('sortOverlay').style.display = 'none';
}

function openSortSheet() {
    // ç°¡å–®å¯¦ä½œï¼šåˆ‡æ› ID æ’åº
    setSort('id');
}

function showLoading(show, text) {
    const el = document.getElementById('loader');
    if(text) document.getElementById('loadText').innerText = text;
    if(show) el.classList.add('show'); else el.classList.remove('show');
}

function toggleSidebar() {
    document.getElementById('sidebar').classList.toggle('open');
}
</script>
</body>
</html>