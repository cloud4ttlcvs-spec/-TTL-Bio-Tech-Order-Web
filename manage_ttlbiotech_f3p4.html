<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
<title>TTL BIO-TECH æˆ°æƒ…ä¸­å¿ƒ V98.11.9</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#00897b">
  <meta name="apple-mobile-web-app-title" content="TTL-Bio Dashboard">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" href="icons/icon-192.png">
<meta name="mobile-web-app-capable" content="yes">
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&family=Roboto:wght@500;700;900&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

<style>
/* --- Theme Variables --- */
:root {
  --primary: #00897b; --accent: #ff6f00;
  --bg-body: #f4f6f8; --text-main: #263238; --text-sub: #546e7a;
  --danger: #d32f2f; --warning: #f57c00; --success: #388e3c;
  --info: #0288d1; --stagnant: #7b1fa2;
  --header-height: 55px; --sidebar-width: 230px;
  --bottom-nav-height: 60px;
}
* { box-sizing: border-box; }
body { font-family: 'Noto Sans TC', sans-serif; background: var(--bg-body); color: var(--text-main); margin: 0; padding: 0; display: flex; height: 100vh; overflow: hidden; font-size: 15px; }

/* --- Desktop Layout --- */
#sidebar { width: var(--sidebar-width); background: #263238; color: #fff; flex-shrink: 0; display: flex; flex-direction: column; padding: 15px 0; transition: transform 0.3s; position: relative; z-index: 120; }
.brand { font-size: 20px; font-weight: 900; padding: 0 20px 20px; display: flex; align-items: center; gap: 10px; color: var(--primary); }
.nav-item { padding: 12px 20px; cursor: pointer; display: flex; align-items: center; gap: 10px; color: #b0bec5; font-weight: 500; transition: 0.2s; border-left: 4px solid transparent; font-size: 15px; }
.nav-item:hover { background: #37474f; color: #fff; }
.nav-item.active { background: #37474f; color: #fff; border-left-color: var(--accent); }

#main { flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; }
header { height: var(--header-height); background: #fff; border-bottom: 1px solid #ddd; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; flex-shrink: 0; z-index: 10; transition: margin-top 0.3s; }
.page-title { font-size: 18px; font-weight: 700; display:flex; align-items:center; gap:10px;}
.update-time { font-size: 12px; color: #999; }
/* --- Mobile App Title Bar (PWA-ready) --- */
.header-left{display:flex;align-items:center;gap:10px;min-width:0;}
.header-right{display:flex;align-items:center;gap:8px;}
.app-mark{color:var(--primary);background:#fff;border-radius:50%;padding:4px;font-size:20px;border:1px solid #e0e0e0;}
#pageTitle{font-weight:900;color:#263238;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.icon-btn{border:1px solid #cfd8dc;background:#fff;width:34px;height:34px;border-radius:10px;display:none;align-items:center;justify-content:center;cursor:pointer;}
.icon-btn .material-icons-round{font-size:20px;color:#546e7a;}
.icon-btn:hover{border-color:#b0bec5;}
@media (max-width:768px){
  header{padding:0 12px;}
  .update-time{display:none;}
  .icon-btn{display:inline-flex;}
}

/* --- Battle Center Dashboard Layout (Route B) --- */
.dashboard-grid{flex:1;display:grid;grid-template-columns:8fr 5fr 7fr;gap:12px;min-height:0;align-items:stretch;}
.dashboard-grid > .chart-card{min-height:0;}
.dashboard-right{display:flex;flex-direction:column;gap:12px;min-height:0;}
.dashboard-right .chart-card{flex:1;min-height:0;}
.legend-row{padding:8px 15px;border-bottom:1px solid #eee;background:#fff;flex-shrink:0;}
.legend-compact{justify-content:flex-start;font-weight:700;}
.alert-body{flex:1;min-height:0;overflow-y:auto;padding:10px;}
.alert-row{display:flex;flex-direction:column;gap:6px;padding:7px 10px;border:1px solid #eceff1;border-radius:10px;background:#fff;cursor:pointer;}
.alert-row:hover{background:#fafafa;}
.alert-name{font-weight:900;font-size:13px;line-height:1.25;}
.alert-meta{display:flex;gap:8px;flex-wrap:wrap;align-items:center;color:#607d8b;font-size:12px;font-weight:700;}
.alert-badge{color:#fff;font-weight:900;border-radius:999px;padding:2px 8px;font-size:12px;}
.alert-num{background:#eceff1;border-radius:999px;padding:2px 8px;}

.alert-top{display:flex;align-items:flex-start;justify-content:space-between;gap:10px;}
.alert-hide{flex:0 0 auto;color:#b0bec5;cursor:pointer;border-radius:10px;padding:4px;line-height:1;-webkit-tap-highlight-color:transparent;}
.alert-hide:active{background:#eceff1;}
.alert-hide:hover{color:#78909c;}

.full-chart-layout{display:flex;gap:14px;align-items:flex-start;}
.fc-side{width:300px;flex:0 0 300px;background:#fff;border:1px solid #e0e0e0;border-radius:14px;overflow:hidden;position:sticky;top:120px;max-height:calc(100vh - 150px);box-shadow:0 6px 18px rgba(0,0,0,0.06);}
.fc-side-head{padding:10px 12px;background:#fafafa;border-bottom:1px solid #eee;font-weight:900;color:#37474f;display:flex;align-items:center;justify-content:space-between;}
.fc-side-list{overflow-y:auto;max-height:calc(100vh - 190px);padding:8px;}
.fc-item{display:flex;align-items:flex-start;justify-content:space-between;gap:10px;padding:10px;border:1px solid #eceff1;border-radius:12px;background:#fff;cursor:pointer;}
.fc-item:hover{background:#fafafa;}
.fc-item-left{min-width:0;display:flex;flex-direction:column;gap:6px;}
.fc-item-name{font-weight:900;font-size:13px;line-height:1.25;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.fc-item-meta{display:flex;flex-wrap:wrap;gap:6px;color:#607d8b;font-size:12px;font-weight:700;}
.fc-pill{background:#eceff1;border-radius:999px;padding:2px 8px;}
.fc-hide{flex:0 0 auto;color:#b0bec5;cursor:pointer;border-radius:10px;padding:4px;}
.fc-hide:active{background:#eceff1;}
.fc-hide:hover{color:#78909c;}

@media (max-width: 980px){
  .full-chart-layout{flex-direction:column;}
  .fc-side{width:100%;flex:0 0 auto;position:static;top:auto;max-height:260px;}
  .fc-side-list{max-height:200px;}
}


@media (max-width:768px){
  .dashboard-grid{grid-template-columns:1fr;}
  .dashboard-right{flex-direction:column;}
  .dashboard-right .alert-card{order:1;}
  .dashboard-right .overstock-card{order:2;}
}


#backBtn { display: none; cursor: pointer; font-size: 14px; color: #fff; background: var(--text-sub); padding: 5px 14px; border-radius: 20px; align-items: center; gap: 4px; transition: 0.2s; }
#backBtn:hover { background: var(--primary); }

.content-box { flex: 1; display: flex; flex-direction: column; padding: 15px; overflow: hidden; gap: 15px; position: relative;  min-height: 0; }
.content-box.dashboard-scroll{overflow-y:auto;-webkit-overflow-scrolling:touch;}

/* KPI Cards */
.kpi-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; flex-shrink: 0; }
.kpi-card { background: #fff; padding: 14px 18px; border-radius: 8px; border: 1px solid #e0e0e0; display: flex; align-items: center; justify-content: space-between; cursor: pointer; transition: 0.2s; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
.kpi-card:hover { transform: translateY(-2px); border-color: var(--primary); }
.kpi-info { display: flex; flex-direction: column; }
.kpi-label { font-size: 12px; color: var(--text-sub); font-weight: 700; text-transform: uppercase; }
.kpi-val { font-size: 24px; font-weight: 900; margin-top: 4px; }
.kpi-icon { font-size: 32px; opacity: 0.15; color: var(--text-main); }
.kpi-dual { display: flex; gap: 10px; align-items: baseline; margin-top: 4px; }
.kpi-dual span { font-weight: 900; font-size: 20px; }

/* Charts */
.chart-section { flex: 1; display: grid; grid-template-columns: 1fr 1fr; gap: 12px; min-height: 0; }
.chart-card { background: #fff; border-radius: 8px; border: 1px solid #e0e0e0; display: flex; flex-direction: column; overflow: hidden; }
.c-head { padding: 10px 15px; font-size: 14px; font-weight: 700; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; background: #fafafa; flex-shrink: 0; align-items: center; flex-wrap: wrap; gap: 8px; }
.c-body { flex: 1; padding: 10px; position: relative; min-height: 0; }

.chart-toggles { display: flex; gap: 5px; background: #eceff1; padding: 2px; border-radius: 6px; }
.c-toggle-btn { padding: 4px 8px; font-size: 11px; cursor: pointer; border-radius: 4px; color: #546e7a; font-weight: 700; }
.c-toggle-btn.active { background: #fff; color: var(--primary); box-shadow: 0 1px 2px rgba(0,0,0,0.1); }

.legend-box { display:flex; gap:8px; flex-wrap:wrap; font-size:11px; color:#546e7a; justify-content:flex-end; font-weight: 500; }
.l-item { display:flex; align-items:center; gap:3px; white-space: nowrap; }
.l-dot { width:8px; height:8px; border-radius:2px; }

.overstock-layout { display: flex; height: 100%; width: 100%; }
/* V98.10.3: remove cramped side list; show values on bars instead */
.os-chart-area { flex: 1; padding-right: 0; border-right: none; position: relative; min-width: 0; }
.os-list-area { display:none !important; }
.os-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 10px; background: #fff; border: 1px solid #eee; border-radius: 4px; font-size: 12px; }
.os-item:hover { background: #f5f5f5; }
.os-btn { cursor: pointer; color: #90a4ae; font-size: 18px; padding: 0 4px; }
.see-more-btn { font-size: 12px; color: var(--primary); cursor: pointer; display: flex; align-items: center; gap: 2px; margin-left: auto; }
.see-more-btn:hover { text-decoration: underline; }

/* Full Chart View */
#view-full-chart { background: #fff; position: absolute; inset: 0; z-index: 50; display: none; flex-direction: column; overflow: hidden; }
.full-chart-header { padding: 10px 15px; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center; background: #fff; flex-shrink: 0; }
.fc-controls { display: flex; gap: 10px; }
.fc-toggle-btn { padding: 6px 12px; border: 1px solid var(--primary); color: var(--primary); border-radius: 20px; font-size: 13px; font-weight: 700; cursor: pointer; }
.fc-toggle-btn.active { background: var(--primary); color: #fff; }
.full-chart-legend { padding: 8px 15px; background: #fafafa; border-bottom: 1px solid #eee; display: flex; gap: 12px; flex-wrap: wrap; justify-content: center; font-size: 12px; font-weight: 700; color: #546e7a; flex-shrink: 0; }
.full-chart-body { flex: 1; overflow-y: auto; padding: 20px; }
.full-chart-container { position: relative; width: 100%; }

/* Restore Widget - Fixed to Left */
#restoreWidget {
    position: fixed; bottom: 80px; left: 20px; 
    background: #263238; color: #fff; border-radius: 25px; 
    padding: 10px 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    z-index: 2000; cursor: pointer; display: none; align-items: center; gap: 8px; font-size: 13px; font-weight: 700;
}
#restoreList {
    position: absolute; bottom: 50px; left: 0; 
    width: 250px; background: #fff; color: #333;
    border-radius: 8px; box-shadow: 0 5px 20px rgba(0,0,0,0.2); display: none; flex-direction: column;
    max-height: 300px; overflow-y: auto; border: 1px solid #eee;
}
#restoreList.open { display: flex; }
.restore-item { padding: 10px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; font-size: 12px; }
.restore-item:hover { background: #f5f5f5; }
.restore-btn { color: var(--primary); cursor: pointer; font-weight: 700; }

/* Table View */
.data-panel { background: #fff; border-radius: 8px; border: 1px solid #e0e0e0; display: flex; flex-direction: column; flex: 1; overflow: hidden; }
.panel-head { padding: 12px 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; background: #fafafa; }

.panel-actions{ display:flex; align-items:center; gap:10px; }
.oar{ display:flex; align-items:center; gap:6px; }
.oar-btn{ border:1px solid #cfd8dc; background:#fff; border-radius:10px; padding:6px 8px; cursor:pointer; display:flex; align-items:center; justify-content:center; }
.oar-btn .material-icons-round{ font-size:20px; color:#607d8b; }
.oar-btn.on{ background:#e0f2f1; border-color: var(--primary); }
.oar-btn.on .material-icons-round{ color: var(--primary); }
.oar-pill{ border:1px solid #cfd8dc; background:#fff; border-radius:999px; padding:6px 10px; cursor:pointer; font-weight:900; color:#455a64; font-size:12px; }
@media(max-width:520px){
  .panel-actions{ gap:8px; }
  .oar-pill{ padding:6px 8px; }
  .oar-btn{ padding:6px 7px; }
}

.search-wrap { position: relative; width: 280px; }
.search-wrap input { width: 100%; padding: 8px 34px 8px 34px; border: 1px solid #ccc; border-radius: 20px; font-size: 14px; outline: none; }
.search-wrap .icon { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); font-size: 18px; color: #999; }
.search-clear { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); font-size: 16px; color: #999; cursor: pointer; display: none; }

.table-container { flex: 1; overflow: auto; position: relative; }
table { width: 100%; border-collapse: collapse; font-size: 15px; }
th { position: sticky; top: 0; background: #f5f5f5; z-index: 5; text-align: left; padding: 12px; font-weight: 700; color: var(--text-sub); border-bottom: 2px solid #ddd; white-space: nowrap; cursor: pointer; transition: background 0.2s;
    cursor: pointer; user-select: none; }
th:hover { background: #e0e0e0; }
td { padding: 12px; border-bottom: 1px solid #eee; vertical-align: middle; }
tr:hover { background: #f9f9f9; }
.sort-icon { font-size: 18px; vertical-align: middle; margin-left: 4px; color: var(--primary); }

.filter-btn { display: flex; align-items: center; justify-content: center; width: 36px; height: 36px; background: #e0f2f1; border-radius: 50%; color: var(--primary); cursor: pointer; transition:0.2s; margin-left:8px; border:1px solid rgba(0,0,0,0.05); }
.filter-btn:hover { background: var(--primary); color:#fff; }
.filter-btn.active { background: var(--primary); color: #fff; box-shadow: 0 2px 5px rgba(0,137,123,0.4); }

/* Compact Desktop Expanded Rows */
.region-row { background: #fcfcfc; display: none; }
.region-row.open { display: table-row; }
.expand-container { padding: 15px 20px; display: grid; grid-template-columns: 350px 350px 1fr; gap: 15px; align-items: start; }
.detail-card { 
    background: #fff; padding: 10px 15px; 
    border-radius: 6px; border: 1px solid #e0e0e0; height: 100%; display: flex; flex-direction: column; 
    gap: 4px; 
}
.card-title { 
    font-weight: 700; margin-bottom: 6px; color: #546e7a; font-size: 13px; 
    border-bottom: 2px solid #eee; padding-bottom: 6px; 
}
.info-line { 
    display: flex; justify-content: space-between; border-bottom: 1px dashed #f0f0f0; 
    padding: 5px 0; font-size: 13px; 
}
.region-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); gap: 6px; align-content: start; }
.r-box { 
    padding: 6px 4px; border-radius: 4px; border: 1px solid rgba(0,0,0,0.05); 
    display: flex; flex-direction: column; align-items: center; text-align: center;
    color: #fff; text-shadow: 0 1px 2px rgba(0,0,0,0.1); white-space: normal;
}
.r-name { 
    font-weight: 700; font-size: 11px; margin-bottom: 2px; line-height: 1.2; 
    height: 28px; display: flex; align-items: center; justify-content: center;
    overflow: hidden;
}
.r-qty { font-weight: 900; font-size: 15px; }

.comp-container { margin-top: 8px; padding-top: 8px; border-top:1px solid #eee; }
.comp-row { display: flex; align-items: center; margin-bottom: 6px; font-size: 12px; }
.comp-label { width: 35px; color: #999; font-weight: 700; }
.comp-track { flex: 1; height: 8px; background: #eee; border-radius: 4px; margin: 0 10px; overflow: hidden; }
.comp-bar { height: 100%; border-radius: 4px; transition: width 0.6s ease; }
.comp-val { width: 45px; text-align: right; font-weight: 700; }

.st-badge { padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 700; display: inline-block; min-width: 55px; text-align: center; }
.st-ok { background: #e8f5e9; color: #2e7d32; }
.st-warn { background: #fff3e0; color: #ef6c00; }
.st-err { background: #ffebee; color: #c62828; }
.st-high { background: #e1f5fe; color: #0277bd; }
.st-dead { background: #f3e5f5; color: #7b1fa2; }
.val-up { color: #d32f2f; font-weight: 700; }
.val-down { color: #388e3c; font-weight: 700; }
.prod-name-cell { font-size: 16px; font-weight: 700; color: #263238; transition: 0.2s; } 
tr.active-row .prod-name-cell { color: #1b5e20; font-size: 17px; font-weight: 900; } 

/* Scroll to Top Button - Optimized Circular */
#scrollTopBtn {
    position: fixed; bottom: 80px; right: 20px; 
    width: 45px; height: 45px; background: var(--primary); color: #fff;
    border-radius: 50%; box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    display: none; align-items: center; justify-content: center;
    cursor: pointer; z-index: 2000; transition: transform 0.2s;
    -webkit-tap-highlight-color: transparent; /* Remove square tap highlight */
    outline: none;
}
#scrollTopBtn:active { transform: scale(0.9); }

/* UI Elements */
#loading-mask { position: fixed; inset: 0; background: rgba(255,255,255,0.9); z-index: 3000; display: flex; align-items: center; justify-content: center; flex-direction: column; gap: 10px; }
.spinner { width: 40px; height: 40px; border: 4px solid #e0f2f1; border-top-color: var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }

.modal { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 2500; display: none; align-items: center; justify-content: center; backdrop-filter: blur(2px); }
.modal.open { display: flex; }
.m-card { background: #fff; width: 500px; max-width: 90%; border-radius: 8px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); display: flex; flex-direction: column; max-height: 90vh; }
.m-head { padding: 15px 25px; background: var(--primary); color: #fff; font-weight: 700; display: flex; justify-content: space-between; align-items: center; font-size: 16px; }
.m-body { padding: 25px; overflow-y: auto; }
.m-foot { padding: 15px 25px; border-top: 1px solid #eee; display: flex; justify-content: flex-end; gap: 10px; background: #fafafa; }
.m-btn { padding: 10px 20px; border-radius: 4px; border: none; font-weight: 700; cursor: pointer; font-size: 14px; }
.m-btn.save { background: var(--primary); color: #fff; }
.m-btn.warn { background: #ffebee; color: #c62828; }
.m-btn.normal { background: #e0e0e0; color: #333; }
.m-form-row { margin-bottom: 15px; }
.m-label { font-size: 13px; color: #666; margin-bottom: 5px; display: block; font-weight: 700; }
.m-input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 15px; }
.m-input:disabled { background: #f5f5f5; cursor: not-allowed; color: #555; }

/* Sort & Filter Sheets */
#sortSheet, #filterSheet { position: fixed; bottom: 0; left: 0; right: 0; background: #fff; border-top-left-radius: 16px; border-top-right-radius: 16px; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); z-index: 2600; padding: 20px; transform: translateY(100%); transition: transform 0.3s; display: none; max-height:80vh; overflow-y:auto; }
#sortSheet.open, #filterSheet.open { transform: translateY(0); display: block; }
.sort-opt { padding: 12px; border-bottom: 1px solid #eee; font-size: 15px; font-weight: 700; color: #546e7a; cursor: pointer; display: flex; justify-content: space-between; }
.sort-opt.selected { color: var(--primary); background: #e0f2f1; border-radius: 8px; border-bottom: none; }

.filter-row { display: flex; align-items: center; padding: 12px 0; border-bottom: 1px solid #f5f5f5; cursor: pointer; }
.filter-chk { width: 20px; height: 20px; margin-right: 12px; accent-color: var(--primary); transform: scale(1.2); }
.filter-label { font-size: 15px; font-weight: 700; color: #37474f; flex: 1; }

#infoModal .m-card { background: #fff; }
.info-section-title { font-size: 15px; font-weight: 900; color: #263238; border-left: 4px solid var(--primary); padding-left: 10px; margin-bottom: 15px; }

/* Region Grid Styles */
.region-grid-mobile { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; } 
.region-box-mobile { padding: 6px 8px; border-radius: 4px; display: flex; flex-direction: column; align-items: center; text-align: center; border: 1px solid rgba(0,0,0,0.05); }
.region-name-m { font-weight: 700; font-size: 12px; margin-bottom: 2px; opacity: 0.95; }
.region-qty-m { font-weight: 900; font-size: 15px; }

/* --- Mobile / Adaptive Styles --- */
#bottom-nav { display: none; }
.mobile-card-container { display: flex; flex-direction: column; gap: 8px; padding-bottom: 80px; }
#mobile-sort-btn { display: none; }

.m-compact-card { background: #fff; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); padding: 10px 12px; position: relative; border: 1px solid #f0f0f0; overflow: hidden; transition: all 0.2s; scroll-margin-top: 70px; }
.m-compact-card.highlight-flash { animation: flashYellow 1.5s; border: 2px solid var(--accent); }
@keyframes flashYellow { 0% { background: #fffde7; } 100% { background: #fff; } }
.m-compact-card:active { transform: scale(0.99); background: #fafafa; }
.m-status-strip { position: absolute; left: 0; top: 0; bottom: 0; width: 4px; }

.stock-ticker-top { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 4px; }
.ticker-name { font-size: 15px; font-weight: 900; color: #263238; width: 65%; line-height: 1.2; word-break: break-all; }
.ticker-val-box { text-align: right; }
.ticker-stock { font-size: 18px; font-weight: 900; color: var(--primary); }
.ticker-sub { display: flex; justify-content: space-between; align-items: center; font-size: 12px; color: #78909c; margin-top: 4px; border-top: 1px solid #f5f5f5; padding-top: 6px; }
.ticker-code { background: #eceff1; padding: 1px 5px; border-radius: 3px; font-size: 11px; font-weight: 700; color: #546e7a; }

.mc-expand-content { margin-top: 12px; padding-top: 10px; border-top: 1px dashed #e0e0e0; display: none; font-size: 13px; }
.mc-expand-content.open { display: block; animation: fadeIn 0.3s; }

.mc-actions-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; padding-top: 10px; border-top: 1px solid #f0f0f0; }
.mc-action-btn { padding: 10px; text-align: center; background: #f5f5f5; border-radius: 6px; color: var(--text-sub); font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px; font-size: 13px; }
.mc-action-btn:hover { background: #e0f2f1; color: var(--primary); }

.mc-sales-mini { display: flex; justify-content: space-between; align-items: center; }
.mc-sales-detail { display: none; margin-top: 10px; padding-top: 10px; border-top: 1px dashed #eee; animation: fadeIn 0.2s; }
.mc-sales-detail.open { display: block; }
.mc-row { display: flex; justify-content: space-between; padding: 4px 0; font-size: 13px; color: #546e7a; }
.mc-row-val { font-weight: 700; color: #263238; }

.mc-order-footer { display: flex; justify-content: space-between; align-items: center; margin-top: 10px; border-top: 1px dashed #eee; padding-top: 8px; }
.mc-order-total { font-size: 17px; font-weight: 900; color: var(--text-main); }
/* Improved Circular Icon Buttons */
.mc-icon-btn { 
    padding: 6px; color: #b0bec5; font-size: 20px; 
    border-radius: 50%; /* Make circular */
    -webkit-tap-highlight-color: transparent; /* Remove square tap highlight */
    outline: none;
    transition: background 0.2s;
}
.mc-icon-btn:active { background: #eceff1; }
.mc-icon-btn.edit:hover { color: var(--primary); }
.mc-icon-btn.del:hover { color: var(--danger); }
.mc-icon-btn.hide { color: #bdbdbd; }
.mc-icon-btn.hide.active { color: var(--danger) !important; opacity: 1; }

@keyframes fadeIn { from { opacity:0; transform: translateY(-5px); } to { opacity:1; transform: translateY(0); } }

@media (max-width: 768px) {
    #sidebar { display: none; }
    #bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; height: var(--bottom-nav-height); background: #fff; border-top: 1px solid #ddd; display: flex; justify-content: space-around; align-items: center; z-index: 1000; padding-bottom: env(safe-area-inset-bottom); }
    .b-nav-item { display: flex; flex-direction: column; align-items: center; gap: 2px; color: #90a4ae; font-size: 11px; font-weight: 500; cursor: pointer; flex: 1; height: 100%; justify-content: center; }
    .b-nav-item.active { color: var(--primary); }
    .b-nav-item span { font-size: 24px; }

    #main { margin-bottom: var(--bottom-nav-height); }
    header { padding: 0 10px; position: sticky; top: 0; height: 45px; }

    header { z-index: 1100; }
    /* Mobile padding modes to remove top blank on table pages */
    .content-box{padding:10px;}
    .content-box.mobile-table{padding:0 10px 10px 10px;}
    .content-box.mobile-dashboard{padding:10px;}

    .page-title { font-size: 15px; }
    
    #view-dashboard { overflow-y: auto !important; -webkit-overflow-scrolling: touch; padding-bottom: calc(var(--bottom-nav-height) + env(safe-area-inset-bottom) + 16px); }
    .kpi-row { grid-template-columns: 1fr 1fr; gap: 8px; }
    .dashboard-grid{grid-template-columns:1fr !important; gap:15px; flex:none !important;}
    .kpi-card { padding: 10px; flex-direction: column; align-items: flex-start; gap: 6px; }
    .kpi-icon { align-self: flex-end; position: absolute; bottom: 8px; right: 8px; font-size: 24px; }
    .kpi-val { font-size: 18px; }
    
    .chart-section { grid-template-columns: 1fr; gap: 15px; display: block; } 
    .chart-card { min-height: auto; margin-bottom: 15px; }

    .chart-card.stock-main{min-height:420px;}
    .chart-card.alert-card{min-height:280px;}
    .chart-card.overstock-card{min-height:380px;}
    .c-head{padding:10px 12px;}
    .c-body{padding:8px;}

    .overstock-layout { flex-direction: column; }
    .os-chart-area { border-right: none; border-bottom: 1px dashed #eee; padding-right: 0; padding-bottom: 10px; flex: 1; min-height: 250px; }
    .os-list-area { padding-left: 0; padding-top: 10px; max-height: 200px; }

    .data-panel { border: none; background: transparent; display: flex; flex-direction: column; }
    
    .panel-head { position: fixed; top: 45px; left: 0; right: 0; height: 50px; z-index: 100; padding: 8px 10px; border-bottom: 1px solid #ddd; background: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.05); display: flex; gap: 8px; align-items: center; }
    .search-wrap { flex: 1; width: auto; }
    .search-wrap input { padding: 8px 30px 8px 34px; font-size: 14px; height: 34px; }
    .search-wrap .icon { font-size: 18px; left: 8px; }
    
    #mobile-sort-btn { display: flex; align-items: center; justify-content: center; width: 34px; height: 34px; background: #f5f5f5; border-radius: 50%; color: #546e7a; cursor: pointer; flex-shrink: 0; }
    
    .table-container { background: transparent; padding-top: 10px; margin-top: 55px; } 
    table { display: none; }
    .m-card { width: 100%; height: 100%; max-height: 100%; border-radius: 0; }
    .m-body { padding: 15px; }
    
    #view-full-chart { padding-bottom: 80px; } 
}

/* ========= Settings (Config Editor) ========= */
#view-settings{
  overflow-y:auto;
  -webkit-overflow-scrolling: touch;
  padding-bottom: calc(var(--bottom-nav-height) + env(safe-area-inset-bottom) + 18px);
}
#view-settings > *{ flex: 0 0 auto; }

.settings-topbar{
  display:flex;align-items:flex-start;justify-content:space-between;gap:12px;
  padding:14px 6px 6px 6px;
}
.settings-top-actions{display:flex;gap:10px;flex-wrap:wrap;}
.settings-grid{display:grid;grid-template-columns:1fr 1fr;gap:15px;min-height:0;}
@media (max-width: 980px){.settings-grid{grid-template-columns:1fr;}}

.settings-card{
  background:#fff;border:1px solid #e0e0e0;border-radius:18px;
  box-shadow:0 8px 24px rgba(0,0,0,0.06);
  padding:16px;
  min-height:0;position:relative;overflow:hidden;
}
.settings-card-head{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:12px;}
.sc-title{font-weight:900;color:#263238;}
.sc-btn{border:1px solid #cfd8dc;background:#fff;border-radius:10px;padding:8px 12px;cursor:pointer;font-weight:800;color:#37474f;}
.sc-btn.primary{background:var(--primary);border-color:var(--primary);color:#fff;}
.sc-btn:active{transform:translateY(1px);}

/* Options viewport: keep the "card backplate" generous, and rely on inner scrolling */
.options-list{
  border:1px solid #e6ecef;border-radius:16px;
  padding:14px;
  min-height:260px;
  max-height:min(56vh, 560px);
  overflow:hidden;overflow-y:auto;background:#f7fafb;
  -webkit-overflow-scrolling:touch;touch-action:pan-y;
  overscroll-behavior:contain;scrollbar-gutter:stable;
  margin-top:8px;
}

/* High-quality option "capsules" inside settings lists */
.opt-row{
  display:flex;align-items:center;gap:10px;
  background:#fff;border:1px solid #e3e7ea;border-radius:14px;
  padding:10px 12px;margin:0 0 10px 0;
  box-shadow:0 2px 10px rgba(0,0,0,0.04);
}
.opt-row.inactive{opacity:0.72;}
.opt-toggle{
  display:flex;align-items:center;gap:6px;flex:0 0 auto;
  font-size:12px;font-weight:900;color:#546e7a;
  background:#f2f5f7;border:1px solid #e3e7ea;
  padding:6px 8px;border-radius:999px;user-select:none;
}
.opt-toggle input{accent-color:var(--primary);transform:scale(1.05);}
.opt-name{
  flex:1 1 auto;min-width:140px;
  border:1px solid #e3e7ea;border-radius:12px;
  padding:8px 10px;background:#fff;
  font-weight:800;color:#263238;
}
.opt-name:focus{
  outline:none;border-color:rgba(0,137,123,0.55);
  box-shadow:0 0 0 3px rgba(0,137,123,0.12);
}
.opt-move{display:flex;gap:6px;flex:0 0 auto;}
.opt-icon-btn{
  width:38px;height:36px;
  display:flex;align-items:center;justify-content:center;
  border:1px solid #e3e7ea;background:#fff;border-radius:12px;
  cursor:pointer;
}
.opt-icon-btn:active{transform:translateY(1px);}
.opt-del{
  flex:0 0 auto;
  border:1px solid rgba(211,47,47,0.35);background:#fff;color:#d32f2f;
  font-weight:900;border-radius:12px;padding:8px 10px;cursor:pointer;
}
.opt-spacer{height:calc(var(--bottom-nav-height) + env(safe-area-inset-bottom) + 24px);}
@media (max-width:520px){
  .opt-row{gap:8px;padding:10px 10px;}
  .opt-name{min-width:0;}
  .opt-icon-btn{width:36px;height:34px;border-radius:12px;}
  .opt-del{padding:8px 10px;border-radius:12px;}
}

/* Health panel should not compress other cards; keep its own scroll area */
.health-panel{
  padding:6px 2px;
  display:flex;flex-direction:column;gap:10px;
  max-height:min(52vh, 560px);
  overflow-y:auto;
  -webkit-overflow-scrolling:touch;
  overscroll-behavior:contain;
}
.health-row{border:1px solid #eceff1;border-radius:14px;padding:10px 12px;background:#fafafa;}
.health-row.ok{border-color:#d0f2ea;background:#f3fffb;}
.health-row.warn{border-color:#ffe0b2;background:#fffaf3;}
.health-name{font-weight:900;color:#263238;display:flex;align-items:center;gap:6px;}
.health-meta{margin-top:6px;color:#607d8b;font-size:12px;line-height:1.4;}
.health-actions{margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;}
.health-badge{font-size:12px;font-weight:900;padding:4px 8px;border-radius:999px;border:1px solid #e0e0e0;background:#fff;color:#455a64;display:inline-flex;align-items:center;gap:4px;}
.health-badge.ok{border-color:#b2dfdb;background:#e0f2f1;color:#00695c;}
.health-badge.warn{border-color:#ffcc80;background:#fff3e0;color:#e65100;}

@media (max-width: 520px){
  #view-settings{ padding-bottom: calc(var(--bottom-nav-height) + env(safe-area-inset-bottom) + 22px); }
  .settings-card{ padding:16px; }
  .options-list{ min-height:240px; max-height:min(52vh, 520px); }
}


/* --- PWA INSTALL (Android + iOS guide) --- */
#installWidget{
  position: fixed;
  bottom: 135px;
  right: 20px;
  width: 45px;
  height: 45px;
  border-radius: 50%;
  background: #263238;
  color: #ffeb3b;
  box-shadow: 0 4px 12px rgba(0,0,0,0.25);
  display: none;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  z-index: 2000;
  -webkit-tap-highlight-color: transparent;
}
#installWidget:active{ transform: scale(0.92); }

#iosInstallPrompt{
  display:none;
  position: fixed;
  bottom: 26px;
  bottom: calc(26px + env(safe-area-inset-bottom));
  left: 50%;
  transform: translateX(-50%) translateY(18px);
  width: 92%;
  max-width: 380px;
  background: rgba(38, 50, 56, 0.95);
  backdrop-filter: blur(10px);
  color: #fff;
  border-radius: 16px;
  padding: 16px 18px 14px 18px;
  box-shadow: 0 10px 40px rgba(0,0,0,0.35);
  z-index: 6000;
  opacity: 0;
  transition: opacity .35s ease, transform .35s cubic-bezier(0.34, 1.56, 0.64, 1);
}
#iosInstallPrompt.visible{ display:block; }
#iosInstallPrompt.animate-in{ opacity:1; transform: translateX(-50%) translateY(0); }

#iosInstallPrompt .ios-close{
  position:absolute;
  top: 8px;
  right: 8px;
  width: 34px;
  height: 34px;
  border-radius: 50%;
  border: none;
  background: rgba(255,255,255,0.08);
  color: #cfd8dc;
  cursor: pointer;
}
#iosInstallPrompt .ios-close:active{ transform: scale(0.92); }

#iosInstallPrompt .ios-title{
  font-weight: 900;
  font-size: 14px;
  margin: 0 0 8px 0;
  letter-spacing: 0.5px;
}
#iosInstallPrompt .ios-text{
  font-size: 13px;
  line-height: 1.55;
  color: #fff;
}
#iosInstallPrompt .ios-sub{
  margin-top: 8px;
  font-size: 12px;
  color: #b0bec5;
}
#iosInstallPrompt .icon-anim{
  vertical-align: middle;
  font-size: 20px;
  color: #4fc3f7;
  margin: 0 3px;
  display:inline-block;
  animation: iconPulse 1.5s infinite ease-in-out;
}
@keyframes iconPulse{
  0%{ transform: scale(1); filter: drop-shadow(0 0 0 rgba(79,195,247,0)); }
  50%{ transform: scale(1.15); filter: drop-shadow(0 0 6px rgba(79,195,247,0.6)); }
  100%{ transform: scale(1); filter: drop-shadow(0 0 0 rgba(79,195,247,0)); }
}

/* --- SW UPDATE TOAST --- */
#updateToast{
  position: fixed;
  left: 50%;
  bottom: 82px;
  transform: translateX(-50%) translateY(40px);
  background: #37474f;
  color: #fff;
  border-radius: 999px;
  padding: 10px 14px;
  display: none;
  align-items: center;
  gap: 10px;
  z-index: 6100;
  box-shadow: 0 8px 28px rgba(0,0,0,0.28);
  font-weight: 800;
  font-size: 13px;
}
#updateToast.show{
  display:flex;
  transform: translateX(-50%) translateY(0);
}
#updateToast .btn-update{
  border:none;
  border-radius: 999px;
  padding: 5px 12px;
  background: #ffeb3b;
  color: #263238;
  font-weight: 900;
  cursor: pointer;
}
#updateToast .btn-update:active{ transform: scale(0.94); }
/* --- GLOBAL TOAST (é¿å…ç‰ˆé¢ä½ç§») --- */
#toast{
  position: fixed;
  left: 50%;
  bottom: 128px;
  transform: translateX(-50%) translateY(18px);
  opacity: 0;
  pointer-events: none;
  z-index: 6200;
  background: rgba(38,50,56,0.95);
  color: #fff;
  padding: 10px 14px;
  border-radius: 12px;
  box-shadow: 0 10px 28px rgba(0,0,0,0.30);
  font-weight: 800;
  font-size: 13px;
  max-width: min(92vw, 520px);
  text-align: center;
  line-height: 1.35;
}
#toast.show{
  opacity: 1;
  transform: translateX(-50%) translateY(0);
}
</style>
</head>
<body>

<div id="loading-mask">
  <div class="spinner"></div>
  <div id="loading-text" style="font-weight:700;color:#546e7a;font-size:15px">ç³»çµ±åˆå§‹åŒ– (V98.11.9)...</div>
</div>

<div id="restoreWidget" onclick="toggleRestoreList(event)">
    <span class="material-icons-round">visibility_off</span>
    <span id="hiddenCount">0</span>
    <div id="restoreList" onclick="event.stopPropagation()"></div>
</div>

<div id="toast" class="toast"></div>

<div id="installWidget" onclick="installApp(event)" title="å®‰è£åˆ°ä¸»ç•«é¢">
  <span class="material-icons-round">install_mobile</span>
</div>

<div id="iosInstallPrompt">
  <button class="ios-close" onclick="closeIosInstallPrompt()" aria-label="é—œé–‰">
    <span class="material-icons-round">close</span>
  </button>
  <div class="ios-title">åŠ å…¥ä¸»ç•«é¢ï¼ˆiPhone / iPadï¼‰</div>
  <div class="ios-text">
    é»æ“Šå·¥å…·åˆ—ä¸Šçš„ <span class="material-icons-round icon-anim">ios_share</span> åˆ†äº«<br>
    ä¸¦é¸æ“‡ <b>ã€ŒåŠ å…¥ä¸»ç•«é¢ã€</b>
  </div>
  </div>

<div id="updateToast">
  <span class="material-icons-round" style="color:#ffeb3b">system_update</span>
  <span>ç™¼ç¾æ–°ç‰ˆæœ¬</span>
  <button class="btn-update" onclick="updateApp()">æ›´æ–°</button>
</div>


<div id="scrollTopBtn" onclick="scrollToTop()">
    <span class="material-icons-round">arrow_upward</span>
</div>

<nav id="sidebar">
  <div class="brand">
    <span class="material-icons-round" style="color:var(--primary);background:#fff;border-radius:50%;padding:4px;">spa</span>
    <span>TTL Bio-Tech</span>
  </div>
  <div id="sidebarMeta" style="padding:0 20px 12px 20px;font-size:12px;color:#607d8b;">
    <div id="ordersGidHint" style="display:none;margin-bottom:6px;color:#c62828;font-weight:700;">
      å°šæœªå›ºå®š Orders åˆ†é  gidï¼šè«‹ç”¨ <span style="font-family:monospace;">?orders_gid=XXXX</span> é–‹å•Ÿä¸€æ¬¡å³å¯æ°¸ä¹…è¨˜ä½ã€‚
    </div>
    <div id="lastSyncText">æœ€å¾Œæ›´æ–°ï¼š--</div>
    <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap;">
      <button id="refreshNowBtn" style="border:1px solid #cfd8dc;background:#fff;border-radius:8px;padding:6px 10px;cursor:pointer;">ç«‹å³æ›´æ–°</button>
      <button id="logoutBtn" style="border:1px solid #cfd8dc;background:#fff;border-radius:8px;padding:6px 10px;cursor:pointer;">æ¸…é™¤å¯†ç¢¼</button>
    </div>
  </div>
  <div class="nav-item active" onclick="switchTab('dashboard')">
    <span class="material-icons-round">dashboard</span> ç¸½è¦½å„€è¡¨æ¿
  </div>
  <div class="nav-item" onclick="switchTab('inventory')">
    <span class="material-icons-round">inventory_2</span> åº«å­˜ç¸½è¡¨
  </div>
  <div class="nav-item" onclick="switchTab('sales')">
    <span class="material-icons-round">trending_up</span> éŠ·å”®ç¸½è¡¨
  </div>
  <div class="nav-item" onclick="switchTab('orders')">
    <span class="material-icons-round">edit_note</span> è¨‚å–®ç®¡ç†
  </div>
  <div class="nav-item" onclick="switchTab('settings')">
    <span class="material-icons-round">settings</span> ç³»çµ±è¨­å®š
  </div>
</nav>

<nav id="bottom-nav">
  <div class="b-nav-item active" onclick="switchTab('dashboard')">
    <span class="material-icons-round">dashboard</span> ç¸½è¦½
  </div>
  <div class="b-nav-item" onclick="switchTab('inventory')">
    <span class="material-icons-round">inventory_2</span> åº«å­˜
  </div>
  <div class="b-nav-item" onclick="switchTab('sales')">
    <span class="material-icons-round">trending_up</span> éŠ·å”®
  </div>
  <div class="b-nav-item" onclick="switchTab('orders')">
    <span class="material-icons-round">edit_note</span> è¨‚å–®
  </div>
  <div class="b-nav-item" onclick="switchTab('settings')">
    <span class="material-icons-round">settings</span> è¨­å®š
  </div>
</nav>

<div id="main">
  <header>
    <div class="header-left">
        <div id="backBtn" onclick="goBack()"><span class="material-icons-round" style="font-size:16px">arrow_back</span> è¿”å›</div>
        <span class="material-icons-round app-mark">spa</span>
        <span id="pageTitle">TTL Bio-Tech</span>
    </div>
    <div class="header-right">
        <div class="update-time" id="lastUpdate">--</div>
        <button id="refreshNowBtnMobile" class="icon-btn" title="é‡æ–°æ•´ç†" aria-label="é‡æ–°æ•´ç†">
            <span class="material-icons-round">refresh</span>
        </button>
        <button id="logoutBtnMobile" class="icon-btn" title="æ¸…é™¤å¯†ç¢¼" aria-label="æ¸…é™¤å¯†ç¢¼">
            <span class="material-icons-round">logout</span>
        </button>
    </div>
  </header>

  <div class="content-box">
    
    <div id="view-dashboard" class="view-section active" style="flex:1; display:flex; flex-direction:column; gap:15px; min-height:0;">
      <div class="kpi-row">
        <div class="kpi-card" onclick="navigateTo('orders', 'today')">
          <div class="kpi-info"><span class="kpi-label">ä»Šæ—¥ç‡Ÿæ”¶</span><div class="kpi-val" id="kpi-revenue">$0</div></div>
          <span class="material-icons-round kpi-icon">payments</span>
        </div>
        <div class="kpi-card" onclick="navigateTo('sales', '')">
          <div class="kpi-info"><span class="kpi-label">ä»Šå¹´éŠ·é‡</span><div class="kpi-val" id="kpi-year-sales">0</div></div>
          <span class="material-icons-round kpi-icon">leaderboard</span>
        </div>
        <div class="kpi-card alert" onclick="navigateTo('inventory', 'alert')">
          <div class="kpi-info">
            <span class="kpi-label">åº«å­˜è­¦ç¤º (ç¼º/ä½)</span>
            <div class="kpi-dual">
                <span style="color:var(--danger)">ğŸ”´ <span id="kpi-danger">0</span></span>
                <span style="color:var(--warning);margin-left:8px">ğŸŸ  <span id="kpi-warn">0</span></span>
            </div>
          </div>
          <span class="material-icons-round kpi-icon" style="color:var(--danger)">warning</span>
        </div>
        <div class="kpi-card" onclick="navigateTo('orders', 'all')">
          <div class="kpi-info"><span class="kpi-label">å¾…è™•ç†è¨‚å–®</span><div class="kpi-val" id="kpi-orders">0</div></div>
          <span class="material-icons-round kpi-icon">shopping_cart</span>
        </div>
      </div>

      <div class="dashboard-grid">
        <div class="chart-card stock-main">
          <div class="c-head">
            <span>ğŸ”¥ å®‰å…¨æ°´ä½ï¼šæœˆå‡éŠ·é‡TOP15</span>
            <div class="chart-toggles">
                <div id="ss-sort-qty" class="c-toggle-btn active" onclick="updateStockChartSort('qty')">ä¾éŠ·é‡</div>
                <div id="ss-sort-rev" class="c-toggle-btn" onclick="updateStockChartSort('rev')">ä¾éŠ·é¡</div>
            </div>
            <div class="see-more-btn" onclick="openFullChart('stock')">çœ‹æ›´å¤š <span class="material-icons-round" style="font-size:14px">arrow_forward</span></div>
          </div>
          <div class="legend-row">
            <div class="legend-box legend-compact">
                <span class="l-item"><div class="l-dot" style="background:#7b1fa2"></div>æ»¯éŠ·(â‰¥13)</span>
                <span class="l-item"><div class="l-dot" style="background:#4527a0"></div>ç©å£“(11-13)</span>
                <span class="l-item"><div class="l-dot" style="background:#388e3c"></div>å……è¶³(4-11)</span>
                <span class="l-item"><div class="l-dot" style="background:#0288d1"></div>ç•™æ„(3-4)</span>
                <span class="l-item"><div class="l-dot" style="background:#f57c00"></div>ä½ä½(2-3)</span>
                <span class="l-item"><div class="l-dot" style="background:#d32f2f"></div>ç¼ºè²¨(<2)</span>
            </div>
          </div>
          <div class="c-body" style="overflow-x:hidden;overflow-y:auto">
            <div id="stockChartContainer" style="position:relative;height:100%;width:100%">
                <canvas id="stockChart"></canvas>
            </div>
          </div>
        </div>

        <div class="chart-card alert-card">
            <div class="c-head">
               <span>âš¡ è£œè²¨å„ªå…ˆæ¸…å–® (ç¼º/ä½/ç•™æ„)</span>
               <div class="see-more-btn" onclick="navigateTo('inventory', 'alert')">çœ‹åº«å­˜ <span class="material-icons-round" style="font-size:14px">arrow_forward</span></div>
            </div>
            <div class="alert-body" id="alertListBox"></div>
          </div>

        <div class="chart-card overstock-card">
            <div class="c-head">
               <span>âš ï¸ æ»¯éŠ·/ç©å£“å“é … (Top 15)</span>
               <div class="chart-toggles">
                  <div id="os-sort-m" class="c-toggle-btn active" onclick="updateOverstockChartSort('months')">ä¾æœˆæ•¸</div>
                  <div id="os-sort-rev" class="c-toggle-btn" onclick="updateOverstockChartSort('rev')">ä¾éŠ·é¡</div>
              </div>
               <div class="see-more-btn" onclick="openFullChart('overstock')">çœ‹æ›´å¤š <span class="material-icons-round" style="font-size:14px">arrow_forward</span></div>
            </div>
            <div class="c-body overstock-layout">
               <div class="os-chart-area">
                  <div id="overstockChartContainer" style="position:relative;height:100%;width:100%">
                      <canvas id="overstockChart"></canvas>
                  </div>
               </div>
               <div class="os-list-area" id="osListControl"></div>
            </div>
          </div>
      </div>
    </div>

    <div id="view-full-chart" class="view-section">
        <div class="full-chart-header">
            <div style="display:flex;align-items:center;gap:10px">
                <span class="material-icons-round" style="cursor:pointer;color:#546e7a" onclick="closeFullChart()">arrow_back</span>
                <span style="font-weight:900;font-size:16px;color:#263238">å®Œæ•´åº«å­˜åˆ†æ</span>
            </div>
            <div class="fc-controls">
                <div id="fc-btn-stock" class="fc-toggle-btn active" onclick="switchFullChartMode('stock')">ä¾æœˆå‡éŠ·é‡</div>
                <div id="fc-btn-rev" class="fc-toggle-btn" onclick="switchFullChartMode('revenue')">ä¾éŠ·å”®è²¢ç»</div>
            </div>
        </div>
        <div class="full-chart-legend">
            <span class="l-item"><div class="l-dot" style="background:#7b1fa2"></div>æ»¯éŠ·(â‰¥13)</span>
            <span class="l-item"><div class="l-dot" style="background:#4527a0"></div>ç©å£“(11-13)</span>
            <span class="l-item"><div class="l-dot" style="background:#388e3c"></div>å……è¶³(4-11)</span>
            <span class="l-item"><div class="l-dot" style="background:#0288d1"></div>ç•™æ„(3-4)</span>
            <span class="l-item"><div class="l-dot" style="background:#f57c00"></div>ä½ä½(2-3)</span>
            <span class="l-item"><div class="l-dot" style="background:#d32f2f"></div>ç¼ºè²¨(<2)</span>
        </div>
        <div class="full-chart-body">
            <div class="full-chart-layout">
                <div class="full-chart-container" id="fcContainer">
                    <canvas id="fullChart"></canvas>
                </div>
                <div class="fc-side" id="fcSide">
                    <div class="fc-side-head">
                        <span>å“é …ï¼ˆå¯éš±è—ï¼‰</span>
                        <span style="font-size:12px;color:#90a4ae;font-weight:800">é»å“åå¯å®šä½</span>
                    </div>
                    <div class="fc-side-list" id="fullChartList"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="view-table-container" class="view-section" style="display:none; flex:1; flex-direction:column; min-height:0;">
      <div class="data-panel">
        <div class="panel-head">
          <div style="font-weight:700;color:var(--text-sub);display:none;" id="table-subtitle">åˆ—è¡¨</div>
          <div class="search-wrap">
            <span class="material-icons-round icon">search</span>
            <input id="tableSearch" type="text" placeholder="æœå°‹..." oninput="handleSearchInput()">
            <span id="searchClear" class="material-icons-round search-clear" onclick="clearSearch()">close</span>
          </div>
          <div class="panel-actions">
            <div id="filter-btn" class="filter-btn" onclick="openFilterSheet()"><span class="material-icons-round" style="font-size:20px">filter_alt</span></div>
            <div id="ordersAutoRefresh" class="oar" style="display:none;">
              <button id="oarToggle" class="oar-btn" onclick="toggleOrdersAutoRefresh()" title="è¨‚å–®è‡ªå‹•æ›´æ–°" aria-label="è¨‚å–®è‡ªå‹•æ›´æ–°">
                <span class="material-icons-round">autorenew</span>
              </button>
              <button id="oarInterval" class="oar-pill" onclick="cycleOrdersAutoInterval()" title="åˆ‡æ›è‡ªå‹•æ›´æ–°é–“éš”" aria-label="åˆ‡æ›è‡ªå‹•æ›´æ–°é–“éš”">120s</button>
            </div>
            <div id="mobile-sort-btn" onclick="openSortSheet()"><span class="material-icons-round" style="font-size:20px">sort</span></div>
            <span id="mobile-del-all" class="material-icons-round" style="display:none; color:#d32f2f; margin-left:10px; cursor:pointer;" onclick="deleteAllOrders()">delete_sweep</span>
          </div>
        </div>
        <div class="table-container" id="tableContainer">
          <table id="mainTable"></table>
          <div id="mobileCardContainer" class="mobile-card-container"></div>
        </div>
      </div>
    </div>


    <div id="view-settings" class="view-section" style="display:none; flex:1; flex-direction:column; gap:15px; min-height:0;">
      <div class="settings-topbar">
        <div>
          <div style="font-weight:900;color:#263238;font-size:16px;">ç³»çµ±è¨­å®š</div>
          <div style="color:#607d8b;font-size:12px;line-height:1.4;margin-top:4px;">
            ç®¡ç†å‰å°ã€Œéƒ¨é–€ã€èˆ‡ã€Œæ”¯ä»˜æ–¹å¼ã€ä¸‹æ‹‰é¸å–®ã€‚åœç”¨å¾Œå‰å°ä¸é¡¯ç¤ºï¼›æ­·å²è¨‚å–®ä»ä¿ç•™åŸå€¼ï¼Œé¿å…çµ±è¨ˆæ–·è£‚ã€‚
          </div>
        </div>
        <div class="settings-top-actions">
          <button class="sc-btn" onclick="reloadConfig()">é‡æ–°è¼‰å…¥</button>
          <button class="sc-btn primary" onclick="saveConfig()">å„²å­˜è®Šæ›´</button>
        </div>
      </div>

      <div class="settings-grid">
        <div class="settings-card">
          <div class="settings-card-head">
            <div class="sc-title">éƒ¨é–€é¸å–®</div>
            <button class="sc-btn" onclick="addOptionRow('departments')">æ–°å¢éƒ¨é–€</button>
          </div>
          <div id="deptOptionsList" class="options-list"></div>
        </div>

        <div class="settings-card">
          <div class="settings-card-head">
            <div class="sc-title">æ”¯ä»˜æ–¹å¼</div>
            <button class="sc-btn" onclick="addOptionRow('payments')">æ–°å¢æ”¯ä»˜æ–¹å¼</button>
          </div>
          <div id="payOptionsList" class="options-list"></div>
          <div style="margin-top:10px;color:#90a4ae;font-size:12px;line-height:1.4;">
            è¨»ï¼šåœç”¨çš„æ”¯ä»˜æ–¹å¼æœƒåœ¨æ­¤ä»¥åˆªé™¤ç·šé¡¯ç¤ºï¼Œå‰å°ä¸å†æä¾›é¸æ“‡ï¼ˆç¬¦åˆä½ æè¿°çš„ã€Œå‹¾é¸å¾Œæœƒç•«ä¸Šåˆªé™¤ç·šï¼Œä½¿ç”¨è€…ä¸èƒ½é¸æ“‡ã€æ•ˆæœï¼‰ã€‚
          </div>
        </div>
      </div>

      <div class="settings-card" style="border:1px solid #e0e0e0;">
        <div class="settings-card-head">
          <div class="sc-title">è³‡æ–™æºç‹€æ…‹</div>
          <div style="display:flex;gap:8px;align-items:center;">
            <button class="sc-btn" onclick="refreshHealthPanel()">åˆ·æ–°</button>
            <button class="sc-btn" onclick="clearHealth()">æ¸…é™¤ç´€éŒ„</button>
          </div>
        </div>
        <div id="healthPanel" class="health-panel"></div>
      </div>

      <div style="display:flex;align-items:center;justify-content:space-between;padding:10px 2px;">
        <div id="configStatus" style="color:#607d8b;font-size:12px;">ç‹€æ…‹ï¼š--</div>
        <div style="color:#b0bec5;font-size:12px;">è‡ªå‹•æ›´æ–°ï¼šå‰å°é‡æ–°æ•´ç†æˆ–é¦–æ¬¡è¼‰å…¥æ™‚æœƒæŠ“å–æœ€æ–°é¸å–®</div>
      </div>
    </div>

  </div>
</div>

<div id="sortSheet">
    <div style="font-weight:900;margin-bottom:15px;color:#263238;font-size:16px">æ’åºæ–¹å¼</div>
    <div id="sortOptions"></div>
    <div style="margin-top:20px;text-align:center;padding:12px;background:#f5f5f5;border-radius:8px;color:#546e7a;font-weight:700" onclick="closeSortSheet()">å–æ¶ˆ</div>
</div>

<div id="filterSheet">
    <div id="filterStatusHead" style="font-weight:900;margin-bottom:15px;color:#263238;font-size:16px;display:flex;justify-content:space-between">
        <span id="filterStatusTitle">ç‹€æ…‹ç¯©é¸ (å¯è¤‡é¸)</span>
        <span id="filterStatusAll" style="color:var(--primary);font-size:14px;cursor:pointer" onclick="toggleAllFilters(true,'status')">å…¨é¸</span>
    </div>
    <div id="filterOptions"></div>

    <div id="filterVisibilitySection" style="margin-top:16px;padding-top:12px;border-top:1px dashed #eee;">
        <div id="filterVisHead" style="font-weight:900;margin-bottom:15px;color:#263238;font-size:16px;display:flex;justify-content:space-between">
            <span id="filterVisTitle">é¡¯ç¤ºç¯©é¸ (å¯è¤‡é¸)</span>
            <span id="filterVisAll" style="color:var(--primary);font-size:14px;cursor:pointer" onclick="toggleAllFilters(true,'vis')">å…¨é¸</span>
        </div>
        <div id="visibilityOptions"></div>
    </div>

    <div style="display:flex;gap:10px;margin-top:20px;">
        <div style="flex:1;text-align:center;padding:12px;background:#f5f5f5;border-radius:8px;color:#546e7a;font-weight:700" onclick="closeFilterSheet()">å–æ¶ˆ</div>
        <div style="flex:1;text-align:center;padding:12px;background:var(--primary);border-radius:8px;color:#fff;font-weight:700" onclick="applyFilter()">ç¢ºå®š</div>
    </div>
</div>

<div id="sortOverlay" style="position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:2500;display:none" onclick="closeAllSheets()"></div>

<div id="editModal" class="modal">
  <div class="m-card">
    <div class="m-head"><span id="m-title">è¨‚å–®è©³æƒ…</span><span class="material-icons-round" style="cursor:pointer" onclick="history.back()">close</span></div>
    <div class="m-body">
      <input type="hidden" id="e-oid">
      <div class="m-form-row"><label class="m-label">å§“å</label><input class="m-input" id="e-name" disabled></div>
      <div class="m-form-row"><label class="m-label">éƒ¨é–€</label><input class="m-input" id="e-dept" disabled></div>
      <div class="m-form-row"><label class="m-label">å–è²¨</label><input class="m-input" id="e-pickup" disabled></div>
      <div class="m-form-row" id="e-pickup-info-row" style="display:none">
        <label class="m-label">å®…é…è³‡è¨Š</label>
        <div class="m-list" id="e-pickup-info" style="padding:10px;background:#fff3e0;border:1px solid #ffe0b2;color:#e65100;border-radius:8px;font-size:13px;line-height:1.4"></div>
      </div>
      <div class="m-form-row"><label class="m-label">å‚™è¨»</label><input class="m-input" id="e-note" disabled></div>
      <div class="m-form-row"><label class="m-label">å…§å®¹</label><div class="m-list" id="e-items"></div></div>
      <div style="text-align:right;color:var(--danger);font-weight:900;font-size:16px;">Total: $<span id="e-total">0</span></div>
    </div>
    <div class="m-foot" id="m-foot-view">
      <button class="m-btn normal" onclick="switchEditMode(true)">åˆ‡æ›ç·¨è¼¯</button>
    </div>
    <div class="m-foot" id="m-foot-edit" style="display:none">
      <button class="m-btn warn" style="margin-right:auto" onclick="deleteOrderAction()">åˆªé™¤</button>
      <button class="m-btn save" onclick="saveOrderAction()">å„²å­˜è®Šæ›´</button>
    </div>
  </div>
</div>

<div id="infoModal" class="modal">
  <div class="m-card">
    <div class="m-head"><span id="info-title">è©³ç´°è³‡è¨Š</span><span class="material-icons-round" style="cursor:pointer" onclick="history.back()">close</span></div>
    <div class="m-body" id="info-body"></div>
  </div>
</div>

<script>
let ADMIN_TOKEN = null;

// === Admin token (password) persistence ===
// Note: This only stores the token on THIS browser/device.
const TOKEN_STORAGE_KEY = 'ttlbiotech_admin_token_v1';
const TOKEN_EXPIRE_MS = 1000 * 60 * 60 * 24 * 30; // 30 days

function getSavedToken() {
  try {
    const raw = localStorage.getItem(TOKEN_STORAGE_KEY);
    if(!raw) return null;
    const obj = JSON.parse(raw);
    if(!obj || !obj.token || !obj.ts) return null;
    if(Date.now() - obj.ts > TOKEN_EXPIRE_MS) return null;
    return String(obj.token);
  } catch(e) {
    return null;
  }
}

function saveToken(token) {
  try {
    localStorage.setItem(TOKEN_STORAGE_KEY, JSON.stringify({ token: String(token), ts: Date.now() }));
  } catch(e) {}
}

// === Chart palette ===
// ç¾æœ‰åº«å­˜ï¼ˆçµ±ä¸€è‰²ï¼‰èˆ‡æœˆå‡éŠ·é‡ï¼ˆç°ï¼‰ç‚ºè¦–è¦ºåŸºæº–ï¼›ç‹€æ…‹é¡è‰²ç”¨åœ¨ã€Œå“åã€ä¸Š
const STOCK_UNI_COLOR = "#1e88e5";
const AVG_GRAY_COLOR = "#90a4ae";


function clearSavedToken() {
  try { localStorage.removeItem(TOKEN_STORAGE_KEY); } catch(e) {}
}

function promptForToken(force=false) {
  const saved = force ? null : getSavedToken();
  if(saved) return saved;

  const t = prompt("è«‹è¼¸å…¥å¾Œå°ç®¡ç†å¯†ç¢¼ï¼š");
  if(t && String(t).trim()) {
    saveToken(String(t).trim());
    return String(t).trim();
  }
  return null;
}

function denyAccessAndStop() {
  document.body.innerHTML = "<div style='display:flex;align-items:center;justify-content:center;height:100vh;color:red;font-weight:900;font-size:20px'>Access Denied</div>";
  throw new Error("Stop");
}

ADMIN_TOKEN = promptForToken(false);
if (!ADMIN_TOKEN) denyAccessAndStop();

const APP_VERSION = "98.11.9";
try{
  document.title = `TTL BIO-TECH æˆ°æƒ…ä¸­å¿ƒ V${APP_VERSION}`;
  const lt = document.getElementById('loading-text');
  if(lt) lt.textContent = `ç³»çµ±åˆå§‹åŒ– (V${APP_VERSION})...`;
} catch(e) {}

const GAS_URL = "https://script.google.com/macros/s/AKfycbxQ9Etloak3ZNv6yfyMCK9KbjoLyDqjRQHHVlASY5iMwwy_c4NCPxWpMK1YkzSXstHN/exec";
const SHEET_P_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQBtV8q3Ank7Bnhs83IbOb97U46juV-RKeL3NpdFiNcSu-ifI21fQYo1-io62S3JIrXEO5MiDArc1Lr/pub?gid=1623055155&single=true&output=csv";
let PRODUCT_BUNDLE_MAP = new Map(); // ç”¨ä¾†æŸ¥è¡¨è£œå…¨è³‡è¨Š
const ORDERS_CSV_BASE = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRIGbs4rMOfytnlajoBKcTZ5a0HhozeDAb2HMmsHsfUzfzrE0_O_y0QhhXD_SQjiwjoDKV_BJWoJwyp/pub?output=csv";
const DEFAULT_ORDERS_GID = "590994475"; // å›ºå®š Orders å·¥ä½œè¡¨ gidï¼ˆä¸€æ¬¡æ€§ä¿®æ­£ï¼Œé¿å…éš±æ€§é¢¨éšªï¼‰
const ORDERS_GID_STORAGE_KEY = 'ttlbiotech_orders_gid_v1';
function getOrdersGid() {
  try {
    const qs = new URLSearchParams(window.location.search);
    const q = qs.get('orders_gid');
    if(q && String(q).trim()) { localStorage.setItem(ORDERS_GID_STORAGE_KEY, String(q).trim()); return String(q).trim(); }
    const s = localStorage.getItem(ORDERS_GID_STORAGE_KEY);
    if(s && String(s).trim()) return String(s).trim();
  } catch(e) {}
  return null;
}
function buildCsvUrl(baseUrl, gid) {
  const u = new URL(baseUrl);
  u.searchParams.set('output','csv');
  u.searchParams.set('single','true');
  if(gid) u.searchParams.set("gid", String(gid));
  return u.toString();
}
function getOrdersCsvUrl() {
  // å„ªå…ˆé †åºï¼šURL ?orders_gid=xxxxï¼ˆæœƒå¯«å…¥ localStorageï¼‰ > localStorage > å›ºå®š DEFAULT_ORDERS_GID
  const explicit = getOrdersGid();
  const gid = explicit || DEFAULT_ORDERS_GID;
  const url = buildCsvUrl(ORDERS_CSV_BASE, gid);

  // æ—¢ç„¶å·²å›ºå®š gidï¼Œå°±ä¸å†æç¤ºä½¿ç”¨è€…
  const hint = document.getElementById("ordersGidHint");
  if(hint) hint.style.display = "none";

  return url;
}
const INVENTORY_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ7k1DqiuXajsGDzeprSAwhj5NEW5DdZLXV3eSRYvAFUmpC16tygyD5bjwEtndESJFzjQ0NrTzxTZ2P/pub?gid=1142644042&single=true&output=csv";
const SALES_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQj5QLrtaWikGcLNwMawbjiN8ZQDgFzW1RV7UECFgLzECWj16I2ugE_B6tzzLICCynsk1L6lAuJfccS/pub?gid=93142219&single=true&output=csv";

let DATA = { orders: [], inventory: [], sales: [], soldMap: {} };

// ===== Settings Config (Departments / Payments) =====
let CONFIG_DATA = { departments: [], payments: [] };
let SETTINGS_LOADED = false;

let CURRENT_TAB = 'dashboard'; 
let ACTIVE_FILTER = ''; 
let AUTO_EXPAND_CODE = null; 
let SORT = { key: null, asc: true };
let HIDDEN_STOCK = new Set(JSON.parse(localStorage.getItem('admin_hidden_stock') || '[]'));
let CHARTS = {};
let PENDING_SEARCH = null; 

let SS_SORT_MODE = 'qty';
let OS_SORT_MODE = 'months';

const ALL_STATUSES = ['ç¼ºè²¨', 'ä½ä½', 'ç•™æ„', 'å……è¶³', 'ç©å£“', 'æ»¯éŠ·'];
let SELECTED_STATUSES = new Set(ALL_STATUSES);
let SELECTED_ORDER_FILTERS = new Set(JSON.parse(localStorage.getItem('admin_order_filters') || '[]'));
// Visibility Filter (Hidden / Visible) - V96
const VISIBILITY_OPTIONS = [
  { k: 'visible', l: 'ééš±è—' },
  { k: 'hidden',  l: 'éš±è—' }
];
const DEFAULT_VIS_SET = ['visible'];
let SELECTED_VISIBILITY = {
  inventory: new Set(JSON.parse(localStorage.getItem('admin_visibility_filter_inventory') || '["visible"]')),
  sales: new Set(JSON.parse(localStorage.getItem('admin_visibility_filter_sales') || '["visible"]'))
};
function ensureVisibilitySet(tab) {
  if(!SELECTED_VISIBILITY[tab] || !(SELECTED_VISIBILITY[tab] instanceof Set)) SELECTED_VISIBILITY[tab] = new Set(DEFAULT_VIS_SET);
  if(SELECTED_VISIBILITY[tab].size === 0) SELECTED_VISIBILITY[tab] = new Set(DEFAULT_VIS_SET);
}
function getVisibilityKey(code) { return HIDDEN_STOCK.has(String(code)) ? 'hidden' : 'visible'; }
function isVisibilityAllowed(tab, code) {
  ensureVisibilitySet(tab);
  return SELECTED_VISIBILITY[tab].has(getVisibilityKey(code));
}
function setEquals(aSet, arrDefault) {
  const bSet = new Set(arrDefault);
  if(aSet.size !== bSet.size) return false;
  for(const v of aSet) if(!bSet.has(v)) return false;
  return true;
}

let FULL_CHART_MODE = 'stock';
let FULL_CHART_SOURCE = 'stock'; 

function normalizeStr(s) {
  // Robust normalization: remove whitespace + common punctuation (including fullwidth)
  return String(s || "")
    .replace(/[\s\u3000]+/g, '')
    .replace(/[\(\)\ï¼ˆ\ï¼‰\[\]ã€ã€‘ã€Œã€ã€ã€ã€Šã€‹<>\-ï¼â€“â€”_+ï¼‹=~`!ï¼?ï¼Ÿ:ï¼š;ï¼›,ï¼Œ.ã€‚\/ï¼\\|ï½œ\"'â€œâ€â€˜â€™Â·â€¢]+/g, '')
    .toLowerCase();
}

function normCode(c){
  return String(c||'').trim().replace(/[ï¼â€“â€”]/g,'-').replace(/\s+/g,'');
}
function baseCode(c){
  const s = normCode(c);
  return s.replace(/-\d+$/,'');
}
function getSalesRowByCode(code){
  try{
    if(!DATA || !DATA.salesMap) return null;
    const n = normCode(code);
    return DATA.salesMap.get(n) || DATA.salesMap.get(baseCode(n)) || null;
  }catch(e){ return null; }
}
function getTodayDigits() {
    const d = new Date();
    return `${d.getFullYear()}${String(d.getMonth()+1).padStart(2,'0')}${String(d.getDate()).padStart(2,'0')}`;
}

async function init() {
  try {
    // V2 Sprint1: staged loading
    // - core (orders/inventory/sales) renders ASAP
    // - product bundle map loads in parallel and enhances UI after
    const prodsPromise = fetchCSV(SHEET_P_CSV, { healthKey: 'products' })
      .then(prods => { processProducts(prods); return true; })
      .catch(e => { console.warn('Product CSV load failed:', e); return false; });

    const [ord, inv, sales] = await Promise.all([
      fetchCSV(getOrdersCsvUrl(), { healthKey: 'orders' }),
      fetchCSV(INVENTORY_CSV, { healthKey: 'inventory' }),
      fetchCSV(SALES_CSV, { healthKey: 'sales' })
    ]);

    processOrders(ord);
    processInventory(inv);
    processSales(sales);
    updateDashboard();
    
    // V69: Force Title Update
    switchTab('dashboard', false); 
    
    // V80: Force Filter Init to prevent empty table
    SELECTED_STATUSES = new Set(ALL_STATUSES);
    
    document.getElementById('lastUpdate').innerText = "æ›´æ–°: " + new Date().toLocaleTimeString();
    showLoading(false);

    // V2 Sprint1: if products load completes after core render, re-render tables to apply mappings
    prodsPromise.then(ok => {
      if(ok) {
        try { if(typeof renderCurrentTable === 'function') renderCurrentTable(); } catch(e) {}
      }
    });

    updateRestoreWidget();
    try{ updateRestoreWidgetVisibility(CURRENT_TAB); }catch(e){}
    
    const viewDash = document.getElementById('view-dashboard');
    const onScroll = (e) => {
        const top = e.target.scrollTop || window.scrollY;
        document.getElementById('scrollTopBtn').style.display = top > 300 ? 'flex' : 'none';
    };
    window.addEventListener('scroll', onScroll); 
    viewDash.addEventListener('scroll', onScroll); 
    
    // V86: Add scroll listener to table container
    const tableContainer = document.querySelector('.table-container');
    if(tableContainer) {
        tableContainer.addEventListener('scroll', onScroll);
    }

    window.addEventListener('popstate', (e) => {
        const state = e.state || {};
        if(document.getElementById('infoModal').classList.contains('open') && !state.modal) { closeInfoModal(false); return; }
        if (document.getElementById('editModal').classList.contains('open') && !state.modal) { closeModal(false); return; }
        if(document.getElementById('view-full-chart').style.display === 'flex' && !state.fullchart) { closeFullChart(false); return; }

        const expandedCard = document.querySelector('.mc-expand-content.open');
        if (expandedCard) {
            const expandedId = expandedCard.id.replace('mc-ex-', '');
            if (!state.expand || state.expand !== expandedId) {
                expandedCard.classList.remove('open');
                const card = document.getElementById('card-' + expandedId);
                if(card) card.classList.remove('highlight-flash');
            }
        }
        
        if (state.expand) {
            const targetDetail = document.getElementById('mc-ex-' + state.expand);
            if (targetDetail && !targetDetail.classList.contains('open')) {
                targetDetail.classList.add('open');
                const card = document.getElementById('card-' + state.expand);
                if(card) {
                    card.scrollIntoView({behavior: "smooth", block: "center"});
                    card.classList.add('highlight-flash');
                }
            }
        }

        if (state.tab) {
            switchTab(state.tab, false); 
        } else {
            switchTab('dashboard', false);
        }
    });
    history.replaceState({tab: 'dashboard'}, '', '');

  } catch(e) { alert("è³‡æ–™ç•°å¸¸: " + e.message); }
}

function scrollToTop() {
    if(window.innerWidth<=768 && CURRENT_TAB==='dashboard') document.getElementById('view-dashboard').scrollTo({top:0, behavior:'smooth'});
    else if(document.getElementById('view-full-chart').style.display==='flex') document.querySelector('.full-chart-body').scrollTo({top:0, behavior:'smooth'});
    else if(document.querySelector('.table-container') && document.querySelector('.table-container').scrollTop > 0) document.querySelector('.table-container').scrollTo({top:0, behavior:'smooth'});
    else window.scrollTo({top:0, behavior:'smooth'});
}


// === Data Source Health (forç¶­é‹) ===
const HEALTH_LS_KEY = 'ttl_admin_data_health_v1';
let DATA_HEALTH = (() => {
  try { return JSON.parse(localStorage.getItem(HEALTH_LS_KEY) || '{}') || {}; }
  catch(e){ return {}; }
})();

function recordHealth(key, ok, detail){
  if(!key) return;
  const now = Date.now();
  if(!DATA_HEALTH[key]) DATA_HEALTH[key] = { okCount:0, failCount:0, lastOk:0, lastFail:0, lastError:'' };
  const it = DATA_HEALTH[key];
  if(ok){
    it.okCount = (it.okCount||0) + 1;
    it.lastOk = now;
    it.lastError = '';
  } else {
    it.failCount = (it.failCount||0) + 1;
    it.lastFail = now;
    it.lastError = String(detail || '');
  }
  try{ localStorage.setItem(HEALTH_LS_KEY, JSON.stringify(DATA_HEALTH)); }catch(e){}
  try{
    if(typeof CURRENT_TAB !== 'undefined' && CURRENT_TAB === 'settings') renderHealthPanel();
  }catch(e){}
}

function _fmtHealthTime(ts){
  if(!ts) return '--';
  try{ return new Date(ts).toLocaleString(); }catch(e){ return '--'; }
}

function renderHealthPanel(){
  const el = document.getElementById('healthPanel');
  if(!el) return;
  const items = [
    ['orders','Ordersï¼ˆè¨‚å–®ï¼‰'],
    ['inventory','Inventoryï¼ˆåº«å­˜ï¼‰'],
    ['sales','Salesï¼ˆéŠ·å”®ï¼‰'],
    ['products','Productsï¼ˆå•†å“ï¼‰'],
    ['config','Configï¼ˆä¸‹æ‹‰é¸å–®ï¼‰'],
  ];
  const rows = items.map(([k,label])=>{
    const it = DATA_HEALTH[k] || {};
    const okAt = _fmtHealthTime(it.lastOk);
    const failAt = _fmtHealthTime(it.lastFail);
    const failCnt = it.failCount || 0;
    const okCnt = it.okCount || 0;
    const status = (failCnt>0 && (!it.lastOk || it.lastFail>it.lastOk)) ? 'warn' : 'ok';
    const badge = status==='ok' ? 'OK' : 'WARN';
    const err = (status==='warn' && it.lastError) ? `<div class="health-err">${escapeHtml(it.lastError).slice(0,120)}</div>` : '';
    return `<div class="health-row ${status}">
      <div class="health-name">${label}<span class="health-badge ${status}">${badge}</span></div>
      <div class="health-meta">
        <div>æˆåŠŸï¼š${okAt}ï¼ˆ${okCnt}ï¼‰</div>
        <div>å¤±æ•—ï¼š${failAt}ï¼ˆ${failCnt}ï¼‰</div>
        ${err}
      </div>
    </div>`;
  }).join('');
  el.innerHTML = rows || "<div style='color:#90a4ae;font-weight:800;padding:10px'>å°šç„¡ç´€éŒ„</div>";
}

function clearHealth(){
  DATA_HEALTH = {};
  try{ localStorage.removeItem(HEALTH_LS_KEY); }catch(e){}
  renderHealthPanel();
  showToast('å·²æ¸…é™¤è³‡æ–™æºç‹€æ…‹ç´€éŒ„');
}


async function refreshHealthPanel(){
  // Manual probe of all data sources (records health, doesn't mutate DATA)
  try{
    showToast('åˆ·æ–°è³‡æ–™æºç‹€æ…‹ä¸­â€¦', 1200);

    const tasks = [
      fetchCSV(getOrdersCsvUrl(), { cacheBust: true, healthKey: 'orders' }).catch(()=>null),
      fetchCSV(INVENTORY_CSV, { cacheBust: true, healthKey: 'inventory' }).catch(()=>null),
      fetchCSV(SALES_CSV, { cacheBust: true, healthKey: 'sales' }).catch(()=>null),
      fetchCSV(SHEET_P_CSV, { cacheBust: true, healthKey: 'products' }).catch(()=>null),
      (async()=>{
        const t0 = performance.now();
        try{
          const res = await gasFetch({ action: "get_config" }, false);
          if(res && res.ok){
            recordHealth('config', true, `ok ${(performance.now()-t0).toFixed(0)}ms`);
          } else {
            recordHealth('config', false, (res && (res.error || res.message)) ? (res.error || res.message) : 'bad response');
          }
        }catch(e){
          recordHealth('config', false, e && e.message ? e.message : String(e));
        }
      })()
    ];

    await Promise.allSettled(tasks);
    renderHealthPanel();
    showToast('å·²åˆ·æ–°è³‡æ–™æºç‹€æ…‹');
  }catch(e){
    console.error('refreshHealthPanel failed', e);
    showToast('åˆ·æ–°å¤±æ•—');
  }
}



async function fetchCSV(url, opts = {}) {
  const cacheBust = opts.cacheBust !== false;
  const healthKey = opts.healthKey || null;
  let finalUrl = url;
  try {
    const u = new URL(url);
    if(cacheBust) u.searchParams.set('_', Date.now().toString());
    finalUrl = u.toString();
  } catch(e) {
    // keep original url
  }

  const t0 = performance.now();
  try{
    const res = await fetch(finalUrl, { cache: 'no-store' });
    if (!res.ok) throw new Error("HTTP " + res.status);
    const txt = await res.text();
    const data = Papa.parse(txt, { header: false }).data;
    recordHealth(healthKey, true, `ok ${(performance.now()-t0).toFixed(0)}ms`);
    return data;
  } catch(err){
    recordHealth(healthKey, false, err && err.message ? err.message : String(err));
    throw err;
  }
}


function showLoading(show, text) {
    const el = document.getElementById('loading-mask');
    if(show) { el.style.display = 'flex'; if(text) document.getElementById('loading-text').innerText = text; } 
    else { el.style.display = 'none'; }
}


function processProducts(rows) {
    try {
        PRODUCT_BUNDLE_MAP.clear();
        if(!rows || rows.length < 2) return;

        const header = rows[0] || [];

        // Helper: find first matching header index (case-insensitive)
        const findIdx = (cands) => {
            const lower = header.map(h => (h || "").toString().trim().toLowerCase());
            for (const c of cands) {
                const i = lower.indexOf(c.toLowerCase());
                if (i !== -1) return i;
            }
            return -1;
        };

        const idxCode = findIdx(['product_code','code','sku','å“è™Ÿ','æ–™è™Ÿ']);
        const idxPName = findIdx(['product_name','name','å“å','å•†å“åç¨±']);
        const idxBundleSummary = findIdx(['bundle_summary','bundle','bundle_items','bundle_content','çµ„åˆå…§å®¹','å…§å®¹ç‰©','çµ„åˆåŒ…å…§å®¹']);

        if(idxCode === -1 && idxPName === -1) {
            console.warn("[Products] No product_code / product_name column found; bundle auto-fix disabled.");
            return;
        }

        // Build code -> name map (helps when spec columns store codes rather than names)
        const codeToName = new Map();
        if(idxCode !== -1 && idxPName !== -1) {
            rows.slice(1).forEach(r => {
                const c = (r[idxCode] || "").toString().trim();
                const n = (r[idxPName] || "").toString().trim();
                if(c && n) codeToName.set(c, n);
            });
        }

        // Detect spec-like columns: spec_1/spec_1_name, bundle_1, item_1 ... with optional qty columns
        const groups = new Map(); // n -> {nameIdx, qtyIdx}
        header.forEach((h, i) => {
            const key = (h || "").toString().trim();

            // name columns
            let m = key.match(/^(spec|bundle|item)[\s_-]?(\d+)(?:_name)?$/i);
            if(m) {
                const n = Number(m[2]);
                if(!groups.has(n)) groups.set(n, {});
                const g = groups.get(n);
                if(g.nameIdx === undefined) g.nameIdx = i;
                return;
            }

            // qty columns
            m = key.match(/^(spec|bundle|item)[\s_-]?(\d+)[\s_-]?(?:qty|quantity|count|æ•¸é‡)$/i);
            if(m) {
                const n = Number(m[2]);
                if(!groups.has(n)) groups.set(n, {});
                const g = groups.get(n);
                if(g.qtyIdx === undefined) g.qtyIdx = i;
                return;
            }
        });

        const orderedNs = [...groups.keys()].sort((a,b)=>a-b);

        const normalizeKey = (s) => normalizeStr((s || "").toString().trim().replace(/[()ï¼ˆï¼‰ã€ã€‘\[\]ã€Œã€ã€ã€ã€Šã€‹<>]/g, ''));

        const translateToken = (t) => {
            let s = (t || "").toString().trim();
            if(!s) return "";

            // If like "CODE Name" (e.g., "375358-12 VINATAç·Šç·»æ´»è†šè† å›Š", "gift-1 ä¸‰åˆä¸€æ¯è“‹åˆ·"), strip the leading CODE
            const m = s.match(/^(\S+)\s+(.+)$/);
            if(m) {
                const head = m[1];
                const tail = m[2];
                if(/^\d{4,}[A-Za-z]*-\d+[A-Za-z]*$/i.test(head) || /^gift-\d+$/i.test(head) || /^set-\d+$/i.test(head)) {
                    s = tail.trim();
                }
            }

            // If it is a pure code, translate to product_name
            if(codeToName.has(s)) s = codeToName.get(s);

            // Remove gift prefix for clean stats
            s = s.replace(/^(?:è´ˆå“|è´ˆ|Gift)[:\s|ï½œ_]*/i, "").trim();
            return s;
        };

        rows.slice(1).forEach(r => {
            const code = idxCode !== -1 ? (r[idxCode] || "").toString().trim() : "";
            const pnRaw = idxPName !== -1 ? (r[idxPName] || "").toString().trim() : "";

            // 1) Prefer explicit bundle_summary if available
            let summary = "";
            if(idxBundleSummary !== -1) summary = (r[idxBundleSummary] || "").toString().trim();

            if(summary) {
                // If bundle_summary contains codes separated by |, translate into names when possible
                summary = summary.split('|').map(s => translateToken(s)).filter(Boolean).join('|');
            }

            // 2) Otherwise, build from spec columns (support qty)
            if(!summary) {
                const bundleItems = [];
                orderedNs.forEach(n => {
                    const g = groups.get(n) || {};
                    let name = g.nameIdx !== undefined ? (r[g.nameIdx] || "").toString().trim() : "";
                    if(!name) return;

                    // translate codes to product names when possible
                    name = translateToken(name);

                    let q = 1;
                    if(g.qtyIdx !== undefined) {
                        const qRaw = (r[g.qtyIdx] || "").toString().trim();
                        const qNum = parseInt(qRaw, 10);
                        if(!isNaN(qNum) && qNum > 0) q = qNum;
                    }
                    // Repeat by qty so existing split('|') logic can count correctly
                    for(let i=0; i<q; i++) bundleItems.push(name);
                });
                if(bundleItems.length > 0) summary = bundleItems.join('|');
            }

            if(!summary) return;

            // Main key: product_code
            if(code) PRODUCT_BUNDLE_MAP.set(code, summary);

            // Secondary key: product_name (normalized) for legacy payloads missing code
            if(pnRaw) PRODUCT_BUNDLE_MAP.set(normalizeKey(pnRaw), summary);
        });

        console.log(`[Products] Bundle map ready: ${PRODUCT_BUNDLE_MAP.size} entries`);
    } catch(e) {
        console.warn("processProducts error:", e);
    }
}


// è«‹æ›¿æ› manage_ttlbiotech_f3p4.html ä¸­çš„ processOrders å‡½å¼
function processOrders(rows) {
  DATA.soldMap = {};
  // GAS V3.7+ çµæ§‹: 
  // Col 0:ID, 1:Time, 2:Name, 3:Dept, 4:PayMethod, 5:Note, 6:Base, 7:Disc, 8:Total, 9:DiscNote, 10:Pickup, 11:JSON
  DATA.orders = rows.slice(1).map(r => {
    const safe = (i) => (r[i] !== undefined && r[i] !== null) ? String(r[i]) : "";
    let rawJson = null;
    
    // [Fix] å˜—è©¦è®€å– JSONï¼ŒåŒ…å«é˜²å‘†
    try { 
        if(safe(11) && safe(11).startsWith('{')) {
            rawJson = JSON.parse(safe(11)); 
        } else if (safe(10) && safe(10).startsWith('{')) {
            // å‘ä¸‹ç›¸å®¹èˆŠè³‡æ–™
            rawJson = JSON.parse(safe(10));
        }
    } catch(e) { console.warn("JSON Parse Error", r[0]); }
    
    // å»ºç«‹éŠ·é‡ Map
    if (rawJson) {
        if(rawJson.items) rawJson.items.forEach(it => { const code = it.product_code || it.product_name; if(code) DATA.soldMap[code] = (DATA.soldMap[code] || 0) + (it.qty || 0); });
        // è´ˆå“çµ±è¨ˆé‚è¼¯ï¼Œç§»é™¤ [è´ˆ] å‰ç¶´
        if(rawJson.gifts) rawJson.gifts.forEach(g => { 
            let code = g.product_code || g.product_name;
            code = code.replace(/^\[è´ˆå“\]\s*/, '').replace(/^\[Gift\]\s*/i, '');
            if(code) DATA.soldMap[code] = (DATA.soldMap[code] || 0) + (g.qty || 0); 
        });
    }
    
    // [Fix] è®€å– Pickup
    let pickup = safe(10); 
    if(pickup.includes('{') || !pickup) pickup = "è‡ªå–"; // é˜²å‘†
    
    return { 
        id: safe(0), 
        time: safe(1), 
        name: safe(2), 
        dept: safe(3), 
        note: safe(5), 
        total: Number(safe(8).toString().replace(/,/g, '')) || 0, 
        pickup: pickup,
        raw: rawJson 
    };
  }).filter(o => o.id); // éæ¿¾æ‰æ²’æœ‰ ID çš„ç©ºè¡Œ
}

// V82: Strict V69 Core Logic
function processInventory(rows) {
  if(rows.length < 2) return;
  const header = (rows[0]||[]).map(h => String(h || "").replace(/[\r\n]+/g, '').trim());
  const idxCode = 0; const idxName = 1; const idxCat = 3; const idxStock = 12; const idxSupply = 13; 
  let idxAvg = header.findIndex(h => h.includes("å‡éŠ·") || h.includes("æœˆå‡"));
  if(idxAvg === -1 && rows[0].length > 14) idxAvg = 14; 

  const idxMonthAccum = header.findIndex(h => h.includes("æœ¬æœˆç´¯ç©"));
  
  const regionHeaders = []; const infoHeaders = [];
  for(let i=0; i<header.length; i++) {
      let label = header[i] || "";
      if(label.includes("åˆ°æœŸæ—¥")) label = "åˆ°æœŸæ—¥ (æœ€è¿‘)";
      if(label.includes("æ•ˆæœŸå¤©æ•¸")) label = "æ•ˆæœŸå¤©æ•¸ (æœ€å°)";
      // V95 Fix: Change index from 15 to 14 to include Column O in regions
      if(i >= 14 && header[i]) regionHeaders.push({ name: header[i], idx: i }); 
      else if(i < 14 && i !== idxCode && i !== idxName && i !== idxCat && i !== idxStock && i !== idxSupply && header[i]) infoHeaders.push({ name: label, idx: i });
  }
  DATA.inventory = rows.slice(1).map(r => {
    const code = (r[idxCode]||"").trim(); const name = (r[idxName]||"").trim();
    if(!code && !name) return null;
    const cat = r[idxCat] || "";
    const stock = Number((r[idxStock] || "0").replace(/,/g, '')) || 0;
    let avg = idxAvg > -1 ? Number((r[idxAvg] || "0").replace(/,/g, '')) : 0;
    if(!isFinite(avg)) avg = 0;
    const avgValid = avg > 0;
    let supplyMonths = Number((r[idxSupply] || "0").replace(/,/g, ''));
    if(!isFinite(supplyMonths)) supplyMonths = 0;
    const supplyMonthsDisplay = avgValid ? supplyMonths : 'â€”';
    const monthAccum = idxMonthAccum > -1 ? Number((r[idxMonthAccum] || "0").replace(/,/g, '')) : 0;
    const reserved = DATA.soldMap[code] || DATA.soldMap[name] || 0;
    const available = stock - reserved;
    
    // V83: Precise Status Assignment
    let status = 'å……è¶³', statusClass = 'st-ok', statusColor = '#388e3c', statusVal = 0;
    if (available <= 0) { status = 'ç¼ºè²¨'; statusClass = 'st-err'; statusColor = '#d32f2f'; statusVal=5; }
    else if (!avgValid) { status = 'å……è¶³'; statusClass = 'st-ok'; statusColor = '#388e3c'; statusVal=1; }
    else if (supplyMonths < 2) { status = 'ç¼ºè²¨'; statusClass = 'st-err'; statusColor = '#d32f2f'; statusVal=4; }
    else if (supplyMonths < 3) { status = 'ä½ä½'; statusClass = 'st-warn'; statusColor = '#f57c00'; statusVal=3; }
    else if (supplyMonths < 4) { status = 'ç•™æ„'; statusClass = 'st-high'; statusColor = '#0288d1'; statusVal=2; } 
    else if (supplyMonths >= 13) { status = 'æ»¯éŠ·'; statusClass = 'st-dead'; statusColor = '#7b1fa2'; statusVal=0; }
    else if (supplyMonths >= 11) { status = 'ç©å£“'; statusClass = 'st-dead'; statusColor = '#4527a0'; statusVal=1; }
    else { status = 'å……è¶³'; statusClass = 'st-ok'; statusColor = '#388e3c'; statusVal=1; }
    
    return { code, name, cat, stock, avg, supplyMonths, supplyMonthsDisplay, monthAccum, monthDiff: monthAccum - avg, reserved, available, status, statusClass, statusColor, statusVal, regions: regionHeaders.map(rh => ({ name: rh.name, qty: Number((r[rh.idx] || "0").replace(/,/g, '')) || 0 })).filter(re => re.qty !== 0), info: infoHeaders.map(ih => ({ name: ih.name, val: r[ih.idx] })) };
  }).filter(x => x);
}

// V79: Revert to V69's Robust Logic
function processSales(rows) {
  // Robust header/data-start detection for QUERY outputs (prevents skipping the first data row)
  const clean = (v) => (v || "").toString().trim();
  const looksLikeCode = (v) => /^\d{6,}(-\d+)?$/.test(clean(v));

  // 1) Prefer explicit header row containing "ç‰©æ–™/æ–™è™Ÿ"
  let headerIdx = -1;
  for (let i = 0; i < Math.min(rows.length, 20); i++) {
    const r = rows[i] || [];
    const a0 = clean(r[0]);
    if (a0.includes("ç‰©æ–™") || a0.includes("æ–™è™Ÿ")) { headerIdx = i; break; }
    // 2) Fallback: row that looks like a header (years + sales keywords)
    const s = JSON.stringify(r);
    if ((s.includes("å¯¦éŠ·") || s.includes("é‡‘é¡")) && (s.includes("2024") || s.includes("2025"))) { headerIdx = i; break; }
  }

  // Determine where actual data starts
  let dataStart = -1;
  if (headerIdx >= 0) {
    dataStart = headerIdx + 1;
  } else {
    // Fallback: find first row that looks like a SKU + name
    for (let i = 0; i < rows.length; i++) {
      const r = rows[i] || [];
      const a = clean(r[0]);
      const b = clean(r[1]);
      if (looksLikeCode(a) && b) { dataStart = i; break; }
    }
    if (dataStart < 0) dataStart = 0;
  }

  const nameToCodeMap = new Map();
  DATA.inventory.forEach(i => nameToCodeMap.set(normalizeStr(i.name), i.code));

  const num = (x) => (Number((x || "0").toString().replace(/,/g, '')) || 0);

  DATA.sales = [];
  for (let i = dataStart; i < rows.length; i++) {
    const r = rows[i] || [];
    const rawCode = clean(r[0]);
    const rawName = clean(r[1] || r[0] || "");
    if (!rawCode && !rawName) continue;
    if (rawCode.includes("ç‰©æ–™") || rawCode.includes("æ–™è™Ÿ")) continue;

    const matchedCode = nameToCodeMap.get(normalizeStr(rawName));
    const code = matchedCode || normCode(rawCode || "-");
    if (!code) continue;

    const lastRev = num(r[2]);
    const thisRev = num(r[3]);
    const lastQty = num(r[4]);
    const thisQty = num(r[5]);
    const yoyVal = lastRev > 0 ? ((thisRev - lastRev) / lastRev * 100) : (thisRev > 0 ? 100 : 0);
    const yoy = Number(yoyVal.toFixed(1));

    DATA.sales.push({ code, name: rawName || "", lastRev, thisRev, lastQty, thisQty, yoy });
  }

  // Build lookup map for robust code matching
  DATA.salesMap = new Map();
  DATA.sales.forEach(s => {
    const k = normCode(s.code);
    if (k) DATA.salesMap.set(k, s);
    const b = baseCode(s.code);
    if (b && !DATA.salesMap.has(b)) DATA.salesMap.set(b, s);
  });
}



function switchTab(tab, pushToHistory = true, preserveState = false) {
    // V96 UX: allow sidebar tab switch even when full chart is open
    const fcView = document.getElementById('view-full-chart');
    if(fcView && fcView.style.display === 'flex') { fcView.style.display = 'none'; }

    if(pushToHistory && tab !== CURRENT_TAB) history.pushState({tab: tab}, '', '');
    const rl = document.getElementById('restoreList'); if(rl) rl.classList.remove('open');
    
    CURRENT_TAB = tab; ACTIVE_FILTER = '';
    try{ applyOrdersAutoRefresh(); }catch(e){}
    // Mobile layout classes (avoid top blank + enable dashboard scrolling)
    try{
        const cb = document.querySelector('.content-box');
        if(cb && window.innerWidth <= 768){
            cb.classList.toggle('mobile-dashboard', tab === 'dashboard');
            cb.classList.toggle('dashboard-scroll', tab === 'dashboard');
            cb.classList.toggle('mobile-table', ['inventory','sales','orders'].includes(tab));
            if(tab !== 'dashboard') cb.classList.remove('dashboard-scroll');
        } else if(cb){
            cb.classList.remove('mobile-dashboard');
            cb.classList.remove('mobile-table');
            cb.classList.remove('dashboard-scroll');
        }
    }catch(e){}

    if(!preserveState) { AUTO_EXPAND_CODE = null; }

    // V94: Set Default Sort per Tab (Auto Sort) - Logic Added
    if (tab === 'sales') SORT = { key: 'yoy', asc: false }; // YoY descending
    else if (tab === 'inventory') SORT = { key: 'stock', asc: false }; // Stock descending
    else if (tab === 'orders') SORT = { key: 'time', asc: false }; // Time descending (newest first)
    else SORT = { key: null, asc: true };

    document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.b-nav-item').forEach(el => el.classList.remove('active'));
    const map = {'dashboard':0, 'inventory':1, 'sales':2, 'orders':3, 'settings':4};
    if(document.querySelectorAll('.nav-item')[map[tab]]) document.querySelectorAll('.nav-item')[map[tab]].classList.add('active');
    if(document.querySelectorAll('.b-nav-item')[map[tab]]) document.querySelectorAll('.b-nav-item')[map[tab]].classList.add('active');
    
    if(window.innerWidth <= 768) {
        document.getElementById('pageTitle').innerText = (tab === 'dashboard') ? 'TTL Bio-Tech' : {'orders':'è¨‚å–®ç®¡ç†', 'inventory':'åº«å­˜ç¸½è¡¨', 'sales':'éŠ·å”®ç¸½è¡¨', 'settings':'ç³»çµ±è¨­å®š'}[tab];
    } else {
        document.getElementById('pageTitle').innerText = (tab === 'dashboard') ? 'ç¸½è¦½å„€è¡¨æ¿' : {'orders':'è¨‚å–®ç®¡ç†', 'inventory':'åº«å­˜ç¸½è¡¨', 'sales':'éŠ·å”®ç¸½è¡¨', 'settings':'ç³»çµ±è¨­å®š'}[tab];
    }
    
    document.getElementById('filter-btn').style.display = (tab === 'inventory' || tab === 'orders' || tab === 'sales') ? 'flex' : 'none';
    // V96: update filter button active state per tab
    const fbtn = document.getElementById('filter-btn');
    if(tab === 'inventory') {
        fbtn.classList.toggle('active', (SELECTED_STATUSES.size !== ALL_STATUSES.length) || !setEquals(SELECTED_VISIBILITY.inventory, DEFAULT_VIS_SET));
    } else if(tab === 'sales') {
        fbtn.classList.toggle('active', !setEquals(SELECTED_VISIBILITY.sales, DEFAULT_VIS_SET));
    } else if(tab === 'orders') {
        fbtn.classList.toggle('active', (SELECTED_ORDER_FILTERS.size > 0));
    } else {
        fbtn.classList.remove('active');
    }


    const backBtn = document.getElementById('backBtn');

    // Hide all sections first
    document.getElementById('view-dashboard').style.display = 'none';
    document.getElementById('view-table-container').style.display = 'none';
    const settingsView = document.getElementById('view-settings');
    if (settingsView) settingsView.style.display = 'none';

    if (tab === 'settings') {
        if (settingsView) settingsView.style.display = 'flex';
        backBtn.style.display = 'flex';
        document.getElementById('filter-btn').style.display = 'none';
        updateRestoreWidgetVisibility('settings');
        ensureSettingsLoaded();
        try{ renderHealthPanel(); }catch(e){}
        return;
    }

    if (tab === 'dashboard') {
        document.getElementById('view-dashboard').style.display = 'flex';
        backBtn.style.display = 'none';
        updateDashboard();
        updateRestoreWidgetVisibility('dashboard');
    } else {
        document.getElementById('view-table-container').style.display = 'flex';
        if (!PENDING_SEARCH && !preserveState) { 
            document.getElementById('tableSearch').value = "";
            handleSearchInput();
        }
        backBtn.style.display = 'flex';
        renderCurrentTable();
        updateRestoreWidgetVisibility(tab);
    }
}

function goBack() {
    if (history.state && history.state.tab !== 'dashboard') { history.back(); } else { switchTab('dashboard'); }
}

function navigateTo(tab, filter) {
    switchTab(tab); ACTIVE_FILTER = filter; 
    if (filter === 'alert') {
        SELECTED_STATUSES = new Set(['ç¼ºè²¨', 'ä½ä½']);
    } else {
        SELECTED_STATUSES = new Set(ALL_STATUSES);
    }
    
    if (filter === 'today') {
        PENDING_SEARCH = getTodayDigits(); 
    }
    renderCurrentTable();
}

function navigateToProduct(code, name) {
    PENDING_SEARCH = code; 
    AUTO_EXPAND_CODE = code;
    // V82 Fix: Reset Filter to allow navigation
    SELECTED_STATUSES = new Set(ALL_STATUSES);
    document.querySelectorAll('.filter-chk').forEach(c => c.checked = true);
    document.getElementById('filter-btn').classList.remove('active');
    
    switchTab('inventory', true, true); 
    
    setTimeout(() => {
        renderCurrentTable();
        
        setTimeout(() => {
            if(window.innerWidth <= 768) {
                const card = document.getElementById('card-' + code);
                if(card) {
                    card.scrollIntoView({behavior: "smooth", block: "center"});
                    card.classList.add('highlight-flash');
                    const detail = document.getElementById('mc-ex-' + code);
                    if(detail) detail.classList.add('open');
                }
            } else {
                const row = document.querySelector('tr.active-row');
                if(row) row.scrollIntoView({behavior: "smooth", block: "center"});
            }
        }, 300);
    }, 100);
}

function handleSearchInput() {
    const val = document.getElementById('tableSearch').value;
    document.getElementById('searchClear').style.display = val.length > 0 ? 'block' : 'none';
    renderCurrentTable();
}
function clearSearch() {
    document.getElementById('tableSearch').value = '';
    handleSearchInput();
}

/* Full Chart Logic */
function openFullChart(source) {
    FULL_CHART_SOURCE = source; 
    if(source === 'stock') FULL_CHART_MODE = 'stock';
    else FULL_CHART_MODE = 'months';
    
    document.getElementById('view-full-chart').style.display = 'flex';
    document.getElementById('view-dashboard').style.display = 'none';
    history.pushState({fullchart: true}, '', '');
    
    if (source === 'stock') {
        document.getElementById('fc-btn-stock').innerText = "ä¾æœˆå‡éŠ·é‡";
        document.getElementById('fc-btn-rev').innerText = "ä¾éŠ·å”®è²¢ç»";
    } else {
        document.getElementById('fc-btn-stock').innerText = "ä¾é ä¼°æœˆæ•¸";
        document.getElementById('fc-btn-rev').innerText = "ä¾éŠ·å”®è²¢ç»";
    }
    switchFullChartMode(FULL_CHART_MODE);
}

function closeFullChart(goBackHist = true) {
    document.getElementById('view-full-chart').style.display = 'none';
    document.getElementById('view-dashboard').style.display = 'flex';
    if(goBackHist && history.state && history.state.fullchart) history.back();
}

function switchFullChartMode(mode) {
    FULL_CHART_MODE = mode;
    document.querySelectorAll('.fc-toggle-btn').forEach(b => b.classList.remove('active'));
    if(mode === 'stock' || mode === 'months') document.getElementById('fc-btn-stock').classList.add('active');
    else document.getElementById('fc-btn-rev').classList.add('active');
    renderFullChart();
}


function calcChartXMin(values) {
    const nums = (values || []).filter(v => typeof v === 'number' && isFinite(v));
    if(nums.length === 0) return 0;
    const mn = Math.min(...nums);
    return mn < 0 ? mn : 0;
}

function renderFullChart() {
    let items = [];
    DATA.inventory.forEach(i => {
        const s = getSalesRowByCode(i.code) || { thisRev: 0 };
        i.tempRev = s.thisRev;
    });

    if (FULL_CHART_SOURCE === 'stock') {
        items = DATA.inventory.filter(i => !String(i.cat).includes("è´ˆå“") && !HIDDEN_STOCK.has(i.code));
    } else {
        items = DATA.inventory.filter(i => i.supplyMonths >= 11 && !String(i.cat).includes("è´ˆå“") && !HIDDEN_STOCK.has(i.code));
    }

    if (FULL_CHART_MODE === 'revenue') {
        items.sort((a,b) => b.tempRev - a.tempRev);
    } else {
        if (FULL_CHART_SOURCE === 'stock') {
            items.sort((a,b) => b.avg - a.avg);
        } else {
            items.sort((a,b) => b.supplyMonths - a.supplyMonths);
        }
    }

    const container = document.getElementById('fcContainer');
    const height = Math.max(items.length * 40, 400); 
    container.style.height = height + 'px';
    
    if(CHARTS.full) CHARTS.full.destroy();
    
    const ctx = document.getElementById('fullChart').getContext('2d');
    
    // V94: Smart Label Wrapping (14 chars)
    const formatLabel = (label) => {
        if(window.innerWidth > 768) return label; // Desktop: No wrap
        const chunk = 14; 
        const res = [];
        for(let i=0; i<label.length; i+=chunk) {
            res.push(label.substring(i, i+chunk));
        }
        return res;
    };
    let chartConfig = {};
    
    if (FULL_CHART_SOURCE === 'stock') {
        chartConfig = {
            type: 'bar',
            data: {
                labels: items.map(i => formatLabel(i.name)),
                datasets: [
                    { label: 'ç¾æœ‰åº«å­˜ (M)', data: items.map(i => i.stock), backgroundColor: Array(items.length).fill('#1e88e5'), order: 2, barPercentage: 0.6 },
                    { label: 'æœˆå‡éŠ·é‡', data: items.map(i => i.avg), backgroundColor: Array(items.length).fill('#90a4ae'), barPercentage: 0.4, order: 1 }
                ]
            },
            options: {
                indexAxis: 'y', responsive: true, maintainAspectRatio: false,
                layout: { padding: { left: 0, right: 30 } },
                scales: { x: { min: calcChartXMin(items.flatMap(i => [i.stock, i.avg])), position: 'top' }, y: { ticks: { color: (ctx) => (items[ctx.index] ? items[ctx.index].statusColor : '#263238'), autoSkip: false, font: { size: 14, weight:'bold' } } } },
                plugins: { 
                    tooltip: { callbacks: { title: (c) => items[c[0].dataIndex].name } } 
                },
                onClick: (e, els) => handleChartClick(e, els, items)
            }
        };
    } else {
        const isRev = FULL_CHART_MODE === 'revenue';
        chartConfig = {
            type: 'bar',
            data: {
                labels: items.map(i => formatLabel(i.name)),
                datasets: [{
                    label: isRev ? 'ä»Šå¹´ç‡Ÿæ”¶ ($)' : 'é ä¼°å¯ä¾›éŠ·æœˆæ•¸',
                    data: items.map(i => isRev ? i.tempRev : i.supplyMonths),
                    backgroundColor: items.map(i => i.statusColor),
                    barPercentage: 0.7
                }]
            },
            options: {
                indexAxis: 'y', responsive: true, maintainAspectRatio: false,
                layout: { padding: { left: 10, right: 20 } },
                scales: { x: { min: calcChartXMin(items.map(i => isRev ? i.tempRev : i.supplyMonths)), position: 'top' }, y: { ticks: { color: (ctx) => (items[ctx.index] ? items[ctx.index].statusColor : '#263238'), autoSkip: false, font: { size: 14, weight:'bold' } } } },
                plugins: {
                    tooltip: {
                        callbacks: {
                            title: (c) => items[c[0].dataIndex].name,
                            label: (c) => isRev ? `ç‡Ÿæ”¶: $${c.raw.toLocaleString()}` : `å¯ä¾›: ${c.raw} æœˆ`,
                            afterLabel: (c) => isRev ? `å¯ä¾›: ${items[c.dataIndex].supplyMonths} æœˆ` : `ç‡Ÿæ”¶: $${items[c.dataIndex].tempRev.toLocaleString()}`
                        }
                    }
                },
                onClick: (e, els) => handleChartClick(e, els, items)
            }
        };
    }
    
    CHARTS.full = new Chart(ctx, chartConfig);
    try{ renderFullChartList(items); }catch(e){}
}


function renderFullChartList(items){
    const list = document.getElementById('fullChartList');
    if(!list) return;

    const isStock = (FULL_CHART_SOURCE === 'stock');
    const isRevMode = (FULL_CHART_MODE === 'revenue');

    const fmtMonth = (n) => {
        if(typeof n !== 'number' || !isFinite(n)) return 'â€”';
        const v = Math.round(n*10)/10;
        return String(v).replace(/\.0$/,'');
    };
    const fmtInt = (n) => {
        if(typeof n !== 'number' || !isFinite(n)) return 'â€”';
        return Math.round(n).toLocaleString();
    };
    const fmtMoney = (n) => {
        if(typeof n !== 'number' || !isFinite(n)) return 'â€”';
        return '$' + Math.round(n).toLocaleString();
    };

    const safeItems = (items || []).slice(0, 220);

    list.innerHTML = safeItems.map(i => {
        const code = escapeHtml(String(i.code));
        const name = escapeHtml(String(i.name || i.code));
        const color = i.statusColor || '#546e7a';

        let pills = '';
        if(isStock){
            const sm = fmtMonth(i.supplyMonths);
            if(isRevMode){
                pills += `<span class="fc-pill">${fmtMoney(i.tempRev)}</span>`;
                pills += `<span class="fc-pill">å¯ä¾› ${sm}æœˆ</span>`;
            } else {
                const avgVal = (typeof i.avg === 'number' && isFinite(i.avg) && i.avg > 0) ? fmtInt(i.avg) : 'â€”';
                pills += `<span class="fc-pill">åº«å­˜ ${fmtInt(i.stock)}</span>`;
                pills += `<span class="fc-pill">æœˆå‡ ${avgVal}</span>`;
                pills += `<span class="fc-pill">å¯ä¾› ${sm}æœˆ</span>`;
            }
        } else {
            const sm = fmtMonth(i.supplyMonths);
            if(isRevMode){
                pills += `<span class="fc-pill">${fmtMoney(i.tempRev)}</span>`;
                pills += `<span class="fc-pill">å¯ä¾› ${sm}æœˆ</span>`;
            } else {
                pills += `<span class="fc-pill">å¯ä¾› ${sm}æœˆ</span>`;
                pills += `<span class="fc-pill">${fmtMoney(i.tempRev)}</span>`;
            }
        }

        return `
        <div class="fc-item" onclick="navigateToProduct('${code}','')">
            <div class="fc-item-left">
                <div class="fc-item-name" style="color:${color}">${name}</div>
                <div class="fc-item-meta">${pills}</div>
            </div>
            <span class="material-icons-round fc-hide" onclick="event.stopPropagation(); toggleHidden('${code}')" title="éš±è—æ­¤å“é …">visibility_off</span>
        </div>`;
    }).join('');
}

function handleChartClick(e, els, items) {
    if(els.length > 0) {
        const item = items[els[0].index];
        if(confirm(`å°èˆªè‡³ "${item.name}"ï¼Ÿ\n(å–æ¶ˆå‰‡éš±è—æ­¤é …ç›®)`)) {
            closeFullChart(false);
            navigateToProduct(item.code, item.name);
        } else {
            toggleHidden(item.code);
        }
    }
}

function updateStockChartSort(mode) {
    SS_SORT_MODE = mode;
    document.getElementById('ss-sort-qty').classList.toggle('active', mode==='qty');
    document.getElementById('ss-sort-rev').classList.toggle('active', mode==='rev');
    updateDashboard();
}

function updateOverstockChartSort(mode) {
    OS_SORT_MODE = mode;
    document.getElementById('os-sort-m').classList.toggle('active', mode==='months');
    document.getElementById('os-sort-rev').classList.toggle('active', mode==='rev');
    updateDashboard();
}

function updateDashboard() {
    const todayDigits = getTodayDigits();
    const isMobile = window.innerWidth <= 768;
    const todayOrders = DATA.orders.filter(o => o.id.includes(todayDigits) || o.time.replace(/\D/g, '').startsWith(todayDigits));
    
    document.getElementById('kpi-revenue').innerText = "$" + todayOrders.reduce((a,b) => a + b.total, 0).toLocaleString();
    document.getElementById('kpi-orders').innerText = DATA.orders.length;
    const dangerCount = DATA.inventory.filter(i => i.status === 'ç¼ºè²¨').length;
    const warnCount = DATA.inventory.filter(i => i.status === 'ä½ä½').length;
    document.getElementById('kpi-danger').innerText = dangerCount;
    document.getElementById('kpi-warn').innerText = warnCount;
    if(dangerCount+warnCount > 0) document.querySelector('.kpi-card.alert').style.border = "2px solid var(--danger)";
    document.getElementById('kpi-year-sales').innerText = DATA.sales.reduce((a,b) => a + b.thisQty, 0).toLocaleString();

    if(CHARTS.stock) CHARTS.stock.destroy();
    if(CHARTS.overstock) CHARTS.overstock.destroy();

    // V94: Smart Label Wrapping for Dashboard (14 chars)
    const formatLabel = (label) => {
        if(!isMobile) return label.length > 12 ? label.substring(0,12)+'...' : label;
        const chunk = 14; // Reduced to 14
        const res = [];
        for(let i=0; i<label.length; i+=chunk) {
            res.push(label.substring(i, i+chunk));
        }
        return res;
    };

    DATA.inventory.forEach(i => {
        const s = getSalesRowByCode(i.code) || { thisRev: 0 };
        i.tempRev = s.thisRev;
    });

    let safetyItems = DATA.inventory.filter(i => !String(i.cat).includes("è´ˆå“") && !HIDDEN_STOCK.has(i.code));
    
    if (SS_SORT_MODE === 'qty') {
        safetyItems.sort((a,b) => b.avg - a.avg);
    } else {
        // V72: Fix 0 Revenue Sort
        safetyItems = safetyItems.filter(i => i.tempRev > 0).sort((a,b) => b.tempRev - a.tempRev);
    }
    safetyItems = safetyItems.slice(0, 15);
    
    // V88: Compact Height (-25%) -> 600px from 800px
    const chartHeight = isMobile ? '600px' : '100%'; 
    document.getElementById('stockChartContainer').style.height = chartHeight;

    CHARTS.stock = new Chart(document.getElementById('stockChart'), {
        type: 'bar',
        data: {
            labels: safetyItems.map(i => formatLabel(i.name)),
            datasets: [
                { label: 'ç¾æœ‰åº«å­˜ (M)', data: safetyItems.map(i => i.stock), backgroundColor: Array(safetyItems.length).fill(STOCK_UNI_COLOR), order: 2, barPercentage: 0.6 },
                { label: 'æœˆå‡éŠ·é‡', data: safetyItems.map(i => i.avg), backgroundColor: Array(safetyItems.length).fill(AVG_GRAY_COLOR), barPercentage: 0.4, order: 1 }
            ]
        },
        options: { 
            indexAxis: 'y', responsive:true, maintainAspectRatio:false,
            layout: { padding: { left: 5, right: 60 } }, 
            scales: { x: { beginAtZero: true }, y: { ticks: { color: (ctx) => (safetyItems[ctx.index] ? safetyItems[ctx.index].statusColor : '#263238'), font: { weight: 'bold', size: isMobile?11:14, lineHeight: 1.2 }, autoSkip: false } } },
            plugins: { 
                tooltip: { 
                    callbacks: { 
                        title: (items) => safetyItems[items[0].dataIndex].name,
                        afterBody: (items) => SS_SORT_MODE === 'rev' ? `ğŸ’° ä»Šå¹´ç‡Ÿæ”¶: $${(safetyItems[items[0].dataIndex].tempRev || 0).toLocaleString()}` : ''
                    } 
                } 
            },
            onClick: (e, els) => { if(els.length > 0) navigateToProduct(safetyItems[els[0].index].code, safetyItems[els[0].index].name); }
        }
    });

    let overstockItems = DATA.inventory.filter(i => (i.supplyMonths >= 11) && !String(i.cat).includes("è´ˆå“") && !HIDDEN_STOCK.has(i.code));
    
    if (OS_SORT_MODE === 'months') {
        overstockItems.sort((a,b) => b.supplyMonths - a.supplyMonths);
    } else {
        overstockItems = overstockItems.filter(i => i.tempRev > 0).sort((a,b) => b.tempRev - a.tempRev);
    }
    overstockItems = overstockItems.slice(0, 15);
    
    document.getElementById('overstockChartContainer').style.height = chartHeight;

    const isRev = OS_SORT_MODE === 'rev';
    // V98.9.1: draw values next to bars (replace cramped side list)
    const osValueLabelPlugin = {
        id: 'osValueLabelPlugin',
        afterDatasetsDraw(chart, args, opts) {
            try {
                const {ctx, chartArea} = chart;
                if(!chartArea) return;
                const right = chartArea.right;
                const meta = chart.getDatasetMeta(0);
                const ds = chart.data.datasets[0];
                ctx.save();
                ctx.textBaseline = 'middle';
                ctx.fillStyle = '#455a64';
                ctx.font = (opts && opts.font) ? opts.font : (isMobile ? '700 11px Noto Sans TC' : '700 12px Noto Sans TC');
                meta.data.forEach((bar, i) => {
                    const raw = ds.data[i];
                    if(raw === null || raw === undefined || !isFinite(raw)) return;
                    const valText = (isRev) ? ('$' + Number(raw).toLocaleString()) : (Number(raw).toFixed(1).replace(/\.0$/,'') + 'æœˆ');
                    let x = (bar.x || 0) + 6;
                    const y = (bar.y || 0);
                    const w = ctx.measureText(valText).width;
                    if(x + w > right - 2) x = right - w - 2;
                    ctx.fillText(valText, x, y);
                });
                ctx.restore();
            } catch(e) {}
        }
    };

CHARTS.overstock = new Chart(document.getElementById('overstockChart'), {
        plugins: [osValueLabelPlugin],
        type: 'bar',
        data: {
            labels: overstockItems.map(i => formatLabel(i.name)),
            datasets: [{
                label: isRev ? 'ä»Šå¹´ç‡Ÿæ”¶ ($)' : 'é ä¼°å¯ä¾›éŠ·æœˆæ•¸',
                data: overstockItems.map(i => isRev ? i.tempRev : i.supplyMonths),
                backgroundColor: overstockItems.map(i => i.statusColor) 
            }]
        },
        options: { 
            responsive:true, maintainAspectRatio:false, indexAxis: 'y',
            layout: { padding: { left: 5, right: 60 } },
            scales: { y: { ticks: { color: (ctx) => (overstockItems[ctx.index] ? overstockItems[ctx.index].statusColor : '#263238'), font: { weight: 'bold', size: isMobile?11:14, lineHeight: 1.2 }, autoSkip: false } } },
            plugins: { 
                tooltip: { 
                    callbacks: { 
                        title: (c) => overstockItems[c[0].dataIndex].name,
                        label: (c) => isRev ? `ç‡Ÿæ”¶: $${c.raw.toLocaleString()}` : `å¯ä¾›: ${c.raw} æœˆ`,
                        afterLabel: (c) => isRev ? `å¯ä¾›: ${overstockItems[c.dataIndex].supplyMonths} æœˆ` : `ç‡Ÿæ”¶: $${overstockItems[c.dataIndex].tempRev.toLocaleString()}`
                    } 
                } 
            },
            onClick: (e, els) => { if(els.length > 0) navigateToProduct(overstockItems[els[0].index].code, overstockItems[els[0].index].name); }
        }
    });
    // V98.9.1: remove side list (values rendered on bars)
    try{ const osBox=document.getElementById('osListControl'); if(osBox) osBox.innerHTML=''; }catch(e){}
    renderQuickAlerts();
}

function splitLabel(str) { return str.length > 18 ? [str.substring(0, 18), str.substring(18, 36) + (str.length>36?'...':'')] : str; }

// V83: Fixed Toggle logic to update specific button without full re-render
window.toggleHidden = function(code) { 
    if(HIDDEN_STOCK.has(code)) HIDDEN_STOCK.delete(code); else HIDDEN_STOCK.add(code); 
    localStorage.setItem('admin_hidden_stock', JSON.stringify([...HIDDEN_STOCK]));
    // UX: toast
    try{ showToast((HIDDEN_STOCK.has(code)?'å·²éš±è— ':'å·²é¡¯ç¤º ') + getNameByCode(code)); }catch(e){} 
    
    updateDashboard(); 
    updateRestoreWidgetVisibility(CURRENT_TAB);
    
    // Immediate Visual Update
    const btnM = document.querySelector(`#card-${code} .mc-icon-btn.hide`);
    if(btnM) btnM.classList.toggle('active', HIDDEN_STOCK.has(code));
    
    const btnD = document.querySelector(`#row-${code} .mc-icon-btn.hide`);
    if(btnD) btnD.classList.toggle('active', HIDDEN_STOCK.has(code));

    
    // V96: Re-render list to reflect visibility filter immediately
    if(CURRENT_TAB === 'inventory' || CURRENT_TAB === 'sales') { renderCurrentTable(); }
if(document.getElementById('view-full-chart').style.display === 'flex') renderFullChart();
}

function showToast(msg, ms=1800){
    const t = document.getElementById('toast');
    if(!t) return;
    t.textContent = msg;
    t.classList.add('show');
    clearTimeout(window.__toastTimer);
    window.__toastTimer = setTimeout(()=>{ t.classList.remove('show'); }, ms);
}
function getNameByCode(code){
    const inv = (DATA && DATA.inventory) ? DATA.inventory.find(i=>String(i.code)===String(code)) : null;
    if(inv && inv.name) return inv.name;
    const sa = getSalesRowByCode(code);
    if(sa && sa.name) return sa.name;
    return String(code);
}

// Close hidden list when clicking outside
document.addEventListener('click', function(){
    const rl = document.getElementById('restoreList');
    if(rl && rl.classList.contains('open')) rl.classList.remove('open');
});

function updateRestoreWidget() {
    try{ if(CURRENT_TAB === 'settings' || CURRENT_TAB === 'orders') {
        const widget=document.getElementById('restoreWidget');
        const list=document.getElementById('restoreList');
        if(widget) widget.style.display='none';
        if(list) list.classList.remove('open');
        return;
    } }catch(e){}
    const widget = document.getElementById('restoreWidget');
    const list = document.getElementById('restoreList');
    const count = HIDDEN_STOCK.size;
    document.getElementById('hiddenCount').innerText = count;
    
    if (count > 0) {
        widget.style.display = 'flex';
        let html = '';
        HIDDEN_STOCK.forEach(code => {
            const item = DATA.inventory.find(i => i.code === code) || { name: code };
            html += `<div class="restore-item"><span>${item.name}</span><span class="restore-btn" onclick="event.stopPropagation(); toggleHidden('${code}')">é‚„åŸ</span></div>`;
        });
        list.innerHTML = html;
    } else {
        widget.style.display = 'none';
        list.classList.remove('open');
    }
}

function updateRestoreWidgetVisibility(activeTab){
    const widget = document.getElementById('restoreWidget');
    const list = document.getElementById('restoreList');
    if(!widget) return;
    if(activeTab === 'settings' || activeTab === 'orders'){
        widget.style.display = 'none';
        if(list) list.classList.remove('open');
        return;
    }
    updateRestoreWidget();
}

function toggleRestoreList(e) {
    document.getElementById('restoreList').classList.toggle('open');
    e.stopPropagation();
}

function renderOverstockControl(activeItems) {
    // V98.9.1: side list removed to avoid cramped duplicate names
    const box = document.getElementById('osListControl');
    if(box) box.innerHTML = '';
}

function renderQuickAlerts() {
    const box = document.getElementById('alertListBox');
    if(!box) return;
    const severity = { 'ç¼ºè²¨': 0, 'ä½ä½': 1, 'ç•™æ„': 2 };
    const items = (DATA.inventory || [])
        .filter(i => !HIDDEN_STOCK.has(i.code) && !String(i.cat).includes('è´ˆå“') && ['ç¼ºè²¨','ä½ä½','ç•™æ„'].includes(i.status))
        .sort((a,b) => {
            // Primary: æœˆå‡éŠ·é‡ (desc)
            const aa = (typeof a.avg === 'number' && isFinite(a.avg)) ? a.avg : -1;
            const bb = (typeof b.avg === 'number' && isFinite(b.avg)) ? b.avg : -1;
            if(bb !== aa) return bb - aa;
            // Secondary: ç‹€æ…‹åš´é‡åº¦
            const sa = severity[a.status] ?? 9;
            const sb = severity[b.status] ?? 9;
            if(sa !== sb) return sa - sb;
            // Tertiary: å¯ä¾›æœˆæ•¸ (asc)
            const ma = (typeof a.supplyMonths === 'number' && isFinite(a.supplyMonths)) ? a.supplyMonths : 9999;
            const mb = (typeof b.supplyMonths === 'number' && isFinite(b.supplyMonths)) ? b.supplyMonths : 9999;
            return ma - mb;
        })
        .slice(0, 12);

    if(items.length === 0) {
        box.innerHTML = `<div style="color:#90a4ae;font-weight:900;font-size:13px;padding:10px 4px;">ç›®å‰ç„¡åº«å­˜è­¦ç¤º ğŸ‰</div>`;
        return;
    }

    box.innerHTML = items.map(i => {
        const avg = (typeof i.avg === 'number' && isFinite(i.avg) && i.avg > 0) ? i.avg : 'â€”';
        return `
        <div class="alert-row" onclick="navigateToProduct('${escapeHtml(i.code)}','')">
            <div class="alert-top">
            <div class="alert-name" style="color:${i.statusColor}">${escapeHtml(i.name)}</div>
            <span class="material-icons-round alert-hide" onclick="event.stopPropagation(); toggleHidden('${escapeHtml(i.code)}')" title="éš±è—æ­¤å“é …">visibility_off</span>
            </div>
            <div class="alert-meta">
                <span class="alert-badge" style="background:${i.statusColor}">${escapeHtml(i.status)}</span>
                <span class="alert-num">åº«å­˜ ${escapeHtml(i.stock)}</span>
                <span class="alert-num">æœˆå‡ ${escapeHtml(avg)}</span>
            </div>
        </div>`;
    }).join('');
}


function sortData(key) { 
    if (SORT.key === key) SORT.asc = !SORT.asc; 
    else { SORT.key = key; SORT.asc = false; } 
    renderCurrentTable(); 
}
function closeAllRegions() { document.querySelectorAll('.region-row').forEach(el => el.classList.remove('open')); document.querySelectorAll('.expand-btn').forEach(el => el.classList.remove('open')); document.querySelectorAll('tr.active-row').forEach(el => el.classList.remove('active-row')); }
function getSortHeader(key, label) {
    let icon = SORT.key === key ? (SORT.asc ? '<span class="material-icons-round sort-icon">arrow_drop_up</span>' : '<span class="material-icons-round sort-icon">arrow_drop_down</span>') : '<span class="material-icons-round sort-icon" style="color:#ddd">arrow_drop_down</span>';
    return `<th onclick="sortData('${key}')">${label} ${icon}</th>`;
}

function openFilterSheet() {
    const optsDiv = document.getElementById('filterOptions');
    const visDiv = document.getElementById('visibilityOptions');
    const statusHead = document.getElementById('filterStatusHead');
    const visSection = document.getElementById('filterVisibilitySection');
    const statusTitle = document.getElementById('filterStatusTitle');
    const statusAll = document.getElementById('filterStatusAll');
    const visTitle = document.getElementById('filterVisTitle');
    const visAll = document.getElementById('filterVisAll');

    optsDiv.innerHTML = "";
    visDiv.innerHTML = "";

    // Default: show both sections (we will hide when not needed)
    statusHead.style.display = 'flex';
    optsDiv.style.display = 'block';
    visSection.style.display = 'block';

    if(CURRENT_TAB === 'inventory') {
        // A) ç‹€æ…‹ç¯©é¸
        statusTitle.innerText = 'ç‹€æ…‹ç¯©é¸ (å¯è¤‡é¸)';
        statusAll.style.display = 'inline';
        ALL_STATUSES.forEach(opt => {
            const isChecked = SELECTED_STATUSES.has(opt);
            const div = document.createElement('div');
            div.className = "filter-row";
            div.onclick = function() {
                const chk = this.querySelector('input');
                chk.checked = !chk.checked;
            };
            div.innerHTML = `<input type="checkbox" class="filter-chk" value="${opt}" ${isChecked ? 'checked' : ''} onclick="event.stopPropagation()">
                             <span class="filter-label">${opt}</span>`;
            optsDiv.appendChild(div);
        });

        // B) é¡¯ç¤ºç¯©é¸ï¼ˆéš±è—/ééš±è—ï¼‰
        ensureVisibilitySet('inventory');
        visTitle.innerText = 'é¡¯ç¤ºç¯©é¸ (å¯è¤‡é¸)';
        visAll.style.display = 'inline';
        VISIBILITY_OPTIONS.forEach(o => {
            const isChecked = SELECTED_VISIBILITY.inventory.has(o.k);
            const div = document.createElement('div');
            div.className = "filter-row";
            div.onclick = function() {
                const chk = this.querySelector('input');
                chk.checked = !chk.checked;
            };
            div.innerHTML = `<input type="checkbox" class="filter-vis-chk" value="${o.k}" ${isChecked ? 'checked' : ''} onclick="event.stopPropagation()">
                             <span class="filter-label">${o.l}</span>`;
            visDiv.appendChild(div);
        });
    }
    else if(CURRENT_TAB === 'sales') {
        // Sales: only visibility filter
        statusHead.style.display = 'none';
        optsDiv.style.display = 'none';

        ensureVisibilitySet('sales');
        visTitle.innerText = 'é¡¯ç¤ºç¯©é¸ (å¯è¤‡é¸)';
        visAll.style.display = 'inline';
        VISIBILITY_OPTIONS.forEach(o => {
            const isChecked = SELECTED_VISIBILITY.sales.has(o.k);
            const div = document.createElement('div');
            div.className = "filter-row";
            div.onclick = function() {
                const chk = this.querySelector('input');
                chk.checked = !chk.checked;
            };
            div.innerHTML = `<input type="checkbox" class="filter-vis-chk" value="${o.k}" ${isChecked ? 'checked' : ''} onclick="event.stopPropagation()">
                             <span class="filter-label">${o.l}</span>`;
            visDiv.appendChild(div);
        });
    }
    else if(CURRENT_TAB === 'orders') {
        // Orders: keep existing dept/pickup filter (no visibility)
        visSection.style.display = 'none';

        statusTitle.innerText = 'ç¯©é¸ (å¯è¤‡é¸)';
        statusAll.style.display = 'none';

        const depts = [...new Set(DATA.orders.map(o => o.dept))].filter(Boolean).sort();
        const pickups = ["è‡ªå–", "å®…é…"];
        const options = ["(å…¨é¸)", ...pickups, "---", ...depts];

        options.forEach(opt => {
            if(opt === "---") {
                optsDiv.appendChild(document.createElement("hr"));
                return;
            }
            const isAll = opt === "(å…¨é¸)";
            const defaultAll = (SELECTED_ORDER_FILTERS.size === 0);
            const isChecked = isAll ? false : (defaultAll ? true : SELECTED_ORDER_FILTERS.has(opt));

            const div = document.createElement('div');
            div.className = "filter-row";
            if(isAll) div.style.color = "var(--primary)";

            div.onclick = function() {
                if(isAll) { toggleAllFilters(true,'status'); return; }
                const chk = this.querySelector('input');
                chk.checked = !chk.checked;
            };

            div.innerHTML = isAll
                ? `<span class="material-icons-round" style="margin-right:12px">done_all</span><span class="filter-label">å…¨é¸æ‰€æœ‰é …ç›®</span>`
                : `<input type="checkbox" class="filter-chk" value="${opt}" ${isChecked ? 'checked' : ''} onclick="event.stopPropagation()">
                   <span class="filter-label">${opt}</span>`;
            optsDiv.appendChild(div);
        });
    } else {
        // Other tabs: hide filter sheet content
        statusHead.style.display = 'none';
        optsDiv.style.display = 'none';
        visSection.style.display = 'none';
    }

    document.getElementById('filterSheet').classList.add('open');
    document.getElementById('sortOverlay').style.display = 'block';
}
function closeFilterSheet() { document.getElementById('filterSheet').classList.remove('open'); document.getElementById('sortOverlay').style.display = 'none'; }

function toggleAllFilters(enable, group='status') {
    const selector = (group === 'vis') ? '.filter-vis-chk' : '.filter-chk';
    const chks = document.querySelectorAll(selector);
    chks.forEach(c => c.checked = enable);
}

function applyFilter() {
    // Status filter (inventory)
    if(CURRENT_TAB === 'inventory') {
        const chks = document.querySelectorAll('.filter-chk');
        SELECTED_STATUSES.clear();
        chks.forEach(c => { if(c.checked) SELECTED_STATUSES.add(c.value); });
        if(SELECTED_STATUSES.size === 0) SELECTED_STATUSES = new Set(ALL_STATUSES); // guard
    }

    // Orders filter (dept / pickup) - empty set means "no restriction"
    if(CURRENT_TAB === 'orders') {
        const chks = document.querySelectorAll('.filter-chk');
        const picked = new Set();
        chks.forEach(c => { if(c.checked) picked.add(c.value); });

        const depts = [...new Set(DATA.orders.map(o => o.dept))].filter(Boolean);
        const pickups = ['è‡ªå–', 'å®…é…'];
        const allVals = new Set([...pickups, ...depts]);

        // Guard: if nothing selected OR everything selected => treat as "all"
        if(picked.size === 0 || picked.size === allVals.size) {
            SELECTED_ORDER_FILTERS = new Set();
            localStorage.removeItem('admin_order_filters');
        } else {
            SELECTED_ORDER_FILTERS = picked;
            localStorage.setItem('admin_order_filters', JSON.stringify([...SELECTED_ORDER_FILTERS]));
        }
    }

    // Visibility filter (inventory/sales)
    if(CURRENT_TAB === 'inventory' || CURRENT_TAB === 'sales') {
        ensureVisibilitySet(CURRENT_TAB);
        const visChks = document.querySelectorAll('.filter-vis-chk');
        SELECTED_VISIBILITY[CURRENT_TAB].clear();
        visChks.forEach(c => { if(c.checked) SELECTED_VISIBILITY[CURRENT_TAB].add(c.value); });

        // Guard: if user unchecks all, keep empty (show none) is allowed, but avoid "stuck" by restoring default when nothing selected
        if(SELECTED_VISIBILITY[CURRENT_TAB].size === 0) SELECTED_VISIBILITY[CURRENT_TAB] = new Set(DEFAULT_VIS_SET);

        if(CURRENT_TAB === 'inventory') localStorage.setItem('admin_visibility_filter_inventory', JSON.stringify([...SELECTED_VISIBILITY.inventory]));
        if(CURRENT_TAB === 'sales') localStorage.setItem('admin_visibility_filter_sales', JSON.stringify([...SELECTED_VISIBILITY.sales]));
    }

    // Update button highlight
    const btn = document.getElementById('filter-btn');
    let active = false;
    if(CURRENT_TAB === 'inventory') {
        active = (SELECTED_STATUSES.size !== ALL_STATUSES.length) || !setEquals(SELECTED_VISIBILITY.inventory, DEFAULT_VIS_SET);
    } else if(CURRENT_TAB === 'sales') {
        active = !setEquals(SELECTED_VISIBILITY.sales, DEFAULT_VIS_SET);
    } else if(CURRENT_TAB === 'orders') {
        active = (SELECTED_ORDER_FILTERS.size > 0);
    }
    if(active) btn.classList.add('active'); else btn.classList.remove('active');

    closeFilterSheet();
    renderCurrentTable();
}

function openSortSheet() {
    const optsDiv = document.getElementById('sortOptions');
    optsDiv.innerHTML = "";
    let opts = [];
    if(CURRENT_TAB === 'inventory') { opts = [ {k:'code',l:'æ–™è™Ÿ'}, {k:'name',l:'å“å'}, {k:'stock',l:'åº«å­˜'}, {k:'avg',l:'æœˆå‡éŠ·'}, {k:'supplyMonths',l:'ä¾›éŠ·æœˆæ•¸'}, {k:'statusVal',l:'ç‹€æ…‹(å¥åº·åº¦)'} ]; }
    else if (CURRENT_TAB === 'sales') { opts = [ {k:'code',l:'æ–™è™Ÿ'}, {k:'name',l:'å“å'}, {k:'yoy',l:'YoY'}, {k:'thisQty',l:'ä»Šå¹´éŠ·é‡'} ]; }
    else if (CURRENT_TAB === 'orders') { 
        opts = [ 
            {k:'id',l:'å–®è™Ÿ'}, {k:'time',l:'æ™‚é–“'}, {k:'total',l:'é‡‘é¡'}, 
            {k:'dept',l:'éƒ¨é–€'}, {k:'pickup',l:'å–è²¨'} // [New]
        ]; 
    }
    opts.forEach(o => {
        const div = document.createElement('div');
        div.className = `sort-opt ${SORT.key===o.k?'selected':''}`;
        div.innerHTML = `<span>${o.l}</span>${SORT.key===o.k ? (SORT.asc?'<span class="material-icons-round">arrow_upward</span>':'<span class="material-icons-round">arrow_downward</span>') : ''}`;
        div.onclick = () => { sortData(o.k); closeSortSheet(); };
        optsDiv.appendChild(div);
    });
    document.getElementById('sortSheet').classList.add('open');
    document.getElementById('sortOverlay').style.display = 'block';
}
function closeSortSheet() { document.getElementById('sortSheet').classList.remove('open'); document.getElementById('sortOverlay').style.display = 'none'; }
function closeAllSheets() { closeSortSheet(); closeFilterSheet(); }

function renderCurrentTable() {
    const isMobile = window.innerWidth <= 768;
    
    if (PENDING_SEARCH !== null) {
        document.getElementById('tableSearch').value = PENDING_SEARCH;
        PENDING_SEARCH = null; 
    }

    const q = document.getElementById('tableSearch').value.toLowerCase().trim();
    document.getElementById('searchClear').style.display = q.length > 0 ? 'block' : 'none';
    
    const table = document.getElementById('mainTable');
    const cardContainer = document.getElementById('mobileCardContainer');
    if(document.getElementById('mobile-del-all')) document.getElementById('mobile-del-all').style.display = (CURRENT_TAB === 'orders' && isMobile) ? 'inline-block' : 'none';

    let list = [];
    if (CURRENT_TAB === 'inventory') {
        list = DATA.inventory.filter(i => (String(i.code||"").toLowerCase().includes(q)) || (String(i.name||"").includes(q)));
        // V83: Trim status to match filter
        list = list.filter(i => SELECTED_STATUSES.has(i.status.trim()));
        // V96: Visibility filter (default: ééš±è—)
        list = list.filter(i => isVisibilityAllowed('inventory', i.code));
    } else if (CURRENT_TAB === 'sales') {
        list = DATA.sales.filter(s => ((s.name||"").includes(q)) || ((s.code||"").toString().toLowerCase().includes(q)));
        // V96: Visibility filter (default: ééš±è—)
        list = list.filter(s => isVisibilityAllowed('sales', s.code));
    } else if (CURRENT_TAB === 'orders') {
        list = DATA.orders.filter(o => o.id.toLowerCase().includes(q) || o.name.includes(q));
        if (q.length === 8 && !isNaN(q)) list = DATA.orders.filter(o => o.id.includes(q) || o.time.replace(/\D/g,'').startsWith(q));
    }

    // Orders filter (dept / pickup) - only applies on Orders tab
    if (CURRENT_TAB === 'orders' && SELECTED_ORDER_FILTERS && SELECTED_ORDER_FILTERS.size > 0) {
        list = list.filter(o => SELECTED_ORDER_FILTERS.has(o.dept) || SELECTED_ORDER_FILTERS.has(o.pickup));
    }

    if(SORT.key) list.sort((a,b) => (a[SORT.key]>b[SORT.key]?1:-1)*(SORT.asc?1:-1));

    if (isMobile) {
        table.style.display = 'none';
        cardContainer.innerHTML = "";
        
        if (list.length === 0) {
            cardContainer.innerHTML = `<div style="text-align:center;padding:20px;color:#999">æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„è³‡æ–™</div>`;
        }

        if (CURRENT_TAB === 'inventory') {
             list.forEach(i => {
                let infoHtml = i.info.map(inf => `<div style="display:flex;justify-content:space-between;padding:4px 0;border-bottom:1px solid #f5f5f5"><span>${inf.name}</span><span style="font-weight:700">${inf.val}</span></div>`).join("");
                
                const isExpand = (String(i.code) === String(AUTO_EXPAND_CODE));
                
                const card = document.createElement('div');
                card.id = 'card-' + i.code; 
                card.className = `m-compact-card ${isExpand ? 'highlight-flash' : ''}`;
                card.innerHTML = `
                    <div class="m-status-strip" style="background:${i.statusColor}"></div>
                    <div style="padding-left:8px;">
                        <div class="stock-ticker-top">
                            <div class="ticker-name">${i.name}</div>
                            <div class="ticker-val-box">
                                <div class="ticker-stock">${i.stock} <span style="font-size:50%;font-weight:normal">(M)</span></div>
                            </div>
                        </div>
                        <div class="ticker-sub">
                             <div style="display:flex;align-items:center;gap:6px">
                                <span class="ticker-code">${i.code}</span>
                                <span class="st-badge ${i.statusClass}" style="transform:scale(0.8)">${i.status}</span>
                             </div>
                             <div style="font-size:11px;color:#90a4ae">
                                æœˆå‡ <span style="font-size:120%;color:#455a64;font-weight:700;margin:0 2px">${i.avg}</span> | 
                                å¯ä¾› <span style="font-size:120%;color:${i.statusColor};font-weight:700;margin:0 2px">${i.supplyMonthsDisplay}</span>${i.supplyMonthsDisplay==='â€”'?'':' æœˆ'} 
                             </div>
                        </div>
                        
                        <div class="mc-expand-content ${isExpand ? 'open' : ''}" id="mc-ex-${i.code}">
                            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
                                <div style="font-weight:700;color:#78909c">åŸºæœ¬è³‡æ–™</div>
                                <div class="mc-icon-btn hide ${HIDDEN_STOCK.has(i.code) ? 'active' : ''}" onclick="toggleHidden('${i.code}')" title="éš±è—æ­¤ç”¢å“"><span class="material-icons-round" style="font-size:18px">visibility_off</span></div>
                            </div>
                            ${infoHtml}
                            <div class="mc-actions-row">
                                <div class="mc-action-btn" onclick="event.stopPropagation(); openInfoModal('sales', '${String(i.code).replace(/'/g, "\\'")}')">
                                    <span class="material-icons-round">analytics</span> éŠ·å”®åˆ†æ
                                </div>
                                <div class="mc-action-btn" onclick="event.stopPropagation(); openInfoModal('regions', '${String(i.code).replace(/'/g, "\\'")}')">
                                    <span class="material-icons-round">map</span> å„åœ°åº«å­˜
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                card.onclick = (e) => { 
                    if(e.target.closest('.mc-action-btn') || e.target.closest('.mc-icon-btn')) return;
                    toggleMobileExpandWithHistory(i.code);
                }
                cardContainer.appendChild(card);
             });
        }
        else if (CURRENT_TAB === 'sales') {
            list.forEach(s => {
                const yoyColor = s.yoy >= 0 ? '#d32f2f' : '#388e3c';
                const card = document.createElement('div');
                card.className = 'm-compact-card';
                card.id = 'card-' + s.code;
                card.onclick = function() { this.querySelector('.mc-sales-detail').classList.toggle('open'); };
                card.innerHTML = `
                    <div class="m-status-strip" style="background:${yoyColor}"></div>
                    <div style="padding-left:8px;">
                        <div class="mc-sales-mini">
                            <div class="mc-main-text" style="margin-right:0">${s.name}</div>
                            <div style="display:flex;align-items:center;gap:10px;justify-content:flex-end">
                                <span class="material-icons-round mc-icon-btn hide ${HIDDEN_STOCK.has(s.code) ? 'active' : '' }" onclick="event.stopPropagation(); toggleHidden('${s.code}')" style="font-size:18px" title="éš±è—/é¡¯ç¤º">visibility_off</span>
                                <div style="text-align:right">
                                <div style="font-size:16px;font-weight:900;color:${yoyColor}">${s.yoy}%</div>
                                <div style="font-size:10px;color:#999">YoY</div>
                            </div>
                        </div>
                        </div>
                        <div class="mc-sales-detail">
                            <div class="mc-row"><span>æ–™è™Ÿ</span><span class="mc-row-val">${s.code}</span></div>
                            <div class="mc-row"><span>ä»Šå¹´éŠ·é‡</span><span class="mc-row-val">${s.thisQty}</span></div>
                            <div class="mc-row"><span>å»å¹´éŠ·é‡</span><span class="mc-row-val">${s.lastQty}</span></div>
                            <div class="mc-row" style="margin-top:4px;border-top:1px dotted #eee;padding-top:4px">
                                <span>ä»Šå¹´ç‡Ÿæ”¶</span><span class="mc-row-val" style="color:var(--primary)">$${s.thisRev.toLocaleString()}</span>
                            </div>
                            <div class="mc-row">
                                <span>å»å¹´ç‡Ÿæ”¶</span><span class="mc-row-val" style="color:#78909c">$${s.lastRev.toLocaleString()}</span>
                            </div>
                        </div>
                    </div>
                `;
                cardContainer.appendChild(card);
            });
        }
        else if (CURRENT_TAB === 'orders') {
            list.forEach(o => {
                const card = document.createElement('div');
                card.className = 'm-compact-card';
                card.id = 'card-' + o.id;
                card.onclick = () => openOrderModal(o.id, 'view');
                card.innerHTML = `
                    <div class="m-status-strip" style="background:#00897b"></div>
                    <div style="padding-left:8px;">
                        <div style="display:flex;justify-content:space-between;font-size:12px;color:#90a4ae;margin-bottom:4px;">
                            <span>${o.id}</span>
                            <span>${o.time.split(' ')[0]}</span>
                        </div>
                        <div class="mc-main-text" style="font-size:16px;">${o.name} <span style="font-size:13px;font-weight:400;color:#666">(${o.dept})</span></div>
                        <div class="mc-order-footer">
                             <div class="mc-order-total">$${o.total.toLocaleString()}</div>
                             <div>
                                <span class="material-icons-round mc-icon-btn edit" onclick="openOrderModal('${o.id}','edit');event.stopPropagation()">edit</span>
                                <span class="material-icons-round mc-icon-btn del" onclick="deleteOrderPrompt('${o.id}');event.stopPropagation()">delete</span>
                             </div>
                        </div>
                    </div>
                `;
                cardContainer.appendChild(card);
            });
        }
    } else {
        // Desktop View
        table.style.display = 'table';
        cardContainer.innerHTML = "";
        let html = "";
        if (CURRENT_TAB === 'inventory') {
            html = `<thead><tr><th style="width:50px"><span class="material-icons-round close-all-btn" onclick="closeAllRegions()">indeterminate_check_box</span></th>${getSortHeader('code','ç‰©æ–™')}${getSortHeader('name','ç”¢å“')}${getSortHeader('monthAccum','æœ¬æœˆ')}${getSortHeader('monthDiff','æœˆéŠ·æ³¢å‹•')}${getSortHeader('avg','æœˆéŠ·')}${getSortHeader('stock','ç¸½åº«å­˜(M)')}${getSortHeader('supplyMonths','é ä¼°ä¾›éŠ·æœˆ')}${getSortHeader('statusVal','ç‹€æ…‹')}</tr></thead><tbody>`;
            list.forEach((i) => {
                const isOpen = (String(i.code) === String(AUTO_EXPAND_CODE));
                const salesRec = getSalesRowByCode(i.code) || DATA.sales.find(s => (normalizeStr(s.name) === normalizeStr(i.name))) || { lastQty:0, thisQty:0, yoy:0, lastRev:0, thisRev:0 };
                const maxVal = Math.max(salesRec.lastQty, salesRec.thisQty, 1);
                
                let salesHtml = `<div class="card-title">éŠ·å”®åˆ†æ (YoY)</div><div class="info-line"><span>å»å¹´ç‡Ÿæ”¶</span><b>$${salesRec.lastRev.toLocaleString()}</b></div><div class="info-line"><span>ä»Šå¹´ç‡Ÿæ”¶</span><b>$${salesRec.thisRev.toLocaleString()}</b></div><div class="info-line"><span>å»å¹´éŠ·é‡</span><b>${salesRec.lastQty}</b></div><div class="info-line"><span>ä»Šå¹´éŠ·é‡</span><b>${salesRec.thisQty}</b></div><div class="info-line"><span>YoY æˆé•·ç‡</span><b class="${salesRec.yoy>=0?'val-up':'val-down'}">${salesRec.yoy}%</b></div><div class="comp-container"><div class="comp-row"><span class="comp-label">å»å¹´</span><div class="comp-track"><div class="comp-bar" style="width:${(salesRec.lastQty/maxVal)*100}%;background:#9e9e9e"></div></div><span class="comp-val">${salesRec.lastQty}</span></div><div class="comp-row"><span class="comp-label">ä»Šå¹´</span><div class="comp-track"><div class="comp-bar" style="width:${(salesRec.thisQty/maxVal)*100}%;background:${salesRec.thisQty>=salesRec.lastQty?'#d32f2f':'#0288d1'}"></div></div><span class="comp-val">${salesRec.thisQty}</span></div></div>`;
                let infoHtml = i.info.map(inf => `<div class="info-line"><span>${inf.name}</span><b>${inf.val}</b></div>`).join("");
                
                // V82: Added getShortRegionName back to context
                let regionHtml = i.regions.map(r => `<div class="r-box" style="background:${r.qty>0?`rgba(0,137,123,${0.1+(r.qty/Math.max(...i.regions.map(x=>x.qty),1))*0.9})`:'#eee'};color:${(r.qty/Math.max(...i.regions.map(x=>x.qty),1))>0.5?'#fff':'#333'}"><span class="r-name">${getShortRegionName(r.name)}</span><span class="r-qty">${r.qty}</span></div>`).join("");
                
                html += `<tr id="row-${i.code}" onclick="toggleRegion(this)" class="${isOpen?'active-row':''}" style="cursor:pointer;border-left:4px solid ${i.status==='ç¼ºè²¨'?'var(--danger)':'transparent'}"><td style="text-align:center"><span class="material-icons-round expand-btn ${isOpen?'open':''}">expand_more</span></td><td style="font-size:14px;color:#888">${i.code} <span class="material-icons-round mc-icon-btn hide ${HIDDEN_STOCK.has(i.code) ? 'active' : ''}" onclick="event.stopPropagation(); toggleHidden('${i.code}')" style="font-size:16px;vertical-align:middle;margin-left:4px" title="éš±è—">visibility_off</span></td><td class="prod-name-cell">${i.name}</td><td>${i.monthAccum}</td><td>${i.monthDiff>0?`<span class="val-up">+${Math.round(i.monthDiff)}</span>`:`<span class="val-down">${Math.round(i.monthDiff)}</span>`}</td><td>${i.avg}</td><td style="font-weight:900;color:var(--primary)">${i.stock}</td><td>${i.supplyMonthsDisplay}</td><td><span class="st-badge ${i.statusClass}">${i.status}</span></td></tr><tr class="region-row ${isOpen?'open':''}"><td colspan="9"><div class="expand-container"><div class="detail-card"><div class="card-title">åŸºæœ¬è³‡æ–™</div>${infoHtml}</div><div class="detail-card">${salesHtml}</div><div><div class="card-title">å„åœ°åº«å­˜</div><div class="region-grid">${regionHtml}</div></div></div></td></tr>`;
            });
        }
        else if (CURRENT_TAB === 'sales') {
            html = `<thead><tr>${getSortHeader('code','ç‰©æ–™')}${getSortHeader('name','å“å')}${getSortHeader('yoy','YoY')}${getSortHeader('lastRev','å»å¹´é‡‘é¡')}${getSortHeader('thisRev','ä»Šå¹´é‡‘é¡')}${getSortHeader('lastQty','å»å¹´éŠ·é‡')}${getSortHeader('thisQty','ä»Šå¹´éŠ·é‡')}</tr></thead><tbody>`;
            list.forEach(s => { html += `<tr id="row-${s.code}"><td style="font-size:14px;color:#888">${s.code} <span class="material-icons-round mc-icon-btn hide ${HIDDEN_STOCK.has(s.code) ? 'active' : '' }" onclick="event.stopPropagation(); toggleHidden('${s.code}')" style="font-size:16px;vertical-align:middle;margin-left:4px" title="éš±è—/é¡¯ç¤º">visibility_off</span></td><td class="prod-name-cell">${s.name}</td><td class="${s.yoy>=0?'val-up':'val-down'}">${s.yoy}%</td><td>$${s.lastRev.toLocaleString()}</td><td>$${s.thisRev.toLocaleString()}</td><td>${s.lastQty}</td><td>${s.thisQty}</td></tr>`; });
        }
                else if (CURRENT_TAB === 'orders') {
            // ç¯©é¸ï¼šéƒ¨é–€ / å–è²¨ï¼ˆOrders å°ˆç”¨ï¼›ç©ºé›†åˆä»£è¡¨ä¸é™åˆ¶ï¼‰
            if (SELECTED_ORDER_FILTERS && SELECTED_ORDER_FILTERS.size > 0) {
                list = list.filter(o => SELECTED_ORDER_FILTERS.has(o.dept) || SELECTED_ORDER_FILTERS.has(o.pickup));
            }

            // [New] è¨ˆç®—ç¯©é¸å¾Œçš„ç¸½é‡‘é¡
            const totalSum = list.reduce((acc, o) => acc + o.total, 0);

            // [New] å‹•æ…‹æ’å…¥ç¸½é‡‘é¡é¡¯ç¤ºèˆ‡çµ±è¨ˆæŒ‰éˆ• (åœ¨ panel-head ä¸­)
            let subHeader = document.getElementById('order-summary-bar');
            if(!subHeader) {
                subHeader = document.createElement('div');
                subHeader.id = 'order-summary-bar';
                subHeader.style.padding = '8px 15px';
                subHeader.style.background = '#e8f5e9';
                subHeader.style.color = '#1b5e20';
                subHeader.style.fontWeight = '700';
                subHeader.style.display = 'flex';
                subHeader.style.justifyContent = 'space-between';
                subHeader.style.alignItems = 'center';
                subHeader.style.borderBottom = '1px solid #c8e6c9';
                // æ’å…¥åœ¨ panel-head ä¹‹å¾Œ
                const head = document.querySelector('.panel-head');
                if(head) head.after(subHeader);
            }
            subHeader.style.display = 'flex';
            subHeader.innerHTML = `
                <span>ç¸½ç­†æ•¸: ${list.length} / ç¸½é‡‘é¡: $${totalSum.toLocaleString()}</span>
                <button onclick="showItemStats()" style="border:1px solid #2e7d32;background:#fff;color:#2e7d32;border-radius:20px;padding:4px 12px;font-size:12px;font-weight:700;cursor:pointer;display:flex;align-items:center;gap:4px">
                    <span class="material-icons-round" style="font-size:16px">poll</span> è²¨å“çµ±è¨ˆ
                </button>
            `;

            // [Mod] æ›´æ–°è¡¨é ­ (æ‹†åˆ†å§“å/éƒ¨é–€, æ–°å¢å–è²¨)
            html = `<thead><tr>
                ${getSortHeader('id','å–®è™Ÿ')}
                ${getSortHeader('time','æ™‚é–“')}
                ${getSortHeader('name','å§“å')}
                ${getSortHeader('dept','éƒ¨é–€')}
                ${getSortHeader('pickup','å–è²¨')}
                ${getSortHeader('total','ç¸½é‡‘é¡')}
                <th>æ“ä½œ <span class="material-icons-round" style="color:#d32f2f;cursor:pointer;font-size:20px;vertical-align:middle;margin-left:8px;" onclick="deleteAllOrders()" title="åˆªé™¤å…¨éƒ¨">delete_sweep</span></th>
            </tr></thead><tbody>`;

            list.forEach(o => { 
                // åˆ¤æ–·å–è²¨æ–¹å¼é¡¯ç¤ºé¡è‰²
                const pickupBadge = o.pickup === 'å®…é…' 
                    ? `<span style="background:#fff3e0;color:#e65100;padding:2px 6px;border-radius:4px;font-size:12px">å®…é…</span>`
                    : `<span style="background:#f5f5f5;color:#607d8b;padding:2px 6px;border-radius:4px;font-size:12px">è‡ªå–</span>`;

                html += `
                <tr style="cursor:pointer" onclick="openOrderModal('${o.id}','view')">
                    <td style="font-size:14px">${o.id}</td>
                    <td>${o.time.split(' ')[0]}</td>
                    <td><b>${o.name}</b></td>
                    <td><span style="font-size:13px;color:#546e7a">${o.dept}</span></td>
                    <td>${pickupBadge}</td>
                    <td style="font-weight:700">$${o.total.toLocaleString()}</td>
                    <td>
                        <span class="material-icons-round act-btn" onclick="openOrderModal('${o.id}','edit');event.stopPropagation()">edit</span>
                        <span class="material-icons-round act-btn" style="color:#ef5350" onclick="deleteOrderPrompt('${o.id}');event.stopPropagation()">delete</span>
                    </td>
                </tr>`; 
            });
        }

        

        // ... (è¨˜å¾—è¦éš±è— summary bar è‹¥ä¸æ˜¯ orders tab)
        if(CURRENT_TAB !== 'orders') {
            const bar = document.getElementById('order-summary-bar');
            if(bar) bar.style.display = 'none';
        }
table.innerHTML = html;
    }
}

function getShortRegionName(name) {
    if(name.includes('å°åŒ—å•¤é…’å·¥å ´')) return 'åŒ—å•¤æ¨å»£';
    return name.replace(/å•¤é…’å» ç”¢å“æ¨å»£ä¸­å¿ƒ/g, 'å•¤æ¨å»£').replace(/é…’å» ç”¢å“æ¨å»£ä¸­å¿ƒ/g, 'é…’å» æ¨å»£').replace(/ç‡Ÿæ¥­è™•/g, 'è™•').replace(/å±•å”®ä¸­å¿ƒ/g, 'å±•å”®');
}

function openInfoModal(type, code) {
    // V87: Sanitization
    const target = String(code).trim();
    const item = DATA.inventory.find(i => String(i.code).trim() === target);
    
    if(!item) return;

    const sales = getSalesRowByCode(target) || DATA.sales.find(s => (normalizeStr(s.name)===normalizeStr(target))) || { lastQty:0, thisQty:0, yoy:0, lastRev:0, thisRev:0 };
    const body = document.getElementById('info-body');
    const title = document.getElementById('info-title');
    
    if (type === 'sales') {
        title.innerText = "éŠ·å”®åˆ†æ";
        const maxVal = Math.max(sales.lastQty, sales.thisQty, 1);
        const yoyCol = sales.yoy >= 0 ? '#d32f2f' : '#388e3c';
        body.innerHTML = `
            <div class="info-section-title">${item.name}</div>
            <div class="mc-compact-card" style="border:none;box-shadow:none;padding:0">
                <div class="mc-row"><span>ä»Šå¹´ç‡Ÿæ”¶</span><span class="mc-row-val">$${sales.thisRev.toLocaleString()}</span></div>
                <div class="mc-row"><span>å»å¹´ç‡Ÿæ”¶</span><span class="mc-row-val">$${sales.lastRev.toLocaleString()}</span></div>
                <hr style="border-top:1px dashed #eee;margin:10px 0">
                <div class="mc-row"><span>ä»Šå¹´éŠ·é‡</span><span class="mc-row-val">${sales.thisQty}</span></div>
                <div class="mc-row"><span>å»å¹´éŠ·é‡</span><span class="mc-row-val">${sales.lastQty}</span></div>
                <div class="mc-row"><span>YoY</span><span class="mc-row-val" style="color:${yoyCol}">${sales.yoy}%</span></div>
                <div class="comp-container" style="margin-top:15px">
                    <div class="comp-row"><span class="comp-label">å»å¹´</span><div class="comp-track"><div class="comp-bar" style="width:${(sales.lastQty/maxVal)*100}%;background:#9e9e9e"></div></div><span class="comp-val">${sales.lastQty}</span></div>
                    <div class="comp-row"><span class="comp-label">ä»Šå¹´</span><div class="comp-track"><div class="comp-bar" style="width:${(sales.thisQty/maxVal)*100}%;background:${sales.thisQty>=sales.lastQty?'#d32f2f':'#0288d1'}"></div></div><span class="comp-val">${sales.thisQty}</span></div>
                </div>
            </div>
        `;
    } else {
        title.innerText = "å„åœ°åº«å­˜";
        const maxR = Math.max(...item.regions.map(r=>r.qty), 1);
        let regionHtml = item.regions.map(r => {
            const ratio = r.qty / maxR;
            const bg = r.qty > 0 ? `rgba(0, 137, 123, ${0.1 + ratio * 0.9})` : '#eee';
            const col = ratio > 0.5 ? '#fff' : '#333';
            return `<div class="region-box-mobile" style="background:${bg};color:${col}">
                <span class="region-name-m">${getShortRegionName(r.name)}</span>
                <span class="region-qty-m">${r.qty}</span>
            </div>`;
        }).join("");
        body.innerHTML = `<div class="info-section-title">${item.name}</div><div class="region-grid-mobile">${regionHtml}</div>`;
    }
    
    document.getElementById('infoModal').classList.add('open');
    history.pushState({modal: 'info', expand: code}, null, ""); // Store Expand state in modal history
}
function closeInfoModal(goBackHist = true) {
    document.getElementById('infoModal').classList.remove('open');
    if(goBackHist && history.state && history.state.modal) history.back();
}

function toggleMobileExpandWithHistory(code) {
    const el = document.getElementById('mc-ex-' + code);
    if(el.classList.contains('open')) {
        if (history.state && history.state.expand === code) { history.back(); } else { el.classList.remove('open'); }
    } else {
        history.pushState({tab: 'inventory', expand: code}, '', '');
        el.classList.add('open');
    }
}

function toggleRegion(row) { const next = row.nextElementSibling; if(next && next.classList.contains('region-row')) { next.classList.toggle('open'); row.querySelector('.expand-btn').classList.toggle('open'); row.classList.toggle('active-row'); } }

// --- V91: å®Œæ•´ä¿®å¾©è¨‚å–®ç®¡ç†é‚è¼¯ (æºè‡ª V69, ç‰ˆé¢ç¶­æŒ V90) ---

let currentEditOrder = null; // ä¿®æ­£: å…¨åŸŸè®Šæ•¸

// é–‹å•Ÿè¨‚å–®è¦–çª— (View/Edit)
function openOrderModal(oid, mode) {
  const order = DATA.orders.find(o => o.id === oid);
  if(!order || !order.raw) { alert("æ­¤ç‚ºèˆŠç‰ˆè³‡æ–™æˆ–æ ¼å¼ä¸ç¬¦ï¼Œç„¡æ³•æª¢è¦–/ç·¨è¼¯ã€‚"); return; }
  
  currentEditOrder = order;

  // 1. å¡«å…¥è¡¨å–®è³‡æ–™
  document.getElementById('e-oid').value = order.id;
  document.getElementById('e-name').value = order.raw.employee_name || "";
  document.getElementById('e-dept').value = order.raw.department || "";
  document.getElementById('e-note').value = order.raw.remarks || "";
  // [New] å–è²¨/å®…é…è³‡è¨Šé¡¯ç¤º
  const pickupMethod = order.raw.pickup_method || order.pickup || "è‡ªå–";
  const pickupInput = document.getElementById('e-pickup');
  if(pickupInput) pickupInput.value = pickupMethod;
  const infoRow = document.getElementById('e-pickup-info-row');
  const infoBox = document.getElementById('e-pickup-info');
  if(infoRow && infoBox) {
      if(pickupMethod === 'å®…é…' && order.raw.pickup_info) {
          infoRow.style.display = 'flex';
          const pi = order.raw.pickup_info;
          infoBox.innerHTML = `${pi.name || ''} / ${pi.phone || ''}<br>${pi.address || ''}` + (pi.note ? `<br>å‚™è¨»ï¼š${pi.note}` : '');
      } else {
          infoRow.style.display = 'none';
          infoBox.innerHTML = '';
      }
  }

  document.getElementById('e-total').innerText = (order.raw.totals && order.raw.totals.pay) ? order.raw.totals.pay.toLocaleString() : "0";

  // 2. æ¸²æŸ“å•†å“åˆ—è¡¨
  let html = ''; 
  if(order.raw.items) {
      order.raw.items.forEach(it => { 
          html += `<div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid #f5f5f5;font-size:14px;">
              <span>${it.product_name}</span>
              <span style="font-weight:700">x${it.qty}</span>
          </div>`;
      });
  }
  if(order.raw.gifts) {
      order.raw.gifts.forEach(g => { 
          html += `<div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid #f5f5f5;color:var(--accent);font-size:14px;">
              <span>ğŸ ${g.product_name}</span>
              <span style="font-weight:700">x${g.qty}</span>
          </div>`;
      });
  }
  document.getElementById('e-items').innerHTML = html;

  // 3. è¨­å®šæ¨¡å¼ä¸¦é–‹å•Ÿ
  switchEditMode(mode === 'edit'); 
  document.getElementById('editModal').classList.add('open');
  
  // åŠ å…¥æ­·å²ç´€éŒ„ä»¥ä¾¿æŒ‰ä¸Šä¸€é é—œé–‰
  history.pushState({modal: 'order'}, null, "");
}

// åˆ‡æ› æª¢è¦–/ç·¨è¼¯ æ¨¡å¼
function switchEditMode(isEdit) { 
    const inputs = document.querySelectorAll('.m-input'); 
    inputs.forEach(el => el.disabled = !isEdit); 
    
    document.getElementById('m-title').innerText = isEdit ? "ç·¨è¼¯è¨‚å–®" : "è¨‚å–®è©³æƒ… (å”¯è®€)"; 
    document.getElementById('m-foot-view').style.display = isEdit ? 'none' : 'flex'; 
    document.getElementById('m-foot-edit').style.display = isEdit ? 'flex' : 'none'; 
}

// é—œé–‰è¦–çª—
function closeModal(goBackHist = true) { 
    document.getElementById('editModal').classList.remove('open'); 
    currentEditOrder = null; 
    // å¦‚æœæ˜¯é€éç¨‹å¼é—œé–‰(å¦‚å„²å­˜å¾Œ)ï¼Œä¸”æ­·å²ç´€éŒ„é‚„åœ¨ Modal ç‹€æ…‹ï¼Œå‰‡æ‰‹å‹•é€€å›
    if(goBackHist && history.state && history.state.modal) history.back();
}

// å„²å­˜è®Šæ›´
function saveOrderAction() { 
    if(!currentEditOrder) return; 

    // æ›´æ–°åŸºæœ¬è³‡æ–™
    currentEditOrder.raw.employee_name = document.getElementById('e-name').value; 
    currentEditOrder.raw.department = document.getElementById('e-dept').value; 
    currentEditOrder.raw.remarks = document.getElementById('e-note').value; 

    // [Fix] æ·±åº¦è£œå…¨ Bundle Summary (æ”¯æ´ä»¥æ–™è™Ÿæˆ–å“åå›å¡«ï¼Œç¢ºä¿èˆŠè¨‚å–®å¯æ­£ç¢ºæ‹†è§£çµ±è¨ˆ)
    const normKey = (s) => normalizeStr((s || "").toString().trim().replace(/[()ï¼ˆï¼‰ã€ã€‘\[\]ã€Œã€ã€ã€ã€Šã€‹<>]/g, ''));

    const fillBundleSummary = (obj) => {
        if(!obj || obj.bundle_summary) return;

        const code = (obj.product_code || "").toString().trim();
        if(code && PRODUCT_BUNDLE_MAP.has(code)) {
            obj.bundle_summary = PRODUCT_BUNDLE_MAP.get(code);
            return;
        }

        // Legacy: some old payloads may miss code; fallback by normalized product_name
        const nk = normKey(obj.product_name || "");
        if(nk && PRODUCT_BUNDLE_MAP.has(nk)) {
            obj.bundle_summary = PRODUCT_BUNDLE_MAP.get(nk);
        }
    };

    if(currentEditOrder.raw.items) currentEditOrder.raw.items.forEach(fillBundleSummary);
    if(currentEditOrder.raw.gifts) currentEditOrder.raw.gifts.forEach(fillBundleSummary);

    const payload = JSON.parse(JSON.stringify(currentEditOrder.raw)); 
    payload.action = "update_order"; 
    payload.order_id = currentEditOrder.id; 

    callGAS(payload, "ä¿®æ”¹æˆåŠŸ", false); 
}

// åˆªé™¤ç¢ºèª (å–®ç­†)
function deleteOrderPrompt(oid) { 
    currentEditOrder = DATA.orders.find(o => o.id === oid); 
    if(confirm("ç¢ºå®šè¦åˆªé™¤æ­¤è¨‚å–®å—ï¼Ÿ\n(å–®è™Ÿ: " + oid + ")")) { 
        callGAS({ action: "delete_order", order_id: currentEditOrder.id }, "åˆªé™¤æˆåŠŸ", true); 
    } 
}

// åˆªé™¤å‹•ä½œ (å¾ç·¨è¼¯è¦–çª—è§¸ç™¼)
function deleteOrderAction() { 
    if(!confirm("ç¢ºå®šè¦åˆªé™¤æ­¤è¨‚å–®å—ï¼Ÿ")) return; 
    callGAS({ action: "delete_order", order_id: currentEditOrder.id }, "åˆªé™¤æˆåŠŸ", true); 
}

// æ‰¹é‡åˆªé™¤
async function deleteAllOrders() {
    const q = document.getElementById('tableSearch').value.trim();
    let targetOrders = q ? DATA.orders.filter(o => o.id.includes(q) || o.name.includes(q)) : DATA.orders;
    
    if(targetOrders.length === 0) { alert("ç›®å‰åˆ—è¡¨ç„¡è¨‚å–®å¯åˆªé™¤"); return; }
    
    if(!confirm(`âš ï¸ å±éšªæ“ä½œï¼šæ‚¨å³å°‡åˆªé™¤ç›®å‰åˆ—è¡¨ä¸­çš„ ${targetOrders.length} ç­†è¨‚å–®ï¼\n\næ­¤å‹•ä½œç„¡æ³•å¾©åŸã€‚`)) return; 
    if(!confirm(`å†æ¬¡ç¢ºèªï¼šçœŸçš„è¦åˆªé™¤é€™ ${targetOrders.length} ç­†è¨‚å–®å—ï¼Ÿ`)) return;
    
    showLoading(true, "æ­£åœ¨æ‰¹é‡åˆªé™¤è¨‚å–®ï¼Œè«‹å‹¿é—œé–‰è¦–çª—...");
    
    let successCount = 0;
    for(const order of targetOrders) { 
        try { 
            await fetch(GAS_URL + "?token=" + encodeURIComponent(ADMIN_TOKEN), { 
                method: "POST", 
                headers: { "Content-Type": "application/x-www-form-urlencoded" }, 
                body: "payload=" + encodeURIComponent(JSON.stringify({ action: "delete_order", order_id: order.id })) 
            }); 
            successCount++; 
        } catch(e) { console.error(e); } 
    }
    
    showLoading(false); 
    alert(`æ‰¹é‡åˆªé™¤å®Œæˆï¼å…±åˆªé™¤ ${successCount} ç­†è¨‚å–®ã€‚`); 
    init(); // é‡æ–°æ•´ç†
}

// GAS API å‘¼å«æ ¸å¿ƒ
function callGAS(payload, msg, isDelete, isRetry=false) {
  showLoading(true, isDelete ? "æ­£åœ¨åˆªé™¤è¨‚å–®..." : "æ­£åœ¨å„²å­˜..."); 
  if(isDelete) closeModal(true); // åˆªé™¤æ™‚å…ˆé—œé–‰è¦–çª—
  
  fetch(GAS_URL + "?token=" + encodeURIComponent(ADMIN_TOKEN), { 
      method: "POST", 
      headers: { "Content-Type": "application/x-www-form-urlencoded" }, 
      body: "payload=" + encodeURIComponent(JSON.stringify(payload)) 
  })
  .then(r=>r.json())
  .then(res=>{ 
      if(res.ok) { 
          if(isDelete) { 
              DATA.orders = DATA.orders.filter(o => o.id !== payload.order_id); 
          } else { 
              // æ›´æ–°æœ¬åœ°é¡¯ç¤ºè³‡æ–™ï¼Œé¿å…éœ€é‡æ–°æ•´ç†
              if(currentEditOrder) { 
                  currentEditOrder.name = document.getElementById('e-name').value; 
                  currentEditOrder.dept = document.getElementById('e-dept').value; 
              } 
              closeModal(true); 
          } 
          updateDashboard();
        updateRestoreWidgetVisibility('dashboard'); 
          renderCurrentTable(); 
          showLoading(false); 
          // alert(msg); // é¸æ“‡æ€§é–‹å•Ÿæç¤º
      } else { 
          showLoading(false); 
          const errMsg = (res && res.error) ? String(res.error) : "";
          if(!isRetry && /token/i.test(errMsg)) {
              return ensureValidTokenAndRetry(payload, msg, isDelete);
          }
          alert("å¤±æ•—: " + errMsg); 
      } 
  })
  .catch(e=>{ 
      showLoading(false); 
      alert("é€£ç·šéŒ¯èª¤"); 
      console.error(e);
  });
}

// ===== Settings: config editor =====
function setConfigStatus(text) {
  const el = document.getElementById('configStatus');
  if(el) el.innerText = text || '';
}

function gasFetch(payload, useToken = false) {
  const url = useToken ? (GAS_URL + "?token=" + encodeURIComponent(ADMIN_TOKEN)) : GAS_URL;
  return fetch(url, {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded" },
      body: "payload=" + encodeURIComponent(JSON.stringify(payload)),
      cache: "no-store"
  }).then(r => r.json());
}

async function ensureSettingsLoaded(force = false) {
  if(SETTINGS_LOADED && !force) return;
  setConfigStatus("ç‹€æ…‹ï¼šè¼‰å…¥ä¸­â€¦");
  try {
    const res = await gasFetch({ action: "get_config" }, false);
    if(res && res.ok) {
      CONFIG_DATA = {
        departments: Array.isArray(res.departments) ? res.departments : [],
        payments: Array.isArray(res.payments) ? res.payments : []
      };
      // normalize
      CONFIG_DATA.departments = CONFIG_DATA.departments.map(x => ({
        value: String(x.value || x.label || "").trim(),
        label: String(x.label || x.value || "").trim(),
        active: String(x.active).toLowerCase() !== 'false'
      })).filter(x => x.label);

      CONFIG_DATA.payments = CONFIG_DATA.payments.map(x => ({
        value: String(x.value || x.label || "").trim(),
        label: String(x.label || x.value || "").trim(),
        active: String(x.active).toLowerCase() !== 'false'
      })).filter(x => x.label);

      // Default safeguard
      if(CONFIG_DATA.departments.length === 0) CONFIG_DATA.departments = [{ value: "å…¶ä»–", label: "å…¶ä»–", active: true }];
      if(CONFIG_DATA.payments.length === 0) CONFIG_DATA.payments = [{ value: "ç¾é‡‘", label: "ç¾é‡‘", active: true }];

      renderConfigUI();
      SETTINGS_LOADED = true;
      recordHealth('config', true);
      setConfigStatus("ç‹€æ…‹ï¼šå·²è¼‰å…¥ï¼ˆ" + new Date().toLocaleTimeString() + "ï¼‰");
    } else {
      recordHealth('config', false, (res && res.error) ? res.error : 'æœªçŸ¥éŒ¯èª¤');
      setConfigStatus("ç‹€æ…‹ï¼šè¼‰å…¥å¤±æ•—");
      alert("è¨­å®šè¼‰å…¥å¤±æ•—ï¼š" + ((res && res.error) ? res.error : "æœªçŸ¥éŒ¯èª¤"));
    }
  } catch(e) {
    console.error(e);
    recordHealth('config', false, e && e.message ? e.message : 'é€£ç·šéŒ¯èª¤');
    setConfigStatus("ç‹€æ…‹ï¼šè¼‰å…¥å¤±æ•—");
    alert("è¨­å®šè¼‰å…¥å¤±æ•—ï¼šé€£ç·šéŒ¯èª¤");
  }
}

async function reloadConfig() {
  SETTINGS_LOADED = false;
  await ensureSettingsLoaded(true);
}

function renderConfigUI() {
  const deptWrap = document.getElementById('deptOptionsList');
  const payWrap = document.getElementById('payOptionsList');
  if(!deptWrap || !payWrap) return;

  deptWrap.innerHTML = renderOptionListHtml('departments', CONFIG_DATA.departments);
  payWrap.innerHTML = renderOptionListHtml('payments', CONFIG_DATA.payments);
}

function renderOptionListHtml(type, list) {
  if(!Array.isArray(list) || list.length === 0) {
    return "<div style='color:#90a4ae;font-weight:800;padding:10px'>å°šç„¡è³‡æ–™ï¼Œè«‹é»ã€Œæ–°å¢ã€</div>";
  }
  return list.map((it, idx) => {
    const inactiveCls = it.active ? "" : "inactive";
    const safeVal = escapeHtml(it.label || it.value || "");
    return `
      <div class="opt-row ${inactiveCls}">
        <label class="opt-toggle">
          <input type="checkbox" ${!it.active ? "checked" : ""} onchange="toggleOptionActive('${type}', ${idx}, !this.checked)">
          åœç”¨
        </label>
        <input class="opt-name" value="${safeVal}" oninput="updateOptionName('${type}', ${idx}, this.value)" placeholder="è«‹è¼¸å…¥åç¨±">
        <div class="opt-move">
          <button class="opt-icon-btn" title="ä¸Šç§»" onclick="moveOption('${type}', ${idx}, -1)"><span class="material-icons-round" style="font-size:18px">arrow_upward</span></button>
          <button class="opt-icon-btn" title="ä¸‹ç§»" onclick="moveOption('${type}', ${idx}, 1)"><span class="material-icons-round" style="font-size:18px">arrow_downward</span></button>
        </div>
        <button class="opt-del" onclick="deleteOption('${type}', ${idx})">åˆªé™¤</button>
      </div>
    `;
  }).join("") + "<div class=\"opt-spacer\" aria-hidden=\"true\"></div>";
}

function escapeHtml(s) {
  return String(s || "")
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;")
    .replaceAll('"', "&quot;")
    .replaceAll("'", "&#39;");
}

function addOptionRow(type) {
  if(!CONFIG_DATA[type]) CONFIG_DATA[type] = [];
  CONFIG_DATA[type].push({ value: "", label: "", active: true });
  renderConfigUI();
}

function deleteOption(type, idx) {
  if(!confirm("ç¢ºå®šè¦åˆªé™¤é€™å€‹é¸é …å—ï¼Ÿ")) return;
  CONFIG_DATA[type].splice(idx, 1);
  renderConfigUI();
}

function moveOption(type, idx, dir) {
  const arr = CONFIG_DATA[type] || [];
  const to = idx + dir;
  if(to < 0 || to >= arr.length) return;
  const tmp = arr[idx];
  arr[idx] = arr[to];
  arr[to] = tmp;
  renderConfigUI();
}

function toggleOptionActive(type, idx, checked) {
  const arr = CONFIG_DATA[type] || [];
  if(!arr[idx]) return;
  arr[idx].active = !!checked;
  renderConfigUI();
}

function updateOptionName(type, idx, v) {
  const arr = CONFIG_DATA[type] || [];
  if(!arr[idx]) return;
  const name = String(v || "").trim();
  arr[idx].label = name;
  arr[idx].value = name;
}

function validateConfigBeforeSave() {
  const norm = (s) => String(s||"").trim();
  const clean = (arr) => (arr||[]).map(x => ({ value: norm(x.value||x.label), label: norm(x.label||x.value), active: !!x.active }))
                                 .filter(x => x.label);

  const depts = clean(CONFIG_DATA.departments);
  const pays = clean(CONFIG_DATA.payments);

  // è‡³å°‘ 1 å€‹å•Ÿç”¨
  if(depts.filter(x => x.active).length === 0) return { ok:false, msg: "éƒ¨é–€é¸å–®è‡³å°‘éœ€ä¿ç•™ 1 å€‹ã€Œå•Ÿç”¨ã€é …ç›®" };
  if(pays.filter(x => x.active).length === 0) return { ok:false, msg: "æ”¯ä»˜æ–¹å¼è‡³å°‘éœ€ä¿ç•™ 1 å€‹ã€Œå•Ÿç”¨ã€é …ç›®" };

  // å»é™¤é‡è¤‡ï¼ˆä»¥ label åˆ¤æ–·ï¼‰
  const dupCheck = (arr, name) => {
    const seen = new Set();
    for(const x of arr) {
      const k = x.label;
      if(seen.has(k)) return name + " å‡ºç¾é‡è¤‡é …ç›®ï¼šã€Œ" + k + "ã€";
      seen.add(k);
    }
    return null;
  };
  const dErr = dupCheck(depts, "éƒ¨é–€");
  if(dErr) return { ok:false, msg: dErr };
  const pErr = dupCheck(pays, "æ”¯ä»˜æ–¹å¼");
  if(pErr) return { ok:false, msg: pErr };

  // å›å¯«æ¸…ç†å¾Œ
  CONFIG_DATA.departments = depts;
  CONFIG_DATA.payments = pays;

  return { ok:true };
}

async function saveConfig() {
  const v = validateConfigBeforeSave();
  if(!v.ok) { alert(v.msg); return; }

  setConfigStatus("ç‹€æ…‹ï¼šå„²å­˜ä¸­â€¦");
  showLoading(true, "æ­£åœ¨å„²å­˜è¨­å®šâ€¦");
  try {
    const payload = {
      action: "update_config",
      departments: CONFIG_DATA.departments,
      payments: CONFIG_DATA.payments
    };
    const res = await gasFetch(payload, true);
    showLoading(false);
    if(res && res.ok) {
      setConfigStatus("ç‹€æ…‹ï¼šå·²å„²å­˜ï¼ˆ" + new Date().toLocaleTimeString() + "ï¼‰");
      SETTINGS_LOADED = false; // next time reload from server
      alert("è¨­å®šå·²å„²å­˜ã€‚\nå‰å°é é¢é‡æ–°æ•´ç†å¾Œå³å¯å¥—ç”¨æœ€æ–°é¸å–®ã€‚");
    } else {
      const errMsg = (res && res.error) ? String(res.error) : "æœªçŸ¥éŒ¯èª¤";
      if(/token/i.test(errMsg)) {
        alert("å„²å­˜å¤±æ•—ï¼šå¯†ç¢¼å·²å¤±æ•ˆï¼Œè«‹é‡æ–°é–‹å•Ÿå¾Œå°ä¸¦è¼¸å…¥å¯†ç¢¼ã€‚");
      } else {
        alert("å„²å­˜å¤±æ•—ï¼š" + errMsg);
      }
      setConfigStatus("ç‹€æ…‹ï¼šå„²å­˜å¤±æ•—");
    }
  } catch(e) {
    console.error(e);
    showLoading(false);
    alert("å„²å­˜å¤±æ•—ï¼šé€£ç·šéŒ¯èª¤");
    setConfigStatus("ç‹€æ…‹ï¼šå„²å­˜å¤±æ•—");
  }
}

// [New] é¡¯ç¤ºè²¨å“çµ±è¨ˆè¦–çª—
function showItemStats() {
    // å–å¾—ç›®å‰ç¯©é¸å¾Œçš„è¨‚å–® (è¤‡ç”¨ renderCurrentTable çš„é‚è¼¯æœ‰é»å›°é›£ï¼Œç›´æ¥é‡ç®—ä¸€æ¬¡ç¯©é¸)
    const q = document.getElementById('tableSearch').value.toLowerCase().trim();
    let list = DATA.orders.filter(o => o.id.toLowerCase().includes(q) || o.name.includes(q));
    if (SELECTED_STATUSES.size > 0 && !SELECTED_STATUSES.has('ç¼ºè²¨')) {
        list = list.filter(o => SELECTED_STATUSES.has(o.dept) || SELECTED_STATUSES.has(o.pickup));
    }

    const itemStats = {};
    const giftStats = {};

    list.forEach(o => {
        if(!o.raw) return;

        // çµ±è¨ˆå•†å“ (å«çµ„åˆåŒ…æ‹†è§£)
        if(o.raw.items) {
            o.raw.items.forEach(it => {
                const qty = it.qty || 0;
                // æª¢æŸ¥æ˜¯å¦æœ‰ bundle_summary (å¾ GAS V3.1 å¯«å…¥çš„ JSON)
                if(it.bundle_summary) {
                    const subs = it.bundle_summary.split('|');
                    subs.forEach(sub => {
                        const name = sub.trim();
                        itemStats[name] = (itemStats[name] || 0) + qty;
                    });
                } else {
                    itemStats[it.product_name] = (itemStats[it.product_name] || 0) + qty;
                }
            });
        }

        // çµ±è¨ˆè´ˆå“ (å«çµ„åˆåŒ…æ‹†è§£ - Step 2 å‰å°å·²åŠ å…¥ bundle_summary)
        if(o.raw.gifts) {
            o.raw.gifts.forEach(g => {
                const qty = g.qty || 0;
                // [Mod] æ”¯æ´è´ˆå“æ‹†è§£
                if(g.bundle_summary) {
                    const subs = g.bundle_summary.split('|');
                    subs.forEach(sub => {
                        const name = sub.trim();
                        giftStats[name] = (giftStats[name] || 0) + qty;
                    });
                } else {
                    // ç§»é™¤ [è´ˆå“] å‰ç¶´ä»¥ä¿æŒä¹¾æ·¨
                    let name = g.product_name.replace(/^\[è´ˆå“\]\s*/, '').replace(/^\[Gift\]\s*/i, '');
                    giftStats[name] = (giftStats[name] || 0) + qty;
                }
            });
        }
    });

    // æ¸²æŸ“ Modal å…§å®¹
    const body = document.getElementById('info-body');
    const title = document.getElementById('info-title');
    title.innerText = "è²¨å“çµ±è¨ˆ (ç›®å‰ç¯©é¸ç¯„åœ)";

    let html = `<div style="padding:10px;background:#e8f5e9;color:#2e7d32;font-weight:700;margin-bottom:15px;border-radius:8px">çµ±è¨ˆè¨‚å–®æ•¸ï¼š${list.length} ç­†</div>`;

    // æ¸²æŸ“å•†å“è¡¨
    html += `<div class="info-section-title">ğŸ“¦ å•†å“çµ±è¨ˆ</div>`;
    const sortedItems = Object.entries(itemStats).sort((a,b) => b[1] - a[1]);
    sortedItems.forEach(([name, qty]) => {
        html += `<div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px dashed #eee"><span>${name}</span><span style="font-weight:900">${qty}</span></div>`;
    });

    // æ¸²æŸ“è´ˆå“è¡¨
    if(Object.keys(giftStats).length > 0) {
        html += `<div class="info-section-title" style="margin-top:20px;border-left-color:var(--accent)">ğŸ è´ˆå“çµ±è¨ˆ</div>`;
        const sortedGifts = Object.entries(giftStats).sort((a,b) => b[1] - a[1]);
        sortedGifts.forEach(([name, qty]) => {
            html += `<div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px dashed #eee;color:var(--text-sub)"><span>${name}</span><span style="font-weight:900;color:var(--accent)">${qty}</span></div>`;
        });
    }

    body.innerHTML = html;
    document.getElementById('infoModal').classList.add('open');
}

window.addEventListener('resize', () => { renderCurrentTable(); updateDashboard(); });

// === Orders auto refresh (optional; Orders tab only) ===
let ORDERS_AUTO_TIMER = null;
const ORDERS_AUTO_ENABLED_KEY = 'ttl_admin_orders_autorefresh_enabled';
const ORDERS_AUTO_INTERVAL_KEY = 'ttl_admin_orders_autorefresh_interval';
let ORDERS_AUTO_ENABLED = localStorage.getItem(ORDERS_AUTO_ENABLED_KEY) === 'true';
let ORDERS_AUTO_INTERVAL = parseInt(localStorage.getItem(ORDERS_AUTO_INTERVAL_KEY) || '120', 10);
if(![60,120].includes(ORDERS_AUTO_INTERVAL)) ORDERS_AUTO_INTERVAL = 120;

// === last sync UI ===

function updateLastSyncText() {
  const el = document.getElementById('lastSyncText');
  if(!el) return;
  const d = new Date();
  const hh = String(d.getHours()).padStart(2,'0');
  const mm = String(d.getMinutes()).padStart(2,'0');
  const ss = String(d.getSeconds()).padStart(2,'0');
  el.innerText = `æœ€å¾Œæ›´æ–°ï¼š${hh}:${mm}:${ss}`;
}

async function refreshOrdersOnly(silent = true) {
  try {
    const editModal = document.getElementById('editModal');
    if(editModal && editModal.classList.contains('open')) return;

    const ord = await fetchCSV(getOrdersCsvUrl(), { cacheBust: true, healthKey: 'orders' });
    processOrders(ord);
    updateDashboard();
    renderCurrentTable();
    updateLastSyncText();
  } catch(e) {
    console.error('refreshOrdersOnly failed', e);
    if(!silent) alert('æ›´æ–°è¨‚å–®è³‡æ–™å¤±æ•—ï¼Œè«‹ç¢ºèªç¶²è·¯æˆ– Orders CSV è¨­å®šã€‚');
  }
}

async function refreshAllData(silent = true) {
  try {
    const editModal = document.getElementById('editModal');
    if(editModal && editModal.classList.contains('open')) return;

    showLoading(true, 'æ›´æ–°ä¸­...');

    // Load products in parallel (enhances bundle rendering, non-blocking)
    const prodsPromise = fetchCSV(SHEET_P_CSV, { cacheBust: true, healthKey: 'products' })
      .then(prods => { processProducts(prods); return true; })
      .catch(e => { console.warn('Product CSV load failed:', e); return false; });

    const [ord, inv, sales] = await Promise.all([
      fetchCSV(getOrdersCsvUrl(), { cacheBust: true, healthKey: 'orders' }),
      fetchCSV(INVENTORY_CSV, { cacheBust: true, healthKey: 'inventory' }),
      fetchCSV(SALES_CSV, { cacheBust: true, healthKey: 'sales' })
    ]);

    processOrders(ord);
    processInventory(inv);
    processSales(sales);

    updateDashboard();
    renderCurrentTable();
    updateRestoreWidget();
    try{ updateRestoreWidgetVisibility(CURRENT_TAB); }catch(e){}

    const lu = document.getElementById('lastUpdate');
    if(lu) lu.innerText = "æ›´æ–°: " + new Date().toLocaleTimeString();

    updateLastSyncText();
    showLoading(false);
    if(!silent) showToast('å·²æ›´æ–°');

    prodsPromise.then(ok => {
      if(ok) {
        try { renderCurrentTable(); updateDashboard(); } catch(e) {}
      }
    });
  } catch(e) {
    console.error('refreshAllData failed', e);
    showLoading(false);
    if(!silent) alert('æ›´æ–°è³‡æ–™å¤±æ•—ï¼Œè«‹ç¢ºèªç¶²è·¯æˆ– CSV è¨­å®šã€‚');
  }
}



function renderOrdersAutoControls(){
  const wrap = document.getElementById('ordersAutoRefresh');
  if(wrap) wrap.style.display = (CURRENT_TAB === 'orders') ? 'flex' : 'none';
  const t = document.getElementById('oarToggle');
  const p = document.getElementById('oarInterval');
  if(t){ t.classList.toggle('on', !!ORDERS_AUTO_ENABLED); }
  if(p){ p.textContent = `${ORDERS_AUTO_INTERVAL}s`; }
}

function stopOrdersAutoRefresh(){
  if(ORDERS_AUTO_TIMER){ clearInterval(ORDERS_AUTO_TIMER); ORDERS_AUTO_TIMER = null; }
}

function applyOrdersAutoRefresh(){
  // show/hide controls
  renderOrdersAutoControls();

  // only run on Orders tab
  if(CURRENT_TAB !== 'orders' || !ORDERS_AUTO_ENABLED || document.visibilityState !== 'visible'){
    stopOrdersAutoRefresh();
    return;
  }
  if(ORDERS_AUTO_TIMER) return;
  ORDERS_AUTO_TIMER = setInterval(() => {
    if(CURRENT_TAB !== 'orders') return;
    if(document.visibilityState !== 'visible') return;
    refreshOrdersOnly(true);
  }, ORDERS_AUTO_INTERVAL * 1000);
}

function setOrdersAutoEnabled(enabled){
  ORDERS_AUTO_ENABLED = !!enabled;
  localStorage.setItem(ORDERS_AUTO_ENABLED_KEY, ORDERS_AUTO_ENABLED ? 'true' : 'false');
  renderOrdersAutoControls();
  stopOrdersAutoRefresh();
  if(ORDERS_AUTO_ENABLED && CURRENT_TAB === 'orders'){
    refreshOrdersOnly(true);
  }
  applyOrdersAutoRefresh();
}

function toggleOrdersAutoRefresh(){
  setOrdersAutoEnabled(!ORDERS_AUTO_ENABLED);
  showToast(`è¨‚å–®è‡ªå‹•æ›´æ–°ï¼š${ORDERS_AUTO_ENABLED ? 'é–‹å•Ÿ' : 'é—œé–‰'}`);
}

function cycleOrdersAutoInterval(){
  ORDERS_AUTO_INTERVAL = (ORDERS_AUTO_INTERVAL === 60) ? 120 : 60;
  localStorage.setItem(ORDERS_AUTO_INTERVAL_KEY, String(ORDERS_AUTO_INTERVAL));
  renderOrdersAutoControls();
  stopOrdersAutoRefresh();
  applyOrdersAutoRefresh();
  showToast(`è‡ªå‹•æ›´æ–°é–“éš”ï¼š${ORDERS_AUTO_INTERVAL}s`);
}

function startAutoRefresh(){
  // legacy entry point for boot
  if(!window.__ordersAutoBound){
    window.__ordersAutoBound = true;
    document.addEventListener('visibilitychange', applyOrdersAutoRefresh);
  }
  applyOrdersAutoRefresh();
}

function bindMetaButtons() {
  const doRefresh = () => refreshAllData(false);
  const doLogout = () => {
    clearSavedToken();
    alert('å·²æ¸…é™¤å¾Œå°å¯†ç¢¼ã€‚é‡æ–°æ•´ç†å¾Œæœƒå†æ¬¡è¦æ±‚è¼¸å…¥ã€‚');
  };

  const r = document.getElementById('refreshNowBtn');
  if(r) r.onclick = doRefresh;
  const rm = document.getElementById('refreshNowBtnMobile');
  if(rm) rm.onclick = doRefresh;

  const lo = document.getElementById('logoutBtn');
  if(lo) lo.onclick = doLogout;
  const lom = document.getElementById('logoutBtnMobile');
  if(lom) lom.onclick = doLogout;
}

// When GAS rejects token, clear and re-prompt once
function ensureValidTokenAndRetry(payload, msg, isDelete) {
  clearSavedToken();
  ADMIN_TOKEN = promptForToken(true);
  if(!ADMIN_TOKEN) { denyAccessAndStop(); return; }
  callGAS(payload, msg, isDelete, true);
}

// --- PWA INSTALL GUIDANCE (Android + iOS) ---
let deferredInstallPrompt = null;
let swWaitingWorker = null;

function isStandaloneMode(){
  return (window.matchMedia && window.matchMedia('(display-mode: standalone)').matches) || window.navigator.standalone === true;
}
function isIosDevice(){
  const ua = (navigator.userAgent || '').toLowerCase();
  const iOS = /iphone|ipad|ipod/.test(ua) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
  return iOS;
}
function isSafariOnIos(){
  const ua = (navigator.userAgent || '').toLowerCase();
  const isIos = isIosDevice();
  // iOS: Safari contains 'safari' and not 'crios' (Chrome), not 'fxios' (Firefox)
  return isIos && ua.includes('safari') && !ua.includes('crios') && !ua.includes('fxios');
}

function showInstallWidget(){
  const w = document.getElementById('installWidget');
  if(w) w.style.display = 'flex';
}
function hideInstallWidget(){
  const w = document.getElementById('installWidget');
  if(w) w.style.display = 'none';
}

window.addEventListener('beforeinstallprompt', (e) => {
  // Android/Chromium install prompt
  e.preventDefault();
  deferredInstallPrompt = e;
  if(!isStandaloneMode()) showInstallWidget();
});

window.addEventListener('appinstalled', () => {
  hideInstallWidget();
  try { showToast('å·²å®‰è£è‡³ä¸»ç•«é¢'); } catch(e) {}
});

async function installApp(ev){
  try { ev && ev.stopPropagation(); } catch(e) {}
  if(!deferredInstallPrompt){
    // If on iOS, guide user
    if(isIosDevice() && !isStandaloneMode()){
      openIosInstallPrompt();
      return;
    }
    try { showToast('æ­¤è£ç½®æš«ç„¡æ³•è‡ªå‹•å®‰è£'); } catch(e) {}
    return;
  }
  deferredInstallPrompt.prompt();
  const { outcome } = await deferredInstallPrompt.userChoice;
  deferredInstallPrompt = null;
  hideInstallWidget();
  if(outcome === 'accepted'){
    try { showToast('å®‰è£ä¸­â€¦'); } catch(e) {}
  }
}

// iOS A2HS guide (Safari Share -> Add to Home Screen)
function openIosInstallPrompt(){
  if(isStandaloneMode()) return;
  const key = 'ttl_admin_ios_a2hs_dismissed';
  if(localStorage.getItem(key) === '1') return;
  const p = document.getElementById('iosInstallPrompt');
  if(!p) return;
  p.classList.add('visible');
  requestAnimationFrame(()=>p.classList.add('animate-in'));
}
function closeIosInstallPrompt(){
  const key = 'ttl_admin_ios_a2hs_dismissed';
  localStorage.setItem(key,'1');
  const p = document.getElementById('iosInstallPrompt');
  if(!p) return;
  p.classList.remove('animate-in');
  setTimeout(()=>p.classList.remove('visible'), 250);
}

// Auto show iOS guide after boot
function maybeShowIosGuide(){
  if(!isIosDevice()) return;
  if(isStandaloneMode()) return;
    setTimeout(()=>openIosInstallPrompt(), 900);
}

// --- Service Worker (App Shell only; all Sheets CSV remain network-only) ---
function showUpdateToast(){
  const t = document.getElementById('updateToast');
  if(t) t.classList.add('show');
}
function hideUpdateToast(){
  const t = document.getElementById('updateToast');
  if(t) t.classList.remove('show');
}
function updateApp(){
  if(swWaitingWorker){
    swWaitingWorker.postMessage({ type: 'SKIP_WAITING' });
  }
}

function registerServiceWorker(){
  if(!('serviceWorker' in navigator)) return;
  navigator.serviceWorker.register('./sw.js', { scope: './' }).then(reg => {
    if(reg.waiting){
      swWaitingWorker = reg.waiting;
      showUpdateToast();
    }
    reg.addEventListener('updatefound', () => {
      const w = reg.installing;
      if(!w) return;
      w.addEventListener('statechange', () => {
        if(w.state === 'installed' && navigator.serviceWorker.controller){
          swWaitingWorker = w;
          showUpdateToast();
        }
      });
    });
  }).catch(err => {
    console.warn('SW register failed', err);
  });

  let refreshing = false;
  navigator.serviceWorker.addEventListener('controllerchange', () => {
    if(refreshing) return;
    refreshing = true;
    hideUpdateToast();
    window.location.reload();
  });
}

async function boot() {
  bindMetaButtons();
  registerServiceWorker();
  maybeShowIosGuide();
  await init();
  updateLastSyncText();
  startAutoRefresh();
}

boot();
</script>
</body>
</html>